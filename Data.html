<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base Client - VisioPro</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary-color: #ec4899;
            --accent-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --dark-color: #1f2937;
            --darker-color: #111827;
            --light-color: #f9fafb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --sidebar-bg: var(--darker-color);
            --sidebar-text: var(--gray-200);
            --sidebar-hover: var(--gray-800);
            --sidebar-active: var(--primary-color);
            
            --card-bg: #ffffff;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --card-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            
            --transition: all 0.2s ease-in-out;
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-mode {
            --card-bg: var(--gray-800);
            --light-color: var(--gray-900);
            --dark-color: var(--gray-100);
            --sidebar-bg: var(--gray-900);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: url("fond.png") no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        /* Layout principal */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Header amélioré */
        .header {
            background-color: var(--card-bg);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition-slow);
            border-bottom: 1px solid var(--gray-200);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--dark-color);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .mobile-menu-btn:hover, .mobile-menu-btn:focus {
            background-color: var(--gray-100);
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
            position: relative;
            padding-left: 1rem;
        }

        .page-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--dark-color);
            background-color: var(--gray-100);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .profile-dropdown:hover {
            background-color: var(--gray-100);
        }

        .profile-name {
            font-weight: 500;
        }

        .profile-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            min-width: 200px;
            box-shadow: var(--card-shadow-lg);
            border-radius: var(--border-radius-lg);
            z-index: 110;
            padding: 0.5rem 0;
            overflow: hidden;
            margin-top: 0.5rem;
            animation: dropdownFade 0.2s ease-out;
            border: 1px solid var(--gray-200);
        }

        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-menu a {
            color: var(--dark-color);
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .dropdown-menu a:hover, .dropdown-menu a:focus {
            background-color: var(--gray-100);
            color: var(--primary-color);
        }

        .dropdown-menu a i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .profile-dropdown:hover .dropdown-menu,
        .profile-dropdown:focus-within .dropdown-menu {
            display: block;
        }

        /* Contenu principal */
        .dashboard-section {
            padding: 1.5rem;
            flex: 1;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h1 {
            font-size: 1.75rem;
            color: var(--dark-color);
            font-weight: 700;
            position: relative;
            padding-bottom: 0.5rem;
        }

        .dashboard-header h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .dashboard-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Cartes de statistiques améliorées */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow-hover);
        }

        .stat-card.primary {
            border-left-color: var(--primary-color);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.info {
            border-left-color: var(--info-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-icon {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-weight: 500;
            color: var(--gray-500);
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Boutons améliorés */
        .btn {
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            font-size: 0.9rem;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-primary:hover, .btn-primary:focus {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--primary-color);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover, .btn-secondary:focus {
            background-color: var(--gray-50);
            box-shadow: var(--card-shadow-hover);
            border-color: var(--primary-color);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #34d399);
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* Conteneur principal amélioré */
        .client-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition-slow);
            border: 1px solid var(--gray-200);
        }

        /* Actions groupées améliorées */
        .bulk-actions {
            display: none;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bulk-actions.show {
            display: flex;
        }

        .selected-count {
            font-weight: 600;
            color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }

        .bulk-action-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bulk-action-btn:hover {
            background-color: var(--gray-100);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .bulk-action-btn.delete {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .bulk-action-btn.delete:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* Barre de recherche et filtres améliorés */
        .search-filters {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--dark-color);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background-color: var(--card-bg);
            color: var(--dark-color);
            cursor: pointer;
            transition: var(--transition);
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Tableau des clients amélioré */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .clients-table th {
            background-color: var(--gray-50);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .clients-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .clients-table tbody tr {
            transition: var(--transition);
        }

        .clients-table tbody tr:hover {
            background-color: var(--gray-50);
        }

        /* Case à cocher améliorée */
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .client-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
            transition: var(--transition);
        }

        .client-checkbox:checked {
            background-color: var(--primary-color);
        }

        /* En-tête de case à cocher */
        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .client-name-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .client-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .client-info {
            display: flex;
            flex-direction: column;
        }

        .client-name {
            font-weight: 500;
            color: var(--dark-color);
        }

        .client-id {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-inactive {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .action-btn.view {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        }

        .action-btn.edit {
            background: linear-gradient(135deg, var(--warning-color), #f59e0b);
        }

        .action-btn.call {
            background: linear-gradient(135deg, var(--success-color), #22c55e);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Pagination améliorée */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--gray-500);
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background-color: var(--card-bg);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            color: var(--dark-color);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--gray-100);
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Messages et alertes améliorées */
        .alert-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            box-shadow: var(--card-shadow-lg);
            z-index: 1050;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-message.success {
            background: linear-gradient(135deg, var(--success-color), #22c55e);
        }

        .alert-message.error {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .alert-message.info {
            background: linear-gradient(135deg, var(--info-color), #06b6d4);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Spinner de chargement amélioré */
        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: -0.125em;
            border: 0.15em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        /* Modal de commande amélioré */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
            padding: 1rem;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow-lg);
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
            border: 1px solid var(--gray-200);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        /* Form elements améliorés */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--dark-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Tableau des commandes amélioré */
        .commandes-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
        }

        .commandes-table th {
            background-color: var(--gray-50);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }

        .commandes-table td {
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .commande-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            background-color: var(--gray-50);
        }

        .commande-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .client-info-card {
            background: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            margin-bottom: 1rem;
        }

        /* Sélection fournisseur améliorée */
        .fournisseur-selection {
            background-color: var(--gray-50);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            margin-top: 1.5rem;
        }

        .fournisseur-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .fournisseur-card {
            background: white;
            padding: 1.5rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .fournisseur-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        .fournisseur-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        .fournisseur-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 0.5rem;
        }

        .fournisseur-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            transition: var(--transition);
        }

        .fournisseur-card.selected .fournisseur-icon {
            color: var(--primary-color);
        }

        .fournisseur-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        /* Actions flottantes améliorées */
        .floating-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 100;
        }

        .floating-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .floating-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition-slow);
        }

        .floating-action-btn:hover::before {
            left: 100%;
        }

        .floating-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .floating-action-btn.back {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }

        /* Accessibilité */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        button:focus, select:focus, input:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Styles pour l'interface compacte */
        .commandes-summary {
            max-height: 60vh;
            overflow-y: auto;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .badge {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .commande-group {
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
        }

        .commande-group:hover {
            box-shadow: var(--card-shadow);
        }

        .group-header {
            background: var(--gray-50);
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .group-header:hover {
            background: var(--gray-100);
        }

        .group-header h4 {
            margin: 0;
            font-size: 1rem;
            color: var(--dark-color);
        }

        .count {
            background: var(--gray-200);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--gray-600);
        }

        .group-content {
            padding: 0;
        }

        .commande-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            transition: var(--transition);
        }

        .commande-item:hover {
            background: var(--gray-50);
        }

        .commande-item:last-child {
            border-bottom: none;
        }

        .client-header {
            flex: 1;
        }

        .client-header strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        .client-id {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .verre-details {
            flex: 2;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
        }

        .label {
            font-weight: 500;
            color: var(--gray-600);
            font-size: 0.85rem;
        }

        .value {
            color: var(--dark-color);
            font-size: 0.85rem;
        }

        .btn-edit {
            background: none;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            cursor: pointer;
            color: var(--primary-color);
            transition: var(--transition);
            margin-left: 1rem;
        }

        .btn-edit:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Styles pour l'édition */
        .edit-commande {
            max-height: 70vh;
            overflow-y: auto;
        }

        .edit-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            margin-right: 1rem;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .btn-back:hover {
            background-color: var(--gray-100);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .verres-section h4 {
            margin: 1.5rem 0 1rem 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 0.5rem;
        }

        /* Page d'impression améliorée */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
        }

        .print-section {
            display: none;
            background: white;
            color: black;
            padding: 2rem;
            font-family: 'Inter', sans-serif;
        }

        .print-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #333;
            padding-bottom: 1rem;
        }

        .print-logo {
            width: 120px;
            height: auto;
            margin-bottom: 1rem;
        }

        .print-client-info {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .print-table th, .print-table td {
            border: 1px solid #333;
            padding: 0.75rem;
            text-align: left;
        }

        .print-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .print-footer {
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
            text-align: center;
        }

        /* Export buttons améliorés */
        .export-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Styles pour l'en-tête d'impression amélioré */
        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #333;
        }

        .company-info {
            flex: 1;
        }

        .company-name {
            font-size: 35px;
            font-weight: bold;
            margin: 0 0 0.5rem 0;
            color: #000;
        }

        .company-details {
            font-size: 12px;
            line-height: 1.4;
            color: #333;
        }

        .company-logo {
            text-align: right;
        }

        .logo-img {
            width: 120px;
            height: auto;
            max-width: 100%;
        }

        .print-title-section {
            text-align: center;
            margin: 1.5rem 0;
        }

        .print-title-section h2 {
            font-size: 24px;
            margin: 0 0 1rem 0;
            color: #000;
            text-transform: uppercase;
        }

        .print-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }

        .print-details p {
            margin: 0;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #333;
        }

        .signature-section div {
            text-align: center;
        }

        .signature-section p {
            margin: 0.5rem 0;
            font-size: 14px;
        }

        /* Assurer une bonne impression */
        @media print {
            .company-header {
                page-break-inside: avoid;
            }
            
            .print-title-section {
                page-break-after: avoid;
            }
            
            .logo-img {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* Responsive amélioré */
        @media (max-width: 1024px) {
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .stats-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .modal-content {
                width: 98%;
                margin: 1%;
            }
        }

        @media (max-width: 768px) {
            .dashboard-section {
                padding: 1rem;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dashboard-buttons {
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .header {
                padding: 1rem;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .profile-name {
                display: none;
            }

            .bulk-actions {
                flex-direction: column;
                align-items: flex-start;
            }

            .clients-table th:nth-child(1),
            .clients-table td:nth-child(1) {
                display: none;
            }

            .clients-table th:nth-child(5),
            .clients-table td:nth-child(5),
            .clients-table th:nth-child(6),
            .clients-table td:nth-child(6) {
                display: none;
            }
            
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .commandes-table {
                font-size: 0.75rem;
            }
            
            .fournisseur-grid {
                grid-template-columns: 1fr;
            }
            
            .verre-details {
                grid-template-columns: 1fr;
            }
            
            .commande-item {
                flex-direction: column;
            }
            
            .btn-edit {
                margin-left: 0;
                margin-top: 1rem;
                align-self: flex-end;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .clients-table th:nth-child(4),
            .clients-table td:nth-child(4) {
                display: none;
            }
            
            .pagination {
                flex-direction: column;
                gap: 1rem;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .modal-body {
                padding: 1rem;
            }
        }

        /* Animations supplémentaires */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Effet de brillance sur les cartes */
        .shine {
            position: relative;
            overflow: hidden;
        }

        .shine::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            transition: all 0.6s;
            opacity: 0;
        }

        .shine:hover::after {
            opacity: 1;
            top: -30%;
            left: -30%;
        }

        /* Effet de gradient animé pour les boutons */
        .gradient-btn {
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="main">
        <header class="header">
            <div class="header-left">
                <h1 class="page-title">Base Client</h1>
            </div>

            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Basculer le mode sombre">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-info">
                    <div class="profile-dropdown" tabindex="0" aria-haspopup="true" aria-expanded="false">
                        <span class="profile-name" id="username-display"></span>
                        <img src="https://ui-avatars.com/api/?name=John+Doe&background=6366f1&color=fff" alt="Photo de profil" class="profile-img">
                        <div class="dropdown-menu" role="menu">
                            <a href="#" role="menuitem"><i class="fas fa-user" aria-hidden="true"></i> Mon profil</a>
                            <a href="#" role="menuitem"><i class="fas fa-cog" aria-hidden="true"></i> Paramètres</a>
                            <a href="#" id="logout-btn" role="menuitem"><i class="fas fa-sign-out-alt" aria-hidden="true"></i> Déconnexion</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="dashboard-section">
            <div class="dashboard-header">
                <h1>Tableau de Bord Clients</h1>
                <div class="dashboard-buttons">
                    <button class="btn btn-primary" 
                    <button class="btn btn-secondary" onclick="refreshClients()">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                </div>
            </div>

            <!-- Cartes de statistiques améliorées -->
            <div class="stats-cards" id="statsCards">
                <div class="stat-card primary shine">
                    <div class="stat-value">
                        <i class="fas fa-users stat-icon"></i>
                        <span id="totalClients">0</span>
                    </div>
                    <div class="stat-label">Total Clients</div>
                    <div class="stat-change" id="totalClientsChange">
                        <i class="fas fa-minus"></i> <span id="totalClientsPercent">0%</span> ce mois
                    </div>
                </div>
                <div class="stat-card success shine">
                    <div class="stat-value">
                        <i class="fas fa-shopping-cart stat-icon"></i>
                        <span id="newSales">0</span>
                    </div>
                    <div class="stat-label">Nouvelles Ventes</div>
                    <div class="stat-change" id="newSalesChange">
                        <i class="fas fa-minus"></i> <span id="newSalesPercent">0%</span> ce mois
                    </div>
                </div>
                <div class="stat-card warning shine">
                    <div class="stat-value">
                        <i class="fas fa-cogs stat-icon"></i>
                        <span id="inProgress">0</span>
                    </div>
                    <div class="stat-label">En Traitement</div>
                    <div class="stat-change" id="inProgressChange">
                        <i class="fas fa-minus"></i> <span id="inProgressPercent">0%</span> ce mois
                    </div>
                </div>
                <div class="stat-card info shine">
                    <div class="stat-value">
                        <span id="totalRevenue">0 FCFA</span>
                    </div>
                    <div class="stat-label">Chiffre d'Affaires</div>
                    <div class="stat-change" id="revenueChange">
                        <i class="fas fa-minus"></i> <span id="revenuePercent">0%</span> ce mois
                    </div>
                </div>
            </div>

            <div class="client-container">
                <!-- Actions groupées améliorées -->
                <div class="bulk-actions" id="bulkActions">
                    <span class="selected-count" id="selectedCount">0</span> client(s) sélectionné(s)
                    <button class="bulk-action-btn" onclick="sendCommande()">
                        <i class="fas fa-paper-plane"></i> Passer Commande Fournisseur
                    </button>
                    <button class="bulk-action-btn delete" onclick="clearSelection()">
                        <i class="fas fa-times"></i> Tout désélectionner
                    </button>
                </div>

                <div class="search-filters">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Rechercher un client...">
                    </div>
                    <select class="filter-select" id="statusFilter">
                        <option value="">Tous les statuts</option>
                        <option value="Nouvelle vente">Nouvelle vente</option>
                        <option value="Lunette Disponible">Lunette Disponible</option>
                        <option value="En traitement">En traitement</option>
                        <option value="Livré">Livré</option>
                        <option value="Perdu">Perdu</option>
                        <option value="Cancel">Annulé</option>
                    </select>
                    <select class="filter-select" id="agencyFilter">
                        <option value="">Toutes les agences</option>
                        <option value="Cotonou">Cotonou</option>
                        <!-- Les autres agences seront ajoutées dynamiquement -->
                    </select>
                    <select class="filter-select" id="rowsPerPage">
                        <option value="10">10 lignes</option>
                        <option value="25">25 lignes</option>
                        <option value="50">50 lignes</option>
                        <option value="100">100 lignes</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="clients-table" id="clientsTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" class="select-all-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                                </th>
                                <th>Client</th>
                                <th>Contact</th>
                                <th>Agence</th>
                                <th>Commercial</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Les données des clients seront chargées ici -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    <div class="pagination-info" id="paginationInfo">
                        Affichage de 0 à 0 sur 0 clients
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        <!-- Les contrôles de pagination seront ajoutés ici -->
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Action flottante améliorée -->
<div class="floating-actions">
    <button class="floating-action-btn back" title="Retour" onclick="openVueGlobale()">
        <i class="fas fa-arrow-left"></i>
    </button>
</div>

<!-- Modals améliorés pour les commandes fournisseur -->
<div class="modal" id="commandeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Commande Fournisseur</h2>
            <button class="modal-close" onclick="closeCommandeModal()">&times;</button>
        </div>
        <div class="modal-body" id="commandeModalBody">
            <!-- Le contenu sera généré dynamiquement -->
        </div>
        <div class="modal-footer">
            <div>
                <strong><span id="totalCommandes">0</span> commande(s)</strong>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="closeCommandeModal()">Annuler</button>
                <button class="btn btn-primary" onclick="showFournisseurSelection()">
                    <i class="fas fa-arrow-right"></i> Choisir Fournisseur
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour la sélection du fournisseur amélioré -->
<div class="modal" id="fournisseurModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Sélection du Fournisseur</h2>
            <button class="modal-close" onclick="closeFournisseurModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="fournisseur-selection">
                <h3>Choisissez un fournisseur</h3>
                <div class="fournisseur-grid" id="fournisseurGrid">
                    <!-- Les fournisseurs seront ajoutés dynamiquement -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="backToCommandeModal()">
                <i class="fas fa-arrow-left"></i> Retour
            </button>
            <button class="btn btn-primary" id="btnImprimerCommande" disabled onclick="imprimerCommande()">
                <i class="fas fa-print"></i> Imprimer et Mettre à Jour
            </button>
        </div>
    </div>
</div>

<!-- Section d'impression améliorée -->
<div class="print-section" id="printSection">
    <div class="print-header">
        <div class="company-header">
            <div class="company-info">
                <h1 class="company-name">FAR VISION Sarl</h1>
                <div class="company-details">
                    Etoile Rouge/Carré 962,<br>
                    Cotonou-Benin.<br>
                    Ifu: 3202112790471<br>
                    Tel (229) 01 94359191<br>
                    Email: farvision521@gmail.com
                </div>
            </div>
            <div class="company-logo">
                <img src="logo.png" alt="FAR VISION Logo" class="logo-img">
            </div>
        </div>
        
        <div class="print-title-section">
            <h2>Commande Fournisseur</h2>
            <div class="print-details">
                <p><strong>Date:</strong> <span id="printDate"></span></p>
                <p><strong>Fournisseur:</strong> <span id="printFournisseur"></span></p>
                <p><strong>Référence:</strong> CMD-<span id="printReference"></span></p>
            </div>
        </div>
    </div>
    
    <div id="printCommandesContent">
        <!-- Le contenu des commandes sera généré dynamiquement -->
    </div>
    
    <div class="print-footer">
        <div class="signature-section">
            <div>
                <p>Signature Responsable</p>
                <p>_________________________</p>
            </div>
            <div>
                <p>Cachet et signature fournisseur</p>
                <p>_________________________</p>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== VARIABLES GLOBALES ====================
let allClients = [];
let filteredClients = [];
let currentPage = 1;
let clientsPerPage = 10;
let selectedClients = new Set();
let commandesData = [];
let selectedFournisseur = null;

// Structure pour stocker les données mensuelles
let monthlyData = {
    current: { clients: 0, newSales: 0, inProgress: 0, revenue: 0 },
    previous: { clients: 0, newSales: 0, inProgress: 0, revenue: 0 }
};

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', () => {
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");

    if (!username) {
        redirectToLogin();
        return;
    }

    // Affiche le nom d'utilisateur
    const usernameDisplay = document.getElementById("username-display");
    if (usernameDisplay) {
        usernameDisplay.textContent = username;
    }

    // Met à jour l'image de profil avec les initiales
    const profileImg = document.querySelector('.profile-img');
    if (profileImg) {
        profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6366f1&color=fff`;
    }

    // Gestion du bouton de déconnexion
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    // Initialiser le thème
    initTheme();
    
    // Activer le timer d'inactivité
    startInactivityTimer();
    
    // Charger les données des clients
    loadClientsData();
    
    // Initialiser les filtres
    setupSearchAndFilters();
});

// ==================== GESTION DU THÈME ====================
function initTheme() {
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    
    // Appliquer le thème sauvegardé
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    // Gestion du bouton de basculement de thème
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            localStorage.setItem('theme', 'light');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
    });
}

// ==================== FONCTIONS D'AUTHENTIFICATION ====================
function logout() {
    sessionStorage.removeItem("utilisateur");
    localStorage.removeItem("utilisateur");
    redirectToLogin();
}

function redirectToLogin() {
    window.location.href = "code.html";
}

function startInactivityTimer() {
    const INACTIVITY_LIMIT = 15 * 60 * 1000; // 15 minutes en ms
    let inactivityTimeout;

    function resetTimer() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(logout, INACTIVITY_LIMIT);
    }

    // Événements qui réinitialisent le timer
    ["load", "mousemove", "keydown", "click", "scroll"].forEach(event => {
        window.addEventListener(event, resetTimer, true);
    });

    resetTimer();
}

// ==================== GESTION DES DONNÉES CLIENTS ====================

// Fonction pour charger les données des clients
async function loadClientsData() {
    try {
        showLoadingState();
        
        const apiUrl = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=dataclient';
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.message || "Erreur inconnue du serveur");
        }
        
        allClients = processClientData(result.data);
        filteredClients = [...allClients];
        
        // Mettre à jour les statistiques AVEC DONNÉES RÉELLES
        updateStats();
        
        // Mettre à jour les filtres d'agence
        updateAgencyFilter();
        
        // Afficher les clients
        displayClients();
        
    } catch (error) {
        console.error("Erreur lors du chargement des clients:", error);
        showTemporaryMessage("Erreur lors du chargement des clients: " + error.message, "error", 5000);
        showErrorState();
    }
}

// Fonction pour traiter les données des clients avec gestion des dates
function processClientData(data) {
    if (!data || !data.rows || !data.headers) {
        return [];
    }
    
    const headers = data.headers;
    const rows = data.rows;
    
    // Mapper les en-têtes aux indices
    const headerMap = {};
    headers.forEach((header, index) => {
        headerMap[header] = index;
    });
    
    // Transformer les lignes en objets clients
    return rows.map(row => {
        // Gestion de la date d'enregistrement
        let registrationDate = null;
        const dateString = row[headerMap["Date Enregistrement"]];
        if (dateString) {
            // Essayer de parser la date selon différents formats
            registrationDate = parseDate(dateString);
        }
        
        return {
            id: row[headerMap["ID client"]] || '',
            fullName: row[headerMap["Nom Complet Client"]] || '',
            phone: row[headerMap["Numéro Contact"]] || '',
            agency: row[headerMap["Agence"]] || '',
            salesperson: row[headerMap["Commercial"]] || '',
            netAmount: row[headerMap["Net à Payer (FCFA)"]] || 0,
            status: row[headerMap["Statut de la vente"]] || 'Nouvelle vente',
            registrationDate: registrationDate
        };
    });
}

// Fonction utilitaire pour parser les dates
function parseDate(dateString) {
    if (!dateString) return null;
    
    // Essayer différents formats de date
    const dateFormats = [
        // Format ISO
        () => new Date(dateString),
        // Format français DD/MM/YYYY
        () => {
            const parts = dateString.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return null;
        },
        // Format timestamp
        () => {
            const timestamp = parseInt(dateString);
            if (!isNaN(timestamp)) {
                return new Date(timestamp);
            }
            return null;
        }
    ];
    
    for (const format of dateFormats) {
        try {
            const date = format();
            if (date && !isNaN(date.getTime())) {
                return date;
            }
        } catch (e) {
            // Continuer avec le format suivant
        }
    }
    
    return null;
}

// ==================== GESTION DES STATISTIQUES RÉELLES ====================

// Fonction pour calculer les statistiques réelles
function calculateRealStats(clients) {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    // Réinitialiser les données
    monthlyData.current = { clients: 0, newSales: 0, inProgress: 0, revenue: 0 };
    monthlyData.previous = { clients: 0, newSales: 0, inProgress: 0, revenue: 0 };
    
    clients.forEach(client => {
        // Extraire la date d'enregistrement
        let registrationDate = client.registrationDate;
        
        // Si pas de date, on considère que c'est du mois en cours
        if (!registrationDate || isNaN(registrationDate.getTime())) {
            registrationDate = new Date();
        }
        
        const clientMonth = registrationDate.getMonth();
        const clientYear = registrationDate.getFullYear();
        
        // Vérifier si c'est le mois en cours ou le mois précédent
        const isCurrentMonth = clientMonth === currentMonth && clientYear === currentYear;
        const isPreviousMonth = clientMonth === (currentMonth === 0 ? 11 : currentMonth - 1) && 
                               clientYear === (currentMonth === 0 ? currentYear - 1 : currentYear);
        
        // Compter pour le mois en cours
        if (isCurrentMonth) {
            monthlyData.current.clients++;
            monthlyData.current.revenue += parseFloat(client.netAmount) || 0;
            
            if (client.status === 'Nouvelle vente') {
                monthlyData.current.newSales++;
            }
            if (client.status === 'En traitement' || client.status === 'En Traitement') {
                monthlyData.current.inProgress++;
            }
        }
        
        // Compter pour le mois précédent
        if (isPreviousMonth) {
            monthlyData.previous.clients++;
            monthlyData.previous.revenue += parseFloat(client.netAmount) || 0;
            
            if (client.status === 'Nouvelle vente') {
                monthlyData.previous.newSales++;
            }
            if (client.status === 'En traitement' || client.status === 'En Traitement') {
                monthlyData.previous.inProgress++;
            }
        }
    });
    
    // Mettre à jour l'affichage des statistiques
    updateStatsDisplay();
}

// Fonction pour calculer le pourcentage de changement
function calculatePercentageChange(current, previous) {
    if (previous === 0) {
        return current > 0 ? 100 : 0;
    }
    return ((current - previous) / previous) * 100;
}

// Fonction pour formater le pourcentage
function formatPercentage(percent) {
    return Math.abs(percent).toFixed(1) + '%';
}

// Fonction pour mettre à jour l'affichage des statistiques
function updateStatsDisplay() {
    // Calculer les pourcentages
    const clientsPercent = calculatePercentageChange(monthlyData.current.clients, monthlyData.previous.clients);
    const newSalesPercent = calculatePercentageChange(monthlyData.current.newSales, monthlyData.previous.newSales);
    const inProgressPercent = calculatePercentageChange(monthlyData.current.inProgress, monthlyData.previous.inProgress);
    const revenuePercent = calculatePercentageChange(monthlyData.current.revenue, monthlyData.previous.revenue);
    
    // Mettre à jour les valeurs
    document.getElementById('totalClients').textContent = monthlyData.current.clients.toLocaleString();
    document.getElementById('newSales').textContent = monthlyData.current.newSales.toLocaleString();
    document.getElementById('inProgress').textContent = monthlyData.current.inProgress.toLocaleString();
    document.getElementById('totalRevenue').textContent = monthlyData.current.revenue.toLocaleString('fr-FR') + ' FCFA';
    
    // Mettre à jour les pourcentages et les flèches
    updateStatChange('totalClients', clientsPercent);
    updateStatChange('newSales', newSalesPercent);
    updateStatChange('inProgress', inProgressPercent);
    updateStatChange('revenue', revenuePercent);
}

// Fonction pour mettre à jour l'affichage du changement
function updateStatChange(statId, percent) {
    const changeElement = document.getElementById(statId + 'Change');
    const percentElement = document.getElementById(statId + 'Percent');
    const iconElement = changeElement.querySelector('i');
    
    percentElement.textContent = formatPercentage(percent);
    
    if (percent > 0) {
        changeElement.className = 'stat-change positive';
        iconElement.className = 'fas fa-arrow-up';
    } else if (percent < 0) {
        changeElement.className = 'stat-change negative';
        iconElement.className = 'fas fa-arrow-down';
    } else {
        changeElement.className = 'stat-change';
        iconElement.className = 'fas fa-minus';
    }
}

// Fonction pour mettre à jour les statistiques (à appeler après le chargement des données)
function updateStats() {
    const totalClients = allClients.length;
    const newSales = allClients.filter(client => 
        client.status === 'Nouvelle vente'
    ).length;
    const inProgress = allClients.filter(client => 
        client.status === 'En traitement' || client.status === 'En traitement'
    ).length;
    
    const totalRevenue = allClients.reduce((sum, client) => {
        return sum + (parseFloat(client.netAmount) || 0);
    }, 0);
    
    // Calculer les statistiques réelles avec comparaison mensuelle
    calculateRealStats(allClients);
    
    // Mettre à jour l'affichage des statistiques globales (en attendant les données mensuelles)
    document.getElementById('totalClients').textContent = totalClients.toLocaleString();
    document.getElementById('newSales').textContent = newSales.toLocaleString();
    document.getElementById('inProgress').textContent = inProgress.toLocaleString();
    document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString('fr-FR') + ' FCFA';
}

// ==================== FONCTION POUR AFFICHER LES CLIENTS ====================
function displayClients() {
    const tableBody = document.getElementById('clientsTableBody');
    const paginationInfo = document.getElementById('paginationInfo');
    
    if (!tableBody || !paginationInfo) return;
    
    // Calculer les clients à afficher pour la page actuelle
    const startIndex = (currentPage - 1) * clientsPerPage;
    const endIndex = Math.min(startIndex + clientsPerPage, filteredClients.length);
    const clientsToShow = filteredClients.slice(startIndex, endIndex);
    
    // Vider le tableau
    tableBody.innerHTML = '';
    
    if (clientsToShow.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    Aucun client trouvé
                </td>
            </tr>
        `;
    } else {
        // Ajouter chaque client au tableau
        clientsToShow.forEach(client => {
            const row = document.createElement('tr');
            
            // Déterminer la classe de statut
            let statusClass = 'status-active';
            if (client.status === 'Perdu' || client.status === 'Cancel') {
                statusClass = 'status-inactive';
            } else if (client.status === 'Nouvelle vente') {
                statusClass = 'status-pending';
            }
            
            // Formater le numéro de téléphone
            const formattedPhone = formatPhoneNumber(client.phone);
            
            // Formater le montant
            const formattedAmount = client.netAmount ? 
                `${parseFloat(client.netAmount).toLocaleString('fr-FR')} FCFA` : '0 FCFA';
            
            // Créer les initiales pour l'avatar
            const initials = getInitials(client.fullName);
            
            // Vérifier si le client est sélectionné
            const isChecked = selectedClients.has(client.id);
            
            row.innerHTML = `
                <td class="checkbox-cell">
                    <input type="checkbox" class="client-checkbox" 
                           data-client-id="${client.id}"
                           ${isChecked ? 'checked' : ''}
                           onchange="toggleClientSelection(this, '${client.id}')">
                </td>
                <td>
                    <div class="client-name-cell">
                        <div class="client-avatar">${initials}</div>
                        <div class="client-info">
                            <span class="client-name">${client.fullName || 'Non renseigné'}</span>
                            <span class="client-id">${client.id}</span>
                        </div>
                    </div>
                </td>
                <td>${formattedPhone || 'N/A'}</td>
                <td>${client.agency || 'N/A'}</td>
                <td>${client.salesperson || 'N/A'}</td>
                <td>${formattedAmount}</td>
                <td><span class="status-badge ${statusClass}">${client.status}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view" title="Voir détails" onclick="viewClientDetails('${client.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn call" title="Appeler" onclick="callClient('${client.phone}')">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Mettre à jour les informations de pagination
    updatePaginationInfo();
    
    // Mettre à jour les contrôles de pagination
    updatePaginationControls();
    
    // Mettre à jour la case "Tout sélectionner"
    updateSelectAllCheckbox();
}

// Fonction pour mettre à jour les informations de pagination
function updatePaginationInfo() {
    const paginationInfo = document.getElementById('paginationInfo');
    if (!paginationInfo) return;
    
    const startIndex = (currentPage - 1) * clientsPerPage + 1;
    const endIndex = Math.min(currentPage * clientsPerPage, filteredClients.length);
    
    paginationInfo.textContent = `Affichage de ${startIndex} à ${endIndex} sur ${filteredClients.length} clients`;
}

// Fonction pour mettre à jour les contrôles de pagination
function updatePaginationControls() {
    const paginationControls = document.getElementById('paginationControls');
    if (!paginationControls) return;
    
    const totalPages = Math.ceil(filteredClients.length / clientsPerPage);
    
    let controlsHTML = '';
    
    // Bouton précédent
    controlsHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Pages
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Ajuster si on est proche de la fin
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Première page
    if (startPage > 1) {
        controlsHTML += `
            <button class="pagination-btn" onclick="changePage(1)">1</button>
            ${startPage > 2 ? '<span class="pagination-btn" disabled>...</span>' : ''}
        `;
    }
    
    // Pages visibles
    for (let i = startPage; i <= endPage; i++) {
        controlsHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
                ${i}
            </button>
        `;
    }
    
    // Dernière page
    if (endPage < totalPages) {
        controlsHTML += `
            ${endPage < totalPages - 1 ? '<span class="pagination-btn" disabled>...</span>' : ''}
            <button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>
        `;
    }
    
    // Bouton suivant
    controlsHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    paginationControls.innerHTML = controlsHTML;
}

// Fonction pour changer de page
function changePage(page) {
    const totalPages = Math.ceil(filteredClients.length / clientsPerPage);
    
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayClients();
    
    // Faire défiler vers le haut du tableau
    const tableContainer = document.querySelector('.table-container');
    if (tableContainer) {
        tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// ==================== FONCTIONS DE FILTRAGE ET RECHERCHE ====================
function setupSearchAndFilters() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const agencyFilter = document.getElementById('agencyFilter');
    const rowsPerPage = document.getElementById('rowsPerPage');
    
    if (searchInput) {
        searchInput.addEventListener('input', debounce(applyFilters, 300));
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', applyFilters);
    }
    
    if (agencyFilter) {
        agencyFilter.addEventListener('change', applyFilters);
    }
    
    if (rowsPerPage) {
        rowsPerPage.addEventListener('change', function() {
            clientsPerPage = parseInt(this.value);
            currentPage = 1;
            displayClients();
        });
    }
}

// Fonction pour appliquer les filtres
function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const agencyFilter = document.getElementById('agencyFilter').value;
    
    filteredClients = allClients.filter(client => {
        // Filtre de recherche
        const matchesSearch = !searchTerm || 
            client.fullName.toLowerCase().includes(searchTerm) ||
            client.id.toLowerCase().includes(searchTerm) ||
            client.phone.includes(searchTerm) ||
            client.salesperson.toLowerCase().includes(searchTerm);
        
        // Filtre de statut
        const matchesStatus = !statusFilter || client.status === statusFilter;
        
        // Filtre d'agence
        const matchesAgency = !agencyFilter || client.agency === agencyFilter;
        
        return matchesSearch && matchesStatus && matchesAgency;
    });
    
    // Revenir à la première page
    currentPage = 1;
    
    // Effacer la sélection lors du filtrage
    clearSelection();
    
    // Afficher les clients filtrés
    displayClients();
}

// Fonction pour mettre à jour le filtre d'agence
function updateAgencyFilter() {
    const agencyFilter = document.getElementById('agencyFilter');
    if (!agencyFilter) return;
    
    // Récupérer toutes les agences uniques
    const agencies = [...new Set(allClients.map(client => client.agency).filter(Boolean))];
    
    // Trier les agences
    agencies.sort();
    
    // Mettre à jour le filtre
    let optionsHTML = '<option value="">Toutes les agences</option>';
    agencies.forEach(agency => {
        optionsHTML += `<option value="${agency}">${agency}</option>`;
    });
    
    agencyFilter.innerHTML = optionsHTML;
}

// ==================== GESTION DES CASES À COCHER ====================

// Fonction pour basculer la sélection de tous les clients
function toggleSelectAll(checkbox) {
    const isChecked = checkbox.checked;
    const checkboxes = document.querySelectorAll('.client-checkbox');
    
    selectedClients.clear();
    
    checkboxes.forEach(clientCheckbox => {
        clientCheckbox.checked = isChecked;
        if (isChecked) {
            selectedClients.add(clientCheckbox.dataset.clientId);
        }
    });
    
    updateBulkActions();
}

// Fonction pour basculer la sélection d'un client individuel
function toggleClientSelection(checkbox, clientId) {
    if (checkbox.checked) {
        selectedClients.add(clientId);
    } else {
        selectedClients.delete(clientId);
    }
    
    // Mettre à jour la case "Tout sélectionner"
    updateSelectAllCheckbox();
    updateBulkActions();
}

// Fonction pour mettre à jour la case "Tout sélectionner"
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.client-checkbox');
    const checkedCount = document.querySelectorAll('.client-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// Fonction pour mettre à jour les actions groupées
function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedClients.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedClients.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

// Fonction pour effacer la sélection
function clearSelection() {
    selectedClients.clear();
    const checkboxes = document.querySelectorAll('.client-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectAllCheckbox();
    updateBulkActions();
}

// ==================== GESTION DES COMMANDES FOURNISSEUR AMÉLIORÉE ====================

// Fonction pour passer commande fournisseur
async function sendCommande() {
    if (selectedClients.size === 0) {
        showTemporaryMessage("Aucun client sélectionné", "error", 3000);
        return;
    }
    
    try {
        showLoadingState();
        
        // Récupérer les données réelles des clients sélectionnés
        const selectedClientsData = allClients.filter(client => 
            selectedClients.has(client.id)
        );
        
        // Préparer les données de commande avec les données réelles
        commandesData = await prepareCommandesData(selectedClientsData);
        
        // Afficher le modal de commande
        showCommandeModal();
        
    } catch (error) {
        console.error("Erreur lors de la préparation des commandes:", error);
        showTemporaryMessage("Erreur lors du chargement des données", "error", 3000);
    }
}

// Fonction pour préparer les données de commande avec les données réelles
async function prepareCommandesData(selectedClientsData) {
    // Pour chaque client, récupérer les données détaillées depuis l'API
    const commandes = [];
    
    for (const client of selectedClientsData) {
        try {
            const clientDetails = await fetchClientDetails(client.id);
            commandes.push({
                clientId: client.id,
                clientName: client.fullName,
                clientPhone: client.phone,
                clientAgency: client.agency,
                salesperson: client.salesperson,
                // Données réelles depuis l'API
                typeVerre: clientDetails.typeVerre || "",
                gammeVerres: clientDetails.gammeVerres || "",
                odSphere: clientDetails.odSphere || "0.00",
                odCylindre: clientDetails.odCylindre || "0.00",
                odAxe: clientDetails.odAxe || "0°",
                odADD: clientDetails.odADD || "0.00",
                odDP: clientDetails.odDP || "0",
                odHauteur: clientDetails.odHauteur || "0",
                ogSphere: clientDetails.ogSphere || "0.00",
                ogCylindre: clientDetails.ogCylindre || "0.00",
                ogAxe: clientDetails.ogAxe || "0°",
                ogADD: clientDetails.ogADD || "0.00",
                ogDP: clientDetails.ogDP || "0",
                ogHauteur: clientDetails.ogHauteur || "0",
                monture: clientDetails.monture || " ",
                netAmount: client.netAmount || 0
            });
        } catch (error) {
            console.error(`Erreur pour le client ${client.id}:`, error);
            // Données par défaut en cas d'erreur
            commandes.push({
                clientId: client.id,
                clientName: client.fullName,
                clientPhone: client.phone,
                clientAgency: client.agency,
                salesperson: client.salesperson,
                typeVerre: "Non spécifié",
                gammeVerres: "Standard",
                odSphere: "0.00",
                odCylindre: "0.00",
                odAxe: "0°",
                odADD: "0.00",
                odDP: "0",
                odHauteur: "0",
                ogSphere: "0.00",
                ogCylindre: "0.00",
                ogAxe: "0°",
                ogADD: "0.00",
                ogDP: "0",
                ogHauteur: "0",
                monture: " ",
                netAmount: client.netAmount || 0
            });
        }
    }
    
    return commandes;
}

// Fonction pour récupérer les détails d'un client depuis l'API
async function fetchClientDetails(clientId) {
    const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=dataclient`;
    
    const response = await fetch(apiUrl);
    if (!response.ok) {
        throw new Error(`Erreur HTTP: ${response.status}`);
    }
    
    const result = await response.json();
    if (!result.success) {
        throw new Error(result.message || "Erreur du serveur");
    }
    
    // Trouver le client dans les données
    const clientRow = result.data.rows.find(row => row[0] === clientId);
    if (!clientRow) {
        throw new Error("Client non trouvé");
    }
    
    // Mapper les données selon les headers
    const headers = result.data.headers;
    const headerMap = {};
    headers.forEach((header, index) => {
        headerMap[header] = index;
    });
    
    return {
        typeVerre: clientRow[headerMap["Type de Verre"]] || "",
        gammeVerres: clientRow[headerMap["Gamme des Verres"]] || "",
        monture: clientRow[headerMap["Choix de Monture"]] || "",
        odSphere: clientRow[headerMap["OD Sphere"]] || "0.00",
        odCylindre: clientRow[headerMap["OD Cylindre"]] || "0.00",
        odAxe: clientRow[headerMap["OD Axe"]] || "0°",
        odADD: clientRow[headerMap["OD ADD"]] || "0.00",
        odDP: clientRow[headerMap["OD DP"]] || "0",
        odHauteur: clientRow[headerMap["OD Hauteur"]] || "0",
        ogSphere: clientRow[headerMap["OG Sphere"]] || "0.00",
        ogCylindre: clientRow[headerMap["OG Cylindre"]] || "0.00",
        ogAxe: clientRow[headerMap["OG Axe"]] || "0°",
        ogADD: clientRow[headerMap["OG ADD"]] || "0.00",
        ogDP: clientRow[headerMap["OG DP"]] || "0",
        ogHauteur: clientRow[headerMap["OG Hauteur"]] || "0"
    };
}

// Fonction pour afficher le modal de commande
function showCommandeModal() {
    const modal = document.getElementById('commandeModal');
    const modalBody = document.getElementById('commandeModalBody');
    
    // Générer le contenu du modal
    modalBody.innerHTML = generateCommandeModalContent();
    
    // Afficher le modal
    modal.style.display = 'flex';
    
    // Mettre à jour le total
    document.getElementById('totalCommandes').textContent = commandesData.length;
}

// Fonction pour générer le contenu du modal de commande (version compacte)
function generateCommandeModalContent() {
    if (commandesData.length === 0) {
        return '<div class="no-data">Aucune donnée de commande disponible</div>';
    }
    
    let html = `
        <div class="commandes-summary">
            <div class="summary-header">
                <h3>Récapitulatif des Commandes</h3>
                <span class="badge">${commandesData.length} client(s)</span>
            </div>
    `;
    
    // Grouper par type de verre pour un affichage plus compact
    const groupedByType = groupCommandesByType();
    
    Object.keys(groupedByType).forEach(typeVerre => {
        const commandes = groupedByType[typeVerre];
        html += `
            <div class="commande-group">
                <div class="group-header" onclick="toggleGroup('${typeVerre}')">
                    <h4>${typeVerre}</h4>
                    <span class="count">${commandes.length} commande(s)</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="group-content" id="group-${typeVerre}">
        `;
        
        commandes.forEach((commande, index) => {
            html += `
                <div class="commande-item">
                    <div class="client-header">
                        <strong>${commande.clientName}</strong>
                        <span class="client-id">${commande.clientId}</span>
                    </div>
                    <div class="verre-details">
                        <div class="detail-row">
                            <span class="label">Gamme:</span>
                            <span class="value">${commande.gammeVerres}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">OD:</span>
                            <span class="value">${commande.odSphere} / ${commande.odCylindre} / ${commande.odAxe}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">OG:</span>
                            <span class="value">${commande.ogSphere} / ${commande.ogCylindre} / ${commande.ogAxe}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">ADD:</span>
                            <span class="value">OD ${commande.odADD} - OG ${commande.ogADD}</span>
                        </div>
                    </div>
                    <button class="btn-edit" onclick="editCommande(${commandes.indexOf(commande)})">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            `;
        });
        
        html += `</div></div>`;
    });
    
    html += `</div>`;
    
    return html;
}

// Fonction pour grouper les commandes par type de verre
function groupCommandesByType() {
    const grouped = {};
    commandesData.forEach(commande => {
        const type = commande.typeVerre || "Non spécifié";
        if (!grouped[type]) {
            grouped[type] = [];
        }
        grouped[type].push(commande);
    });
    return grouped;
}

// Fonction pour afficher/masquer un groupe
function toggleGroup(typeVerre) {
    const groupContent = document.getElementById(`group-${typeVerre}`);
    const icon = groupContent.previousElementSibling.querySelector('.fa-chevron-down');
    
    if (groupContent.style.display === 'none') {
        groupContent.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
    } else {
        groupContent.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// Fonction pour éditer une commande
function editCommande(index) {
    const commande = commandesData[index];
    
    const modalBody = document.getElementById('commandeModalBody');
    modalBody.innerHTML = `
        <div class="edit-commande">
            <div class="edit-header">
                <button class="btn-back" onclick="showCommandeModal()">
                    <i class="fas fa-arrow-left"></i> Retour
                </button>
                <h3>Modifier: ${commande.clientName}</h3>
            </div>
            
            <div class="client-info">
                <p><strong>ID:</strong> ${commande.clientId}</p>
                <p><strong>Agence:</strong> ${commande.clientAgency}</p>
            </div>
            
            <div class="edit-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Type de Verre</label>
                        <input type="text" class="form-control" value="${commande.typeVerre || 'Non spécifié'}" 
                               onchange="updateCommandeData(${index}, 'typeVerre', this.value)"
                               placeholder="Type de verre">
                    </div>
                    <div class="form-group">
                        <label>Gamme</label>
                        <input type="text" class="form-control" value="${commande.gammeVerres || 'Standard'}" 
                               onchange="updateCommandeData(${index}, 'gammeVerres', this.value)"
                               placeholder="Gamme des verres">
                    </div>
                </div>
                
                <div class="verres-section">
                    <h4>Œil Droit (OD)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Sphere</label>
                            <input type="text" class="form-control" value="${commande.odSphere || '0.00'}" 
                                   onchange="updateCommandeData(${index}, 'odSphere', this.value)"
                                   placeholder="OD Sphere">
                        </div>
                        <div class="form-group">
                            <label>Cylindre</label>
                            <input type="text" class="form-control" value="${commande.odCylindre || '0.00'}" 
                                   onchange="updateCommandeData(${index}, 'odCylindre', this.value)"
                                   placeholder="OD Cylindre">
                        </div>
                        <div class="form-group">
                            <label>Axe</label>
                            <input type="text" class="form-control" value="${commande.odAxe || '0°'}" 
                                   onchange="updateCommandeData(${index}, 'odAxe', this.value)"
                                   placeholder="OD Axe">
                        </div>
                    </div>
                    
                    <h4>Œil Gauche (OG)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Sphere</label>
                            <input type="text" class="form-control" value="${commande.ogSphere || '0.00'}" 
                                   onchange="updateCommandeData(${index}, 'ogSphere', this.value)"
                                   placeholder="OG Sphere">
                        </div>
                        <div class="form-group">
                            <label>Cylindre</label>
                            <input type="text" class="form-control" value="${commande.ogCylindre || '0.00'}" 
                                   onchange="updateCommandeData(${index}, 'ogCylindre', this.value)"
                                   placeholder="OG Cylindre">
                        </div>
                        <div class="form-group">
                            <label>Axe</label>
                            <input type="text" class="form-control" value="${commande.ogAxe || '0°'}" 
                                   onchange="updateCommandeData(${index}, 'ogAxe', this.value)"
                                   placeholder="OG Axe">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>ADD OD</label>
                            <input type="text" class="form-control" value="${commande.odADD || '0.00'}" 
                                   onchange="updateCommandeData(${index}, 'odADD', this.value)"
                                   placeholder="OD ADD">
                        </div>
                        <div class="form-group">
                            <label>ADD OG</label>
                            <input type="text" class="form-control" value="${commande.ogADD || '0.00'}" 
                                   onchange="updateCommandeData(${index}, 'ogADD', this.value)"
                                   placeholder="OG ADD">
                        </div>
                        <div class="form-group">
                            <label>Monture</label>
                            <input type="text" class="form-control" value="${commande.monture || 'Non spécifiée'}" 
                                   onchange="updateCommandeData(${index}, 'monture', this.value)"
                                   placeholder="Type de monture">
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="showCommandeModal()">
                        <i class="fas fa-check"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Fonction pour mettre à jour les données de commande
function updateCommandeData(index, field, value) {
    if (commandesData[index]) {
        commandesData[index][field] = value;
    }
}

// Fonction pour fermer le modal de commande
function closeCommandeModal() {
    document.getElementById('commandeModal').style.display = 'none';
}

// Fonction pour retourner au modal de commande
function backToCommandeModal() {
    closeFournisseurModal();
    showCommandeModal();
}

// Fonction pour afficher la sélection du fournisseur
function showFournisseurSelection() {
    closeCommandeModal();
    
    const fournisseurGrid = document.getElementById('fournisseurGrid');
    const fournisseurs = [
        { id: 'essilor', name: 'Essilor', icon: 'fas fa-glasses' },
        { id: 'hoya', name: 'Hoya', icon: 'fas fa-eye' },
        { id: 'zeiss', name: 'Zeiss', icon: 'fas fa-microscope' },
        { id: 'rodenstock', name: 'Rodenstock', icon: 'fas fa-certificate' },
        { id: 'seiko', name: 'Seiko', icon: 'fas fa-clock' },
        { id: 'SIVO', name: 'SIVO', icon: 'fas fa-star' }
    ];
    
    fournisseurGrid.innerHTML = fournisseurs.map(fournisseur => `
        <div class="fournisseur-card" onclick="selectFournisseur('${fournisseur.id}', '${fournisseur.name}')">
            <div class="fournisseur-icon">
                <i class="${fournisseur.icon}"></i>
            </div>
            <div class="fournisseur-name">${fournisseur.name}</div>
        </div>
    `).join('');
    
    document.getElementById('fournisseurModal').style.display = 'flex';
}

// Fonction pour sélectionner un fournisseur
function selectFournisseur(id, name) {
    selectedFournisseur = { id, name };
    
    // Mettre à jour l'interface
    document.querySelectorAll('.fournisseur-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    event.currentTarget.classList.add('selected');
    document.getElementById('btnImprimerCommande').disabled = false;
}

// Fonction pour fermer le modal fournisseur
function closeFournisseurModal() {
    document.getElementById('fournisseurModal').style.display = 'none';
    selectedFournisseur = null;
}

// Fonction pour imprimer la commande
async function imprimerCommande() {
    if (!selectedFournisseur) {
        showTemporaryMessage("Veuillez sélectionner un fournisseur", "error", 3000);
        return;
    }
    
    try {
        // Mettre à jour les statuts des clients avant l'impression
        await updateClientStatuses();
        
        // Générer le contenu d'impression
        generatePrintContent();
        
        // Afficher la section d'impression
        const printSection = document.getElementById('printSection');
        printSection.style.display = 'block';
        
        // Imprimer
        window.print();
        
        // Masquer la section d'impression après impression
        setTimeout(() => {
            printSection.style.display = 'none';
        }, 500);
        
        // Fermer le modal
        closeFournisseurModal();
        
        showTemporaryMessage("Commande imprimée avec succès et statuts mis à jour", "success", 3000);
        
    } catch (error) {
        console.error("Erreur lors de la mise à jour des statuts:", error);
        showTemporaryMessage("Erreur lors de la mise à jour des statuts", "error", 3000);
    }
}

// Fonction pour mettre à jour les statuts des clients
async function updateClientStatuses() {
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");
    const currentDate = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
    
    // Préparer les données de mise à jour
    const statusUpdates = [];
    
    for (const clientId of selectedClients) {
        // Trouver le client dans les données
        const client = allClients.find(c => c.id === clientId);
        if (client) {
            statusUpdates.push({
                id: clientId,
                ancienStatut: client.status,
                nouveauStatut: "En traitement",
                dateMiseAJour: currentDate,
                utilisateur: username,
                fournisseur: selectedFournisseur.name
            });
        }
    }
    
    // Envoyer les mises à jour à l'API
    if (statusUpdates.length > 0) {
        await sendStatusUpdates(statusUpdates);
        
        // Mettre à jour localement les statuts
        updateLocalStatuses();
    }
}

// Fonction pour envoyer les mises à jour de statut à l'API
async function sendStatusUpdates(statusUpdates) {
    const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addpo";
    
    try {
        // Préparer les données pour l'API
        const statusData = {
            updates: statusUpdates
        };
        
        console.log("📤 Envoi des mises à jour de statut:", statusData);
        
        // Utiliser mode: 'no-cors' pour contourner CORS
        const response = await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors', // ← AJOUT IMPORTANT
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(statusData)
        });
        
        // Avec mode: 'no-cors', on ne peut pas lire la réponse
        // Mais la requête est envoyée
        console.log("✅ Requête envoyée (mode no-cors)");
        
        return { success: true, message: "Requête envoyée" };
        
    } catch (error) {
        console.error("❌ Erreur lors de l'envoi des mises à jour:", error);
        // En mode no-cors, on considère que c'est un succès
        // car l'erreur CORS est normale
        return { success: true, message: "Requête envoyée (mode no-cors)" };
    }
}

// Fonction pour mettre à jour localement les statuts
function updateLocalStatuses() {
    // Mettre à jour les statuts dans allClients et filteredClients
    allClients.forEach(client => {
        if (selectedClients.has(client.id)) {
            client.status = "En traitement";
        }
    });
    
    filteredClients.forEach(client => {
        if (selectedClients.has(client.id)) {
            client.status = "En traitement";
        }
    });
    
    // Mettre à jour l'affichage
    displayClients();
    
    // Mettre à jour les statistiques
    updateStats();
    
    // Effacer la sélection
    clearSelection();
    
    console.log("✅ Statuts mis à jour localement pour", selectedClients.size, "clients");
}

// Fonction pour générer le contenu d'impression (version compacte)
function generatePrintContent() {
    const printDate = document.getElementById('printDate');
    const printFournisseur = document.getElementById('printFournisseur');
    const printReference = document.getElementById('printReference');
    const printCommandesContent = document.getElementById('printCommandesContent');
    
    // Mettre à jour les informations générales
    printDate.textContent = new Date().toLocaleDateString('fr-FR');
    printFournisseur.textContent = selectedFournisseur.name;
    printReference.textContent = Date.now().toString().slice(-6);
    
    // Générer le contenu compact des commandes
    let html = '';
    
    // Grouper par type de verre pour l'impression
    const groupedByType = groupCommandesByType();
    
    Object.keys(groupedByType).forEach(typeVerre => {
        const commandes = groupedByType[typeVerre];
        
        html += `
            <div class="print-group">
                <div class="print-group-header">
                    <h3>${typeVerre}</h3>
                    <span class="count">${commandes.length} commande(s)</span>
                </div>
                <table class="print-table compact">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Gamme</th>
                            <th>OD</th>
                            <th>OG</th>
                            <th>ADD</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        commandes.forEach(commande => {
            html += `
                <tr>
                    <td>
                        <strong>${commande.clientName}</strong>
                        <div class="client-details">
                            ${commande.clientId} | ${commande.clientAgency}
                        </div>
                    </td>
                    <td>${commande.gammeVerres}</td>
                    <td>
                        ${commande.odSphere}/${commande.odCylindre}/${commande.odAxe}
                        ${commande.odDP ? `DP:${commande.odDP}` : ''}
                    </td>
                    <td>
                        ${commande.ogSphere}/${commande.ogCylindre}/${commande.ogAxe}
                        ${commande.ogDP ? `DP:${commande.ogDP}` : ''}
                    </td>
                    <td>
                        ${commande.odADD}
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    });
    
    printCommandesContent.innerHTML = html;
}

// ==================== FONCTIONS UTILITAIRES ====================
// Fonction pour obtenir les initiales d'un nom
function getInitials(fullName) {
    if (!fullName) return '?';
    
    return fullName
        .split(' ')
        .map(part => part.charAt(0))
        .join('')
        .toUpperCase()
        .substring(0, 2);
}

// Fonction pour formater un numéro de téléphone
function formatPhoneNumber(phoneString) {
    if (!phoneString) return '';
    
    // Convertir en chaîne de caractères au cas où c'est un nombre ou autre type
    const phoneStr = String(phoneString);
    
    // Si le numéro a plus de 10 chiffres, garder les 10 derniers
    let digitsOnly = phoneStr.replace(/\D/g, '');
    if (digitsOnly.length > 10) {
        digitsOnly = digitsOnly.slice(-10);
    }
    
    // Formater avec des espaces tous les 2 chiffres
    return digitsOnly.length === 10 ? 
        digitsOnly.replace(/(\d{2})(?=\d)/g, '$1 ') : 
        phoneStr;
}

// Fonction debounce pour limiter les appels de fonction
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ==================== FONCTIONS D'ACTION ====================
// Fonction pour voir les détails d'un client
function openVueGlobale() {
    try {
        const salePath = 'Accueil.html';
        window.location.href = salePath;
    } catch (error) {
        console.error("Erreur d'ouverture:", error);
        alert("Impossible d'ouvrir la page. Contactez l'administrateur.");
    }
}

function viewClientDetails(clientId) {
    // Stocker l'ID du client sélectionné
    localStorage.setItem("selectedClient", JSON.stringify([clientId]));
    
    // Rediriger vers la page de détails
    window.location.href = "DetailClient.html";
}

// Fonction pour appeler un client
function callClient(phoneNumber) {
    if (!phoneNumber) {
        showTemporaryMessage("Numéro de téléphone non disponible", "error", 3000);
        return;
    }
    
    const cleanedNumber = cleanPhoneNumber(phoneNumber);
    
    if (!cleanedNumber) {
        showTemporaryMessage("Numéro de téléphone invalide", "error", 3000);
        return;
    }
    
    // Confirmer l'appel
    if (confirm(`Voulez-vous appeler le numéro ${formatPhoneNumber(cleanedNumber)} ?`)) {
        window.location.href = `tel:${cleanedNumber}`;
    }
}

// Fonction pour nettoyer un numéro de téléphone
function cleanPhoneNumber(phoneNumber) {
    if (!phoneNumber) return null;
    
    // Convertir en chaîne et supprimer tous les caractères non numériques
    let digitsOnly = String(phoneNumber).replace(/\D/g, '');
    
    // Si le numéro a plus de 10 chiffres, garder les 10 derniers
    if (digitsOnly.length > 10) {
        digitsOnly = digitsOnly.slice(-10);
    }
    
    // Retourner seulement si c'est un numéro valide (10 chiffres)
    return digitsOnly.length === 10 ? digitsOnly : null;
}

// Fonction pour actualiser les données
function refreshClients() {
    loadClientsData();
    showTemporaryMessage("Liste des clients actualisée", "success", 2000);
}

// ==================== ÉTATS D'AFFICHAGE ====================
// Fonction pour afficher l'état de chargement
function showLoadingState() {
    const tableBody = document.getElementById('clientsTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = `
        <tr>
            <td colspan="8" style="text-align: center; padding: 3rem;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                    <div class="spinner-border" style="color: var(--primary-color);"></div>
                    <div style="color: var(--gray-500);">Chargement des clients...</div>
                </div>
            </td>
        </tr>
    `;
}

// Fonction pour afficher l'état d'erreur
function showErrorState() {
    const tableBody = document.getElementById('clientsTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = `
        <tr>
            <td colspan="8" style="text-align: center; padding: 3rem;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--danger-color);"></i>
                    <div style="color: var(--danger-color); font-weight: 500;">Erreur de chargement</div>
                    <button class="btn btn-primary" onclick="loadClientsData()">
                        <i class="fas fa-redo"></i> Réessayer
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// ==================== MESSAGES TEMPORAIRES ====================
function showTemporaryMessage(message, type, duration) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert-message ${type}`;
    messageDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(messageDiv);
    
    // Disparaître après la durée spécifiée
    setTimeout(() => {
        messageDiv.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 300);
    }, duration);
}

// Fermer les modals en cliquant à l'extérieur
window.addEventListener('click', function(event) {
    const commandeModal = document.getElementById('commandeModal');
    const fournisseurModal = document.getElementById('fournisseurModal');
    
    if (event.target === commandeModal) {
        closeCommandeModal();
    }
    if (event.target === fournisseurModal) {
        closeFournisseurModal();
    }
});



</script>
</body>
</html>
