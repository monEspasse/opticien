<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Stocks - VisionPro</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Palette de couleurs harmonisée */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --warning-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            
            /* Couleurs de base */
            --primary-50: #f0f4ff;
            --primary-100: #d9e4ff;
            --primary-200: #b3c9ff;
            --primary-300: #8daef8;
            --primary-400: #6793f1;
            --primary-500: #4f46e5;
            --primary-600: #4338ca;
            --primary-700: #3730a3;
            --primary-800: #312e81;
            --primary-900: #1e1b4b;
            
            /* Neutres */
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
            
            /* Éléments d'interface */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            
            /* Bordures */
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
            --border-radius-xl: 32px;
            --border-radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
            font-smooth: always;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: #2d3748;
            position: relative;
        }

        .dashboard {
            min-height: 100vh;
            padding: 2rem;
        }

        .main {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem 2rem;
            box-shadow: var(--glass-shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title {
            position: relative;
            padding-left: 1.5rem;
            font-size: 1.5rem;
            margin: 0;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .page-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-full);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* Navigation entre sections */
        .section-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--glass-border);
        }

        .section-nav-btn {
            padding: 1rem 1.5rem;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            color: var(--gray-600);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-nav-btn:hover {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary-600);
            transform: translateY(-2px);
        }

        .section-nav-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        /* Sections */
        .section-container {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }

        .section-container.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Boutons */
        .btn {
            position: relative;
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            min-width: 120px;
        }

        .btn-primary {
            color: white;
            background: var(--primary-gradient);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--primary-600);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: var(--primary-gradient);
            color: white;
        }

        /* Cartes */
        .produit-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--glass-shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .produit-container:hover {
            transform: translateY(-4px);
            box-shadow: var(--glass-shadow);
        }

        /* Section header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            margin: 0;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Sous-section */
        .subsection {
            margin-bottom: 2rem;
        }

        .subsection-title {
            font-size: 1.25rem;
            color: var(--primary-700);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Grille de statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        /* Indicateurs KPI */
        .kpi-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-gradient);
        }

        .kpi-title {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-600);
            margin-bottom: 0.5rem;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }

        .kpi-trend.positive {
            color: #10b981;
        }

        .kpi-trend.negative {
            color: #ef4444;
        }

        /* Cartes d'analyse */
        .analysis-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .analysis-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-700);
        }

        /* Visualisations */
        .chart-container {
            height: 300px;
            position: relative;
            margin-top: 1rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        /* Tableau */
        .table-container {
            position: relative;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .produit-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            min-width: 1000px;
        }

        .produit-table th,
        .produit-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        .produit-table th {
            background: rgba(79, 70, 229, 0.1);
            font-weight: 600;
            color: var(--primary-700);
        }

        .produit-table tbody tr:hover {
            background: rgba(79, 70, 229, 0.05);
        }

        .text-center {
            text-align: center;
        }

        .text-end {
            text-align: right;
        }

        /* Barre de progression */
        .progress-bar-container {
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: var(--border-radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: var(--border-radius-full);
            transition: width 1s ease;
        }

        /* Messages d'alerte */
        .alert-message {
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-md);
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideInRight 0.3s ease;
        }

        .alert-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-left: 4px solid #10b981;
        }

        .alert-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-left: 4px solid #ef4444;
        }

        .alert-message.info {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-left: 4px solid #3b82f6;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Indicateur de chargement */
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border: 3px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Thème toggle */
        .theme-toggle {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius-full);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--primary-gradient);
            color: white;
        }

        /* Action flottante */
        .floating-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 1000;
        }

        .floating-action-btn {
            width: 56px;
            height: 56px;
            border-radius: var(--border-radius-full);
            border: none;
            background: var(--primary-gradient);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
        }

        .floating-action-btn:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 20px 40px rgba(79, 70, 229, 0.4);
        }

        /* Modales */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            animation: modalSlideUp 0.4s ease;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .medium-modal {
            width: 500px;
            max-width: 95vw;
        }

        .xlarge-modal {
            width: 1200px;
            max-width: 95vw;
            height: 800px;
            max-height: 90vh;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 1.75rem 2rem;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            color: var(--primary-700);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-icon {
            color: var(--primary-500);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-full);
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: var(--gray-500);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(90vh - 200px);
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: rgba(250, 250, 250, 0.8);
        }

        /* Input code */
        .code-input-container {
            margin: 1.5rem 0;
        }

        .code-input-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Barre de progression */
        .progress {
            height: 1.5rem;
            background-color: #e9ecef;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            transition: width 0.6s ease;
        }

        .progress-bar-striped {
            background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        @keyframes progress-bar-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }

        /* Recherche */
        .search-container {
            margin-bottom: 1.5rem;
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            background: rgba(255, 255, 255, 0.9);
            color: var(--gray-800);
            font-family: inherit;
            font-size: 0.9375rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: white;
        }

        /* Input inventaire */
        .nouvelle-quantite {
            width: 100px;
            padding: 0.5rem;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-sm);
            background: white;
            color: var(--gray-800);
            font-family: inherit;
            text-align: center;
        }

        .nouvelle-quantite:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Filtres */
        .filters-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
        }

        .form-control,
        .form-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            background: rgba(255, 255, 255, 0.1);
            color: var(--gray-800);
            font-family: inherit;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                min-width: auto;
            }
            
            .produit-table {
                min-width: 800px;
            }
            
            .filters-panel > div {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 1rem;
            }
            
            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 1.25rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Effets spéciaux pour les cartes de stats */
        .stat-glow {
            position: relative;
            overflow: hidden;
        }

        .stat-glow::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(79, 70, 229, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-glow:hover::after {
            opacity: 1;
        }
        
        /* Styles pour les détails des agences */
        .agence-details {
            margin-top: 0.5rem;
        }
        
        .categorie-ligne {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.75rem;
        }
        
        .categorie-ligne:last-child {
            border-bottom: none;
        }
        
        .categorie-nom {
            flex: 1;
        }
        
        .categorie-stats {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .stock-nombre {
            font-weight: 600;
            color: var(--primary-600);
            min-width: 40px;
            text-align: right;
        }
        
        .stock-pourcentage {
            min-width: 50px;
            text-align: right;
        }
        
        .pourcentage-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .pourcentage-badge.high {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .pourcentage-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .pourcentage-badge.low {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="main">
        <header class="header">
            <div class="header-left">
                <h1 class="page-title">Gestion des Stocks</h1>
            </div>

            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Basculer le mode sombre">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-info">
                    <div class="profile-dropdown" tabindex="0" aria-haspopup="true" aria-expanded="false">
                        <span class="profile-name" id="username-display"></span>
                        <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" alt="Photo de profil" class="profile-img">
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation entre sections -->
        <div class="section-nav">
            <button class="section-nav-btn active" onclick="showSection('gestion-stock')">
                <i class="fas fa-boxes"></i> Gestion des Stocks
            </button>
            <button class="section-nav-btn" onclick="showSection('statistiques')">
                <i class="fas fa-chart-pie"></i> Tableau de Bord
            </button>
        </div>

        <!-- Sections principales -->
        <div class="main-sections">
            <!-- Section 1: Gestion des Stocks -->
            <div id="gestion-stock" class="section-container active">
                <div class="section-header">
                    <h2 class="section-title">Inventaire des Produits</h2>
                    <div class="dashboard-buttons">
                        <button type="button" class="btn btn-primary" onclick="openCodeVerificationDialog()">
                            <i class="fas fa-boxes"></i> Inventaire du stock
                        </button>
                        <button class="btn btn-primary" onclick="exportStockData()" aria-label="Exporter les données">
                            <i class="fas fa-file-export"></i> Exporter
                        </button>
                        <button class="btn btn-secondary" onclick="refreshStockData()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                </div>

                <!-- Filtres -->
                <div class="filters-panel">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="filter-group">
                            <label for="filterCategory" class="filter-group-label">Catégorie</label>
                            <select id="filterCategory" class="form-select" onchange="applyStockFilter()" aria-label="Filtrer par catégorie">
                                <option value="">Toutes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterAgence" class="filter-group-label">Agence</label>
                            <select id="filterAgence" class="form-select" onchange="applyStockFilter()" aria-label="Filtrer par agence">
                                <option value="">Toutes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterReference" class="filter-group-label">Référence</label>
                            <input type="text" id="filterReference" class="form-control" oninput="applyStockFilter()" placeholder="Rechercher référence..." aria-label="Filtrer par référence">
                        </div>
                    </div>
                </div>

                <!-- Tableau -->
                <div class="table-container">
                    <table class="produit-table" id="stockTable" aria-label="Inventaire des produits">
                        <thead id="stockTableHeader">
                            <!-- Les en-têtes seront générés dynamiquement -->
                        </thead>
                        <tbody id="stockData">
                            <tr>
                                <td colspan="12" class="text-center py-4">
                                    <div class="loading-indicator">
                                        <div class="spinner-border" style="color: var(--primary-color);"></div>
                                        <div class="loading-text">Chargement des produits...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Message -->
                <div id="stock-message" class="alert-message" style="display: none; margin-top: 1rem;"></div>
            </div>

            <!-- Section 2: Tableau de Bord Statistiques -->
            <div id="statistiques" class="section-container">
                <div class="section-header">
                    <h2 class="section-title">Tableau de Bord Analytique</h2>
                    <div class="dashboard-buttons">
                        <button class="btn btn-secondary" onclick="refreshStats()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                        <button class="btn btn-primary" onclick="exportStats()">
                            <i class="fas fa-download"></i> Exporter Rapport
                        </button>
                    </div>
                </div>

                <!-- Indicateurs Clés (KPIs) -->
                <div class="produit-container">
                    <h3 class="section-title">Indicateurs Clés de Performance</h3>
                    <div class="stats-grid">
                        <div class="kpi-card stat-glow">
                            <div class="kpi-title">
                                <i class="fas fa-box"></i> Stock des Produits
                            </div>
                            <div class="kpi-value" id="kpi-total-articles">0</div>
                            <div class="kpi-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                <span>+12% vs mois dernier</span>
                            </div>
                        </div>

                        <div class="kpi-card stat-glow">
                            <div class="kpi-title">
                                <i class="fas fa-percentage"></i> Disponibilité par Catégorie
                            </div>
                            <div class="kpi-value" id="kpi-availability">0%</div>
                            <div class="agence-details" id="categorie-disponibilite">
                                <!-- Détails par catégorie -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 1: Analyse par Agence -->
                <div class="subsection">
                    <div class="subsection-title">
                        <i class="fas fa-building"></i> Analyse par Agence
                    </div>
                    
                    <div class="stats-grid">
                        <!-- Carte 1: Répartition par agence -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <div class="analysis-title">Stock par Agence et Catégorie</div>
                                <i class="fas fa-chart-pie" style="color: var(--primary-500);"></i>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartAgenceRepartition"></canvas>
                            </div>
                            <div id="agence-stats" style="margin-top: 1rem;">
                                <!-- Statistiques dynamiques par agence et catégorie -->
                            </div>
                        </div>

                        <!-- Carte 2: Taux de disponibilité par agence -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <div class="analysis-title">Disponibilité par Agence et Catégorie</div>
                                <i class="fas fa-chart-bar" style="color: var(--primary-500);"></i>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartAgenceDisponibilite"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Analyse par Catégorie -->
                <div class="subsection">
                    <div class="subsection-title">
                        <i class="fas fa-tags"></i> Analyse par Catégorie
                    </div>
                    
                    <div class="stats-grid">
                        <!-- Carte 1: Distribution des catégories -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <div class="analysis-title">Distribution des Catégories</div>
                                <i class="fas fa-chart-pie" style="color: var(--primary-500);"></i>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartCategorieDistribution"></canvas>
                            </div>
                        </div>

                        <!-- Carte 2: Stock par catégorie -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <div class="analysis-title">Stock Total par Catégorie</div>
                                <i class="fas fa-chart-bar" style="color: var(--primary-500);"></i>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartCategorieStock"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Visualisations Avancées -->
                <div class="subsection">
                    <div class="subsection-title">
                        <i class="fas fa-brain"></i> Visualisations Intelligentes
                    </div>
                    
                    <div class="stats-grid">
                        <!-- Carte 1: Heatmap des stocks -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <div class="analysis-title">Heatmap des Niveaux de Stock</div>
                                <i class="fas fa-fire" style="color: var(--primary-500);"></i>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartStockHeatmap"></canvas>
                            </div>
                        </div>

                        <!-- Carte 2: Évolution temporelle -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <div class="analysis-title">Évolution du Stock (6 derniers mois)</div>
                                <i class="fas fa-chart-line" style="color: var(--primary-500);"></i>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartStockEvolution"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Recommandations IA -->
                <div class="produit-container" style="margin-top: 2rem;">
                    <h3 class="section-title">
                        <i class="fas fa-robot"></i> Recommandations Intelligentes
                    </h3>
                    <div id="ai-recommendations" style="display: grid; gap: 1rem; margin-top: 1rem;">
                        <!-- Les recommandations seront générées dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action flottante -->
<div class="floating-actions">
    <button class="floating-action-btn back" title="Retour" onclick="goBack()" aria-label="Retour">
        <i class="fas fa-arrow-left"></i>
    </button>
</div>

<!-- Conteneur pour les modales -->
<div id="modal-container"></div>

<script>
// ==================== GESTIONNAIRE DE DONNÉES ====================
class StockManager {
    constructor() {
        this.allData = [];
        this.filteredData = [];
        this.stats = {
            totalProducts: 0,
            totalValue: 0,
            categoryCount: 0
        };
        this.charts = {};
    }

    async loadData() {
        try {
            const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importproduits`;
            
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
            
            const responseData = await response.json();
            
            if (!responseData?.data?.rows || !responseData?.data?.headers) {
                throw new Error('Structure de données invalide');
            }
            
            this.allData = responseData.data.rows.map(row => {
                const item = {};
                responseData.data.headers.forEach((header, index) => {
                    const cleanHeader = header.trim();
                    let value = row[index] || '';
                    
                    // Convertir les nombres
                    if (cleanHeader.includes('Stock') || cleanHeader.includes('Prix') || 
                        cleanHeader.includes('Conso') || cleanHeader === 'Stock de depart') {
                        value = parseFloat(value) || 0;
                    }
                    
                    item[cleanHeader] = value;
                });
                return item;
            });

            this.allData.sort((a, b) => {
                const dateA = a['Date'] ? new Date(a['Date']) : new Date(0);
                const dateB = b['Date'] ? new Date(b['Date']) : new Date(0);
                return dateB - dateA;
            });

            this.filteredData = [...this.allData];
            this.updateStats();
            return true;
            
        } catch (error) {
            console.error('Erreur:', error);
            throw error;
        }
    }

    updateStats() {
        this.stats.totalProducts = this.allData.length;
        
        // Calcul de la valeur totale
        this.stats.totalValue = this.allData.reduce((sum, item) => {
            const price = parseFloat(item['Prix de vente']) || 0;
            const stockPhysique = parseFloat(item['Stock Physique']) || 0;
            return sum + (price * stockPhysique);
        }, 0);
        
        // Compter les catégories uniques
        const uniqueCategories = [...new Set(this.allData.map(item => item['Catégorie']).filter(Boolean))];
        this.stats.categoryCount = uniqueCategories.length;
    }

    applyFilters(filters) {
        this.filteredData = this.allData.filter(item => {
            const categoryMatch = !filters.category || item['Catégorie'] === filters.category;
            const agenceMatch = !filters.agence || item['Agence'] === filters.agence;
            
            const referenceMatch = !filters.reference || 
                (item['Référence'] && item['Référence'].toLowerCase().includes(filters.reference.toLowerCase()));
            
            return categoryMatch && agenceMatch && referenceMatch;
        });
    }

    // Méthodes pour les statistiques avancées
    getAgenceStats() {
        const agenceStats = {};
        
        this.allData.forEach(item => {
            const agence = item['Agence'] || 'Non spécifiée';
            const categorie = item['Catégorie'] || 'Non spécifiée';
            
            if (!agenceStats[agence]) {
                agenceStats[agence] = {
                    count: 0,
                    totalStockDepart: 0,
                    totalStockPhysique: 0,
                    categories: {}
                };
            }
            
            agenceStats[agence].count++;
            
            const stockDepart = parseFloat(item['Stock de depart']) || 0;
            const stockPhysique = parseFloat(item['Stock Physique']) || 0;
            
            agenceStats[agence].totalStockDepart += stockDepart;
            agenceStats[agence].totalStockPhysique += stockPhysique;
            
            if (!agenceStats[agence].categories[categorie]) {
                agenceStats[agence].categories[categorie] = {
                    stockDepart: 0,
                    stockPhysique: 0,
                    count: 0
                };
            }
            
            agenceStats[agence].categories[categorie].stockDepart += stockDepart;
            agenceStats[agence].categories[categorie].stockPhysique += stockPhysique;
            agenceStats[agence].categories[categorie].count++;
        });
        
        return agenceStats;
    }

    getCategorieStats() {
        const categorieStats = {};
        
        this.allData.forEach(item => {
            const categorie = item['Catégorie'] || 'Non spécifiée';
            if (!categorieStats[categorie]) {
                categorieStats[categorie] = {
                    count: 0,
                    totalStockDepart: 0,
                    totalStockPhysique: 0,
                    tauxDisponibilite: 0,
                    agences: new Set()
                };
            }
            
            categorieStats[categorie].count++;
            
            const stockDepart = parseFloat(item['Stock de depart']) || 0;
            const stockPhysique = parseFloat(item['Stock Physique']) || 0;
            
            categorieStats[categorie].totalStockDepart += stockDepart;
            categorieStats[categorie].totalStockPhysique += stockPhysique;
            
            if (item['Agence']) {
                categorieStats[categorie].agences.add(item['Agence']);
            }
        });
        
        // Calculer le taux de disponibilité pour chaque catégorie
        Object.keys(categorieStats).forEach(categorie => {
            const stats = categorieStats[categorie];
            stats.tauxDisponibilite = stats.totalStockDepart > 0 ? 
                (stats.totalStockPhysique / stats.totalStockDepart) * 100 : 0;
        });
        
        return categorieStats;
    }

    getDisponibiliteStats() {
        let totalStockDepart = 0;
        let totalStockPhysique = 0;
        
        this.allData.forEach(item => {
            totalStockDepart += parseFloat(item['Stock de depart']) || 0;
            totalStockPhysique += parseFloat(item['Stock Physique']) || 0;
        });
        
        const tauxDisponibilite = totalStockDepart > 0 ? (totalStockPhysique / totalStockDepart * 100) : 0;
        
        return {
            stockDepart: totalStockDepart,
            stockPhysique: totalStockPhysique,
            tauxDisponibilite: tauxDisponibilite
        };
    }

    getStockLevelAnalysis() {
        const analysis = {
            faible: 0,      // ≤ 5
            moyen: 0,       // 6-20
            eleve: 0,       // > 20
            epuise: 0       // 0
        };
        
        this.allData.forEach(item => {
            const stock = parseFloat(item['Stock Physique']) || 0;
            if (stock === 0) {
                analysis.epuise++;
            } else if (stock <= 5) {
                analysis.faible++;
            } else if (stock <= 20) {
                analysis.moyen++;
            } else {
                analysis.eleve++;
            }
        });
        
        return analysis;
    }

    getAIRecommendations() {
        const recommendations = [];
        const disponibilite = this.getDisponibiliteStats();
        const stockLevels = this.getStockLevelAnalysis();
        const agenceStats = this.getAgenceStats();
        
        // Recommandation 1: Taux de disponibilité
        if (disponibilite.tauxDisponibilite < 80) {
            recommendations.push({
                type: 'warning',
                icon: 'exclamation-triangle',
                title: 'Taux de disponibilité faible',
                description: `Seulement ${disponibilite.tauxDisponibilite.toFixed(1)}% du stock initial est disponible`,
                action: 'Envisagez de réapprovisionner les produits épuisés'
            });
        } else {
            recommendations.push({
                type: 'success',
                icon: 'check-circle',
                title: 'Taux de disponibilité excellent',
                description: `${disponibilite.tauxDisponibilite.toFixed(1)}% du stock est disponible`,
                action: 'Continuez à maintenir ce niveau'
            });
        }
        
        // Recommandation 2: Stock faible
        if (stockLevels.faible > 0 || stockLevels.epuise > 0) {
            recommendations.push({
                type: 'danger',
                icon: 'box',
                title: 'Stock faible ou épuisé',
                description: `${stockLevels.faible + stockLevels.epuise} produits nécessitent un réapprovisionnement`,
                action: 'Priorisez la commande de ces produits'
            });
        }
        
        // Recommandation 3: Distribution par agence
        const agences = Object.keys(agenceStats);
        if (agences.length > 1) {
            const counts = agences.map(a => agenceStats[a].count);
            const maxCount = Math.max(...counts);
            const minCount = Math.min(...counts);
            
            if (maxCount / minCount > 3) {
                recommendations.push({
                    type: 'info',
                    icon: 'balance-scale',
                    title: 'Déséquilibre entre agences',
                    description: 'La distribution des produits est inégale entre les différentes agences',
                    action: 'Rééquilibrez le stock entre les agences'
                });
            }
        }
        
        // Recommandation 4: Analyse de la valeur
        const totalValue = this.stats.totalValue;
        const avgValuePerProduct = totalValue / this.stats.totalProducts;
        
        if (avgValuePerProduct > 50000) {
            recommendations.push({
                type: 'info',
                icon: 'coins',
                title: 'Valeur moyenne élevée',
                description: `La valeur moyenne par produit est de ${StockUIManager.formatCurrency(avgValuePerProduct)}`,
                action: 'Surveillez attentivement ces produits à haute valeur'
            });
        }
        
        return recommendations;
    }
}

// ==================== GESTIONNAIRE D'INTERFACE ====================
class StockUIManager {
    static showMessage(message, type, duration = 3000) {
        const messageDiv = document.getElementById('stock-message');
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `alert-message ${type}`;
            messageDiv.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, duration);
            }
        }
    }

    static showLoading() {
        document.getElementById('stockData').innerHTML = `
            <tr>
                <td colspan="12" class="text-center py-4">
                    <div class="loading-indicator">
                        <div class="spinner-border" style="color: var(--primary-color);"></div>
                        <div class="loading-text">Chargement des produits...</div>
                    </div>
                </td>
            </tr>
        `;
    }

    static populateSelect(selectId, values, placeholder = 'Tous') {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        select.innerHTML = `<option value="">${placeholder}</option>`;
        
        if (!values || !values.length) return;
        
        values.sort().forEach(value => {
            if (value) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            }
        });
    }

    static formatCurrency(amount) {
        if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
        return amount.toLocaleString('fr-FR', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        }) + ' FCFA';
    }

    static formatDate(dateString) {
        if (!dateString) return '';
        try {
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('fr-FR');
        } catch (e) {
            return dateString;
        }
    }

    static formatPercentage(value) {
        return `${value.toFixed(1)}%`;
    }
    
    static getPercentageBadgeClass(pourcentage) {
        if (pourcentage >= 80) return 'high';
        if (pourcentage >= 60) return 'medium';
        return 'low';
    }
}

// ==================== GESTIONNAIRE DE GRAPHIQUES ====================
class StockChartManager {
    static createAgenceRepartitionChart(data, canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        const agences = Object.keys(data).filter(a => a !== 'Non spécifiée');
        const counts = agences.map(agence => data[agence].count);
        
        const colors = this.generateColors(agences.length);
        
        return new Chart(ctx, {
            type: 'pie',
            data: {
                labels: agences,
                datasets: [{
                    data: counts,
                    backgroundColor: colors,
                    borderColor: 'white',
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} articles (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    static createAgenceDisponibiliteChart(data, canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Préparer les données pour le graphique groupé par agence et catégorie
        const agences = Object.keys(data).filter(a => a !== 'Non spécifiée');
        const categories = new Set();
        
        // Récupérer toutes les catégories
        agences.forEach(agence => {
            const agenceCategories = Object.keys(data[agence].categories || {});
            agenceCategories.forEach(cat => {
                if (cat !== 'Non spécifiée') {
                    categories.add(cat);
                }
            });
        });
        
        const categoryArray = Array.from(categories);
        
        // Créer les datasets pour chaque agence
        const datasets = agences.map((agence, agenceIndex) => {
            const tauxDisponibilite = categoryArray.map(categorie => {
                const categorieData = data[agence].categories[categorie];
                if (!categorieData) return 0;
                
                const taux = categorieData.stockDepart > 0 ? 
                    (categorieData.stockPhysique / categorieData.stockDepart) * 100 : 0;
                return taux;
            });
            
            const color = this.generateColors(agences.length)[agenceIndex];
            
            return {
                label: agence,
                data: tauxDisponibilite,
                backgroundColor: color.replace(')', ', 0.7)').replace('rgb', 'rgba'),
                borderColor: color,
                borderWidth: 1,
                borderRadius: 4
            };
        });
        
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categoryArray,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: false,
                        title: {
                            display: true,
                            text: 'Catégories'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        stacked: false,
                        title: {
                            display: true,
                            text: 'Disponibilité (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const agence = context.dataset.label;
                                const categorie = categoryArray[context.dataIndex];
                                const taux = context.raw || 0;
                                const categorieData = data[agence]?.categories?.[categorie];
                                
                                if (!categorieData) return `${agence}: ${taux.toFixed(1)}%`;
                                
                                return `${agence} - ${categorie}: ${categorieData.stockPhysique} | ${taux.toFixed(1)}%`;
                            }
                        }
                    }
                }
            }
        });
    }

    static createCategorieDistributionChart(data, canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        const categories = Object.keys(data).filter(c => c !== 'Non spécifiée');
        const counts = categories.map(categorie => data[categorie].count);
        
        const colors = this.generateColors(categories.length, 0.7);
        
        return new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: counts,
                    backgroundColor: colors,
                    borderColor: 'white',
                    borderWidth: 2,
                    hoverOffset: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    static createCategorieStockChart(data, canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        const categories = Object.keys(data).filter(c => c !== 'Non spécifiée');
        const stocks = categories.map(categorie => data[categorie].totalStockPhysique);
        
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(79, 70, 229, 0.8)');
        gradient.addColorStop(1, 'rgba(79, 70, 229, 0.2)');
        
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [{
                    label: 'Stock physique',
                    data: stocks,
                    backgroundColor: gradient,
                    borderColor: 'rgba(79, 70, 229, 1)',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantité'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    static createStockHeatmapChart(data, canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Pour cette démo, nous allons simuler une heatmap
        // Dans une vraie application, vous utiliseriez des données réelles
        
        const categories = ['Monture', 'Étui', 'Nettoyant', 'Verre', 'Accessoire'];
        const agences = ['Cotonou', 'Porto-Novo', 'Bohicon'];
        
        const heatmapData = [];
        
        // Générer des données aléatoires pour la démo
        for (let i = 0; i < categories.length; i++) {
            for (let j = 0; j < agences.length; j++) {
                heatmapData.push({
                    x: agences[j],
                    y: categories[i],
                    v: Math.floor(Math.random() * 100) + 10
                });
            }
        }
        
        // Créer un scatter chart pour simuler une heatmap
        return new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Niveau de stock',
                    data: heatmapData,
                    backgroundColor: function(context) {
                        const value = context.raw.v;
                        if (value >= 70) return 'rgba(16, 185, 129, 0.7)';
                        if (value >= 40) return 'rgba(245, 158, 11, 0.7)';
                        return 'rgba(239, 68, 68, 0.7)';
                    },
                    pointRadius: function(context) {
                        return context.raw.v / 10 + 5;
                    },
                    borderColor: 'white',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Agence'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Catégorie'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Stock: ${context.raw.v} unités`;
                            }
                        }
                    }
                }
            }
        });
    }

    static createStockEvolutionChart(data, canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Simuler des données d'évolution sur 6 mois
        const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin'];
        const stockData = months.map(() => Math.floor(Math.random() * 500) + 200);
        const valueData = months.map(() => Math.floor(Math.random() * 5000000) + 1000000);
        
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [
                    {
                        label: 'Quantité de stock',
                        data: stockData,
                        borderColor: 'rgb(79, 70, 229)',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.3,
                        fill: true,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Valeur (millions FCFA)',
                        data: valueData.map(v => v / 1000000),
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.3,
                        fill: true,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Quantité'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Valeur (millions FCFA)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }

    static generateColors(count, opacity = 1) {
        const colors = [
            `rgba(79, 70, 229, ${opacity})`,
            `rgba(245, 158, 11, ${opacity})`,
            `rgba(16, 185, 129, ${opacity})`,
            `rgba(239, 68, 68, ${opacity})`,
            `rgba(139, 92, 246, ${opacity})`,
            `rgba(14, 165, 233, ${opacity})`,
            `rgba(20, 184, 166, ${opacity})`
        ];
        
        // Si nous avons plus de catégories que de couleurs, répéter
        const result = [];
        for (let i = 0; i < count; i++) {
            result.push(colors[i % colors.length]);
        }
        return result;
    }
}

// ==================== INSTANCE GLOBALE ====================
const stockManager = new StockManager();
let allProduitData = [];

// ==================== NAVIGATION ENTRE SECTIONS ====================
function showSection(sectionId) {
    // Masquer toutes les sections
    document.querySelectorAll('.section-container').forEach(section => {
        section.classList.remove('active');
    });
    
    // Désactiver tous les boutons de navigation
    document.querySelectorAll('.section-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Activer la section sélectionnée
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.add('active');
        
        // Activer le bouton correspondant
        const btn = document.querySelector(`.section-nav-btn[onclick*="${sectionId}"]`);
        if (btn) {
            btn.classList.add('active');
        }
        
        // Charger les données si nécessaire
        if (sectionId === 'statistiques') {
            loadStats();
        }
    }
}

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', () => {
    // Initialiser le thème
    initTheme();
    
    // Charger les données
    loadStockData();
    
    // Configurer les événements
    setupEventListeners();
});

function initTheme() {
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            localStorage.setItem('theme', 'light');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
        
        // Redessiner les graphiques si nécessaire
        if (document.getElementById('statistiques').classList.contains('active')) {
            setTimeout(() => {
                Object.values(stockManager.charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 100);
        }
    });
}

async function loadStockData() {
    StockUIManager.showLoading();
    
    try {
        await stockManager.loadData();
        
        // Stocker les données pour l'inventaire
        allProduitData = stockManager.allData.map(item => ({
            ID: item['Date'] || '',
            Categorie: item['Catégorie'] || '',
            Reference: item['Référence'] || '',
            Agence: item['Agence'] || '',
            Price: StockUIManager.formatCurrency(item['Prix de vente'] || 0),
            Disponible: parseFloat(item['Stock Physique']) || 0
        }));
        
        // Générer les en-têtes de tableau sans la colonne Actions
        generateTableHeaders();
        
        // Remplir les filtres
        populateFilters();
        
        // Afficher les données
        displayStockData();
        
    } catch (error) {
        console.error('Erreur:', error);
        StockUIManager.showMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'error');
        document.getElementById('stockData').innerHTML = '<tr><td colspan="12" class="text-center">Erreur de chargement</td></tr>';
    }
}

function generateTableHeaders() {
    const tableHeader = document.getElementById('stockTableHeader');
    if (!stockManager.allData[0]) return;
    
    const headers = Object.keys(stockManager.allData[0]);
    const headerRow = document.createElement('tr');
    
    // Retirer la colonne "User" si elle existe
    const headersToShow = headers.filter(header => header !== 'User');
    
    headersToShow.forEach(header => {
        const th = document.createElement('th');
        th.setAttribute('scope', 'col');
        
        if (header.includes('Prix') || header.includes('Stock')) {
            th.className = 'text-end';
        }
        
        th.textContent = header;
        headerRow.appendChild(th);
    });
    
    tableHeader.innerHTML = '';
    tableHeader.appendChild(headerRow);
}

function populateFilters() {
    const uniqueCategories = [...new Set(stockManager.allData.map(item => item['Catégorie']).filter(Boolean))];
    const uniqueAgences = [...new Set(stockManager.allData.map(item => item['Agence']).filter(Boolean))];
    
    StockUIManager.populateSelect('filterCategory', uniqueCategories, 'Toutes');
    StockUIManager.populateSelect('filterAgence', uniqueAgences, 'Toutes');
}

function displayStockData() {
    const stockData = document.getElementById('stockData');
    const headers = Object.keys(stockManager.allData[0] || {});
    
    if (!stockManager.filteredData?.length) {
        stockData.innerHTML = '<tr><td colspan="12" class="text-center">Aucun produit trouvé</td></tr>';
        return;
    }
    
    let html = '';
    stockManager.filteredData.forEach((item, index) => {
        html += '<tr>';
        
        // Retirer la colonne "User" si elle existe
        const headersToShow = headers.filter(header => header !== 'User');
        
        headersToShow.forEach(header => {
            const value = item[header] || '';
            
            if (header === 'Date') {
                html += `<td>${StockUIManager.formatDate(value)}</td>`;
            } 
            else if (header.includes('Prix')) {
                html += `<td class="text-end">${StockUIManager.formatCurrency(value)}</td>`;
            }
            else if (header.includes('Stock')) {
                html += `<td class="text-end">${value}</td>`;
            }
            else {
                html += `<td>${value}</td>`;
            }
        });
        
        html += '</tr>';
    });
    
    stockData.innerHTML = html;
}

function applyStockFilter() {
    const filters = {
        category: document.getElementById('filterCategory').value,
        agence: document.getElementById('filterAgence').value,
        reference: document.getElementById('filterReference').value
    };
    
    stockManager.applyFilters(filters);
    displayStockData();
}

function setupEventListeners() {
    // Recherche en temps réel pour la référence
    const referenceFilter = document.getElementById('filterReference');
    if (referenceFilter) {
        let timeout;
        referenceFilter.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(applyStockFilter, 300);
        });
    }
}

function refreshStockData() {
    loadStockData();
    StockUIManager.showMessage('Données actualisées avec succès', 'success', 2000);
}

function exportStockData() {
    const data = stockManager.filteredData;
    if (!data.length) {
        StockUIManager.showMessage('Aucune donnée à exporter', 'warning', 3000);
        return;
    }
    
    // Créer un CSV
    const headers = Object.keys(data[0]);
    // Retirer la colonne "User" si elle existe
    const headersToExport = headers.filter(header => header !== 'User');
    
    const csvContent = [
        headersToExport.join(','),
        ...data.map(row => headersToExport.map(header => {
            let cell = row[header] || '';
            // Échapper les guillemets
            if (typeof cell === 'string') {
                cell = cell.replace(/"/g, '""');
                if (cell.includes(',') || cell.includes('\n') || cell.includes('"')) {
                    cell = `"${cell}"`;
                }
            }
            return cell;
        }).join(','))
    ].join('\n');
    
    // Télécharger le fichier
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `stock_visionpro_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    StockUIManager.showMessage('Export CSV généré avec succès', 'success', 3000);
}

// ==================== STATISTIQUES ====================
async function loadStats() {
    try {
        // Mettre à jour les KPIs
        updateKPIs();
        
        // Générer les graphiques
        generateCharts();
        
        // Générer les recommandations IA
        generateAIRecommendations();
        
        // Mettre à jour les statistiques par agence
        updateAgenceStats();
        
    } catch (error) {
        console.error('Erreur lors du chargement des statistiques:', error);
        StockUIManager.showMessage('❌ Erreur lors du chargement des statistiques', 'error');
    }
}

function updateKPIs() {
    // Stock des produits
    document.getElementById('kpi-total-articles').textContent = stockManager.stats.totalProducts;
    
    // Taux de disponibilité global
    const disponibilite = stockManager.getDisponibiliteStats();
    document.getElementById('kpi-availability').textContent = StockUIManager.formatPercentage(disponibilite.tauxDisponibilite);
    
    // Détails par catégorie
    const categorieStats = stockManager.getCategorieStats();
    const container = document.getElementById('categorie-disponibilite');
    
    if (container) {
        let html = '';
        Object.keys(categorieStats)
            .filter(cat => cat !== 'Non spécifiée')
            .sort((a, b) => categorieStats[b].totalStockPhysique - categorieStats[a].totalStockPhysique)
            .slice(0, 5) // Afficher les 5 principales catégories
            .forEach(categorie => {
                const stats = categorieStats[categorie];
                const pourcentage = stats.tauxDisponibilite;
                const badgeClass = StockUIManager.getPercentageBadgeClass(pourcentage);
                
                html += `
                    <div class="categorie-ligne">
                        <div class="categorie-nom">${categorie}</div>
                        <div class="categorie-stats">
                            <span class="stock-nombre">${stats.totalStockPhysique}</span>
                            <span class="stock-pourcentage">
                                <span class="pourcentage-badge ${badgeClass}">${pourcentage.toFixed(0)}%</span>
                            </span>
                        </div>
                    </div>
                `;
            });
        
        container.innerHTML = html;
    }
}

function generateCharts() {
    // Détruire les anciens graphiques
    Object.values(stockManager.charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    
    stockManager.charts = {};
    
    // Obtenir les données statistiques
    const agenceStats = stockManager.getAgenceStats();
    const categorieStats = stockManager.getCategorieStats();
    
    // Créer les graphiques
    stockManager.charts.agenceRepartition = StockChartManager.createAgenceRepartitionChart(
        agenceStats,
        'chartAgenceRepartition'
    );
    
    stockManager.charts.agenceDisponibilite = StockChartManager.createAgenceDisponibiliteChart(
        agenceStats,
        'chartAgenceDisponibilite'
    );
    
    stockManager.charts.categorieDistribution = StockChartManager.createCategorieDistributionChart(
        categorieStats,
        'chartCategorieDistribution'
    );
    
    stockManager.charts.categorieStock = StockChartManager.createCategorieStockChart(
        categorieStats,
        'chartCategorieStock'
    );
    
    stockManager.charts.stockHeatmap = StockChartManager.createStockHeatmapChart(
        stockManager.allData,
        'chartStockHeatmap'
    );
    
    stockManager.charts.stockEvolution = StockChartManager.createStockEvolutionChart(
        stockManager.allData,
        'chartStockEvolution'
    );
}

function updateAgenceStats() {
    const agenceStats = stockManager.getAgenceStats();
    const container = document.getElementById('agence-stats');
    
    if (!container) return;
    
    const agences = Object.keys(agenceStats)
        .filter(a => a !== 'Non spécifiée')
        .sort((a, b) => agenceStats[b].count - agenceStats[a].count);
    
    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">';
    
    agences.forEach(agence => {
        const stats = agenceStats[agence];
        const tauxGlobal = stats.totalStockDepart > 0 ? 
            (stats.totalStockPhysique / stats.totalStockDepart) * 100 : 0;
        
        html += `
            <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: var(--border-radius-md);">
                <div style="font-weight: 600; color: var(--primary-600); margin-bottom: 0.5rem;">
                    ${agence} 
                    <span style="font-size: 0.75rem; color: var(--gray-500); font-weight: normal;">
                        (${stats.count} articles)
                    </span>
                </div>
                <div style="font-size: 0.75rem; margin-bottom: 0.5rem;">
                    Stock départ: ${stats.totalStockDepart} | Physique: ${stats.totalStockPhysique}
                </div>
                <div class="agence-details">
        `;
        
        // Afficher les catégories de cette agence
        const categories = Object.keys(stats.categories || {})
            .filter(cat => cat !== 'Non spécifiée')
            .sort((a, b) => stats.categories[b].stockPhysique - stats.categories[a].stockPhysique);
        
        categories.forEach(categorie => {
            const catStats = stats.categories[categorie];
            const pourcentage = catStats.stockDepart > 0 ? 
                (catStats.stockPhysique / catStats.stockDepart) * 100 : 0;
            const badgeClass = StockUIManager.getPercentageBadgeClass(pourcentage);
            
            html += `
                <div class="categorie-ligne">
                    <div class="categorie-nom">${categorie}</div>
                    <div class="categorie-stats">
                        <span class="stock-nombre">${catStats.stockPhysique}</span>
                        <span class="stock-pourcentage">
                            <span class="pourcentage-badge ${badgeClass}">${pourcentage.toFixed(0)}%</span>
                        </span>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function generateAIRecommendations() {
    const recommendations = stockManager.getAIRecommendations();
    const container = document.getElementById('ai-recommendations');
    
    if (!container) return;
    
    let html = '';
    
    recommendations.forEach((rec, index) => {
        const iconColor = rec.type === 'success' ? '#10b981' : 
                         rec.type === 'warning' ? '#f59e0b' : 
                         rec.type === 'danger' ? '#ef4444' : '#3b82f6';
        
        html += `
            <div style="background: ${rec.type === 'success' ? 'rgba(16, 185, 129, 0.1)' : 
                              rec.type === 'warning' ? 'rgba(245, 158, 11, 0.1)' : 
                              rec.type === 'danger' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)'};
                    border-left: 4px solid ${iconColor};
                    padding: 1rem;
                    border-radius: var(--border-radius-md);
                    display: flex;
                    gap: 1rem;
                    align-items: flex-start;">
                <div style="color: ${iconColor}; font-size: 1.25rem;">
                    <i class="fas fa-${rec.icon}"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${rec.title}</div>
                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">${rec.description}</div>
                    <div style="font-size: 0.75rem; color: var(--gray-500);">
                        <i class="fas fa-lightbulb"></i> ${rec.action}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function refreshStats() {
    loadStats();
    StockUIManager.showMessage('Statistiques actualisées', 'success', 2000);
}

function exportStats() {
    // Créer un rapport PDF ou HTML
    const statsData = {
        kpis: {
            totalArticles: stockManager.stats.totalProducts,
            totalValue: stockManager.stats.totalValue,
            categories: stockManager.stats.categoryCount,
            disponibilite: stockManager.getDisponibiliteStats().tauxDisponibilite
        },
        agenceStats: stockManager.getAgenceStats(),
        categorieStats: stockManager.getCategorieStats(),
        recommendations: stockManager.getAIRecommendations()
    };
    
    // Créer un rapport texte simple
    let report = `RAPPORT DE STOCK - ${new Date().toLocaleDateString('fr-FR')}\n\n`;
    report += `=== INDICATEURS CLÉS ===\n`;
    report += `Total articles: ${statsData.kpis.totalArticles}\n`;
    report += `Valeur totale: ${StockUIManager.formatCurrency(statsData.kpis.totalValue)}\n`;
    report += `Catégories actives: ${statsData.kpis.categories}\n`;
    report += `Taux de disponibilité: ${statsData.kpis.disponibilite.toFixed(1)}%\n\n`;
    
    report += `=== ANALYSE PAR AGENCE ===\n`;
    Object.keys(statsData.agenceStats).forEach(agence => {
        if (agence !== 'Non spécifiée') {
            const stats = statsData.agenceStats[agence];
            report += `${agence}: ${stats.count} articles, ${stats.totalStock} unités, ${StockUIManager.formatCurrency(stats.totalValue)}\n`;
        }
    });
    
    report += `\n=== RECOMMANDATIONS ===\n`;
    statsData.recommendations.forEach(rec => {
        report += `• ${rec.title}: ${rec.description}\n  ${rec.action}\n`;
    });
    
    // Télécharger le rapport
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `rapport_stock_${new Date().toISOString().split('T')[0]}.txt`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    StockUIManager.showMessage('Rapport généré avec succès', 'success', 3000);
}

// ==================== INVENTAIRE ====================
function openCodeVerificationDialog() {
    const modalContainer = document.getElementById('modal-container');
    const codeDialogHTML = `
        <div class="modal-overlay active" id="codeVerificationModal">
            <div class="modal-content medium-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-shield-alt modal-icon"></i> Accès à l'Inventaire
                    </h3>
                    <button class="modal-close" onclick="fermerCodeDialog()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert-message info" style="margin-bottom: 1.5rem;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Accès sécurisé requis. Un code de vérification a été envoyé par email.
                    </div>
                    
                    <div class="code-input-container">
                        <label for="codeInput">Code de vérification à 6 chiffres :</label>
                        <input type="text" 
                               class="form-control" 
                               id="codeInput"
                               maxlength="6"
                               placeholder="000000"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,6)">
                        <div style="font-size: 0.875rem; color: var(--gray-500); margin-top: 0.5rem;">Veuillez saisir le code reçu par email</div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin: 1.5rem 0;">
                        <button type="button" class="btn btn-secondary" onclick="regenererCode()">
                            <i class="fas fa-redo"></i> Régénérer le code
                        </button>
                    </div>
                    
                    <div id="codeMessage" class="alert-message" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="verifierCodeAcces()" id="btnVerifierCode">
                        <i class="fas fa-check"></i> Vérifier le code
                    </button>
                </div>
            </div>
        </div>
    `;
    modalContainer.innerHTML = codeDialogHTML;
    
    setTimeout(() => {
        const codeInput = document.getElementById('codeInput');
        if (codeInput) {
            codeInput.focus();
        }
    }, 100);
    
    regenererCode();
}

function fermerCodeDialog() {
    const modal = document.getElementById('codeVerificationModal');
    if (modal) {
        modal.remove();
    }
}

async function regenererCode() {
    try {
        const btnVerifier = document.getElementById('btnVerifierCode');
        const messageDiv = document.getElementById('codeMessage');
        
        btnVerifier.disabled = true;
        btnVerifier.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
        
        if (messageDiv) {
            messageDiv.style.display = 'none';
        }
        
        const response = await fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=accesinventaire', {
            method: 'GET',
            mode: 'no-cors'
        });
        
        btnVerifier.disabled = false;
        btnVerifier.innerHTML = '<i class="fas fa-check"></i> Vérifier le code';
        
        showCodeMessage('✅ Nouveau code généré et envoyé par email !', 'success');
        
        const codeInput = document.getElementById('codeInput');
        if (codeInput) {
            codeInput.value = '';
            codeInput.focus();
        }
        
    } catch (error) {
        console.error('Erreur génération code:', error);
        showCodeMessage('❌ Erreur lors de la génération du code', 'error');
        
        const btnVerifier = document.getElementById('btnVerifierCode');
        if (btnVerifier) {
            btnVerifier.disabled = false;
            btnVerifier.innerHTML = '<i class="fas fa-check"></i> Vérifier le code';
        }
    }
}

async function verifierCodeAcces() {
    const codeInput = document.getElementById('codeInput');
    const code = codeInput.value.trim();
    
    if (!code || code.length !== 6) {
        showCodeMessage('❌ Veuillez saisir un code à 6 chiffres', 'error');
        codeInput.focus();
        return;
    }
    
    try {
        const btnVerifier = document.getElementById('btnVerifierCode');
        const messageDiv = document.getElementById('codeMessage');
        
        btnVerifier.disabled = true;
        btnVerifier.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vérification...';
        
        if (messageDiv) {
            messageDiv.style.display = 'none';
        }
        
        const response = await fetch(`https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=codeaccess&code=${code}`, {
            method: 'GET',
            mode: 'no-cors'
        });
        
        setTimeout(() => {
            btnVerifier.disabled = false;
            btnVerifier.innerHTML = '<i class="fas fa-check"></i> Vérifier le code';
            
            if (code.length === 6 && /^\d+$/.test(code)) {
                showCodeMessage('✅ Code vérifié avec succès ! Ouverture de l\'inventaire...', 'success');
                
                setTimeout(() => {
                    fermerCodeDialog();
                    openInventaireUpdate();
                }, 1500);
            } else {
                showCodeMessage('❌ Code incorrect. Veuillez réessayer.', 'error');
                codeInput.focus();
                codeInput.select();
            }
        }, 1000);
        
    } catch (error) {
        console.error('Erreur vérification code:', error);
        showCodeMessage('❌ Erreur lors de la vérification du code', 'error');
        
        const btnVerifier = document.getElementById('btnVerifierCode');
        if (btnVerifier) {
            btnVerifier.disabled = false;
            btnVerifier.innerHTML = '<i class="fas fa-check"></i> Vérifier le code';
        }
    }
}

function showCodeMessage(message, type) {
    const messageDiv = document.getElementById('codeMessage');
    if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.className = `alert-message ${type}`;
        messageDiv.style.display = 'block';
    }
}

// ==================== INVENTAIRE UPDATE ====================
function openInventaireUpdate() {
    const modalContainer = document.getElementById('modal-container');
    const inventaireHTML = `
        <div class="modal-overlay active" id="inventaireModal">
            <div class="modal-content xlarge-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-clipboard-list modal-icon"></i> Mise à jour du Stock d'Inventaire
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert-message info" style="margin-bottom: 1.5rem;">
                        <i class="fas fa-info-circle"></i> 
                        Mettez à jour les quantités disponibles pour chaque produit.
                    </div>
                    
                    <div class="search-container">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" 
                                   class="search-input" 
                                   id="searchReference"
                                   placeholder="Rechercher une référence..."
                                   autocomplete="off">
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="produit-table" id="inventaireTable">
                            <thead>
                                <tr>
                                    <th>Catégorie</th>
                                    <th>Référence</th>
                                    <th>Agence</th>
                                    <th>Prix</th>
                                    <th>Stock Actuel</th>
                                    <th>Nouveau Stock</th>
                                </tr>
                            </thead>
                            <tbody id="inventaireData">
                                ${allProduitData.map(item => {
                                    const reference = item.Reference || '';
                                    const referenceString = String(reference);
                                    const referenceLower = referenceString.toLowerCase();
                                    
                                    return `
                                    <tr class="product-row" data-reference="${referenceLower}">
                                        <td>${item.Categorie || ''}</td>
                                        <td class="reference-cell">${referenceString}</td>
                                        <td>${item.Agence || ''}</td>
                                        <td>${item.Price || ''}</td>
                                        <td>${item.Disponible || 0}</td>
                                        <td>
                                            <input type="number" 
                                                   class="nouvelle-quantite" 
                                                   data-id="${item.ID || ''}"
                                                   data-reference="${referenceString}"
                                                   min="0" 
                                                   value="${item.Disponible || 0}"
                                                   placeholder="Nouvelle quantité">
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="inventaire-progress" style="display: none; margin-top: 1.5rem;">
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 id="progressBar">
                                0%
                            </div>
                        </div>
                        <div id="progress-text" style="text-align: center; font-size: 0.875rem; color: var(--gray-600);"></div>
                    </div>
                    
                    <div id="inventaire-message" class="alert-message" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="validerMiseAJourInventaire()" id="btnValiderInventaire">
                        <i class="fas fa-check"></i> Valider la mise à jour
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    modalContainer.innerHTML = inventaireHTML;
    
    initializeSearch();
}

function initializeSearch() {
    const searchInput = document.getElementById('searchReference');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            filterProducts(e.target.value.toLowerCase());
        });
        
        setTimeout(() => {
            searchInput.focus();
        }, 100);
    }
}

function filterProducts(searchTerm) {
    const rows = document.querySelectorAll('#inventaireData .product-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const reference = row.getAttribute('data-reference') || '';
        const referenceCell = row.querySelector('.reference-cell');
        
        if (searchTerm === '' || reference.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
            
            if (searchTerm !== '' && referenceCell) {
                const originalText = referenceCell.textContent || '';
                try {
                    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    const highlightedText = originalText.replace(regex, '<mark style="background-color: #f59e0b; color: white; padding: 2px 4px; border-radius: 3px;">$1</mark>');
                    referenceCell.innerHTML = highlightedText;
                } catch (e) {
                    referenceCell.textContent = originalText;
                }
            }
        } else {
            row.style.display = 'none';
        }
    });
}

async function validerMiseAJourInventaire() {
    const quantiteInputs = document.querySelectorAll('.nouvelle-quantite');
    const modifications = [];
    
    const username = "Admin"; // Vous pouvez adapter cette valeur
    
    quantiteInputs.forEach(input => {
        if (input.closest('tr').style.display !== 'none') {
            const row = input.closest('tr');
            const nouvelleQuantite = parseInt(input.value) || 0;
            
            modifications.push({
                reference: input.dataset.reference || '',
                categorie: row.cells[0].textContent || '',
                agence: row.cells[2].textContent || '',
                prix: row.cells[3].textContent || '',
                nouvelleQuantite: nouvelleQuantite
            });
        }
    });
    
    if (modifications.length === 0) {
        showInventaireMessage('Aucun produit à mettre à jour.', 'error');
        return;
    }
    
    const confirmation = confirm(
        `Êtes-vous sûr de vouloir mettre à jour ${modifications.length} produit(s) ?\n\n` +
        `Cette action remplacera TOUTES les données existantes dans la feuille AjoutStock.`
    );
    
    if (!confirmation) return;
    
    const btnValider = document.getElementById('btnValiderInventaire');
    const progressContainer = document.getElementById('inventaire-progress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progress-text');
    const messageDiv = document.getElementById('inventaire-message');
    
    btnValider.disabled = true;
    btnValider.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi en cours...';
    progressContainer.style.display = 'block';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=inventaire";

        const inventaireData = {
            action: 'inventaire',
            utilisateur: username,
            modifications: modifications,
            timestamp: new Date().toISOString()
        };

        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress <= 100) {
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                progressText.textContent = `Mise à jour en cours... ${progress}%`;
            }
        }, 100);

        const response = await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(inventaireData)
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        progressText.textContent = 'Mise à jour terminée !';

        showInventaireMessage(
            `✅ Mise à jour réussie ! ${modifications.length} produit(s) envoyé(s).`,
            'success'
        );
        
        setTimeout(() => {
            closeModal();
            refreshStockData(); // Recharger les données après mise à jour
            refreshStats(); // Actualiser les statistiques
        }, 2000);

    } catch (error) {
        console.error("Erreur:", error);
        showInventaireMessage(
            `❌ Erreur de connexion au serveur`,
            'error'
        );
        
        btnValider.disabled = false;
        btnValider.innerHTML = '<i class="fas fa-check"></i> Valider la mise à jour';
    }
}

function showInventaireMessage(message, type) {
    const messageDiv = document.getElementById('inventaire-message');
    if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.className = `alert-message ${type}`;
        messageDiv.style.display = 'block';
    }
}

function closeModal() {
    const modal = document.querySelector('.modal-overlay.active');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

function goBack() {
    window.history.back();
}

// Fermer la modal en cliquant en dehors
window.addEventListener('click', function(event) {
    const modal = document.querySelector('.modal-overlay.active');
    if (modal && event.target === modal) {
        closeModal();
    }
});

// Entrer pour vérifier le code
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const codeModal = document.getElementById('codeVerificationModal');
        if (codeModal) {
            verifierCodeAcces();
        }
    }
});
</script>
</body>
</html>
