<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Produits - VisioPro</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary-color: #ec4899;
            --accent-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --dark-color: #1f2937;
            --darker-color: #111827;
            --light-color: #f9fafb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --sidebar-bg: var(--darker-color);
            --sidebar-text: var(--gray-200);
            --sidebar-hover: var(--gray-800);
            --sidebar-active: var(--primary-color);
            
            --card-bg: #ffffff;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --card-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            
            --transition: all 0.2s ease-in-out;
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-mode {
            --card-bg: var(--gray-800);
            --light-color: var(--gray-900);
            --dark-color: var(--gray-100);
            --sidebar-bg: var(--gray-900);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: url("fond.png") no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        /* Layout principal */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Header amélioré */
        .header {
            background-color: var(--card-bg);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition-slow);
            border-bottom: 1px solid var(--gray-200);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
            position: relative;
            padding-left: 1rem;
        }

        .page-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--dark-color);
            background-color: var(--gray-100);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .profile-dropdown:hover {
            background-color: var(--gray-100);
        }

        .profile-name {
            font-weight: 500;
        }

        .profile-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            min-width: 200px;
            box-shadow: var(--card-shadow-lg);
            border-radius: var(--border-radius-lg);
            z-index: 110;
            padding: 0.5rem 0;
            overflow: hidden;
            margin-top: 0.5rem;
            animation: dropdownFade 0.2s ease-out;
            border: 1px solid var(--gray-200);
        }

        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-menu a {
            color: var(--dark-color);
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .dropdown-menu a:hover, .dropdown-menu a:focus {
            background-color: var(--gray-100);
            color: var(--primary-color);
        }

        .dropdown-menu a i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .profile-dropdown:hover .dropdown-menu,
        .profile-dropdown:focus-within .dropdown-menu {
            display: block;
        }

        /* Contenu principal */
        .dashboard-section {
            padding: 1.5rem;
            flex: 1;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h1 {
            font-size: 1.75rem;
            color: var(--dark-color);
            font-weight: 700;
            position: relative;
            padding-bottom: 0.5rem;
        }

        .dashboard-header h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .dashboard-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Cartes de statistiques améliorées */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow-hover);
        }

        .stat-card.primary {
            border-left-color: var(--primary-color);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.info {
            border-left-color: var(--info-color);
        }

        .stat-card.secondary {
            border-left-color: var(--secondary-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-icon {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-weight: 500;
            color: var(--gray-500);
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Boutons améliorés */
        .btn {
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            font-size: 0.9rem;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-primary:hover, .btn-primary:focus {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--primary-color);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover, .btn-secondary:focus {
            background-color: var(--gray-50);
            box-shadow: var(--card-shadow-hover);
            border-color: var(--primary-color);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #34d399);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f59e0b);
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* Conteneur principal amélioré */
        .produit-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition-slow);
            border: 1px solid var(--gray-200);
        }

        /* Barre de recherche et filtres améliorés */
        .search-filters {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--dark-color);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background-color: var(--card-bg);
            color: var(--dark-color);
            cursor: pointer;
            transition: var(--transition);
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .filter-input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background-color: var(--card-bg);
            color: var(--dark-color);
            transition: var(--transition);
            min-width: 120px;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Tableau des produits amélioré */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
        }

        .produit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .produit-table th {
            background-color: var(--gray-50);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .produit-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .produit-table tbody tr {
            transition: var(--transition);
        }

        .produit-table tbody tr:hover {
            background-color: var(--gray-50);
        }

        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .status-high {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-medium {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-low {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Pagination améliorée */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--gray-500);
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background-color: var(--card-bg);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            color: var(--dark-color);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--gray-100);
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Messages et alertes améliorées */
        .alert-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            box-shadow: var(--card-shadow-lg);
            z-index: 1050;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-message.success {
            background: linear-gradient(135deg, var(--success-color), #22c55e);
        }

        .alert-message.error {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .alert-message.info {
            background: linear-gradient(135deg, var(--info-color), #06b6d4);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Spinner de chargement amélioré */
        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: -0.125em;
            border: 0.15em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        /* Modal amélioré */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow-lg);
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
            border: 1px solid var(--gray-200);
        }

        .large-modal {
            max-width: 1400px;
        }

        .xlarge-modal {
            max-width: 1600px;
        }

        .medium-modal {
            max-width: 600px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-icon {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        /* Filtres améliorés pour la modale */
        .filters-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .form-select, .form-control {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--dark-color);
        }

        .form-select:focus, .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-outline-secondary {
            background-color: transparent;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
        }

        .btn-outline-secondary:hover {
            background-color: var(--gray-100);
            border-color: var(--gray-400);
        }

        /* Styles pour la boîte de dialogue de code */
        .code-input-container {
            padding: 1rem;
            text-align: center;
        }

        .code-input-container label {
            display: block;
            margin-bottom: 1rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        #codeInput {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 0.5rem;
            text-align: center;
            height: 60px;
            border: 2px solid var(--info-color);
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }

        #codeInput:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }

        /* Styles pour l'inventaire */
        .search-container {
            margin-bottom: 1.5rem;
        }

        .product-row {
            transition: var(--transition);
        }

        .product-row:hover {
            background-color: var(--gray-50);
        }

        .reference-cell {
            font-weight: 500;
            color: var(--primary-color);
        }

        .nouvelle-quantite {
            border: 2px solid var(--success-color);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            font-weight: 600;
            color: var(--success-color);
            background-color: rgba(16, 185, 129, 0.05);
            transition: var(--transition);
        }

        .nouvelle-quantite:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
        }

        /* Barre de progression */
        .progress {
            height: 1.5rem;
            border-radius: 10px;
            background-color: var(--gray-200);
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--success-color), #34d399);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            transition: width 0.4s ease;
        }

        .progress-bar-striped {
            background-image: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 1rem 1rem;
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        @keyframes progress-bar-stripes {
            0% {
                background-position: 1rem 0;
            }
            100% {
                background-position: 0 0;
            }
        }

        /* Action flottante améliorée */
        .floating-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 100;
        }

        .floating-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .floating-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition-slow);
        }

        .floating-action-btn:hover::before {
            left: 100%;
        }

        .floating-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .floating-action-btn.back {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }

        /* Accessibilité */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        button:focus, select:focus, input:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Responsive amélioré */
        @media (max-width: 1024px) {
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .stats-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .modal-content {
                width: 98%;
                margin: 1%;
            }
        }

        @media (max-width: 768px) {
            .dashboard-section {
                padding: 1rem;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dashboard-buttons {
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .header {
                padding: 1rem;
            }
            
            .profile-name {
                display: none;
            }

            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .filters-panel {
                grid-template-columns: 1fr;
            }
            
            .produit-table th:nth-child(1),
            .produit-table td:nth-child(1) {
                display: none;
            }

            .produit-table th:nth-child(5),
            .produit-table td:nth-child(5),
            .produit-table th:nth-child(6),
            .produit-table td:nth-child(6) {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .produit-table th:nth-child(4),
            .produit-table td:nth-child(4) {
                display: none;
            }
            
            .pagination {
                flex-direction: column;
                gap: 1rem;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .modal-body {
                padding: 1rem;
            }
        }

        /* Animations supplémentaires */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Effet de brillance sur les cartes */
        .shine {
            position: relative;
            overflow: hidden;
        }

        .shine::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            transition: all 0.6s;
            opacity: 0;
        }

        .shine:hover::after {
            opacity: 1;
            top: -30%;
            left: -30%;
        }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="main">
        <header class="header">
            <div class="header-left">
                <h1 class="page-title">Gestion des Produits</h1>
            </div>

            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Basculer le mode sombre">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-info">
                    <div class="profile-dropdown" tabindex="0" aria-haspopup="true" aria-expanded="false">
                        <span class="profile-name" id="username-display"></span>
                        <img src="https://ui-avatars.com/api/?name=John+Doe&background=6366f1&color=fff" alt="Photo de profil" class="profile-img">
                        <div class="dropdown-menu" role="menu">
                            <a href="#" role="menuitem"><i class="fas fa-user" aria-hidden="true"></i> Mon profil</a>
                            <a href="#" role="menuitem"><i class="fas fa-cog" aria-hidden="true"></i> Paramètres</a>
                            <a href="#" id="logout-btn" role="menuitem"><i class="fas fa-sign-out-alt" aria-hidden="true"></i> Déconnexion</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="dashboard-section">
            <div class="dashboard-header">
                <h1>Catalogue des Produits</h1>
                <div class="dashboard-buttons">
                    <button class="btn btn-primary" onclick="openCodeVerificationDialog()">
                        <i class="fas fa-boxes"></i> Inventaire du stock
                    </button>
                    <button class="btn btn-secondary" onclick="refreshProduits()">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                </div>
            </div>

            <!-- Cartes de statistiques améliorées -->
            <div class="stats-cards" id="statsCards">
                <!-- Vue globale du stock par catégorie -->
                <div class="stat-card primary shine" onclick="openVueStockCategorie()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-layer-group stat-icon"></i>
                        <span id="totalCategories">0</span>
                    </div>
                    <div class="stat-label">Stock par Catégorie</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
                
                <!-- Vue globale du stock par agence -->
                <div class="stat-card success shine" onclick="openVueStockAgence()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-store stat-icon"></i>
                        <span id="totalAgences">0</span>
                    </div>
                    <div class="stat-label">Stock par Agence</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
                
                <!-- Vue de disponibilité par catégorie -->
                <div class="stat-card warning shine" onclick="openVueDisponibiliteCategorie()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-chart-pie stat-icon"></i>
                        <span id="disponibiliteCategories">0</span>
                    </div>
                    <div class="stat-label">Disponibilité par Catégorie</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
                
                <!-- Vue de disponibilité par agence -->
                <div class="stat-card info shine" onclick="openVueDisponibiliteAgence()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-chart-bar stat-icon"></i>
                        <span id="disponibiliteAgences">0</span>
                    </div>
                    <div class="stat-label">Disponibilité par Agence</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
                
                <!-- Vue spéciale pour les étuis -->
                <div class="stat-card secondary shine" onclick="openVueEtuisDetail()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-mobile-alt stat-icon"></i>
                        <span id="totalEtuis">0</span>
                    </div>
                    <div class="stat-label">Étuis par Référence</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
            </div>

            <div class="produit-container">
                <div class="search-filters">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchProduitInput" placeholder="Rechercher un produit...">
                    </div>
                    <select class="filter-select" id="categorieFilter">
                        <option value="">Toutes les catégories</option>
                    </select>
                    <select class="filter-select" id="agenceFilter">
                        <option value="">Toutes les agences</option>
                    </select>
                    <input type="number" class="filter-input" id="quantiteMinFilter" placeholder="Qté min..." min="0">
                    <select class="filter-select" id="rowsPerPage">
                        <option value="10">10 lignes</option>
                        <option value="25">25 lignes</option>
                        <option value="50">50 lignes</option>
                        <option value="100">100 lignes</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="produit-table" id="produitTable">
                        <thead>
                            <tr>
                                <th>Date d'ajout</th>
                                <th>Catégorie</th>
                                <th>Référence</th>
                                <th>Quantité Ajoutée</th>
                                <th>Agence</th>
                                <th>Prix</th>
                                <th>Disponible</th>
                                <th>Ajouté par</th>
                                <th>IDs Client</th>
                            </tr>
                        </thead>
                        <tbody id="produitTableBody">
                            <!-- Les données des produits seront chargées ici -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    <div class="pagination-info" id="paginationInfo">
                        Affichage de 0 à 0 sur 0 produits
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        <!-- Les contrôles de pagination seront ajoutés ici -->
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Action flottante améliorée -->
<div class="floating-actions">
    <button class="floating-action-btn back" title="Retour" onclick="openVueGlobale()">
        <i class="fas fa-arrow-left"></i>
    </button>
</div>

<!-- Conteneur pour les modales -->
<div id="modal-container"></div>

<script>
// ==================== VARIABLES GLOBALES ====================
let allProduitData = [];
let filteredProduitData = [];
let currentPage = 1;
let produitsPerPage = 10;
let uniqueCategorie = [];
let uniqueAgence = [];

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', () => {
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");

    if (!username) {
        redirectToLogin();
        return;
    }

    // Affiche le nom d'utilisateur
    const usernameDisplay = document.getElementById("username-display");
    if (usernameDisplay) {
        usernameDisplay.textContent = username;
    }

    // Met à jour l'image de profil avec les initiales
    const profileImg = document.querySelector('.profile-img');
    if (profileImg) {
        profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6366f1&color=fff`;
    }

    // Gestion du bouton de déconnexion
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    // Initialiser le thème
    initTheme();
    
    // Activer le timer d'inactivité
    startInactivityTimer();
    
    // Charger les données des produits
    loadProduitData();
    
    // Initialiser les filtres
    setupSearchAndFilters();
});

// ==================== GESTION DU THÈME ====================
function initTheme() {
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    
    // Appliquer le thème sauvegardé
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    // Gestion du bouton de basculement de thème
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            localStorage.setItem('theme', 'light');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
    });
}

// ==================== FONCTIONS D'AUTHENTIFICATION ====================
function logout() {
    sessionStorage.removeItem("utilisateur");
    localStorage.removeItem("utilisateur");
    redirectToLogin();
}

function redirectToLogin() {
    window.location.href = "code.html";
}

function startInactivityTimer() {
    const INACTIVITY_LIMIT = 15 * 60 * 1000; // 15 minutes en ms
    let inactivityTimeout;

    function resetTimer() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(logout, INACTIVITY_LIMIT);
    }

    // Événements qui réinitialisent le timer
    ["load", "mousemove", "keydown", "click", "scroll"].forEach(event => {
        window.addEventListener(event, resetTimer, true);
    });

    resetTimer();
}

// ==================== GESTION DES DONNÉES PRODUITS ====================

// Fonction pour charger les données des produits
async function loadProduitData() {
    try {
        showLoadingState();
        
        const apiUrl = 'https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=importproduits';
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result?.data?.rows) {
            throw new Error("Structure de données invalide");
        }
        
        allProduitData = processProduitData(result.data);
        filteredProduitData = [...allProduitData];
        
        // Mettre à jour les statistiques
        updateStats();
        
        // Mettre à jour les filtres
        updateFilters();
        
        // Afficher les produits
        displayProduits();
        
    } catch (error) {
        console.error("Erreur lors du chargement des produits:", error);
        showTemporaryMessage("Erreur lors du chargement des produits: " + error.message, "error", 5000);
        showErrorState();
    }
}

// Fonction pour traiter les données des produits
function processProduitData(data) {
    if (!data || !data.rows || !data.headers) {
        return [];
    }
    
    const headers = data.headers;
    const rows = data.rows;
    
    // Transformer les lignes en objets produits
    return rows.map(row => {
        return {
            Date: row[headers.indexOf("Date d'ajout")] || '',
            Categorie: row[headers.indexOf('Catégorie')] || '',
            Reference: row[headers.indexOf('Référence')] || '',
            Quantite: row[headers.indexOf('Quantité')] || 0,
            Agence: row[headers.indexOf('Agence')] || '',
            Price: row[headers.indexOf('Prix de vente')] || '',
            Disponible: row[headers.indexOf('Disponible')] || '',
            User: row[headers.indexOf('User')] || '',
            ID: row[headers.indexOf('ID')] || ''
        };
    });
}

// ==================== FONCTIONS POUR LES NOUVELLES VUES ====================

// Fonction pour ouvrir la vue du stock par catégorie
function openVueStockCategorie() {
    const categories = groupByCategorie(allProduitData);
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-layer-group modal-icon"></i> Stock par Catégorie
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-container">
                        <table class="produit-table">
                            <thead>
                                <tr>
                                    <th>Catégorie</th>
                                    <th>Nombre de Produits</th>
                                    <th>Stock Total</th>
                                    <th>Valeur du Stock</th>
                                    <th>Stock Faible</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(categories).map(([categorie, data]) => `
                                    <tr>
                                        <td><strong>${categorie}</strong></td>
                                        <td>${data.nombreProduits}</td>
                                        <td>${data.stockTotal}</td>
                                        <td>${data.valeurStock.toLocaleString('fr-FR')} FCFA</td>
                                        <td><span class="status-badge ${data.stockFaible > 0 ? 'status-low' : 'status-high'}">${data.stockFaible}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modal-container').innerHTML = modalHTML;
}

// Fonction pour ouvrir la vue du stock par agence
function openVueStockAgence() {
    const agences = groupByAgence(allProduitData);
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-store modal-icon"></i> Stock par Agence
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-container">
                        <table class="produit-table">
                            <thead>
                                <tr>
                                    <th>Agence</th>
                                    <th>Nombre de Produits</th>
                                    <th>Stock Total</th>
                                    <th>Valeur du Stock</th>
                                    <th>Catégories</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(agences).map(([agence, data]) => `
                                    <tr>
                                        <td><strong>${agence}</strong></td>
                                        <td>${data.nombreProduits}</td>
                                        <td>${data.stockTotal}</td>
                                        <td>${data.valeurStock.toLocaleString('fr-FR')} FCFA</td>
                                        <td>${Object.keys(data.categories).join(', ')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modal-container').innerHTML = modalHTML;
}

// Fonction pour ouvrir la vue de disponibilité par catégorie
function openVueDisponibiliteCategorie() {
    const categories = groupByCategorie(allProduitData);
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-chart-pie modal-icon"></i> Disponibilité par Catégorie
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="stats-cards" style="margin-bottom: 2rem;">
                        ${Object.entries(categories).map(([categorie, data]) => `
                            <div class="stat-card ${getStatusClass(data.tauxDisponibilite)}">
                                <div class="stat-value">${data.tauxDisponibilite}%</div>
                                <div class="stat-label">${categorie}</div>
                                <div class="stat-change">
                                    ${data.stockDisponible} / ${data.stockTotal} unités
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="table-container">
                        <table class="produit-table">
                            <thead>
                                <tr>
                                    <th>Catégorie</th>
                                    <th>Stock Disponible</th>
                                    <th>Stock Total</th>
                                    <th>Taux de Disponibilité</th>
                                    <th>Niveau</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(categories).map(([categorie, data]) => `
                                    <tr>
                                        <td><strong>${categorie}</strong></td>
                                        <td>${data.stockDisponible}</td>
                                        <td>${data.stockTotal}</td>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar" style="width: ${data.tauxDisponibilite}%">
                                                    ${data.tauxDisponibilite}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge ${getStatusClass(data.tauxDisponibilite)}">
                                                ${getStatusText(data.tauxDisponibilite)}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modal-container').innerHTML = modalHTML;
}

// Fonction pour ouvrir la vue de disponibilité par agence
function openVueDisponibiliteAgence() {
    const agences = groupByAgence(allProduitData);
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-chart-bar modal-icon"></i> Disponibilité par Agence
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-container">
                        <table class="produit-table">
                            <thead>
                                <tr>
                                    <th>Agence</th>
                                    <th>Stock Disponible</th>
                                    <th>Stock Total</th>
                                    <th>Taux de Disponibilité</th>
                                    <th>Catégorie la mieux stockée</th>
                                    <th>Niveau</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(agences).map(([agence, data]) => {
                                    const meilleureCategorie = Object.entries(data.categories)
                                        .sort((a, b) => b[1].tauxDisponibilite - a[1].tauxDisponibilite)[0];
                                    
                                    return `
                                        <tr>
                                            <td><strong>${agence}</strong></td>
                                            <td>${data.stockDisponible}</td>
                                            <td>${data.stockTotal}</td>
                                            <td>
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: ${data.tauxDisponibilite}%">
                                                        ${data.tauxDisponibilite}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${meilleureCategorie ? `${meilleureCategorie[0]} (${meilleureCategorie[1].tauxDisponibilite}%)` : '-'}</td>
                                            <td>
                                                <span class="status-badge ${getStatusClass(data.tauxDisponibilite)}">
                                                    ${getStatusText(data.tauxDisponibilite)}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modal-container').innerHTML = modalHTML;
}

// Fonction pour ouvrir la vue détaillée des étuis
function openVueEtuisDetail() {
    const etuis = allProduitData.filter(p => p.Categorie && p.Categorie.toLowerCase().includes('etui'));
    const etuisParReference = groupEtuisParReference(etuis);
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content xlarge-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-mobile-alt modal-icon"></i> Étuis par Référence
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="search-filters">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="searchEtuiInput" placeholder="Rechercher une référence d'étui...">
                        </div>
                        <select class="filter-select" id="agenceEtuiFilter">
                            <option value="">Toutes les agences</option>
                            ${[...new Set(etuis.map(e => e.Agence))].filter(Boolean).map(agence => 
                                `<option value="${agence}">${agence}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="table-container">
                        <table class="produit-table">
                            <thead>
                                <tr>
                                    <th>Référence</th>
                                    <th>Agence</th>
                                    <th>Stock Disponible</th>
                                    <th>Prix</th>
                                    <th>Valeur Stock</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="etuisTableBody">
                                ${Object.entries(etuisParReference).map(([reference, data]) => `
                                    <tr>
                                        <td><strong>${reference}</strong></td>
                                        <td>${data.agence}</td>
                                        <td>${data.stockDisponible}</td>
                                        <td>${data.prix}</td>
                                        <td>${data.valeurStock.toLocaleString('fr-FR')} FCFA</td>
                                        <td>
                                            <span class="status-badge ${getStockStatusClass(data.stockDisponible)}">
                                                ${getStockStatusText(data.stockDisponible)}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="stats-cards" style="margin-top: 2rem;">
                        <div class="stat-card primary">
                            <div class="stat-value">${Object.keys(etuisParReference).length}</div>
                            <div class="stat-label">Références d'Étuis</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-value">${etuis.reduce((sum, etui) => sum + (parseInt(etui.Disponible) || 0), 0)}</div>
                            <div class="stat-label">Étuis en Stock</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-value">${etuis.filter(e => (parseInt(e.Disponible) || 0) < 5).length}</div>
                            <div class="stat-label">Références en Stock Faible</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modal-container').innerHTML = modalHTML;
    
    // Initialiser la recherche pour les étuis
    setTimeout(() => {
        const searchInput = document.getElementById('searchEtuiInput');
        const agenceFilter = document.getElementById('agenceEtuiFilter');
        
        if (searchInput) {
            searchInput.addEventListener('input', filterEtuis);
        }
        if (agenceFilter) {
            agenceFilter.addEventListener('change', filterEtuis);
        }
    }, 100);
}

// ==================== FONCTIONS UTILITAIRES POUR LES VUES ====================

// Grouper les produits par catégorie
function groupByCategorie(produits) {
    const categories = {};
    
    produits.forEach(produit => {
        const categorie = produit.Categorie || 'Non catégorisé';
        const disponible = parseInt(produit.Disponible) || 0;
        const prix = parseFloat(produit.Price) || 0;
        
        if (!categories[categorie]) {
            categories[categorie] = {
                nombreProduits: 0,
                stockTotal: 0,
                stockDisponible: 0,
                stockFaible: 0,
                valeurStock: 0
            };
        }
        
        categories[categorie].nombreProduits++;
        categories[categorie].stockTotal += disponible;
        categories[categorie].stockDisponible += disponible;
        categories[categorie].valeurStock += disponible * prix;
        
        if (disponible < 10) {
            categories[categorie].stockFaible++;
        }
    });
    
    // Calculer les taux de disponibilité
    Object.keys(categories).forEach(categorie => {
        const data = categories[categorie];
        data.tauxDisponibilite = data.stockTotal > 0 ? 
            Math.round((data.stockDisponible / data.stockTotal) * 100) : 0;
    });
    
    return categories;
}

// Grouper les produits par agence
function groupByAgence(produits) {
    const agences = {};
    
    produits.forEach(produit => {
        const agence = produit.Agence || 'Non assigné';
        const categorie = produit.Categorie || 'Non catégorisé';
        const disponible = parseInt(produit.Disponible) || 0;
        const prix = parseFloat(produit.Price) || 0;
        
        if (!agences[agence]) {
            agences[agence] = {
                nombreProduits: 0,
                stockTotal: 0,
                stockDisponible: 0,
                valeurStock: 0,
                categories: {}
            };
        }
        
        if (!agences[agence].categories[categorie]) {
            agences[agence].categories[categorie] = {
                stockTotal: 0,
                stockDisponible: 0,
                valeurStock: 0
            };
        }
        
        agences[agence].nombreProduits++;
        agences[agence].stockTotal += disponible;
        agences[agence].stockDisponible += disponible;
        agences[agence].valeurStock += disponible * prix;
        
        agences[agence].categories[categorie].stockTotal += disponible;
        agences[agence].categories[categorie].stockDisponible += disponible;
        agences[agence].categories[categorie].valeurStock += disponible * prix;
    });
    
    // Calculer les taux de disponibilité
    Object.keys(agences).forEach(agence => {
        const data = agences[agence];
        data.tauxDisponibilite = data.stockTotal > 0 ? 
            Math.round((data.stockDisponible / data.stockTotal) * 100) : 0;
        
        // Calculer les taux par catégorie
        Object.keys(data.categories).forEach(categorie => {
            const catData = data.categories[categorie];
            catData.tauxDisponibilite = catData.stockTotal > 0 ? 
                Math.round((catData.stockDisponible / catData.stockTotal) * 100) : 0;
        });
    });
    
    return agences;
}

// Grouper les étuis par référence
function groupEtuisParReference(etuis) {
    const references = {};
    
    etuis.forEach(etui => {
        const reference = etui.Reference || 'Sans référence';
        const disponible = parseInt(etui.Disponible) || 0;
        const prix = parseFloat(etui.Price) || 0;
        
        references[reference] = {
            agence: etui.Agence || 'Non assigné',
            stockDisponible: disponible,
            prix: etui.Price || '0',
            valeurStock: disponible * prix
        };
    });
    
    return references;
}

// Fonction pour filtrer les étuis
function filterEtuis() {
    const searchTerm = document.getElementById('searchEtuiInput').value.toLowerCase();
    const agenceFilter = document.getElementById('agenceEtuiFilter').value;
    const etuis = allProduitData.filter(p => p.Categorie && p.Categorie.toLowerCase().includes('etui'));
    const etuisParReference = groupEtuisParReference(etuis);
    
    const tbody = document.getElementById('etuisTableBody');
    if (!tbody) return;
    
    const filteredEtuis = Object.entries(etuisParReference).filter(([reference, data]) => {
        const matchesSearch = !searchTerm || reference.toLowerCase().includes(searchTerm);
        const matchesAgence = !agenceFilter || data.agence === agenceFilter;
        
        return matchesSearch && matchesAgence;
    });
    
    tbody.innerHTML = filteredEtuis.map(([reference, data]) => `
        <tr>
            <td><strong>${reference}</strong></td>
            <td>${data.agence}</td>
            <td>${data.stockDisponible}</td>
            <td>${data.prix}</td>
            <td>${data.valeurStock.toLocaleString('fr-FR')} FCFA</td>
            <td>
                <span class="status-badge ${getStockStatusClass(data.stockDisponible)}">
                    ${getStockStatusText(data.stockDisponible)}
                </span>
            </td>
        </tr>
    `).join('');
}

// Fonction pour déterminer la classe de statut selon le taux de disponibilité
function getStatusClass(taux) {
    if (taux >= 80) return 'status-high';
    if (taux >= 50) return 'status-medium';
    return 'status-low';
}

// Fonction pour déterminer le texte de statut selon le taux de disponibilité
function getStatusText(taux) {
    if (taux >= 80) return 'Excellent';
    if (taux >= 50) return 'Moyen';
    return 'Faible';
}

// Fonction pour déterminer la classe de statut selon le stock disponible
function getStockStatusClass(stock) {
    if (stock >= 20) return 'status-high';
    if (stock >= 5) return 'status-medium';
    return 'status-low';
}

// Fonction pour déterminer le texte de statut selon le stock disponible
function getStockStatusText(stock) {
    if (stock >= 20) return 'Bon stock';
    if (stock >= 5) return 'Stock moyen';
    return 'Stock faible';
}

// ==================== MISE À JOUR DES STATISTIQUES ====================

function updateStats() {
    const categories = groupByCategorie(allProduitData);
    const agences = groupByAgence(allProduitData);
    const etuis = allProduitData.filter(p => p.Categorie && p.Categorie.toLowerCase().includes('etui'));
    
    // Mettre à jour les compteurs des cartes
    document.getElementById('totalCategories').textContent = Object.keys(categories).length;
    document.getElementById('totalAgences').textContent = Object.keys(agences).length;
    document.getElementById('disponibiliteCategories').textContent = Object.keys(categories).length;
    document.getElementById('disponibiliteAgences').textContent = Object.keys(agences).length;
    document.getElementById('totalEtuis').textContent = Object.keys(groupEtuisParReference(etuis)).length;
}

// ==================== FONCTION POUR AFFICHER LES PRODUITS ====================
function displayProduits() {
    const tableBody = document.getElementById('produitTableBody');
    const paginationInfo = document.getElementById('paginationInfo');
    
    if (!tableBody || !paginationInfo) return;
    
    // Calculer les produits à afficher pour la page actuelle
    const startIndex = (currentPage - 1) * produitsPerPage;
    const endIndex = Math.min(startIndex + produitsPerPage, filteredProduitData.length);
    const produitsToShow = filteredProduitData.slice(startIndex, endIndex);
    
    // Vider le tableau
    tableBody.innerHTML = '';
    
    if (produitsToShow.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    Aucun produit trouvé
                </td>
            </tr>
        `;
    } else {
        // Ajouter chaque produit au tableau
        produitsToShow.forEach(produit => {
            const row = document.createElement('tr');
            
            // Déterminer la classe de statut selon la quantité disponible
            let statusClass = 'status-high';
            const disponible = parseInt(produit.Disponible) || 0;
            if (disponible < 5) {
                statusClass = 'status-low';
            } else if (disponible < 15) {
                statusClass = 'status-medium';
            }
            
            // Formater la date
            const formattedDate = produit.Date ? 
                new Date(produit.Date).toLocaleDateString('fr-FR') : '';
            
            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${produit.Categorie}</td>
                <td class="reference-cell">${produit.Reference}</td>
                <td>${produit.Quantite}</td>
                <td>${produit.Agence}</td>
                <td>${produit.Price}</td>
                <td><span class="status-badge ${statusClass}">${produit.Disponible}</span></td>
                <td>${produit.User}</td>
                <td>${produit.ID}</td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Mettre à jour les informations de pagination
    updatePaginationInfo();
    
    // Mettre à jour les contrôles de pagination
    updatePaginationControls();
}

// Fonction pour mettre à jour les informations de pagination
function updatePaginationInfo() {
    const paginationInfo = document.getElementById('paginationInfo');
    if (!paginationInfo) return;
    
    const startIndex = (currentPage - 1) * produitsPerPage + 1;
    const endIndex = Math.min(currentPage * produitsPerPage, filteredProduitData.length);
    
    paginationInfo.textContent = `Affichage de ${startIndex} à ${endIndex} sur ${filteredProduitData.length} produits`;
}

// Fonction pour mettre à jour les contrôles de pagination
function updatePaginationControls() {
    const paginationControls = document.getElementById('paginationControls');
    if (!paginationControls) return;
    
    const totalPages = Math.ceil(filteredProduitData.length / produitsPerPage);
    
    let controlsHTML = '';
    
    // Bouton précédent
    controlsHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Pages
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Ajuster si on est proche de la fin
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Première page
    if (startPage > 1) {
        controlsHTML += `
            <button class="pagination-btn" onclick="changePage(1)">1</button>
            ${startPage > 2 ? '<span class="pagination-btn" disabled>...</span>' : ''}
        `;
    }
    
    // Pages visibles
    for (let i = startPage; i <= endPage; i++) {
        controlsHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
                ${i}
            </button>
        `;
    }
    
    // Dernière page
    if (endPage < totalPages) {
        controlsHTML += `
            ${endPage < totalPages - 1 ? '<span class="pagination-btn" disabled>...</span>' : ''}
            <button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>
        `;
    }
    
    // Bouton suivant
    controlsHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    paginationControls.innerHTML = controlsHTML;
}

// Fonction pour changer de page
function changePage(page) {
    const totalPages = Math.ceil(filteredProduitData.length / produitsPerPage);
    
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayProduits();
    
    // Faire défiler vers le haut du tableau
    const tableContainer = document.querySelector('.table-container');
    if (tableContainer) {
        tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// ==================== FONCTIONS DE FILTRAGE ET RECHERCHE ====================
function setupSearchAndFilters() {
    const searchInput = document.getElementById('searchProduitInput');
    const categorieFilter = document.getElementById('categorieFilter');
    const agenceFilter = document.getElementById('agenceFilter');
    const quantiteMinFilter = document.getElementById('quantiteMinFilter');
    const rowsPerPage = document.getElementById('rowsPerPage');
    
    if (searchInput) {
        searchInput.addEventListener('input', debounce(applyFilters, 300));
    }
    
    if (categorieFilter) {
        categorieFilter.addEventListener('change', applyFilters);
    }
    
    if (agenceFilter) {
        agenceFilter.addEventListener('change', applyFilters);
    }
    
    if (quantiteMinFilter) {
        quantiteMinFilter.addEventListener('input', debounce(applyFilters, 300));
    }
    
    if (rowsPerPage) {
        rowsPerPage.addEventListener('change', function() {
            produitsPerPage = parseInt(this.value);
            currentPage = 1;
            displayProduits();
        });
    }
}

// Fonction pour appliquer les filtres
function applyFilters() {
    const searchTerm = document.getElementById('searchProduitInput').value.toLowerCase();
    const categorieFilter = document.getElementById('categorieFilter').value;
    const agenceFilter = document.getElementById('agenceFilter').value;
    const quantiteMin = document.getElementById('quantiteMinFilter').value;
    
    filteredProduitData = allProduitData.filter(produit => {
        // Filtre de recherche
        const matchesSearch = !searchTerm || 
            produit.Reference.toLowerCase().includes(searchTerm) ||
            produit.Categorie.toLowerCase().includes(searchTerm);
        
        // Filtre de catégorie
        const matchesCategorie = !categorieFilter || produit.Categorie === categorieFilter;
        
        // Filtre d'agence
        const matchesAgence = !agenceFilter || produit.Agence === agenceFilter;
        
        // Filtre de quantité minimale
        const matchesQuantite = !quantiteMin || 
            (parseInt(produit.Disponible) || 0) >= parseInt(quantiteMin);
        
        return matchesSearch && matchesCategorie && matchesAgence && matchesQuantite;
    });
    
    // Revenir à la première page
    currentPage = 1;
    
    // Afficher les produits filtrés
    displayProduits();
}

// Fonction pour mettre à jour les filtres
function updateFilters() {
    updateCategorieFilter();
    updateAgenceFilter();
}

// Fonction pour mettre à jour le filtre de catégorie
function updateCategorieFilter() {
    const categorieFilter = document.getElementById('categorieFilter');
    if (!categorieFilter) return;
    
    // Récupérer toutes les catégories uniques
    uniqueCategorie = [...new Set(allProduitData.map(produit => produit.Categorie).filter(Boolean))];
    
    // Trier les catégories
    uniqueCategorie.sort();
    
    // Mettre à jour le filtre
    let optionsHTML = '<option value="">Toutes les catégories</option>';
    uniqueCategorie.forEach(categorie => {
        optionsHTML += `<option value="${categorie}">${categorie}</option>`;
    });
    
    categorieFilter.innerHTML = optionsHTML;
}

// Fonction pour mettre à jour le filtre d'agence
function updateAgenceFilter() {
    const agenceFilter = document.getElementById('agenceFilter');
    if (!agenceFilter) return;
    
    // Récupérer toutes les agences uniques
    uniqueAgence = [...new Set(allProduitData.map(produit => produit.Agence).filter(Boolean))];
    
    // Trier les agences
    uniqueAgence.sort();
    
    // Mettre à jour le filtre
    let optionsHTML = '<option value="">Toutes les agences</option>';
    uniqueAgence.forEach(agence => {
        optionsHTML += `<option value="${agence}">${agence}</option>`;
    });
    
    agenceFilter.innerHTML = optionsHTML;
}

// ==================== FONCTIONS UTILITAIRES ====================
// Fonction debounce pour limiter les appels de fonction
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ==================== FONCTIONS D'ACTION ====================
// Fonction pour retourner à la vue globale
function openVueGlobale() {
    try {
        const homePath = 'Accueil.html';
        window.location.href = homePath;
    } catch (error) {
        console.error("Erreur d'ouverture:", error);
        alert("Impossible d'ouvrir la page. Contactez l'administrateur.");
    }
}

// Fonction pour actualiser les données
function refreshProduits() {
    loadProduitData();
    showTemporaryMessage("Liste des produits actualisée", "success", 2000);
}

// ==================== ÉTATS D'AFFICHAGE ====================
// Fonction pour afficher l'état de chargement
function showLoadingState() {
    const tableBody = document.getElementById('produitTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = `
        <tr>
            <td colspan="9" style="text-align: center; padding: 3rem;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                    <div class="spinner-border" style="color: var(--primary-color);"></div>
                    <div style="color: var(--gray-500);">Chargement des produits...</div>
                </div>
            </td>
        </tr>
    `;
}

// Fonction pour afficher l'état d'erreur
function showErrorState() {
    const tableBody = document.getElementById('produitTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = `
        <tr>
            <td colspan="9" style="text-align: center; padding: 3rem;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--danger-color);"></i>
                    <div style="color: var(--danger-color); font-weight: 500;">Erreur de chargement</div>
                    <button class="btn btn-primary" onclick="loadProduitData()">
                        <i class="fas fa-redo"></i> Réessayer
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// ==================== MESSAGES TEMPORAIRES ====================
function showTemporaryMessage(message, type, duration) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert-message ${type}`;
    messageDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(messageDiv);
    
    // Disparaître après la durée spécifiée
    setTimeout(() => {
        messageDiv.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 300);
    }, duration);
}

// Fonction pour fermer la modale
function closeModal() {
    const modal = document.querySelector('.modal-overlay.active');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// Fermer les modals en cliquant à l'extérieur
window.addEventListener('click', function(event) {
    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(modal => {
        if (event.target === modal) {
            closeModal();
        }
    });
});

//========== Inventaire======
// Fonction pour ouvrir la boîte de dialogue de vérification de code
function openCodeVerificationDialog() {
    const modalContainer = document.getElementById('modal-container');
    const codeDialogHTML = `
        <div class="modal-overlay active" id="codeVerificationModal">
            <div class="modal-content medium-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-shield-alt modal-icon"></i> Accès à l'Inventaire
                    </h3>
                    <button class="modal-close" onclick="fermerCodeDialog()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert-message info" style="position: relative; margin-bottom: 1.5rem;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Accès sécurisé requis. Un code de vérification a été envoyé par email.
                    </div>
                    
                    <div class="code-input-container">
                        <label for="codeInput">Code de vérification à 6 chiffres :</label>
                        <input type="text" 
                               class="form-control" 
                               id="codeInput"
                               maxlength="6"
                               placeholder="000000"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,6)">
                        <div class="stat-change">Veuillez saisir le code reçu par email</div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin: 1.5rem 0;">
                        <button type="button" class="btn btn-secondary" onclick="regenererCode()">
                            <i class="fas fa-redo"></i> Régénérer le code
                        </button>
                    </div>
                    
                    <div id="codeMessage" class="alert-message" style="position: relative; display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="verifierCodeAcces()" id="btnVerifierCode">
                        <i class="fas fa-check"></i> Vérifier le code
                    </button>
                </div>
            </div>
        </div>
    `;
    modalContainer.innerHTML = codeDialogHTML;
    
    // Focus automatique sur le champ de code
    setTimeout(() => {
        const codeInput = document.getElementById('codeInput');
        if (codeInput) {
            codeInput.focus();
        }
    }, 100);
    
    // Générer automatiquement un code au chargement
    regenererCode();
}

// Fonction pour fermer la boîte de dialogue de code
function fermerCodeDialog() {
    const modal = document.getElementById('codeVerificationModal');
    if (modal) {
        modal.remove();
    }
}

// Fonction pour régénérer un code
async function regenererCode() {
    try {
        const btnVerifier = document.getElementById('btnVerifierCode');
        const messageDiv = document.getElementById('codeMessage');
        
        // Désactiver le bouton pendant la génération
        btnVerifier.disabled = true;
        btnVerifier.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
        
        if (messageDiv) {
            messageDiv.style.display = 'none';
        }
        
        // Appeler l'API pour générer un nouveau code
        const response = await fetch('https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=accesinventaire', {
            method: 'GET',
            mode: 'no-cors'
        });
        
        // Réactiver le bouton
        btnVerifier.disabled = false;
        btnVerifier.innerHTML = '<i class="fas fa-check"></i> Vérifier le code';
        
        showCodeMessage('✅ Nouveau code généré et envoyé par email !', 'success');
        
        // Effacer le champ de saisie
        const codeInput = document.getElementById('codeInput');
        if (codeInput) {
            codeInput.value = '';
            codeInput.focus();
        }
        
    } catch (error) {
        console.error('Erreur génération code:', error);
        showCodeMessage('❌ Erreur lors de la génération du code', 'error');
        
        const btnVerifier = document.getElementById('btnVerifierCode');
        if (btnVerifier) {
            btnVerifier.disabled = false;
            btnVerifier.innerHTML = '<i class="fas fa-check"></i> Vérifier le code';
        }
    }
}

// Fonction pour vérifier le code saisi
async function verifierCodeAcces() {
    const codeInput = document.getElementById('codeInput');
    const code = codeInput.value.trim();
    
    if (!code || code.length !== 6) {
        showCodeMessage('❌ Veuillez saisir un code à 6 chiffres', 'error');
        codeInput.focus();
        return;
    }
    
    try {
        const btnVerifier = document.getElementById('btnVerifierCode');
        const messageDiv = document.getElementById('codeMessage');
        
        // Désactiver le bouton pendant la vérification
        btnVerifier.disabled = true;
        btnVerifier.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vérification...';
        
        if (messageDiv) {
            messageDiv.style.display = 'none';
        }
        
        // Appeler l'API pour vérifier le code
        const response = await fetch(`https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=codeaccess&code=${code}`, {
            method: 'GET',
            mode: 'no-cors'
        });
        
        // Dans une vraie implémentation, vous devriez vérifier la réponse
        // Pour l'instant, on simule une vérification réussie après un délai
        setTimeout(() => {
            // Réactiver le bouton
            btnVerifier.disabled = false;
            btnVerifier.innerHTML = '<i class="fas fa-check"></i> Vérifier le code';
            
            // Simuler une vérification réussie (à adapter selon votre API)
            if (code.length === 6 && /^\d+$/.test(code)) {
                showCodeMessage('✅ Code vérifié avec succès ! Ouverture de l\'inventaire...', 'success');
                
                // Fermer la boîte de dialogue après un délai
                setTimeout(() => {
                    fermerCodeDialog();
                    // Ouvrir l'inventaire
                    openInventaireUpdate();
                }, 1500);
            } else {
                showCodeMessage('❌ Code incorrect. Veuillez réessayer.', 'error');
                codeInput.focus();
                codeInput.select();
            }
        }, 1000);
        
    } catch (error) {
        console.error('Erreur vérification code:', error);
        showCodeMessage('❌ Erreur lors de la vérification du code', 'error');
        
        const btnVerifier = document.getElementById('btnVerifierCode');
        if (btnVerifier) {
            btnVerifier.disabled = false;
            btnVerifier.innerHTML = '<i class="fas fa-check"></i> Vérifier le code';
        }
    }
}

// Fonction pour afficher les messages dans la boîte de code
function showCodeMessage(message, type) {
    const messageDiv = document.getElementById('codeMessage');
    if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.className = `alert-message ${type}`;
        messageDiv.style.display = 'block';
    }
}

// Permettre la soumission avec la touche Entrée
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const codeModal = document.getElementById('codeVerificationModal');
        if (codeModal) {
            verifierCodeAcces();
        }
    }
});

// NOUVELLE FONCTIONNALITÉ : MISE À JOUR INVENTAIRE
function openInventaireUpdate() {
    const modalContainer = document.getElementById('modal-container');
    const inventaireHTML = `
        <div class="modal-overlay active" id="inventaireModal">
            <div class="modal-content xlarge-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-clipboard-list modal-icon"></i> Mise à jour du Stock d'Inventaire
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert-message info" style="position: relative; margin-bottom: 1.5rem;">
                        <i class="fas fa-info-circle"></i> 
                        Mettez à jour les quantités disponibles pour chaque produit.
                    </div>
                    
                    <!-- Zone de recherche dynamique -->
                    <div class="search-container">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" 
                                   class="search-input" 
                                   id="searchReference"
                                   placeholder="Rechercher une référence..."
                                   autocomplete="off">
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="produit-table" id="inventaireTable">
                            <thead>
                                <tr>
                                    <th>Catégorie</th>
                                    <th>Référence</th>
                                    <th>Agence</th>
                                    <th>Prix</th>
                                    <th>Stock Actuel</th>
                                    <th>Nouveau Stock</th>
                                </tr>
                            </thead>
                            <tbody id="inventaireData">
                                ${allProduitData.map(item => {
                                    // Gérer les cas où Reference pourrait être null, undefined, ou un nombre
                                    const reference = item.Reference || '';
                                    const referenceString = String(reference); // Convertir en string
                                    const referenceLower = referenceString.toLowerCase();
                                    
                                    return `
                                    <tr class="product-row" data-reference="${referenceLower}">
                                        <td>${item.Categorie || ''}</td>
                                        <td class="reference-cell">${referenceString}</td>
                                        <td>${item.Agence || ''}</td>
                                        <td>${item.Price || ''}</td>
                                        <td>${item.Disponible || 0}</td>
                                        <td>
                                            <input type="number" 
                                                   class="nouvelle-quantite" 
                                                   data-id="${item.ID || ''}"
                                                   data-reference="${referenceString}"
                                                   min="0" 
                                                   value="${item.Disponible || 0}"
                                                   placeholder="Nouvelle quantité">
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="inventaire-progress" style="display: none; margin-top: 1.5rem;">
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 id="progressBar">
                                0%
                            </div>
                        </div>
                        <div id="progress-text" class="stat-change text-center"></div>
                    </div>
                    
                    <div id="inventaire-message" class="alert-message" style="position: relative; display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="validerMiseAJourInventaire()" id="btnValiderInventaire">
                        <i class="fas fa-check"></i> Valider la mise à jour
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    modalContainer.innerHTML = inventaireHTML;
    
    // Initialiser la recherche
    initializeSearch();
}

// Fonction pour initialiser la recherche
function initializeSearch() {
    const searchInput = document.getElementById('searchReference');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            filterProducts(e.target.value.toLowerCase());
        });
        
        // Focus automatique sur le champ de recherche
        setTimeout(() => {
            searchInput.focus();
        }, 100);
    }
}

// Fonction pour filtrer les produits par référence
function filterProducts(searchTerm) {
    const rows = document.querySelectorAll('#inventaireData .product-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const reference = row.getAttribute('data-reference') || '';
        const referenceCell = row.querySelector('.reference-cell');
        
        if (searchTerm === '' || reference.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
            
            // Mettre en évidence le texte correspondant
            if (searchTerm !== '' && referenceCell) {
                const originalText = referenceCell.textContent || '';
                try {
                    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    const highlightedText = originalText.replace(regex, '<mark style="background-color: var(--warning-color); color: white; padding: 2px 4px; border-radius: 3px;">$1</mark>');
                    referenceCell.innerHTML = highlightedText;
                } catch (e) {
                    // En cas d'erreur regex, on affiche le texte original
                    referenceCell.textContent = originalText;
                }
            }
        } else {
            row.style.display = 'none';
        }
    });
}

// Fonction pour valider et envoyer la mise à jour de l'inventaire
async function validerMiseAJourInventaire() {
    const quantiteInputs = document.querySelectorAll('.nouvelle-quantite');
    const modifications = [];
    
    // Récupérer le nom d'utilisateur
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur") || 'Utilisateur Inconnu';
    
    // Collecter TOUTES les quantités du nouveau stock (même inchangées)
    quantiteInputs.forEach(input => {
        if (input.closest('tr').style.display !== 'none') {
            const row = input.closest('tr');
            const nouvelleQuantite = parseInt(input.value) || 0;
            
            // Toujours envoyer la donnée, même si la quantité est 0 ou inchangée
            modifications.push({
                reference: input.dataset.reference || '',
                categorie: row.cells[0].textContent || '',
                agence: row.cells[2].textContent || '',
                prix: row.cells[3].textContent || '',
                nouvelleQuantite: nouvelleQuantite
            });
        }
    });
    
    if (modifications.length === 0) {
        showInventaireMessage('Aucun produit à mettre à jour.', 'error');
        return;
    }
    
    // Confirmation
    const confirmation = confirm(
        `Êtes-vous sûr de vouloir mettre à jour ${modifications.length} produit(s) ?\n\n` +
        `Cette action remplacera TOUTES les données existantes dans la feuille AjoutStock.`
    );
    
    if (!confirmation) return;
    
    // Préparer l'interface pour l'envoi
    const btnValider = document.getElementById('btnValiderInventaire');
    const progressContainer = document.getElementById('inventaire-progress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progress-text');
    const messageDiv = document.getElementById('inventaire-message');
    
    btnValider.disabled = true;
    btnValider.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi en cours...';
    progressContainer.style.display = 'block';
    messageDiv.style.display = 'none';

    try {
        // Configuration identique au premier code
        const apiUrl = "https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=inventaire";

        const inventaireData = {
            action: 'inventaire',
            utilisateur: username,
            modifications: modifications,
            timestamp: new Date().toISOString()
        };

        // Simuler l'envoi avec une barre de progression
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress <= 100) {
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                progressText.textContent = `Mise à jour en cours... ${progress}%`;
            }
        }, 100);

        // Envoi avec la même configuration que le premier code
        const response = await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(inventaireData)
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        progressText.textContent = 'Mise à jour terminée !';

        showInventaireMessage(
            `✅ Mise à jour réussie ! ${modifications.length} produit(s) envoyé(s).`,
            'success'
        );
        
        // Fermer la modale après un délai
        setTimeout(() => {
            closeModal();
        }, 2000);

    } catch (error) {
        console.error("Erreur:", error);
        showInventaireMessage(
            `❌ Erreur de connexion au serveur`,
            'error'
        );
        
        // Réactiver le bouton en cas d'erreur
        btnValider.disabled = false;
        btnValider.innerHTML = '<i class="fas fa-check"></i> Valider la mise à jour';
    }
}

// Fonction pour afficher les messages dans la modale d'inventaire
function showInventaireMessage(message, type) {
    const messageDiv = document.getElementById('inventaire-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert-message ${type}`;
    messageDiv.style.display = 'block';
    
    // Faire défiler jusqu'au message
    messageDiv.scrollIntoView({ behavior: 'smooth' });
}

</script>
</body>
</html>