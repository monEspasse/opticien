<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - VisionPro</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --warning-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            
            --primary-50: #f0f4ff;
            --primary-100: #d9e4ff;
            --primary-200: #b3c9ff;
            --primary-300: #8daef8;
            --primary-400: #6793f1;
            --primary-500: #4f46e5;
            --primary-600: #4338ca;
            --primary-700: #3730a3;
            --primary-800: #312e81;
            --primary-900: #1e1b4b;
            
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
            
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
            --border-radius-xl: 32px;
            --border-radius-full: 9999px;
            
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
            font-smooth: always;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: #2d3748;
            position: relative;
        }

        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        /* SKELETON LOADING */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
            border-radius: var(--border-radius-sm);
            min-height: 1em;
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5rem;
            width: 100%;
        }

        .skeleton-text.short {
            width: 60%;
        }

        .skeleton-text.medium {
            width: 80%;
        }

        .skeleton-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .skeleton-rect {
            height: 100px;
            border-radius: var(--border-radius-md);
        }

        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            animation: fadeIn 0.5s ease;
        }

        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem 2rem;
            box-shadow: var(--glass-shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.6s ease 0.1s both;
        }

        .header-left h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 2rem;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary-300);
            transition: transform 0.3s ease;
        }

        .profile-img:hover {
            transform: scale(1.05);
        }

        .admin-sections {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease 0.2s both;
        }

        .admin-nav {
            flex: 0 0 250px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
        }

        .nav-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--primary-700);
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            width: 100%;
            text-align: left;
            margin-bottom: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: left 0.3s ease;
            z-index: 0;
        }

        .nav-btn:hover {
            color: var(--primary-600);
            transform: translateX(5px);
        }

        .nav-btn:hover::before {
            left: 0;
        }

        .nav-btn:hover span,
        .nav-btn:hover i {
            position: relative;
            z-index: 1;
            color: white;
        }

        .nav-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            transform: translateX(5px);
        }

        .nav-btn i {
            width: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .nav-btn:hover i {
            transform: scale(1.1);
        }

        .content-area {
            flex: 1;
        }

        .section-content {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s var(--transition-smooth);
        }

        .section-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .section-header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }

        .section-title {
            margin: 0;
            font-size: 1.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* ==================== CONTROLS STYLES ==================== */
        .controls-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-md);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.3s var(--transition-smooth);
            background: white;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .filters-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-md);
            font-family: inherit;
            font-size: 0.95rem;
            background: white;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .items-per-page {
            min-width: 120px;
        }

        .sort-indicator {
            margin-left: 0.5rem;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: color 0.2s ease;
        }

        .sortable:hover {
            color: var(--primary-500);
        }

        .sortable::after {
            content: '↕';
            margin-left: 0.5rem;
            font-size: 0.8em;
            opacity: 0.5;
        }

        .sortable.asc::after {
            content: '↑';
            opacity: 1;
        }

        .sortable.desc::after {
            content: '↓';
            opacity: 1;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-md);
            background: white;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-50);
            border-color: var(--primary-300);
            color: var(--primary-600);
            transform: translateY(-1px);
        }

        .pagination-btn.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            margin: 0 1rem;
            color: var(--gray-600);
            font-size: 0.95rem;
        }

        /* ==================== END CONTROLS STYLES ==================== */

        .btn {
            position: relative;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(40, 40);
                opacity: 0;
            }
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .table-container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 0;
            overflow: hidden;
            max-height: 500px;
            animation: fadeIn 0.5s ease 0.3s both;
        }

        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .admin-table th {
            text-align: left;
            padding: 1rem;
            background: rgba(79, 70, 229, 0.95);
            color: white;
            font-weight: 600;
            border-bottom: 2px solid var(--primary-300);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s ease;
        }

        .admin-table tbody tr {
            animation: fadeIn 0.3s ease;
            animation-fill-mode: both;
        }

        .admin-table tbody tr:hover {
            background: rgba(79, 70, 229, 0.05);
            transform: translateX(5px);
            transition: transform 0.2s ease;
        }

        /* Styles pour les soldes négatifs */
        .solde-negatif {
            background-color: rgba(239, 68, 68, 0.1) !important;
            position: relative;
            font-weight: 600;
        }

        .solde-negatif::before {
            content: '⚠️';
            margin-right: 0.5rem;
        }

        .en-caisse-negatif {
            color: #ef4444 !important;
            font-weight: 700;
            position: relative;
        }

        .en-caisse-negatif::before {
            content: '⚠️ ';
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius-sm);
            border: none;
            background: var(--glass-bg);
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--transition-smooth);
        }

        .action-btn:hover {
            transform: translateY(-2px) scale(1.1);
        }

        .btn-edit:hover {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-delete:hover {
            background: var(--danger-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* MODALES */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            animation: fadeIn 0.4s ease 0.1s both;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary-700);
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-500);
            cursor: pointer;
            transition: color 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.25rem;
            animation: fadeIn 0.3s ease;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-md);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s var(--transition-smooth);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            transform: translateY(-1px);
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* MESSAGES ET ALERTES */
        .alert-message {
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-md);
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-left: 4px solid #ef4444;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border-left: 4px solid #f59e0b;
        }

        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            gap: 1rem;
        }

        .spinner-border {
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--primary-400);
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
            font-style: italic;
        }

        .back-btn {
            margin-bottom: 1rem;
            animation: fadeIn 0.5s ease;
        }

        /* PROGRESS OVERLAY */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .progress-overlay.active {
            opacity: 1;
        }

        .progress-modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            min-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .progress-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1.5rem;
        }

        .progress-spinner {
            font-size: 3rem;
            color: #3b82f6;
        }

        .progress-spinner .fa-spin {
            animation: spin 1s linear infinite;
        }

        .progress-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .progress-content.success .progress-icon {
            color: #10b981;
        }

        .progress-content.error .progress-icon {
            color: #ef4444;
        }

        .progress-text h4 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
        }

        .progress-text p {
            margin: 0;
            color: #6b7280;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* PASSWORD TOOLTIP */
        .password-tooltip {
            position: fixed;
            background: var(--gray-900);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.2s ease;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .password-tooltip.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* LOGOUT NOTIFICATION */
        .logout-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger-gradient);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-md);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            z-index: 3000;
            display: none;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        /* AUTOCOMPLETE */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        /* SUMMARY CARDS */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.5s ease 0.2s both;
        }

        @media (max-width: 1024px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }

        .summary-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            transition: all 0.3s ease;
            animation: fadeIn 0.4s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        .summary-card:hover .card-icon {
            transform: scale(1.1) rotate(5deg);
        }

        /* OPTIMISTIC UPDATE STATES */
        .optimistic-update {
            opacity: 0.7;
            position: relative;
            animation: pulse 2s infinite;
        }

        .optimistic-update::after {
            content: 'Synchronisation...';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: var(--primary-600);
            z-index: 1;
        }

        /* ERROR STATES */
        .error-state {
            border: 2px dashed #ef4444;
            background: rgba(239, 68, 68, 0.05);
            padding: 2rem;
            border-radius: var(--border-radius-md);
            text-align: center;
            margin: 1rem 0;
        }

        .error-state button {
            margin-top: 1rem;
        }

        /* SUCCESS CONFIRMATION */
        .success-confirmation {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-gradient);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-md);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }
            
            .admin-sections {
                flex-direction: column;
            }
            
            .admin-nav {
                flex: none;
                width: 100%;
            }
            
            .table-container {
                padding: 0;
            }
            
            .admin-table {
                display: block;
                overflow-x: auto;
            }
            
            .action-btns {
                flex-direction: column;
            }
            
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .controls-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box,
            .filter-select {
                min-width: 100%;
            }
        }

        /* UTILITY CLASSES */
        .text-danger {
            color: #ef4444 !important;
        }

        .text-success {
            color: #10b981 !important;
        }

        .text-center {
            text-align: center !important;
        }

        .text-muted {
            color: var(--gray-500) !important;
        }

        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }

        /* FLOATING ACTION BUTTON */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }

        /* TOAST NOTIFICATIONS */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 350px;
        }

        .toast {
            padding: 1rem;
            border-radius: var(--border-radius-md);
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: #10b981;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), white);
        }

        .toast.error {
            border-left-color: #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), white);
        }

        .toast.warning {
            border-left-color: #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), white);
        }

        .toast.info {
            border-left-color: #3b82f6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), white);
        }

        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .toast-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        /* LOADING SKELETON FOR TABLE */
        .table-skeleton {
            width: 100%;
        }

        .table-skeleton-row {
            display: flex;
            padding: 1rem;
            gap: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .table-skeleton-cell {
            flex: 1;
        }

        .table-skeleton-cell.short {
            flex: 0.5;
        }

        .table-skeleton-cell.medium {
            flex: 0.8;
        }

        /* CATEGORIES DROPDOWN */
        .categories-dropdown {
            position: fixed;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 99999;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            width: auto;
            margin-top: 2px;
        }

        .categories-dropdown .category-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            color: #374151;
        }

        .categories-dropdown .category-item:last-child {
            border-bottom: none;
        }

        .categories-dropdown .category-item:hover,
        .categories-dropdown .category-item.active {
            background-color: #f3f4f6;
            color: #4f46e5;
            font-weight: 500;
        }

        .categories-dropdown .no-categories {
            padding: 15px;
            color: #6b7280;
            text-align: center;
            font-style: italic;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="scrollToTop()" id="fab" style="display: none;">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Main Container -->
    <div class="admin-container">
        <header class="header">
            <div class="header-left">
                <h1>VisionPro</h1>
            </div>
            <div class="user-info">
                <span id="username-display"></span>
                <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" alt="Photo de profil" class="profile-img">
            </div>
        </header>

        <div class="back-btn">
            <button class="btn btn-primary" onclick="openVueGlobale()">
                <i class="fas fa-arrow-left"></i> Retour
            </button>
        </div>

        <div class="admin-sections">
            <nav class="admin-nav">
                <h3 class="nav-title">Administration</h3>
                <button class="nav-btn" onclick="showAdminSection('banque')">
                    <i class="fas fa-university"></i>
                    <span>Gestion Banque</span>
                </button>
                <button class="nav-btn active" onclick="showAdminSection('grand-caisse')">
                    <i class="fas fa-vault"></i>
                    <span>Gestion Grande Caisse</span>
                </button>
                <button class="nav-btn" onclick="showAdminSection('users')">
                    <i class="fas fa-users"></i>
                    <span>Gestion des Utilisateurs</span>
                </button>
                <button class="nav-btn" onclick="showAdminSection('fournisseur')">
                    <i class="fas fa-truck"></i>
                    <span>Gestion Fournisseurs</span>
                </button>
                    <button class="nav-btn" onclick="showAdminSection('personnel')">
        <i class="fas fa-users-cog"></i>
        <span>Gestion du Personnel</span>
         </button>
            </nav>

            <div class="content-area">
                <!-- Section 1: Gestion Banque -->
                <div id="section-banque" class="section-content">
                    <div class="section-header">
                        <h2 class="section-title">Gestion Banque</h2>
                    </div>
                    
                    <!-- Contrôles Banque -->
                    <div class="controls-panel" id="banque-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="banque-search" placeholder="Rechercher dans Désignation, Catégorie, Type, Montant..." onkeyup="searchBanque()">
                        </div>
                        <div class="filters-group">
                            <select class="filter-select items-per-page" id="banque-items-per-page" onchange="changeItemsPerPage('banque')">
                                <option value="10">10/page</option>
                                <option value="20">20/page</option>
                                <option value="50">50/page</option>
                                <option value="100">100/page</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Cartes de synthèse Banque -->
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div class="card-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500); font-weight: 500;">Credited</div>
                                    <div id="credited-total" style="font-size: 1.5rem; font-weight: 700; color: #10b981;">0</div>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-400);">Somme des crédits</div>
                        </div>
                        
                        <div class="summary-card">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div class="card-icon" style="background: linear-gradient(135deg, #ef4444, #f87171);">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500); font-weight: 500;">Debited</div>
                                    <div id="debited-total" style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">0</div>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-400);">Somme des débits</div>
                        </div>
                        
                        <div class="summary-card">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div class="card-icon" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500); font-weight: 500;">Solde</div>
                                    <div id="solde-disponible" style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">0</div>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-400);"></div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-wrapper">
                            <div id="banqueTableSkeleton" class="table-skeleton" style="display: none;">
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                </div>
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                </div>
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                </div>
                            </div>
                            <table class="admin-table" id="banqueTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortTable('banque', 'Date')">Date</th>
                                        <th class="sortable" onclick="sortTable('banque', 'Designation')">Désignation</th>
                                        <th class="sortable" onclick="sortTable('banque', 'Montant')">Montant</th>
                                        <th class="sortable" onclick="sortTable('banque', 'Type')">Type</th>
                                        <th class="sortable" onclick="sortTable('banque', 'Solde')">Solde</th>
                                        <th class="sortable" onclick="sortTable('banque', 'Categorie')">Catégorie</th>
                                        <th>ID unique</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="banqueData">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="loading-indicator">
                                                <div class="spinner-border"></div>
                                                <div>Chargement des transactions...</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="banque-pagination" class="pagination-controls" style="display: none;"></div>
                    </div>
                    
                    <div id="banque-message" class="alert-message" style="display: none;"></div>
                </div>

                <!-- Section 2: Gestion Grande Caisse -->
                <div id="section-grand-caisse" class="section-content active">
                    <div class="section-header">
                        <h2 class="section-title">Gestion Grande Caisse</h2>
                        <button class="btn btn-primary" onclick="openAddGrandCaisseModal()">
                            <i class="fas fa-plus"></i> Nouvelle Entrée
                        </button>
                    </div>
                    
                    <!-- Contrôles Grande Caisse -->
                    <div class="controls-panel" id="grand-caisse-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="grand-caisse-search" placeholder="Rechercher dans Désignation, Catégorie, Mode, Mouvement..." onkeyup="searchGrandCaisse()">
                        </div>
                        <div class="filters-group">
                            <select class="filter-select items-per-page" id="grand-caisse-items-per-page" onchange="changeItemsPerPage('grand-caisse')">
                                <option value="10">10/page</option>
                                <option value="20">20/page</option>
                                <option value="50">50/page</option>
                                <option value="100">100/page</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Cartes de synthèse Grande Caisse -->
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div class="card-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                                    <i class="fas fa-sign-in-alt"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500); font-weight: 500;">Total Entrées</div>
                                    <div id="grand-caisse-entrees" style="font-size: 1.5rem; font-weight: 700; color: #10b981;">0</div>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-400);">Somme des entrées</div>
                        </div>
                        
                        <div class="summary-card">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div class="card-icon" style="background: linear-gradient(135deg, #ef4444, #f87171);">
                                    <i class="fas fa-sign-out-alt"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500); font-weight: 500;">Total Sorties</div>
                                    <div id="grand-caisse-sorties" style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">0</div>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-400);">Somme des sorties</div>
                        </div>
                        
                        <div class="summary-card">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <div class="card-icon" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                                    <i class="fas fa-cash-register"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500); font-weight: 500;">En Caisse</div>
                                    <div id="grand-caisse-solde" style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">0</div>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-400);"></div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-wrapper">
                            <div id="grandCaisseTableSkeleton" class="table-skeleton" style="display: none;">
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                </div>
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                </div>
                            </div>
                            <table class="admin-table" id="grandCaisseTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortTable('grand-caisse', 'Date')">Date</th>
                                        <th class="sortable" onclick="sortTable('grand-caisse', 'Designation')">Désignation</th>
                                        <th class="sortable" onclick="sortTable('grand-caisse', 'Montant')">Montant</th>
                                        <th class="sortable" onclick="sortTable('grand-caisse', 'Mouvement')">Mouvement</th>
                                        <th class="sortable" onclick="sortTable('grand-caisse', 'ModePaiement')">Mode</th>
                                        <th class="sortable" onclick="sortTable('grand-caisse', 'Categorie')">Catégorie</th>
                                    </tr>
                                </thead>
                                <tbody id="grandCaisseData">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading-indicator">
                                                <div class="spinner-border"></div>
                                                <div>Chargement des données...</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="grand-caisse-pagination" class="pagination-controls" style="display: none;"></div>
                    </div>
                    
                    <div id="grand-caisse-message" class="alert-message" style="display: none;"></div>
                </div>
                
                <!-- Section 3: Gestion des Utilisateurs -->
                <div id="section-users" class="section-content">
                    <div class="section-header">
                        <h2 class="section-title">Gestion des Utilisateurs</h2>
                        <button class="btn btn-primary" onclick="openAddUserModal()">
                            <i class="fas fa-user-plus"></i> Nouvel Utilisateur
                        </button>
                    </div>
                    
                    <!-- Contrôles Utilisateurs -->
                    <div class="controls-panel" id="users-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="users-search" placeholder="Rechercher dans Nom utilisateur, Date..." onkeyup="searchUsers()">
                        </div>
                        <div class="filters-group">
                            <select class="filter-select items-per-page" id="users-items-per-page" onchange="changeItemsPerPage('users')">
                                <option value="10">10/page</option>
                                <option value="20">20/page</option>
                                <option value="50">50/page</option>
                                <option value="100">100/page</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-wrapper">
                            <div id="usersTableSkeleton" class="table-skeleton" style="display: none;">
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                </div>
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                </div>
                            </div>
                            <table class="admin-table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortTable('users', 'Utilisateur')">Utilisateur</th>
                                        <th>Pass</th>
                                        <th class="sortable" onclick="sortTable('users', 'DateCreation')">Date</th>
                                        <th>Accès Admin</th>
                                        <th>Accès Finance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersData">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading-indicator">
                                                <div class="spinner-border"></div>
                                                <div>Chargement des utilisateurs...</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="users-pagination" class="pagination-controls" style="display: none;"></div>
                    </div>
                    
                    <div id="users-message" class="alert-message" style="display: none;"></div>
                </div>

                <!-- Section 4: Gestion des Fournisseurs -->
                <div id="section-fournisseur" class="section-content">
                    <div class="section-header">
                        <h2 class="section-title">Gestion des Fournisseurs</h2>
                        <button class="btn btn-primary" onclick="openAddFournisseurModal()">
                            <i class="fas fa-file-invoice-dollar"></i> Nouvelle Facture
                        </button>
                    </div>
                    
                    <!-- Contrôles Fournisseurs -->
                    <div class="controls-panel" id="fournisseur-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="fournisseur-search" placeholder="Rechercher dans Fournisseur, Désignation, Statut..." onkeyup="searchFournisseur()">
                        </div>
                        <div class="filters-group">
                            <select class="filter-select items-per-page" id="fournisseur-items-per-page" onchange="changeItemsPerPage('fournisseur')">
                                <option value="10">10/page</option>
                                <option value="20">20/page</option>
                                <option value="50">50/page</option>
                                <option value="100">100/page</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-wrapper">
                            <div id="fournisseurTableSkeleton" class="table-skeleton" style="display: none;">
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                </div>
                                <div class="table-skeleton-row">
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell short skeleton"></div>
                                    <div class="table-skeleton-cell medium skeleton"></div>
                                </div>
                            </div>
                            <table class="admin-table" id="fournisseurTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'DateDebut')">Date début</th>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'DateFin')">Date fin</th>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'Fournisseur')">Fournisseur</th>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'Designation')">Désignation</th>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'Montants')">Montant</th>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'Qte')">Qté</th>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'Statut')">Statut</th>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'MontantPaye')">Montant Payé</th>
                                        <th class="sortable" onclick="sortTable('fournisseur', 'ResteAPaye')">Reste à payé</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="fournisseurData">
                                    <tr>
                                        <td colspan="11" class="text-center">
                                            <div class="loading-indicator">
                                                <div class="spinner-border"></div>
                                                <div>Chargement des factures fournisseurs...</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="fournisseur-pagination" class="pagination-controls" style="display: none;"></div>
                    </div>
                    
                    <div id="fournisseur-message" class="alert-message" style="display: none;"></div>
                </div>
                <!-- Section 5: Gestion du Personnel -->
<div id="section-personnel" class="section-content">
    <div class="section-header">
        <h2 class="section-title">Gestion du Personnel</h2>
        <button class="btn btn-primary" onclick="openAddPersonnelModal()">
            <i class="fas fa-user-plus"></i> Nouveau Collaborateur
        </button>
    </div>
    
    <!-- Contrôles Personnel -->
    <div class="controls-panel" id="personnel-controls">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="personnel-search" placeholder="Rechercher dans Nom, Prénom, Poste, Département..." onkeyup="searchPersonnel()">
        </div>
        <div class="filters-group">
            <select class="filter-select" id="personnel-department-filter" onchange="filterByDepartment()">
                <option value="">Tous les départements</option>
            </select>
            <select class="filter-select" id="personnel-contract-filter" onchange="filterByContractType()">
                <option value="">Tous les contrats</option>
                <option value="CDI">CDI</option>
                <option value="CDD">CDD</option>
                <option value="Journalier">Journalier</option>
                <option value="Stagiaire">Stagiaire</option>
            </select>
            <select class="filter-select items-per-page" id="personnel-items-per-page" onchange="changeItemsPerPage('personnel')">
                <option value="10">10/page</option>
                <option value="20">20/page</option>
                <option value="50">50/page</option>
                <option value="100">100/page</option>
            </select>
        </div>
    </div>
    <div class="table-container">
        <div class="table-wrapper">
            <div id="personnelTableSkeleton" class="table-skeleton" style="display: none;">
                <div class="table-skeleton-row">
                    <div class="table-skeleton-cell medium skeleton"></div>
                    <div class="table-skeleton-cell medium skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                </div>
                <div class="table-skeleton-row">
                    <div class="table-skeleton-cell medium skeleton"></div>
                    <div class="table-skeleton-cell medium skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                    <div class="table-skeleton-cell short skeleton"></div>
                </div>
            </div>
            <table class="admin-table" id="personnelTable">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('personnel', 'Nom')">Nom</th>
                        <th class="sortable" onclick="sortTable('personnel', 'Prenom')">Prénom</th>
                        <th class="sortable" onclick="sortTable('personnel', 'Poste')">Poste</th>
                        <th class="sortable" onclick="sortTable('personnel', 'Departement')">Département</th>
                        <th class="sortable" onclick="sortTable('personnel', 'DateEmbauche')">Embauche</th>
                        <th class="sortable" onclick="sortTable('personnel', 'TypeContrat')">Contrat</th>
                        <th>Solde Congés</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="personnelData">
                    <tr>
                        <td colspan="9" class="text-center">
                            <div class="loading-indicator">
                                <div class="spinner-border"></div>
                                <div>Chargement des données du personnel...</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="personnel-pagination" class="pagination-controls" style="display: none;"></div>
    </div>
    
    <div id="personnel-message" class="alert-message" style="display: none;"></div>
</div>
            </div>
        </div>
    </div>

    <!-- Conteneur pour les modales -->
    <div id="modal-container"></div>
    
    <!-- Notification de déconnexion -->
    <div id="logout-notification" class="logout-notification">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Vous allez être déconnecté dans <span id="logout-countdown">30</span> secondes</span>
    </div>

    <script>
        // ==================== VARIABLES GLOBALES ====================
        let allUsersData = [];
        let allBanqueData = [];
        let banqueCategories = [];
        let allGrandCaisseData = [];
        let allFournisseurData = [];
        let currentUser = '';
        
        // Variables pour la gestion des données filtrées et triées
        let filteredBanqueData = [];
        let filteredGrandCaisseData = [];
        let filteredUsersData = [];
        let filteredFournisseurData = [];
        
        // Variables pour la pagination
        let currentPage = {
            'banque': 1,
            'grand-caisse': 1,
            'users': 1,
            'fournisseur': 1
        };
        
        let itemsPerPage = {
            'banque': 10,
            'grand-caisse': 10,
            'users': 10,
            'fournisseur': 10
        };
        
        // Variables pour le tri
        let sortState = {
            'banque': { column: 'Date', direction: 'desc' },
            'grand-caisse': { column: 'Date', direction: 'desc' },
            'users': { column: 'DateCreation', direction: 'desc' },
            'fournisseur': { column: 'DateDebut', direction: 'desc' }
        };
        
        // Variables pour la recherche
        let searchTerm = {
            'banque': '',
            'grand-caisse': '',
            'users': '',
            'fournisseur': ''
        };
        
        // Variables pour la gestion de l'inactivité
        let inactivityTimer;
        let logoutWarningTimer;
        let logoutTimeout = 5 * 60 * 1000; // 5 minutes
        let warningTimeout = 30 * 1000; // 30 secondes
        let isLogoutWarningActive = false;

        // Variables pour la gestion des toasts
        let toastId = 0;

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Récupérer l'utilisateur connecté
            currentUser = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");
            
            if (currentUser) {
                document.getElementById('username-display').textContent = currentUser;
                document.querySelector('.profile-img').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser)}&background=6366f1&color=fff`;
            } else {
                document.getElementById('username-display').textContent = 'Administrateur';
            }
            
            // Charger les données initiales
            loadUsersData();
            loadBanqueData();
            loadGrandCaisseData();
            loadFournisseurData();
            loadPersonnelData();
            
            // Démarrer le timer d'inactivité
            resetInactivityTimer();
            
            // Ajouter les événements pour détecter l'activité
            setupActivityListeners();
            
            // Gérer le scroll pour le FAB
            window.addEventListener('scroll', handleScroll);
            
            // Initialiser le tooltip pour les mots de passe
            createPasswordTooltip();
        });

        // ==================== FONCTIONS DE TRI ====================
        function sortTable(tableType, column) {
            const currentSort = sortState[tableType];
            
            // Si on clique sur la même colonne, on inverse le sens
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // Sinon, on trie par cette colonne en ascendant par défaut
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Mettre à jour les indicateurs visuels
            updateSortIndicators(tableType, column, currentSort.direction);
            
            // Appliquer le tri
            applySort(tableType);
            
            // Revenir à la première page
            currentPage[tableType] = 1;
            
            // Mettre à jour l'affichage
            updateTableDisplay(tableType);
        }

        function updateSortIndicators(tableType, column, direction) {
            // Retirer toutes les classes de tri
            const table = document.getElementById(`${tableType}Table`);
            if (!table) return;
            
            const headers = table.querySelectorAll('th.sortable');
            headers.forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            
            // Ajouter la classe appropriée à l'en-tête cliqué
            const targetHeader = Array.from(headers).find(header => 
                header.textContent.includes(column) || header.onclick.toString().includes(column)
            );
            
            if (targetHeader) {
                targetHeader.classList.add(direction);
            }
        }
        function applySort(tableType) {
    const sortConfig = sortState[tableType];
    let dataToSort = getCurrentData(tableType);
    
    if (dataToSort.length === 0) return;
    
    dataToSort.sort((a, b) => {
        let valueA = a[sortConfig.column];
        let valueB = b[sortConfig.column];
        
        // Traitement spécial pour les dates
        if (sortConfig.column.includes('Date')) {
            valueA = new Date(valueA);
            valueB = new Date(valueB);
        }
        
        // Traitement spécial pour les nombres
        if (sortConfig.column === 'SalaireBase' || sortConfig.column === 'PrimePerformance' || 
            sortConfig.column === 'PrimeAssiduite' || sortConfig.column === 'PrimeResponsabilite' ||
            sortConfig.column === 'SoldeConges' || sortConfig.column === 'CongesAnnuels') {
            valueA = parseFloat(valueA) || 0;
            valueB = parseFloat(valueB) || 0;
        }
        
        if (valueA < valueB) return sortConfig.direction === 'asc' ? -1 : 1;
        if (valueA > valueB) return sortConfig.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Mettre à jour les données filtrées
    switch(tableType) {
        case 'banque':
            filteredBanqueData = dataToSort;
            break;
        case 'grand-caisse':
            filteredGrandCaisseData = dataToSort;
            break;
        case 'users':
            filteredUsersData = dataToSort;
            break;
        case 'fournisseur':
            filteredFournisseurData = dataToSort;
            break;
        case 'personnel':
            filteredPersonnelData = dataToSort;
            break;
    }
}


        // ==================== FONCTIONS DE RECHERCHE ====================
        function searchBanque() {
            const searchInput = document.getElementById('banque-search');
            searchTerm.banque = searchInput.value.toLowerCase().trim();
            applySearch('banque');
        }

        function searchGrandCaisse() {
            const searchInput = document.getElementById('grand-caisse-search');
            searchTerm['grand-caisse'] = searchInput.value.toLowerCase().trim();
            applySearch('grand-caisse');
        }

        function searchUsers() {
            const searchInput = document.getElementById('users-search');
            searchTerm.users = searchInput.value.toLowerCase().trim();
            applySearch('users');
        }

        function searchFournisseur() {
            const searchInput = document.getElementById('fournisseur-search');
            searchTerm.fournisseur = searchInput.value.toLowerCase().trim();
            applySearch('fournisseur');
        }

        function applySearch(tableType) {
            const search = searchTerm[tableType];
            let allData = [];
            
            switch(tableType) {
                case 'banque':
                    allData = allBanqueData;
                    break;
                case 'grand-caisse':
                    allData = allGrandCaisseData;
                    break;
                case 'users':
                    allData = allUsersData;
                    break;
                case 'fournisseur':
                    allData = allFournisseurData;
                    break;
            }
            
            if (!search) {
                // Si pas de recherche, on utilise toutes les données
                switch(tableType) {
                    case 'banque':
                        filteredBanqueData = [];
                        break;
                    case 'grand-caisse':
                        filteredGrandCaisseData = [];
                        break;
                    case 'users':
                        filteredUsersData = [];
                        break;
                    case 'fournisseur':
                        filteredFournisseurData = [];
                        break;
                }
            } else {
                // Filtrer les données selon le type de table
                switch(tableType) {
                    case 'banque':
                        filteredBanqueData = allData.filter(item => {
                            return (
                                (item.Designation && item.Designation.toLowerCase().includes(search)) ||
                                (item.Categorie && item.Categorie.toLowerCase().includes(search)) ||
                                (item.Type && item.Type.toLowerCase().includes(search)) ||
                                (item.Montant && item.Montant.toString().includes(search))
                            );
                        });
                        break;
                        
                    case 'grand-caisse':
                        filteredGrandCaisseData = allData.filter(item => {
                            return (
                                (item.Designation && item.Designation.toLowerCase().includes(search)) ||
                                (item.Categorie && item.Categorie.toLowerCase().includes(search)) ||
                                (item.ModePaiement && item.ModePaiement.toLowerCase().includes(search)) ||
                                (item.Mouvement && item.Mouvement.toLowerCase().includes(search))
                            );
                        });
                        break;
                        
                    case 'users':
                        filteredUsersData = allData.filter(item => {
                            const dateStr = formatDate(item.DateCreation).toLowerCase();
                            return (
                                (item.Utilisateur && item.Utilisateur.toLowerCase().includes(search)) ||
                                dateStr.includes(search)
                            );
                        });
                        break;
                        
                    case 'fournisseur':
                        filteredFournisseurData = allData.filter(item => {
                            return (
                                (item.Fournisseur && item.Fournisseur.toLowerCase().includes(search)) ||
                                (item.Designation && item.Designation.toLowerCase().includes(search)) ||
                                (item.Statut && item.Statut.toLowerCase().includes(search)) ||
                                (item.Note && item.Note.toLowerCase().includes(search)) ||
                                (item.Idfacture && item.Idfacture.toLowerCase().includes(search))
                            );
                        });
                        break;
                }
            }
            
            // Réappliquer le tri après la recherche
            applySort(tableType);
            
            // Revenir à la première page
            currentPage[tableType] = 1;
            
            // Mettre à jour l'affichage
            updateTableDisplay(tableType);
            
            // Mettre à jour les cartes de synthèse pour la banque et grande caisse
            if (tableType === 'banque') {
                updateBanqueSummaryCards(getCurrentData('banque'));
            } else if (tableType === 'grand-caisse') {
                updateGrandCaisseSummaryCards(getCurrentData('grand-caisse'));
            }
        }

        // ==================== FONCTIONS DE PAGINATION ====================
        function changeItemsPerPage(tableType) {
            const select = document.getElementById(`${tableType}-items-per-page`);
            itemsPerPage[tableType] = parseInt(select.value);
            currentPage[tableType] = 1;
            updateTableDisplay(tableType);
        }

// Dans la fonction getCurrentData, ajouter le cas personnel
function getCurrentData(tableType) {
    let data = [];
    switch(tableType) {
        case 'banque':
            data = filteredBanqueData.length > 0 ? filteredBanqueData : allBanqueData;
            break;
        case 'grand-caisse':
            data = filteredGrandCaisseData.length > 0 ? filteredGrandCaisseData : allGrandCaisseData;
            break;
        case 'users':
            data = filteredUsersData.length > 0 ? filteredUsersData : allUsersData;
            break;
        case 'fournisseur':
            data = filteredFournisseurData.length > 0 ? filteredFournisseurData : allFournisseurData;
            break;
        case 'personnel':
            data = filteredPersonnelData.length > 0 ? filteredPersonnelData : allPersonnelData;
            break;
    }
    return data;
}

function getPaginatedData(tableType) {
    const data = getCurrentData(tableType);
    const startIndex = (currentPage[tableType] - 1) * itemsPerPage[tableType];
    const endIndex = startIndex + itemsPerPage[tableType];
    return data.slice(startIndex, endIndex);
}

        function updatePagination(tableType) {
            const data = getCurrentData(tableType);
            const totalItems = data.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage[tableType]);
            
            const paginationDiv = document.getElementById(`${tableType}-pagination`);
            if (!paginationDiv) return;
            
            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            
            let html = '';
            
            // Bouton Précédent
            html += `<button class="pagination-btn" onclick="changePage('${tableType}', ${currentPage[tableType] - 1})" ${currentPage[tableType] === 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i>
                     </button>`;
            
            // Pages
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage[tableType] - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="changePage('${tableType}', 1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-dots">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === currentPage[tableType] ? 'active' : ''}" onclick="changePage('${tableType}', ${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="pagination-dots">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="changePage('${tableType}', ${totalPages})">${totalPages}</button>`;
            }
            
            // Bouton Suivant
            html += `<button class="pagination-btn" onclick="changePage('${tableType}', ${currentPage[tableType] + 1})" ${currentPage[tableType] === totalPages ? 'disabled' : ''}>
                        <i class="fas fa-chevron-right"></i>
                     </button>`;
            
            // Information sur les éléments
            const startItem = (currentPage[tableType] - 1) * itemsPerPage[tableType] + 1;
            const endItem = Math.min(currentPage[tableType] * itemsPerPage[tableType], totalItems);
            
            html += `<div class="pagination-info">${startItem}-${endItem} sur ${totalItems}</div>`;
            
            paginationDiv.innerHTML = html;
        }

        function changePage(tableType, page) {
            const data = getCurrentData(tableType);
            const totalPages = Math.ceil(data.length / itemsPerPage[tableType]);
            
            if (page < 1 || page > totalPages) return;
            
            currentPage[tableType] = page;
            updateTableDisplay(tableType);
            
            // Scroll vers le haut de la table
            const tableContainer = document.querySelector(`#section-${tableType} .table-container`);
            if (tableContainer) {
                tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

function updateTableDisplay(tableType) {
    const paginatedData = getPaginatedData(tableType);
    
    switch(tableType) {
        case 'banque':
            displayBanqueData(paginatedData);
            break;
        case 'grand-caisse':
            displayGrandCaisseData(paginatedData);
            break;
        case 'users':
            displayUsersData(paginatedData);
            break;
        case 'fournisseur':
            displayFournisseurData(paginatedData);
            break;
        case 'personnel':
            displayPersonnelData(paginatedData);
            break;
    }
    
    updatePagination(tableType);
}

        // ==================== GESTION DES DONNÉES ====================
        function loadBanqueData() {
            showTableSkeleton('banque');
            
            // Charger les catégories
            loadBanqueCategories();
            
            fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=banque')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data?.rows) {
                        allBanqueData = data.data.rows.map(row => ({
                            Date: row[0] || '',
                            Designation: row[1] || '',
                            Montant: parseFloat(row[2]) || 0,
                            Type: row[3] || '',
                            Solde: parseFloat(row[4]) || 0,
                            Categorie: row[5] || '',
                            Idunique: row[6] || ''
                        }));
                        
                        // Appliquer le tri par défaut (Date DESC)
                        applySort('banque');
                        
                        hideTableSkeleton('banque');
                        updateTableDisplay('banque');
                        updateBanqueSummaryCards(getCurrentData('banque'));
                        
                        // Appliquer les indicateurs de tri visuels
                        updateSortIndicators('banque', 'Date', 'desc');
                        
                        showToast(`${allBanqueData.length} transactions chargées`, 'success');
                    } else {
                        throw new Error('Structure de données invalide');
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des transactions:', error);
                    hideTableSkeleton('banque');
                    document.getElementById('banqueData').innerHTML = `
                        <tr>
                            <td colspan="8">
                                <div class="error-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div>Erreur de chargement</div>
                                    <button class="btn btn-primary" onclick="loadBanqueData()">Réessayer</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    showToast('Erreur lors du chargement des transactions', 'error');
                });
        }

        function loadGrandCaisseData() {
            showTableSkeleton('grandCaisse');
            
            fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=grandcaisse')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data?.rows) {
                        allGrandCaisseData = data.data.rows.map(row => ({
                            Date: row[0] || '',
                            Designation: row[1] || '',
                            Montant: parseFloat(row[2]) || 0,
                            Mouvement: row[3] || '',
                            Agence: row[4] || '',
                            EnCaisse: parseFloat(row[5]) || 0,
                            ModePaiement: row[6] || '',
                            Categorie: row[7] || ''
                        }));
                        
                        // Appliquer le tri par défaut (Date DESC)
                        applySort('grand-caisse');
                        
                        hideTableSkeleton('grandCaisse');
                        updateTableDisplay('grand-caisse');
                        updateGrandCaisseSummaryCards(getCurrentData('grand-caisse'));
                        
                        // Appliquer les indicateurs de tri visuels
                        updateSortIndicators('grand-caisse', 'Date', 'desc');
                        
                        showToast(`${allGrandCaisseData.length} entrées chargées`, 'success');
                    } else {
                        throw new Error('Structure de données invalide');
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des données:', error);
                    hideTableSkeleton('grandCaisse');
                    document.getElementById('grandCaisseData').innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="error-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div>Erreur de chargement</div>
                                    <button class="btn btn-primary" onclick="loadGrandCaisseData()">Réessayer</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    showToast('Erreur lors du chargement des données', 'error');
                });
        }

        function loadUsersData() {
            showTableSkeleton('users');
            
            fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=listedesutilisateur')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data?.rows) {
                        allUsersData = data.data.rows.map(row => ({
                            Utilisateur: row[0] || '',
                            Pass: row[1] || '',
                            DateCreation: row[2] || '',
                            Acces: row[3] || '',
                            Caisse: row[4] || ''
                        }));
                        
                        // Appliquer le tri par défaut (DateCreation DESC)
                        applySort('users');
                        
                        hideTableSkeleton('users');
                        updateTableDisplay('users');
                        
                        // Appliquer les indicateurs de tri visuels
                        updateSortIndicators('users', 'DateCreation', 'desc');
                        
                        showToast(`${allUsersData.length} utilisateurs chargés`, 'success');
                    } else {
                        throw new Error('Structure de données invalide');
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des utilisateurs:', error);
                    hideTableSkeleton('users');
                    document.getElementById('usersData').innerHTML = `
                        <tr>
                            <td colspan="6">
                                <div class="error-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div>Erreur de chargement</div>
                                    <button class="btn btn-primary" onclick="loadUsersData()">Réessayer</button>
                                </div>
                            </td>
                        </tr>
                    `;
                    showToast('Erreur lors du chargement des utilisateurs', 'error');
                });
        }

        // ==================== AFFICHAGE DES DONNÉES ====================
        function displayBanqueData(data) {
            const tbody = document.getElementById('banqueData');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">Aucune transaction trouvée</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach((transaction, index) => {
                const amountClass = transaction.Type === 'Debited' || transaction.Type === 'Débité' ? 'text-danger' : 'text-success';
                const typeText = transaction.Type || 'Non spécifié';
                
                // Vérifier si le solde est négatif
                const soldeClass = transaction.Solde < 0 ? 'solde-negatif' : '';
                
                html += `
                    <tr style="animation-delay: ${index * 0.02}s">
                        <td>${formatDate(transaction.Date)}</td>
                        <td title="${transaction.Designation}">${transaction.Designation ? (transaction.Designation.substring(0, 50) + (transaction.Designation.length > 50 ? '...' : '')) : 'N/A'}</td>
                        <td class="${amountClass}">${formatCurrency(transaction.Montant)}</td>
                        <td><span class="status-badge ${typeText === 'Credited' || typeText === 'Crédité' ? 'status-success' : 'status-danger'}">${typeText}</span></td>
                        <td class="${soldeClass}">${formatCurrency(transaction.Solde)}</td>
                        <td>${transaction.Categorie || ''}</td>
                        <td><small>${transaction.Idunique || 'N/A'}</small></td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn btn-edit" onclick="editBanqueTransaction('${transaction.Idunique}')" title="Modifier catégorie">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function displayGrandCaisseData(data) {
            const tbody = document.getElementById('grandCaisseData');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">Aucune donnée trouvée</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach((item, index) => {
                const montantClass = item.Mouvement === 'Sortie' ? 'text-danger' : 'text-success';
                
                html += `
                    <tr style="animation-delay: ${index * 0.02}s">
                        <td>${formatDate(item.Date)}</td>
                        <td title="${item.Designation}">${item.Designation ? (item.Designation.substring(0, 50) + (item.Designation.length > 50 ? '...' : '')) : 'N/A'}</td>
                        <td class="${montantClass}">${formatCurrency(item.Montant)}</td>
                        <td><span class="status-badge ${item.Mouvement === 'Entrée' ? 'status-success' : 'status-danger'}">${item.Mouvement || 'N/A'}</span></td>
                        <td>${item.ModePaiement || 'N/A'}</td>
                        <td>${item.Categorie || 'N/A'}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Vérifier si "En Caisse" est négatif dans les cartes de synthèse
            const soldeCaisseElement = document.getElementById('grand-caisse-solde');
            const soldeCaisse = parseFloat(soldeCaisseElement.textContent.replace(/[^\d.-]/g, ''));
            if (soldeCaisse < 0) {
                soldeCaisseElement.classList.add('en-caisse-negatif');
            }
        }

        function displayUsersData(data) {
            const tbody = document.getElementById('usersData');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">Aucun utilisateur trouvé</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach((user, index) => {
                html += `
                    <tr style="animation-delay: ${index * 0.02}s">
                        <td><strong>${user.Utilisateur || 'N/A'}</strong></td>
                        <td>
                            <span 
                                class="password-display" 
                                title="${user.Pass || 'N/A'}"
                                data-password="${user.Pass || ''}"
                                onmouseenter="showPasswordTooltip(this)"
                                onmouseleave="hidePasswordTooltip()"
                            >
                                ${user.Pass ? '********' : 'N/A'}
                            </span>
                        </td>
                        <td>${formatDate(user.DateCreation)}</td>
                        <td><span class="status-badge ${user.Acces === 'OUI' ? 'status-success' : 'status-danger'}">${user.Acces || 'NON'}</span></td>
                        <td><span class="status-badge ${user.Caisse === 'OUI' ? 'status-success' : 'status-danger'}">${user.Caisse || 'NON'}</span></td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn btn-edit" onclick="editUser(${index})" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteUser('${user.Utilisateur}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // ==================== FONCTIONS UTILITAIRES ====================
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('fr-FR');
            } catch (e) {
                return dateString;
            }
        }

        function formatDateFR(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                
                return `${day}/${month}/${year}`;
            } catch (e) {
                return dateString;
            }
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
            return amount.toLocaleString('fr-FR', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        }

        function formatNumber(value, decimals = 2) {
            if (typeof value !== 'number') value = parseFloat(value) || 0;
            
            // Format avec virgule pour les décimales et sans séparateur de milliers
            return value.toLocaleString('fr-FR', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
                useGrouping: false
            });
        }

        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startTime = performance.now();
            const step = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = start + (end - start) * easeOutQuart;
                
                element.textContent = formatCurrency(currentValue);
                
                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    element.textContent = formatCurrency(end);
                }
            };
            
            requestAnimationFrame(step);
        }

        function updateBanqueSummaryCards(data) {
            let creditedTotal = 0;
            let debitedTotal = 0;
            
            data.forEach(transaction => {
                if (transaction.Type === 'Credited' || transaction.Type === 'Crédité') {
                    creditedTotal += transaction.Montant;
                } else if (transaction.Type === 'Debited' || transaction.Type === 'Débité') {
                    debitedTotal += transaction.Montant;
                }
            });
            
            const soldeDisponible = creditedTotal - debitedTotal;
            
            animateValue('credited-total', 0, creditedTotal, 500);
            animateValue('debited-total', 0, debitedTotal, 500);
            animateValue('solde-disponible', 0, soldeDisponible, 500);
            
            const soldeElement = document.getElementById('solde-disponible');
            if (soldeDisponible >= 0) {
                soldeElement.style.color = '#10b981';
            } else {
                soldeElement.style.color = '#ef4444';
            }
        }

        function updateGrandCaisseSummaryCards(data) {
            let entreeTotal = 0;
            let sortieTotal = 0;
            
            data.forEach(item => {
                if (item.Mouvement === 'Entrée') {
                    entreeTotal += item.Montant;
                } else if (item.Mouvement === 'Sortie') {
                    sortieTotal += item.Montant;
                }
            });
            
            const soldeCaisse = entreeTotal - sortieTotal;
            
            animateValue('grand-caisse-entrees', 0, entreeTotal, 500);
            animateValue('grand-caisse-sorties', 0, sortieTotal, 500);
            animateValue('grand-caisse-solde', 0, soldeCaisse, 500);
            
            const soldeElement = document.getElementById('grand-caisse-solde');
            if (soldeCaisse >= 0) {
                soldeElement.style.color = '#10b981';
            } else {
                soldeElement.style.color = '#ef4444';
                soldeElement.classList.add('en-caisse-negatif');
            }
        }

        // ==================== NAVIGATION ====================
        function showAdminSection(sectionId) {
            // Mettre à jour les boutons de navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            
            const btn = document.querySelector(`.nav-btn[onclick*="${sectionId}"]`);
            if (btn) btn.classList.add('active');
            
            const section = document.getElementById(`section-${sectionId}`);
            if (section) section.classList.add('active');
            
            // Charger les données si nécessaire
            if (sectionId === 'users' && allUsersData.length === 0) {
                showTableSkeleton('users');
                setTimeout(() => loadUsersData(), 100);
            } else if (sectionId === 'banque' && allBanqueData.length === 0) {
                showTableSkeleton('banque');
                setTimeout(() => loadBanqueData(), 100);
            } else if (sectionId === 'grand-caisse' && allGrandCaisseData.length === 0) {
                showTableSkeleton('grandCaisse');
                setTimeout(() => loadGrandCaisseData(), 100);
            } else if (sectionId === 'fournisseur' && allFournisseurData.length === 0) {
                showTableSkeleton('fournisseur');
                setTimeout(() => loadFournisseurData(), 100);
            }else if (sectionId === 'fournisseur' && allFournisseurData.length === 0) {
                showTableSkeleton('personnels');
                setTimeout(() => loadPersonnelData(), 100);
            }
        }

        function openVueGlobale() {
            try {
                window.location.href = 'Accueil.html';
            } catch (error) {
                console.error("Erreur d'ouverture:", error);
                showToast("Impossible d'ouvrir la page. Contactez l'administrateur.", 'error');
            }
        }

        // ==================== FONCTIONS UX/UI ====================
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            const id = `toast-${toastId++}`;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = id;
            
            let icon = 'info-circle';
            switch(type) {
                case 'success': icon = 'check-circle'; break;
                case 'error': icon = 'exclamation-circle'; break;
                case 'warning': icon = 'exclamation-triangle'; break;
                case 'info': icon = 'info-circle'; break;
            }
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="closeToast('${id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                closeToast(id);
            }, duration);
            
            return id;
        }

        function closeToast(id) {
            const toast = document.getElementById(id);
            if (toast) {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        function handleScroll() {
            const fab = document.getElementById('fab');
            if (window.scrollY > 300) {
                fab.style.display = 'flex';
            } else {
                fab.style.display = 'none';
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function showTableSkeleton(tableType) {
            const skeletonId = `${tableType}TableSkeleton`;
            const skeleton = document.getElementById(skeletonId);
            const table = document.getElementById(`${tableType}Table`);
            
            if (skeleton && table) {
                skeleton.style.display = 'block';
                table.style.display = 'none';
            }
        }

        function hideTableSkeleton(tableType) {
            const skeletonId = `${tableType}TableSkeleton`;
            const skeleton = document.getElementById(skeletonId);
            const table = document.getElementById(`${tableType}Table`);
            
            if (skeleton && table) {
                skeleton.style.display = 'none';
                table.style.display = 'table';
            }
        }

        // ==================== GESTION DE L'INACTIVITÉ ====================
        function setupActivityListeners() {
            const events = ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'];
            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer);
            });
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            
            if (isLogoutWarningActive) {
                hideLogoutWarning();
            }
            
            inactivityTimer = setTimeout(showLogoutWarning, logoutTimeout - warningTimeout);
        }

        function showLogoutWarning() {
            isLogoutWarningActive = true;
            const notification = document.getElementById('logout-notification');
            const countdownElement = document.getElementById('logout-countdown');
            
            notification.style.display = 'flex';
            
            let countdown = 30;
            countdownElement.textContent = countdown;
            
            logoutWarningTimer = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    logoutUser();
                }
            }, 1000);
        }

        function hideLogoutWarning() {
            isLogoutWarningActive = false;
            const notification = document.getElementById('logout-notification');
            notification.style.display = 'none';
            clearInterval(logoutWarningTimer);
        }

        function logoutUser() {
            clearTimeout(inactivityTimer);
            clearTimeout(logoutWarningTimer);
            
            sessionStorage.removeItem("utilisateur");
            localStorage.removeItem("utilisateur");
            
            showToast('Vous avez été déconnecté pour inactivité', 'warning');
            setTimeout(() => {
                window.location.href = 'Accueil.html';
            }, 2000);
        }
 
        let passwordTooltip = null;

        function createPasswordTooltip() {
            if (!passwordTooltip) {
                passwordTooltip = document.createElement('div');
                passwordTooltip.className = 'password-tooltip';
                document.body.appendChild(passwordTooltip);
            }
            return passwordTooltip;
        }

        function showPasswordTooltip(element) {
            const tooltip = createPasswordTooltip();
            const password = element.getAttribute('data-password');
            
            if (!password) {
                tooltip.textContent = 'Aucun mot de passe';
            } else {
                tooltip.textContent = `Mot de passe : ${password}`;
            }
            
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + window.scrollX}px`;
            tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 10}px`;
            
            tooltip.classList.add('active');
        }

        function hidePasswordTooltip() {
            if (passwordTooltip) {
                passwordTooltip.classList.remove('active');
            }
        }

        function copyPassword(password) {
            if (!password) return;
            
            navigator.clipboard.writeText(password)
                .then(() => {
                    const originalText = passwordTooltip.textContent;
                    passwordTooltip.textContent = 'Copié !';
                    
                    setTimeout(() => {
                        passwordTooltip.textContent = originalText;
                    }, 1000);
                })
                .catch(err => {
                    console.error('Erreur lors de la copie :', err);
                });
        }

        function closeModal() {
            // actualiser la page , pour etre sur que les donnée identique
            // donc ne pas changer
            window.location.href = 'Admin.html';
        }

        // Fonctions pour la gestion des utilisateurs (restent inchangées)
        async function loadBanqueCategories() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getconfigdata');
                const data = await response.json();
                
                if (data.success && data.data?.categories) {
                    banqueCategories = data.data.categories;
                } else {
                    banqueCategories = [];
                }
            } catch (error) {
                console.error('Erreur lors du chargement des catégories:', error);
                banqueCategories = [];
            }
        }

        function openAddUserModal() {
            const modalContainer = document.getElementById('modal-container');
            
            const modalHTML = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Nouvel Utilisateur</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addUserForm">
                                <div class="form-group">
                                    <label class="form-label">Nom d'utilisateur *</label>
                                    <input type="text" class="form-control" id="newUsername" required autofocus>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mot de passe *</label>
                                    <input type="Text" class="form-control" id="newPassword" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Confirmer le mot de passe *</label>
                                    <input type="Text" class="form-control" id="confirmPassword" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Accès administration</label>
                                    <select class="form-control" id="newAccess">
                                        <option value="OUI">OUI</option>
                                        <option value="NON">NON</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Accès caisse</label>
                                    <select class="form-control" id="newCaisse">
                                        <option value="OUI">OUI</option>
                                        <option value="NON">NON</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="submitNewUser()" id="submitUserBtn">Ajouter</button>
                            <button class="btn" onclick="closeModal()">Annuler</button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = modalHTML;
        }

        function submitNewUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const access = document.getElementById('newAccess').value;
            const caisse = document.getElementById('newCaisse').value;
            
            if (!username || !password) {
                showToast('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            const userData = {
                username: username,
                password: password,
                access: access,
                caisse: caisse
            };
            
            const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=adduser";
            
            const submitBtn = document.getElementById('submitUserBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout...';
            submitBtn.disabled = true;
            
            showProgressOverlay('Ajout de l\'utilisateur...');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(() => {
                hideProgressOverlay();
                showToast('✅ Utilisateur ajouté avec succès', 'success');
                
                setTimeout(() => {
                    loadUsersData();
                    closeModal();
                }, 1000);
            })
            .catch(error => {
                console.error('Erreur lors de l\'ajout:', error);
                hideProgressOverlay();
                showToast('❌ Erreur lors de l\'ajout de l\'utilisateur', 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        function editUser(index) {
            const user = allUsersData[index];
            
            const modalContainer = document.getElementById('modal-container');
            
            const modalHTML = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Modifier Utilisateur</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm">
                                <div class="form-group">
                                    <label class="form-label">Nom d'utilisateur</label>
                                    <input type="text" class="form-control" value="${user.Utilisateur}" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nouveau mot de passe</label>
                                    <input type="text" class="form-control" value="${user.Pass}" id="editPassword" placeholder="Nouveau mot de passe">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Accès administration</label>
                                    <select class="form-control" id="editAccess">
                                        <option value="OUI" ${user.Acces === 'OUI' ? 'selected' : ''}>OUI</option>
                                        <option value="NON" ${user.Acces !== 'OUI' ? 'selected' : ''}>NON</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Accès caisse</label>
                                    <select class="form-control" id="editCaisse">
                                        <option value="OUI" ${user.Caisse === 'OUI' ? 'selected' : ''}>OUI</option>
                                        <option value="NON" ${user.Caisse !== 'OUI' ? 'selected' : ''}>NON</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="submitUserUpdate(${index})" id="updateUserBtn">Enregistrer</button>
                            <button class="btn" onclick="closeModal()">Annuler</button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = modalHTML;
        }

        function submitUserUpdate(index) {
            const user = allUsersData[index];
            const newPassword = document.getElementById('editPassword').value;
            const access = document.getElementById('editAccess').value;
            const caisse = document.getElementById('editCaisse').value;
            
            const updatedData = {
                username: user.Utilisateur,
                password: newPassword || '',
                access: access,
                caisse: caisse
            };
            
            const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=updateuser";
            
            const submitBtn = document.getElementById('updateUserBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
            submitBtn.disabled = true;
            
            showProgressOverlay('Mise à jour de l\'utilisateur...');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedData)
            })
            .then(() => {
                hideProgressOverlay();
                showToast('✅ Utilisateur mis à jour avec succès', 'success');
                
                setTimeout(() => {
                    loadUsersData();
                    closeModal();
                }, 1000);
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour:', error);
                hideProgressOverlay();
                showToast('❌ Erreur lors de la mise à jour', 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        function deleteUser(username) {
            if (!username || username === 'N/A') {
                showToast('Nom d\'utilisateur invalide', 'error');
                return;
            }
            
            if (!confirm(`Êtes-vous sûr de vouloir supprimer l'utilisateur "${username}" ?`)) {
                return;
            }
            
            const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=deleteuser";
            
            showProgressOverlay('Suppression de l\'utilisateur...');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: username })
            })
            .then(() => {
                hideProgressOverlay();
                showToast('✅ Utilisateur supprimé avec succès', 'success');
                
                setTimeout(() => {
                    loadUsersData();
                }, 1000);
            })
            .catch(error => {
                console.error('Erreur lors de la suppression:', error);
                hideProgressOverlay();
                showToast('❌ Erreur lors de la suppression', 'error');
            });
        }

        function editBanqueTransaction(idUnique) {
            const transaction = allBanqueData.find(item => item.Idunique === idUnique);
            if (!transaction) {
                showToast('Transaction non trouvée', 'error');
                return;
            }
            
            const modalContainer = document.getElementById('modal-container');
            
            let categoryOptions = '';
            
            if (banqueCategories.length > 0 && typeof banqueCategories[0] === 'object') {
                banqueCategories.forEach(cat => {
                    const selected = cat.value === transaction.Categorie ? 'selected' : '';
                    categoryOptions += `<option value="${cat.value}" ${selected}>${cat.label}</option>`;
                });
            } else {
                const allCategories = [...new Set([...banqueCategories, transaction.Categorie].filter(Boolean))];
                allCategories.forEach(cat => {
                    const selected = cat === transaction.Categorie ? 'selected' : '';
                    categoryOptions += `<option value="${cat}" ${selected}>${cat}</option>`;
                });
            }
            
            const modalHTML = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Modifier Catégorie (ID: ${idUnique})</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editBanqueForm">
                                <div class="form-group">
                                    <label class="form-label">ID Unique</label>
                                    <input type="text" class="form-control" value="${idUnique}" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date</label>
                                    <input type="text" class="form-control" value="${formatDate(transaction.Date)}" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Désignation</label>
                                    <textarea class="form-control" rows="2" readonly>${transaction.Designation || 'N/A'}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Montant</label>
                                    <input type="text" class="form-control" value="${formatCurrency(transaction.Montant)}" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <input type="text" class="form-control" value="${transaction.Type || 'N/A'}" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Catégorie *</label>
                                    <select class="form-control" id="editBanqueCategorie" required autofocus>
                                        <option value="">Sélectionner...</option>
                                        ${categoryOptions}
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="submitBanqueUpdate('${idUnique}')" id="updateBanqueBtn">Enregistrer</button>
                            <button class="btn" onclick="closeModal()">Annuler</button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = modalHTML;
        }

        function submitBanqueUpdate(idUnique) {
            const categorie = document.getElementById('editBanqueCategorie').value;
            
            if (!categorie) {
                showToast('Veuillez sélectionner une catégorie', 'warning');
                return;
            }
            
            const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=updatebanque";
            
            const updatedData = {
                idUnique: idUnique,
                categorie: categorie
            };
            
            const submitBtn = document.getElementById('updateBanqueBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
            submitBtn.disabled = true;
            
            showProgressOverlay('Mise à jour de la catégorie...');
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedData)
            })
            .then(() => {
                hideProgressOverlay();
                showToast('✅ Catégorie mise à jour avec succès', 'success');
                
                setTimeout(() => {
                    loadBanqueData();
                    closeModal();
                }, 1000);
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour:', error);
                hideProgressOverlay();
                showToast('❌ Erreur lors de la mise à jour', 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        async function openAddGrandCaisseModal() {
            const modalContainer = document.getElementById('modal-container');
            
            const today = new Date().toISOString().split('T')[0];
            
            const modalHTML = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Nouvelle Entrée Grande Caisse</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="modalLoading" class="loading-indicator" style="min-height: 200px;">
                                <div class="spinner-border"></div>
                                <div>Chargement des catégories...</div>
                            </div>
                            <form id="addGrandCaisseForm" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Date *</label>
                                    <input type="date" class="form-control" id="grandCaisseDate" value="${today}" required autofocus>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Désignation *</label>
                                    <input type="text" class="form-control" id="grandCaisseDesignation" required placeholder="Description de l'opération">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Montant *</label>
                                    <input type="number" step="0.01" class="form-control" id="grandCaisseMontant" required placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mouvement *</label>
                                    <select class="form-control" id="grandCaisseMouvement" required>
                                        <option value="Sortie">Sortie</option>
                                        <option value="Entrée">Entrée</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Agence *</label>
                                    <input type="text" class="form-control" id="grandCaisseAgence" value="Grand-C" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mode de Paiement *</label>
                                    <select class="form-control" id="grandCaisseModePaiement" required>
                                        <option value="CASH">CASH</option>
                                        <option value="CARD">CARD</option>
                                        <option value="VIREMENT">VIREMENT</option>
                                        <option value="CHEQUE">CHEQUE</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Catégorie *</label>
                                    <div class="autocomplete-container" style="position: relative;">
                                        <input type="text" 
                                               class="form-control" 
                                               id="grandCaisseCategorie" 
                                               required 
                                               placeholder="Commencez à taper pour filtrer..."
                                               autocomplete="off">
                                       <div id="categoriesDropdown" class="categories-dropdown"></div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer" id="modalFooter" style="display: none;">
                            <button class="btn btn-primary" onclick="submitGrandCaisse()" id="submitGrandCaisseBtn">Ajouter</button>
                            <button class="btn" onclick="closeModal()">Annuler</button>
                        </div>
                    </div>
                </div>
            `;
            
            modalContainer.innerHTML = modalHTML;
            
            try {
                await loadBanqueCategories();
                
                const modalLoading = document.getElementById('modalLoading');
                const addGrandCaisseForm = document.getElementById('addGrandCaisseForm');
                const modalFooter = document.getElementById('modalFooter');
                
                if (modalLoading && addGrandCaisseForm && modalFooter) {
                    modalLoading.style.display = 'none';
                    addGrandCaisseForm.style.display = 'block';
                    modalFooter.style.display = 'flex';
                    
                    initializeCategoryAutocomplete();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des catégories:', error);
                
                const modalLoading = document.getElementById('modalLoading');
                if (modalLoading) {
                    modalLoading.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ef4444; margin-bottom: 1rem;"></i>
                            <div style="color: #ef4444; margin-bottom: 1rem;">Erreur lors du chargement des catégories</div>
                            <button class="btn btn-primary" onclick="retryLoadCategories()">Réessayer</button>
                        </div>
                    `;
                }
            }
        }

        function retryLoadCategories() {
            setTimeout(() => {
                openAddGrandCaisseModal();
            }, 300);
        }
        
        function initializeCategoryAutocomplete() {
            const categoryInput = document.getElementById('grandCaisseCategorie');
            const dropdown = document.getElementById('categoriesDropdown');
            
            if (!categoryInput || !dropdown) return;
            
            categoryInput.addEventListener('focus', function() {
                showAllCategories();
            });
            
            categoryInput.addEventListener('input', function() {
                filterCategories(this);
            });
            
            categoryInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const activeItem = dropdown.querySelector('.category-item.active');
                    if (activeItem) {
                        selectCategory(activeItem);
                    } else if (dropdown.style.display === 'block' && banqueCategories.length > 0) {
                        const firstItem = dropdown.querySelector('.category-item');
                        if (firstItem) {
                            selectCategory(firstItem);
                        }
                    }
                } else if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    navigateDropdown(1);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    navigateDropdown(-1);
                } else if (event.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });
            
            document.addEventListener('click', function(event) {
                const isClickInside = categoryInput.contains(event.target) || dropdown.contains(event.target);
                if (!isClickInside) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function adjustDropdownPosition() {
            const dropdown = document.getElementById('categoriesDropdown');
            const input = document.getElementById('grandCaisseCategorie');
            
            if (!dropdown || !input) return;
            
            const inputRect = input.getBoundingClientRect();
            const modalContent = document.querySelector('.modal-content');
            const modalRect = modalContent.getBoundingClientRect();
            
            dropdown.style.position = 'absolute';
            dropdown.style.top = '100%';
            dropdown.style.left = '0';
            dropdown.style.width = '100%';
            dropdown.style.maxHeight = '200px';
            dropdown.style.overflowY = 'auto';
            dropdown.style.zIndex = '90000'; 
            dropdown.style.marginTop = '2px';
        }

        function showAllCategories() {
            const dropdown = document.getElementById('categoriesDropdown');
            const input = document.getElementById('grandCaisseCategorie');
            
            if (!dropdown || !input) return;
            
            if (!banqueCategories || banqueCategories.length === 0) {
                dropdown.innerHTML = '<div class="no-categories">Aucune catégorie disponible</div>';
                dropdown.style.display = 'block';
                adjustDropdownPosition();
                return;
            }
            
            let dropdownHTML = '';
            
            if (banqueCategories.length > 0 && typeof banqueCategories[0] === 'object') {
                banqueCategories.forEach((cat, index) => {
                    const label = cat.label || cat.value || '';
                    const value = cat.value || label;
                    dropdownHTML += `
                        <div class="category-item ${index === 0 ? 'active' : ''}" 
                             data-value="${value}" 
                             data-label="${label}"
                             onclick="selectCategory(this)">
                            ${label}
                        </div>
                    `;
                });
            } else {
                banqueCategories.forEach((cat, index) => {
                    dropdownHTML += `
                        <div class="category-item ${index === 0 ? 'active' : ''}" 
                             data-value="${cat}" 
                             data-label="${cat}"
                             onclick="selectCategory(this)">
                            ${cat}
                        </div>
                    `;
                });
            }
            
            dropdown.innerHTML = dropdownHTML;
            dropdown.style.display = 'block';
            adjustDropdownPosition();
        }

        function filterCategories(inputElement) {
            const searchTerm = inputElement.value.toLowerCase().trim();
            const dropdown = document.getElementById('categoriesDropdown');
            
            if (!dropdown) return;
            
            if (!searchTerm) {
                showAllCategories();
                return;
            }
            
            let filteredCategories = [];
            
            if (banqueCategories.length > 0 && typeof banqueCategories[0] === 'object') {
                filteredCategories = banqueCategories.filter(cat => {
                    const label = cat.label || '';
                    const value = cat.value || '';
                    return label.toLowerCase().includes(searchTerm) || 
                           value.toLowerCase().includes(searchTerm);
                });
            } else {
                filteredCategories = banqueCategories.filter(cat => {
                    return cat.toLowerCase().includes(searchTerm);
                });
            }
            
            displayCategories(filteredCategories);
        }

        function displayCategories(categories) {
            const dropdown = document.getElementById('categoriesDropdown');
            
            if (!dropdown) return;
            
            if (!categories || categories.length === 0) {
                dropdown.innerHTML = '<div class="no-categories">Aucune catégorie correspondante</div>';
                dropdown.style.display = 'block';
                adjustDropdownPosition();
                return;
            }
            
            let dropdownHTML = '';
            
            if (categories.length > 0 && typeof categories[0] === 'object') {
                categories.forEach((cat, index) => {
                    const label = cat.label || cat.value || '';
                    const value = cat.value || label;
                    dropdownHTML += `
                        <div class="category-item ${index === 0 ? 'active' : ''}" 
                             data-value="${value}" 
                             data-label="${label}"
                             onclick="selectCategory(this)">
                            ${label}
                        </div>
                    `;
                });
            } else {
                categories.forEach((cat, index) => {
                    dropdownHTML += `
                        <div class="category-item ${index === 0 ? 'active' : ''}" 
                             data-value="${cat}" 
                             data-label="${cat}"
                             onclick="selectCategory(this)">
                            ${cat}
                        </div>
                    `;
                });
            }
            
            dropdown.innerHTML = dropdownHTML;
            dropdown.style.display = 'block';
            adjustDropdownPosition();
        }

        function navigateDropdown(direction) {
            const dropdown = document.getElementById('categoriesDropdown');
            const items = dropdown.querySelectorAll('.category-item');
            
            if (items.length === 0) return;
            
            let activeIndex = -1;
            items.forEach((item, index) => {
                if (item.classList.contains('active')) {
                    activeIndex = index;
                    item.classList.remove('active');
                }
            });
            
            let newIndex = activeIndex + direction;
            
            if (newIndex < 0) newIndex = items.length - 1;
            if (newIndex >= items.length) newIndex = 0;
            
            items[newIndex].classList.add('active');
            items[newIndex].scrollIntoView({ block: 'nearest' });
        }

        function selectCategory(categoryElement) {
            const value = categoryElement.getAttribute('data-value');
            const label = categoryElement.getAttribute('data-label');
            
            const categoryInput = document.getElementById('grandCaisseCategorie');
            if (categoryInput) {
                categoryInput.value = label;
                categoryInput.setAttribute('data-selected-value', value);
            }
            
            const dropdown = document.getElementById('categoriesDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
            
            if (categoryInput) {
                categoryInput.focus();
            }
        }

        function submitGrandCaisse() {
            const date = document.getElementById('grandCaisseDate').value;
            const designation = document.getElementById('grandCaisseDesignation').value.trim();
            const montant = document.getElementById('grandCaisseMontant').value;
            const mouvement = document.getElementById('grandCaisseMouvement').value;
            const agence = document.getElementById('grandCaisseAgence').value.trim();
            const modePaiement = document.getElementById('grandCaisseModePaiement').value;
            const categorieInput = document.getElementById('grandCaisseCategorie');
            
            let categorie = categorieInput.getAttribute('data-selected-value') || categorieInput.value.trim();
            
            if (!date || !designation || !montant || !agence || !categorie) {
                showToast('⚠️ Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }
            
            const payload = {
                date: date,
                designation: designation,
                montant: parseFloat(montant),
                mouvement: mouvement,
                agence: agence,
                modePaiement: modePaiement,
                categorie: categorie
            };
            
            const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addGrandCaisse";
            
            const submitBtn = document.getElementById('submitGrandCaisseBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';
            submitBtn.disabled = true;
            
            const progressOverlay = document.createElement('div');
            progressOverlay.className = 'progress-overlay active';
            progressOverlay.innerHTML = `
                <div class="progress-modal">
                    <div class="progress-content">
                        <div class="progress-spinner">
                            <i class="fas fa-paper-plane fa-spin"></i>
                        </div>
                        <div class="progress-text">
                            <h4>Envoi en cours...</h4>
                            <p>Veuillez patienter pendant l'envoi des données</p>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressOverlay);
            
            const progressFill = progressOverlay.querySelector('.progress-fill');
            let width = 0;
            const progressInterval = setInterval(() => {
                if (width < 90) {
                    width += 10;
                    progressFill.style.width = width + '%';
                }
            }, 300);
            
            fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(payload)
            })
            .then(() => {
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    progressOverlay.innerHTML = `
                        <div class="progress-modal">
                            <div class="progress-content success">
                                <div class="progress-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="progress-text">
                                    <h4>Succès !</h4>
                                    <p>Données envoyées avec succès</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        progressOverlay.remove();
                        showToast('✅ Entrée ajoutée avec succès', 'success');
                        
                        setTimeout(() => {
                            loadGrandCaisseData();
                            closeModal();
                        }, 1000);
                    }, 1500);
                }, 500);
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Erreur lors de l\'ajout:', error);
                
                progressOverlay.innerHTML = `
                    <div class="progress-modal">
                        <div class="progress-content error">
                            <div class="progress-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="progress-text">
                                <h4>Erreur</h4>
                                <p>Échec de l'envoi des données</p>
                                <button class="btn btn-primary" onclick="retrySubmitGrandCaisse()">Réessayer</button>
                            </div>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    if (progressOverlay.parentNode) {
                        progressOverlay.remove();
                    }
                    showToast('❌ Erreur lors de l\'ajout', 'error');
                }, 3000);
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        function retrySubmitGrandCaisse() {
            const progressOverlay = document.querySelector('.progress-overlay');
            if (progressOverlay) {
                progressOverlay.remove();
            }
            submitGrandCaisse();
        }

        function showProgressOverlay(message = 'Traitement en cours...') {
            const overlay = document.createElement('div');
            overlay.className = 'progress-overlay active';
            overlay.innerHTML = `
                <div class="progress-modal">
                    <div class="progress-content">
                        <div class="progress-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div class="progress-text">
                            <h4>${message}</h4>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            overlay.id = 'global-progress-overlay';
            document.body.appendChild(overlay);
            
            const progressFill = overlay.querySelector('.progress-fill');
            let width = 0;
            const interval = setInterval(() => {
                if (width < 80) {
                    width += 5;
                    progressFill.style.width = width + '%';
                }
            }, 200);
            
            overlay.dataset.interval = interval;
        }

        function hideProgressOverlay() {
            const overlay = document.getElementById('global-progress-overlay');
            if (overlay) {
                clearInterval(overlay.dataset.interval);
                const progressFill = overlay.querySelector('.progress-fill');
                if (progressFill) {
                    progressFill.style.width = '100%';
                }
                
                setTimeout(() => {
                    overlay.remove();
                }, 500);
            }
        }

// ==================== SECTION FOURNISSEUR ====================
function loadFournisseurData() {
    showTableSkeleton('fournisseur');
    
    fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importfournisseur')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data?.rows) {
                allFournisseurData = data.data.rows.map(row => {
                    const montant = parseFloat(row[4]) || 0;
                    const qte = parseInt(row[5]) || 0;
                    const montantPaye = parseFloat(row[10]) || 0;
                    
                    return {
                        DateDebut: row[0] || '',
                        DateFin: row[1] || '',
                        Fournisseur: row[2] || '',
                        Designation: row[3] || '',
                        Montants: montant,
                        Qte: qte,
                        Periode: row[6] || '',
                        Statut: row[8] || '',
                        ResteAPaye: parseFloat(row[9]) || 0,
                        MontantPaye: montantPaye,
                        PrixUnitaireMoy: parseFloat(row[11]) || 0,
                        CAPeriode: parseFloat(row[13]) || 0,
                        PourcentageCA: parseFloat(row[14]) || 0,
                        Idfacture: row[15] || ''
                    };
                });
                
                // Extraire les listes uniques de fournisseurs et désignations
                extractFournisseurAndDesignationLists();
                
                // Appliquer le tri par défaut
                applySort('fournisseur');
                
                hideTableSkeleton('fournisseur');
                updateTableDisplay('fournisseur');
                
                // Appliquer les indicateurs de tri visuels
                updateSortIndicators('fournisseur', 'DateDebut', 'desc');
                
                showToast(`${allFournisseurData.length} factures fournisseurs chargées`, 'success');
            } else {
                throw new Error('Structure de données invalide');
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des factures fournisseurs:', error);
            hideTableSkeleton('fournisseur');
            document.getElementById('fournisseurData').innerHTML = `
                <tr>
                    <td colspan="11">
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Erreur de chargement</div>
                            <button class="btn btn-primary" onclick="loadFournisseurData()">Réessayer</button>
                        </div>
                    </td>
                </tr>
            `;
            showToast('Erreur lors du chargement des factures fournisseurs', 'error');
        });
}

// Extraire les listes uniques de fournisseurs et désignations
function extractFournisseurAndDesignationLists() {
    if (!allFournisseurData || allFournisseurData.length === 0) {
        window.fournisseurList = ['SIVO', 'Essilor', 'Canada Optic', 'Autre'];
        window.designationList = ['Facture de Monture', 'Facture de Verre', 'Facture Accessoire', 'Autre'];
        return;
    }
    
    // Extraire les fournisseurs uniques
    const fournisseursSet = new Set();
    allFournisseurData.forEach(item => {
        if (item.Fournisseur && item.Fournisseur.trim() !== '') {
            fournisseursSet.add(item.Fournisseur.trim());
        }
    });
    
    // Ajouter les valeurs par défaut si elles n'existent pas déjà
    ['SIVO', 'Essilor', 'Canada Optic', 'Autre'].forEach(item => {
        fournisseursSet.add(item);
    });
    
    window.fournisseurList = Array.from(fournisseursSet).sort();
    
    // Extraire les désignations uniques
    const designationsSet = new Set();
    allFournisseurData.forEach(item => {
        if (item.Designation && item.Designation.trim() !== '') {
            designationsSet.add(item.Designation.trim());
        }
    });
    
    // Ajouter les valeurs par défaut si elles n'existent pas déjà
    ['Facture de Monture', 'Facture de Verre', 'Facture Accessoire', 'Autre'].forEach(item => {
        designationsSet.add(item);
    });
    
    window.designationList = Array.from(designationsSet).sort();
}

function displayFournisseurData(data) {
    const tbody = document.getElementById('fournisseurData');
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="no-data">Aucune facture fournisseur trouvée</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach((facture, index) => {
        const statutClass = facture.Statut === 'Payé' ? 'status-success' : 'status-danger';
        const montantPayeClass = facture.MontantPaye > 0 ? 'text-success' : 'text-danger';
        const resteAPayeClass = facture.ResteAPaye > 0 ? 'text-danger' : 'text-success';
        
        // Formater les dates en format français
        const dateDebut = formatDateFR(facture.DateDebut);
        const dateFin = formatDateFR(facture.DateFin);
        
        html += `
            <tr style="animation-delay: ${index * 0.02}s">
                <td>${dateDebut}</td>
                <td>${dateFin}</td>
                <td><strong>${facture.Fournisseur || 'N/A'}</strong></td>
                <td title="${facture.Designation}">${facture.Designation ? (facture.Designation.substring(0, 30) + (facture.Designation.length > 30 ? '...' : '')) : 'N/A'}</td>
                <td class="${facture.Montants < 0 ? 'text-danger' : ''}">${formatNumber(facture.Montants)}</td>
                <td>${formatNumber(facture.Qte, 0)}</td>
                <td><span class="status-badge ${statutClass}">${facture.Statut || 'N/A'}</span></td>
                <td class="${montantPayeClass}">${facture.MontantPaye > 0 ? formatNumber(facture.MontantPaye) : '0,00'}</td>
                <td class="${resteAPayeClass}">${facture.ResteAPaye > 0 ? formatNumber(facture.ResteAPaye) : '0,00'}</td>
                <td>
                    <div class="action-btns">
                        <button class="action-btn btn-edit" onclick="editFournisseurFacture('${facture.Idfacture}')" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteFournisseurFacture('${facture.Idfacture}')" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Générer un ID facture unique
function generateIdFacture() {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    
    // Générer un nombre aléatoire à 2 chiffres
    const randomNum = Math.floor(Math.random() * 100).toString().padStart(2, '0');
    
    return `F${year}${month}${day}${hours}${minutes}${seconds}-${randomNum}`;
}

// Générer les options HTML pour les sélecteurs
function generateFournisseurOptions(selectedValue = '') {
    if (!window.fournisseurList || window.fournisseurList.length === 0) {
        return `
            <option value="">Sélectionner un fournisseur</option>
            <option value="SIVO">SIVO</option>
            <option value="Essilor">Essilor</option>
            <option value="Canada Optic">Canada Optic</option>
            <option value="Autre">Autre</option>
            <option value="__nouveau__" class="add-new-option">➕ Ajouter un nouveau fournisseur</option>
        `;
    }
    
    let html = '<option value="">Sélectionner un fournisseur</option>';
    window.fournisseurList.forEach(fournisseur => {
        const selected = fournisseur === selectedValue ? 'selected' : '';
        html += `<option value="${fournisseur}" ${selected}>${fournisseur}</option>`;
    });
    html += '<option value="__nouveau__" class="add-new-option">➕ Ajouter un nouveau fournisseur</option>';
    return html;
}

function generateDesignationOptions(selectedValue = '') {
    if (!window.designationList || window.designationList.length === 0) {
        return `
            <option value="">Sélectionner une désignation</option>
            <option value="Facture de Monture">Facture de Monture</option>
            <option value="Facture de Verre">Facture de Verre</option>
            <option value="Facture Accessoire">Facture Accessoire</option>
            <option value="Autre">Autre</option>
            <option value="__nouveau__" class="add-new-option">➕ Ajouter une nouvelle désignation</option>
        `;
    }
    
    let html = '<option value="">Sélectionner une désignation</option>';
    window.designationList.forEach(designation => {
        const selected = designation === selectedValue ? 'selected' : '';
        html += `<option value="${designation}" ${selected}>${designation}</option>`;
    });
    html += '<option value="__nouveau__" class="add-new-option">➕ Ajouter une nouvelle désignation</option>';
    return html;
}

// Gérer la sélection "Ajouter un nouveau" pour les fournisseurs
function handleFournisseurChange(selectElement, isEditModal = false) {
    if (selectElement.value === '__nouveau__') {
        // Créer une modale stylée pour l'ajout
        const modalId = isEditModal ? 'newFournisseurModalEdit' : 'newFournisseurModalAdd';
        const modalHTML = `
            <div class="modal-overlay active" id="${modalId}">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-plus-circle" style="color: #4CAF50; margin-right: 10px;"></i>
                            Nouveau Fournisseur
                        </h3>
                        <button class="modal-close" onclick="closeNewItemModal('${modalId}', 'fournisseur')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-truck" style="margin-right: 8px; color: #2196F3;"></i>
                                Nom du fournisseur
                            </label>
                            <input type="text" class="form-control" id="newFournisseurInput" 
                                   placeholder="Entrez le nom du nouveau fournisseur" 
                                   style="padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <div class="form-hint" style="margin-top: 8px; color: #666; font-size: 14px;">
                                <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                Ce fournisseur sera disponible pour toutes les factures
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 20px;">
                        <button class="btn btn-primary" onclick="addNewFournisseur('${isEditModal}')" 
                                style="padding: 12px 24px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check"></i>
                            Ajouter
                        </button>
                        <button class="btn" onclick="closeNewItemModal('${modalId}', 'fournisseur')" 
                                style="padding: 12px 24px; font-size: 16px;">
                            Annuler
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Ajouter la modale
        const modalContainer = document.getElementById('modal-container');
        modalContainer.insertAdjacentHTML('beforeend', modalHTML);
        
        // Focus sur l'input
        setTimeout(() => {
            const input = document.getElementById('newFournisseurInput');
            if (input) {
                input.focus();
                
                // Ajouter un événement pour la touche Entrée
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addNewFournisseur(isEditModal);
                    }
                });
            }
        }, 100);
    }
}

// Gérer la sélection "Ajouter une nouvelle" pour les désignations
function handleDesignationChange(selectElement, isEditModal = false) {
    if (selectElement.value === '__nouveau__') {
        // Créer une modale stylée pour l'ajout
        const modalId = isEditModal ? 'newDesignationModalEdit' : 'newDesignationModalAdd';
        const modalHTML = `
            <div class="modal-overlay active" id="${modalId}">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-plus-circle" style="color: #4CAF50; margin-right: 10px;"></i>
                            Nouvelle Désignation
                        </h3>
                        <button class="modal-close" onclick="closeNewItemModal('${modalId}', 'designation')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-invoice" style="margin-right: 8px; color: #9C27B0;"></i>
                                Nom de la désignation
                            </label>
                            <input type="text" class="form-control" id="newDesignationInput" 
                                   placeholder="Entrez la nouvelle désignation" 
                                   style="padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <div class="form-hint" style="margin-top: 8px; color: #666; font-size: 14px;">
                                <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                Cette désignation sera disponible pour toutes les factures
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 20px;">
                        <button class="btn btn-primary" onclick="addNewDesignation('${isEditModal}')" 
                                style="padding: 12px 24px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check"></i>
                            Ajouter
                        </button>
                        <button class="btn" onclick="closeNewItemModal('${modalId}', 'designation')" 
                                style="padding: 12px 24px; font-size: 16px;">
                            Annuler
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Ajouter la modale
        const modalContainer = document.getElementById('modal-container');
        modalContainer.insertAdjacentHTML('beforeend', modalHTML);
        
        // Focus sur l'input
        setTimeout(() => {
            const input = document.getElementById('newDesignationInput');
            if (input) {
                input.focus();
                
                // Ajouter un événement pour la touche Entrée
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addNewDesignation(isEditModal);
                    }
                });
            }
        }, 100);
    }
}

// Ajouter un nouveau fournisseur
function addNewFournisseur(isEditModal = false) {
    const input = document.getElementById('newFournisseurInput');
    const newValue = input ? input.value.trim() : '';
    
    if (!newValue) {
        showToast('⚠️ Veuillez entrer un nom de fournisseur', 'warning');
        input.focus();
        return;
    }
    
    // Vérifier si la valeur existe déjà
    if (window.fournisseurList && window.fournisseurList.includes(newValue)) {
        showToast('Ce fournisseur existe déjà', 'warning');
        input.focus();
        input.select();
        return;
    }
    
    // Ajouter à la liste globale
    if (!window.fournisseurList) window.fournisseurList = [];
    window.fournisseurList.push(newValue);
    window.fournisseurList.sort();
    
    // Mettre à jour le select
    const selectId = isEditModal ? 'editFournisseurFournisseur' : 'fournisseurFournisseur';
    const select = document.getElementById(selectId);
    if (select) {
        select.innerHTML = generateFournisseurOptions(newValue);
        select.value = newValue;
    }
    
    // Fermer la modale
    const modalId = isEditModal ? 'newFournisseurModalEdit' : 'newFournisseurModalAdd';
    closeNewItemModal(modalId, 'fournisseur');
    
    showToast(`✅ Fournisseur "${newValue}" ajouté avec succès`, 'success');
}

// Ajouter une nouvelle désignation
function addNewDesignation(isEditModal = false) {
    const input = document.getElementById('newDesignationInput');
    const newValue = input ? input.value.trim() : '';
    
    if (!newValue) {
        showToast('⚠️ Veuillez entrer une désignation', 'warning');
        input.focus();
        return;
    }
    
    // Vérifier si la valeur existe déjà
    if (window.designationList && window.designationList.includes(newValue)) {
        showToast('Cette désignation existe déjà', 'warning');
        input.focus();
        input.select();
        return;
    }
    
    // Ajouter à la liste globale
    if (!window.designationList) window.designationList = [];
    window.designationList.push(newValue);
    window.designationList.sort();
    
    // Mettre à jour le select
    const selectId = isEditModal ? 'editFournisseurDesignation' : 'fournisseurDesignation';
    const select = document.getElementById(selectId);
    if (select) {
        select.innerHTML = generateDesignationOptions(newValue);
        select.value = newValue;
    }
    
    // Fermer la modale
    const modalId = isEditModal ? 'newDesignationModalEdit' : 'newDesignationModalAdd';
    closeNewItemModal(modalId, 'designation');
    
    showToast(`✅ Désignation "${newValue}" ajoutée avec succès`, 'success');
}

// Fermer la modale d'ajout
function closeNewItemModal(modalId, type) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
    }
    
    // Réinitialiser la valeur du select
    if (type === 'fournisseur') {
        const selects = document.querySelectorAll('select[id$="Fournisseur"]');
        selects.forEach(select => {
            if (select.value === '__nouveau__') {
                select.value = '';
            }
        });
    } else if (type === 'designation') {
        const selects = document.querySelectorAll('select[id$="Designation"]');
        selects.forEach(select => {
            if (select.value === '__nouveau__') {
                select.value = '';
            }
        });
    }
}

// Ouvrir la modale pour ajouter une nouvelle facture
function openAddFournisseurModal() {
    const modalContainer = document.getElementById('modal-container');
    
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    const todayStr = today.toISOString().split('T')[0];
    const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];
    const lastDayStr = lastDayOfMonth.toISOString().split('T')[0];
    
    // Générer un ID facture unique
    const idFacture = generateIdFacture();
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 class="modal-title">Nouvelle Facture Fournisseur</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addFournisseurForm">
                        <div class="form-group">
                            <label class="form-label">ID Facture *</label>
                            <input type="text" class="form-control" id="fournisseurIdFacture" value="${idFacture}" readonly>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Date début *</label>
                                <input type="date" class="form-control" id="fournisseurDateDebut"  required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date fin *</label>
                                <input type="date" class="form-control" id="fournisseurDateFin"  required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Fournisseur *</label>
                            <select class="form-control" id="fournisseurFournisseur" required onchange="handleFournisseurChange(this, false)">
                                ${generateFournisseurOptions()}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Désignation *</label>
                            <select class="form-control" id="fournisseurDesignation" required onchange="handleDesignationChange(this, false)">
                                ${generateDesignationOptions()}
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Montant *</label>
                                <input type="number" step="0.01" class="form-control" id="fournisseurMontant" required placeholder="0,00" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantité *</label>
                                <input type="number" class="form-control" id="fournisseurQte" required placeholder="0" min="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Statut *</label>
                            <select class="form-control" id="fournisseurStatut" required>
                                <option value="Payé">Payé</option>
                                <option value="Non-Payé" selected>Non-Payé</option>
                                <option value="Partiellement Payé">Partiellement Payé</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Montant Payé</label>
                                <input type="number" step="0.01" class="form-control" id="fournisseurMontantPaye" placeholder="0,00" min="0" value="0">
                            </div>
                            <div class="form-group">
                            <div class="form-group">
                                <label class="form-label">Solde Prevu le*</label>
                                <input type="date" class="form-control" id="fournisseurSolde"  required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Note / Commentaire</label>
                            <textarea class="form-control" id="fournisseurNote" rows="3" placeholder="Ajouter une note ou un commentaire..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="submitNewFournisseur()" id="submitFournisseurBtn">Ajouter</button>
                    <button class="btn" onclick="closeModal()">Annuler</button>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modalHTML;
    
    // Ajouter le CSS pour styler l'option "Ajouter nouveau"
    addNewItemStyle();
}

// Ajouter le style pour l'option "Ajouter nouveau"
function addNewItemStyle() {
    if (!document.getElementById('newItemStyle')) {
        const style = document.createElement('style');
        style.id = 'newItemStyle';
        style.textContent = `
            .add-new-option {
                background-color: #f8f9fa !important;
                color: #28a745 !important;
                font-weight: 600 !important;
                border-top: 2px solid #dee2e6 !important;
                padding: 12px !important;
                margin-top: 5px !important;
            }
            
            .add-new-option:hover {
                background-color: #e8f5e9 !important;
                color: #1e7e34 !important;
            }
            
            .add-new-option::before {
                content: "➕ ";
                margin-right: 8px;
            }
            
            select option:not(.add-new-option) {
                padding: 8px 12px !important;
            }
            
            select option[value=""] {
                color: #6c757d !important;
                font-style: italic !important;
            }
            
            .modal-content .form-control {
                transition: all 0.3s ease;
            }
            
            .modal-content .form-control:focus {
                border-color: #4CAF50 !important;
                box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25) !important;
            }
            
            .form-hint {
                display: flex;
                align-items: center;
                padding: 8px 12px;
                background-color: #f8f9fa;
                border-radius: 6px;
                margin-top: 10px;
                border-left: 4px solid #4CAF50;
            }
        `;
        document.head.appendChild(style);
    }
}

// Soumettre une nouvelle facture fournisseur
function submitNewFournisseur() {
    // Récupération des valeurs
    const idFacture = document.getElementById('fournisseurIdFacture').value.trim();
    const dateDebut = document.getElementById('fournisseurDateDebut').value;
    const dateFin = document.getElementById('fournisseurDateFin').value;
    const fournisseur = document.getElementById('fournisseurFournisseur').value;
    const designation = document.getElementById('fournisseurDesignation').value;
    const montant = parseFloat(document.getElementById('fournisseurMontant').value) || 0;
    const qte = parseInt(document.getElementById('fournisseurQte').value) || 0;
    const statut = document.getElementById('fournisseurStatut').value;
    const montantPaye = parseFloat(document.getElementById('fournisseurMontantPaye').value) || 0;
    const datesolde = document.getElementById('fournisseurSolde').value;
    const note = document.getElementById('fournisseurNote').value.trim();
    
    // Validation
    if (!idFacture || !dateDebut || !dateFin || !fournisseur || !designation || montant <= 0 || qte <= 0 || !statut) {
        showToast('⚠️ Veuillez remplir tous les champs obligatoires correctement', 'warning');
        return;
    }
    
    if (fournisseur === '__nouveau__' || designation === '__nouveau__') {
        showToast('⚠️ Veuillez sélectionner ou ajouter un fournisseur et une désignation valides', 'warning');
        return;
    }
    
    // Construction du payload JSON
    const payload = {
        Idfacture: idFacture,
        DateDebut: dateDebut,
        DateFin: dateFin,
        Fournisseur: fournisseur,
        Designation: designation,
        Montants: montant,
        Qte: qte,
        Statut: statut,
        MontantPaye: montantPaye,
        DateSolde: datesolde,
        Note: note
    };
    
    console.log('Payload JSON:', payload); // Pour debug
    
    const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addfacturefournisseur";
    
    const submitBtn = document.getElementById('submitFournisseurBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout...';
    submitBtn.disabled = true;
    
    showProgressOverlay('Ajout de la facture...');
    
    // Envoi en JSON
    fetch(url, {
        method: 'POST',
        mode: 'no-cors', // <-- VOLONTAIRE
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(() => {
        hideProgressOverlay();
        showToast('✅ Facture ajoutée avec succès', 'success');
        
        setTimeout(() => {
            loadFournisseurData();
            closeModal();
        }, 1000);
    })
    .catch(error => {
        console.error('Fetch error:', error);
        hideProgressOverlay();
        showToast('❌ Erreur lors de l\'envoi', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Éditer une facture fournisseur
function editFournisseurFacture(idFacture) {
    const facture = allFournisseurData.find(item => item.Idfacture === idFacture);
    if (!facture) {
        showToast('Facture non trouvée', 'error');
        return;
    }
    
    const modalContainer = document.getElementById('modal-container');
    
    // Formater les dates pour l'input type="date"
    const dateDebut = facture.DateDebut ? new Date(facture.DateDebut).toISOString().split('T')[0] : '';
    const dateFin = facture.DateFin ? new Date(facture.DateFin).toISOString().split('T')[0] : '';
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 class="modal-title">Modifier Facture (${idFacture})</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editFournisseurForm">
                        <div class="form-group">
                            <label class="form-label">ID Facture</label>
                            <input type="text" class="form-control" value="${idFacture}" readonly>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Date début *</label>
                                <input type="date" class="form-control" id="editFournisseurDateDebut" value="${dateDebut}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date fin *</label>
                                <input type="date" class="form-control" id="editFournisseurDateFin" value="${dateFin}" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Fournisseur *</label>
                            <select class="form-control" id="editFournisseurFournisseur" required onchange="handleFournisseurChange(this, true)">
                                ${generateFournisseurOptions(facture.Fournisseur)}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Désignation *</label>
                            <select class="form-control" id="editFournisseurDesignation" required onchange="handleDesignationChange(this, true)">
                                ${generateDesignationOptions(facture.Designation)}
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Montant *</label>
                                <input type="number" step="0.01" class="form-control" id="editFournisseurMontant" value="${facture.Montants}" required min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantité *</label>
                                <input type="number" class="form-control" id="editFournisseurQte" value="${facture.Qte}" required min="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Statut *</label>
                            <select class="form-control" id="editFournisseurStatut" required>
                                <option value="Payé" ${facture.Statut === 'Payé' ? 'selected' : ''}>Payé</option>
                                <option value="Non-Payé" ${facture.Statut === 'Non-Payé' ? 'selected' : ''}>Non-Payé</option>
                                <option value="Partiellement Payé" ${facture.Statut === 'Partiellement Payé' ? 'selected' : ''}>Partiellement Payé</option>
                            </select>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Montant Payé</label>
                                <input type="number" step="0.01" class="form-control" id="editFournisseurMontantPaye" value="${facture.MontantPaye || 0}" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reste à payer</label>
                                <input type="number" step="0.01" class="form-control" id="editFournisseurResteAPaye" value="${facture.ResteAPaye || 0}" min="0" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Note / Commentaire</label>
                            <textarea class="form-control" id="editFournisseurNote" rows="3">${facture.Note || ''}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="submitFournisseurUpdate('${idFacture}')" id="updateFournisseurBtn">Enregistrer</button>
                    <button class="btn" onclick="closeModal()">Annuler</button>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modalHTML;
    
    // Ajouter le CSS pour styler l'option "Ajouter nouveau"
    addNewItemStyle();
    
    // Calculer automatiquement le reste à payer
    const montantInput = document.getElementById('editFournisseurMontant');
    const montantPayeInput = document.getElementById('editFournisseurMontantPaye');
    const resteAPayeInput = document.getElementById('editFournisseurResteAPaye');
    
    function updateResteAPaye() {
        const montant = parseFloat(montantInput.value) || 0;
        const montantPaye = parseFloat(montantPayeInput.value) || 0;
        const reste = montant - montantPaye;
        resteAPayeInput.value = reste.toFixed(2);
    }
    
    montantInput.addEventListener('input', updateResteAPaye);
    montantPayeInput.addEventListener('input', updateResteAPaye);
    
    // Initialiser le calcul
    updateResteAPaye();
}

// Soumettre la modification d'une facture
function submitFournisseurUpdate(idFacture) {
    const dateDebut = document.getElementById('editFournisseurDateDebut').value;
    const dateFin = document.getElementById('editFournisseurDateFin').value;
    const fournisseur = document.getElementById('editFournisseurFournisseur').value;
    const designation = document.getElementById('editFournisseurDesignation').value;
    const montant = parseFloat(document.getElementById('editFournisseurMontant').value) || 0;
    const qte = parseInt(document.getElementById('editFournisseurQte').value) || 0;
    const statut = document.getElementById('editFournisseurStatut').value;
    const montantPaye = parseFloat(document.getElementById('editFournisseurMontantPaye').value) || 0;
    const resteAPaye = parseFloat(document.getElementById('editFournisseurResteAPaye').value) || 0;
    const note = document.getElementById('editFournisseurNote').value.trim();
    
    // Validation
    if (!dateDebut || !dateFin || !fournisseur || !designation || montant <= 0 || qte <= 0 || !statut) {
        showToast('⚠️ Veuillez remplir tous les champs obligatoires correctement', 'warning');
        return;
    }
    
    if (fournisseur === '__nouveau__' || designation === '__nouveau__') {
        showToast('⚠️ Veuillez sélectionner ou ajouter un fournisseur et une désignation valides', 'warning');
        return;
    }
    
    // Construction du payload JSON
    const payload = {
        Idfacture: idFacture,
        DateDebut: dateDebut,
        DateFin: dateFin,
        Fournisseur: fournisseur,
        Designation: designation,
        Montants: montant,
        Qte: qte,
        Statut: statut,
        MontantPaye: montantPaye,
        ResteAPaye: resteAPaye,
        Note: note
    };
    
    console.log('Update payload:', payload);
    
    const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=editefacturefournisseur";
    
    const submitBtn = document.getElementById('updateFournisseurBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    submitBtn.disabled = true;
    
    showProgressOverlay('Mise à jour de la facture...');
    
    // Envoi en JSON
    fetch(url, {
        method: 'POST',
        mode: 'no-cors', // <-- VOLONTAIRE
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(() => {
        hideProgressOverlay();
        showToast('✅ Facture mise à jour avec succès', 'success');
        
        setTimeout(() => {
            loadFournisseurData();
            closeModal();
        }, 1000);
    })
    .catch(error => {
        console.error('Fetch error:', error);
        hideProgressOverlay();
        showToast('❌ Erreur lors de la mise à jour', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Supprimer une facture fournisseur
function deleteFournisseurFacture(idFacture) {
    if (!idFacture) {
        showToast('ID facture invalide', 'error');
        return;
    }
    
    if (!confirm(`Êtes-vous sûr de vouloir supprimer la facture "${idFacture}" ? Cette action est irréversible.`)) {
        return;
    }
    
    // Construction du payload JSON
    const payload = {
        Idfacture: idFacture
    };
    
    const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=deletefacturefournisseur";
    
    showProgressOverlay('Suppression de la facture...');
    
    // Envoi en JSON
    fetch(url, {
        method: 'POST',
        mode: 'no-cors', // <-- VOLONTAIRE
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(() => {
        hideProgressOverlay();
        showToast('✅ Facture supprimée avec succès', 'success');
        
        setTimeout(() => {
            closeModal();
        }, 1000);
    })
    .catch(error => {
        console.error('Fetch error:', error);
        hideProgressOverlay();
        showToast('❌ Erreur lors de la suppression', 'error');
    });
}

// ==================== SECTION PERSONNEL ====================

// Variables globales pour le personnel
let allPersonnelData = [];
let filteredPersonnelData = [];

// Initialiser les variables pour le personnel
currentPage.personnel = 1;
itemsPerPage.personnel = 10;
sortState.personnel = { column: 'Nom', direction: 'asc' };
searchTerm.personnel = '';

// Charger les données du personnel
function loadPersonnelData() {
    showTableSkeleton('personnel');
    
    fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importpersonnel')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data?.rows) {
                allPersonnelData = data.data.rows.map(row => {
                    // Mapper les données selon les headers
                    const employeeData = {};
                    data.data.headers.forEach((header, index) => {
                        employeeData[header] = row[index] || '';
                    });
                    
                    // Calculer le solde de congés selon le système béninois (2.5 jours par mois)
                    const dateEmbauche = employeeData.DateEmbauche ? new Date(employeeData.DateEmbauche) : null;
                    let soldeConges = parseFloat(employeeData.SoldeConges) || 0;
                    
                    // Si le solde n'est pas défini, le calculer
                    if (soldeConges === 0 && dateEmbauche) {
                        const aujourdHui = new Date();
                        const moisEcoules = Math.floor((aujourdHui - dateEmbauche) / (30.44 * 24 * 60 * 60 * 1000));
                        soldeConges = Math.max(0, moisEcoules * 2.5);
                        employeeData.SoldeConges = soldeConges;
                    }
                    
                    // Convertir les nombres
                    employeeData.SalaireBase = parseFloat(employeeData.SalaireBase) || 0;
                    employeeData.PrimePerformance = parseFloat(employeeData.PrimePerformance) || 0;
                    employeeData.PrimeAssiduite = parseFloat(employeeData.PrimeAssiduite) || 0;
                    employeeData.PrimeResponsabilite = parseFloat(employeeData.PrimeResponsabilite) || 0;
                    employeeData.CongesAnnuels = parseFloat(employeeData.CongesAnnuels) || 0;
                    employeeData.CongesMaladie = parseFloat(employeeData.CongesMaladie) || 0;
                    employeeData.CongesMaternite = parseFloat(employeeData.CongesMaternite) || 0;
                    employeeData.CongesPaternite = parseFloat(employeeData.CongesPaternite) || 0;
                    employeeData.Permissions = parseFloat(employeeData.Permissions) || 0;
                    employeeData.HeuresSupplementaires = parseFloat(employeeData.HeuresSupplementaires) || 0;
                    employeeData.Avances = parseFloat(employeeData.Avances) || 0;
                    employeeData.Retenues = parseFloat(employeeData.Retenues) || 0;
                    
                    return employeeData;
                });
                
                // Extraire les départements uniques pour le filtre
                extractDepartments();
                
                // Appliquer le tri par défaut
                applySort('personnel');
                
                hideTableSkeleton('personnel');
                updateTableDisplay('personnel');
                
                // Appliquer les indicateurs de tri visuels
                updateSortIndicators('personnel', 'Nom', 'asc');
                
                showToast(`${allPersonnelData.length} employés chargés`, 'success');
            } else {
                throw new Error('Structure de données invalide');
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement du personnel:', error);
            hideTableSkeleton('personnel');
            document.getElementById('personnelData').innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Erreur de chargement</div>
                            <button class="btn btn-primary" onclick="loadPersonnelData()">Réessayer</button>
                        </div>
                    </td>
                </tr>
            `;
            showToast('Erreur lors du chargement du personnel', 'error');
        });
}

// Extraire les départements uniques
function extractDepartments() {
    const departments = new Set();
    allPersonnelData.forEach(employe => {
        if (employe.Departement && employe.Departement.trim() !== '') {
            departments.add(employe.Departement.trim());
        }
    });
    
    const departmentFilter = document.getElementById('personnel-department-filter');
    if (departmentFilter) {
        departmentFilter.innerHTML = '<option value="">Tous les départements</option>';
        Array.from(departments).sort().forEach(dept => {
            departmentFilter.innerHTML += `<option value="${dept}">${dept}</option>`;
        });
    }
}


// Recherche dans le personnel
function searchPersonnel() {
    const searchInput = document.getElementById('personnel-search');
    searchTerm.personnel = searchInput.value.toLowerCase().trim();
    applySearch('personnel');
}

// Filtre par département
function filterByDepartment() {
    applySearch('personnel');
}

// Filtre par type de contrat
function filterByContractType() {
    applySearch('personnel');
}

// Appliquer la recherche pour le personnel
function applySearch(tableType) {
    if (tableType !== 'personnel') return;
    
    const search = searchTerm[tableType];
    const department = document.getElementById('personnel-department-filter')?.value || '';
    const contractType = document.getElementById('personnel-contract-filter')?.value || '';
    
    let filteredData = allPersonnelData;
    
    // Appliquer les filtres
    if (department) {
        filteredData = filteredData.filter(item => item.Departement === department);
    }
    
    if (contractType) {
        filteredData = filteredData.filter(item => item.TypeContrat === contractType);
    }
    
    if (search) {
        filteredData = filteredData.filter(item => {
            return (
                (item.Nom && item.Nom.toLowerCase().includes(search)) ||
                (item.Prenom && item.Prenom.toLowerCase().includes(search)) ||
                (item.Poste && item.Poste.toLowerCase().includes(search)) ||
                (item.Departement && item.Departement.toLowerCase().includes(search)) ||
                (item.TypeContrat && item.TypeContrat.toLowerCase().includes(search)) ||
                (item.Email && item.Email.toLowerCase().includes(search)) ||
                (item.Telephone && item.Telephone.includes(search))
            );
        });
    }
    
    filteredPersonnelData = filteredData;
    
    // Réappliquer le tri
    applySort('personnel');
    
    // Revenir à la première page
    currentPage[tableType] = 1;
    
    // Mettre à jour l'affichage
    updateTableDisplay(tableType);
}

// Afficher les données du personnel
function displayPersonnelData(data) {
    const tbody = document.getElementById('personnelData');
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="no-data">Aucun employé trouvé</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach((employe, index) => {
        const nomComplet = `${employe.Nom || ''} ${employe.Prenom || ''}`.trim();
        const dateEmbauche = formatDateFR(employe.DateEmbauche);
        const statutClass = employe.Statut === 'Actif' ? 'status-success' : 
                           employe.Statut === 'Inactif' ? 'status-danger' : 'status-warning';
        const soldeConges = parseFloat(employe.SoldeConges) || 0;
        const soldeCongesClass = soldeConges < 0 ? 'solde-negatif' : '';
        
        html += `
            <tr style="animation-delay: ${index * 0.02}s">
                <td><strong>${employe.Nom || 'N/A'}</strong></td>
                <td>${employe.Prenom || 'N/A'}</td>
                <td>${employe.Poste || 'N/A'}</td>
                <td>${employe.Departement || 'N/A'}</td>
                <td>${dateEmbauche}</td>
                <td><span class="status-badge ${employe.TypeContrat === 'CDI' ? 'status-success' : 'status-warning'}">${employe.TypeContrat || 'N/A'}</span></td>
                <td class="${soldeCongesClass}">${soldeConges.toFixed(1)} jours</td>
                <td><span class="status-badge ${statutClass}">${employe.Statut || 'N/A'}</span></td>
                <td>
                    <div class="action-btns">
                        <button class="action-btn btn-edit" onclick="viewPersonnelDetails('${employe.IdEmploye}')" title="Voir détails">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-edit" onclick="editPersonnel('${employe.IdEmploye}')" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deletePersonnel('${employe.IdEmploye}')" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Ouvrir la modale pour ajouter un nouveau collaborateur
function openAddPersonnelModal() {
    const modalContainer = document.getElementById('modal-container');
    const today = new Date().toISOString().split('T')[0];
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                <div class="modal-header">
                    <h3 class="modal-title">Nouveau Collaborateur</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <form id="addPersonnelForm">
                        <h4 style="color: var(--primary-600); margin-bottom: 1.5rem; border-bottom: 2px solid var(--primary-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-id-card"></i> Informations Administratives
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Nom *</label>
                                <input type="text" class="form-control" id="personnelNom" required autofocus>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prénom(s) *</label>
                                <input type="text" class="form-control" id="personnelPrenom" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Date de naissance *</label>
                                <input type="date" class="form-control" id="personnelDateNaissance" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lieu de naissance *</label>
                                <input type="text" class="form-control" id="personnelLieuNaissance" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Téléphone *</label>
                                <input type="tel" class="form-control" id="personnelTelephone" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="personnelEmail">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Adresse *</label>
                            <textarea class="form-control" id="personnelAdresse" rows="2" required></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Poste / Fonction *</label>
                                <input type="text" class="form-control" id="personnelPoste" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Département *</label>
                                <input type="text" class="form-control" id="personnelDepartement" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Date d'embauche *</label>
                                <input type="date" class="form-control" id="personnelDateEmbauche" value="${today}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Type de contrat *</label>
                                <select class="form-control" id="personnelTypeContrat" required>
                                    <option value="CDI">CDI</option>
                                    <option value="CDD">CDD</option>
                                    <option value="Journalier">Journalier</option>
                                    <option value="Stagiaire">Stagiaire</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Durée du contrat</label>
                                <input type="text" class="form-control" id="personnelDureeContrat" placeholder="Ex: 6 mois, 1 an...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Catégorie salariale</label>
                                <input type="text" class="form-control" id="personnelCategorieSalariale">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Numéro CNSS</label>
                                <input type="text" class="form-control" id="personnelNumeroCNSS">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Assurance (si applicable)</label>
                                <input type="text" class="form-control" id="personnelAssurance">
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-600); margin: 2rem 0 1.5rem 0; border-bottom: 2px solid var(--primary-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-phone-alt"></i> Contact d'urgence
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Personne à contacter *</label>
                                <input type="text" class="form-control" id="personnelContactUrgence" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Téléphone d'urgence *</label>
                                <input type="tel" class="form-control" id="personnelTelephoneUrgence" required>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-600); margin: 2rem 0 1.5rem 0; border-bottom: 2px solid var(--primary-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-money-bill-wave"></i> Informations de Paie
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Salaire de base *</label>
                                <input type="number" step="0.01" class="form-control" id="personnelSalaireBase" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prime performance</label>
                                <input type="number" step="0.01" class="form-control" id="personnelPrimePerformance" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prime assiduité</label>
                                <input type="number" step="0.01" class="form-control" id="personnelPrimeAssiduite" value="0">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Prime responsabilité</label>
                                <input type="number" step="0.01" class="form-control" id="personnelPrimeResponsabilite" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Statut *</label>
                                <select class="form-control" id="personnelStatut" required>
                                    <option value="Actif" selected>Actif</option>
                                    <option value="Inactif">Inactif</option>
                                    <option value="Suspendu">Suspendu</option>
                                    <option value="En congé">En congé</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="submitNewPersonnel()" id="submitPersonnelBtn">Ajouter</button>
                    <button class="btn" onclick="closeModal()">Annuler</button>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modalHTML;
}

// Soumettre un nouveau collaborateur
function submitNewPersonnel() {
    // Récupération des valeurs
    const nom = document.getElementById('personnelNom').value.trim();
    const prenom = document.getElementById('personnelPrenom').value.trim();
    const dateNaissance = document.getElementById('personnelDateNaissance').value;
    const lieuNaissance = document.getElementById('personnelLieuNaissance').value.trim();
    const telephone = document.getElementById('personnelTelephone').value.trim();
    const email = document.getElementById('personnelEmail').value.trim();
    const adresse = document.getElementById('personnelAdresse').value.trim();
    const poste = document.getElementById('personnelPoste').value.trim();
    const departement = document.getElementById('personnelDepartement').value.trim();
    const dateEmbauche = document.getElementById('personnelDateEmbauche').value;
    const typeContrat = document.getElementById('personnelTypeContrat').value;
    const dureeContrat = document.getElementById('personnelDureeContrat').value.trim();
    const categorieSalariale = document.getElementById('personnelCategorieSalariale').value.trim();
    const numeroCNSS = document.getElementById('personnelNumeroCNSS').value.trim();
    const assurance = document.getElementById('personnelAssurance').value.trim();
    const contactUrgence = document.getElementById('personnelContactUrgence').value.trim();
    const telephoneUrgence = document.getElementById('personnelTelephoneUrgence').value.trim();
    const salaireBase = parseFloat(document.getElementById('personnelSalaireBase').value) || 0;
    const primePerformance = parseFloat(document.getElementById('personnelPrimePerformance').value) || 0;
    const primeAssiduite = parseFloat(document.getElementById('personnelPrimeAssiduite').value) || 0;
    const primeResponsabilite = parseFloat(document.getElementById('personnelPrimeResponsabilite').value) || 0;
    const statut = document.getElementById('personnelStatut').value;
    
    // Validation des champs obligatoires
    if (!nom || !prenom || !dateNaissance || !lieuNaissance || 
        !telephone || !adresse || !poste || !departement || !dateEmbauche || !typeContrat || 
        !contactUrgence || !telephoneUrgence || salaireBase <= 0) {
        showToast('⚠️ Veuillez remplir tous les champs obligatoires', 'warning');
        return;
    }
    
    // Construction du payload
    const payload = {
        IdEmploye: generateEmployeeId(),
        DateEmbauche: dateEmbauche,
        Nom: nom,
        Prenom: prenom,
        DateNaissance: dateNaissance,
        LieuNaissance: lieuNaissance,
        Telephone: telephone,
        Email: email,
        Adresse: adresse,
        Poste: poste,
        Departement: departement,
        TypeContrat: typeContrat,
        DureeContrat: dureeContrat,
        CategorieSalariale: categorieSalariale,
        NumeroCNSS: numeroCNSS,
        Assurance: assurance,
        ContactUrgence: contactUrgence,
        TelephoneUrgence: telephoneUrgence,
        SalaireBase: salaireBase,
        PrimePerformance: primePerformance,
        PrimeAssiduite: primeAssiduite,
        PrimeResponsabilite: primeResponsabilite,
        CongesAnnuels: 0,
        CongesMaladie: 0,
        CongesMaternite: 0,
        CongesPaternite: 0,
        Permissions: 0,
        HeuresSupplementaires: 0,
        Avances: 0,
        Retenues: 0,
        Statut: statut
    };
    
    const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addpersonnel";
    
    const submitBtn = document.getElementById('submitPersonnelBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout...';
    submitBtn.disabled = true;
    
    showProgressOverlay('Ajout du collaborateur...');
    
    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(() => {
        hideProgressOverlay();
        showToast('✅ Collaborateur ajouté avec succès', 'success');
        
        setTimeout(() => {
            loadPersonnelData();
            closeModal();
        }, 1000);
    })
    .catch(error => {
        console.error('Erreur lors de l\'ajout:', error);
        hideProgressOverlay();
        showToast('❌ Erreur lors de l\'ajout du collaborateur', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Générer un ID employé unique
function generateEmployeeId() {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `EMP${year}${month}${day}${randomNum}`;
}

// Voir les détails d'un employé
function viewPersonnelDetails(idEmploye) {
    const employe = allPersonnelData.find(item => item.IdEmploye === idEmploye);
    if (!employe) {
        showToast('Employé non trouvé', 'error');
        return;
    }
    
    const modalContainer = document.getElementById('modal-container');
    
    // Calcul des totaux
    const totalPrimes = (parseFloat(employe.PrimePerformance) || 0) + 
                       (parseFloat(employe.PrimeAssiduite) || 0) + 
                       (parseFloat(employe.PrimeResponsabilite) || 0);
    const salaireTotal = (parseFloat(employe.SalaireBase) || 0) + totalPrimes;
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                <div class="modal-header">
                    <h3 class="modal-title">Fiche Employé: ${employe.Nom} ${employe.Prenom}</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div style="background: linear-gradient(135deg, var(--primary-50), white); border-radius: var(--border-radius-md); padding: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">
                                ${(employe.Nom?.charAt(0) || '') + (employe.Prenom?.charAt(0) || '')}
                            </div>
                            <div>
                                <h4 style="margin: 0; color: var(--primary-700);">${employe.Nom} ${employe.Prenom}</h4>
                                <p style="margin: 0.25rem 0 0 0; color: var(--gray-600);">${employe.Poste} • ${employe.Departement}</p>
                                <span class="status-badge ${employe.Statut === 'Actif' ? 'status-success' : 'status-danger'}" style="margin-top: 0.5rem;">
                                    ${employe.Statut}
                                </span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">ID Employé</div>
                                <div style="font-weight: 600;">${employe.IdEmploye}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Type de contrat</div>
                                <div style="font-weight: 600;">${employe.TypeContrat} ${employe.DureeContrat ? `(${employe.DureeContrat})` : ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-600); margin-bottom: 1rem; border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-info-circle"></i> Informations Personnelles
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Date de naissance</div>
                                <div>${formatDateFR(employe.DateNaissance)} à ${employe.LieuNaissance}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Date d'embauche</div>
                                <div>${formatDateFR(employe.DateEmbauche)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Téléphone</div>
                                <div>${employe.Telephone}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Email</div>
                                <div>${employe.Email || 'Non renseigné'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.875rem; color: var(--gray-500);">Adresse</div>
                            <div>${employe.Adresse}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-600); margin-bottom: 1rem; border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-id-card-alt"></i> Informations Administratives
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Numéro CNSS</div>
                                <div>${employe.NumeroCNSS || 'Non renseigné'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Assurance</div>
                                <div>${employe.Assurance || 'Non renseigné'}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Catégorie salariale</div>
                                <div>${employe.CategorieSalariale || 'Non renseigné'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-600); margin-bottom: 1rem; border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-phone-alt"></i> Contact d'urgence
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Personne à contacter</div>
                                <div>${employe.ContactUrgence}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">Téléphone d'urgence</div>
                                <div>${employe.TelephoneUrgence}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-600); margin-bottom: 1rem; border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-calendar-alt"></i> Gestion des Congés
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius-md);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-600);">${parseFloat(employe.SoldeConges || 0).toFixed(1)}</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600);">Solde congés</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius-md);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning-600);">${parseFloat(employe.CongesMaladie || 0)}</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600);">Congés maladie</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius-md);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-600);">${parseFloat(employe.Permissions || 0)}</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600);">Permissions</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-600); margin-bottom: 1rem; border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-money-bill-wave"></i> Informations de Paie
                        </h4>
                        <div style="background: var(--gray-50); border-radius: var(--border-radius-md); padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500);">Salaire de base</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--gray-800);">${formatCurrency(employe.SalaireBase)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-500);">Total primes</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--success-600);">${formatCurrency(totalPrimes)}</div>
                                </div>
                            </div>
                            <div style="border-top: 2px solid var(--primary-200); padding-top: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 1rem; color: var(--gray-700); font-weight: 600;">Salaire total</div>
                                    <div style="font-size: 1.5rem; font-weight: 800; color: var(--primary-600);">${formatCurrency(salaireTotal)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="editPersonnel('${idEmploye}')">Modifier</button>
                    <button class="btn" onclick="closeModal()">Fermer</button>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modalHTML;
}

// Éditer un employé
function editPersonnel(idEmploye) {
    const employe = allPersonnelData.find(item => item.IdEmploye === idEmploye);
    if (!employe) {
        showToast('Employé non trouvé', 'error');
        return;
    }
    
    const modalContainer = document.getElementById('modal-container');
    const dateEmbauche = employe.DateEmbauche ? new Date(employe.DateEmbauche).toISOString().split('T')[0] : '';
    const dateNaissance = employe.DateNaissance ? new Date(employe.DateNaissance).toISOString().split('T')[0] : '';
    
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                <div class="modal-header">
                    <h3 class="modal-title">Modifier Collaborateur: ${employe.Nom} ${employe.Prenom}</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <form id="editPersonnelForm">
                        <input type="hidden" id="editPersonnelId" value="${idEmploye}">
                        
                        <h4 style="color: var(--primary-600); margin-bottom: 1.5rem; border-bottom: 2px solid var(--primary-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-id-card"></i> Informations Administratives
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Nom *</label>
                                <input type="text" class="form-control" id="editPersonnelNom" value="${employe.Nom || ''}" required autofocus>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prénom(s) *</label>
                                <input type="text" class="form-control" id="editPersonnelPrenom" value="${employe.Prenom || ''}" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Date de naissance *</label>
                                <input type="date" class="form-control" id="editPersonnelDateNaissance" value="${dateNaissance}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lieu de naissance *</label>
                                <input type="text" class="form-control" id="editPersonnelLieuNaissance" value="${employe.LieuNaissance || ''}" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Téléphone *</label>
                                <input type="tel" class="form-control" id="editPersonnelTelephone" value="${employe.Telephone || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="editPersonnelEmail" value="${employe.Email || ''}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Adresse *</label>
                            <textarea class="form-control" id="editPersonnelAdresse" rows="2" required>${employe.Adresse || ''}</textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Poste / Fonction *</label>
                                <input type="text" class="form-control" id="editPersonnelPoste" value="${employe.Poste || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Département *</label>
                                <input type="text" class="form-control" id="editPersonnelDepartement" value="${employe.Departement || ''}" required>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Date d'embauche *</label>
                                <input type="date" class="form-control" id="editPersonnelDateEmbauche" value="${dateEmbauche}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Type de contrat *</label>
                                <select class="form-control" id="editPersonnelTypeContrat" required>
                                    <option value="CDI" ${employe.TypeContrat === 'CDI' ? 'selected' : ''}>CDI</option>
                                    <option value="CDD" ${employe.TypeContrat === 'CDD' ? 'selected' : ''}>CDD</option>
                                    <option value="Journalier" ${employe.TypeContrat === 'Journalier' ? 'selected' : ''}>Journalier</option>
                                    <option value="Stagiaire" ${employe.TypeContrat === 'Stagiaire' ? 'selected' : ''}>Stagiaire</option>
                                    <option value="Autre" ${employe.TypeContrat === 'Autre' || (!['CDI','CDD','Journalier','Stagiaire'].includes(employe.TypeContrat)) ? 'selected' : ''}>Autre</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Durée du contrat</label>
                                <input type="text" class="form-control" id="editPersonnelDureeContrat" value="${employe.DureeContrat || ''}" placeholder="Ex: 6 mois, 1 an...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Catégorie salariale</label>
                                <input type="text" class="form-control" id="editPersonnelCategorieSalariale" value="${employe.CategorieSalariale || ''}">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Numéro CNSS</label>
                                <input type="text" class="form-control" id="editPersonnelNumeroCNSS" value="${employe.NumeroCNSS || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Assurance</label>
                                <input type="text" class="form-control" id="editPersonnelAssurance" value="${employe.Assurance || ''}">
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-600); margin: 2rem 0 1.5rem 0; border-bottom: 2px solid var(--primary-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-phone-alt"></i> Contact d'urgence
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Personne à contacter *</label>
                                <input type="text" class="form-control" id="editPersonnelContactUrgence" value="${employe.ContactUrgence || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Téléphone d'urgence *</label>
                                <input type="tel" class="form-control" id="editPersonnelTelephoneUrgence" value="${employe.TelephoneUrgence || ''}" required>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-600); margin: 2rem 0 1.5rem 0; border-bottom: 2px solid var(--primary-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-calendar-alt"></i> Gestion des Congés
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Congés annuels</label>
                                <input type="number" step="0.1" class="form-control" id="editPersonnelCongesAnnuels" value="${parseFloat(employe.CongesAnnuels) || 0}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Congés maladie</label>
                                <input type="number" step="0.1" class="form-control" id="editPersonnelCongesMaladie" value="${parseFloat(employe.CongesMaladie) || 0}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Permissions</label>
                                <input type="number" step="0.1" class="form-control" id="editPersonnelPermissions" value="${parseFloat(employe.Permissions) || 0}">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Congés maternité</label>
                                <input type="number" step="0.1" class="form-control" id="editPersonnelCongesMaternite" value="${parseFloat(employe.CongesMaternite) || 0}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Congés paternité</label>
                                <input type="number" step="0.1" class="form-control" id="editPersonnelCongesPaternite" value="${parseFloat(employe.CongesPaternite) || 0}">
                            </div>
                        </div>
                        
                        <h4 style="color: var(--primary-600); margin: 2rem 0 1.5rem 0; border-bottom: 2px solid var(--primary-200); padding-bottom: 0.5rem;">
                            <i class="fas fa-money-bill-wave"></i> Informations de Paie
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Salaire de base *</label>
                                <input type="number" step="0.01" class="form-control" id="editPersonnelSalaireBase" value="${parseFloat(employe.SalaireBase) || 0}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prime performance</label>
                                <input type="number" step="0.01" class="form-control" id="editPersonnelPrimePerformance" value="${parseFloat(employe.PrimePerformance) || 0}">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Prime assiduité</label>
                                <input type="number" step="0.01" class="form-control" id="editPersonnelPrimeAssiduite" value="${parseFloat(employe.PrimeAssiduite) || 0}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prime responsabilité</label>
                                <input type="number" step="0.01" class="form-control" id="editPersonnelPrimeResponsabilite" value="${parseFloat(employe.PrimeResponsabilite) || 0}">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Heures supplémentaires</label>
                                <input type="number" step="0.1" class="form-control" id="editPersonnelHeuresSupplementaires" value="${parseFloat(employe.HeuresSupplementaires) || 0}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Avances</label>
                                <input type="number" step="0.01" class="form-control" id="editPersonnelAvances" value="${parseFloat(employe.Avances) || 0}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Retenues</label>
                            <input type="number" step="0.01" class="form-control" id="editPersonnelRetenues" value="${parseFloat(employe.Retenues) || 0}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Statut *</label>
                            <select class="form-control" id="editPersonnelStatut" required>
                                <option value="Actif" ${employe.Statut === 'Actif' ? 'selected' : ''}>Actif</option>
                                <option value="Inactif" ${employe.Statut === 'Inactif' ? 'selected' : ''}>Inactif</option>
                                <option value="Suspendu" ${employe.Statut === 'Suspendu' ? 'selected' : ''}>Suspendu</option>
                                <option value="En congé" ${employe.Statut === 'En congé' ? 'selected' : ''}>En congé</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="submitPersonnelUpdate('${idEmploye}')" id="updatePersonnelBtn">Enregistrer</button>
                    <button class="btn" onclick="closeModal()">Annuler</button>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modalHTML;
}

// Soumettre la mise à jour d'un employé
function submitPersonnelUpdate(idEmploye) {
    // Récupération des valeurs
    const nom = document.getElementById('editPersonnelNom').value.trim();
    const prenom = document.getElementById('editPersonnelPrenom').value.trim();
    const dateNaissance = document.getElementById('editPersonnelDateNaissance').value;
    const lieuNaissance = document.getElementById('editPersonnelLieuNaissance').value.trim();
    const telephone = document.getElementById('editPersonnelTelephone').value.trim();
    const email = document.getElementById('editPersonnelEmail').value.trim();
    const adresse = document.getElementById('editPersonnelAdresse').value.trim();
    const poste = document.getElementById('editPersonnelPoste').value.trim();
    const departement = document.getElementById('editPersonnelDepartement').value.trim();
    const dateEmbauche = document.getElementById('editPersonnelDateEmbauche').value;
    const typeContrat = document.getElementById('editPersonnelTypeContrat').value;
    const dureeContrat = document.getElementById('editPersonnelDureeContrat').value.trim();
    const categorieSalariale = document.getElementById('editPersonnelCategorieSalariale').value.trim();
    const numeroCNSS = document.getElementById('editPersonnelNumeroCNSS').value.trim();
    const assurance = document.getElementById('editPersonnelAssurance').value.trim();
    const contactUrgence = document.getElementById('editPersonnelContactUrgence').value.trim();
    const telephoneUrgence = document.getElementById('editPersonnelTelephoneUrgence').value.trim();
    const salaireBase = parseFloat(document.getElementById('editPersonnelSalaireBase').value) || 0;
    const primePerformance = parseFloat(document.getElementById('editPersonnelPrimePerformance').value) || 0;
    const primeAssiduite = parseFloat(document.getElementById('editPersonnelPrimeAssiduite').value) || 0;
    const primeResponsabilite = parseFloat(document.getElementById('editPersonnelPrimeResponsabilite').value) || 0;
    const congesAnnuels = parseFloat(document.getElementById('editPersonnelCongesAnnuels').value) || 0;
    const congesMaladie = parseFloat(document.getElementById('editPersonnelCongesMaladie').value) || 0;
    const congesMaternite = parseFloat(document.getElementById('editPersonnelCongesMaternite').value) || 0;
    const congesPaternite = parseFloat(document.getElementById('editPersonnelCongesPaternite').value) || 0;
    const permissions = parseFloat(document.getElementById('editPersonnelPermissions').value) || 0;
    const heuresSupplementaires = parseFloat(document.getElementById('editPersonnelHeuresSupplementaires').value) || 0;
    const avances = parseFloat(document.getElementById('editPersonnelAvances').value) || 0;
    const retenues = parseFloat(document.getElementById('editPersonnelRetenues').value) || 0;
    const statut = document.getElementById('editPersonnelStatut').value;
    
    // Validation
    if (!nom || !prenom || !dateNaissance || !lieuNaissance || !telephone || 
        !adresse || !poste || !departement || !dateEmbauche || !typeContrat || 
        !contactUrgence || !telephoneUrgence || salaireBase <= 0) {
        showToast('⚠️ Veuillez remplir tous les champs obligatoires', 'warning');
        return;
    }
    
    const payload = {
        IdEmploye: idEmploye,
        Nom: nom,
        Prenom: prenom,
        DateNaissance: dateNaissance,
        LieuNaissance: lieuNaissance,
        Telephone: telephone,
        Email: email,
        Adresse: adresse,
        Poste: poste,
        Departement: departement,
        DateEmbauche: dateEmbauche,
        TypeContrat: typeContrat,
        DureeContrat: dureeContrat,
        CategorieSalariale: categorieSalariale,
        NumeroCNSS: numeroCNSS,
        Assurance: assurance,
        ContactUrgence: contactUrgence,
        TelephoneUrgence: telephoneUrgence,
        SalaireBase: salaireBase,
        PrimePerformance: primePerformance,
        PrimeAssiduite: primeAssiduite,
        PrimeResponsabilite: primeResponsabilite,
        CongesAnnuels: congesAnnuels,
        CongesMaladie: congesMaladie,
        CongesMaternite: congesMaternite,
        CongesPaternite: congesPaternite,
        Permissions: permissions,
        HeuresSupplementaires: heuresSupplementaires,
        Avances: avances,
        Retenues: retenues,
        Statut: statut
    };
    
    const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=updatepersonnel";
    
    const submitBtn = document.getElementById('updatePersonnelBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    submitBtn.disabled = true;
    
    showProgressOverlay('Mise à jour du collaborateur...');
    
    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(() => {
        hideProgressOverlay();
        showToast('✅ Collaborateur mis à jour avec succès', 'success');
        
        setTimeout(() => {
            loadPersonnelData();
            closeModal();
        }, 1000);
    })
    .catch(error => {
        console.error('Erreur lors de la mise à jour:', error);
        hideProgressOverlay();
        showToast('❌ Erreur lors de la mise à jour du collaborateur', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Supprimer un employé
function deletePersonnel(idEmploye) {
    if (!idEmploye) {
        showToast('ID employé invalide', 'error');
        return;
    }
    
    const employe = allPersonnelData.find(item => item.IdEmploye === idEmploye);
    if (!employe) {
        showToast('Employé non trouvé', 'error');
        return;
    }
    
    const nomComplet = `${employe.Nom} ${employe.Prenom}`;
    
    if (!confirm(`Êtes-vous sûr de vouloir supprimer "${nomComplet}" ? Cette action est irréversible.`)) {
        return;
    }
    
    const payload = {
        IdEmploye: idEmploye
    };
    
    const url = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=deletepersonnel";
    
    showProgressOverlay('Suppression du collaborateur...');
    
    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(() => {
        hideProgressOverlay();
        showToast('✅ Collaborateur supprimé avec succès', 'success');
        
        setTimeout(() => {
            loadPersonnelData();
        }, 1000);
    })
    .catch(error => {
        console.error('Fetch error:', error);
        hideProgressOverlay();
        showToast('❌ Erreur lors de la suppression', 'error');
    });
}

// ==================== EXPORT DES FONCTIONS GLOBALES ====================
window.showAdminSection = showAdminSection;
window.openVueGlobale = openVueGlobale;
window.openAddGrandCaisseModal = openAddGrandCaisseModal;
window.openAddUserModal = openAddUserModal;
window.submitNewUser = submitNewUser;
window.submitUserUpdate = submitUserUpdate;
window.editUser = editUser;
window.deleteUser = deleteUser;
window.editBanqueTransaction = editBanqueTransaction;
window.submitBanqueUpdate = submitBanqueUpdate;
window.submitGrandCaisse = submitGrandCaisse;
window.retrySubmitGrandCaisse = retrySubmitGrandCaisse;
window.retryLoadCategories = retryLoadCategories;
window.selectCategory = selectCategory;
window.showPasswordTooltip = showPasswordTooltip;
window.hidePasswordTooltip = hidePasswordTooltip;
window.copyPassword = copyPassword;
window.closeModal = closeModal;
window.scrollToTop = scrollToTop;
window.closeToast = closeToast;
window.sortTable = sortTable;
window.searchBanque = searchBanque;
window.searchGrandCaisse = searchGrandCaisse;
window.searchUsers = searchUsers;
window.changeItemsPerPage = changeItemsPerPage;
window.changePage = changePage;
window.loadFournisseurData = loadFournisseurData;
window.searchFournisseur = searchFournisseur;
window.openAddFournisseurModal = openAddFournisseurModal;
window.editFournisseurFacture = editFournisseurFacture;
window.deleteFournisseurFacture = deleteFournisseurFacture;
window.loadPersonnelData = loadPersonnelData;
window.searchPersonnel = searchPersonnel;
window.filterByDepartment = filterByDepartment;
window.filterByContractType = filterByContractType;
window.openAddPersonnelModal = openAddPersonnelModal;
window.viewPersonnelDetails = viewPersonnelDetails;
window.editPersonnel = editPersonnel;
window.deletePersonnel = deletePersonnel;
        
    </script>
</body>
</html>
