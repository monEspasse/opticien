<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Facturations - VisioPro</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary-color: #ec4899;
            --accent-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --dark-color: #1f2937;
            --darker-color: #111827;
            --light-color: #f9fafb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --sidebar-bg: var(--darker-color);
            --sidebar-text: var(--gray-200);
            --sidebar-hover: var(--gray-800);
            --sidebar-active: var(--primary-color);
            
            --card-bg: #ffffff;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --card-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            
            --transition: all 0.2s ease-in-out;
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-mode {
            --card-bg: var(--gray-800);
            --light-color: var(--gray-900);
            --dark-color: var(--gray-100);
            --sidebar-bg: var(--gray-900);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: url("fond.png") no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        /* Layout principal */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Header amélioré */
        .header {
            background-color: var(--card-bg);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition-slow);
            border-bottom: 1px solid var(--gray-200);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
            position: relative;
            padding-left: 1rem;
        }

        .page-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--dark-color);
            background-color: var(--gray-100);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .profile-dropdown:hover {
            background-color: var(--gray-100);
        }

        .profile-name {
            font-weight: 500;
        }

        .profile-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            min-width: 200px;
            box-shadow: var(--card-shadow-lg);
            border-radius: var(--border-radius-lg);
            z-index: 110;
            padding: 0.5rem 0;
            overflow: hidden;
            margin-top: 0.5rem;
            animation: dropdownFade 0.2s ease-out;
            border: 1px solid var(--gray-200);
        }

        @keyframes dropdownFade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-menu a {
            color: var(--dark-color);
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .dropdown-menu a:hover, .dropdown-menu a:focus {
            background-color: var(--gray-100);
            color: var(--primary-color);
        }

        .dropdown-menu a i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .profile-dropdown:hover .dropdown-menu,
        .profile-dropdown:focus-within .dropdown-menu {
            display: block;
        }

        /* Contenu principal */
        .dashboard-section {
            padding: 1.5rem;
            flex: 1;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h1 {
            font-size: 1.75rem;
            color: var(--dark-color);
            font-weight: 700;
            position: relative;
            padding-bottom: 0.5rem;
        }

        .dashboard-header h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .dashboard-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Cartes de statistiques améliorées */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow-hover);
        }

        .stat-card.primary {
            border-left-color: var(--primary-color);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.info {
            border-left-color: var(--info-color);
        }

        .stat-card.secondary {
            border-left-color: var(--secondary-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-icon {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-weight: 500;
            color: var(--gray-500);
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Boutons améliorés */
        .btn {
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            font-size: 0.9rem;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-primary:hover, .btn-primary:focus {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--primary-color);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover, .btn-secondary:focus {
            background-color: var(--gray-50);
            box-shadow: var(--card-shadow-hover);
            border-color: var(--primary-color);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #34d399);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f59e0b);
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* Conteneur principal amélioré */
        .produit-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition-slow);
            border: 1px solid var(--gray-200);
        }

        /* Barre de recherche et filtres améliorés */
        .search-filters {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--dark-color);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background-color: var(--card-bg);
            color: var(--dark-color);
            cursor: pointer;
            transition: var(--transition);
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .filter-input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background-color: var(--card-bg);
            color: var(--dark-color);
            transition: var(--transition);
            min-width: 120px;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Tableau des produits amélioré */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
        }

        .produit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .produit-table th {
            background-color: var(--gray-50);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .produit-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .produit-table tbody tr {
            transition: var(--transition);
        }

        .produit-table tbody tr:hover {
            background-color: var(--gray-50);
        }

        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .status-high {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-medium {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-low {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Pagination améliorée */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--gray-500);
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            background-color: var(--card-bg);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            color: var(--dark-color);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--gray-100);
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Messages et alertes améliorées */
        .alert-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            box-shadow: var(--card-shadow-lg);
            z-index: 1050;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-message.success {
            background: linear-gradient(135deg, var(--success-color), #22c55e);
        }

        .alert-message.error {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .alert-message.info {
            background: linear-gradient(135deg, var(--info-color), #06b6d4);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Spinner de chargement amélioré */
        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: -0.125em;
            border: 0.15em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        /* Modal amélioré */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow-lg);
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
            border: 1px solid var(--gray-200);
        }

        .large-modal {
            max-width: 1400px;
        }

        .xlarge-modal {
            max-width: 1600px;
        }

        .medium-modal {
            max-width: 600px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-icon {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        /* Filtres améliorés pour la modale */
        .filters-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background-color: var(--gray-50);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .form-select, .form-control {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--dark-color);
        }

        .form-select:focus, .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-outline-secondary {
            background-color: transparent;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
        }

        .btn-outline-secondary:hover {
            background-color: var(--gray-100);
            border-color: var(--gray-400);
        }

        /* Styles pour la gestion des facturations */
        .action-btns {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .action-btn {
            padding: 0.4rem 0.6rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .btn-edit:hover {
            background-color: #3b82f6;
            color: white;
        }

        .btn-cancel {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn-cancel:hover {
            background-color: #ef4444;
            color: white;
        }

        /* Styles pour les modales d'édition */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
            padding: 1rem;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow-lg);
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
            border: 1px solid var(--gray-200);
        }

        .edit-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .edit-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .edit-modal-body {
            padding: 1.5rem;
        }

        .edit-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.75rem;
        }

        .edit-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .edit-col {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .edit-form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .edit-form-label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .edit-form-control {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--dark-color);
        }

        .edit-form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .edit-btn {
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .edit-btn-primary {
            background: linear-gradient(135deg, var(--success-color), #34d399);
            color: white;
        }

        .edit-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .edit-btn-secondary {
            background-color: var(--card-bg);
            color: var(--gray-600);
            border: 1px solid var(--gray-300);
        }

        .edit-btn-secondary:hover {
            background-color: var(--gray-50);
            border-color: var(--gray-400);
        }

        .required {
            color: var(--danger-color);
        }

        /* Action flottante améliorée */
        .floating-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 100;
        }

        .floating-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .floating-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition-slow);
        }

        .floating-action-btn:hover::before {
            left: 100%;
        }

        .floating-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .floating-action-btn.back {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }

        /* Accessibilité */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        button:focus, select:focus, input:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Responsive amélioré */
        @media (max-width: 1024px) {
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .stats-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .modal-content {
                width: 98%;
                margin: 1%;
            }

            .edit-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-section {
                padding: 1rem;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dashboard-buttons {
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .header {
                padding: 1rem;
            }
            
            .profile-name {
                display: none;
            }

            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .filters-panel {
                grid-template-columns: 1fr;
            }
            
            .action-btns {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .pagination {
                flex-direction: column;
                gap: 1rem;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .modal-body {
                padding: 1rem;
            }

            .edit-modal-body {
                padding: 1rem;
            }
        }

        /* Animations supplémentaires */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Effet de brillance sur les cartes */
        .shine {
            position: relative;
            overflow: hidden;
        }

        .shine::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            transition: all 0.6s;
            opacity: 0;
        }

        .shine:hover::after {
            opacity: 1;
            top: -30%;
            left: -30%;
        }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="main">
        <header class="header">
            <div class="header-left">
                <h1 class="page-title">Gestion des Facturations</h1>
            </div>

            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Basculer le mode sombre">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-info">
                    <div class="profile-dropdown" tabindex="0" aria-haspopup="true" aria-expanded="false">
                        <span class="profile-name" id="username-display"></span>
                        <img src="https://ui-avatars.com/api/?name=John+Doe&background=6366f1&color=fff" alt="Photo de profil" class="profile-img">
                        <div class="dropdown-menu" role="menu">
                            <a href="#" role="menuitem"><i class="fas fa-user" aria-hidden="true"></i> Mon profil</a>
                            <a href="#" role="menuitem"><i class="fas fa-cog" aria-hidden="true"></i> Paramètres</a>
                            <a href="#" id="logout-btn" role="menuitem"><i class="fas fa-sign-out-alt" aria-hidden="true"></i> Déconnexion</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="dashboard-section">
            <div class="dashboard-header">
                <h1>Tableau de Bord des Facturations</h1>
                <div class="dashboard-buttons">
                    <button class="btn btn-primary" onclick="openFacturation()">
                        <i class="fas fa-file-invoice"></i> Gérer les Factures
                    </button>
                    <button class="btn btn-secondary" onclick="openPointFacturation()">
                        <i class="fas fa-chart-bar"></i> Point des Facturations
                    </button>
                </div>
            </div>

            <!-- Cartes de statistiques améliorées -->
            <div class="stats-cards" id="statsCards">
                <!-- Total des factures -->
                <div class="stat-card primary shine" onclick="openFacturation()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-file-invoice stat-icon"></i>
                        <span id="totalFactures">0</span>
                    </div>
                    <div class="stat-label">Total des Factures</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
                
                <!-- Factures en attente -->
                <div class="stat-card warning shine" onclick="openFacturation()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-clock stat-icon"></i>
                        <span id="facturesEnAttente">0</span>
                    </div>
                    <div class="stat-label">Factures en Attente</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
                
                <!-- Montant total -->
                <div class="stat-card success shine" onclick="openPointFacturation()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-money-bill-wave stat-icon"></i>
                        <span id="montantTotal">0 FCFA</span>
                    </div>
                    <div class="stat-label">Montant Total</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
                
                <!-- Dépôts récents -->
                <div class="stat-card info shine" onclick="openPointFacturation()" style="cursor: pointer;">
                    <div class="stat-value">
                        <i class="fas fa-database stat-icon"></i>
                        <span id="depotsRecents">0</span>
                    </div>
                    <div class="stat-label">Dépôts Récents</div>
                    <div class="stat-change">
                        <i class="fas fa-eye"></i> Cliquer pour voir
                    </div>
                </div>
            </div>

            <div class="produit-container">
                <h3 style="margin-bottom: 1rem; color: var(--dark-color);">Actions Rapides</h3>
                <div class="dashboard-buttons">
                    <button class="btn btn-success" onclick="openAddFactureModal()">
                        <i class="fas fa-plus"></i> Nouvelle Facture
                    </button>
                    <button class="btn btn-primary" onclick="genererFacture()">
                        <i class="fas fa-file-export"></i> Générer Dépôt
                    </button>
                    <button class="btn btn-secondary" onclick="refreshFactureData()">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Action flottante améliorée -->
<div class="floating-actions">
    <button class="floating-action-btn back" title="Retour" onclick="openVueGlobale()">
        <i class="fas fa-arrow-left"></i>
    </button>
</div>

<!-- Conteneur pour les modales -->
<div id="modal-container"></div>

<script>
// ==================== VARIABLES GLOBALES ====================
let allFactureData = [];
let uniqueFactureSocietes = [];
let uniqueFactureAssurances = [];
let uniqueFactureCompagnies = [];
let uniqueFactureProprietaires = [];
let currentFilteredFactures = [];

let allFacturationData = [];
let uniqueAssurances = [];
let uniqueCompagnies = [];

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', () => {
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");

    if (!username) {
        redirectToLogin();
        return;
    }

    // Affiche le nom d'utilisateur
    const usernameDisplay = document.getElementById("username-display");
    if (usernameDisplay) {
        usernameDisplay.textContent = username;
    }

    // Met à jour l'image de profil avec les initiales
    const profileImg = document.querySelector('.profile-img');
    if (profileImg) {
        profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=6366f1&color=fff`;
    }

    // Gestion du bouton de déconnexion
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    // Initialiser le thème
    initTheme();
    
    // Activer le timer d'inactivité
    startInactivityTimer();
    
    // Charger les statistiques initiales
    updateStats();
});

// ==================== GESTION DU THÈME ====================
function initTheme() {
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    
    // Appliquer le thème sauvegardé
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }
    
    // Gestion du bouton de basculement de thème
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            localStorage.setItem('theme', 'light');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
    });
}

// ==================== FONCTIONS D'AUTHENTIFICATION ====================
function logout() {
    sessionStorage.removeItem("utilisateur");
    localStorage.removeItem("utilisateur");
    redirectToLogin();
}

function redirectToLogin() {
    window.location.href = "code.html";
}

function startInactivityTimer() {
    const INACTIVITY_LIMIT = 15 * 60 * 1000; // 15 minutes en ms
    let inactivityTimeout;

    function resetTimer() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(logout, INACTIVITY_LIMIT);
    }

    // Événements qui réinitialisent le timer
    ["load", "mousemove", "keydown", "click", "scroll"].forEach(event => {
        window.addEventListener(event, resetTimer, true);
    });

    resetTimer();
}

// ==================== FONCTIONS PRINCIPALES ====================

// Fonction principale pour ouvrir la gestion des facturations
function openFacturation() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content xlarge-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-file-invoice modal-icon"></i> Gestion des Facturations
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <!-- Filtres améliorés -->
                    <div class="filters-panel">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <!-- Filtre Date Début -->
                            <div class="filter-group">
                                <label for="filterFactureDateStart" class="filter-group-label">Date de début</label>
                                <input type="date" id="filterFactureDateStart" class="form-control" onchange="applyFactureFilter()">
                            </div>
                            <!-- Filtre Date Fin -->
                            <div class="filter-group">
                                <label for="filterFactureDateEnd" class="filter-group-label">Date de fin</label>
                                <input type="date" id="filterFactureDateEnd" class="form-control" onchange="applyFactureFilter()">
                            </div>
                            <div class="filter-group">
                                <label for="filterFactureSociete" class="filter-group-label">Société</label>
                                <select id="filterFactureSociete" class="form-select" onchange="applyFactureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="filterFactureAssurance" class="filter-group-label">Assurance</label>
                                <select id="filterFactureAssurance" class="form-select" onchange="applyFactureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="filterFactureCompagnie" class="filter-group-label">Compagnie</label>
                                <select id="filterFactureCompagnie" class="form-select" onchange="applyFactureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="filterFactureProprietaire" class="filter-group-label">Propriétaire</label>
                                <select id="filterFactureProprietaire" class="form-select" onchange="applyFactureFilter()">
                                    <option value="">Tous</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="table-container">
                        <table class="produit-table" id="factureTable">
                            <thead id="factureTableHeader">
                                <!-- Les en-têtes seront générés dynamiquement -->
                            </thead>
                            <tbody id="factureData">
                                <tr>
                                    <td colspan="12" class="text-center py-4">
                                        <div class="spinner-border" style="color: var(--primary-color);"></div>
                                        <div style="margin-top: 1rem; color: var(--gray-500);">Chargement des factures...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Message -->
                    <div id="facture-message" class="alert-message" style="position: relative; display: none; margin-top: 1rem;"></div>
                </div>

                <!-- Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="genererFacture()">
                        <i class="fas fa-file-export"></i> Générer Dépôt
                    </button>
                    <button type="button" class="btn btn-primary" onclick="openAddFactureModal()">
                        <i class="fas fa-plus"></i> Ajouter Facture
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    loadFactureData();
}

// Chargement des données de facturation
async function loadFactureData() {
    const factureData = document.getElementById('factureData');
    const messageDiv = document.getElementById('facture-message');
    const tableHeader = document.getElementById('factureTableHeader');
    
    factureData.innerHTML = '<tr><td colspan="12" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=importassurance`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows || !responseData?.data?.headers) {
            throw new Error('Structure de données invalide');
        }
        
        // Générer les en-têtes du tableau
        generateTableHeaders(responseData.data.headers);
        
        // Transformation des données
        allFactureData = responseData.data.rows.map(row => {
            const item = {};
            responseData.data.headers.forEach((header, index) => {
                const cleanHeader = header.replace(/\t/g, ' ').trim();
                item[cleanHeader] = row[index] || '';
                
                if (cleanHeader.includes('MONTANT TOTAL') || cleanHeader.includes('TOTAL PART ASSURE') || cleanHeader.includes('PART ASSUREUR')) {
                    item[cleanHeader] = parseFloat(row[index]) || 0;
                }
            });
            return item;
        });

        // Initialiser les données filtrées
        currentFilteredFactures = [...allFactureData];

        // Mettre à jour les filtres
        refreshFilters();

        // Afficher les données
        const headers = Object.keys(allFactureData[0] || {});
        displayFilteredFactures(allFactureData, headers);
        
        // Mettre à jour les statistiques
        updateStats();
        
    } catch (error) {
        console.error('Erreur:', error);
        showFactureMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'error');
        factureData.innerHTML = '<tr><td colspan="12" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Générer les en-têtes du tableau
function generateTableHeaders(headers) {
    const tableHeader = document.getElementById('factureTableHeader');
    tableHeader.innerHTML = '';
    
    const headerRow = document.createElement('tr');
    
    headers.forEach(header => {
        const th = document.createElement('th');
        const cleanHeader = header.replace(/\t/g, ' ').trim();
        
        if (cleanHeader.includes('MONTANT TOTAL') || cleanHeader.includes('TOTAL PART ASSURE') || cleanHeader.includes('PART ASSUREUR')) {
            th.className = 'text-end';
        }
        
        th.textContent = cleanHeader;
        headerRow.appendChild(th);
    });
    
    // Ajouter la colonne Actions
    const actionsTh = document.createElement('th');
    actionsTh.textContent = 'Actions';
    headerRow.appendChild(actionsTh);
    
    tableHeader.appendChild(headerRow);
}

// Rafraîchir les filtres
function refreshFilters() {
    uniqueFactureSocietes = [...new Set(allFactureData.map(item => item['Société']).filter(Boolean))];
    uniqueFactureAssurances = [...new Set(allFactureData.map(item => item['Assurance']).filter(Boolean))];
    uniqueFactureCompagnies = [...new Set(allFactureData.map(item => item['Compagnie']).filter(Boolean))];
    uniqueFactureProprietaires = [...new Set(allFactureData.map(item => item['Proprietaire']).filter(Boolean))];

    populateFactureFilter('filterFactureSociete', uniqueFactureSocietes);
    populateFactureFilter('filterFactureAssurance', uniqueFactureAssurances);
    populateFactureFilter('filterFactureCompagnie', uniqueFactureCompagnies);
    populateFactureFilter('filterFactureProprietaire', uniqueFactureProprietaires);
}

// Peupler les filtres
function populateFactureFilter(selectId, values) {
    const select = document.getElementById(selectId);
    if (!select) {
        console.error(`Element #${selectId} non trouvé`);
        return;
    }
    
    select.innerHTML = `<option value="">Tous</option>`;
    
    if (!values || !values.length) return;
    
    values.sort().forEach(value => {
        if (value) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
        }
    });
}

// Application des filtres
function applyFactureFilter() {
    const dateStart = document.getElementById('filterFactureDateStart').value;
    const dateEnd = document.getElementById('filterFactureDateEnd').value;
    const societe = document.getElementById('filterFactureSociete').value;
    const assurance = document.getElementById('filterFactureAssurance').value;
    const compagnie = document.getElementById('filterFactureCompagnie').value;
    const proprietaire = document.getElementById('filterFactureProprietaire').value;
    
    // Convertir les dates une seule fois
    const startDateObj = dateStart ? new Date(dateStart) : null;
    const endDateObj = dateEnd ? new Date(dateEnd) : null;
    
    let filteredData = allFactureData.filter(item => {
        // Filtrage par date
        let dateMatch = true;
        if (item['Date']) {
            const itemDate = new Date(item['Date']);
            
            if (startDateObj && endDateObj) {
                dateMatch = itemDate >= startDateObj && itemDate <= endDateObj;
            } else if (startDateObj) {
                dateMatch = itemDate >= startDateObj;
            } else if (endDateObj) {
                dateMatch = itemDate <= endDateObj;
            }
        }
        
        // Filtrage par autres critères
        const societeMatch = !societe || item['Société'] === societe;
        const assuranceMatch = !assurance || item['Assurance'] === assurance;
        const compagnieMatch = !compagnie || item['Compagnie'] === compagnie;
        const proprietaireMatch = !proprietaire || item['Proprietaire'] === proprietaire;
        
        return dateMatch && societeMatch && assuranceMatch && compagnieMatch && proprietaireMatch;
    });
    
    const headers = Object.keys(allFactureData[0] || {});
    displayFilteredFactures(filteredData, headers);
}

// Réinitialiser les filtres
function resetFactureFilter() {
    document.getElementById('filterFactureDateStart').value = '';
    document.getElementById('filterFactureDateEnd').value = '';
    document.getElementById('filterFactureSociete').value = '';
    document.getElementById('filterFactureAssurance').value = '';
    document.getElementById('filterFactureCompagnie').value = '';
    document.getElementById('filterFactureProprietaire').value = '';
    
    const headers = Object.keys(allFactureData[0] || {});
    displayFilteredFactures(allFactureData, headers);
}

// Affichage des données filtrées
function displayFilteredFactures(data, headers) {
    const factureData = document.getElementById('factureData');
    
    // Stocker les données filtrées actuellement affichées
    currentFilteredFactures = data;
    
    if (!data?.length) {
        factureData.innerHTML = `<tr><td colspan="${headers.length + 1}" class="text-center">Aucune facture trouvée</td></tr>`;
        return;
    }
    
    let html = '';
    data.forEach((item, index) => {
        html += '<tr>';
        
        headers.forEach(header => {
            const cleanHeader = header.replace(/\t/g, ' ').trim();
            const value = item[cleanHeader] || '';
            
            if (cleanHeader === 'Date') {
                html += `<td>${formatDate(value)}</td>`;
            } 
            else if (cleanHeader.includes('MONTANT') || cleanHeader.includes('PART') || cleanHeader.includes('TOTAL')) {
                html += `<td class="text-end">${formatCurrency(value)}</td>`;
            }
            else if (cleanHeader === 'Statut') {
                html += `<td><span class="status-badge ${getStatusBadgeClass(value)}">${value}</span></td>`;
            }
            else {
                html += `<td>${value}</td>`;
            }
        });
        
        // Boutons d'action - utiliser l'index des données filtrées
        html += `
            <td>
                <div class="action-btns">
                    <button class="action-btn btn-edit" onclick="editFilteredFacture(${index})" title="Modifier">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="action-btn btn-cancel" onclick="cancelFilteredFacture(${index})" title="Annuler">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </td>
        `;
        
        html += '</tr>';
    });
    
    factureData.innerHTML = html;
}

// Édition d'une facture depuis les données filtrées
function editFilteredFacture(filteredIndex) {
    // Récupérer la facture depuis les données filtrées actuelles
    const facture = currentFilteredFactures[filteredIndex];
    
    // Trouver l'index correspondant dans allFactureData
    const originalIndex = allFactureData.findIndex(item => 
        item['Id Client'] === facture['Id Client'] && 
        item['N°Police'] === facture['N°Police']
    );
    
    if (originalIndex === -1) {
        alert('Facture non trouvée dans les données originales');
        return;
    }
    
    // Ouvrir la modal d'édition avec l'index original
    openEditFactureModal(originalIndex, facture);
}

// Annulation d'une facture depuis les données filtrées
function cancelFilteredFacture(filteredIndex) {
    // Récupérer la facture depuis les données filtrées actuelles
    const facture = currentFilteredFactures[filteredIndex];
    
    // Trouver l'index correspondant dans allFactureData
    const originalIndex = allFactureData.findIndex(item => 
        item['Id Client'] === facture['Id Client'] && 
        item['N°Police'] === facture['N°Police']
    );
    
    if (originalIndex === -1) {
        alert('Facture non trouvée dans les données originales');
        return;
    }
    
    // Appeler la fonction d'annulation avec l'index original
    cancelFacture(originalIndex);
}

// Ouvrir la modal d'édition de facture
function openEditFactureModal(index, factureData = null) {
    const facture = factureData || allFactureData[index];
    const modalContainer = document.getElementById('modal-container');
    
    const modalHTML = `
        <div class="edit-modal active" id="editFactureModal">
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h3 class="edit-modal-title">
                        <i class="fas fa-edit me-2"></i> 
                        Modifier Facture ${facture['N°Police'] || facture['Id Client']}
                    </h3>
                    <button class="modal-close" onclick="closeModalAndOpenFacturation()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="edit-modal-body">
                    <form id="editFactureForm">
                        <div class="edit-row">
                            <div class="edit-col">
                                <div class="edit-form-group">
                                    <label class="edit-form-label">ID Client</label>
                                    <input type="text" class="edit-form-control" value="${facture['Id Client'] || ''}" readonly>
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Date</label>
                                    <input type="date" class="edit-form-control" id="editDate" value="${formatDateForInput(facture['Date'])}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">N° Police</label>
                                    <input type="text" class="edit-form-control" id="editPolice" value="${facture['N°Police'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Société</label>
                                    <input type="text" class="edit-form-control" id="editSociete" value="${facture['Société'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Assuré Principal</label>
                                    <input type="text" class="edit-form-control" id="editAssure" value="${facture['Assuré Principal'] || ''}">
                                </div>
                                                            
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Bénéficiaire</label>
                                    <input type="text" class="edit-form-control" id="editBeneficiaire" value="${facture['Bénéficiaire'] || ''}">
                                </div>
                            </div>
                            
                            <div class="edit-col">
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Actes</label>
                                    <input type="text" class="edit-form-control" id="editActes" value="${facture['Actes'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Montant Total</label>
                                    <input type="number" step="0.01" class="edit-form-control" id="editMontant" value="${facture['MONTANT TOTAL'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Part Assureur</label>
                                    <input type="number" step="0.01" class="edit-form-control" id="editPartAssureur" value="${facture['PART ASSUREUR'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Part Assuré</label>
                                    <input type="number" step="0.01" class="edit-form-control" id="editPartAssure" value="${facture['TOTAL PART ASSURE'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Assurance</label>
                                    <input type="text" class="edit-form-control" id="editAssurance" value="${facture['Assurance'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Compagnie</label>
                                    <input type="text" class="edit-form-control" id="editCompagnie" value="${facture['Compagnie'] || ''}">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="edit-modal-footer">
                    <button type="button" class="edit-btn edit-btn-secondary" onclick="closeModalAndOpenFacturation()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="button" class="edit-btn edit-btn-primary" onclick="submitFactureUpdate(${index})">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modalHTML;
}

function formatDateForInput(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toISOString().split('T')[0];
    } catch (e) {
        return '';
    }
}

function submitFactureUpdate(index) {
    const facture = allFactureData[index];
    const idClient = facture['Id Client'];
    
    // Récupération des valeurs des champs
    const updatedData = {
        'Id Client': idClient,
        'Date': document.getElementById('editDate').value,
        'N°Police': document.getElementById('editPolice').value,
        'Société': document.getElementById('editSociete').value,
        'Assuré Principal': document.getElementById('editAssure').value,
        'Bénéficiaire': document.getElementById('editBeneficiaire').value,
        'Actes': document.getElementById('editActes').value,
        'MONTANT TOTAL': document.getElementById('editMontant').value,
        'PART ASSUREUR': document.getElementById('editPartAssureur').value,
        'TOTAL PART ASSURE': document.getElementById('editPartAssure').value,
        'Assurance': document.getElementById('editAssurance').value,
        'Compagnie': document.getElementById('editCompagnie').value
    };

    const submitBtn = document.querySelector('.edit-btn-primary');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    submitBtn.disabled = true;

    const url = `https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=updateFacture`;
    
    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            idClient: idClient,
            updatedData: updatedData
        })
    })
    .then(() => {
        // Mise à jour optimiste
        allFactureData[index] = {...allFactureData[index], ...updatedData};
        showTemporaryMessage('✅ Facture mise à jour avec succès', 'success', 3000);
        closeModalAndOpenFacturation();
    })
    .catch(error => {
        console.error("Erreur d'envoi:", error);
        showTemporaryMessage('❌ Erreur lors de la mise à jour', 'error', 3000);
        closeModalAndOpenFacturation();
    })
    .finally(() => {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    });
}

async function cancelFacture(index) {
    const facture = allFactureData[index];
    const clientId = facture['Id Client'];
    const policeNumber = facture['N°Police'] || '';

    if (!confirm(`Confirmez-vous l'annulation de la facture ${policeNumber} ?`)) {
        return;
    }

    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        await fetch(`https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=deleteFacture`, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                idClient: clientId,
                policeNumber: policeNumber
            })
        });

        // Suppression optimiste
        allFactureData.splice(index, 1);
        refreshFilters();
        showTemporaryMessage('✅ Facture annulée avec succès', 'success', 3000);
        closeModalAndOpenFacturation();
    } catch (e) {
        console.error('Erreur réseau:', e);
        showTemporaryMessage('❌ Erreur lors de l\'annulation', 'error', 3000);
    } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

// Fonction pour ouvrir le modal d'ajout
async function openAddFactureModal() {
    const modalContainer = document.getElementById('modal-container');
    
    // Vérifier si une modale est déjà ouverte
    if (document.querySelector('.edit-modal.active')) {
        closeCurrentModal();
        await new Promise(resolve => setTimeout(resolve, 300));
    }

    // Définir la date du jour par défaut
    const today = new Date().toISOString().split('T')[0];

    const modalHTML = `
    <div class="edit-modal active" id="addFactureModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">
                    <i class="fas fa-plus-circle me-2"></i> 
                    Nouvelle Facture
                </h3>
                <button class="modal-close" onclick="closeModalAndOpenFacturation()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="edit-modal-body">
                <form id="addFactureForm">
                    <div class="edit-row">
                        <div class="edit-col">
                            <div class="edit-form-group">
                                <label class="edit-form-label">ID Client <span class="required">*</span></label>
                                <input type="text" class="edit-form-control" id="addClientId" required
                                       placeholder="2 lettres du nom + numéro de police, sans espace">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Date <span class="required">*</span></label>
                                <input type="date" class="edit-form-control" id="addDate" 
                                       value="${today}" required>
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">N° Police</label>
                                <input type="text" class="edit-form-control" id="addPolice"
                                       placeholder="Numéro de police d'assurance">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Société</label>
                                <input type="text" class="edit-form-control" id="addSociete"
                                       placeholder="Nom de la société">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Assuré Principal</label>
                                <input type="text" class="edit-form-control" id="addAssure"
                                       placeholder="Nom complet de l'assuré">
                            </div>
                                                        
                            <div class="edit-form-group">
                                <label class="edit-form-label">Bénéficiaire</label>
                                <input type="text" class="edit-form-control" id="addBeneficiaire"
                                       placeholder="Nom du bénéficiaire">
                            </div>
                        </div>
                        
                        <div class="edit-col">
                            <div class="edit-form-group">
                                <label class="edit-form-label">Actes</label>
                                <textarea class="edit-form-control" id="addActes" rows="1"
                                        placeholder="Détails des actes médicaux">Lunettes</textarea>
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Montant Total</label>
                                <input type="number" step="0.01" class="edit-form-control" id="addMontant"
                                       placeholder="0.00">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Part Assureur</label>
                                <input type="number" step="0.01" class="edit-form-control" id="addPartAssureur"
                                       placeholder="0.00">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Part Assuré</label>
                                <input type="number" step="0.01" class="edit-form-control" id="addPartAssure"
                                       placeholder="0.00">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Assurance</label>
                                <select class="edit-form-control" id="addAssurance">
                                    <option value="">Sélectionner une assurance</option>
                                </select>
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Compagnie</label>
                                <select class="edit-form-control" id="addCompagnie">
                                    <option value="">Sélectionner une compagnie</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="edit-modal-footer">
                <button type="button" class="edit-btn edit-btn-secondary" onclick="closeModalAndOpenFacturation()">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="edit-btn edit-btn-primary" id="submitNewFactureBtn" onclick="submitNewFacture()">
                    <i class="fas fa-save"></i> Ajouter
                </button>
            </div>
        </div>
    </div>`;

    // Ajouter la modale au DOM
    modalContainer.innerHTML = modalHTML;

    // Focus automatique sur le premier champ
    setTimeout(() => {
        document.getElementById('addClientId')?.focus();
    }, 100);

    // Charger les options dynamiques
    await loadDynamicOptions();
}

// Fonction pour soumettre la nouvelle facture
async function submitNewFacture() {
    const form = document.getElementById('addFactureForm');
    
    // Validation améliorée
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Préparation des données de la facture
    const factureData = {
        clientId: document.getElementById('addClientId').value.trim(),
        date: document.getElementById('addDate').value,
        police: document.getElementById('addPolice').value.trim(),
        societe: document.getElementById('addSociete').value.trim(),
        assure: document.getElementById('addAssure').value.trim(),
        beneficiaire: document.getElementById('addBeneficiaire').value.trim(),
        actes: document.getElementById('addActes').value.trim(),
        montant: parseFloat(document.getElementById('addMontant').value) || 0,
        partAssureur: parseFloat(document.getElementById('addPartAssureur').value) || 0,
        partAssure: parseFloat(document.getElementById('addPartAssure').value) || 0,
        assurance: document.getElementById('addAssurance').value,
        compagnie: document.getElementById('addCompagnie').value
    };

    const submitButton = document.getElementById('submitNewFactureBtn');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=addfacture";

        await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(factureData)
        });

        // Succès
        showTemporaryMessage('✅ Facture enregistrée avec succès!', 'success', 3000);
        
        // Fermer après 1.5s
        setTimeout(() => {
            closeModalAndOpenFacturation();
        }, 1500);

    } catch (error) {
        console.error("Erreur:", error);
        showTemporaryMessage('❌ Une erreur est survenue lors de l\'enregistrement', 'error', 3000);
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-save"></i> Ajouter';
    }
}

async function loadDynamicOptions() {
    try {
        // Récupérer les données depuis l'API
        const response = await fetch('https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=importassurance');
        if (!response.ok) throw new Error('Erreur réseau');
        
        const data = await response.json();
        if (!data?.data?.rows) throw new Error('Erreur de données');

        // Extraire les assurances et compagnies uniques
        const assurances = [...new Set(data.data.rows.map(row => row[data.data.headers.indexOf('Assurance')]).filter(Boolean))];
        const compagnies = [...new Set(data.data.rows.map(row => row[data.data.headers.indexOf('Compagnie')]).filter(Boolean))];

        // Remplir le select des assurances
        const assuranceSelect = document.getElementById('addAssurance');
        assurances.forEach(assurance => {
            assuranceSelect.innerHTML += `<option value="${assurance}">${assurance}</option>`;
        });

        // Remplir le select des compagnies
        const compagnieSelect = document.getElementById('addCompagnie');
        compagnies.forEach(compagnie => {
            compagnieSelect.innerHTML += `<option value="${compagnie}">${compagnie}</option>`;
        });

    } catch (error) {
        console.error('Erreur lors du chargement des options:', error);
    }
}

async function genererFacture() {
    // Récupérer les valeurs des filtres
    const dateDebut = document.getElementById('filterFactureDateStart')?.value;
    const dateFin = document.getElementById('filterFactureDateEnd')?.value;
    const assurance = document.getElementById('filterFactureAssurance')?.value;
    const compagnie = document.getElementById('filterFactureCompagnie')?.value;
    
    // Vérifier que tous les champs sont remplis
    if (!dateDebut || !dateFin || !assurance || !compagnie) {
        showTemporaryMessage("❌ Veuillez remplir tous les filtres obligatoires", 'error', 4000);
        return;
    }
    
    // Récupérer la date du jour au format DD/MM/YYYY
    const aujourdhui = new Date();
    const dateDuJour = `${String(aujourdhui.getDate()).padStart(2, '0')}/${String(aujourdhui.getMonth() + 1).padStart(2, '0')}/${aujourdhui.getFullYear()}`;
    
    // Préparer les données
    const data = {
        dateDebut: dateDebut,
        dateFin: dateFin,
        assurance: assurance,
        compagnie: compagnie,
        dateDuJour: dateDuJour
    };
   
    // URL du script Google Apps
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=adddepotData';
    
    // Afficher un message de confirmation
    if (!confirm(`Confirmez-vous l'ajout de ce dépôt ?\n\nDu: ${dateDebut}\nAu: ${dateFin}\nAssurance: ${assurance}\nCompagnie: ${compagnie}`)) {
        return;
    }
    
    const generateButton = document.querySelector('button[onclick*="genererFacture"]');
    let originalText = '';
    
    try {
        // Désactiver le bouton et afficher un indicateur de chargement
        if (generateButton) {
            originalText = generateButton.innerHTML;
            generateButton.disabled = true;
            generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
        }
        
        // Envoyer les données
        await fetch(scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
    
        // Message de succès
        showTemporaryMessage("✅ Dépôt enregistré avec succès !", 'success', 5000);
        
        // Attendre 3 secondes puis ouvrir la fonction
        setTimeout(() => {
            openPointFacturation();
        }, 3000);
        
    } catch (error) {
        console.error("Erreur lors de l'envoi:", error);
        showTemporaryMessage("❌ Erreur lors de l'enregistrement du dépôt", 'error', 4000);
        
    } finally {
        // Réactiver le bouton
        if (generateButton) {
            generateButton.disabled = false;
            generateButton.innerHTML = originalText;
        }
    }
}

function openPointFacturation() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay active">
            <div class="modal-content xlarge-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-file-contract modal-icon"></i> Point des Facturations
                    </h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <!-- Filtres -->
                    <div class="filters-panel">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <!-- Filtre Date Début -->
                            <div class="filter-group">
                                <label for="filterDateStart" class="filter-group-label">Date début</label>
                                <input type="date" id="filterDateStart" class="form-control" onchange="applyFacturationFilter()">
                            </div>
                            <!-- Filtre Date Fin -->
                            <div class="filter-group">
                                <label for="filterDateEnd" class="filter-group-label">Date fin</label>
                                <input type="date" id="filterDateEnd" class="form-control" onchange="applyFacturationFilter()">
                            </div>
                            <div class="filter-group">
                                <label for="filterDateDepot" class="filter-group-label">Date dépôt</label>
                                <input type="date" id="filterDateDepot" class="form-control" onchange="applyFacturationFilter()">
                            </div>
                            <div class="filter-group">
                                <label for="filterAssurance" class="filter-group-label">Assurance</label>
                                <select id="filterAssurance" class="form-select" onchange="applyFacturationFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="filterCompagnie" class="filter-group-label">Compagnie</label>
                                <select id="filterCompagnie" class="form-select" onchange="applyFacturationFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="table-container">
                        <table class="produit-table" id="facturationTable">
                            <thead>
                                <tr>
                                    <th>Date début</th>
                                    <th>Date fin</th>
                                    <th>Assurance</th>
                                    <th>Compagnie</th>
                                    <th>Date dépôt</th>
                                    <th class="text-end">Montant Total</th>
                                    <th class="text-end">Part Assuré</th>
                                    <th class="text-end">Part Assureur</th>
                                    <th>Nb Factures</th>
                                    <th>PDF Récap</th>
                                    <th>PDF Détail</th>
                                </tr>
                            </thead>
                            <tbody id="facturationData">
                                <tr>
                                    <td colspan="11" class="text-center py-4">
                                        <div class="spinner-border" style="color: var(--primary-color);"></div>
                                        <div style="margin-top: 1rem; color: var(--gray-500);">Chargement des données...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Message -->
                    <div id="facturation-message" class="alert-message" style="position: relative; display: none; margin-top: 1rem;"></div>
                </div>

                <!-- Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="printFacturationList()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    loadFacturationData();
}

// Chargement des données de pointage
async function loadFacturationData() {
    const facturationData = document.getElementById('facturationData');
    const messageDiv = document.getElementById('facturation-message');
    
    facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbzcgbKkkfBZgxlarLyLnsXy6sHpQBWox33RXi_W_DRwhM-fAqTvAWO5tkvBZnRcdxt4aQ/exec?action=pointfacturation`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de données invalide');
        }
        
        // Transformation des données
        allFacturationData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                DateDebut: row[headers.indexOf('Date debut')] || '',
                DateFin: row[headers.indexOf('Date fin')] || '',
                Assurance: row[headers.indexOf('Assurance')] || '',
                Compagnie: row[headers.indexOf('Compagnie')] || '',
                DateDepot: row[headers.indexOf('Date de depot')] || '',
                MontantTotal: parseFloat(row[headers.indexOf('MONTANT TOTAL')]) || 0,
                PartAssure: parseFloat(row[headers.indexOf('PART ASSURE')]) || 0,
                PartAssureur: parseFloat(row[headers.indexOf('PART ASSUREUR')]) || 0,
                NbFactures: row[headers.indexOf('Nbs')] || '',
                PdfRecap: row[headers.indexOf("lien Pdf Recaps")] || '',
                PdfDetail: row[headers.indexOf("lien Pdf Detail")] || ''
            };
        });

        // TRI DES DONNÉES PAR DATE DE DÉPÔT DÉCROISSANTE
        allFacturationData.sort((a, b) => {
            const dateA = a.DateDepot ? new Date(a.DateDepot) : new Date(0);
            const dateB = b.DateDepot ? new Date(b.DateDepot) : new Date(0);
            return dateB - dateA;
        });
        
        // Récupération des valeurs uniques pour les filtres
        uniqueAssurances = [...new Set(allFacturationData.map(item => item.Assurance).filter(Boolean))];
        uniqueCompagnies = [...new Set(allFacturationData.map(item => item.Compagnie).filter(Boolean))];
        
        // Peuplement des filtres
        populatePointdesfacture('filterAssurance', uniqueAssurances);
        populatePointdesfacture('filterCompagnie', uniqueCompagnies);

        displayFilteredFacturation(allFacturationData);
       
    } catch (error) {
        console.error('Erreur:', error);
        showFacturationMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'error');
        facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Peuplement des select filters
function populatePointdesfacture(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">Tous</option>`;
    
    values.sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
    });
}

// Affichage des données filtrées avec gestion améliorée des PDF
function displayFilteredFacturation(data) {
    const facturationData = document.getElementById('facturationData');
    
    if (!data?.length) {
        facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Aucune donnée trouvée</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        // Gestion des liens PDF
        const pdfRecapBtn = item.PdfRecap && isValidUrl(item.PdfRecap) 
            ? `<a href="${item.PdfRecap}" target="_blank" class="btn btn-primary btn-sm">Facture</a>`
            : '<span class="text-muted">-</span>';
        
        const pdfDetailBtn = item.PdfDetail && isValidUrl(item.PdfDetail) 
            ? `<a href="${item.PdfDetail}" target="_blank" class="btn btn-primary btn-sm">Détail</a>`
            : '<span class="text-muted">-</span>';

        html += `
            <tr>
                <td>${formatDate(item.DateDebut)}</td>
                <td>${formatDate(item.DateFin)}</td>
                <td>${item.Assurance}</td>
                <td>${item.Compagnie}</td>
                <td>${formatDate(item.DateDepot)}</td>
                <td class="text-end">${formatCurrency(item.MontantTotal)}</td>
                <td class="text-end">${formatCurrency(item.PartAssure)}</td>
                <td class="text-end">${formatCurrency(item.PartAssureur)}</td>
                <td>${item.NbFactures}</td>
                <td>${pdfRecapBtn}</td>
                <td>${pdfDetailBtn}</td>
            </tr>
        `;
    });
    
    facturationData.innerHTML = html;
}

// Vérifie si une URL est valide
function isValidUrl(string) {
    if (!string || typeof string !== 'string') return false;
    
    // Nettoyage basique de l'URL
    string = string.trim().replace(/\s+/g, '');
    
    try {
        new URL(string);
        return true;
    } catch (_) {
        // Tentative de correction pour les URLs Google Drive avec espaces
        if (string.includes('drive.google.com') && string.includes(' ')) {
            const cleanedUrl = string.replace(/\s/g, '');
            try {
                new URL(cleanedUrl);
                return true;
            } catch (_) {
                return false;
            }
        }
        return false;
    }
}

// Application des filtres pour le pointage
function applyFacturationFilter() {
    const dateStart = document.getElementById('filterDateStart').value;
    const dateEnd = document.getElementById('filterDateEnd').value;
    const dateDepot = document.getElementById('filterDateDepot').value;
    const assurance = document.getElementById('filterAssurance').value;
    const compagnie = document.getElementById('filterCompagnie').value;
    
    let filteredData = allFacturationData.filter(item => {
        // Conversion des dates en objets Date pour comparaison
        const itemDateDebut = item.DateDebut ? new Date(item.DateDebut) : null;
        const itemDateFin = item.DateFin ? new Date(item.DateFin) : null;
        const itemDateDepot = item.DateDepot ? new Date(item.DateDepot) : null;
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        const filterDateDepotObj = dateDepot ? new Date(dateDepot) : null;
        
        // Vérification de la plage de dates
        let dateMatch = true;
        if (startDate && endDate) {
            dateMatch = (itemDateDebut >= startDate && itemDateDebut <= endDate) || 
                       (itemDateFin >= startDate && itemDateFin <= endDate);
        } else if (startDate) {
            dateMatch = itemDateDebut >= startDate || itemDateFin >= startDate;
        } else if (endDate) {
            dateMatch = itemDateDebut <= endDate || itemDateFin <= endDate;
        }

        let depotMatch = true;
        if (filterDateDepotObj && itemDateDepot) {
            // Compare seulement jour/mois/année (ignore l'heure)
            depotMatch = itemDateDepot.toDateString() === filterDateDepotObj.toDateString();
        }
        const assuranceMatch = !assurance || item.Assurance === assurance;
        const compagnieMatch = !compagnie || item.Compagnie === compagnie;
        
        return dateMatch && assuranceMatch && compagnieMatch && depotMatch;
    });
    
    displayFilteredFacturation(filteredData);
}

// Réinitialisation des filtres pour le pointage
function resetFacturationFilter() {
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    document.getElementById('filterDateDepot').value = ''; 
    document.getElementById('filterAssurance').value = '';
    document.getElementById('filterCompagnie').value = '';
    
    displayFilteredFacturation(allFacturationData);
}

// Affichage des messages pour le pointage
function showFacturationMessage(message, type) {
    const messageDiv = document.getElementById('facturation-message');
    if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.className = `alert-message ${type}`;
        messageDiv.style.display = 'block';
    }
}

// ==================== FONCTIONS UTILITAIRES ====================

// Fonction pour fermer la modale
function closeModal() {
    const modal = document.querySelector('.modal-overlay.active');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

function closeCurrentModal() {
    const modal = document.querySelector('.edit-modal.active');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

function closeModalAndOpenFacturation() {
    closeModal();
    setTimeout(() => {
        openFacturation();
    }, 300);
}

// Fermer les modals en cliquant à l'extérieur
window.addEventListener('click', function(event) {
    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(modal => {
        if (event.target === modal) {
            closeModal();
        }
    });
});

// Fonction pour afficher les messages temporaires
function showTemporaryMessage(message, type, duration) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert-message ${type}`;
    messageDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(messageDiv);
    
    // Disparaître après la durée spécifiée
    setTimeout(() => {
        messageDiv.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (document.body.contains(messageDiv)) {
                document.body.removeChild(messageDiv);
            }
        }, 300);
    }, duration);
}

// Fonction pour retourner à la vue globale
function openVueGlobale() {
    try {
        const homePath = 'Accueil.html';
        window.location.href = homePath;
    } catch (error) {
        console.error("Erreur d'ouverture:", error);
        alert("Impossible d'ouvrir la page. Contactez l'administrateur.");
    }
}

// Fonction pour rafraîchir les données
function refreshFactureData() {
    if (document.querySelector('.modal-overlay.active')) {
        loadFactureData();
    }
    updateStats();
    showTemporaryMessage("Données actualisées", "success", 2000);
}

// Fonctions utilitaires pour les dates et devises
function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('fr-FR');
    } catch (e) {
        return dateString;
    }
}

function formatCurrency(amount) {
    if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
    return amount.toLocaleString('fr-FR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    }) + ' FCFA';
}

function getStatusBadgeClass(statut) {
    switch(statut) {
        case 'Payé': return 'status-high';
        case 'En attente': return 'status-medium';
        case 'Annulé': return 'status-low';
        default: return 'status-medium';
    }
}

function showFactureMessage(message, type) {
    const messageDiv = document.getElementById('facture-message');
    if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.className = `alert-message ${type}`;
        messageDiv.style.display = 'block';
    }
}

// ==================== MISE À JOUR DES STATISTIQUES ====================

function updateStats() {
    // Calcul des statistiques réelles
    const totalFactures = allFactureData.length;
    const facturesEnAttente = allFactureData.filter(item => 
        item.Statut === 'En attente' || !item.Statut
    ).length;
    
    const montantTotal = allFactureData.reduce((sum, item) => {
        return sum + (parseFloat(item['MONTANT TOTAL']) || 0);
    }, 0);
    
    const depotsRecents = allFacturationData.length;

    // Mise à jour de l'affichage
    document.getElementById('totalFactures').textContent = totalFactures;
    document.getElementById('facturesEnAttente').textContent = facturesEnAttente;
    document.getElementById('montantTotal').textContent = formatCurrency(montantTotal);
    document.getElementById('depotsRecents').textContent = depotsRecents;
}

// Fonction d'impression pour le pointage
function printFacturationList() {
    const printWindow = window.open('', '_blank');
    
    // Récupérer les valeurs actuelles des filtres
    const dateStart = document.getElementById('filterDateStart')?.value || '';
    const dateEnd = document.getElementById('filterDateEnd')?.value || '';
    const dateDepot = document.getElementById('filterDateDepot')?.value || '';
    const assurance = document.getElementById('filterAssurance')?.value || '';
    const compagnie = document.getElementById('filterCompagnie')?.value || '';
    
    // Filtrer les données selon les filtres actuels
    const filteredData = filterData(allFacturationData, dateStart, dateEnd, dateDepot, assurance, compagnie);
    
    const printContent = document.getElementById('facturationTable').cloneNode(true);
    
    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 10px; font-size: 12px; }
            h1 { color: #333; text-align: center; margin-bottom: 5px; font-size: 16px; }
            h2 { color: #555; margin-top: 15px; font-size: 14px; }
            table { width: 100%; border-collapse: collapse; margin-top: 5px; }
            th, td { border: 1px solid #ddd; padding: 5px; text-align: left; }
            th { background-color: #f2f2f2; }
            .text-end { text-align: right; }
            @page { size: landscape; margin: 5mm; }
            @media print {
                body { margin: 0; padding: 0; }
            }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Point des Facturations</title>
                ${styles}
            </head>
            <body>
                <h1>Point des Facturations</h1>
                <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Fonction pour filtrer les données (identique à applyFacturationFilter mais retourne les données)
function filterData(data, dateStart, dateEnd, dateDepot, assurance, compagnie) {
    return data.filter(item => {
        // Conversion des dates en objets Date pour comparaison
        const itemDateDebut = item.DateDebut ? new Date(item.DateDebut) : null;
        const itemDateFin = item.DateFin ? new Date(item.DateFin) : null;
        const itemDateDepot = item.DateDepot ? new Date(item.DateDepot) : null;
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        const filterDateDepotObj = dateDepot ? new Date(dateDepot) : null;
        
        // Vérification de la plage de dates
        let dateMatch = true;
        if (startDate && endDate) {
            dateMatch = (itemDateDebut >= startDate && itemDateDebut <= endDate) || 
                       (itemDateFin >= startDate && itemDateFin <= endDate);
        } else if (startDate) {
            dateMatch = itemDateDebut >= startDate || itemDateFin >= startDate;
        } else if (endDate) {
            dateMatch = itemDateDebut <= endDate || itemDateFin <= endDate;
        }

        let depotMatch = true;
        if (filterDateDepotObj && itemDateDepot) {
            // Compare seulement jour/mois/année (ignore l'heure)
            depotMatch = itemDateDepot.toDateString() === filterDateDepotObj.toDateString();
        }
        const assuranceMatch = !assurance || item.Assurance === assurance;
        const compagnieMatch = !compagnie || item.Compagnie === compagnie;
        
        return dateMatch && assuranceMatch && compagnieMatch && depotMatch;
    });
}
</script>
</body>
</html>