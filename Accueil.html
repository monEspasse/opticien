 <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - VisioPro</title>
        <!-- Favicon de base -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
    --primary-color: #4361ee;
    --primary-dark: #3a56d4;
    --secondary-color: #3f37c9;
    --accent-color: #4895ef;
    --light-accent: #4cc9f0;
    --success-color: #4ade80;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --dark-color: #1e293b;
    --light-color: #f8fafc;
    --gray-color: #94a3b8;
    --sidebar-bg: #1e293b;
    --sidebar-text: #e2e8f0;
    --sidebar-hover: #334155;
    --sidebar-active: #4361ee;
    --card-bg: #ffffff;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --border-radius: 8px;
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Montserrat', sans-serif;
}

body {
    background: url("fond.png") no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 20px;
}

/* Styles pour mobile */
@media (max-width: 768px) {
    body {
        background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
        min-height: 100vh;
        font-family: 'Inter', sans-serif;
        color: #2d3748;
        position: relative;
        display: block; /* Remet à la valeur par défaut */
        padding: 0; /* Supprime le padding si nécessaire */
    }
}


.dashboard {
    display: flex;
    min-height: 100vh;
}

@media (max-width: 768px) {
  .sidebar {
    left: -280px;            /* masquée par défaut */
    transition: left .3s ease;
  }
  .sidebar.active {
    left: 0;                 /* visible quand on ajoute la classe */
  }
}

/* ===== SIDEBAR ===== */
.sidebar {
    width: 280px;
    background: linear-gradient(180deg, var(--sidebar-bg) 0%, #1a2235 100%);
    color: var(--sidebar-text);
    transition: var(--transition);
    overflow-y: auto;
    position: fixed;
    height: 100vh;
    z-index: 1000;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
    top: 0;
    left: 0;
    display: flex;
    flex-direction: column;
    padding-top: 25px;
}

/* Logo Container */
.logo-container {
    padding: 0 1.5rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.logo-image {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    object-fit: cover;
    border: 2px solid var(--accent-color);
}

.logo-text {
    font-weight: 700;
    font-size: 1.1rem;
    color: white;
    background: linear-gradient(135deg, #fff, var(--light-accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.sidebar-toggle {
    color: var(--gray-color);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: var(--transition);
}

.sidebar-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

/* Menu Styles */
.menu {
    padding: 0 1rem;
    flex: 1;
}

.menu-item {
    margin-bottom: 0.25rem;
    position: relative;
}

.menu-link {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: var(--sidebar-text);
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    justify-content: space-between;
    position: relative;
    overflow: hidden;
}

.menu-link::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.menu-link:hover::before {
    left: 100%;
}

.menu-link:hover {
    background: linear-gradient(135deg, var(--sidebar-hover), rgba(67, 97, 238, 0.1));
    color: white;
    transform: translateX(5px);
}

.menu-link.active {
    background: linear-gradient(135deg, var(--sidebar-active), var(--accent-color));
    color: white;
    box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
}

.menu-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 1rem;
}

.menu-text {
    flex: 1;
    font-weight: 500;
    font-size: 0.9rem;
}

.chevron {
    transition: var(--transition);
    font-size: 0.8rem;
    color: var(--gray-color);
}

.menu-item.active .chevron {
    transform: rotate(180deg);
    color: white;
}

/* Submenu Styles */
.submenu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    margin-left: 0.5rem;
    border-left: 1px solid rgba(255, 255, 255, 0.1);
}

.menu-item.active .submenu {
    max-height: 500px;
}

.submenu a {
    display: flex;
    align-items: center;
    padding: 0.6rem 1rem 0.6rem 1.5rem;
    color: var(--sidebar-text);
    text-decoration: none;
    border-radius: 8px;
    transition: var(--transition);
    font-size: 0.85rem;
    margin: 0.1rem 0;
    position: relative;
}

.submenu a:hover {
    background: rgba(255, 255, 255, 0.05);
    color: white;
    transform: translateX(3px);
}

.submenu-icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 0.8rem;
    color: var(--accent-color);
}

/* Submenu Sections */
.submenu-section {
    margin: 0.5rem 0;
    padding: 0.5rem 0;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.submenu-header {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem 0.5rem 1.5rem;
    color: var(--gray-color);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.submenu-header i {
    margin-right: 0.5rem;
    font-size: 0.7rem;
}

/* Badges et Status */
.menu-badge {
    background: var(--success-color);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-left: auto;
}

.menu-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: auto;
}

.menu-status.online {
    background: var(--success-color);
    box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.3);
}

/* Loader */
.menu-loader {
    padding: 0.5rem 1rem 0.5rem 2.5rem;
    font-size: 0.8rem;
    color: var(--gray-color);
    display: none;
}

.loader-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-left: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 0.5rem;
}

/* Sidebar Footer */
.sidebar-footer {
    padding: 1.25rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: auto;
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}

.profile-avatar {
    position: relative;
    flex-shrink: 0;
}

.profile-img {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid var(--accent-color);
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    transition: all 0.3s ease;
}

.profile-img:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
}

.online-status {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--success-color);
    border: 2px solid var(--sidebar-bg);
    box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.5);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); 
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(74, 222, 128, 0.3); 
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); 
    }
}

.profile-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 0;
}

.profile-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.profile-role {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.75rem;
    color: var(--gray-color);
    font-weight: 500;
}

.profile-role i {
    font-size: 0.5rem;
    color: var(--success-color);
    animation: blink 2s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

.download-app-btn {
    background: rgba(67, 97, 238, 0.15);
    border: none;
    color: var(--primary-color);
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    margin-top: 0.25rem;
}

.download-app-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-1px);
}

.footer-actions {
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

.logout-btn {
    background: rgba(239, 68, 68, 0.15);
    border: none;
    color: var(--danger-color);
    padding: 0.75rem;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.logout-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.logout-btn:hover::before {
    left: 100%;
}

.logout-btn:hover {
    background: var(--danger-color);
    color: white;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}

/* ===== HEADER ===== */
.header {
    background-color: var(--card-bg);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    position: fixed;
    top: 0;
    left: 280px; 
    right: 0; 
    z-index: 5;
    height: 80px;
    box-sizing: border-box;
}

.main {
    flex: 1;
    margin-left: 280px;
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
    min-height: 100vh;
    margin-top: 80px;
}

.header-left {
    display: flex;
    align-items: center;
}

.mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    color: var(--dark-color);
    font-size: 1.25rem;
    margin-right: 1rem;
    cursor: pointer;
}

.page-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--dark-color);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* ===== DASHBOARD CONTENT ===== */
.dashboard-section {
    padding: 1.5rem;
    flex: 1;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--gray-light);
}

.dashboard-header h1 {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.quick-action-card {
    background: var(--card-bg);
    border: 1px solid var(--gray-light);
    border-radius: 20px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 1rem;
    text-align: left;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.quick-action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.quick-action-card:hover {
    transform: translateY(-8px);
    border-color: var(--primary-color);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.quick-action-card:hover::before {
    transform: scaleX(1);
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.quick-action-card:hover .card-icon {
    transform: scale(1.1) rotate(5deg);
}

.card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.card-title {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--dark-color);
}

.card-desc {
    font-size: 0.85rem;
    color: var(--gray-color);
    line-height: 1.4;
}

.card-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--success-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.card-badge.trending {
    background: linear-gradient(135deg, #ff6b6b, #ffa500);
}

/* Animations au chargement */
.quick-action-card {
    animation: cardEntrance 0.6s ease-out;
    animation-fill-mode: both;
}

.quick-action-card:nth-child(1) { animation-delay: 0.1s; }
.quick-action-card:nth-child(2) { animation-delay: 0.2s; }
.quick-action-card:nth-child(3) { animation-delay: 0.3s; }
.quick-action-card:nth-child(4) { animation-delay: 0.4s; }

@keyframes cardEntrance {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== CLIENTS CARD ===== */
.clients-card {
    background: var(--card-bg);
    border-radius: 20px;
    border: 1px solid var(--gray-light);
    box-shadow: var(--card-shadow);
    overflow: hidden;
    position: relative;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    max-height: 600px;
}

.clients-card:hover {
    box-shadow: var(--card-shadow-hover);
    transform: translateY(-2px);
}

/* En-tête de carte */
.card-header {
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.02), rgba(72, 149, 239, 0.03));
    border-bottom: 1px solid var(--gray-light);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark-color);
}

.title-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
}

/* Actions header */
.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.search-container {
    position: relative;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--gray-light);
    transition: var(--transition);
    min-width: 280px;
}

.search-container:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-color);
    transition: var(--transition);
}

.search-container:focus-within .search-icon {
    color: var(--primary-color);
}

.search-container input {
    border: none;
    background: none;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    width: 100%;
    font-size: 0.9rem;
    color: var(--dark-color);
    outline: none;
}

.search-focus-line {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    transition: var(--transition);
    transform: translateX(-50%);
}

.search-container:focus-within .search-focus-line {
    width: 100%;
}

/* Corps de carte */
.card-body {
    padding: 0;
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
}

/* États de chargement */
.loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    color: var(--gray-color);
}

.loading-animation {
    position: relative;
    margin-bottom: 1.5rem;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(67, 97, 238, 0.1);
    border-left: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loading-pulse {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30px;
    height: 30px;
    background: rgba(67, 97, 238, 0.2);
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
}

.loading-progress {
    width: 200px;
    height: 4px;
    background: var(--gray-light);
    border-radius: 2px;
    margin-top: 1rem;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    border-radius: 2px;
    animation: progress 2s ease-in-out infinite;
}

/* Message d'erreur */
.error-message {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 2rem;
    text-align: center;
    background: rgba(239, 68, 68, 0.05);
    border-radius: 12px;
    margin: 1rem 2rem;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.error-icon {
    font-size: 2.5rem;
    color: var(--danger-color);
    margin-bottom: 1rem;
}

.error-content h3 {
    color: var(--danger-color);
    margin-bottom: 0.5rem;
    font-size: 1.2rem;
}

.error-content p {
    color: var(--gray-color);
    margin-bottom: 1rem;
}

.retry-btn {
    padding: 0.75rem 1.5rem;
    background: var(--danger-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
}

.retry-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* Conteneur tableau */
.table-container {
    position: relative;
    flex: 1;
    overflow: hidden;
    min-height: 300px;
}

.table-responsive {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 400px;
    position: relative;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) #f1f5f9;
}

.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    border-radius: 4px;
    transition: all 0.3s ease;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
}

.modern-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.modern-table thead {
    background: #f8fafc;
    border-bottom: 2px solid var(--gray-light);
    position: sticky;
    top: 0;
    z-index: 10;
}

.modern-table th {
    padding: 1rem 1.5rem;
    text-align: left;
    font-weight: 600;
    color: var(--dark-color);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.modern-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--gray-light);
    font-size: 0.9rem;
    transition: var(--transition);
}

.modern-table tbody tr {
    transition: var(--transition);
    position: relative;
    background: linear-gradient(90deg, transparent 50%, rgba(67, 97, 238, 0.02) 50%);
    background-size: 200% 100%;
    background-position: right bottom;
    border-left: 3px solid transparent;
}

.modern-table tbody tr:hover {
    transform: scale(1.002);
    background-position: left bottom;
    border-left: 3px solid var(--primary-color);
    box-shadow: 
        0 8px 25px rgba(67, 97, 238, 0.15),
        inset 4px 0 0 var(--primary-color);
    z-index: 2;
    animation: gentlePulse 2s ease-in-out infinite;
}

@keyframes gentlePulse {
    0%, 100% {
        box-shadow: 
            0 8px 25px rgba(67, 97, 238, 0.15),
            inset 4px 0 0 var(--primary-color);
    }
    50% {
        box-shadow: 
            0 8px 35px rgba(67, 97, 238, 0.25),
            inset 4px 0 0 var(--accent-color);
    }
}

/* Overlay état vide */
.table-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    align-items: center;
    justify-content: center;
    border-radius: 12px;
}

.empty-state {
    text-align: center;
    color: var(--gray-color);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    color: var(--dark-color);
    margin-bottom: 0.5rem;
    font-size: 1.2rem;
}

.empty-state p {
    font-size: 0.9rem;
}

/* Pagination */
.pagination-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    background: #f8fafc;
    border-top: 1px solid var(--gray-light);
    gap: 1rem;
    flex-shrink: 0;
}

.pagination-info {
    font-size: 0.9rem;
    color: var(--gray-color);
}

.pagination-navigation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pagination-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border: 1px solid var(--gray-light);
    background: white;
    border-radius: 8px;
    color: var(--dark-color);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    font-size: 0.9rem;
}

.pagination-btn:hover:not(:disabled) {
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(67, 97, 238, 0.15);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.items-per-page {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
    color: var(--gray-color);
}

.select-wrapper {
    position: relative;
}

.modern-select {
    appearance: none;
    padding: 0.5rem 2rem 0.5rem 1rem;
    border: 1px solid var(--gray-light);
    border-radius: 6px;
    background: white;
    color: var(--dark-color);
    font-size: 0.9rem;
    cursor: pointer;
    transition: var(--transition);
}

.modern-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.select-arrow {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--gray-color);
    font-size: 0.8rem;
}

/* ===== CHARTS CARD ===== */
.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.charts-card {
    background: var(--card-bg);
    border-radius: 20px;
    border: 1px solid var(--gray-light);
    box-shadow: var(--card-shadow);
    overflow: hidden;
    position: relative;
    transition: var(--transition);
}

.charts-card:hover {
    box-shadow: var(--card-shadow-hover);
    transform: translateY(-2px);
}

/* Conteneur des graphiques */
.charts-container {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

/* Section de graphique */
.chart-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--gray-light);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.chart-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-color);
    margin: 0;
}

.chart-stats {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-item {
    text-align: right;
}

.stat-value {
    display: block;
    font-weight: 700;
    font-size: 1.2rem;
    color: var(--success-color);
}

.stat-label {
    display: block;
    font-size: 0.8rem;
    color: var(--gray-color);
}

.chart-wrapper {
    height: 200px;
    position: relative;
}

/* Grille des tableaux de données */
.data-tables-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
    margin-top: 1.5rem;
}

.data-table-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.04),
        0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(226, 232, 240, 0.8);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: fit-content;
    max-height: 400px;
}

.data-table-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.data-table-section:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.08),
        0 4px 12px rgba(67, 97, 238, 0.05);
    border-color: rgba(67, 97, 238, 0.2);
}

.data-table-section:hover::before {
    transform: scaleX(1);
}

.data-table-section h4 {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--dark-color);
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(67, 97, 238, 0.1);
    position: relative;
    flex-shrink: 0;
}

.data-table-section h4::before {
    content: '';
    width: 4px;
    height: 20px;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
}

/* Tableaux de statistiques */
.stats-table {
    font-size: 0.875rem;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 500px;
}

.stats-table th {
    font-size: 0.8rem;
    padding: 1rem 0.875rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    color: var(--dark-color);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid rgba(67, 97, 238, 0.2);
    position: sticky;
    top: 0;
    z-index: 2;
    white-space: nowrap;
}

.stats-table td {
    padding: 0.875rem;
    border-bottom: 1px solid rgba(226, 232, 240, 0.8);
    transition: all 0.2s ease;
    position: relative;
    white-space: nowrap;
}

.stats-table tbody tr {
    transition: all 0.3s ease;
    background: linear-gradient(90deg, transparent 50%, rgba(67, 97, 238, 0.02) 50%);
    background-size: 200% 100%;
    background-position: right bottom;
    animation: fadeInUp 0.4s ease-out;
    animation-fill-mode: both;
}

.stats-table tbody tr:hover {
    background-position: left bottom;
    transform: translateX(2px);
}

.stats-table tbody tr:nth-child(1) { animation-delay: 0.1s; }
.stats-table tbody tr:nth-child(2) { animation-delay: 0.2s; }
.stats-table tbody tr:nth-child(3) { animation-delay: 0.3s; }
.stats-table tbody tr:nth-child(4) { animation-delay: 0.4s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Indicateurs d'évolution */
.evolution-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 700;
    transition: all 0.3s ease;
    min-width: 80px;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: hidden;
    white-space: nowrap;
}

.evolution-indicator::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.evolution-indicator:hover::before {
    left: 100%;
}

.evolution-positive {
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(74, 222, 128, 0.08));
    color: #059669;
    border: 1px solid rgba(74, 222, 128, 0.3);
}

.evolution-positive:hover {
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(74, 222, 128, 0.12));
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 222, 128, 0.2);
}

.evolution-negative {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08));
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.evolution-negative:hover {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.12));
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
}

.evolution-neutral {
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.15), rgba(148, 163, 184, 0.08));
    color: #64748b;
    border: 1px solid rgba(148, 163, 184, 0.3);
}

.evolution-neutral:hover {
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.2), rgba(148, 163, 184, 0.12));
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(148, 163, 184, 0.2);
}

/* ===== ANIMATIONS ===== */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.7; }
}

@keyframes progress {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .data-tables-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 1024px) {
    .sidebar {
        width: 240px;
    }
    
    .header-content {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .search-container {
        min-width: auto;
    }
}

@media (max-width: 768px) {
    .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        bottom: 0;
        z-index: 100;
        transition: var(--transition);
    }

    .sidebar.active {
        left: 0;
    }

    .mobile-menu-btn {
        display: block;
    }

    .main {
        margin-left: 0;
        margin-top: 70px;
        width: 100%;
    }

    .header {
        left: 0;
        width: 100%;
        padding: 1rem;
        height: 70px;
    }

    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .dashboard-header h1 {
        font-size: 1.75rem;
    }

    .quick-actions {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .quick-action-card {
        padding: 1.25rem;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
    }

    .card-header {
        padding: 1rem 1.5rem;
    }
    
    .header-content {
        gap: 1rem;
    }
    
    .header-actions {
        flex-direction: column;
        width: 100%;
    }
    
    .search-container {
        width: 100%;
    }
    
    .section-title {
        font-size: 1.3rem;
    }
    
    .title-icon {
        width: 44px;
        height: 44px;
        font-size: 1.1rem;
    }
    
    .modern-table th,
    .modern-table td {
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
    }
    
    .pagination-controls {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem 1.5rem;
    }
    
    .pagination-navigation {
        order: -1;
    }
    
    .items-per-page {
        justify-content: center;
    }

    .data-table-section {
        padding: 1.25rem;
        max-height: 350px;
    }
    
    .stats-table {
        min-width: 450px;
    }

    .chart-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .chart-stats {
        align-self: flex-end;
    }
}

@media (max-width: 480px) {
    .dashboard-section {
        padding: 1rem;
    }

    .card-header {
        padding: 1rem;
    }
    
    .section-title {
        font-size: 1.2rem;
    }
    
    .title-icon {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    
    .modern-table {
        font-size: 0.8rem;
    }
    
    .modern-table th,
    .modern-table td {
        padding: 0.5rem 0.75rem;
    }
    
    .pagination-btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
    }

    .profile-name {
        display: none;
    }

    .data-table-section {
        padding: 1rem;
        border-radius: 12px;
        max-height: 300px;
    }
    
    .data-table-section h4 {
        font-size: 1rem;
        margin-bottom: 1rem;
    }
    
    .stats-table {
        font-size: 0.8rem;
        min-width: 400px;
    }
    
    .stats-table th,
    .stats-table td {
        padding: 0.75rem 0.5rem;
    }
    
    .evolution-indicator {
        padding: 0.375rem 0.5rem;
        font-size: 0.75rem;
        min-width: 70px;
    }
}


#addFactureModal {
    font-family: 'Poppins', sans-serif;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 30000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

#addFactureModal.active {
    opacity: 1;
    visibility: visible;
}

#addFactureModal .modal-content {
    width: 90%;
    max-width: 800px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#addFactureModal.active .modal-content {
    transform: translateY(0);
}

#addFactureModal .modal-header {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 20px;
    position: relative;
    border-bottom: none;
}

#addFactureModal .modal-header::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 20px;
    background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="%23f8f9fa" opacity=".25"/><path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" fill="%23f8f9fa" opacity=".5"/><path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="%23f8f9fa"/></svg>');
    background-size: cover;
}

#addFactureModal .modal-title {
    font-weight: 600;
    letter-spacing: 0.5px;
    font-size: 1.4rem;
    margin: 0;
    font-family: 'Montserrat', sans-serif;
}

#addFactureModal .modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    position: absolute;
    top: 15px;
    right: 15px;
}

#addFactureModal .modal-body {
    padding: 25px;
}

#addFactureModal .form-group {
    margin-bottom: 1.5rem;
    position: relative;
}

#addFactureModal .form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.9rem;
    display: block;
}

#addFactureModal .form-control,
#addFactureModal .form-select {
    width: 100%;
    border-radius: 8px;
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    transition: all 0.3s ease;
    box-shadow: none;
    font-family: 'Poppins', sans-serif;
}

#addFactureModal .form-control:focus,
#addFactureModal .form-select:focus {
    border-color: #2575fc;
    box-shadow: 0 0 0 0.25rem rgba(37, 117, 252, 0.15);
    outline: none;
}

#addFactureModal .modal-footer {
    padding: 20px;
    background-color: #f8f9fa;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

#addFactureModal .btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
    font-family: 'Montserrat', sans-serif;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

#addFactureModal .btn-secondary {
    background-color: #6c757d;
    color: white;
}

#addFactureModal .btn-primary {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

#addFactureModal .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

#addFactureModal .btn-primary:hover::before {
    left: 100%;
}

#addFactureModal .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* Animation de l'onde */
#addFactureModal .form-group::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #2575fc, #6a11cb);
    transition: width 0.4s ease;
}

#addFactureModal .form-group:focus-within::after {
    width: 100%;
}

/* Spinner */
#addFactureModal .spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    #addFactureModal .modal-content {
        width: 95%;
    }
    
    #addFactureModal .row {
        flex-direction: column;
    }
    
    #addFactureModal .col-md-6 {
        width: 100%;
    }
}

/* Style unique pour le modal de modification */
.edit-modal {
    font-family: 'Poppins', sans-serif;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.edit-modal.active {
    opacity: 1;
    visibility: visible;
}

.edit-modal-content {
    width: 90%;
    max-width: 800px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.edit-modal.active .edit-modal-content {
    transform: translateY(0);
}

.edit-modal-header {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 20px;
    position: relative;
    border-bottom: none;
}

.edit-modal-header::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 20px;
    background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="%23f8f9fa" opacity=".25"/><path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" fill="%23f8f9fa" opacity=".5"/><path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="%23f8f9fa"/></svg>');
    background-size: cover;
}

.edit-modal-title {
    font-weight: 600;
    letter-spacing: 0.5px;
    font-size: 1.4rem;
    margin: 0;
    font-family: 'Montserrat', sans-serif;
}

.edit-modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    position: absolute;
    top: 15px;
    right: 15px;
}

.edit-modal-body {
    padding: 25px;
}

.edit-form-group {
    margin-bottom: 1.5rem;
    position: relative;
}

.edit-form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.9rem;
    display: block;
}

.edit-form-control {
    width: 100%;
    border-radius: 8px;
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    transition: all 0.3s ease;
    box-shadow: none;
    font-family: 'Poppins', sans-serif;
}

.edit-form-control:focus {
    border-color: #2575fc;
    box-shadow: 0 0 0 0.25rem rgba(37, 117, 252, 0.15);
    outline: none;
}

.edit-form-control[readonly] {
    background-color: #f8f9fa;
    border-color: #e9ecef;
    color: #6c757d;
}

.edit-modal-footer {
    padding: 20px;
    background-color: #f8f9fa;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.edit-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
    font-family: 'Montserrat', sans-serif;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.edit-btn-secondary {
    background-color: #6c757d;
    color: white;
}

.edit-btn-primary {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

.edit-btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

.edit-btn-primary:hover::before {
    left: 100%;
}

.edit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.edit-row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px;
}

.edit-col {
    flex: 1;
    min-width: 250px;
    padding: 0 10px;
}

/* Animation de l'onde */
.edit-form-group::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #2575fc, #6a11cb);
    transition: width 0.4s ease;
}

.edit-form-group:focus-within::after {
    width: 100%;
}

/* Spinner */
.edit-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: edit-spin 0.75s linear infinite;
}

@keyframes edit-spin {
    to { transform: rotate(360deg); }
}

#addFactureModal .modal-content {
    width: 90%;
    max-width: 800px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#addFactureModal.active .modal-content {
    transform: translateY(0);
}

#addFactureModal .modal-header {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 20px;
    position: relative;
    border-bottom: none;
}

#addFactureModal .modal-header::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 20px;
    background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="%23f8f9fa" opacity=".25"/><path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" fill="%23f8f9fa" opacity=".5"/><path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="%23f8f9fa"/></svg>');
    background-size: cover;
}

#addFactureModal .btn-primary {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

#addFactureModal .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

#addFactureModal .btn-primary:hover::before {
    left: 100%;
}

/* =======================
   PROFORMA MODAL STYLES
   ======================= */

/* Overlay (arrière-plan du modal) */
#proformaModal.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(6px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-out;
}

/* Modal actif */
#proformaModal.active {
    display: flex;
}

/* Conteneur principal */
#proformaModal .modal-container {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    width: 90%;
    max-width: 1250px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.25);
    animation: slideDown 0.4s ease-out;
    padding: 20px;
}

/* Header du modal */
#proformaModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: #fff;
    border-radius: 15px 15px 0 0;
}

/* Titre */
#proformaModal .modal-title {
    font-size: 1.6rem;
    font-weight: 700;
}

/* Bouton de fermeture */
#proformaModal .modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.3s;
}
#proformaModal .modal-close:hover {
    background: rgba(255, 255, 255, 0.4);
}

/* =======================
   STEPPER
   ======================= */
#proformaModal .stepper {
    display: flex;
    justify-content: space-between;
    margin: 25px 0 30px;
    position: relative;
}
#proformaModal .stepper::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
}
#proformaModal .step {
    flex: 1;
    text-align: center;
    position: relative;
    z-index: 1;
}
#proformaModal .step-number {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(6px);
    border: 2px solid #6a11cb;
    color: #6a11cb;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 8px;
    transition: all 0.3s ease;
}
#proformaModal .step.active .step-number {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    transform: scale(1.1);
}
#proformaModal .step-label {
    font-size: 0.85rem;
    color: #2575fc;
    font-weight: 500;
}

/* =======================
   FORMULAIRE
   ======================= */
#proformaModal .form-section {
    display: none;
}
#proformaModal .form-section.active {
    display: block;
    animation: fadeIn 0.5s ease;
}
#proformaModal .section-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: #2575fc;
    border-left: 5px solid #6a11cb;
    padding-left: 10px;
}
#proformaModal .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
}
#proformaModal .form-group {
    flex: 1;
    min-width: 240px;
}
#proformaModal .form-group label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    color: #333;
}
#proformaModal input, 
#proformaModal select {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ccc;
    border-radius: 10px;
    font-size: 1rem;
    transition: border 0.3s, box-shadow 0.3s;
}
#proformaModal input:focus, 
#proformaModal select:focus {
    border-color: #6a11cb;
    box-shadow: 0 0 6px rgba(106, 17, 203, 0.3);
    outline: none;
}

/* =======================
   TABLE
   ======================= */
#proformaModal .prescription-table-container {
    overflow-x: auto;
    margin: 20px 0;
    border-radius: 10px;
    border: 1px solid #eee;
}
#proformaModal .prescription-table {
    width: 100%;
    border-collapse: collapse;
}
#proformaModal .prescription-table th {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    padding: 12px;
    font-weight: 600;
}
#proformaModal .prescription-table td {
    border: 1px solid #eee;
    padding: 10px;
    text-align: center;
}

/* =======================
   NAVIGATION
   ======================= */
#proformaModal .form-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #ddd;
}
#proformaModal .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.3s;
}
#proformaModal .btn-primary {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
}
#proformaModal .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(37, 117, 252, 0.3);
}
#proformaModal .btn-secondary {
    background: #eee;
    color: #333;
}
#proformaModal .btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* =======================
   LOADER
   ======================= */
#proformaModal .loader-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
#proformaModal .loader-overlay.active {
    display: flex;
}
#proformaModal .loader-content {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(6px);
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
}
#proformaModal .loader-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #6a11cb;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

/* =======================
   ANIMATIONS
   ======================= */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes slideDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* =======================
   RESPONSIVE
   ======================= */
@media (max-width: 768px) {
    #proformaModal .modal-container {
        width: 95%;
        padding: 15px;
    }
    #proformaModal .form-row {
        flex-direction: column;
        gap: 15px;
    }
    #proformaModal .btn {
        width: 100%;
    }
}

.detail-couts-container {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.detail-couts-title {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.1rem;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
}

.detail-couts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.detail-cout-item {
    display: flex;
    flex-direction: column;
}

.detail-cout-item label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 5px;
    font-size: 0.9rem;
}

.detail-cout-item input {
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.95rem;
}

.detail-cout-item input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

/* -----------------------
   OVERLAY AVEC EFFET GLASSMORPHISM AVANCÉ
   ----------------------- */
#newSaleModal.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.15) 0%, transparent 50%);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    animation: modalEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    padding: 20px;
    box-sizing: border-box;
}

/* Modal actif */
#newSaleModal.active {
    display: flex;
}

/* -----------------------
   MODAL CONTAINER NÉOMORPHISME
   ----------------------- */
#newSaleModal .modal-content {
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.95) 0%,
            rgba(255, 255, 255, 0.88) 100%);
    backdrop-filter: blur(40px) saturate(200%);
    -webkit-backdrop-filter: blur(40px) saturate(200%);
    border-radius: 32px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    width: 98%;
    max-width: 1600px;
    max-height: 98vh; /* Limite la hauteur maximale */
    height: auto; /* Permet l'adaptation automatique */
    overflow-y: auto; /* ✅ DÉFILEMENT VERTICAL ACTIVÉ */
    overflow-x: hidden; /* Évite le défilement horizontal */
    box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.6),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
    animation: contentSlideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s both;
    display: flex;
    flex-direction: column;
    position: relative;
}

/* Effet de bordure lumineuse */
#newSaleModal .modal-content::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 32px;
    padding: 2px;
    background: linear-gradient(135deg, 
        rgba(106, 17, 203, 0.3), 
        rgba(37, 117, 252, 0.3), 
        transparent 30%,
        transparent 70%,
        rgba(106, 17, 203, 0.3));
    -webkit-mask: 
        linear-gradient(#fff 0 0) content-box, 
        linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
}

/* =======================
   STYLES MANQUANTS POUR LA PRESCRIPTION
   ======================= */

/* Styles pour la table desktop */
#newSaleModal .prescription-table.desktop-view {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
    backdrop-filter: blur(10px);
    border-radius: 20px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

#newSaleModal .prescription-table.desktop-view th {
    background: linear-gradient(135deg, rgba(106, 17, 203, 0.9), rgba(37, 117, 252, 0.9));
    color: white;
    padding: 18px 16px;
    font-weight: 700;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
}

#newSaleModal .prescription-table.desktop-view td {
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    padding: 16px;
    text-align: center;
    background: rgba(255, 255, 255, 0.5);
    transition: all 0.3s;
}

#newSaleModal .prescription-table.desktop-view select,
#newSaleModal .prescription-table.desktop-view input {
    width: 100%;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid rgba(106, 17, 203, 0.2);
    background: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
}

/* Styles pour la version mobile */
#newSaleModal .prescription-mobile.mobile-view .prescription-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

#newSaleModal .prescription-mobile.mobile-view .card-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(106, 17, 203, 0.2);
}

#newSaleModal .prescription-mobile.mobile-view .card-header h4 {
    margin: 0;
    color: #6a11cb;
    font-weight: 700;
    font-size: 1.2rem;
}

#newSaleModal .prescription-mobile.mobile-view .card-body {
    display: grid;
    gap: 15px;
}

#newSaleModal .prescription-mobile.mobile-view .mobile-form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#newSaleModal .prescription-mobile.mobile-view .mobile-form-group label {
    font-weight: 600;
    color: #4a5568;
    font-size: 0.9rem;
}

#newSaleModal .prescription-mobile.mobile-view .measures-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

#newSaleModal .prescription-mobile.mobile-view .measure-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#newSaleModal .prescription-mobile.mobile-view .measure-group label {
    font-weight: 600;
    color: #4a5568;
    font-size: 0.9rem;
    text-align: center;
}

/* Responsive breakpoints pour la prescription */
@media (min-width: 1025px) {
    #newSaleModal .prescription-table.desktop-view {
        display: table;
    }
    #newSaleModal .prescription-mobile.mobile-view {
        display: none;
    }
}

@media (max-width: 1024px) {
    #newSaleModal .prescription-table.desktop-view {
        display: none;
    }
    #newSaleModal .prescription-mobile.mobile-view {
        display: block;
    }
}
/* -----------------------
   HEADER AVEC GRADIENT ANIMÉ
   ----------------------- */
#newSaleModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 30px;
    background: 
        linear-gradient(135deg, 
            #667eea 0%,
            #764ba2 25%,
            #f093fb 50%,
            #f5576c 75%,
            #4facfe 100%);
    background-size: 400% 400%;
    animation: gradientShift 8s ease infinite;
    color: #fff;
    border-radius: 30px 30px 0 0;
    position: relative;
    overflow: hidden;
}

#newSaleModal .modal-header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
        radial-gradient(circle at 30% 20%, rgba(255,255,255,0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,0.2) 0%, transparent 50%);
}

#newSaleModal .modal-title {
    font-size: 1.8rem;
    font-weight: 800;
    background: linear-gradient(135deg, #fff, #e0f7ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
}

#newSaleModal .modal-close {
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    font-size: 1.3rem;
    color: white;
    cursor: pointer;
    width: 44px;
    height: 44px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 2;
}

#newSaleModal .modal-close:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 8px 25px rgba(255,255,255,0.3);
}

/* -----------------------
   STEPPER AVEC DESIGN 3D
   ----------------------- */
#newSaleModal .step-indicator {
    display: flex;
    justify-content: space-between;
    margin: 30px 40px;
    position: relative;
    padding: 0 20px;
}

#newSaleModal .step-indicator::before {
    content: '';
    position: absolute;
    top: 28px;
    left: 50px;
    right: 50px;
    height: 4px;
    background: 
        linear-gradient(90deg, 
            rgba(106, 17, 203, 0.3) 0%,
            rgba(37, 117, 252, 0.6) 50%,
            rgba(106, 17, 203, 0.3) 100%);
    border-radius: 2px;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(106, 17, 203, 0.2);
}

#newSaleModal .step {
    flex: 1;
    text-align: center;
    position: relative;
    z-index: 2;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#newSaleModal .step-number {
    width: 56px;
    height: 56px;
    border-radius: 18px;
    background: 
        linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    backdrop-filter: blur(10px);
    border: 2px solid rgba(106, 17, 203, 0.3);
    color: rgba(106, 17, 203, 0.7);
    font-weight: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 
        0 4px 20px rgba(106, 17, 203, 0.15),
        inset 0 1px 0 rgba(255,255,255,0.8);
    position: relative;
    overflow: hidden;
}

#newSaleModal .step-number::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(106, 17, 203, 0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s;
}

#newSaleModal .step.active .step-number {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    transform: scale(1.15) translateY(-5px);
    border-color: transparent;
    box-shadow: 
        0 8px 30px rgba(37, 117, 252, 0.4),
        0 2px 0 rgba(255,255,255,0.2) inset;
}

#newSaleModal .step.active .step-number::before {
    opacity: 1;
}

#newSaleModal .step-label {
    font-size: 0.9rem;
    color: #4a5568;
    font-weight: 600;
    transition: all 0.3s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#newSaleModal .step.active .step-label {
    color: #6a11cb;
    font-weight: 700;
    transform: translateY(2px);
}

/* -----------------------
   FORM SECTIONS AVEC DESIGN FLOATING
   ----------------------- */
#newSaleModal .form-step {
    display: none;
    padding: 30px 40px;
    animation: formSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#newSaleModal .form-step.active {
    display: block;
}

#newSaleModal .section-title {
    font-size: 1.5rem;
    font-weight: 800;
    margin-bottom: 25px;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding-left: 15px;
    position: relative;
}

#newSaleModal .section-title::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 6px;
    height: 30px;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    border-radius: 3px;
    box-shadow: 0 4px 12px rgba(106, 17, 203, 0.3);
}

/* -----------------------
   FORM GRID AVANCÉ
   ----------------------- */
#newSaleModal .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
}

#newSaleModal .form-group {
    position: relative;
}

#newSaleModal .form-group label {
    font-weight: 700;
    margin-bottom: 8px;
    display: block;
    color: #2d3748;
    font-size: 0.95rem;
    transition: all 0.3s;
}

/* Inputs avec design glassmorphism */
#newSaleModal input,
#newSaleModal select,
#newSaleModal textarea {
    width: 100%;
    padding: 16px 20px;
    border-radius: 16px;
    border: 2px solid transparent;
    font-size: 1rem;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.7));
    backdrop-filter: blur(10px);
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    position: relative;
}

#newSaleModal input:focus,
#newSaleModal select:focus,
#newSaleModal textarea:focus {
    border-color: #6a11cb;
    box-shadow: 
        0 8px 30px rgba(106, 17, 203, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
    outline: none;
}

/* Effet de lueur au focus */
#newSaleModal input:focus,
#newSaleModal select:focus,
#newSaleModal textarea:focus {
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.95),
            rgba(255, 255, 255, 0.8));
}

/* -----------------------
   TABLE PRESCRIPTION AVEC DESIGN MODERNE
   ----------------------- */
#newSaleModal .prescription-table-container {
    overflow-x: auto;
    margin: 25px 0;
    border-radius: 20px;
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.8),
            rgba(255, 255, 255, 0.6));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

#newSaleModal .prescription-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 700px;
}

#newSaleModal .prescription-table th {
    background: 
        linear-gradient(135deg, 
            rgba(106, 17, 203, 0.9),
            rgba(37, 117, 252, 0.9));
    color: white;
    padding: 18px 16px;
    font-weight: 700;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
}

#newSaleModal .prescription-table th::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s;
}

#newSaleModal .prescription-table th:hover::before {
    left: 100%;
}

#newSaleModal .prescription-table td {
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    padding: 16px;
    text-align: center;
    background: rgba(255, 255, 255, 0.5);
    transition: all 0.3s;
}

#newSaleModal .prescription-table tr:hover td {
    background: rgba(106, 17, 203, 0.03);
    transform: translateX(4px);
}

/* -----------------------
   PAYMENT CARDS AVEC EFFET 3D
   ----------------------- */
#newSaleModal .payment-card {
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.7));
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
}

#newSaleModal .payment-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #6a11cb, #2575fc);
    transform: scaleX(0);
    transition: transform 0.4s;
}

#newSaleModal .payment-card:hover::before {
    transform: scaleX(1);
}

#newSaleModal .payment-card:hover {
    transform: translateY(-5px);
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

#newSaleModal .payment-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
}

#newSaleModal .payment-label {
    font-weight: 700;
    margin-bottom: 8px;
    color: #4a5568;
    font-size: 0.95rem;
}

#newSaleModal .payment-value {
    font-weight: 800;
    font-size: 1.3rem;
    padding: 12px 16px;
    border-radius: 12px;
    background: 
        linear-gradient(135deg, 
            rgba(106, 17, 203, 0.1),
            rgba(37, 117, 252, 0.1));
    border: 1px solid rgba(106, 17, 203, 0.2);
    color: #6a11cb;
    box-shadow: 
        inset 0 1px 0 rgba(255, 255, 255, 0.6),
        0 2px 8px rgba(106, 17, 203, 0.1);
}

/* -----------------------
   BOUTONS AVEC MICRO-INTERACTIONS
   ----------------------- */
#newSaleModal .btn {
    padding: 16px 32px;
    border-radius: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: none;
    min-width: 140px;
    position: relative;
    overflow: hidden;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#newSaleModal .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.6s;
}

#newSaleModal .btn:hover::before {
    left: 100%;
}

#newSaleModal .btn-primary {
    background: 
        linear-gradient(135deg, 
            #6a11cb 0%,
            #2575fc 50%,
            #6a11cb 100%);
    background-size: 200% 200%;
    color: white;
    box-shadow: 
        0 8px 25px rgba(37, 117, 252, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

#newSaleModal .btn-primary:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 
        0 12px 35px rgba(37, 117, 252, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
    background-position: 100% 100%;
}

#newSaleModal .btn-secondary {
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.7));
    color: #4a5568;
    border: 2px solid rgba(106, 17, 203, 0.2);
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

#newSaleModal .btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    border-color: #6a11cb;
    color: #6a11cb;
}

/* -----------------------
   STEP NAVIGATION AVANCÉE
   ----------------------- */
#newSaleModal .step-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    padding: 0 40px 30px;
    gap: 15px;
}

/* -----------------------
   LOADER HOLOGRAPRHIQUE
   ----------------------- */
#newSaleModal .loader-overlay {
    position: fixed;
    inset: 0;
    background: 
        radial-gradient(circle at 30% 30%, rgba(106, 17, 203, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(37, 117, 252, 0.2) 0%, transparent 50%),
        rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(30px) saturate(180%);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 20000;
    animation: fadeIn 0.4s ease-out;
}

#newSaleModal .loader-overlay.active {
    display: flex;
}

#newSaleModal .loader-content {
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.95),
            rgba(255, 255, 255, 0.85));
    backdrop-filter: blur(40px);
    padding: 3rem;
    border-radius: 24px;
    text-align: center;
    max-width: 400px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    animation: contentSlideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

#newSaleModal .loader-spinner {
    border: 3px solid transparent;
    border-top: 3px solid #6a11cb;
    border-right: 3px solid #2575fc;
    border-bottom: 3px solid #6a11cb;
    border-left: 3px solid #2575fc;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1.5s linear infinite, colors 3s ease-in-out infinite;
    margin: 0 auto 1.5rem;
    position: relative;
}

#newSaleModal .loader-spinner::before {
    content: '';
    position: absolute;
    inset: -6px;
    border: 2px solid transparent;
    border-top: 2px solid #6a11cb;
    border-radius: 50%;
    animation: spin 2s linear infinite reverse;
}

/* -----------------------
   ANIMATIONS AVANCÉES
   ----------------------- */
@keyframes modalEntrance {
    0% { 
        opacity: 0; 
        backdrop-filter: blur(0px) saturate(100%);
    }
    100% { 
        opacity: 1; 
        backdrop-filter: blur(20px) saturate(180%);
    }
}

@keyframes contentSlideUp {
    0% { 
        opacity: 0; 
        transform: translateY(30px) scale(0.95);
    }
    100% { 
        opacity: 1; 
        transform: translateY(0) scale(1);
    }
}

@keyframes formSlideIn {
    0% { 
        opacity: 0; 
        transform: translateX(20px);
    }
    100% { 
        opacity: 1; 
        transform: translateX(0);
    }
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes colors {
    0%, 100% { 
        border-top-color: #6a11cb;
        border-right-color: #2575fc;
        border-bottom-color: #6a11cb;
        border-left-color: #2575fc;
    }
    25% { 
        border-top-color: #2575fc;
        border-right-color: #6a11cb;
        border-bottom-color: #2575fc;
        border-left-color: #6a11cb;
    }
    50% { 
        border-top-color: #f093fb;
        border-right-color: #f5576c;
        border-bottom-color: #f093fb;
        border-left-color: #f5576c;
    }
    75% { 
        border-top-color: #4facfe;
        border-right-color: #00f2fe;
        border-bottom-color: #4facfe;
        border-left-color: #00f2fe;
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn { 
    from { opacity: 0; } 
    to { opacity: 1; } 
}

/* =======================
   RESPONSIVE DESIGN 2025
   ======================= */
@media (max-width: 1200px) {
    #newSaleModal .modal-content {
        max-width: 95%;
    }
    
    #newSaleModal .form-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    #newSaleModal.modal-overlay {
        padding: 15px;
        align-items: flex-start;
        padding-top: 40px;
    }
    
    #newSaleModal .modal-content {
        width: 100%;
        max-height: 90vh;
        border-radius: 24px;
    }
    
    #newSaleModal .modal-header {
        padding: 20px 25px;
        border-radius: 24px 24px 0 0;
    }
    
    #newSaleModal .modal-title {
        font-size: 1.5rem;
    }
    
    #newSaleModal .step-indicator {
        margin: 20px 25px;
        padding: 0 10px;
    }
    
    #newSaleModal .step-number {
        width: 48px;
        height: 48px;
        border-radius: 14px;
    }
    
    #newSaleModal .step-label {
        font-size: 0.8rem;
    }
    
    #newSaleModal .form-step {
        padding: 20px 25px;
    }
    
    #newSaleModal .section-title {
        font-size: 1.3rem;
    }
    
    #newSaleModal .form-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    #newSaleModal .step-navigation {
        flex-direction: column;
        padding: 0 25px 25px;
    }
    
    #newSaleModal .btn {
        width: 100%;
        margin-bottom: 10px;
    }
}

@media (max-width: 480px) {
    #newSaleModal .modal-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    #newSaleModal .step-indicator::before {
        left: 30px;
        right: 30px;
        top: 24px;
    }
    
    #newSaleModal .step-number {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        font-size: 0.9rem;
    }
    
    #newSaleModal input,
    #newSaleModal select,
    #newSaleModal textarea {
        padding: 14px 16px;
    }
    
    #newSaleModal .payment-card {
        padding: 20px;
    }
    
    #newSaleModal .payment-row {
        grid-template-columns: 1fr;
    }
}

/* Support pour les appareils avec préférence de mouvement réduit */
@media (prefers-reduced-motion: reduce) {
    #newSaleModal * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
/* =======================
   PRESCRIPTION RESPONSIVE
   ======================= */

.prescription-container {
    margin: 25px 0;
}

/* Version desktop visible par défaut */
.prescription-table.desktop-view {
    display: table;
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
    backdrop-filter: blur(10px);
    border-radius: 20px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* Version mobile cachée par défaut */
.prescription-mobile.mobile-view {
    display: none;
}

/* Cartes pour la version mobile */
.prescription-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.prescription-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.card-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(106, 17, 203, 0.2);
}

.card-header h4 {
    margin: 0;
    color: #6a11cb;
    font-weight: 700;
    font-size: 1.2rem;
}

/* Corps des cartes */
.card-body {
    display: grid;
    gap: 15px;
}

.mobile-form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.mobile-form-group label {
    font-weight: 600;
    color: #4a5568;
    font-size: 0.9rem;
}

.mobile-form-group select,
.mobile-form-group input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 2px solid transparent;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

.mobile-form-group select:focus,
.mobile-form-group input:focus {
    border-color: #6a11cb;
    box-shadow: 0 8px 30px rgba(106, 17, 203, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.8);
    outline: none;
}

/* Grille pour les mesures */
.measures-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.measure-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.measure-group label {
    font-weight: 600;
    color: #4a5568;
    font-size: 0.9rem;
    text-align: center;
}

.measure-group input {
    text-align: center;
    padding: 12px;
}

/* Carte mesures spéciale */
.measures-card .card-header {
    text-align: center;
    border-bottom-color: rgba(37, 117, 252, 0.3);
}

.measures-card .card-header h4 {
    color: #2575fc;
}

/* Inputs plus petits pour desktop */
.small-input {
    padding: 8px 12px !important;
    text-align: center;
}

/* =======================
   RESPONSIVE BREAKPOINTS
   ======================= */

@media (max-width: 1024px) {
    .prescription-table.desktop-view {
        display: none;
    }
    
    .prescription-mobile.mobile-view {
        display: block;
    }
}

@media (max-width: 768px) {
    .prescription-card {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .card-body {
        gap: 12px;
    }
    
    .mobile-form-group select,
    .mobile-form-group input {
        padding: 10px 14px;
        font-size: 0.9rem;
    }
    
    .measures-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

@media (max-width: 480px) {
    .prescription-card {
        padding: 12px;
        border-radius: 16px;
    }
    
    .card-header {
        margin-bottom: 15px;
        padding-bottom: 12px;
    }
    
    .card-header h4 {
        font-size: 1.1rem;
    }
    
    .mobile-form-group select,
    .mobile-form-group input {
        padding: 8px 12px;
        font-size: 0.85rem;
    }
}

/* Support pour les appareils avec préférence de mouvement réduit */
@media (prefers-reduced-motion: reduce) {
    .prescription-card {
        transition: none;
    }
    
    .prescription-card:hover {
        transform: none;
    }
}
/* Cacher/montrer selon l'écran */
@media (min-width: 1025px) {
    .prescription-table.desktop-view {
        display: table;
    }
    .prescription-mobile.mobile-view {
        display: none;
    }
}

@media (max-width: 1024px) {
    .prescription-table.desktop-view {
        display: none;
    }
    .prescription-mobile.mobile-view {
        display: block;
    }
}




/* === OVERLAY ET MODAL === */
#productModal.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 2000;
}

#productModal.active {
  opacity: 1;
  pointer-events: auto;
}

#productModal .modal-content {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(15px);
  border-radius: 18px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  width: 100%;
  max-width: 600px;
  padding: 0;
  overflow: hidden;
  animation: slideDown 0.35s ease;
}

@keyframes slideDown {
  from { transform: translateY(-30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* === HEADER === */
#productModal .modal-header {
  background: linear-gradient(135deg, #4A90E2, #007AFF);
  color: #fff;
  padding: 14px 20px;
  font-size: 1.2rem;
  font-weight: 600;
}

#productModal .modal-title {
  margin: 0;
}

#productModal .modal-header i {
  margin-right: 8px;
}

/* === BODY === */
#productModal .modal-body {
  padding: 20px;
}

/* === FORM GROUP === */
#productModal .form-group {
  margin-bottom: 15px;
}

#productModal label {
  font-weight: 600;
  margin-bottom: 6px;
  display: block;
  font-size: 0.95rem;
  color: #333;
}

#productModal .required {
  color: #e74c3c;
}

/* === INPUTS & SELECT === */
#productModal .form-control,
#productModal select,
#productModal textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 10px;
  font-size: 0.95rem;
  transition: all 0.2s ease-in-out;
  background: rgba(255, 255, 255, 0.9);
}

#productModal .form-control:focus,
#productModal select:focus,
#productModal textarea:focus {
  border-color: #4A90E2;
  outline: none;
  box-shadow: 0 0 8px rgba(74, 144, 226, 0.2);
}

/* === SELECT + INPUT combo === */
#productModal .select-with-input {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

/* === BUTTONS === */
#productModal .btn {
  padding: 8px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s ease-in-out;
}

#productModal .btn-primary {
  background: linear-gradient(135deg, #4A90E2, #007AFF);
  color: #fff;
}

#productModal .btn-primary:hover {
  background: linear-gradient(135deg, #007AFF, #005FCC);
}

#productModal .btn-secondary {
  background: #f1f1f1;
  color: #333;
}

#productModal .btn-secondary:hover {
  background: #ddd;
}

#productModal .btn-small {
  font-size: 0.8rem;
  padding: 5px 8px;
  background: #eee;
  color: #333;
  border-radius: 6px;
}

#productModal .btn-small:hover {
  background: #ddd;
}

/* === LOADING INDICATOR === */
#productModal .loading-indicator {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1rem;
  color: #4A90E2;
}

/* === FOOTER === */
#productModal .modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 14px 20px;
  background: rgba(245, 245, 245, 0.9);
  border-top: 1px solid #eee;
}

/* === FORM MESSAGES === */
#productModal .form-message {
  margin-top: 10px;
  font-size: 0.9rem;
  display: none;
}

#productModal .form-message.success {
  display: block;
  color: #27ae60;
  font-weight: 600;
}

#productModal .form-message.error {
  display: block;
  color: #e74c3c;
  font-weight: 600;
}


/* === RESPONSIVE === */
@media (max-width: 600px) {
  #productModal .modal-content {
    width: 90%;
    max-width: none;
  }
}




/* Styles spécifiques pour la modal de dépense */
#depenseModal.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    backdrop-filter: blur(5px);
}

#depenseModal.modal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

#depenseModal .modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(20px);
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
}

#depenseModal.modal-overlay.active .modal-content {
    transform: translateY(0);
    opacity: 1;
}

#depenseModal .modal-header {
    padding: 1.5rem 1.5rem 1rem;
    border-bottom: 1px solid #e2e8f0;
    background: linear-gradient(135deg, #4361ee, #4895ef);
    color: white;
    border-radius: 12px 12px 0 0;
}

#depenseModal .modal-title {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
}

#depenseModal .modal-body {
    padding: 1.5rem;
}

#depenseModal .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    background: #f8fafc;
    border-radius: 0 0 12px 12px;
}

/* Styles du formulaire spécifique à depenseModal */
#depenseModal .form-group {
    margin-bottom: 1.25rem;
}

#depenseModal .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #1e293b;
}

#depenseModal .form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s, box-shadow 0.3s;
    background: white;
}

#depenseModal .form-control:focus {
    outline: none;
    border-color: #4361ee;
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

#depenseModal .select-control {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 2.5rem;
}

/* Messages du formulaire spécifiques */
#depenseModal #form-message {
    padding: 0.75rem 1rem;
    border-radius: 6px;
    margin-top: 1rem;
    font-size: 0.9rem;
    display: none;
}

#depenseModal #form-message.error {
    background-color: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
    display: block;
}

#depenseModal #form-message.success {
    background-color: rgba(74, 222, 128, 0.1);
    color: #4ade80;
    border: 1px solid rgba(74, 222, 128, 0.2);
    display: block;
}

/* Indicateur requis spécifique */
#depenseModal .required {
    color: #ef4444;
}

/* Styles responsives spécifiques */
@media (max-width: 768px) {
    #depenseModal .modal-content {
        width: 95%;
        margin: 1rem;
    }
    
    #depenseModal .modal-header {
        padding: 1.25rem 1.25rem 0.75rem;
    }
    
    #depenseModal .modal-body {
        padding: 1.25rem;
    }
    
    #depenseModal .modal-footer {
        padding: 1rem 1.25rem;
        flex-direction: column;
    }
    
    #depenseModal .modal-footer .btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    #depenseModal .modal-content {
        width: 100%;
        margin: 0.5rem;
        border-radius: 12px;
    }
    
    #depenseModal .modal-header {
        padding: 1rem 1rem 0.5rem;
    }
    
    #depenseModal .modal-body {
        padding: 1rem;
    }
    
    #depenseModal .form-group {
        margin-bottom: 1rem;
    }
    
    #depenseModal .form-control {
        padding: 0.65rem 0.75rem;
    }
}

/* Animation d'entrée spécifique */
@keyframes depenseModalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

#depenseModal.modal-overlay.active .modal-content {
    animation: depenseModalSlideIn 0.3s ease-out;
}

/* Amélioration de l'accessibilité spécifique */
#depenseModal .modal-content:focus {
    outline: none;
}

#depenseModal .form-control:invalid {
    border-color: #ef4444;
}

#depenseModal .form-control:valid {
    border-color: #4ade80;
}

/* Style pour les options du select spécifique */
#depenseModal .select-control option {
    padding: 0.5rem;
}

/* Hover states spécifiques */
#depenseModal .btn:hover {
    transform: translateY(-1px);
}

#depenseModal .form-control:hover {
    border-color: #4361ee;
}

/* Styles pour les champs spécifiques de la dépense */
#depenseDate,
#depenseAgence,
#depenseDesignation,
#depenseCategorie,
#depenseMontant {
    font-family: 'Montserrat', sans-serif;
}

#depenseMontant {
    font-weight: 600;
    color: #1e293b;
}

/* Style spécial pour le champ montant */
#depenseMontant::placeholder {
    color: #94a3b8;
    font-weight: normal;
}

/* Focus personnalisé pour les champs de dépense */
#depenseModal .form-control:focus {
    border-color: #4361ee;
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    background-color: #f8fafc;
}

</style>
    <style>
        /* Nouveaux styles pour le téléchargement */
        .download-app-btn {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        .download-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .download-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .download-steps {
            text-align: left;
            margin: 20px 0;
        }

        .download-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 10px;
        }

        .step-number {
            background: #4361ee;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            flex-shrink: 0;
        }

        .download-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-primary {
            background: #4361ee;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }



/* Styles pour les tooltips */
.has-tooltip {
    position: relative;
    cursor: pointer;
}

.custom-tooltip {
    position: fixed;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-size: 12px;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    animation: tooltipFadeIn 0.3s ease;
    pointer-events: none;
    max-width: 250px;
}

.client-tooltip {
    line-height: 1.4;
}

.tooltip-header {
    font-weight: 600;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    font-size: 13px;
}

.tooltip-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.tooltip-row:last-child {
    margin-bottom: 0;
}

.tooltip-label {
    font-weight: 500;
    margin-right: 8px;
    opacity: 0.9;
}

.tooltip-value {
    font-weight: 600;
    text-align: right;
}

.tooltip-value.amount {
    color: #4ade80; /* Vert pour le montant total */
}

.tooltip-value.rest {
    color: #f87171; /* Rouge pour le reste à payer */
}

/* Animation d'apparition */
@keyframes tooltipFadeIn {
    from {
        opacity: 0;
        transform: translateY(5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Flèche du tooltip */
.custom-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 20px;
    border-width: 5px;
    border-style: solid;
    border-color: #667eea transparent transparent transparent;
}


/* -----------------------
   CONFIRMATION MODAL STYLES
   ----------------------- */
.confirmation-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 30000;
    animation: fadeIn 0.3s ease;
}

.confirmation-box {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    width: 90%;
    text-align: center;
    animation: slideUp 0.3s ease;
}

.confirmation-box h3 {
    color: #2d3748;
    margin-bottom: 1rem;
    font-size: 1.4rem;
}

.confirmation-box p {
    color: #4a5568;
    margin-bottom: 2rem;
    line-height: 1.5;
}

.confirmation-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.confirmation-box .btn {
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    min-width: 120px;
}

.btn-confirm {
    background: linear-gradient(135deg, #4ade80, #22c55e);
    color: white;
}

.btn-cancel {
    background: #f1f5f9;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.btn-confirm:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
}

.btn-cancel:hover {
    background: #e2e8f0;
}

/* Loading spinner dans la confirmation */
.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f1f5f9;
    border-top: 3px solid #4ade80;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 1rem auto;
    display: none;
}

.confirmation-box.loading .loading-spinner {
    display: block;
}

.confirmation-box.loading .confirmation-buttons {
    opacity: 0.5;
    pointer-events: none;
}

/* -----------------------
   LOADING BAR STYLES
   ----------------------- */
.loading-bar-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: rgba(255, 255, 255, 0.1);
    z-index: 40000;
    display: none;
}

.loading-bar {
    height: 100%;
    background: linear-gradient(90deg, #6a11cb, #2575fc, #4ade80);
    width: 0%;
    transition: width 0.4s ease;
    position: relative;
    overflow: hidden;
}

.loading-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
    animation: shimmer 1.5s infinite;
}

/* -----------------------
   STATUS MESSAGE STYLES
   ----------------------- */
.status-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(15px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 35000;
    animation: fadeIn 0.3s ease;
}

.status-content {
    background: white;
    padding: 2.5rem;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
}

.status-content.success {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
}

.status-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid #f1f5f9;
    border-top: 3px solid #6a11cb;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

.status-icon {
    font-size: 3rem;
    color: #22c55e;
    margin-bottom: 1rem;
}

.status-content h3 {
    color: #1f2937;
    margin-bottom: 0.5rem;
    font-size: 1.3rem;
}

.status-content p {
    color: #6b7280;
    line-height: 1.5;
}

/* -----------------------
   SUCCESS/ERROR MESSAGE STYLES
   ----------------------- */
.success-message, .error-message {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    color: white;
    font-weight: 600;
    z-index: 25000;
    animation: slideInRight 0.3s ease;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    display: none;
}

.success-message {
    background: linear-gradient(135deg, #4ade80, #22c55e);
}

.error-message {
    background: linear-gradient(135deg, #f87171, #ef4444);
}

.success-message i, .error-message i {
    margin-right: 0.5rem;
}

/* -----------------------
   ANIMATIONS
   ----------------------- */
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes shimmer {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(200%);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
    </style>
  

</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <img src="logoAppli.png" alt="Logo" class="logo-image">
                    <span class="logo-text">VisionPro</span>
                </div>
            </div>
            
            <nav class="menu">
                <!-- Menu items -->
                <div class="menu-item">
                    <a class="menu-link">
                        <div class="menu-icon"><i class="fas fa-chart-pie"></i></div>
                        <span class="menu-text">Tableau de bord</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openVueGlobale()">
                            <div class="submenu-icon"><i class="fas fa-globe-americas"></i></div>
                            <span>Vue Globale</span>
                        </a>
                        <a href="#" onclick="openLooker()">
                            <div class="submenu-icon"><i class="fas fa-chart-bar"></i></div>
                            <span>Statistiques</span>
                        </a>
                    </div>
                </div>
                
                <div class="menu-item active">
                    <a class="menu-link">
                        <div class="menu-icon"><i class="fas fa-shopping-cart"></i></div>
                        <span class="menu-text">Gestion des Ventes</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openDataCleint()">
                            <div class="submenu-icon"><i class="fas fa-plus-circle"></i></div>
                            <span>Liste des Clients</span>
                            <span class="menu-badge">Data</span>
                        </a>
                        <a href="#" onclick="openProforma()">
                            <div class="submenu-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                            <span>Facture Proforma</span>
                        </a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <div class="menu-icon"><i class="fas fa-boxes"></i></div>
                        <span class="menu-text">Gestion Stock</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openProductEntryForm()">
                            <div class="submenu-icon"><i class="fas fa-dolly"></i></div>
                            <span>Entrée Stock</span>
                        </a>
                        <a href="#" onclick="openDataProduit()">
                            <div class="submenu-icon"><i class="fas fa-clipboard-list"></i></div>
                            <span>Inventaire</span>
                        </a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <div class="menu-icon"><i class="fas fa-shield-alt"></i></div>
                        <span class="menu-text">Assurances</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openDatafacture()">
                            <div class="submenu-icon"><i class="fas fa-file-medical"></i></div>
                            <span>Facturation TP</span>
                        </a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <div class="menu-icon"><i class="fas fa-cash-register"></i></div>
                        <span class="menu-text">Gestion de Caisse</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <div class="submenu-section">
                            <div class="submenu-header">
                                <i class="fas fa-wallet"></i>
                                <span>Caisses Physiques</span>
                            </div>
                            <a href="#" onclick="openCaisse()">
                                <div class="submenu-icon"><i class="fas fa-map-marker-alt"></i></div>
                                <span>Caisse</span>
                                <span class="menu-status online"></span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link" onclick="toggleAdminMenu(event)">
                        <div class="menu-icon"><i class="fas fa-user-cog"></i></div>
                        <span class="menu-text">Administration</span>
                        <i class="fas fa-chevron-down chevron"></i>
                        <span class="card-badge trending">Admin</span>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openAdmin()">
                            <div class="submenu-icon"><i class="fas fa-chevron-down chevron"></i></div>
                            <span>Administration</span>
                        </a>
                    </div>
                </div>
            </nav>
        
        <!-- Footer de la sidebar -->
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="profile-avatar">
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="Admin" class="profile-img">
                    <div class="online-status"></div>
                </div>
                <div class="profile-info">
                    <span class="profile-name" id="username-display"></span>
                    <span class="profile-role">
                        <i class="fas fa-circle"></i>
                        Session active
                    </span>
                    <button class="download-app-btn" onclick="showDownloadModal()">
                        <i class="fas fa-mobile-alt"></i>
                        <span>Mobile</span>
                    </button>
                </div>
            </div>
            <div class="footer-actions">
                <button class="logout-btn" id="logout-btn" title="Déconnexion">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

    <div class="main">
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Mon Espace</h1>
            </div>
            
            <div class="user-info">             
                <div class="user-profile">
                    <div class="profile-info">
                        <span class="profile-role">
                            <i class="fas fa-circle"></i>
                            Session active
                        </span>
                    </div>
                </div>
            </div>
        </header>
        
        <section class="dashboard-section">
            <div class="dashboard-header">
                <h1>Tableau de bord</h1>
            </div>

            <div class="quick-actions">
                <button class="quick-action-card" onclick="openNewSale()">
                    <div class="card-icon">
                        <i class="fas fa-cart-plus"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-title">Nouvelle Vente</span>
                        <span class="card-desc">Ajouter une Nouvelle Vente</span>
                    </div>
                    <div class="card-badge">+</div>
                </button>
                
                <button class="quick-action-card" onclick="openDepense()">
                    <div class="card-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-title">Dépense</span>
                        <span class="card-desc">Sortie de caisse</span>
                    </div>
                </button>
                
                <button class="quick-action-card" onclick="openDevis()">
                    <div class="card-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-title">Proforma</span>
                        <span class="card-desc">Créer un devis</span>
                    </div>
                </button>
                
                <button class="quick-action-card" onclick="openLooker()">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-title">Analytics</span>
                        <span class="card-desc">Tableaux de bord</span>
                    </div>
                    <div class="card-badge trending">Admin</div>
                </button>
            </div>
            
            <div class="dashboard-grid">
                <!-- Section Liste des Clients -->
                <div class="card clients-card">
                    <div class="card-header">
                        <div class="header-content">
                            <h2 class="section-title">
                                <div class="title-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <span>Liste des Clients</span>
                            </h2>
                            <div class="header-actions">
                                <div class="search-container">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" id="searchInput" placeholder="Rechercher ID..." />
                                    <div class="search-focus-line"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <div id="loading-indicator" class="loading-indicator">
                            <div class="loading-animation">
                                <div class="loading-spinner"></div>
                                <div class="loading-pulse"></div>
                            </div>
                            <p>Chargement des données clients...</p>
                            <div class="loading-progress">
                                <div class="progress-bar"></div>
                            </div>
                        </div>
                        
                        <div id="error-message" class="error-message">
                            <div class="error-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="error-content">
                                <h3>Erreur de chargement</h3>
                                <p>Impossible de charger les données clients</p>
                            </div>
                            <button class="retry-btn">Réessayer</button>
                        </div>

                        <div id="table-container" class="table-container">
                            <div class="table-responsive">
                                <table id="client-table" class="modern-table">
                                    <thead>
                                        <!-- Les données seront injectées ici -->
                                    </thead>
                                    <tbody>
                                        <!-- Les données seront injectées ici -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="table-overlay">
                                <div class="empty-state">
                                    <i class="fas fa-users-slash"></i>
                                    <h3>Aucun client trouvé</h3>
                                    <p>Aucune donnée ne correspond à votre recherche</p>
                                </div>
                            </div>
                        </div>

                        <div class="pagination-controls">
                            <div class="pagination-info" id="page-info">
                                <!-- Les données seront injectées ici -->
                            </div>
                            <div class="pagination-navigation">
                                <button class="pagination-btn prev-btn" id="prevPage" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                    <span>Précédent</span>
                                </button>
                                <button class="pagination-btn next-btn" id="nextPage">
                                    <span>Suivant</span>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="items-per-page">
                                <span class="per-page-label">Ligne:</span>
                                <div class="select-wrapper">
                                    <select id="itemsPerPageSelect" class="modern-select">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                    </select>
                                    <i class="fas fa-chevron-down select-arrow"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Graphiques -->
                <div class="card charts-card">
                    <div class="card-header">
                        <div class="header-content">
                            <h2 class="section-title">
                                <div class="title-icon">
                                    <i class="fas fa-chart-area"></i>
                                </div>
                                <span>Analytiques</span>
                            </h2>
                            <div class="header-actions">
                                <div class="chart-period-selector">
                                    <select id="chartPeriod" class="modern-select">
                                        <option value="today">Aujourd'hui</option>
                                        <option value="thisWeek">Cette semaine</option>
                                        <option value="lastWeek">Semaine passée</option>
                                        <option value="thisMonth" selected>Ce mois</option>
                                        <option value="lastMonth">Le mois passé</option>
                                        <option value="thisYear">Cette année</option>
                                        <option value="lastYear">L'année passée</option>
                                    </select>
                                    <i class="fas fa-chevron-down select-arrow"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="charts-container">
                            <!-- Graphique des ventes -->
                            <div class="chart-section">
                                <div class="chart-header">
                                    <h3>Évolution du Chiffre d'Affaires</h3>
                                    <div class="chart-stats">
                                        <div class="stat-item">
                                            <span class="stat-value" id="totalCA">0 </span>
                                            <span class="stat-label">CA Total</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>

                            <!-- Tableaux de données -->
                            <div class="data-tables-grid">
                                <div class="data-table-section">
                                    <h4>Performance par Agence</h4>
                                    <div class="table-responsive">
                                        <table class="modern-table stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Agence</th>
                                                    <th>CA Période</th>
                                                    <th>CA Précédent</th>
                                                    <th>Évolution</th>
                                                </tr>
                                            </thead>
                                            <tbody id="agencyStatsBody">
                                                <!-- Données injectées dynamiquement -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="data-table-section">
                                    <h4>Indicateurs Clés</h4>
                                    <div class="table-responsive">
                                        <table class="modern-table stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Indicateur</th>
                                                    <th>Valeur</th>
                                                    <th>Évolution</th>
                                                </tr>
                                            </thead>
                                            <tbody id="keyMetricsBody">
                                                <!-- Données injectées dynamiquement -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
                    <div id="vente-loader" class="menu-loader">
                        <div class="loader-spinner"></div>
                        <span id="vente-status">Chargement...</span>
                    </div>
<div id="tooltip-container"></div>
<div id="modal-container"></div>
    <!-- Modale Proforma -->
    
<div class="modal-overlay" id="proformaModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Facture Proforma</h3>
        </div>
        <div class="modal-body">
            <div class="form-container">
                <form id="client-form" method="POST"> 
                    <!-- Stepper Navigation -->
                    <div class="stepper">
                        <div class="step active" id="step1">
                            <div class="step-number">1</div>
                            <div class="step-label">Informations Client</div>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <div class="step-label">Prescription</div>
                        </div>
                        <div class="step" id="step4">
                            <div class="step-number">3</div>
                            <div class="step-label">Paiement</div>
                        </div>
                    </div>
                    
                    <!-- Step 1: Client Information -->
                    <div class="form-section active" id="section1">
                        <h2 class="section-title">INFORMATION CLIENT</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nom_complet" class="required-field">Nom complet du client</label>
                                <input type="text" name="nom_complet" id="nom_complet" required />
                            </div>

                            <div class="form-group">
                                <label class="required-field">Contact</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" name="indicatif" placeholder="+229" value="+229" style="width: 70px;" required/>
                                    <input type="tel" name="numero" placeholder="012345678"  />
                                </div>
                            </div>
                         </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="date_naissance" class="required-field">Né le</label>
                                <input type="date" name="date_naissance" id="date_naissance" />
                            </div>
                        

                        
                            <div class="form-group">
                                <label for="civilite" class="required-field">Civilité</label>
                                <select name="civilite" id="civilite" >
                                    <option value="M.">M.</option>
                                    <option value="Mme">Mme</option>
                                    <option value="Mlle">Mlle</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-navigation">
                            <button type="button" class="btn btn-secondary" id="cancelButton">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                            <button type="button" class="btn btn-primary next-step" data-next="2">
                                Suivant <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Prescription -->
                    <div class="form-section" id="section2">
                        <h2 class="section-title">PRESCRIPTION ET COMMANDE</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="type_verre" class="required-field">Type de Verre</label>
                                <select name="type_verre" id="type_verre" >
                                    <option value="">-- Sélectionnez --</option>
<option value="ACHAT MONTURE">ACHAT MONTURE</option>
<option value="ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE 1.6 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE 1.6 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE1.56 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  BLANC/ ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER BLANC/ ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE1.56 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  BLANC/ ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER BLANC/ ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>      </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="gamme_verre" class="required-field">Gamme des Verres</label>
                                <select name="gamme_verre" id="gamme_verre" >
                                  <option value="MOYEN DE GAMME">MOYEN DE GAMME</option>
                                    <option value="ENTREE DE GAMME">ENTREE DE GAMME</option>
                              
                                    <option value="HAUT DE GAMME">HAUT DE GAMME</option>
                                    
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="choix_monture" class="required-field">Choix de Monture</label>
                              <input type="text"  name="choixmonture" id="choixmonture"  />
                                
                            </div>
                        </div>

                        <div class="prescription-table-container">
                            <table class="prescription-table">
                                <thead>
                                    <tr>
                                        <th>Œil</th>
                                        <th>Sphere</th>
                                        <th>Cylindre</th>
                                        <th>Axe</th>
                                        <th>ADD</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr>
                                        <td>OD</td>
                                        <td>
                                            <select name="od_sphere" >
                                                <option value="0.00">0.00</option>
                                                <option value="+0.25">+0.25</option>
                                                <option value="+0.50">+0.50</option>
                                                <option value="+0.75">+0.75</option>
                                                <option value="+1.00">+1.00</option>
                                                <option value="+1.25">+1.25</option>
                                                <option value="+1.50">+1.50</option>
                                                <option value="+1.75">+1.75</option>
                                                <option value="+2.00">+2.00</option>
                                                <option value="+2.25">+2.25</option>
                                                <option value="+2.50">+2.50</option>
                                                <option value="+2.75">+2.75</option>
                                                <option value="+3.00">+3.00</option>
                                                <option value="+3.25">+3.25</option>
                                                <option value="+3.50">+3.50</option>
                                                <option value="+3.75">+3.75</option>
                                                <option value="+4.00">+4.00</option>
                                                <option value="+4.25">+4.25</option>
                                                <option value="+4.50">+4.50</option>
                                                <option value="+4.75">+4.75</option>
                                                <option value="+5.00">+5.00</option>
                                                <option value="+5.25">+5.25</option>
                                                <option value="+5.50">+5.50</option>
                                                <option value="+5.75">+5.75</option>
                                                <option value="+6.00">+6.00</option>
                                                <option value="+6.25">+6.25</option>
                                                <option value="+6.50">+6.50</option>
                                                <option value="+6.75">+6.75</option>
                                                <option value="+7.00">+7.00</option>
                                                <option value="+7.25">+7.25</option>
                                                <option value="+7.50">+7.50</option>
                                                <option value="+7.75">+7.75</option>
                                                <option value="+8,00">+8,00</option>
                                                <option value="+8.25">+8.25</option>
                                                <option value="+8.50">+8.50</option>
                                                <option value="+8.75">+8.75</option>
                                                <option value="+9.00">+9.00</option>
                                                <option value="+9.25">+9.25</option>
                                                <option value="+9.50">+9.50</option>
                                                <option value="+9.75">+9.75</option>
                                                <option value="+10,00">+10.00</option>
                                                <option value="+10.25">+10.25</option>
                                                <option value="+10.5">+10.5</option>
                                                <option value="+10.75">+10.75</option>
                                                <option value="+11,00">+11.00</option>
                                                <option value="+11.25">+11.25</option>
                                                <option value="+11.50">+11.50</option>
                                                <option value="+11.75">+11.75</option>
                                                <option value="+12,00">+12,00</option>
                                                <option value="-0.25">-0.25</option>
                                                <option value="-0.50">-0.50</option>
                                                <option value="-0.75">-0.75</option>
                                                <option value="-1.00">-1.00</option>
                                                <option value="-1.25">-1.25</option>
                                                <option value="-1.50">-1.50</option>
                                                <option value="-1.75">-1.75</option>
                                                <option value="-2.00">-2.00</option>
                                                <option value="-2.25">-2.25</option>
                                                <option value="-2.50">-2.50</option>
                                                <option value="-2.75">-2.75</option>
                                                <option value="-3.00">-3.00</option>
                                                <option value="-3.25">-3.25</option>
                                                <option value="-3.50">-3.50</option>
                                                <option value="-3.75">-3.75</option>
                                                <option value="-4.00">-4.00</option>
                                                <option value="-4.25">-4.25</option>
                                                <option value="-4.50">-4.50</option>
                                                <option value="-4.75">-4.75</option>
                                                <option value="-5.00">-5.00</option>
                                                <option value="-5.25">-5.25</option>
                                                <option value="-5.50">-5.50</option>
                                                <option value="-5.75">-5.75</option>
                                                <option value="-6.00">-6.00</option>
                                                <option value="-6.25">-6.25</option>
                                                <option value="-6.50">-6.50</option>
                                                <option value="-6.75">-6.75</option>
                                                <option value="-7.00">-7.00</option>
                                                <option value="-7.25">-7.25</option>
                                                <option value="-7.50">-7.50</option>
                                                <option value="-7.75">-7.75</option>
                                                <option value="-8.00">-8.00</option>
                                                <option value="-8.25">-8.25</option>
                                                <option value="-8.50">-8.50</option>
                                                <option value="-8.75">-8.75</option>
                                                <option value="-9.00">-9.00</option>
                                                <option value="-9.25">-9.25</option>
                                                <option value="-9.50">-9.50</option>
                                                <option value="-9.75">-9.75</option>
                                                <option value="-10.00">-10.00</option>
                                                <option value="-10.25">-10.25</option>
                                                <option value="-10.50">-10.50</option>
                                                <option value="-10.75">-10.75</option>
                                                <option value="-11.00">-11.00</option>
                                                <option value="-11.25">-11.25</option>
                                                <option value="-11.50">-11.50</option>
                                                <option value="-11.75">-11.75</option>
                                                <option value="-12.00">-12.00</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_cylindre">
                                                <option value="0.00">0.00</option>
                                                <option value="+0.25">+0.25</option>
                                                <option value="+0.50">+0.50</option>
                                                <option value="+0.75">+0.75</option>
                                                <option value="+1.00">+1.00</option>
                                                <option value="+1.25">+1.25</option>
                                                <option value="+1.50">+1.50</option>
                                                <option value="+1.75">+1.75</option>
                                                <option value="+2.00">+2.00</option>
                                                <option value="+2.25">+2.25</option>
                                                <option value="+2.50">+2.50</option>
                                                <option value="+2.75">+2.75</option>
                                                <option value="+3.00">+3.00</option>
                                                <option value="+3.25">+3.25</option>
                                                <option value="+3.50">+3.50</option>
                                                <option value="+3.75">+3.75</option>
                                                <option value="+4.00">+4.00</option>
                                                <option value="+4.25">+4.25</option>
                                                <option value="+4.50">+4.50</option>
                                                <option value="+4.75">+4.75</option>
                                                <option value="+5.00">+5.00</option>
                                                <option value="+5.25">+5.25</option>
                                                <option value="+5.50">+5.50</option>
                                                <option value="+5.75">+5.75</option>
                                                <option value="+6.00">+6.00</option>
                                                <option value="+6.25">+6.25</option>
                                                <option value="+6.50">+6.50</option>
                                                <option value="+6.75">+6.75</option>
                                                <option value="+7.00">+7.00</option>
                                                <option value="+7.25">+7.25</option>
                                                <option value="+7.50">+7.50</option>
                                                <option value="+7.75">+7.75</option>
                                                <option value="+8,00">+8,00</option>
                                                <option value="+8.25">+8.25</option>
                                                <option value="+8.50">+8.50</option>
                                                <option value="+8.75">+8.75</option>
                                                <option value="+9.00">+9.00</option>
                                                <option value="+9.25">+9.25</option>
                                                <option value="+9.50">+9.50</option>
                                                <option value="+9.75">+9.75</option>
                                                <option value="+10,00">+10,00</option>
                                                <option value="+10.25">+10.25</option>
                                                <option value="+10.5">+10.5</option>
                                                <option value="+10.75">+10.75</option>
                                                <option value="+11,00">+11,00</option>
                                                <option value="+11.25">+11.25</option>
                                                <option value="+11.50">+11.50</option>
                                                <option value="+11.75">+11.75</option>
                                                <option value="+12,00">+12,00</option>
                                                <option value="-0.25">-0.25</option>
                                                <option value="-0.50">-0.50</option>
                                                <option value="-0.75">-0.75</option>
                                                <option value="-1.00">-1.00</option>
                                                <option value="-1.25">-1.25</option>
                                                <option value="-1.50">-1.50</option>
                                                <option value="-1.75">-1.75</option>
                                                <option value="-2.00">-2.00</option>
                                                <option value="-2.25">-2.25</option>
                                                <option value="-2.50">-2.50</option>
                                                <option value="-2.75">-2.75</option>
                                                <option value="-3.00">-3.00</option>
                                                <option value="-3.25">-3.25</option>
                                                <option value="-3.50">-3.50</option>
                                                <option value="-3.75">-3.75</option>
                                                <option value="-4.00">-4.00</option>
                                                <option value="-4.25">-4.25</option>
                                                <option value="-4.50">-4.50</option>
                                                <option value="-4.75">-4.75</option>
                                                <option value="-5.00">-5.00</option>
                                                <option value="-5.25">-5.25</option>
                                                <option value="-5.50">-5.50</option>
                                                <option value="-5.75">-5.75</option>
                                                <option value="-6.00">-6.00</option>
                                                <option value="-6.25">-6.25</option>
                                                <option value="-6.50">-6.50</option>
                                                <option value="-6.75">-6.75</option>
                                                <option value="-7.00">-7.00</option>
                                                <option value="-7.25">-7.25</option>
                                                <option value="-7.50">-7.50</option>
                                                <option value="-7.75">-7.75</option>
                                                <option value="-8.00">-8.00</option>
                                                <option value="-8.25">-8.25</option>
                                                <option value="-8.50">-8.50</option>
                                                <option value="-8.75">-8.75</option>
                                                <option value="-9.00">-9.00</option>
                                                <option value="-9.25">-9.25</option>
                                                <option value="-9.50">-9.50</option>
                                                <option value="-9.75">-9.75</option>
                                                <option value="-10.00">-10.00</option>
                                                <option value="-10.25">-10.25</option>
                                                <option value="-10.50">-10.50</option>
                                                <option value="-10.75">-10.75</option>
                                                <option value="-11.00">-11.00</option>
                                                <option value="-11.25">-11.25</option>
                                                <option value="-11.50">-11.50</option>
                                                <option value="-11.75">-11.75</option>
                                                <option value="-12.00">-12.00</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_axe">
                                                <option value="0°">0°</option>
                                                <option value="5°">5°</option>
                                                <option value="10°">10°</option>
                                                <option value="15°">15°</option>
                                                <option value="20°">20°</option>
                                                <option value="25°">25°</option>
                                                <option value="30°">30°</option>
                                                <option value="35°">35°</option>
                                                <option value="40°">40°</option>
                                                <option value="45°">45°</option>
                                                <option value="50°">50°</option>
                                                <option value="55°">55°</option>
                                                <option value="60°">60°</option>
                                                <option value="65°">65°</option>
                                                <option value="70°">70°</option>
                                                <option value="75°">75°</option>
                                                <option value="80°">80°</option>
                                                <option value="85°">85°</option>
                                                <option value="90°">90°</option>
                                                <option value="95°">95°</option>
                                                <option value="100°">100°</option>
                                                <option value="105°">105°</option>
                                                <option value="110°">110°</option>
                                                <option value="115°">115°</option>
                                                <option value="120°">120°</option>
                                                <option value="125°">125°</option>
                                                <option value="130°">130°</option>
                                                <option value="135°">135°</option>
                                                <option value="140°">140°</option>
                                                <option value="145°">145°</option>
                                                <option value="150°">150°</option>
                                                <option value="155°">155°</option>
                                                <option value="160°">160°</option>
                                                <option value="165°">165°</option>
                                                <option value="170°">170°</option>
                                                <option value="175°">175°</option>
                                                <option value="180°">180°</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_add">
                                                    <option value="0.00">0.00</option>
                                                    <option value="+0.50">+0.50</option>
                                                    <option value="+0.75">+0.75</option>
                                                    <option value="+1.00">+1.00</option>
                                                    <option value="+1.25">+1.25</option>
                                                    <option value="+1.50">+1.50</option>
                                                    <option value="+1.75">+1.75</option>
                                                    <option value="+2.00">+2.00</option>
                                                    <option value="+2.25">+2.25</option>
                                                    <option value="+2.50">+2.50</option>
                                                    <option value="+2.75">+2.75</option>
                                                    <option value="+3.00">+3.00</option>
                                                    <option value="+3.25">+3.25</option>
                                                    <option value="+3.50">+3.50</option>
                                                    <option value="+3.75">+3.75</option>
                                                    <option value="+4.00">+4.00</option>
                                            </select>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td>OG</td>
                                        <td>
                                            <select name="og_sphere" >
                                                <option value="0.00">0.00</option>
                                                <option value="+0.25">+0.25</option>
                                                <option value="+0.50">+0.50</option>
                                                <option value="+0.75">+0.75</option>
                                                <option value="+1.00">+1.00</option>
                                                <option value="+1.25">+1.25</option>
                                                <option value="+1.50">+1.50</option>
                                                <option value="+1.75">+1.75</option>
                                                <option value="+2.00">+2.00</option>
                                                <option value="+2.25">+2.25</option>
                                                <option value="+2.50">+2.50</option>
                                                <option value="+2.75">+2.75</option>
                                                <option value="+3.00">+3.00</option>
                                                <option value="+3.25">+3.25</option>
                                                <option value="+3.50">+3.50</option>
                                                <option value="+3.75">+3.75</option>
                                                <option value="+4.00">+4.00</option>
                                                <option value="+4.25">+4.25</option>
                                                <option value="+4.50">+4.50</option>
                                                <option value="+4.75">+4.75</option>
                                                <option value="+5.00">+5.00</option>
                                                <option value="+5.25">+5.25</option>
                                                <option value="+5.50">+5.50</option>
                                                <option value="+5.75">+5.75</option>
                                                <option value="+6.00">+6.00</option>
                                                <option value="+6.25">+6.25</option>
                                                <option value="+6.50">+6.50</option>
                                                <option value="+6.75">+6.75</option>
                                                <option value="+7.00">+7.00</option>
                                                <option value="+7.25">+7.25</option>
                                                <option value="+7.50">+7.50</option>
                                                <option value="+7.75">+7.75</option>
                                                <option value="+8,00">+8,00</option>
                                                <option value="+8.25">+8.25</option>
                                                <option value="+8.50">+8.50</option>
                                                <option value="+8.75">+8.75</option>
                                                <option value="+9.00">+9.00</option>
                                                <option value="+9.25">+9.25</option>
                                                <option value="+9.50">+9.50</option>
                                                <option value="+9.75">+9.75</option>
                                                <option value="+10,00">+10,00</option>
                                                <option value="+10.25">+10.25</option>
                                                <option value="+10.5">+10.5</option>
                                                <option value="+10.75">+10.75</option>
                                                <option value="+11,00">+11,00</option>
                                                <option value="+11.25">+11.25</option>
                                                <option value="+11.50">+11.50</option>
                                                <option value="+11.75">+11.75</option>
                                                <option value="+12,00">+12,00</option>
                                                <option value="-0.25">-0.25</option>
                                                <option value="-0.50">-0.50</option>
                                                <option value="-0.75">-0.75</option>
                                                <option value="-1.00">-1.00</option>
                                                <option value="-1.25">-1.25</option>
                                                <option value="-1.50">-1.50</option>
                                                <option value="-1.75">-1.75</option>
                                                <option value="-2.00">-2.00</option>
                                                <option value="-2.25">-2.25</option>
                                                <option value="-2.50">-2.50</option>
                                                <option value="-2.75">-2.75</option>
                                                <option value="-3.00">-3.00</option>
                                                <option value="-3.25">-3.25</option>
                                                <option value="-3.50">-3.50</option>
                                                <option value="-3.75">-3.75</option>
                                                <option value="-4.00">-4.00</option>
                                                <option value="-4.25">-4.25</option>
                                                <option value="-4.50">-4.50</option>
                                                <option value="-4.75">-4.75</option>
                                                <option value="-5.00">-5.00</option>
                                                <option value="-5.25">-5.25</option>
                                                <option value="-5.50">-5.50</option>
                                                <option value="-5.75">-5.75</option>
                                                <option value="-6.00">-6.00</option>
                                                <option value="-6.25">-6.25</option>
                                                <option value="-6.50">-6.50</option>
                                                <option value="-6.75">-6.75</option>
                                                <option value="-7.00">-7.00</option>
                                                <option value="-7.25">-7.25</option>
                                                <option value="-7.50">-7.50</option>
                                                <option value="-7.75">-7.75</option>
                                                <option value="-8.00">-8.00</option>
                                                <option value="-8.25">-8.25</option>
                                                <option value="-8.50">-8.50</option>
                                                <option value="-8.75">-8.75</option>
                                                <option value="-9.00">-9.00</option>
                                                <option value="-9.25">-9.25</option>
                                                <option value="-9.50">-9.50</option>
                                                <option value="-9.75">-9.75</option>
                                                <option value="-10.00">-10.00</option>
                                                <option value="-10.25">-10.25</option>
                                                <option value="-10.50">-10.50</option>
                                                <option value="-10.75">-10.75</option>
                                                <option value="-11.00">-11.00</option>
                                                <option value="-11.25">-11.25</option>
                                                <option value="-11.50">-11.50</option>
                                                <option value="-11.75">-11.75</option>
                                                <option value="-12.00">-12.00</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_cylindre">
                                                <option value="0.00">0.00</option>
                                                <option value="+0.25">+0.25</option>
                                                <option value="+0.50">+0.50</option>
                                                <option value="+0.75">+0.75</option>
                                                <option value="+1.00">+1.00</option>
                                                <option value="+1.25">+1.25</option>
                                                <option value="+1.5">+1.5</option>
                                                <option value="+1.75">+1.75</option>
                                                <option value="+2.00">+2.00</option>
                                                <option value="+2.25">+2.25</option>
                                                <option value="+2.50">+2.50</option>
                                                <option value="+2.75">+2.75</option>
                                                <option value="+3.00">+3.00</option>
                                                <option value="+3.25">+3.25</option>
                                                <option value="+3.50">+3.50</option>
                                                <option value="+3.75">+3.75</option>
                                                <option value="+4.00">+4.00</option>
                                                <option value="+4.25">+4.25</option>
                                                <option value="+4.50">+4.50</option>
                                                <option value="+4.75">+4.75</option>
                                                <option value="+5.00">+5.00</option>
                                                <option value="+5.25">+5.25</option>
                                                <option value="+5.50">+5.50</option>
                                                <option value="+5.75">+5.75</option>
                                                <option value="+6.00">+6.00</option>
                                                <option value="+6.25">+6.25</option>
                                                <option value="+6.50">+6.50</option>
                                                <option value="+6.75">+6.75</option>
                                                <option value="+7.00">+7.00</option>
                                                <option value="+7.25">+7.25</option>
                                                <option value="+7.50">+7.50</option>
                                                <option value="+7.75">+7.75</option>
                                                <option value="+8,00">+8,00</option>
                                                <option value="+8.25">+8.25</option>
                                                <option value="+8.50">+8.50</option>
                                                <option value="+8.75">+8.75</option>
                                                <option value="+9.00">+9.00</option>
                                                <option value="+9.25">+9.25</option>
                                                <option value="+9.50">+9.50</option>
                                                <option value="+9.75">+9.75</option>
                                                <option value="+10,00">+10,00</option>
                                                <option value="+10.25">+10.25</option>
                                                <option value="+10.5">+10.5</option>
                                                <option value="+10.75">+10.75</option>
                                                <option value="+11,00">+11,00</option>
                                                <option value="+11.25">+11.25</option>
                                                <option value="+11.50">+11.50</option>
                                                <option value="+11.75">+11.75</option>
                                                <option value="+12,00">+12,00</option>
                                                <option value="-0.25">-0.25</option>
                                                <option value="-0.50">-0.50</option>
                                                <option value="-0.75">-0.75</option>
                                                <option value="-1.00">-1.00</option>
                                                <option value="-1.25">-1.25</option>
                                                <option value="-1.50">-1.50</option>
                                                <option value="-1.75">-1.75</option>
                                                <option value="-2.00">-2.00</option>
                                                <option value="-2.25">-2.25</option>
                                                <option value="-2.50">-2.50</option>
                                                <option value="-2.75">-2.75</option>
                                                <option value="-3.00">-3.00</option>
                                                <option value="-3.25">-3.25</option>
                                                <option value="-3.50">-3.50</option>
                                                <option value="-3.75">-3.75</option>
                                                <option value="-4.00">-4.00</option>
                                                <option value="-4.25">-4.25</option>
                                                <option value="-4.50">-4.50</option>
                                                <option value="-4.75">-4.75</option>
                                                <option value="-5.00">-5.00</option>
                                                <option value="-5.25">-5.25</option>
                                                <option value="-5.50">-5.50</option>
                                                <option value="-5.75">-5.75</option>
                                                <option value="-6.00">-6.00</option>
                                                <option value="-6.25">-6.25</option>
                                                <option value="-6.50">-6.50</option>
                                                <option value="-6.75">-6.75</option>
                                                <option value="-7.00">-7.00</option>
                                                <option value="-7.25">-7.25</option>
                                                <option value="-7.50">-7.50</option>
                                                <option value="-7.75">-7.75</option>
                                                <option value="-8.00">-8.00</option>
                                                <option value="-8.25">-8.25</option>
                                                <option value="-8.50">-8.50</option>
                                                <option value="-8.75">-8.75</option>
                                                <option value="-9.00">-9.00</option>
                                                <option value="-9.25">-9.25</option>
                                                <option value="-9.50">-9.50</option>
                                                <option value="-9.75">-9.75</option>
                                                <option value="-10.00">-10.00</option>
                                                <option value="-10.25">-10.25</option>
                                                <option value="-10.50">-10.50</option>
                                                <option value="-10.75">-10.75</option>
                                                <option value="-11.00">-11.00</option>
                                                <option value="-11.25">-11.25</option>
                                                <option value="-11.50">-11.50</option>
                                                <option value="-11.75">-11.75</option>
                                                <option value="-12.00">-12.00</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_axe">
                                                <option value="0°">0°</option>
                                                <option value="5°">5°</option>
                                                <option value="10°">10°</option>
                                                <option value="15°">15°</option>
                                                <option value="20°">20°</option>
                                                <option value="25°">25°</option>
                                                <option value="30°">30°</option>
                                                <option value="35°">35°</option>
                                                <option value="40°">40°</option>
                                                <option value="45°">45°</option>
                                                <option value="50°">50°</option>
                                                <option value="55°">55°</option>
                                                <option value="60°">60°</option>
                                                <option value="65°">65°</option>
                                                <option value="70°">70°</option>
                                                <option value="75°">75°</option>
                                                <option value="80°">80°</option>
                                                <option value="85°">85°</option>
                                                <option value="90°">90°</option>
                                                <option value="95°">95°</option>
                                                <option value="100°">100°</option>
                                                <option value="105°">105°</option>
                                                <option value="110°">110°</option>
                                                <option value="115°">115°</option>
                                                <option value="120°">120°</option>
                                                <option value="125°">125°</option>
                                                <option value="130°">130°</option>
                                                <option value="135°">135°</option>
                                                <option value="140°">140°</option>
                                                <option value="145°">145°</option>
                                                <option value="150°">150°</option>
                                                <option value="155°">155°</option>
                                                <option value="160°">160°</option>
                                                <option value="165°">165°</option>
                                                <option value="170°">170°</option>
                                                <option value="175°">175°</option>
                                                <option value="180°">180°</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_add">
                                                <option value="0.00">0.00</option>
                                                    <option value="+0.50">+0.50</option>
                                                    <option value="+0.75">+0.75</option>
                                                    <option value="+1.00">+1.00</option>
                                                    <option value="+1.25">+1.25</option>
                                                    <option value="+1.50">+1.50</option>
                                                    <option value="+1.75">+1.75</option>
                                                    <option value="+2.00">+2.00</option>
                                                    <option value="+2.25">+2.25</option>
                                                    <option value="+2.50">+2.50</option>
                                                    <option value="+2.75">+2.75</option>
                                                    <option value="+3.00">+3.00</option>
                                                    <option value="+3.25">+3.25</option>
                                                    <option value="+3.50">+3.50</option>
                                                    <option value="+3.75">+3.75</option>
                                                    <option value="+4.00">+4.00</option>
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-row" style="margin-top: 1rem;">
                            <div class="form-group">
                                <label for="date_soin">Date de soin</label>
                                <input type="date" name="date_soin" id="date_soin" />
                            </div>
                        </div>
                        
                        <div class="form-navigation">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="1">
                                <i class="fas fa-arrow-left"></i> Précédent
                            </button>
                            <button type="button" class="btn btn-primary next-step" data-next="4">
                                Suivant <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
<!-- Step 3: Payment -->
<div class="form-section" id="section4">
    <h2 class="section-title">DÉTAILS DE PAIEMENT</h2>
    
    <div class="form-row">
        <div class="form-group">
            <label class="required-field">Montant Monture (FCFA)</label>
            <input type="number" name="montant_monture" id="montant_monture" required oninput="calculerTotalPro()" />
        </div>
        
        <div class="form-group">
            <label class="required-field">Montant Verres (FCFA)</label>
            <input type="number" name="montant_verres" id="montant_verres" required oninput="calculerTotalPro()" />
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label>Total Brut (FCFA)</label>
            <input type="number" name="total_brut" id="total_brut" readonly />
        </div>
        
        <div class="form-group">
            <label>Remise</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="number" name="remise" id="remise" value="0" oninput="calculerTotalPro()" style="flex: 2;" />
                <select name="remise_type" id="remise_type" onchange="calculerTotalPro()" style="flex: 1;">
                    <option value="">FCFA</option>
                    <option value="%">%</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label>Net à payer (FCFA)</label>
            <input type="number" name="net_a_payer" id="net_a_payer" readonly />
        </div>
    </div>
    
    <!-- Bouton pour afficher les détails des coûts -->
    <div class="form-row">
        <div class="form-group" style="width: 100%; text-align: center;">
            <button type="button" id="toggleDetailCouts" class="btn btn-secondary" style="margin: 1rem 0;">
                <i class="fas fa-calculator"></i> Afficher les détails des coûts
            </button>
        </div>
    </div>
    
    <!-- Section détail des coûts (cachée par défaut) -->
    <div class="detail-couts-container" id="detailCoutsContainer" style="display: none;">
        <h3 class="detail-couts-title">DÉTAIL DES PRODUITS</h3>
        <div class="detail-couts-grid">
            <div class="detail-cout-item">
                <label for="coutverre">Coût du verre (FCFA)</label>
                <input type="number" name="coutverre" id="coutverre" value="0" min="0" placeholder="0">
            </div>
            
            <div class="detail-cout-item">
                <label for="coutphotochromique">Photochromique/Transition (FCFA)</label>
                <input type="number" name="coutphotochromique" id="coutphotochromique" value="0" min="0" placeholder="0">
            </div>
            
            <div class="detail-cout-item">
                <label for="coutantireflet">Antireflet (FCFA)</label>
                <input type="number" name="coutantireflet" id="coutantireflet" value="0" min="0" placeholder="0">
            </div>
            
            <div class="detail-cout-item">
                <label for="<coutantiLumiereBleu>">Anti-lumière bleue (FCFA)</label>
                <input type="number" name="coutantiLumiereBleu" id="coutantiLumiereBleu" value="0" min="0" placeholder="0">
            </div>
        </div>
    </div>
    
    <div class="form-navigation">
        <button type="button" class="btn btn-secondary prev-step" data-prev="2">
            <i class="fas fa-arrow-left"></i> Précédent
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Envoyer
        </button>
    </div>
</div>
</form>
            </div>
        </div>
    </div>
</div>
    <div class="loader-overlay" id="loaderOverlay">
    <div class="loader-content">
        <div class="loader-spinner"></div>
        <div class="loader-text">Chargement du formulaire...</div>
    </div>
</div>
<div id="submitLoader" class="submit-loader">
    <div class="submit-loader-content">
        <div class="submit-spinner"></div>
        <div class="submit-message">Enregistrement en cours</div>
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>

async function openDevis() {
    const modal = getElementSafe('proformaModal');
    const loaderOverlay = getElementSafe('loaderOverlay');
    
    if (!modal || !loaderOverlay) return;
    
    // Afficher le loader
    loaderOverlay.classList.add('active');
    
    try {
        await loadDataFromSheet();
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    } catch (error) {
        console.error("Erreur lors du chargement:", error);
        alert("Erreur lors du chargement des données");
    } finally {
        loaderOverlay.classList.remove('active');
    }
}

// Fonction pour afficher un loader pendant la génération du PDF
async function generatePDFWithLoader() {
    const loader = getElementSafe('loaderOverlay');
    if (!loader) return;
    
    const loaderText = loader.querySelector('.loader-text');
    
    try {
        if (loaderText) {
            loaderText.textContent = 'Génération du PDF en cours...';
        }
        loader.classList.add('active');
        
        await new Promise(resolve => setTimeout(resolve, 100));
        await generatePDF();
    } catch (error) {
        console.error("Erreur lors de la génération du PDF:", error);
        alert("Erreur lors de la génération du PDF: " + error.message);
    } finally {
        loader.classList.remove('active');
    }
}

// Gestion du formulaire avec vérification
const clientForm = getElementSafe('client-form');
if (clientForm) {
    clientForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitLoader = getElementSafe('submitLoader');
        if (submitLoader) {
            submitLoader.classList.add('active');
        }
        
        try {
            await generatePDF();
        } catch (error) {
            console.error("Erreur:", error);
            alert("Erreur lors de la génération du PDF");
        } finally {
            if (submitLoader) {
                submitLoader.classList.remove('active');
            }
        }
    });
}

// Fonction pour basculer l'affichage des détails des coûts
function toggleDetailCouts() {
    const container = document.getElementById('detailCoutsContainer');
    const button = document.getElementById('toggleDetailCouts');
    
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        button.innerHTML = '<i class="fas fa-eye-slash"></i> Masquer les détails des coûts';
        button.classList.remove('btn-secondary');
        button.classList.add('btn-info');
    } else {
        container.style.display = 'none';
        button.innerHTML = '<i class="fas fa-calculator"></i> Afficher les détails des coûts';
        button.classList.remove('btn-info');
        button.classList.add('btn-secondary');
    }
}

// Calcul des totaux avec prise en compte des coûts détaillés
document.addEventListener("DOMContentLoaded", function() {
    function calculerTotalPro() {
        const montantMonture = parseFloat(document.getElementById('montant_monture')?.value) || 0;
        const montantVerres = parseFloat(document.getElementById('montant_verres')?.value) || 0;
        const remise = parseFloat(document.getElementById('remise')?.value) || 0;
        const remiseType = document.getElementById('remise_type')?.value;

        const totalBrut = montantMonture + montantVerres;
        const totalBrutElement = getElementSafe('total_brut');
        if (totalBrutElement) {
            totalBrutElement.value = totalBrut.toFixed(2);
        }

        let montantRemise = remiseType === '%' ? totalBrut * (remise / 100) : remise;
        const netAPayer = totalBrut - montantRemise;
        const netAPayerElement = getElementSafe('net_a_payer');
        if (netAPayerElement) {
            netAPayerElement.value = Math.max(0, netAPayer).toFixed(2);
        }
    }

    window.calculerTotalPro = calculerTotalPro;
    
    // Ajouter l'événement au bouton de bascule
    const toggleBtn = document.getElementById('toggleDetailCouts');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleDetailCouts);
    }
});

function validateStep() {
    return true;
}

function updateStepper(activeStep) {
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
        
        const stepNumber = parseInt(step.id.replace('step', ''));
        if (stepNumber < activeStep) {
            step.classList.add('completed');
        } else if (stepNumber == activeStep) {
            step.classList.add('active');
        }
    });
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', async () => {
    // Charger les données au premier affichage de la modale
    const proformaModal = getElementSafe('proformaModal');
    if (proformaModal) {
        proformaModal.addEventListener('click', async function(e) {
            if (e.target === this && !window.appDataCache) {
                await loadDataFromSheet();
            }
        });
    }

    // Initialiser le bouton de bascule des détails
    const toggleBtn = getElementSafe('toggleDetailCouts');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleDetailCouts);
    }
});

async function generatePDF() {
    // Récupérer les données du formulaire
    const formData = {
        nom_complet: document.getElementById('nom_complet').value,
        contact: document.querySelector('input[name="indicatif"]').value + ' ' + 
        document.querySelector('input[name="numero"]').value,
        date_naissance: document.getElementById('date_naissance').value,
        civilite: document.getElementById('civilite').value,
        type_verre: document.getElementById('type_verre').value,
        gamme_verre: document.getElementById('gamme_verre').value,
        choix_monture: document.getElementById('choixmonture').value,
        od_sphere: document.querySelector('select[name="od_sphere"]').value,
        od_cylindre: document.querySelector('select[name="od_cylindre"]').value,
        od_axe: document.querySelector('select[name="od_axe"]').value,
        od_add: document.querySelector('select[name="od_add"]').value,
        og_sphere: document.querySelector('select[name="og_sphere"]').value,
        og_cylindre: document.querySelector('select[name="og_cylindre"]').value,
        og_axe: document.querySelector('select[name="og_axe"]').value,
        og_add: document.querySelector('select[name="og_add"]').value,
        date_soin: document.getElementById('date_soin').value,
        montant_monture: document.getElementById('montant_monture').value,
        montant_verres: document.getElementById('montant_verres').value,
        total_brut: document.getElementById('total_brut').value,
        remise: document.getElementById('remise').value,
        remise_type: document.getElementById('remise_type').value,
        net_a_payer: document.getElementById('net_a_payer').value,
        // Ajouter les détails des coûts
        coutverre: document.getElementById('coutverre')?.value || 0,
        coutphotochromique: document.getElementById('coutphotochromique')?.value || 0,
        coutantireflet: document.getElementById('coutantireflet')?.value || 0,
        coutantiLumiereBleu: document.getElementById('coutantiLumiereBleu')?.value || 0
    };

    // Afficher un indicateur de chargement
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération en cours...';
    submitBtn.disabled = true;

    try {
        const url = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addproforma`;
        
        // Envoyer les données en no-cors
        await fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                formData: formData
            })
        });

        // Attendre 3 secondes pour la génération du PDF
        setTimeout(() => {
            // Ouvrir le PDF
            checkAndOpenPDF();
        }, 3000);

    } catch (error) {
        // Même en cas d'erreur, fermer et ouvrir le PDF
        setTimeout(() => {
            checkAndOpenPDF();
            closeModal();
        }, 3000);
    } finally {
        // Restaurer le bouton (au cas où)
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
}

// Fonction unique pour récupérer et ouvrir le PDF (version robuste)
async function checkAndOpenPDF() {
    try {
        const url = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getlastpdf`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP! statut: ${response.status}`);
        }
        
        const result = await response.json();
        console.log("Réponse du serveur:", result); // Pour debug
        
        // Vérifier les deux orthographes possibles (succès/success)
        const isSuccess = result.succès || result.success;
        const messageText = result.message || "";
        
        let pdfUrl = null;
        
        // CORRECTION : Vérifier si la réponse contient data.pdfUrl
        if (isSuccess && result.data && result.data.pdfUrl) {
            pdfUrl = result.data.pdfUrl;
        } 
        // Gérer les cas où le PDF est en cours de génération
        else if (messageText === "Le PDF est en cours de génération. Veuillez patienter quelques secondes." ||
                 messageText.includes("en cours de génération")) {
            console.warn("⚠️ Aucun PDF disponible:", messageText);
            alert("Le PDF est en cours de génération. Veuillez patienter quelques secondes puis réessayer.");
            return;
        } 
        // Gérer les autres cas d'erreur
        else if (isSuccess === false) {
            console.warn("⚠️ Échec de génération du PDF:", messageText);
            alert("Erreur lors de la génération du PDF: " + messageText);
            return;
        } 
        // Structure inattendue
        else {
            console.warn("⚠️ Structure de réponse inattendue:", result);
            alert("Erreur inattendue lors de la génération du PDF.");
            return;
        }
        
        // Ouvrir le PDF
        if (pdfUrl) {
            closeModal();
            window.open(pdfUrl, '_blank');
            alert("PDF généré avec succès! Ouverture dans un nouvel onglet.");
        }
        
    } catch (error) {
        console.error("❌ Erreur ouverture PDF:", error);
        alert("Erreur lors de l'ouverture du PDF: " + error.message);
    }
}
 
function closeModal() {
    
    // Rediriger vers Accueil.html
    window.location.href = 'Accueil.html';
}

        window.openProforma = function() {
            window.location.href = 'proforma.html';
        };

        window.openAdmin = function() {
            if (!hasAdminRights()) {
                alert("⛔ Accès refusé");
                return;
            }
            window.location.href = 'Admin.html';
        };
        
        window.openCaisse = function() {
            window.location.href = 'Caisse.html';
        };

      
function toggleAdminMenu(event) {
    event.preventDefault(); // Empêche le lien de suivre #
    
    if (!hasAdminRights()) {
        alert("⛔ Accès refusé");
        return; // Bloque l'ouverture du menu
    }

    // ✅ Autorisé → toggle le sous-menu
    const menuItem = event.currentTarget.closest('.menu-item');
    const submenu = menuItem.querySelector('.submenu');
    submenu.classList.toggle('open');
}

function openDataCleint() {
    if (!hasAdminRights()) {
        alert("⛔ Accès refusé");
        return;
    }
window.location.href = 'Data.html';
}

function openDataProduit() {
window.location.href = 'Stock.html';
}

function openDatafacture() {
window.location.href = 'Facturation.html';
}

function openLooker() {
    if (!hasAdminRights()) {
        alert("⛔ Accès refusé");
        return;
    }

    window.open(
        'https://lookerstudio.google.com/s/kdslE6LRVDI',
        '_blank'
    );
}
    // Fonction combinée pour la gestion des menus et l'ouverture de nouvelle vente
    (function() {
        // Gestion des menus déroulants
        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', function(e) {
                // Empêche le comportement par default si c'est un lien
                if (e.target.href) e.preventDefault();

                const currentItem = this.parentElement;

                // Fermer toutes les autres sections
                document.querySelectorAll('.menu-item').forEach(item => {
                    if (item !== currentItem) item.classList.remove('active');
                });

                // Basculer l'état de la section cliquée
                currentItem.classList.toggle('active');
            });
        });

        // Fonction pour ouvrir Acceuil
        window.openVueGlobale = function() {
            try {
                const salePath = 'Accueil.html';
                window.location.href = salePath;
            } catch (error) {
                console.error("Erreur d'ouverture:", error);
                alert("Impossible d'ouvrir la page. Contactez l'administrateur.");
            }
        };
    })();
// ouvrir le catalogue Verre
window.openCatalogueVerre = function() {
    const pdfPath = 'Catalogue.pdf';
    window.open(pdfPath, '_blank');
};



window.openProductEntryForm = function() {
    const modalContainer = document.getElementById('modal-container');

    const modalHTML = `
        <div class="modal-overlay" id="productModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">Entrée de Produit</h3>
                </div>
                <div class="modal-body">
                    <form id="productForm">
        <div class="form-group">
            <label for="productCategory">Catégorie</label>
            <div class="select-with-input">
               <select name="productCategory" id="productCategory" class="form-control" onchange="updateProductFields()">
                                <option value="">-- Sélectionnez une catégorie --</option>
                                <option value="monture">Monture</option>
                                <option value="etui">Etuis</option>
                                <option value="nettoyant">Nettoyant</option>
                                <option value="autre">Autre</option>
                </select>
                <input type="text" id="productCategory_input" class="form-control" style="display: none; margin-top: 5px;" 
                       placeholder="Ajouter">
            </div>
            <button type="button" class="btn btn-small" onclick="toggleInput('productCategory')" 
                    style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                <i class="fas fa-plus"></i> Ajouter
            </button>
        </div>
                        <div id="dynamicFields"></div>
                        
                        <div class="form-group">
                            <label for="productQuantity">Quantité <span class="required">*</span></label>
                            <input type="number" id="productQuantity" class="form-control" min="1" required>
                        </div>
                        
                        <div id="product-message" class="form-message"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="submitProductForm()">Enregistrer</button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('productModal').classList.add('active');
    }, 10);
};

// Fonction pour charger les fournisseurs depuis l'API
async function loadFournisseurs(selectId) {
    const supplierSelect = document.getElementById(selectId);
    const loadingIndicator = document.getElementById(`loading-${selectId}`);
    const addSupplierBtn = document.getElementById(`addBtn-${selectId}`);
    
    try {
        if (loadingIndicator) loadingIndicator.style.display = 'inline-block';
        if (addSupplierBtn) addSupplierBtn.style.display = 'none';
        supplierSelect.disabled = true;
        supplierSelect.innerHTML = '<option value="">-- Chargement en cours --</option>';
        
        const apiUrl = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=catalogue';
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error('Erreur de chargement des fournisseurs');
        
        const data = await response.json();
        
        if (data.success && data.data.fournisseur) {
            supplierSelect.innerHTML = '<option value="">-- Sélectionnez une Agence --</option>';
            
            data.data.fournisseur.sort().forEach(fournisseur => {
                const option = document.createElement('option');
                option.value = fournisseur;
                option.textContent = fournisseur;
                supplierSelect.appendChild(option);
            });
            
            // Ajouter l'option pour nouveau fournisseur
            const newOption = document.createElement('option');
            newOption.value = 'new';
            newOption.textContent = '+ Ajouter';
            supplierSelect.appendChild(newOption);
        }
    } catch (error) {
        console.error('Erreur chargement fournisseurs:', error);
        supplierSelect.innerHTML = '<option value="">-- Erreur de chargement --</option>';
    } finally {
        supplierSelect.disabled = false;
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        if (addSupplierBtn) addSupplierBtn.style.display = 'block';
    }
}

// Fonction pour afficher/masquer le champ de nouveau fournisseur
function toggleNewSupplierField(selectId) {
    const supplierSelect = document.getElementById(selectId);
    const newSupplierField = document.getElementById(`newField-${selectId}`);
    const addSupplierBtn = document.getElementById(`addBtn-${selectId}`);
    
    if (supplierSelect.value === 'new') {
        newSupplierField.style.display = 'block';
        addSupplierBtn.style.display = 'none';
    } else {
        newSupplierField.style.display = 'none';
        addSupplierBtn.style.display = 'block';
    }
}

// Fonction pour ajouter un nouveau fournisseur à la liste
function addNewSupplier(selectId) {
    const newSupplierInput = document.getElementById(`newName-${selectId}`);
    const newSupplierName = newSupplierInput.value.trim();
    
    if (!newSupplierName) {
        alert('Veuillez saisir un nom ');
        return;
    }
    
    const supplierSelect = document.getElementById(selectId);
    const newSupplierField = document.getElementById(`newField-${selectId}`);
    const addSupplierBtn = document.getElementById(`addBtn-${selectId}`);
    
    // Ajouter le nouveau fournisseur à la liste
    const newOption = document.createElement('option');
    newOption.value = newSupplierName;
    newOption.textContent = newSupplierName;
    newOption.selected = true;
    
    // Insérer avant l'option "Ajouter nouveau"
    const addNewOption = supplierSelect.querySelector('option[value="new"]');
    supplierSelect.insertBefore(newOption, addNewOption);
    
    // Masquer le champ et réafficher le bouton
    newSupplierField.style.display = 'none';
    addSupplierBtn.style.display = 'block';
    newSupplierInput.value = '';
}

function updateProductFields() {
    const category = document.getElementById('productCategory').value;
    const dynamicFields = document.getElementById('dynamicFields');
    
    let fieldsHTML = '';
    
    switch(category) {
        case 'monture':
            fieldsHTML = `
                <div class="form-group">
                    <label for="montureReference">Référence Monture <span class="required">*</span></label>
                    <input type="text" id="montureReference" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="monturePrix">Prix de vente <span class="required">*</span></label>
                    <input type="text" id="monturePrix" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="montureSupplier">Agence <span class="required">*</span></label>
                    <div style="position: relative;">
                        <select id="montureSupplier" class="form-control" required onchange="toggleNewSupplierField('montureSupplier')">
                            <option value="">-- Chargement des Agence --</option>
                        </select>
                        <span id="loading-montureSupplier" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <div id="newField-montureSupplier" style="display: none; margin-top: 5px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newName-montureSupplier" class="form-control" placeholder="agence">
                            <button type="button" class="btn btn-success" onclick="addNewSupplier('montureSupplier')" style="white-space: nowrap;">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addBtn-montureSupplier" class="btn btn-small" onclick="document.getElementById('montureSupplier').value = 'new'; toggleNewSupplierField('montureSupplier');" 
                            style="margin-top: 5px; padding: 0.25rem 0.5rem; display: none;">
                        <i class="fas fa-plus"></i> Nouveau
                    </button>
                </div>
            `;
            break;
            
        case 'etui':
            fieldsHTML = `
                <div class="form-group">
                    <label for="etuiReference">Référence <span class="required">*</span></label>
                    <input type="text" id="etuiReference" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="etuiSupplier">Agence <span class="required">*</span></label>
                    <div style="position: relative;">
                        <select id="etuiSupplier" class="form-control" required onchange="toggleNewSupplierField('etuiSupplier')">
                            <option value="">-- Chargement des Agence --</option>
                        </select>
                        <span id="loading-etuiSupplier" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <div id="newField-etuiSupplier" style="display: none; margin-top: 5px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newName-etuiSupplier" class="form-control" placeholder="">
                            <button type="button" class="btn btn-success" onclick="addNewSupplier('etuiSupplier')" style="white-space: nowrap;">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addBtn-etuiSupplier" class="btn btn-small" onclick="document.getElementById('etuiSupplier').value = 'new'; toggleNewSupplierField('etuiSupplier');" 
                            style="margin-top: 5px; padding: 0.25rem 0.5rem; display: none;">
                        <i class="fas fa-plus"></i> Nouveau Agence
                    </button>
                </div>
            `;
            break;
            
        case 'nettoyant':
            fieldsHTML = `
                <div class="form-group">
                    <label for="nettoyantSupplier">Agence <span class="required">*</span></label>
                    <div style="position: relative;">
                        <select id="nettoyantSupplier" class="form-control" required onchange="toggleNewSupplierField('nettoyantSupplier')">
                            <option value="">-- Chargement  --</option>
                        </select>
                        <span id="loading-nettoyantSupplier" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <div id="newField-nettoyantSupplier" style="display: none; margin-top: 5px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newName-nettoyantSupplier" class="form-control" placeholder="Nom du nouveau">
                            <button type="button" class="btn btn-success" onclick="addNewSupplier('nettoyantSupplier')" style="white-space: nowrap;">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addBtn-nettoyantSupplier" class="btn btn-small" onclick="document.getElementById('nettoyantSupplier').value = 'new'; toggleNewSupplierField('nettoyantSupplier');" 
                            style="margin-top: 5px; padding: 0.25rem 0.5rem; display: none;">
                        <i class="fas fa-plus"></i> Nouveau 
                    </button>
                </div>
            `;
            break;
            
        case 'autre':
            fieldsHTML = `
                <div class="form-group">
                    <label for="autreReference">Référence</label>
                    <input type="text" id="autreReference" class="form-control">
                </div>
                <div class="form-group">
                    <label for="autreSupplier">Agence</label>
                    <div style="position: relative;">
                        <select id="autreSupplier" class="form-control" onchange="toggleNewSupplierField('autreSupplier')">
                            <option value="">-- Chargement --</option>
                        </select>
                        <span id="loading-autreSupplier" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <div id="newField-autreSupplier" style="display: none; margin-top: 5px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newName-autreSupplier" class="form-control" placeholder="Nom du nouveau ">
                            <button type="button" class="btn btn-success" onclick="addNewSupplier('autreSupplier')" style="white-space: nowrap;">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addBtn-autreSupplier" class="btn btn-small" onclick="document.getElementById('autreSupplier').value = 'new'; toggleNewSupplierField('autreSupplier');" 
                            style="margin-top: 5px; padding: 0.25rem 0.5rem; display: none;">
                        <i class="fas fa-plus"></i> Nouveau 
                    </button>
                </div>
                <div class="form-group">
                    <label for="autreInfo">Informations utiles</label>
                    <textarea id="autreInfo" class="form-control" rows="2"></textarea>
                </div>
            `;
            break;
            
        default:
            fieldsHTML = '';
    }
    
    dynamicFields.innerHTML = fieldsHTML;
    
    // Charger les fournisseurs pour les champs concernés
    if (category !== '') {
        setTimeout(() => {
            loadFournisseurs(category + 'Supplier');
        }, 100);
    }
}

// Fonctions pour gérer les nouveaux fournisseurs
function toggleNewSupplierField(selectId) {
    const select = document.getElementById(selectId);
    const newField = document.getElementById('newField-' + selectId);
    const addBtn = document.getElementById('addBtn-' + selectId);
    
    if (select.value === 'new') {
        newField.style.display = 'block';
        addBtn.style.display = 'none';
    } else {
        newField.style.display = 'none';
        addBtn.style.display = 'block';
    }
}

function addNewSupplier(selectId) {
    const newNameInput = document.getElementById('newName-' + selectId);
    const newSupplierName = newNameInput.value.trim();
    
    if (!newSupplierName) {
        alert('Veuillez saisir un nom de fournisseur');
        return;
    }
    
    const select = document.getElementById(selectId);
    
    // Ajouter le nouveau fournisseur à la liste
    const newOption = document.createElement('option');
    newOption.value = newSupplierName;
    newOption.textContent = newSupplierName;
    newOption.selected = true;
    
    // Insérer avant l'option "Nouveau fournisseur"
    const newOptionRef = select.querySelector('option[value="new"]');
    if (newOptionRef) {
        select.insertBefore(newOption, newOptionRef);
    } else {
        select.appendChild(newOption);
    }
    
    // Cacher le champ de saisie et réafficher le bouton
    document.getElementById('newField-' + selectId).style.display = 'none';
    document.getElementById('addBtn-' + selectId).style.display = 'block';
    
    // Réinitialiser le champ de saisie
    newNameInput.value = '';
}

// Fonction pour soumettre le formulaire de produit
async function submitProductForm() {
    const form = document.getElementById('productForm');
    const formMessage = document.getElementById('product-message');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires.';
        formMessage.classList.add('error');
        return;
    }

    const category = document.getElementById('productCategory').value;
    const quantity = document.getElementById('productQuantity').value;
    const utilisateur = sessionStorage.getItem("utilisateur") || "Utilisateur inconnu";
    
    let productData = {
        category: category,
        quantity: quantity,
        utilisateur: utilisateur
    };

    // Fonction pour gérer le fournisseur (nouveau ou existant)
    function handleSupplier(selectId) {
        const supplierSelect = document.getElementById(selectId);
        if (supplierSelect.value === 'new') {
            // Si l'utilisateur a sélectionné "Nouveau" mais n'a pas rempli le champ
            const newNameInput = document.getElementById('newName-' + selectId);
            const newSupplierName = newNameInput.value.trim();
            if (!newSupplierName) {
                throw new Error('Veuillez saisir le nom du nouveau ');
            }
            return newSupplierName;
        } else {
            return supplierSelect.value;
        }
    }

    // Récupérer les données spécifiques à la catégorie
    try {
        switch(category) {
            case 'monture':
                productData.reference = document.getElementById('montureReference').value;
                productData.prix = document.getElementById('monturePrix').value;
                productData.supplier = handleSupplier('montureSupplier');
                break;
                
            case 'etui':
                productData.reference = document.getElementById('etuiReference').value;
                productData.supplier = handleSupplier('etuiSupplier');
                break;
                
            case 'nettoyant':
                productData.supplier = handleSupplier('nettoyantSupplier');
                break;
                
            case 'autre':
                productData.reference = document.getElementById('autreReference').value;
                productData.supplier = handleSupplier('autreSupplier');
                productData.info = document.getElementById('autreInfo').value;
                break;
        }
    } catch (error) {
        formMessage.textContent = '❌ ' + error.message;
        formMessage.classList.add('error');
        return;
    }

    const submitButton = document.querySelector('#productModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addProduct";

        await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productData)
        });

        formMessage.textContent = '✅ Produit enregistré avec succès!';
        formMessage.classList.add('success');

        form.reset();
        document.getElementById('dynamicFields').innerHTML = '';

    } catch (error) {
        console.error("Erreur:", error);
        formMessage.textContent = "❌ Une erreur est survenue lors de l'enregistrement";
        formMessage.classList.add('error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';
    }
}
// Fonction pour vérifier les droits d'administration
function hasAdminRights() {
    // Vérifie si l'utilisateur est connecté
    const currentUser = sessionStorage.getItem("utilisateur");
    if (!currentUser) {
       
        return false;
    }
    
    // Vérifie directement le statut admin
    const isAdmin = sessionStorage.getItem("isAdmin") === "true";
    

    return isAdmin;
}


// Variables globales pour les factures
let allFactureData = [];
let uniqueFactureSocietes = [];
let uniqueFactureAssurances = [];
let uniqueFactureCompagnies = [];
let uniqueFactureProprietaires = [];
let currentFilteredFactures = [];

// Délai pour le filtrage
let filterTimeout;


// Variables globales
let allFacturationData = [];
let uniqueAssurances = [];
let uniqueCompagnies = [];


// Variables globales
let allProduitData = [];
let uniqueCategorie = [];
let uniqueAgence = [];



// Fonction utilitaire pour vérifier les éléments
function getElementSafe(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`Élément #${id} non trouvé`);
    }
    return element;
}

// Variables globales
let allClientsData = [];
let filteredClients = [];
let tableHeaders = [];
let currentPage = 1;
let itemsPerPage = 10;
let currentSortColumn = null;
let currentSortDirection = 'asc';

// Dans loadClientsFromScript()
async function loadClientsFromScript() {
    showLoading();

    const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=liste";

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const responseData = await response.json();

                
        
        if (!responseData.success || !responseData.data) {
            throw new Error("Réponse inattendue de l'API");
        }

        const { headers, rows } = responseData.data;
        
        // STOCKER LES HEADERS SÉPARÉMENT
        tableHeaders = headers;
        allClientsData = rows;
        filteredClients = [...allClientsData];
        
        renderTableHeaders(headers);
        updateTableAndPagination();
        
        // Initialiser les graphiques après le chargement des données
        setTimeout(() => {
            initializeCharts();
        }, 500);
        
    } catch (error) {
        console.error("Erreur de chargement:", error);
        displayError(error.message || "Erreur lors du chargement des clients");
    } finally {
        hideLoading();
    }
}

    // Affichage des en-têtes du tableau
    function renderTableHeaders(headers) {
        const thead = document.querySelector("#client-table thead");
        thead.innerHTML = "";

        const tr = document.createElement("tr");

        headers.forEach((header, index) => {
            const th = document.createElement("th");
            th.textContent = header;
            th.setAttribute('data-column', index);
            th.addEventListener('click', () => sortTable(index));
            tr.appendChild(th);
        });

        thead.appendChild(tr);
    }
// Affichage des lignes du tableau
function renderTableRows(rows) {
    const tbody = document.querySelector("#client-table tbody");
    tbody.innerHTML = "";

    if (!rows || rows.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        const columnCount = document.querySelectorAll("#client-table thead th").length;
        td.colSpan = columnCount || 1;
        td.textContent = "Aucun client trouvé";
        td.style.textAlign = "center";
        td.style.padding = "2rem";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    rows.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");

        row.forEach((cell, cellIndex) => {
            const td = document.createElement("td");

            // Colonne 0 (ID) - Lien cliquable avec tooltip
            if (cellIndex === 0) {
                const link = document.createElement("a");
                link.href = "#";
                link.className = "client-link";
                link.textContent = cell || "";
                link.onclick = (e) => {
                    e.preventDefault();
                    selectClient(row);
                };
                
                // Ajout du tooltip pour la colonne ID
                const tooltipContent = createClientTooltip(row);
                if (tooltipContent) {
                    link.classList.add("has-tooltip");
                    link.setAttribute("data-tooltip", tooltipContent);
                }
                
                td.appendChild(link);
            }
            // Colonne 4 (index 3) - Formatage date
            else if (cellIndex === 3 && cell) {
                try {
                    const date = new Date(cell);
                    if (!isNaN(date.getTime())) {
                        const formattedDate = date.toLocaleDateString('fr-FR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        td.textContent = formattedDate;
                    } else {
                        td.textContent = cell;
                    }
                } catch (error) {
                    console.error("Erreur de formatage de date:", error);
                    td.textContent = cell;
                }
            }
            // Toutes les autres colonnes
            else {
                td.textContent = cell || "";
            }
            
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });

    // Initialiser les tooltips après le rendu
    initializeTooltips();
}

// Fonction pour créer le contenu du tooltip
function createClientTooltip(clientData) {
    if (!clientData || clientData.length < 6) return null;
    
    try {
        // Récupérer les données depuis le tableau
        // Index 1: Nom complet, Index 4: Montant TTC, Index 5: Reste à payer
        const nomComplet = clientData[1] || "Non spécifié";
        const montantTTC = clientData[5] || "0";
        const resteAPayer = clientData[4] || "0";
        
        // Formater les montants
        const formatMontant = (montant) => {
            if (!montant) return "0 ";
            const num = parseFloat(montant);
            return isNaN(num) ? "0 " : `${num.toLocaleString('fr-FR')} `;
        };
        
        return `
            <div class="client-tooltip">
                <div class="tooltip-header">Détails Client</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Nom complet:</span>
                    <span class="tooltip-value">${nomComplet}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Montant total:</span>
                    <span class="tooltip-value amount">${formatMontant(montantTTC)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Reste à payer:</span>
                    <span class="tooltip-value rest">${formatMontant(resteAPayer)}</span>
                </div>
            </div>
        `;
    } catch (error) {
        console.error("Erreur création tooltip:", error);
        return null;
    }
}

// Initialiser les tooltips
function initializeTooltips() {
    const tooltipElements = document.querySelectorAll('.has-tooltip');
    
    tooltipElements.forEach(element => {
        let tooltip = null;
        let showTimeout = null;
        let hideTimeout = null;
        
        const showTooltip = () => {
            if (!tooltip) {
                const tooltipContent = element.getAttribute('data-tooltip');
                if (tooltipContent) {
                    tooltip = document.createElement('div');
                    tooltip.className = 'custom-tooltip';
                    tooltip.innerHTML = tooltipContent;
                    
                    // Positionner le tooltip
                    const rect = element.getBoundingClientRect();
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.top - 10) + 'px'; // Ajusté pour être juste au-dessus
                    tooltip.style.transform = 'translateY(-100%)';
                    
                    document.body.appendChild(tooltip);
                    
                    // Ajouter l'événement pour fermer le tooltip quand la souris le quitte
                    tooltip.addEventListener('mouseenter', () => {
                        if (hideTimeout) {
                            clearTimeout(hideTimeout);
                            hideTimeout = null;
                        }
                    });
                    
                    tooltip.addEventListener('mouseleave', hideTooltip);
                }
            }
        };
        
        const hideTooltip = () => {
            hideTimeout = setTimeout(() => {
                if (tooltip && document.body.contains(tooltip)) {
                    document.body.removeChild(tooltip);
                    tooltip = null;
                }
            }, 300);
        };
        
        element.addEventListener('mouseenter', function() {
            // Annuler le timeout de masquage s'il existe
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
            
            // Programmer l'affichage du tooltip après 1 seconde (réduit de 2 à 1s pour meilleure UX)
            showTimeout = setTimeout(showTooltip, 1000);
        });
        
        element.addEventListener('mouseleave', function() {
            // Annuler l'affichage si la souris quitte avant le délai
            if (showTimeout) {
                clearTimeout(showTimeout);
                showTimeout = null;
            }
            
            // Programmer la suppression du tooltip
            hideTooltip();
        });
        
        // Nettoyage si l'élément est retiré du DOM
        element.addEventListener('DOMNodeRemoved', function() {
            if (showTimeout) {
                clearTimeout(showTimeout);
            }
            if (hideTimeout) {
                clearTimeout(hideTimeout);
            }
            if (tooltip && document.body.contains(tooltip)) {
                document.body.removeChild(tooltip);
            }
        });
    });
}
        
    // Sélection d'un client
    function selectClient(clientData) {
        localStorage.setItem("selectedClient", JSON.stringify(clientData));
        window.location.href = "DetailClient.html";
    }

    // Filtrage des clients
function applySearchFilter() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();

    if (!searchTerm) {
        filteredClients = [...allClientsData];
    } else {
        filteredClients = allClientsData.filter(client => {
            // Recherche dans la colonne 0 (ID) et colonne 1 (Nom)
            const idMatch = client[0]?.toLowerCase().includes(searchTerm);
            const nameMatch = client[1]?.toLowerCase().includes(searchTerm);
            return idMatch || nameMatch;
        });
    }

    currentPage = 1;
    updateTableAndPagination();
}

    // Tri du tableau
    function sortTable(columnIndex) {
        if (currentSortColumn === columnIndex) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = columnIndex;
            currentSortDirection = 'asc';
        }

        filteredClients.sort((a, b) => {
            const valA = a[columnIndex] ?? '';
            const valB = b[columnIndex] ?? '';

            if (currentSortDirection === 'asc') {
                return String(valA).localeCompare(String(valB));
            } else {
                return String(valB).localeCompare(String(valA));
            }
        });

        updateTableAndPagination();
    }

    // Mise à jour de la pagination
function updateTableAndPagination() {
    const totalItems = filteredClients.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
    const rowsToDisplay = filteredClients.slice(startIndex, endIndex);

    // Mise à jour des informations de pagination
    const paginationInfo = document.querySelector(".pagination-info");
    if (paginationInfo) {
        paginationInfo.textContent = `Affichage de ${startIndex + 1} à ${endIndex} sur ${totalItems} clients`;
    }

    // Mise à jour des boutons de navigation
    document.getElementById("prevPage").disabled = currentPage <= 1;
    document.getElementById("nextPage").disabled = currentPage >= totalPages;

    // Affichage des données
    renderTableRows(rowsToDisplay);
    
    // Réinitialiser les tooltips
    initializeTooltips();
}

    // Navigation entre les pages
    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTableAndPagination();
        }
    }

    function goToNextPage() {
        const totalPages = Math.ceil(filteredClients.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateTableAndPagination();
        }
    }

    // Gestion des états de chargement
    function showLoading() {
        document.getElementById("loading-indicator").style.display = "block";
        document.getElementById("error-message").style.display = "none";
        document.getElementById("table-container").style.display = "none";
    }

    function hideLoading() {
        document.getElementById("loading-indicator").style.display = "none";
        document.getElementById("table-container").style.display = "block";
    }

    function displayError(message) {
        document.getElementById("error-message").textContent = message;
        document.getElementById("error-message").style.display = "block";
    }

    // Global function to close any active modal

async function fetchDataFromGoogleSheet() {
    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getconfigdata');

        if (!response.ok) {
            throw new Error(`Erreur HTTP! statut: ${response.status}`);
        }

        const responseData = await response.json();

        
        // Modification ici: vérifier responseData.data au lieu de responseData
        if (!responseData.success || !responseData.data) {
            throw new Error(responseData.message || "Réponse inattendue de l'API");
        }

        // Modification ici: accéder aux données via responseData.data
        const { categories, agences } = responseData.data;
        
        // Vérification des données requises
        if (!categories || !agences) {
            throw new Error("Structure de données incomplète");
        }


        return {
            success: true,
            categories: categories,
            agences: agences
        };

    } catch (error) {
        console.error("Erreur fetchDataFromGoogleSheet:", error);
        throw error;
    }
}
// Function to fetch categories from Google Sheets
window.openDepense = async function() {
    const modalContainer = document.getElementById('modal-container');

    // Afficher un loader pendant le chargement
    modalContainer.innerHTML = `
        <div class="modal-overlay active" id="loadingModal">
            <div class="modal-content" style="text-align: center; padding: 2rem;">
                <div class="loading-spinner"></div>
                <p>Chargement des données...</p>
            </div>
        </div>
    `;

    try {
        // Récupérer les données de configuration
        const { categories, agences } = await fetchDataFromGoogleSheet();

        const modalHTML = `
            <div class="modal-overlay" id="depenseModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Ajouter une Dépense</h3>
                    </div>
                    <div class="modal-body">
                        <form id="depenseForm">
                            <div class="form-group">
                                <label for="depenseDate">Date <span class="required">*</span></label>
                                <input type="date" id="depenseDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="depenseAgence">Agence <span class="required">*</span></label>
                                <select id="depenseAgence" class="form-control select-control" required>
                                    <option value="">Sélectionner une agence</option>
                                    ${agences.map(agence =>
                                        `<option value="${agence}">${agence}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="depenseDesignation">Désignation <span class="required">*</span></label>
                                <input type="text" id="depenseDesignation" class="form-control" placeholder="Description de la dépense" required>
                            </div>
                            <div class="form-group">
                                <label for="depenseCategorie">Catégorie <span class="required">*</span></label>
                                <select id="depenseCategorie" class="form-control select-control" required>
                                    <option value="">Sélectionner une catégorie</option>
                                    ${categories.map(cat =>
                                        `<option value="${cat.value}">${cat.label}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="depenseMontant">Montant () <span class="required">*</span></label>
                                <input type="number" id="depenseMontant" class="form-control" placeholder="0" required>
                            </div>
                            
                            <div id="form-message" class="form-message"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                        <button type="button" class="btn btn-primary" onclick="submitDepense()">Enregistrer</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.innerHTML = modalHTML;

        // Afficher la modal
        setTimeout(() => {
            document.getElementById('depenseModal').classList.add('active');
            document.getElementById('depenseDate').value = new Date().toISOString().split('T')[0];
        }, 10);

    } catch (error) {
        console.error("Erreur:", error);
        modalContainer.innerHTML = `
            <div class="modal-overlay active" id="errorModal">
                <div class="modal-content" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-color); font-size: 2rem; margin-bottom: 1rem;"></i>
                    <h4>Erreur de chargement</h4>
                    <p>Impossible de charger les données nécessaires depuis le tableur.</p>
                    <p><strong>Détails :</strong> ${error.message}</p>
                    <button class="btn btn-danger" onclick="closeModal()">Fermer</button>
                </div>
            </div>
        `;
    }
};
    // Function to submit the expense
async function submitDepense() {
    const form = document.getElementById('depenseForm');
    const formMessage = document.getElementById('form-message');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    // Validation améliorée
    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires correctement.';
        formMessage.classList.add('error');
        
        // Highlight des champs invalides
        const invalidFields = form.querySelectorAll(':invalid');
        invalidFields.forEach(field => {
            field.classList.add('input-error');
            field.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.classList.remove('input-error');
                }
            });
        });
        
        return;
    }
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur") || 'Utilisateur Inconnu';
    const depenseData = {
        date: document.getElementById('depenseDate').value,
        agence: document.getElementById('depenseAgence').value,
        designation: document.getElementById('depenseDesignation').value.trim(),
        categorie: document.getElementById('depenseCategorie').value,
        utilisateur: username, // CORRECTION : Ici on définit bien utilisateur
        montant: parseFloat(document.getElementById('depenseMontant').value)
    };

    // Validation supplémentaire
if (isNaN(depenseData.montant)) {
    formMessage.textContent = 'Veuillez entrer un montant valide.';
    formMessage.classList.add('error');
    document.getElementById('depenseMontant').classList.add('input-error');
    return;
}

    const submitButton = document.querySelector('#depenseModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addDepense";

            await fetch(apiUrl, {
              method: 'POST',
              mode: 'no-cors',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(depenseData)
            });

        // Succès
        formMessage.textContent = '✅ Dépense enregistrée avec succès!';
        formMessage.classList.add('success');
        
        // Réinitialiser le formulaire après succès
        form.reset();
        
        // Fermer après 1.5s
        setTimeout(() => {
            closeModal();
            // Rafraîchir les données si nécessaire
            if (typeof refreshExpenses === 'function') {
                refreshExpenses();
            }
        }, 1500);

    } catch (error) {
        console.error("Erreur:", error);
        formMessage.innerHTML = `❌ ${error.message || "Une erreur est survenue lors de l'enregistrement"}`;
        logError(`Dépense: ${errorMsg}`);
        formMessage.classList.add('error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';
    }
}


// Fonction pour ouvrir la modal de nouvelle vente
function openNewSale() {
    // Vérifier si la modal existe déjà
    let modal = document.getElementById('newSaleModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'newSaleModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Nouvelle Vente</h3>
                </div>
                <div class="modal-body">
                    <form id="client-form" method="POST">
                        <input type="hidden" name="source" value="web_form">
                        
                        <!-- Indicateur d'étapes -->
                        <div class="step-indicator">
                            <div class="step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-label">Informations Client</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-label">Prescription & Commande</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-number">3</div>
                                <div class="step-label">Paiement</div>
                            </div>
                            <div class="step" data-step="4">
                                <div class="step-number">4</div>
                                <div class="step-label">Tier Payant & Livraison</div>
                            </div>
                            <div class="step-progress">
                                <div class="step-progress-bar" id="stepProgressBar"></div>
                            </div>
                        </div>

                        <!-- Étape 1: Informations Client -->
                        <div id="step-1" class="form-step active">
                            <h2 class="section-title">Informations Client</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="nom_complet" class="required-field">Nom complet</label>
                                    <input type="text" name="nom_complet" id="nom_complet" class="form-control" required />
                                </div>

                                <div class="form-group">
                                    <label for="numero" class="required-field">Téléphone</label>
                                    <input type="text" name="indicatif" id="indicatif" placeholder="+229" value="+229" required/>
                                    <input type="tel" name="numero" id="numero" class="form-control" placeholder="01XXXXXXXX" required />
                                </div>

                                <div class="form-group">
                                    <label for="date_naissance" class="required-field">Date de naissance</label>
                                    <input type="date" name="date_naissance" id="date_naissance" class="form-control" required />
                                </div>

                                <div class="form-group">
                                    <label for="civilite" class="required-field">Civilité</label>
                                    <select name="civilite" id="civilite" class="form-control" required>
                                        <option value="M.">M.</option>
                                        <option value="Mme">Mme</option>
                                        <option value="Mlle">Mlle</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="entreprise">Entreprise</label>
                                    <div class="select-with-input">
                                        <select name="entreprise" id="entreprise" class="form-control">
                                            <option value="">-- Choisir --</option>
                                        </select>
                                        <input type="text" id="entreprise_input" class="form-control" style="display: none; margin-top: 5px;" 
                                               placeholder="Nouvelle entreprise">
                                    </div>
                                    <button type="button" class="btn btn-small" onclick="toggleInput('entreprise')" 
                                            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                        <i class="fas fa-plus"></i> Ajouter nouvelle
                                    </button>
                                </div>

                                <div class="form-group">
                                    <label for="agence" class="required-field">Agence</label>
                                    <select name="agence" id="agence" class="form-control" required>
                                    <option value="">-- Choisir --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="commercial">Commercial</label>
                                    <div class="select-with-input">
                                        <select name="commercial" id="commercial" class="form-control">
                                            <option value="">-- Choisir --</option>
                                        </select>
                                        <input type="text" id="commercial_input" class="form-control" style="display: none; margin-top: 5px;" 
                                               placeholder="New commercial">
                                    </div>
                                    
                                    <button type="button" class="btn btn-small" onclick="toggleInput('commercial')" 
                                            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                        <i class="fas fa-plus"></i> Ajouter nouvelle
                                    </button>
                                </div>
                                <div class="form-group">
                                    <label for="current_user" class="required-field">Utilisateur</label>
                                    <input type="text" name="current_user" id="current_user" class="form-control" readonly 
                                           style="background-color: #f0f0f0; cursor: not-allowed;">
                                </div>
                            </div>
                        </div>

                        <!-- Étape 2: Prescription & Commande -->
                        <div id="step-2" class="form-step">
                            <h2 class="section-title">Prescription Médicale</h2>
                            
<div class="prescription-container">
    <!-- Version desktop (table normale) -->
    <table class="prescription-table desktop-view">
        <thead>
            <tr>
                <th>Œil</th>
                <th>Sphere</th>
                <th>Cylindre</th>
                <th>Axe</th>
                <th>ADD</th>
                <th>DP</th>
                <th>Hauteur</th>
            </tr>
        </thead>
        <tbody>
            <!-- OD -->
            <tr>
                <td>OD</td>
                <td>
                    <select name="od_sphere">
                        <!-- Options -->
                    </select>
                </td>
                <td>
                    <select name="od_cylindre">
                        <!-- Options -->
                    </select>
                </td>
                <td>
                    <select name="od_axe">
                        <!-- Options -->
                    </select>
                </td>
                <td>
                    <select name="od_add">
                        <!-- Options -->
                    </select>
                </td>
                <td>
                    <input type="number" name="od_dp" value="0" min="0" class="small-input">
                </td>
                <td>
                    <input type="number" name="od_hauteur" value="0" min="0" class="small-input">
                </td>
            </tr>

            <!-- OG -->
            <tr>
                <td>OG</td>
                <td>
                    <select name="og_sphere">
                        <!-- Options -->
                    </select>
                </td>
                <td>
                    <select name="og_cylindre">
                        <!-- Options -->
                    </select>
                </td>
                <td>
                    <select name="og_axe">
                        <!-- Options -->
                    </select>
                </td>
                <td>
                    <select name="og_add">
                        <!-- Options -->
                    </select>
                </td>
                <td>
                    <input type="number" name="og_dp" value="0" min="0" class="small-input">
                </td>
                <td>
                    <input type="number" name="og_hauteur" value="0" min="0" class="small-input">
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Version mobile (cartes) -->
    <div class="prescription-mobile mobile-view">
        <!-- Carte OD -->
        <div class="prescription-card">
            <div class="card-header">
                <h4>Œil Droit (OD)</h4>
            </div>
            <div class="card-body">
                <div class="mobile-form-group">
                    <label>Sphere</label>
                    <select name="od_sphere" >
                        <!-- Options -->
                    </select>
                </div>
                <div class="mobile-form-group">
                    <label>Cylindre</label>
                    <select name="od_cylindre">
                        <!-- Options -->
                    </select>
                </div>
                <div class="mobile-form-group">
                    <label>Axe</label>
                    <select name="od_axe">
                        <!-- Options -->
                    </select>
                </div>
                <div class="mobile-form-group">
                    <label>ADD</label>
                    <select name="od_add">
                        <!-- Options -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Carte OG -->
        <div class="prescription-card">
            <div class="card-header">
                <h4>Œil Gauche (OG)</h4>
            </div>
            <div class="card-body">
                <div class="mobile-form-group">
                    <label>Sphere</label>
                    <select name="og_sphere" >
                        <!-- Options -->
                    </select>
                </div>
                <div class="mobile-form-group">
                    <label>Cylindre</label>
                    <select name="og_cylindre">
                        <!-- Options -->
                    </select>
                </div>
                <div class="mobile-form-group">
                    <label>Axe</label>
                    <select name="og_axe">
                        <!-- Options -->
                    </select>
                </div>
                <div class="mobile-form-group">
                    <label>ADD</label>
                    <select name="og_add">
                        <!-- Options -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Carte Mesures -->
        <div class="prescription-card measures-card">
            <div class="card-header">
                <h4>Mesures</h4>
            </div>
            <div class="card-body">
                <div class="measures-grid">
                    <div class="measure-group">
                        <label>DP OD</label>
                        <input type="number" name="od_dp" value="0" min="0">
                    </div>
                    <div class="measure-group">
                        <label>DP OG</label>
                        <input type="number" name="og_dp" value="0" min="0">
                    </div>
                    <div class="measure-group">
                        <label>Hauteur OD</label>
                        <input type="number" name="od_hauteur" value="0" min="0">
                    </div>
                    <div class="measure-group">
                        <label>Hauteur OG</label>
                        <input type="number" name="og_hauteur" value="0" min="0">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="clinique">Clinique</label>
                                    <div class="select-with-input">
                                        <select name="clinique" id="clinique" class="form-control">
                                            <option value="">-- Choisir --</option>
                                            <!-- Options existantes seront ajoutées dynamiquement -->
                                        </select>
                                        <input type="text" id="clinique_input" class="form-control" style="display: none; margin-top: 5px;" 
                                               placeholder="Nouvelle clinique">
                                    </div>
                                    <button type="button" class="btn btn-small" onclick="toggleInput('clinique')" 
                                            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                        <i class="fas fa-plus"></i> Ajouter nouvelle
                                    </button>
                                </div>
                                
                                <div class="form-group">
                                    <label for="ophtalmo">Ophtalmologue</label>
                                    <div class="select-with-input">
                                        <select name="ophtalmo" id="ophtalmo" class="form-control">
                                            <option value="">-- Choisir --</option>
                                            <!-- Options existantes seront ajoutées dynamiquement -->
                                        </select>
                                        <input type="text" id="ophtalmo_input" class="form-control" style="display: none; margin-top: 5px;" 
                                               placeholder="Nouvel ophtalmologue">
                                    </div>
                                    <button type="button" class="btn btn-small" onclick="toggleInput('ophtalmo')"
                                            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                        <i class="fas fa-plus"></i> Ajouter nouveau
                                    </button>
                                </div>
                                
                                <div class="form-group">
                                    <label for="date_soin">Date de soin</label>
                                    <input type="date" name="date_soin" id="date_soin" class="form-control" />
                                </div>
                            </div>

                            <h2 class="section-title" style="margin-top: 2rem;">Détails de la Commande</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="type_verre" class="required-field">Type de Verre</label>
                                    <select name="type_verre" id="type_verre" class="form-control" >
                                        <option value="">-- Type de Verre --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="gamme_verre" class="required-field">Gamme des Verres</label>
                                    <select name="gamme_verre" id="gamme_verre" class="form-control" >
                                       
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="choix_monture" class="required-field">Choix de Monture</label>
                                    <select name="choix_monture" id="choix_monture" class="form-control" >
                                    
                                       
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 3: Paiement -->
                        <div id="step-3" class="form-step">
                            <h2 class="section-title">Détails de Paiement</h2>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label required-field">Montant Monture (FCFA)</label>
                                        <input type="number" class="form-control" name="montant_monture" id="montant_monture" required value="0" oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label required-field">Montant Verres (FCFA)</label>
                                        <input type="number" class="form-control" name="montant_verres" id="montant_verres" required value="0" oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Frais de livraison (FCFA)</label>
                                        <input type="number" class="form-control" name="frais_livraison" id="frais_livraison" value="0" oninput="calculerTotal()" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label">Total Brut (FCFA)</label>
                                        <div class="payment-value" id="total_brut_display">0</div>
                                        <input type="hidden" name="total_brut" id="total_brut" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Remise</label>
                                        <div class="discount-selector">
                                            <input type="number" class="form-control discount-amount" name="remise" id="remise" value="0" oninput="calculerTotal()" />
                                            <select class="form-control discount-type" name="remise_type" id="remise_type" onchange="calculerTotal()">
                                                <option value="FCFA">FCFA</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Part Assurance (FCFA)</label>
                                        <input type="number" class="form-control" name="part_assurance" id="part_assurance" value="0" oninput="calculerTotal()" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label">Net à payer (FCFA)</label>
                                        <div class="payment-value" id="net_a_payer_display">0</div>
                                        <input type="hidden" name="net_a_payer" id="net_a_payer" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Acompte (FCFA)</label>
                                        <input type="number" class="form-control" name="acompte" id="acompte" value="0" oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Reste à payer (FCFA)</label>
                                        <div class="payment-value" id="reste_a_payer_display">0</div>
                                        <input type="hidden" name="reste_a_payer" id="reste_a_payer" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 4: Tier Payant & Livraison -->
                        <div id="step-4" class="form-step">
                        <h2 class="section-title">Tier Payant</h2>
                        <div class="form-grid">
                            <div class="form-group">
    <label for="assurance">Assurance</label>
    <div class="select-with-input">
        <select name="assurance" id="assurance" class="form-control">
            <option value="">-- Choisir --</option>
        </select>
        <input type="text" id="assurance_input" class="form-control" 
              placeholder="Nom de l'assurance" style="display: none;">
    </div>
    <button type="button" class="btn btn-small" onclick="toggleInput('assurance')" 
            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
        <i class="fas fa-plus"></i> Ajouter nouveau
    </button>
</div>

<div class="form-group">
    <label for="compagnie">Compagnie</label>
    <div class="select-with-input">
        <select name="compagnie" id="compagnie" class="form-control">
            <option value="">-- Choisir --</option>
        </select>
        <input type="text" id="compagnie_input" class="form-control" 
              placeholder="Nom de la compagnie" style="display: none;">
    </div>
    <button type="button" class="btn btn-small" onclick="toggleInput('compagnie')"
            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
        <i class="fas fas fa-plus"></i> Ajouter nouveau 
    </button>
</div>
                            
                            <div class="form-group">
                                <label for="numero_police">N° Police</label>
                                <input type="text" name="numero_police" id="numero_police" class="form-control" placeholder="Numéro de police d'assurance" />
                            </div>
                            <div class="form-group">
  <label for="tva">TVA sur la monture (18%)</label>
  <input type="number" name="tva" id="tva" class="form-control" readonly style="background-color: #f8f9fa;">
</div>
                                
                                <div class="form-group">
                                    <label for="assure_principal">Assuré Principal</label>
                                    <select name="assure_principal" id="assure_principal" class="form-control">
                                        <option value="">-- Choisir --</option>
                                        <option value="oui">Oui</option>
                                        <option value="non">Non</option>
                                    </select>
                                </div>

                                <div class="form-group" id="assure_principal_nom_container" style="display: none;">
                                    <label class="required-field">Nom complet de l'assuré principal</label>
                                    <input type="text" name="assure_principal_nom" id="assure_principal_nom" class="form-control" />
                                </div>
                            </div>

                        <!-- Nouvelle section pour la modification des montants assurance -->
                        <div class="form-grid" id="modification_montants_section" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
                            <div class="form-group" style="grid-column: span 3;">
                                <label>Souhaitez-vous modifier les montants pour l'assurance ?</label>
                                <div class="radio-group" style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                    <label class="radio-label">
                                        <input type="radio" name="modifier_montants" value="oui" onchange="toggleChampsMontantsAssurance(true)"> Oui
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="modifier_montants" value="non" checked onchange="toggleChampsMontantsAssurance(false)"> Non
                                    </label>
                                </div>
                            </div>

                            <div id="champs_montants_assurance" style="display: none; grid-column: span 3;">
                                <div class="payment-card">
                                    <h4 style="margin-bottom: 1rem; color: #333;">Répartition des montants assurance</h4>
                                    <div class="payment-row">
                                        <div class="payment-group">
                                            <label class="payment-label required-field">Part du client (FCFA)</label>
                                            <input type="number" class="form-control" name="part_client_assurance" id="part_client_assurance" 
                                                  value="0" oninput="calculerTotalAssurance()" />
                                        </div>
                                        
                                        <div class="payment-group">
                                            <label class="payment-label required-field">Part assureur (FCFA)</label>
                                            <input type="number" class="form-control" name="part_assureur" id="part_assureur" 
                                                  value="0" oninput="calculerTotalAssurance()" />
                                        </div>
                                        
                                        <div class="payment-group">
                                            <label class="payment-label">Montant total assurance (FCFA)</label>
                                            <div class="payment-value" id="montant_total_assurance_display">0</div>
                                            <input type="hidden" name="montant_total_assurance" id="montant_total_assurance" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h2 class="section-title" style="margin-top: 2rem;">Informations de Livraison</h2>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required-field">Date de livraison prévue</label>
                                <input type="date" class="form-control" name="date_livraison" id="date_livraison"  />
                            </div>
                            
                            <div class="form-group">
                                <label class="required-field">Personne à contacter</label>
                                <select class="form-control" name="contact_livraison_type" id="contact_livraison_type" >
                                    <option value="">-- Choisir --</option>
                                    <option value="client">Lui-même</option>
                                    <option value="tiers">Tier Personne</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="required-field">Téléphone du contact</label>
                                <input type="tel" class="form-control" name="telephone_contact" id="telephone_contact"  />
                            </div>
                            
                            <div class="form-group" style="grid-column: span 2">
                                <label class="required-field">Adresse de livraison</label>
                                <textarea class="form-control" name="adresse_livraison" id="adresse_livraison" rows="3" required></textarea>
                            </div>
                        </div>
                        </div>
                        <!-- Navigation entre les étapes -->
                        <div class="step-navigation">
                            <div class="nav-group">
                                <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;">
                                    <i class="fas fa-arrow-left"></i> Précédent
                                </button>
                            </div>
                            
                            <div class="nav-group">
                                <button type="button" class="btn btn-outline" id="resetButton">
                                    <i class="fas fa-undo"></i> Réinitialiser
                                </button>
                                <button type="button" class="btn btn-outline" id="cancelButton">
                                    <i class="fas fa-times"></i> Annuler
                                </button>
                            </div>
                            
                            <div class="nav-group">
                                <button type="button" class="btn btn-primary" id="nextStepBtn">
                                    Suivant <i class="fas fa-arrow-right"></i>
                                </button>
                                <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                                    <i class="fas fa-check"></i> Ajouter
                                </button>
                            </div>
                        </div>

                        <style>
/* -----------------------
   STEP NAVIGATION MODERNE
   ----------------------- */
.step-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
    margin-top: 2.5rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
    flex-wrap: wrap;
    position: relative;
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.7));
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 1.5rem 2rem;
    margin: 2rem 0 0 0;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* Effet de bordure supérieure décorative */
.step-navigation::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 3px;
    background: linear-gradient(90deg, #6a11cb, #2575fc);
    border-radius: 0 0 2px 2px;
}

.nav-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

/* -----------------------
   BOUTONS MODERNES
   ----------------------- */
.btn-outline {
    background: 
        linear-gradient(135deg, 
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.7));
    border: 2px solid rgba(106, 17, 203, 0.3);
    color: #6a11cb;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
    box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

.btn-outline::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(106, 17, 203, 0.1), transparent);
    transition: left 0.6s;
}

.btn-outline:hover::before {
    left: 100%;
}

.btn-outline:hover {
    background: 
        linear-gradient(135deg, 
            rgba(106, 17, 203, 0.05),
            rgba(37, 117, 252, 0.05));
    border-color: #6a11cb;
    color: #6a11cb;
    transform: translateY(-2px);
    box-shadow: 
        0 8px 25px rgba(106, 17, 203, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.btn-outline:active {
    transform: translateY(0);
    box-shadow: 
        0 2px 10px rgba(106, 17, 203, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* -----------------------
   BOUTON SUCCÈS AVEC GRADIENT ANIMÉ
   ----------------------- */
.btn-success {
    background: 
        linear-gradient(135deg, 
            #4ade80 0%,
            #3bc46d 50%,
            #2da85c 100%);
    background-size: 200% 200%;
    border: 2px solid transparent;
    color: white;
    padding: 12px 28px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 
        0 6px 20px rgba(74, 222, 128, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-success::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s;
}

.btn-success:hover::before {
    left: 100%;
}

.btn-success:hover {
    background-position: 100% 100%;
    transform: translateY(-3px);
    box-shadow: 
        0 10px 30px rgba(74, 222, 128, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

.btn-success:active {
    transform: translateY(-1px);
    box-shadow: 
        0 4px 15px rgba(74, 222, 128, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

/* -----------------------
   BOUTON PRIMAIRE POUR ÉTAPES SUIVANTES
   ----------------------- */
.btn-primary {
    background: 
        linear-gradient(135deg, 
            #6a11cb 0%,
            #2575fc 50%,
            #6a11cb 100%);
    background-size: 200% 200%;
    border: 2px solid transparent;
    color: white;
    padding: 12px 28px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 
        0 6px 20px rgba(37, 117, 252, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s;
}

.btn-primary:hover::before {
    left: 100%;
}

.btn-primary:hover {
    background-position: 100% 100%;
    transform: translateY(-3px);
    box-shadow: 
        0 10px 30px rgba(37, 117, 252, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

.btn-primary:active {
    transform: translateY(-1px);
    box-shadow: 
        0 4px 15px rgba(37, 117, 252, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

/* -----------------------
   INDICATEUR DE PROGRESSION
   ----------------------- */
.progress-indicator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #6a11cb;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 8px 16px;
    background: rgba(106, 17, 203, 0.1);
    border-radius: 10px;
    border: 1px solid rgba(106, 17, 203, 0.2);
}

.progress-indicator i {
    font-size: 1.1rem;
}

/* -----------------------
   ÉTATS DES BOUTONS
   ----------------------- */
.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.6) !important;
}

.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.btn-success.btn-loading::after {
    border-top-color: white;
}

.btn-outline.btn-loading::after {
    border-top-color: #6a11cb;
}

/* -----------------------
   RESPONSIVE DESIGN AMÉLIORÉ
   ----------------------- */
@media (max-width: 768px) {
    .step-navigation {
        flex-direction: column-reverse;
        gap: 1.25rem;
        padding: 1.25rem 1.5rem;
        margin-top: 2rem;
        border-radius: 16px;
    }
    
    .nav-group {
        width: 100%;
        justify-content: space-between;
        gap: 0.75rem;
    }
    
    .btn-outline,
    .btn-success,
    .btn-primary {
        padding: 10px 20px;
        font-size: 0.9rem;
        flex: 1;
        min-width: 120px;
        text-align: center;
    }
    
    .progress-indicator {
        order: -1;
        width: 100%;
        justify-content: center;
        margin-bottom: 0.5rem;
    }
}

@media (max-width: 480px) {
    .step-navigation {
        padding: 1rem 1.25rem;
        gap: 1rem;
    }
    
    .nav-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-outline,
    .btn-success,
    .btn-primary {
        width: 100%;
        padding: 12px 16px;
    }
    
    .progress-indicator {
        font-size: 0.85rem;
        padding: 6px 12px;
    }
}

/* -----------------------
   ANIMATIONS
   ----------------------- */
@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* -----------------------
   VARIANTES SUPPLÉMENTAIRES
   ----------------------- */
.btn-sm {
    padding: 8px 16px !important;
    font-size: 0.85rem !important;
}

.btn-lg {
    padding: 14px 32px !important;
    font-size: 1rem !important;
}

.btn-full {
    width: 100% !important;
}

/* Bouton avec icône */
.btn-with-icon {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Effet de pulsation pour les actions importantes */
.btn-pulse {
    animation: pulse 2s infinite;
}

/* État de succès */
.btn-success-completed {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}
                        </style>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    
    // Afficher la modal
    modal.classList.add('active');
    
    // Initialiser la modal
    initModal();
};
// URL pour soumettre les données
const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addCommandeClient";

// URL de votre Web App Google Apps Script
const DATA_SOURCE_URL = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=catalogue';

// URL de l'API produits
const PRODUCTS_URL = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importproduits';

// Variables globales
let currentStep = 1;
const totalSteps = 4;

// Initialisation de la modal
function initModal() {
    // Configurer les événements
    setupEventListeners();
    synchronizePrescriptionFields();
    
    // Calcul initial
    calculerTotal();
    
    // Charger les données depuis Google Sheets
    loadDataFromSheet();
    
    // Mettre à jour l'affichage des étapes
    updateStepDisplay();
    setupCurrentUserField();
    
    // Ajouter les écouteurs pour les champs assurance
    const champsAssurance = ['assurance', 'assurance_input', 'compagnie', 'compagnie_input', 'numero_police'];
    champsAssurance.forEach(champ => {
        const element = document.getElementById(champ);
        if (element) {
            element.addEventListener('input', verifierAffichageModificationMontants);
            element.addEventListener('change', verifierAffichageModificationMontants);
        }
    });
    
    // Initialiser l'affichage
    verifierAffichageModificationMontants();
    
    // Définir les dates par défaut
    const today = new Date();
    const deliveryDate = new Date(today);
    deliveryDate.setDate(today.getDate() + 15);
    
    // Formater en YYYY-MM-DD
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    // Définir les dates par défaut
    document.getElementById('date_soin').value = formatDate(today);
    document.getElementById('date_livraison').value = formatDate(deliveryDate);
    document.getElementById('date_naissance').value = '2000-01-01'; // Date de naissance par défaut
    
    // Initialiser le champ monture
    initializeMontureField();
}

// Fonction pour initialiser le champ monture
function initializeMontureField() {
    const montureSelect = document.getElementById('choix_monture');
    const agenceSelect = document.getElementById('agence');
    
    if (!montureSelect || !agenceSelect) return;
    
    // Désactiver le champ monture initialement
    montureSelect.disabled = true;
    montureSelect.innerHTML = '<option value="">-- Sélectionnez d\'abord une agence --</option>';
    
    // Ajouter l'écouteur sur le changement d'agence
    agenceSelect.addEventListener('change', async function() {
        const selectedAgence = this.value;
        const montureSelect = document.getElementById('choix_monture');
        
        if (!selectedAgence) {
            // Si aucune agence n'est sélectionnée
            montureSelect.disabled = true;
            montureSelect.innerHTML = '<option value="">-- Sélectionnez d\'abord une agence --</option>';
            montureSelect.classList.add('monture-select-disabled');
            return;
        }
        
        // Activer le champ monture
        montureSelect.disabled = false;
        montureSelect.classList.remove('monture-select-disabled');
        
        // Charger les montures pour cette agence
        await loadMonturesForAgence(selectedAgence);
    });
}

// Fonction pour charger les montures pour une agence spécifique
async function loadMonturesForAgence(agence) {
    try {
        console.log('⏳ Début du chargement des montures pour l\'agence:', agence);
        
        const response = await fetch(PRODUCTS_URL);
        
        if (!response.ok) {
            console.error('❌ Erreur HTTP produits:', response.status, response.statusText);
            throw new Error(`Erreur HTTP produits: ${response.status}`);
        }
        
        const responseText = await response.text();
        
        let data;
        try {
            data = JSON.parse(responseText);
            console.log('✅ JSON parsé avec succès');
        } catch (parseError) {
            console.error('❌ Erreur de parsing JSON:', parseError);
            throw new Error("Format JSON invalide dans la réponse");
        }
        
        if (!data.success || !data.data || !data.data.rows) {
            console.error('❌ Structure de données invalide');
            throw new Error("Données produits invalides");
        }
        
        // Filtrer et formater les montures pour l'agence sélectionnée
        const montures = filterMonturesForAgence(data.data.rows, agence);
        
        // Remplir le select des montures
        populateMonturesSelect(montures, agence);
        
        hideStatusMessage();
        console.log('✅ Chargement des montures terminé avec succès');
        
    } catch (error) {
        console.error('❌ Erreur complète lors du chargement des montures:', error);
        showError('Erreur lors du chargement des montures: ' + error.message);
    }
}

// Fonction pour filtrer les montures pour une agence spécifique
function filterMonturesForAgence(rows, agence) {
    const headers = ["Date", "Catégorie", "Référence", "Stock de depart", "Agence", 
                     "Prix de vente", "User", "Conso Fin", "Conso En cour", 
                     "Stock Virtuel", "Stock Physique"];
    
    const montures = [];
    
    rows.forEach(row => {
        // Convertir la ligne en objet avec les headers comme clés
        const rowData = {};
        headers.forEach((header, index) => {
            rowData[header] = row[index] || '';
        });
        
        // Vérifier si c'est une monture pour l'agence sélectionnée
        if (rowData["Catégorie"] && rowData["Catégorie"].toLowerCase() === "monture") {
            // Vérifier l'agence (correspondance partielle pour gérer les variations)
            const rowAgence = rowData["Agence"] || '';
            const isMatchingAgence = rowAgence.toLowerCase().includes(agence.toLowerCase()) || 
                                     agence.toLowerCase().includes(rowAgence.toLowerCase());
            
            if (isMatchingAgence) {
                // Convertir le stock virtuel en nombre
                const stockVirtuel = parseInt(rowData["Stock Virtuel"]) || 0;
                const stockPhysique = parseInt(rowData["Stock Physique"]) || 0;
                const prix = parseInt(rowData["Prix de vente"]) || 0;
                
                // Filtrer si stock virtuel > 0
                if (stockVirtuel > 0 || stockPhysique > 0) {
                    montures.push({
                        reference: rowData["Référence"] || '',
                        agence: rowData["Agence"] || '',
                        prix: prix,
                        stockVirtuel: stockVirtuel,
                        stockPhysique: stockPhysique,
                        categorie: rowData["Catégorie"] || '',
                        formatted: `${rowData["Référence"]} - ${prix.toLocaleString()} FCFA (Stock: ${stockVirtuel})`
                    });
                }
            }
        }
    });
    
    return montures;
}

// Fonction pour remplir le select des montures
function populateMonturesSelect(montures, agence) {
    const montureSelect = document.getElementById('choix_monture');
    if (!montureSelect) {
        console.error('❌ Élément choix_monture non trouvé dans le DOM');
        return;
    }
    
    // Vider le select
    while (montureSelect.options.length > 0) {
        montureSelect.remove(0);
    }
    
    // Ajouter l'option par défaut
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '-- Sélectionner une monture --';
    montureSelect.appendChild(defaultOption);
    
    if (!montures) {
        montures = [];
    }
    
    if (!Array.isArray(montures)) {
        montures = [];
    }
    
    if (montures.length === 0) {
        // Si aucune monture n'est disponible
        const noOption = document.createElement('option');
        noOption.value = '';
        noOption.textContent = `Aucune monture disponible pour ${agence}`;
        noOption.disabled = true;
        montureSelect.appendChild(noOption);
        montureSelect.disabled = true;
        montureSelect.classList.add('monture-select-disabled');
    } else {
        // Activer le select
        montureSelect.disabled = false;
        montureSelect.classList.remove('monture-select-disabled');
        
        // Trier les montures par référence
       montures.sort((a, b) => {
    const refA = (a.reference || '').toString();
    const refB = (b.reference || '').toString();
    return refA.localeCompare(refB);
});
        
        // Ajouter les options
        montures.forEach((monture) => {
            const option = document.createElement('option');
            
            // Créer l'objet pour value
            const montureData = {
                reference: monture.reference || ''
            };
            
            try {
                option.value = JSON.stringify(montureData);
            } catch (jsonError) {
                console.error(`❌ Erreur JSON.stringify pour ${monture.reference}:`, jsonError);
                option.value = '';
            }
            
            option.textContent = monture.reference ;
            montureSelect.appendChild(option);
        });
    }
}



// Fonction pour afficher/masquer le champ nom de l'assuré principal
function toggleAssurePrincipalNom() {
    const assurePrincipal = document.getElementById('assure_principal');
    const nomContainer = document.getElementById('assure_principal_nom_container');
    
    if (assurePrincipal && nomContainer) {
        if (assurePrincipal.value === 'non') {
            nomContainer.style.display = 'block';
            // Remplir automatiquement avec le nom du client
            const nomClient = document.getElementById('nom_complet')?.value || '';
            const nomInput = document.getElementById('assure_principal_nom');
            nomInput.value = nomClient;
            nomInput.readOnly = true;
            nomInput.style.backgroundColor = '#f0f0f0';
        } else if (assurePrincipal.value === 'oui') {
            nomContainer.style.display = 'block';
            const nomInput = document.getElementById('assure_principal_nom');
            nomInput.value = '';
            nomInput.readOnly = false;
            nomInput.style.backgroundColor = '';
        } else {
            nomContainer.style.display = 'none';
            document.getElementById('assure_principal_nom').value = '';
        }
    }
}

// Fonction pour calculer le total assurance
function calculerTotalAssurance() {
    const partClient = parseFloat(document.getElementById('part_client_assurance').value) || 0;
    const partAssureur = parseFloat(document.getElementById('part_assureur').value) || 0;
    const totalAssurance = partClient + partAssureur;
    
    document.getElementById('montant_total_assurance_display').textContent = 
        Math.round(totalAssurance).toLocaleString();
    document.getElementById('montant_total_assurance').value = totalAssurance;
}

// Fonction pour afficher/masquer les champs de modification des montants
function toggleChampsMontantsAssurance(afficher) {
    const champsMontants = document.getElementById('champs_montants_assurance');
    
    if (afficher) {
        champsMontants.style.display = 'block';
        // Initialiser les valeurs à 0
        document.getElementById('part_client_assurance').value = '0';
        document.getElementById('part_assureur').value = '0';
        calculerTotalAssurance();
    } else {
        champsMontants.style.display = 'none';
        // Réinitialiser les valeurs
        document.getElementById('part_client_assurance').value = '0';
        document.getElementById('part_assureur').value = '0';
        calculerTotalAssurance();
    }
}

// Fonction pour afficher la section modification montants si assurance renseignée
function verifierAffichageModificationMontants() {
    const assurance = document.getElementById('assurance').value || document.getElementById('assurance_input').value;
    const compagnie = document.getElementById('compagnie').value || document.getElementById('compagnie_input').value;
    const numeroPolice = document.getElementById('numero_police').value;
    
    const sectionModification = document.getElementById('modification_montants_section');
    
    if (assurance || compagnie || numeroPolice) {
        sectionModification.style.display = 'grid';
    } else {
        sectionModification.style.display = 'none';
        document.getElementById('champs_montants_assurance').style.display = 'none';
        // Décocher "Oui" si caché
        const ouiRadio = document.querySelector('input[name="modifier_montants"][value="oui"]');
        const nonRadio = document.querySelector('input[name="modifier_montants"][value="non"]');
        if (ouiRadio && nonRadio) {
            ouiRadio.checked = false;
            nonRadio.checked = true;
        }
    }
}

// Mettre à jour l'affichage des étapes
function updateStepDisplay() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    // Masquer toutes les étapes
    modal.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Afficher l'étape actuelle
    const currentStepElement = modal.querySelector(`#step-${currentStep}`);
    if (currentStepElement) {
        currentStepElement.classList.add('active');
    }
    
    // Mettre à jour l'indicateur d'étapes
    modal.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
        const stepNumber = parseInt(step.getAttribute('data-step'));
        
        if (stepNumber === currentStep) {
            step.classList.add('active');
        } else if (stepNumber < currentStep) {
            step.classList.add('completed');
        }
    });
    
    // Mettre à jour la barre de progression
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    const progressBar = modal.querySelector('#stepProgressBar');
    if (progressBar) {
        progressBar.style.width = `${progressPercentage}%`;
    }
    
    // Gérer les boutons de navigation
    const prevBtn = modal.querySelector('#prevStepBtn');
    const nextBtn = modal.querySelector('#nextStepBtn');
    const submitBtn = modal.querySelector('#submitBtn');
    
    if (prevBtn) {
        prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
    }
    
    if (nextBtn && submitBtn) {
        if (currentStep < totalSteps) {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        } else {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        }
    }
}

// Aller à l'étape suivante
function nextStep() {
    if (!validateStep(currentStep)) return;
    
    if (currentStep < totalSteps) {
        currentStep++;
        updateStepDisplay();
        const modal = document.getElementById('newSaleModal');
        if (modal) {
            modal.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
}

// Revenir à l'étape précédente
function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
        const modal = document.getElementById('newSaleModal');
        if (modal) {
            modal.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
}

// Valider l'étape actuelle
function validateStep(step) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return false;
    
    let isValid = true;
    const highlightError = (element) => {
        if (element) {
            element.style.borderColor = '#dc3545';
            setTimeout(() => {
                element.style.borderColor = '';
            }, 2000);
        }
    };
    
    // Validation pour l'étape 1 (Informations Client)
    if (step === 1) {
        const requiredFields = [
            'nom_complet', 'numero', 
            'agence', 'commercial'
        ];
        
        for (const fieldId of requiredFields) {
            const field = modal.querySelector(`#${fieldId}`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        // Validation du téléphone
        const phoneField = modal.querySelector('#numero');
        if (phoneField && phoneField.value) {
            const phoneRegex = /^[0-9]{8,12}$/;
            if (!phoneRegex.test(phoneField.value.replace(/\D/g, ''))) {
                highlightError(phoneField);
                isValid = false;
                showError('Numéro de téléphone invalide. Format attendu: 8 à 12 chiffres');
            }
        }
        
        if (!isValid) {
            showError('Veuillez remplir tous les champs obligatoires');
        }
    }
    
    // Les autres étapes ne sont plus obligatoires
    if (step === 2 || step === 3 || step === 4) {
        return true; // Validation automatique pour les étapes 2, 3 et 4
    }
    
    return isValid;
}

// Synchronisation des champs de prescription desktop/mobile
function synchronizePrescriptionFields() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const createSyncHandler = (fieldName) => {
        return function() {
            const allElements = modal.querySelectorAll(`[name="${fieldName}"]`);
            allElements.forEach(element => {
                if (element !== this) {
                    element.value = this.value;
                }
            });
        };
    };
    
    const prescriptionFields = [
        'od_sphere', 'od_cylindre', 'od_axe', 'od_add', 'od_dp', 'od_hauteur',
        'og_sphere', 'og_cylindre', 'og_axe', 'og_add', 'og_dp', 'og_hauteur'
    ];
    
    prescriptionFields.forEach(field => {
        const elements = modal.querySelectorAll(`[name="${field}"]`);
        elements.forEach(element => {
         
            element.removeEventListener('change', element._syncHandler);
            element.removeEventListener('input', element._syncHandler);
            
            // Créer et attacher le nouvel écouteur
            const handler = createSyncHandler(field);
            element._syncHandler = handler;
            element.addEventListener('change', handler);
            
            // Pour les champs de texte, utiliser aussi 'input'
            if (field.includes('dp') || field.includes('hauteur')) {
                element.addEventListener('input', handler);
            }
        });
    });
    
    // Synchronisation automatique de l'ADD
    const odAdd = modal.querySelector('[name="od_add"]');
    const ogAdd = modal.querySelector('[name="og_add"]');
    
    if (odAdd && ogAdd) {
        odAdd.addEventListener('change', function() {
            const allAdds = modal.querySelectorAll('[name="og_add"], [name="od_add"]');
            allAdds.forEach(add => {
                if (add !== this) {
                    add.value = this.value;
                }
            });
        });
        
        ogAdd.addEventListener('change', function() {
            const allAdds = modal.querySelectorAll('[name="og_add"], [name="od_add"]');
            allAdds.forEach(add => {
                if (add !== this) {
                    add.value = this.value;
                }
            });
        });
    }
}

// Collecter toutes les données du formulaire
function collectAllFormData() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return {};
    
    const data = {};
    
    // 1. Collecter tous les champs du formulaire
    const allFormElements = modal.querySelectorAll('#client-form input, #client-form select, #client-form textarea');
    allFormElements.forEach(element => {
        if (element.name && !element.disabled) {
            // Gestion spéciale pour les boutons radio et checkbox
            if ((element.type === 'radio' || element.type === 'checkbox') && !element.checked) {
                return;
            }
            
            // Traitement spécial pour le champ choix_monture
            if (element.name === 'choix_monture' && element.value) {
                try {
                    const montureData = JSON.parse(element.value);
                    data['monture_reference'] = montureData.reference || '';
                    data['monture_prix'] = montureData.prix || 0;
                    data['monture_stock_virtuel'] = montureData.stockVirtuel || 0;
                    data['monture_agence'] = montureData.agence || '';
                    data[element.name] = montureData.reference || ''; // Garder la référence simple
                } catch (e) {
                    data[element.name] = element.value;
                }
            } else {
                data[element.name] = element.value;
            }
        }
    });
    
    // 2. Gestion des champs de prescription
    const prescriptionFields = [
        'od_sphere', 'od_cylindre', 'od_axe', 'od_add', 'od_dp', 'od_hauteur',
        'og_sphere', 'og_cylindre', 'og_axe', 'og_add', 'og_dp', 'og_hauteur'
    ];
    
    prescriptionFields.forEach(field => {
        let value = '';
        
        // Chercher dans tous les éléments
        const elements = modal.querySelectorAll(`[name="${field}"]`);
        for (const element of elements) {
            if (element && element.value) {
                value = element.value;
                break;
            }
        }
        
        // Appliquer la valeur (même si vide)
        data[field] = value || '0';
    });
    
    // 3. Collecter les champs d'input supplémentaires
    const additionalFields = [
        'clinique_input', 'ophtalmo_input', 'assurance_input', 
        'compagnie_input', 'entreprise_input', 'commercial_input'
    ];
    
    additionalFields.forEach(field => {
        const element = modal.querySelector(`#${field}`);
        if (element && element.value) {
            const fieldName = field.replace('_input', '');
            data[fieldName] = element.value;
        }
    });
    
    return data;
}

// Configuration des événements
function setupEventListeners() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    // Fermeture de la modal au clic en dehors
    modal.addEventListener('click', function(event) {
        if (event.target === modal) {
            if (confirm('Voulez-vous annuler et fermer le formulaire ?')) {
                closeModal();
            }
        }
    });
    
    // Boutons de navigation
    const nextBtn = modal.querySelector('#nextStepBtn');
    const prevBtn = modal.querySelector('#prevStepBtn');
    
    if (nextBtn) nextBtn.addEventListener('click', nextStep);
    if (prevBtn) prevBtn.addEventListener('click', prevStep);
    
    // Boutons d'action
    const resetBtn = modal.querySelector('#resetButton');
    const cancelBtn = modal.querySelector('#cancelButton');
    const form = modal.querySelector('#client-form');
    
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment réinitialiser le formulaire ?')) {
                form.reset();
                // Réinitialiser les dates
                const today = new Date();
                const deliveryDate = new Date(today);
                deliveryDate.setDate(today.getDate() + 15);
                
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                document.getElementById('date_soin').value = formatDate(today);
                document.getElementById('date_livraison').value = formatDate(deliveryDate);
                document.getElementById('date_naissance').value = '2000-01-01';
                
                // Réinitialiser le champ monture
                const montureSelect = document.getElementById('choix_monture');
                if (montureSelect) {
                    montureSelect.disabled = true;
                    montureSelect.innerHTML = '<option value="">-- Sélectionnez d\'abord une agence --</option>';
                    montureSelect.classList.add('monture-select-disabled');
                }
                
                const nomComplet = modal.querySelector('#nom_complet');
                if (nomComplet) nomComplet.focus();
                calculerTotal();
                showSuccess('Formulaire réinitialisé avec succès !');
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment annuler et fermer le formulaire ?')) {
                closeModal();
            }
        });
    }
    
    // Calcul automatique pour tous les champs pertinents
    const calcFields = [
        'montant_monture', 'montant_verres', 'frais_livraison',
        'remise', 'part_assurance', 'acompte'
    ];
    calcFields.forEach(id => {
        const field = modal.querySelector(`#${id}`);
        if (field) field.addEventListener('input', calculerTotal);
    });
    
    // Écouteur pour le type de remise (FCFA ou %)
    const remiseType = modal.querySelector('#remise_type');
    if (remiseType) remiseType.addEventListener('change', calculerTotal);
    
    // Synchronisation automatique de l'ADD OD vers OG
    const odAdd = modal.querySelector('[name="od_add"]');
    if (odAdd) {
        odAdd.addEventListener('change', function() {
            const odAddValue = this.value;
            const ogAddSelect = modal.querySelector('[name="og_add"]');
            if (odAddValue && ogAddSelect) {
                ogAddSelect.value = odAddValue;
            }
        });
    }
    
    // Gestion de l'affichage conditionnel pour l'assuré principal
    const assurePrincipal = modal.querySelector('#assure_principal');
    if (assurePrincipal) {
        assurePrincipal.addEventListener('change', function() {
            const container = modal.querySelector('#assure_principal_nom_container');
            const input = modal.querySelector('#assure_principal_nom');
            const nomComplet = modal.querySelector('#nom_complet');
            
            if (!container || !input) return;
            
            if (this.value === 'oui') {
                container.style.display = 'block';
                input.value = nomComplet?.value || '';
                input.readOnly = true;
                input.style.backgroundColor = '#f0f0f0';
            } else if (this.value === 'non') {
                container.style.display = 'block';
                input.readOnly = false;
                input.style.backgroundColor = '';
                input.value = '';
            } else {
                container.style.display = 'none';
            }
        });
    }
    
    // Gestion du type de contact pour la livraison
    const contactLivraisonType = modal.querySelector('#contact_livraison_type');
    if (contactLivraisonType) {
        contactLivraisonType.addEventListener('change', function() {
            const telephoneContact = modal.querySelector('#telephone_contact');
            const adresseLivraison = modal.querySelector('#adresse_livraison');
            const clientIndicatif = modal.querySelector('#indicatif')?.value || '+229';
            const clientNumero = modal.querySelector('#numero')?.value || '';
            const clientTel = `${clientIndicatif} ${clientNumero}`;
            const agence = modal.querySelector('#agence')?.value || '';
            
            if (!telephoneContact || !adresseLivraison) return;
            
            if (this.value === 'client') {
                telephoneContact.value = clientTel;
                telephoneContact.readOnly = true;
                telephoneContact.style.backgroundColor = '#f0f0f0';
                
                if (agence) {
                    // Simuler une adresse d'agence (vous devrez adapter selon vos données)
                    const adressesAgences = {
                        'Agence Cotonou': '123 Avenue principale, Cotonou',
                        'Agence Porto-Novo': '456 Rue centrale, Porto-Novo'
                    };
                    
                    adresseLivraison.value = adressesAgences[agence] || agence;
                    adresseLivraison.readOnly = true;
                    adresseLivraison.style.backgroundColor = '#f0f0f0';
                    const fraisLivraison = modal.querySelector('#frais_livraison');
                    if (fraisLivraison) fraisLivraison.value = 0;
                    calculerTotal();
                }
            } else if (this.value === 'tiers') {
                telephoneContact.readOnly = false;
                telephoneContact.style.backgroundColor = '';
                // Réinitialiser uniquement si c'était le téléphone du client
                if (telephoneContact.value === clientTel) {
                    telephoneContact.value = '+229 ';
                }
                
                adresseLivraison.readOnly = false;
                adresseLivraison.style.backgroundColor = '';
                adresseLivraison.value = '';
            }
        });
    }
    
    // Soumission du formulaire
    if (form) {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Validation finale
            if (!validateStep(currentStep)) {
                showError('Veuillez corriger les erreurs avant de soumettre');
                return;
            }

            // Afficher la boîte de confirmation
            const confirmation = await showConfirmation(
                'Confirmer la vente',
                'Êtes-vous sûr de vouloir enregistrer cette vente ?',
                'Oui, enregistrer',
                'Annuler'
            );

            if (!confirmation) {
                return; // L'utilisateur a annulé
            }

            // Afficher le statut d'envoi
            showSendingStatus();
            
            const data = collectAllFormData();
            
            console.log('Données à envoyer:', data);
            
            // Désactiver le bouton de soumission
            const submitBtn = modal.querySelector('#submitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
            }

            try {
                // Simuler un délai d'envoi
                await new Promise(resolve => setTimeout(resolve, 1500));
                const response = await fetch(SUBMIT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                // Afficher le statut de succès
                showSuccessStatus();
                
                // Fermer la modal après un délai
                setTimeout(() => {
                    showSuccess('Vente enregistrée avec succès !');
                    closeModal();
                    
                }, 1500);
                

            } catch (error) {
                console.error('Erreur lors de l\'envoi des données :', error);
                hideLoadingBar();
                showError('Erreur lors de l\'envoi des données. Veuillez réessayer.');
            } finally {
                // Réactiver le bouton de soumission
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Ajouter';
                }
                hideStatusMessage();
            }
        });
    }
}

// Fonction pour afficher la barre de chargement
function showLoadingBar() {
    let loadingBarContainer = document.getElementById('loadingBarContainer');
    
    if (!loadingBarContainer) {
        loadingBarContainer = document.createElement('div');
        loadingBarContainer.id = 'loadingBarContainer';
        loadingBarContainer.className = 'loading-bar-container';
        loadingBarContainer.innerHTML = '<div class="loading-bar"></div>';
        document.body.appendChild(loadingBarContainer);
    }
    
    loadingBarContainer.style.display = 'block';
    const loadingBar = loadingBarContainer.querySelector('.loading-bar');
    loadingBar.style.width = '0%';
    
    // Animation progressive
    setTimeout(() => loadingBar.style.width = '30%', 100);
    setTimeout(() => loadingBar.style.width = '60%', 500);
    setTimeout(() => loadingBar.style.width = '90%', 1000);
}

// Fonction pour masquer la barre de chargement
function hideLoadingBar() {
    const loadingBarContainer = document.getElementById('loadingBarContainer');
    if (loadingBarContainer) {
        const loadingBar = loadingBarContainer.querySelector('.loading-bar');
        loadingBar.style.width = '100%';
        
        setTimeout(() => {
            loadingBarContainer.style.display = 'none';
        }, 300);
    }
}

// Fonction pour afficher le statut d'envoi
function showSendingStatus() {
    showStatusMessage('Envoi en cours', 'Traitement de votre commande...');
    showLoadingBar();
}

// Fonction pour afficher le statut de confirmation
function showSuccessStatus() {
    showStatusMessage('Succès', 'Commande enregistrée avec succès !', true);
    hideLoadingBar();
}

function showConfirmation(title, message, confirmText = 'Confirmer', cancelText = 'Annuler') {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'confirmation-overlay';
        
        const box = document.createElement('div');
        box.className = 'confirmation-box';
        box.innerHTML = `
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="loading-spinner"></div>
            <div class="confirmation-buttons">
                <button class="btn btn-confirm">${confirmText}</button>
                <button class="btn btn-cancel">${cancelText}</button>
            </div>
        `;
        
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        const confirmBtn = box.querySelector('.btn-confirm');
        const cancelBtn = box.querySelector('.btn-cancel');

        const cleanUp = () => {
            document.body.removeChild(overlay);
        };

        const handleConfirm = () => {
            box.classList.add('loading');
            setTimeout(() => {
                cleanUp();
                resolve(true);
            }, 1500);
        };

        const handleCancel = () => {
            cleanUp();
            resolve(false);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);
        
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                handleCancel();
            }
        });
        
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                handleCancel();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    });
}
        
// Calculs financiers
function calculerTotal() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const getValue = id => {
        const element = modal.querySelector(`#${id}`);
        if (!element) return 0;
        const value = parseFloat(element.value);
        return isNaN(value) ? 0 : value;
    };

    const montantMonture = getValue('montant_monture');
    const montantVerres = getValue('montant_verres');
    const fraisLivraison = getValue('frais_livraison');
    const remise = getValue('remise');
    const remiseType = modal.querySelector('#remise_type')?.value || 'FCFA';
    const partAssurance = getValue('part_assurance');
    const acompte = getValue('acompte');
    
    // Calcul automatique de la TVA (18% du montant monture TTC)
    const tvaMonture = montantMonture*(18/118);
    
    // Mettre à jour le champ TVA (lecture seule)
    const tvaInput = modal.querySelector('#tva');
    if (tvaInput) {
        tvaInput.value = Math.round(tvaMonture);
    }
    

    const totalBrut = montantMonture + montantVerres + fraisLivraison;
    
    let montantRemise = 0;
    if (remiseType === '%') {
        montantRemise = totalBrut * (remise / 100);
    } else {
        montantRemise = remise;
    }

    const netAPayer = Math.max(0, totalBrut - montantRemise - partAssurance);
    const resteAPayer = Math.max(0, netAPayer - acompte);
    
    // Affichage avec formatage
    const formatCurrency = (amount) => {
        return Math.round(amount).toLocaleString('fr-FR');
    };
    
    const totalBrutInput = modal.querySelector('#total_brut');
    const totalBrutDisplay = modal.querySelector('#total_brut_display');
    if (totalBrutInput && totalBrutDisplay) {
        totalBrutInput.value = Math.round(totalBrut);
        totalBrutDisplay.textContent = formatCurrency(totalBrut);
    }
    
    const netAPayerInput = modal.querySelector('#net_a_payer');
    const netAPayerDisplay = modal.querySelector('#net_a_payer_display');
    if (netAPayerInput && netAPayerDisplay) {
        netAPayerInput.value = Math.round(netAPayer);
        netAPayerDisplay.textContent = formatCurrency(netAPayer);
    }
    
    const resteAPayerInput = modal.querySelector('#reste_a_payer');
    const resteAPayerDisplay = modal.querySelector('#reste_a_payer_display');
    if (resteAPayerInput && resteAPayerDisplay) {
        resteAPayerInput.value = Math.round(resteAPayer);
        resteAPayerDisplay.textContent = formatCurrency(resteAPayer);
    }
}

// Fonction pour remplir une liste déroulante
function populateSelect(id, options) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const select = modal.querySelector(`#${id}`);
    if (!select) return;
    
    // Sauvegarder la valeur sélectionnée actuelle
    const currentValue = select.value;
    
    // Vider le select sauf la première option
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Ajouter les nouvelles options
    options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
    
    // Restaurer la valeur sélectionnée si elle existe toujours
    if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
    }
}

// Fonction pour remplir les options de prescription
function populatePrescriptionOptions(selectName, values) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    // Sélectionner TOUS les selects avec ce nom
    const selects = modal.querySelectorAll(`select[name="${selectName}"]`);
    
    if (!selects || selects.length === 0) return;
    
    // Parcourir TOUS les selects
    selects.forEach(select => {
        const currentValue = select.value;
        
        // Vider le select sauf la première option
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // Ajouter les nouvelles options
        values.forEach(value => {
            const opt = document.createElement('option');
            opt.value = value;
            opt.textContent = value;
            select.appendChild(opt);
        });
        
        // Restaurer la valeur sélectionnée si elle existe toujours
        if (currentValue && values.includes(currentValue)) {
            select.value = currentValue;
        }
    });
}

// Fonction principale de chargement des données
async function loadDataFromSheet() {
    showStatusMessage('Chargement des données...');
    
    try {
        const response = await fetch(DATA_SOURCE_URL);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const data = await response.json();
        
        if (!data.success) throw new Error("Réponse invalide du serveur.");
        if (!data.data) throw new Error("Données manquantes dans la réponse");

        populateFormWithData(data.data);
        
    } catch (error) {
        console.error('Erreur lors du chargement:', error);
        showError(`Erreur lors du chargement: ${error.message}`);
    } finally {
        hideStatusMessage();
    }
}

// Fonction pour remplir le formulaire avec les données
function populateFormWithData(data) {
    if (!data) return;
    
    // Liste des champs à remplir (EXCLURE choix_monture car chargé dynamiquement)
    const fieldsToPopulate = [
        { id: 'entreprise', data: data.entreprises },
        { id: 'agence', data: data.agences },
        { id: 'commercial', data: data.commerciaux },
        { id: 'type_verre', data: data.typesVerre },
        { id: 'gamme_verre', data: data.gammesVerre },
        // NE PAS inclure choix_monture ici car chargé dynamiquement selon l'agence
        { id: 'clinique', data: data.cliniques },
        { id: 'ophtalmo', data: data.ophtalmos },
        { id: 'assurance', data: data.assurances },
        { id: 'compagnie', data: data.compagnies },
        { id: 'infos_complementaires', data: data.infos_complementaires }
    ];

    fieldsToPopulate.forEach(field => {
        if (Array.isArray(field.data)) {
            populateSelect(field.id, field.data);
        }
    });

    // Gestion des champs de prescription
    const prescriptionFields = [
        { name: 'od_sphere', data: data.sphere },
        { name: 'od_cylindre', data: data.sphere },
        { name: 'od_axe', data: data.axe },
        { name: 'od_add', data: data.add },
        { name: 'og_sphere', data: data.sphere },
        { name: 'og_cylindre', data: data.sphere },
        { name: 'og_axe', data: data.axe },
        { name: 'og_add', data: data.add }
    ];

    prescriptionFields.forEach(field => {
        if (Array.isArray(field.data)) {
            populatePrescriptionOptions(field.name, field.data);
        }
    });
}

// Fonction pour basculer entre select et input
function toggleInput(fieldName) {
    const select = document.getElementById(fieldName);
    const input = document.getElementById(`${fieldName}_input`);
    const button = event.currentTarget;
    
    if (input.style.display === 'none') {
        // Passer en mode saisie libre
        select.style.display = 'none';
        input.style.display = 'block';
        input.value = '';
        button.innerHTML = '<i class="fas fa-list"></i> Choisir existant';
        
        // Si une valeur était sélectionnée, la mettre dans l'input
        if (select.value && !select.options[select.selectedIndex].disabled) {
            input.value = select.options[select.selectedIndex].text;
        }
    } else {
        // Revenir en mode sélection
        select.style.display = 'block';
        input.style.display = 'none';
        button.innerHTML = '<i class="fas fa-plus"></i> Ajouter nouveau';
        
        // Si l'input contient une valeur, l'ajouter aux options
        if (input.value.trim()) {
            addOptionIfNotExists(select, input.value.trim());
        }
    }
}

// Ajouter une option si elle n'existe pas déjà
function addOptionIfNotExists(selectElement, value) {
    // Vérifier si la valeur existe déjà
    for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].text === value) {
            selectElement.value = value;
            return;
        }
    }
    
    // Ajouter la nouvelle option
    const option = document.createElement('option');
    option.value = value;
    option.text = value;
    selectElement.add(option);
    selectElement.value = value;
}

// Fonction pour configurer le champ utilisateur
function setupCurrentUserField() {
    const userField = document.getElementById('current_user');
    if (!userField) return;
    
    // Récupérer l'utilisateur connecté
    let currentUser = 'Non connecté';
    
    // Vérifier si un utilisateur est stocké en session/localStorage
    if (typeof localStorage !== 'undefined') {
        currentUser = localStorage.getItem('currentUser') || 
                     sessionStorage.getItem('currentUser') || 
                     'Non connecté';
    }
    
    userField.value = currentUser;
    
    // Ajouter un bouton pour changer d'utilisateur
    const userContainer = userField.parentElement;
    const changeUserBtn = document.createElement('button');
    changeUserBtn.type = 'button';
    changeUserBtn.className = 'btn btn-small';
    changeUserBtn.innerHTML = '<i class="fas fa-user-edit"></i>';
    changeUserBtn.style.marginLeft = '10px';
    changeUserBtn.title = 'Changer d\'utilisateur';
    changeUserBtn.onclick = function() {
        const newUser = prompt('Entrez le nom de l\'utilisateur :', currentUser);
        if (newUser) {
            userField.value = newUser;
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('currentUser', newUser);
            }
        }
    };
    
    userContainer.appendChild(changeUserBtn);
}

// Fonctions utilitaires
function showStatusMessage(title = 'Chargement', message = 'Veuillez patienter...', isSuccess = false) {
    let statusBox = document.getElementById('statusMessageBox');
    
    if (!statusBox) {
        statusBox = document.createElement('div');
        statusBox.id = 'statusMessageBox';
        statusBox.className = 'status-overlay';
        statusBox.innerHTML = `
            <div class="status-content ${isSuccess ? 'success' : ''}">
                ${!isSuccess ? '<div class="status-spinner"></div>' : ''}
                ${isSuccess ? '<i class="fas fa-check-circle status-icon"></i>' : ''}
                <h3>${title}</h3>
                <p>${message}</p>
            </div>
        `;
        document.body.appendChild(statusBox);
    } else {
        // Mise à jour dynamique
        const content = statusBox.querySelector('.status-content');
        const spinner = statusBox.querySelector('.status-spinner');
        const icon = statusBox.querySelector('.status-icon');
        
        content.className = `status-content ${isSuccess ? 'success' : ''}`;
        
        if (isSuccess) {
            if (spinner) spinner.remove();
            if (!icon) {
                content.insertAdjacentHTML('afterbegin', '<i class="fas fa-check-circle status-icon"></i>');
            }
        } else {
            if (icon) icon.remove();
            if (!spinner) {
                content.insertAdjacentHTML('afterbegin', '<div class="status-spinner"></div>');
            }
        }
        
        statusBox.querySelector('h3').textContent = title;
        statusBox.querySelector('p').textContent = message;
    }
}

function hideStatusMessage() {
    const statusBox = document.getElementById('statusMessageBox');
    if (statusBox) {
        statusBox.remove();
    }
}

function showSuccess(message) {
    hideStatusMessage();
    
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    document.body.appendChild(successDiv);
    successDiv.style.display = 'block';
    
    setTimeout(() => {
        successDiv.style.display = 'none';
        setTimeout(() => {
            document.body.removeChild(successDiv);
        }, 500);
    }, 3000);
}

function showError(message) {
    hideStatusMessage();
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    document.body.appendChild(errorDiv);
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
        errorDiv.style.display = 'none';
        setTimeout(() => {
            document.body.removeChild(errorDiv);
        }, 500);
    }, 5000);
}


// Initialiser la modal lorsque le DOM est chargé
document.addEventListener('DOMContentLoaded', function() {
    // Si la modal existe déjà dans le DOM, l'initialiser
    if (document.getElementById('newSaleModal')) {
        initModal();
    }
    
    // Initialiser d'autres composants si nécessaire
    if (document.getElementById("itemsPerPageSelect")) {
        document.getElementById("itemsPerPageSelect").addEventListener("change", function() {
            const itemsPerPage = parseInt(this.value);
            const currentPage = 1;
            // updateTableAndPagination(); // Fonction à définir
        });
    }
    
    if (document.getElementById("searchInput")) {
        document.getElementById("searchInput").addEventListener("input", function() {
            // applySearchFilter(); // Fonction à définir
        });
    }
});

// Pour afficher le bouton avec l'animation
function showSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.style.display = 'inline-block';
        submitBtn.classList.add('highlight');
        
        // Retirer la classe après l'animation pour pouvoir la réutiliser
        setTimeout(() => {
            submitBtn.classList.remove('highlight');
        }, 3000);
    }
}

// Ajouter l'écouteur pour la touche Échap
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('newSaleModal');
        if (modal && modal.classList.contains('active')) {
            if (confirm('Voulez-vous annuler et fermer le formulaire ?')) {
                closeModal();
            }
        }
    }
});
// ==================== Fonctions séparées pour plus de clarté ====================
    document.addEventListener('DOMContentLoaded', function() {
    // 1. Gestion de l'utilisateur et authentification
    handleUserSession();

    // 2. Initialisation des données et interface
    initializeDataAndUI();

    // 3. Gestion de la navigation par étapes (formulaire proforma)
    setupFormStepNavigation();
});

function handleUserSession() {
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");

    if (!username) {
        redirectToLogin();
        return;
    }

    // Afficher le nom d'utilisateur
    const usernameDisplay = document.getElementById("username-display");
    if (usernameDisplay) {
        usernameDisplay.textContent = username;
    }

    // Mettre à jour l'image de profil
    const profileImg = document.querySelector('.profile-img');
    if (profileImg) {
        profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=4361ee&color=fff`;
    }

    // Bouton déconnexion
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    // Lancer le timer d'inactivité
    startInactivityTimer();
}

function logout() {
    sessionStorage.removeItem("utilisateur");
    localStorage.removeItem("utilisateur");
    redirectToLogin();
}

function redirectToLogin() {
    window.location.href = "code.html";
}

function startInactivityTimer() {
    const INACTIVITY_LIMIT = 30 * 60 * 1000; // 1h
    let inactivityTimeout;

    function resetTimer() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(logout, INACTIVITY_LIMIT);
    }

    // Réinitialiser le timer sur chaque interaction
    ["load", "mousemove", "keydown", "click", "scroll"].forEach(event => {
        window.addEventListener(event, resetTimer, true);
    });

    resetTimer();
}

// Exécuter au chargement
handleUserSession();


// 2. Initialisation des données et interface
function initializeDataAndUI() {
    // Chargement des clients
    loadClientsFromScript();

    // Configuration de la recherche
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', applySearchFilter);
    }

    // Configuration de la pagination
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    
    if (prevPageBtn) prevPageBtn.addEventListener('click', goToPrevPage);
    if (nextPageBtn) nextPageBtn.addEventListener('click', goToNextPage);
}

// 3. Navigation par étapes du formulaire
function setupFormStepNavigation() {
    // Bouton Suivant - sans validation
    document.querySelectorAll('.next-step').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const currentSection = this.closest('.form-section');
            const nextStep = this.dataset.next;
            
            currentSection.classList.remove('active');
            document.getElementById(`section${nextStep}`).classList.add('active');
            updateStepper(nextStep);
        });
    });
    
    // Bouton Précédent (inchangé)
    document.querySelectorAll('.prev-step').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const currentSection = this.closest('.form-section');
            const prevStep = this.dataset.prev;
            currentSection.classList.remove('active');
            document.getElementById(`section${prevStep}`).classList.add('active');
            updateStepper(prevStep);
        });
    });

    // Bouton Annuler
    const cancelButton = document.getElementById('cancelButton');
    if (cancelButton) {
        cancelButton.addEventListener('click', closeModal);
    }
}
    
document.addEventListener('DOMContentLoaded', function() {
    setupFormStepNavigation();
    
    // Debug : Affiche tous les champs requis
    document.querySelectorAll('[required]').forEach(field => {
        field.addEventListener('change', function() {
            
        });
    });
});

// Fonction utilitaire pour changer de section
function switchSection(currentSection, targetStep) {
    currentSection.classList.remove('active');
    const nextSection = document.getElementById(`section${targetStep}`);
    if (nextSection) {
        nextSection.classList.add('active');
        updateStepper(targetStep);
        
        // Scroll vers le haut pour une meilleure UX
        nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}


function setupCurrentUserField() {
    // 1. Récupère l'utilisateur stocké
    const currentUser = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");
    
    // 2. Trouve le champ utilisateur dans le formulaire
    const userField = document.getElementById('current_user');
    
    // 3. Si le champ existe et qu'on a un utilisateur
    if (userField && currentUser) {
        // a. Affiche le nom dans le champ visible
        userField.value = currentUser;
        
        // b. Crée un champ caché pour l'envoi au serveur
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'utilisateur';
        hiddenInput.value = currentUser;
        hiddenInput.id = 'hidden_utilisateur';
        
        // c. Ajoute le champ caché au formulaire (s'il n'existe pas déjà)
        if (!document.getElementById('hidden_utilisateur')) {
            document.getElementById('client-form').appendChild(hiddenInput);
        }
    }
}
window.openJournalGrandCaisse = function () {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="grandCaisseModal">
            <div class="modal-content" style="max-width: 1600px;">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-cash-register"></i> Journal Grand Caisse</h3>
                </div>
                <div class="modal-body">
                    <div class="filters-card">
                        <div class="filters-container">
                        <div class="filter-item">
                                <label><i class="fas fa-exchange-alt"></i> Mouvement</label>
                                <select id="gcFilterMouvement" class="form-control">
                                    <option value="">Tous</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label><i class="fas fa-tags"></i> Catégorie</label>
                                <select id="gcFilterCategorie" class="form-control">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label><i class="fas fa-calendar-alt"></i> Période</label>
                                <div class="date-range">
                                    <input type="date" id="gcDateStart" class="form-control">
                                    <span>à</span>
                                    <input type="date" id="gcDateEnd" class="form-control">
                                </div>
                            </div>

                            <div class="filter-item">
                                <button class="btn btn-outline-secondary" onclick="resetGrandCaisseFilter()">
                                    <i class="fas fa-undo"></i> Réinitialiser
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-card">
                        <div class="table-responsive">
                            <table class="grandcaisse-table" id="grandCaisseTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Désignation</th>
                                        <th class="text-right">Montant</th>
                                        <th>Mouvement</th>
                                        <th>Agence</th>
                                        <th>En caisse</th>
                                        <th>Mode de Paiement</th>
                                        <th>Catégorie</th>
                                    </tr>
                                </thead>
                                <tbody id="grandCaisseData">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="grandcaisse-message" class="alert alert-info mt-3" style="display:none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="openAjoutGrandCaisse()">
                        <i class="fas fa-plus"></i> Ajouter
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="printGrandCaisse()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-close-modal" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('grandCaisseModal').classList.add('active');
        loadGrandCaisseData();
    }, 10);
};

// Variables
let allGrandCaisseData = [];
let uniqueMouvements = [];
let uniqueCategories = [];

// Charger les données
async function loadGrandCaisseData() {
    const tbody = document.getElementById('grandCaisseData');
    const msgDiv = document.getElementById('grandcaisse-message');
    tbody.innerHTML = `<tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>`;
    msgDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=grandcaisse`;
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const data = await response.json();
        if (!data?.data?.rows) throw new Error('Structure de données invalide');

        const headers = data.data.headers;
        allGrandCaisseData = data.data.rows.map(row => ({
            Date: row[headers.indexOf('Date')] ? new Date(row[headers.indexOf('Date')]) : null,
            Designation: row[headers.indexOf('Designation')] || '',
            Montant: parseFloat(row[headers.indexOf('Montant')]) || 0,
            Mouvement: row[headers.indexOf('Mouvement')] || '',
            Agence: row[headers.indexOf('Agence')] || '',
            EnCaisse: row[headers.indexOf('En caisse')] || '',
            ModePaiement: row[headers.indexOf('Mode de Paiement')] || '',
            Categorie: row[headers.indexOf('Categorie')] || ''
        }));

        uniqueMouvements = [...new Set(allGrandCaisseData.map(i => i.Mouvement).filter(Boolean))];
        uniqueCategories = [...new Set(allGrandCaisseData.map(i => i.Categorie).filter(Boolean))];

        populateFilterOptions('gcFilterMouvement', uniqueMouvements);
        populateFilterOptions('gcFilterCategorie', uniqueCategories);

        setupGrandCaisseFilters();
        displayGrandCaisseData(allGrandCaisseData);

    } catch (err) {
        console.error('[Grand Caisse] Erreur:', err);
        showGrandCaisseMessage(`❌ Erreur: ${err.message}`, 'danger');
        tbody.innerHTML = `<tr><td colspan="8" class="text-center">Erreur de chargement</td></tr>`;
    }
}

function populateFilterOptions(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">${selectId.includes('Mouvement') ? 'Tous' : 'Toutes'}</option>`;
    values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
    });
}

function setupGrandCaisseFilters() {
    document.getElementById('gcDateStart').addEventListener('input', applyGrandCaisseFilter);
    document.getElementById('gcDateEnd').addEventListener('input', applyGrandCaisseFilter);
    document.getElementById('gcFilterMouvement').addEventListener('change', applyGrandCaisseFilter);
    document.getElementById('gcFilterCategorie').addEventListener('change', applyGrandCaisseFilter);
}

function displayGrandCaisseData(data) {
    const tbody = document.getElementById('grandCaisseData');
    if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center">Aucune donnée disponible</td></tr>`;
        return;
    }
    tbody.innerHTML = data.map(item => `
        <tr>
            <td>${item.Date?.toLocaleDateString('fr-FR') || 'N/A'}</td>
            <td>${item.Designation}</td>
            <td class="text-right">${item.Montant.toLocaleString('fr-FR', {minimumFractionDigits:2})}</td>
            <td>${item.Mouvement}</td>
            <td>${item.Agence}</td>
            <td>${item.EnCaisse}</td>
            <td>${item.ModePaiement}</td>
            <td>${item.Categorie}</td>
        </tr>
    `).join('');
}

function applyGrandCaisseFilter() {
    const start = document.getElementById('gcDateStart').value ? new Date(document.getElementById('gcDateStart').value) : null;
    const end = document.getElementById('gcDateEnd').value ? new Date(document.getElementById('gcDateEnd').value) : null;
    const mouvement = document.getElementById('gcFilterMouvement').value;
    const categorie = document.getElementById('gcFilterCategorie').value;

    let filtered = [...allGrandCaisseData];

    if (start || end) {
        filtered = filtered.filter(i => {
            if (!i.Date) return false;
            if (start && end) return i.Date >= start && i.Date <= end;
            if (start) return i.Date >= start;
            if (end) return i.Date <= end;
            return true;
        });
    }

    if (mouvement) filtered = filtered.filter(i => i.Mouvement === mouvement);
    if (categorie) filtered = filtered.filter(i => i.Categorie === categorie);

    displayGrandCaisseData(filtered);
}

function resetGrandCaisseFilter() {
    document.getElementById('gcDateStart').value = '';
    document.getElementById('gcDateEnd').value = '';
    document.getElementById('gcFilterMouvement').value = '';
    document.getElementById('gcFilterCategorie').value = '';
    displayGrandCaisseData(allGrandCaisseData);
    showGrandCaisseMessage(`↻ Affichage de toutes les ${allGrandCaisseData.length} entrées`, 'info');
}

function showGrandCaisseMessage(msg, type) {
    const div = document.getElementById('grandcaisse-message');
    div.textContent = msg;
    div.className = `alert alert-${type}`;
    div.style.display = 'block';
}

// Impression
function printGrandCaisse() {
    try {
        const printWindow = window.open('', '_blank');
        const printContent = document.getElementById('grandCaisseTable').cloneNode(true);

        let total = 0;
        printContent.querySelectorAll('tbody tr').forEach(row => {
            const cell = row.cells[2]?.textContent;
            if (cell) {
                const amount = parseFloat(cell.replace(/[^\d,.-]/g, '').replace(',', '.'));
                if (!isNaN(amount)) total += amount;
            }
        });

        const totalRow = document.createElement('tr');
        totalRow.innerHTML = `<td colspan="2" class="text-right"><strong>Total</strong></td>
                              <td class="text-right"><strong>${total.toLocaleString('fr-FR',{minimumFractionDigits:2})}</strong></td>
                              <td colspan="5"></td>`;
        printContent.querySelector('tbody').appendChild(totalRow);

        const styles = `
            <style>
                body { font-family: Arial; margin:15px; }
                h1 { text-align:center; }
                table { width:100%; border-collapse:collapse; margin-top:10px; }
                th,td { border:1px solid #ddd; padding:8px; }
                th { background:#f2f2f2; }
                .text-right{text-align:right;}
                @page { margin: 10mm; }
            </style>
        `;

        printWindow.document.write(`
            <html>
                <head><title>Journal Grand Caisse</title>${styles}</head>
                <body>
                    <h1>Journal Grand Caisse</h1>
                    <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                    ${printContent.outerHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); printWindow.close(); };

    } catch (err) {
        console.error('Erreur impression:', err);
        alert("Erreur lors de l'impression");
    }
}

// Variables globales pour les transactions bancaires
let allBanqueData = [];
let uniqueBanqueDesignations = [];
let uniqueBanqueTypes = [];
let uniqueBanqueCategories = [];
let currentFilteredBanque = [];
let banqueCategories = [];

// Charger les catégories de configuration
async function loadConfigData() {
    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getconfigdata');
        const json = await response.json();

        if (json.success && json.data?.categories) {
            banqueCategories = json.data.categories;
           
        } else {
            banqueCategories = [];
          
        }
    } catch (error) {
        console.error("❌ Erreur lors du chargement des catégories :", error);
        banqueCategories = [];
    }
}


// Variables pour les graphiques
let salesChart = null;
let currentPeriod = 'thisMonth';

// Initialisation des graphiques
function initializeCharts() {
   
   
    
    setupChartPeriodListener();
    loadChartData();
}

// Écouteur pour le changement de période
function setupChartPeriodListener() {
    const periodSelect = document.getElementById('chartPeriod');
    if (periodSelect) {
        periodSelect.addEventListener('change', function() {
            currentPeriod = this.value;
           
            loadChartData();
        });
    }
}

// Chargement des données pour les graphiques
async function loadChartData() {
    
    try {
        if (allClientsData.length === 0) {
           
            return;
        }
        
        const chartData = await generateChartData(currentPeriod);
        
        renderSalesChart(chartData);
        renderDataTables(chartData);
    } catch (error) {
        console.error('Erreur chargement données graphiques:', error);
    }
}

// Fonction manquante : Génération de données de démonstration basées sur les clients
function generateChartData(period) {
    return new Promise((resolve) => {
       
        
        // Normaliser les données clients
        const normalizedClients = normalizeClientData(allClientsData);
        
        
        // Filtrer les données clients selon la période
        const filteredData = filterClientsByPeriod(normalizedClients, period);
       
        
        // Calculer les statistiques
        const stats = calculateStatistics(filteredData, period);
       
        
        resolve(stats);
    });
}

// Fonction pour normaliser les données clients
function normalizeClientData(clients) {
    if (clients.length === 0) return [];
    
    // Utiliser les headers stockés globalement
    if (tableHeaders && tableHeaders.length > 0) {
        return clients.map(row => {
            const client = {};
            tableHeaders.forEach((header, index) => {
                client[header] = row[index] || '';
            });
            return client;
        });
    } else {
        // Fallback si pas de headers disponibles
        const defaultHeaders = ['ID', 'Nom', 'Prénom', 'Date Enregistrement', 'Montant TTC', 'Agence'];
        return clients.map(row => {
            const client = {};
            defaultHeaders.forEach((header, index) => {
                client[header] = row[index] || '';
            });
            return client;
        });
    }
}
// Parse date au format DD/MM/YYYY
function parseDate(dateString) {
    if (!dateString) return new Date();
    
  
    
    // Essayer le format DD/MM/YYYY
    const parts = dateString.split('/');
    if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1;
        const year = parseInt(parts[2]);
        return new Date(year, month, day);
    }
    
    // Essayer le format YYYY-MM-DD
    if (dateString.includes('-')) {
        return new Date(dateString);
    }
    
    // Essayer de parser directement
    return new Date(dateString);
}

// Filtrage des clients par période (nouvelle version)
function filterClientsByPeriod(clients, period) {
    const now = new Date();
    let startDate = new Date();
    let endDate = new Date();
    
    switch(period) {
        case 'today':
            // Aujourd'hui seulement
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            break;
            
        case 'thisWeek':
            // Cette semaine (lundi à dimanche)
            const dayOfWeek = now.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            startDate.setDate(now.getDate() + diffToMonday);
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            break;
            
        case 'lastWeek':
            // Semaine passée
            const dayOfWeekLast = now.getDay();
            const diffToMondayLast = dayOfWeekLast === 0 ? -6 : 1 - dayOfWeekLast;
            startDate.setDate(now.getDate() + diffToMondayLast - 7);
            startDate.setHours(0, 0, 0, 0);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23, 59, 59, 999);
            break;
            
        case 'thisMonth':
            // Ce mois (du 1er au dernier jour)
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            break;
            
        case 'lastMonth':
            // Mois passé
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
            break;
            
        case 'thisYear':
            // Cette année
            startDate = new Date(now.getFullYear(), 0, 1);
            endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
            break;
            
        case 'lastYear':
            // Année passée
            startDate = new Date(now.getFullYear() - 1, 0, 1);
            endDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
            break;
            
        default:
            // Cette semaine par défaut
            const dayOfWeekDefault = now.getDay();
            const diffToMondayDefault = dayOfWeekDefault === 0 ? -6 : 1 - dayOfWeekDefault;
            startDate.setDate(now.getDate() + diffToMondayDefault);
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
    }
    
    
    
    return clients.filter(client => {
        const dateStr = client['Date Enregistrement'] || client['Date'] || '';
        if (!dateStr) return false;
        
        const clientDate = parseDate(dateStr);
        return clientDate >= startDate && clientDate <= endDate;
    });
}

// Génération des données de timeline adaptée aux nouvelles périodes
function generateTimelineData(clients, period) {
    
    
    const now = new Date();
    let timeline = [];
    
    switch(period) {
        case 'today':
            timeline = generateHourlyTimeline(clients, now);
            break;
            
        case 'thisWeek':
        case 'lastWeek':
            timeline = generateDailyTimeline(clients, period);
            break;
            
        case 'thisMonth':
        case 'lastMonth':
            timeline = generateWeeklyTimeline(clients, period);
            break;
            
        case 'thisYear':
        case 'lastYear':
            timeline = generateMonthlyTimeline(clients, period);
            break;
            
        default:
            timeline = generateDailyTimeline(clients, 'thisWeek');
    }
    
   
    return timeline;
}

// Timeline horaire pour "Aujourd'hui"
function generateHourlyTimeline(clients, date) {
    const timeline = [];
    const agencies = getAgenciesFromClients(clients);
    
    for (let hour = 0; hour < 24; hour++) {
        const periodStart = new Date(date);
        periodStart.setHours(hour, 0, 0, 0);
        
        const periodEnd = new Date(date);
        periodEnd.setHours(hour, 59, 59, 999);
        
        const point = {
            date: `${hour}h`,
            total: 0
        };
        
        // Initialiser les agences
        agencies.forEach(agency => {
            point[agency] = 0;
        });
        
        // Calculer les CA pour cette heure
        clients.forEach(client => {
            const dateStr = client['Date Enregistrement'] || client['Date'] || '';
            if (!dateStr) return;
            
            const clientDate = parseDate(dateStr);
            if (clientDate >= periodStart && clientDate <= periodEnd) {
                const agency = getAgencyFromClient(client);
                const montant = parseFloat(client['Montant TTC'] || client['Montant'] || 0);
                
                point[agency] = (point[agency] || 0) + montant;
                point.total += montant;
            }
        });
        
        timeline.push(point);
    }
    
    return timeline;
}

// Timeline quotidienne pour les semaines
function generateDailyTimeline(clients, period) {
    const timeline = [];
    const agencies = getAgenciesFromClients(clients);
    const now = new Date();
    
    let startDate = new Date();
    let days = 7;
    
    if (period === 'thisWeek') {
        const dayOfWeek = now.getDay();
        const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        startDate.setDate(now.getDate() + diffToMonday);
    } else if (period === 'lastWeek') {
        const dayOfWeek = now.getDay();
        const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        startDate.setDate(now.getDate() + diffToMonday - 7);
    }
    
    startDate.setHours(0, 0, 0, 0);
    
    for (let i = 0; i < days; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const periodStart = new Date(currentDate);
        periodStart.setHours(0, 0, 0, 0);
        
        const periodEnd = new Date(currentDate);
        periodEnd.setHours(23, 59, 59, 999);
        
        const point = {
            date: currentDate.toLocaleDateString('fr-FR', { 
                weekday: 'short',
                day: 'numeric'
            }),
            total: 0
        };
        
        // Initialiser les agences
        agencies.forEach(agency => {
            point[agency] = 0;
        });
        
        // Calculer les CA pour ce jour
        clients.forEach(client => {
            const dateStr = client['Date Enregistrement'] || client['Date'] || '';
            if (!dateStr) return;
            
            const clientDate = parseDate(dateStr);
            if (clientDate >= periodStart && clientDate <= periodEnd) {
                const agency = getAgencyFromClient(client);
                const montant = parseFloat(client['Montant TTC'] || client['Montant'] || 0);
                
                point[agency] = (point[agency] || 0) + montant;
                point.total += montant;
            }
        });
        
        timeline.push(point);
    }
    
    return timeline;
}

// Timeline hebdomadaire pour les mois
function generateWeeklyTimeline(clients, period) {
    const timeline = [];
    const agencies = getAgenciesFromClients(clients);
    const now = new Date();
    
    let startDate = new Date();
    let endDate = new Date();
    
    if (period === 'thisMonth') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    } else if (period === 'lastMonth') {
        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), 0);
    }
    
    // Calculer le nombre de semaines dans le mois
    const firstDay = startDate.getDay();
    const lastDate = endDate.getDate();
    const weeks = Math.ceil((firstDay + lastDate) / 7);
    
    for (let week = 0; week < weeks; week++) {
        const weekStart = new Date(startDate);
        weekStart.setDate(startDate.getDate() + (week * 7) - firstDay);
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        weekEnd.setHours(23, 59, 59, 999);
        
        // Ajuster pour ne pas dépasser la fin du mois
        if (weekEnd > endDate) {
            weekEnd.setTime(endDate.getTime());
        }
        
        const point = {
            date: `S${week + 1} (${weekStart.getDate()}/${weekStart.getMonth() + 1})`,
            total: 0
        };
        
        // Initialiser les agences
        agencies.forEach(agency => {
            point[agency] = 0;
        });
        
        // Calculer les CA pour cette semaine
        clients.forEach(client => {
            const dateStr = client['Date Enregistrement'] || client['Date'] || '';
            if (!dateStr) return;
            
            const clientDate = parseDate(dateStr);
            if (clientDate >= weekStart && clientDate <= weekEnd) {
                const agency = getAgencyFromClient(client);
                const montant = parseFloat(client['Montant TTC'] || client['Montant'] || 0);
                
                point[agency] = (point[agency] || 0) + montant;
                point.total += montant;
            }
        });
        
        timeline.push(point);
    }
    
    return timeline;
}

// Timeline mensuelle pour les années
function generateMonthlyTimeline(clients, period) {
    const timeline = [];
    const agencies = getAgenciesFromClients(clients);
    const now = new Date();
    
    const year = period === 'thisYear' ? now.getFullYear() : now.getFullYear() - 1;
    const months = 12;
    
    for (let month = 0; month < months; month++) {
        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0, 23, 59, 59, 999);
        
        const point = {
            date: monthStart.toLocaleDateString('fr-FR', { 
                month: 'short'
            }),
            total: 0
        };
        
        // Initialiser les agences
        agencies.forEach(agency => {
            point[agency] = 0;
        });
        
        // Calculer les CA pour ce mois
        clients.forEach(client => {
            const dateStr = client['Date Enregistrement'] || client['Date'] || '';
            if (!dateStr) return;
            
            const clientDate = parseDate(dateStr);
            if (clientDate >= monthStart && clientDate <= monthEnd) {
                const agency = getAgencyFromClient(client);
                const montant = parseFloat(client['Montant TTC'] || client['Montant'] || 0);
                
                point[agency] = (point[agency] || 0) + montant;
                point.total += montant;
            }
        });
        
        timeline.push(point);
    }
    
    return timeline;
}

// Helper functions
function getAgenciesFromClients(clients) {
    return Array.from(new Set(clients.map(client => getAgencyFromClient(client))));
}

function getAgencyFromClient(client) {
    if (client['Agence']) {
        return client['Agence'];
    } else if (client['ID'] && client['ID'].includes('PORT')) {
        return 'Porto-Nouvo';
    } else if (client['ID'] && client['ID'].includes('COTO')) {
        return 'Cotonou';
    }
    return 'Cotonou'; // Par défaut
}

// Fonction manquante : Calcul des indicateurs clés
function calculateKeyMetrics(clients) {
    const totalVentes = clients.length;
    const totalCA = clients.reduce((sum, client) => {
        const montant = parseFloat(client['Montant TTC'] || client['Montant'] || 0);
        return sum + montant;
    }, 0);
    
    const moyennePanier = totalVentes > 0 ? totalCA / totalVentes : 0;
    
    // Taux de conversion basé sur les clients avec montant > 0
    const clientsAvecAchat = clients.filter(client => {
        const montant = parseFloat(client['Montant TTC'] || client['Montant'] || 0);
        return montant > 0;
    }).length;
    
    const tauxConversion = totalVentes > 0 ? (clientsAvecAchat / totalVentes) * 100 : 0;
    
    
    return {
        totalVentes,
        moyennePanier,
        tauxConversion
    };
}

// Calcul des statistiques avec données de comparaison
function calculateStatistics(clients, period) {
   
    
    const agencies = getAgenciesFromClients(clients);
    const stats = {
        totalCA: 0,
        previousCA: 0,
        agencies: {},
        timeline: [],
        keyMetrics: {},
        period: period
    };
    
    // Initialiser les agences
    agencies.forEach(agency => {
        stats.agencies[agency] = {
            currentCA: 0,
            previousCA: 0,
            evolution: 0
        };
    });
    
    // Calculer le CA par agence pour la période actuelle
    clients.forEach(client => {
        const agency = getAgencyFromClient(client);
        const montant = parseFloat(client['Montant TTC'] || client['Montant'] || 0);
        
        if (stats.agencies[agency]) {
            stats.agencies[agency].currentCA += montant;
        } else {
            stats.agencies[agency] = {
                currentCA: montant,
                previousCA: 0,
                evolution: 0
            };
        }
        stats.totalCA += montant;
    });
    
    // Calculer le CA pour la période de comparaison
    const comparisonClients = getComparisonClients(period);
    let comparisonTotalCA = 0;
    
    comparisonClients.forEach(client => {
        const agency = getAgencyFromClient(client);
        const montant = parseFloat(client['Montant TTC'] || client['Montant'] || 0);
        
        if (stats.agencies[agency]) {
            stats.agencies[agency].previousCA += montant;
        }
        comparisonTotalCA += montant;
    });
    
    stats.previousCA = comparisonTotalCA;
    
    // Calculer les évolutions
    Object.keys(stats.agencies).forEach(agency => {
        const agencyStats = stats.agencies[agency];
        agencyStats.evolution = agencyStats.previousCA > 0 ? 
            ((agencyStats.currentCA - agencyStats.previousCA) / agencyStats.previousCA) * 100 : 
            (agencyStats.currentCA > 0 ? 100 : 0);
    });
    
    // Générer la timeline
    stats.timeline = generateTimelineData(clients, period);
    
    // Calculer les indicateurs clés
    const comparisonMetrics = calculateKeyMetrics(comparisonClients);
    stats.keyMetrics = calculateKeyMetrics(clients);
    
    // Ajouter les évolutions aux métriques
    stats.keyMetrics.totalVentesEvolution = calculateEvolution(stats.keyMetrics.totalVentes, comparisonMetrics.totalVentes);
    stats.keyMetrics.moyennePanierEvolution = calculateEvolution(stats.keyMetrics.moyennePanier, comparisonMetrics.moyennePanier);
    stats.keyMetrics.tauxConversionEvolution = calculateEvolution(stats.keyMetrics.tauxConversion, comparisonMetrics.tauxConversion);
    stats.keyMetrics.nouveauxClientsEvolution = calculateEvolution(stats.keyMetrics.nouveauxClients, comparisonMetrics.nouveauxClients);
    
    return stats;
}

// Obtenir les clients pour la période de comparaison
function getComparisonClients(period) {
    const now = new Date();
    let startDate = new Date();
    let endDate = new Date();
    
    switch(period) {
        case 'today':
            // Hier
            startDate.setDate(now.getDate() - 1);
            startDate.setHours(0, 0, 0, 0);
            endDate.setDate(now.getDate() - 1);
            endDate.setHours(23, 59, 59, 999);
            break;
            
        case 'thisWeek':
            // Semaine passée
            const dayOfWeek = now.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            startDate.setDate(now.getDate() + diffToMonday - 7);
            startDate.setHours(0, 0, 0, 0);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23, 59, 59, 999);
            break;
            
        case 'lastWeek':
            // Avant-dernière semaine
            const dayOfWeekLast = now.getDay();
            const diffToMondayLast = dayOfWeekLast === 0 ? -6 : 1 - dayOfWeekLast;
            startDate.setDate(now.getDate() + diffToMondayLast - 14);
            startDate.setHours(0, 0, 0, 0);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23, 59, 59, 999);
            break;
            
        case 'thisMonth':
            // Mois passé
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);
            break;
            
        case 'lastMonth':
            // Avant-dernier mois
            startDate = new Date(now.getFullYear(), now.getMonth() - 2, 1);
            endDate = new Date(now.getFullYear(), now.getMonth() - 1, 0, 23, 59, 59, 999);
            break;
            
        case 'thisYear':
            // Année passée
            startDate = new Date(now.getFullYear() - 1, 0, 1);
            endDate = new Date(now.getFullYear() - 1, 11, 31, 23, 59, 59, 999);
            break;
            
        case 'lastYear':
            // Avant-dernière année
            startDate = new Date(now.getFullYear() - 2, 0, 1);
            endDate = new Date(now.getFullYear() - 2, 11, 31, 23, 59, 59, 999);
            break;
    }
    
    // Normaliser les données avant de filtrer
    const normalizedClients = normalizeClientData(allClientsData);
    
    return normalizedClients.filter(client => {
        const dateStr = client['Date Enregistrement'] || client['Date'] || '';
        if (!dateStr) return false;
        
        const clientDate = parseDate(dateStr);
        return clientDate >= startDate && clientDate <= endDate;
    });
}

// Calcul de l'évolution entre deux valeurs
function calculateEvolution(current, previous) {
    if (previous === 0) {
        return current > 0 ? 100 : 0;
    }
    return ((current - previous) / previous) * 100;
}

// Rendu du graphique des ventes
function renderSalesChart(data) {
    const ctx = document.getElementById('salesChart');
    if (!ctx) {
        console.error("Canvas salesChart non trouvé");
        return;
    }
    
    // Détruire le graphique existant
    if (salesChart) {
        salesChart.destroy();
    }
    
    const labels = data.timeline.map(point => point.date);
    const agencies = Object.keys(data.agencies);
    
   
    
    const datasets = agencies.map((agency, index) => {
        const colors = [
            { border: '#4361ee', background: 'rgba(67, 97, 238, 0.1)' },
            { border: '#3a56d4', background: 'rgba(58, 86, 212, 0.1)' },
            { border: '#4895ef', background: 'rgba(72, 149, 239, 0.1)' }
        ];
        
        return {
            label: agency,
            data: data.timeline.map(point => point[agency] || 0),
            borderColor: colors[index % colors.length].border,
            backgroundColor: colors[index % colors.length].background,
            borderWidth: 2,
            fill: true,
            tension: 0.4
        };
    });
    
    // Ajouter la ligne du total
    datasets.push({
        label: 'Total',
        data: data.timeline.map(point => point.total),
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        borderWidth: 3,
        borderDash: [5, 5],
        fill: false,
        tension: 0.4
    });
    
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} `;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'nearest'
            }
        }
    });
    
    // Mettre à jour le total CA
    const totalCAElement = document.getElementById('totalCA');
    if (totalCAElement) {
        totalCAElement.textContent = `${data.totalCA.toLocaleString()} `;
    }
}

// Rendu des tableaux de données
function renderDataTables(data) {
    renderAgencyStats(data);
    renderKeyMetrics(data);
}

// Rendu des statistiques par agence
function renderAgencyStats(data) {
    const tbody = document.getElementById('agencyStatsBody');
    if (!tbody) {
        console.error("Tableau agencyStatsBody non trouvé");
        return;
    }
    
    tbody.innerHTML = '';
    
    Object.keys(data.agencies).forEach(agency => {
        const agencyData = data.agencies[agency];
        const evolution = agencyData.evolution;
        const evolutionClass = evolution > 0 ? 'evolution-positive' : 
                             evolution < 0 ? 'evolution-negative' : 'evolution-neutral';
        
        const row = `
            <tr>
                <td><strong>${agency}</strong></td>
                <td>${agencyData.currentCA.toLocaleString()} </td>
                <td>${agencyData.previousCA.toLocaleString()} </td>
                <td>
                    <span class="evolution-indicator ${evolutionClass}">
                        <i class="fas fa-arrow-${evolution > 0 ? 'up' : 'down'}"></i>
                        ${Math.abs(evolution).toFixed(1)}%
                    </span>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// Rendu des indicateurs clés
function renderKeyMetrics(data) {
    const tbody = document.getElementById('keyMetricsBody');
    if (!tbody) {
        console.error("Tableau keyMetricsBody non trouvé");
        return;
    }
    
    const metrics = data.keyMetrics;
    
    const rows = [
        {
            label: 'Total Ventes',
            value: metrics.totalVentes,
            evolution: metrics.totalVentesEvolution,
            icon: 'shopping-cart'
        },
        {
            label: 'Panier Moyen',
            value: `${Math.round(metrics.moyennePanier).toLocaleString()} `,
            evolution: metrics.moyennePanierEvolution,
            icon: 'receipt'
        }
    ];
    
    tbody.innerHTML = '';
    
    rows.forEach(row => {
        const evolutionClass = row.evolution > 0 ? 'evolution-positive' : 
                             row.evolution < 0 ? 'evolution-negative' : 'evolution-neutral';
        
        const html = `
            <tr>
                <td>
                    <i class="fas fa-${row.icon}"></i>
                    ${row.label}
                </td>
                <td><strong>${row.value}</strong></td>
                <td>
                    <span class="evolution-indicator ${evolutionClass}">
                        <i class="fas fa-arrow-${row.evolution > 0 ? 'up' : 'down'}"></i>
                        ${Math.abs(row.evolution).toFixed(1)}%
                    </span>
                </td>
            </tr>
        `;
        tbody.innerHTML += html;
    });
}


// Gestion du défilement intelligent
document.addEventListener('DOMContentLoaded', function() {
    const tableContainers = document.querySelectorAll('.table-responsive');
    
    tableContainers.forEach(container => {
        // Ajouter les indicateurs de défilement
        const scrollHintVertical = document.createElement('div');
        scrollHintVertical.className = 'scroll-hint scroll-hint-vertical';
        
        const scrollHintHorizontal = document.createElement('div');
        scrollHintHorizontal.className = 'scroll-hint scroll-hint-horizontal';
        
        container.appendChild(scrollHintVertical);
        container.appendChild(scrollHintHorizontal);
        
        // Vérifier si le défilement est nécessaire
        function checkScrollability() {
            // Défilement vertical
            if (container.scrollHeight > container.clientHeight) {
                container.classList.add('scrollable-vertical');
            } else {
                container.classList.remove('scrollable-vertical', 'scrolling-vertical');
            }
            
            // Défilement horizontal
            if (container.scrollWidth > container.clientWidth) {
                container.classList.add('scrollable-horizontal');
            } else {
                container.classList.remove('scrollable-horizontal', 'scrolling-horizontal');
            }
        }
        
        // Gestion du défilement avec timeout pour performance
        let scrollTimeout;
        container.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            
            // Défilement vertical
            if (container.scrollTop > 0 && container.scrollTop < container.scrollHeight - container.clientHeight) {
                container.classList.add('scrolling-vertical');
            } else {
                container.classList.remove('scrolling-vertical');
            }
            
            // Défilement horizontal
            if (container.scrollLeft > 0 && container.scrollLeft < container.scrollWidth - container.clientWidth) {
                container.classList.add('scrolling-horizontal');
            } else {
                container.classList.remove('scrolling-horizontal');
            }
            
            scrollTimeout = setTimeout(() => {
                container.classList.remove('scrolling-vertical', 'scrolling-horizontal');
            }, 1000);
        });
        
        // Vérifier initialement et sur le redimensionnement
        checkScrollability();
        window.addEventListener('resize', checkScrollability);
        
        // Réinitialiser périodiquement pour les données dynamiques
        setInterval(checkScrollability, 2000);
        
        // Défilement fluide au survol avec la molette
        container.addEventListener('wheel', function(e) {
            if (e.deltaY !== 0 && container.scrollHeight > container.clientHeight) {
                container.classList.add('scrolling-vertical');
            }
            if (e.deltaX !== 0 && container.scrollWidth > container.clientWidth) {
                container.classList.add('scrolling-horizontal');
            }
            
            setTimeout(() => {
                if (!container.scrollHeight > container.clientHeight) {
                    container.classList.remove('scrolling-vertical');
                }
                if (!container.scrollWidth > container.clientWidth) {
                    container.classList.remove('scrolling-horizontal');
                }
            }, 1500);
        });
    });
});
</script>
    <script>
        // Fonctions pour le téléchargement
        function showDownloadModal() {
            // Créer le modal s'il n'existe pas
            if (!document.getElementById('downloadModal')) {
                const modalHTML = `
                    <div class="download-modal" id="downloadModal">
                        <div class="download-modal-content">
                            <h2>📱 Télécharger VisioPro</h2>
                            <p>Installez l'application mobile pour une meilleure expérience</p>
                            
                            <div class="download-steps">
                                <div class="download-step">
                                    <div class="step-number">1</div>
                                    <div>
                                        <strong>Téléchargez le fichier APK</strong>
                                        <p>Cliquez sur "Télécharger APK"</p>
                                    </div>
                                </div>
                                <div class="download-step">
                                    <div class="step-number">2</div>
                                    <div>
                                        <strong>Autorisez l'installation</strong>
                                        <p>Activez "Sources inconnues" dans Paramètres → Sécurité</p>
                                    </div>
                                </div>
                                <div class="download-step">
                                    <div class="step-number">3</div>
                                    <div>
                                        <strong>Installez l'application</strong>
                                        <p>Ouvrez le fichier .apk et suivez les instructions</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="download-actions">
                                <button class="btn-primary" onclick="downloadAPK()">
                                    <i class="fas fa-download"></i>
                                    Télécharger APK
                                </button>
                                <button class="btn-secondary" onclick="closeDownloadModal()">
                                    Plus tard
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            document.getElementById('downloadModal').style.display = 'flex';
        }

        function closeDownloadModal() {
            const modal = document.getElementById('downloadModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

function downloadAPK() {
    // Créer un lien de téléchargement
    const downloadLink = document.createElement('a');
    downloadLink.href = 'optic-app.apk';

    
    // Déclencher le téléchargement
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    
    // Fermer le modal après téléchargement
    closeDownloadModal();
    
}

        // Fermer le modal en cliquant à l'extérieur
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('downloadModal');
            if (event.target === modal) {
                closeDownloadModal();
            }
        });




    </script>

    <script>
/* ------------------- GESTION DU BURGER MOBILE ------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const btn   = document.getElementById('mobileMenuBtn');
  const side  = document.querySelector('.sidebar');

  if (!btn || !side) return;          // sécurité

  btn.addEventListener('click', () => {
    side.classList.toggle('active');  // bascule l’état
  });

  /* fermeture si on clique sur l’overlay (la page) */
  document.addEventListener('click', e => {
    if (!side.contains(e.target) && !btn.contains(e.target)) {
      side.classList.remove('active');
    }
  });
});
</script>
</body>
</html>
