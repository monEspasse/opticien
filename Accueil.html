 <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Accueil - Optic'APP</title>
        <!-- Favicon de base -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
:root {
    --primary-color: #4361ee;
    --primary-dark: #3a56d4;
    --secondary-color: #3f37c9;
    --accent-color: #4895ef;
    --light-accent: #4cc9f0;
    --success-color: #4ade80;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --dark-color: #1e293b;
    --light-color: #f8fafc;
    --gray-color: #94a3b8;
    --sidebar-bg: #1e293b;
    --sidebar-text: #e2e8f0;
    --sidebar-hover: #334155;
    --sidebar-active: #4361ee;
    --card-bg: #ffffff;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --border-radius: 8px;
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Montserrat', sans-serif;
}

body {
    background-color: #f1f5f9;
    color: #334155;
}

.dashboard {
    display: flex;
    min-height: 100vh;
}

.sidebar {
    width: 280px;
    background: linear-gradient(180deg, var(--sidebar-bg) 0%, #1a2235 100%);
    color: var(--sidebar-text);
    transition: var(--transition);
    overflow-y: auto;
    position: fixed;
    height: 100vh;
    z-index: 1000;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
    top: 0;
    left: 0;
    display: flex;
    flex-direction: column;
    padding-top: 25px;
}

/* Logo Container */
.logo-container {
    padding: 0 1.5rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.logo-image {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    object-fit: cover;
    border: 2px solid var(--accent-color);
}

.logo-text {
    font-weight: 700;
    font-size: 1.1rem;
    color: white;
    background: linear-gradient(135deg, #fff, var(--light-accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.sidebar-toggle {
    color: var(--gray-color);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: var(--transition);
}

.sidebar-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

/* Menu Styles */
.menu {
    padding: 0 1rem;
    flex: 1;
}

.menu-item {
    margin-bottom: 0.25rem;
    position: relative;
}

.menu-link {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: var(--sidebar-text);
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    justify-content: space-between;
    position: relative;
    overflow: hidden;
}

.menu-link::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.menu-link:hover::before {
    left: 100%;
}

.menu-link:hover {
    background: linear-gradient(135deg, var(--sidebar-hover), rgba(67, 97, 238, 0.1));
    color: white;
    transform: translateX(5px);
}

.menu-link.active {
    background: linear-gradient(135deg, var(--sidebar-active), var(--accent-color));
    color: white;
    box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
}

.menu-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 1rem;
}

.menu-text {
    flex: 1;
    font-weight: 500;
    font-size: 0.9rem;
}

.chevron {
    transition: var(--transition);
    font-size: 0.8rem;
    color: var(--gray-color);
}

.menu-item.active .chevron {
    transform: rotate(180deg);
    color: white;
}

/* Submenu Styles */
.submenu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    margin-left: 0.5rem;
    border-left: 1px solid rgba(255, 255, 255, 0.1);
}

.menu-item.active .submenu {
    max-height: 500px;
}

.submenu a {
    display: flex;
    align-items: center;
    padding: 0.6rem 1rem 0.6rem 1.5rem;
    color: var(--sidebar-text);
    text-decoration: none;
    border-radius: 8px;
    transition: var(--transition);
    font-size: 0.85rem;
    margin: 0.1rem 0;
    position: relative;
}

.submenu a:hover {
    background: rgba(255, 255, 255, 0.05);
    color: white;
    transform: translateX(3px);
}

.submenu-icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 0.8rem;
    color: var(--accent-color);
}

/* Submenu Sections */
.submenu-section {
    margin: 0.5rem 0;
    padding: 0.5rem 0;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.submenu-header {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem 0.5rem 1.5rem;
    color: var(--gray-color);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.submenu-header i {
    margin-right: 0.5rem;
    font-size: 0.7rem;
}

/* Badges et Status */
.menu-badge {
    background: var(--success-color);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-left: auto;
}

.menu-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: auto;
}

.menu-status.online {
    background: var(--success-color);
    box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.3);
}

/* Loader */
.menu-loader {
    padding: 0.5rem 1rem 0.5rem 2.5rem;
    font-size: 0.8rem;
    color: var(--gray-color);
    display: none;
}

.loader-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-left: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 0.5rem;
}

/* Sidebar Footer */
.sidebar-footer {
    padding: 1.25rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: auto;
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    min-width: 0;
}

.profile-avatar {
    position: relative;
    flex-shrink: 0;
}

.profile-img {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid var(--accent-color);
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    transition: all 0.3s ease;
}

.profile-img:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
}

.online-status {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--success-color);
    border: 2px solid var(--sidebar-bg);
    box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.5);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); 
    }
    50% { 
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(74, 222, 128, 0.3); 
    }
    100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); 
    }
}

.profile-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 0;
}

.profile-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.profile-role {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.75rem;
    color: var(--gray-color);
    font-weight: 500;
}

.profile-role i {
    font-size: 0.5rem;
    color: var(--success-color);
    animation: blink 2s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

.profile-timer {
    font-size: 0.7rem;
    color: var(--accent-color);
    font-weight: 600;
    background: rgba(67, 97, 238, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    align-self: flex-start;
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
    margin-top: 0.1rem;
}

.footer-actions {
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

.logout-btn {
    background: rgba(239, 68, 68, 0.15);
    border: none;
    color: var(--danger-color);
    padding: 0.75rem;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.logout-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.logout-btn:hover::before {
    left: 100%;
}

.logout-btn:hover {
    background: var(--danger-color);
    color: white;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}

.logout-btn:active {
    transform: translateY(0) scale(1);
}

/* Tooltip pour le bouton de d√©connexion */
.logout-btn::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    margin-bottom: 0.5rem;
}

.logout-btn:hover::after {
    opacity: 1;
}

/* Animation de secousse pour le timer quand le temps est critique */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

.profile-timer.warning {
    color: var(--warning-color);
    background: rgba(245, 158, 11, 0.1);
    animation: shake 0.5s ease-in-out infinite;
}

.profile-timer.critical {
    color: var(--danger-color);
    background: rgba(239, 68, 68, 0.1);
    animation: shake 0.3s ease-in-out infinite;
}

/* Version responsive */
@media (max-width: 768px) {
    .sidebar-footer {
        padding: 1rem;
        gap: 0.75rem;
    }
    
    .profile-img {
        width: 40px;
        height: 40px;
    }
    
    .profile-name {
        font-size: 0.9rem;
    }
    
    .profile-role {
        font-size: 0.7rem;
    }
    
    .profile-timer {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
    }
    
    .logout-btn {
        padding: 0.6rem;
    }
}

/* Pour les tr√®s petits √©crans */
@media (max-width: 480px) {
    .sidebar-footer {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .footer-actions {
        align-self: flex-end;
    }
}
.header {
    background-color: var(--card-bg);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    position: fixed;
    top: 0;
    left: 280px; 
    right: 0; 
    z-index: 5;
    height: 80px;
    box-sizing: border-box;
}

.main {
    flex: 1;
    margin-left: 280px;
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
    min-height: 100vh;
    margin-top: 80px;
}

@media (max-width: 768px) {
    .header {
        left: 0;
        width: 100%;
        padding: 1rem;
        height: 70px;
    }
    
    .main {
        margin-left: 0;
        margin-top: 70px;
        width: 100%;
    }
    
    .sidebar {
        z-index: 1001; /* Au-dessus du header */
    }
}
.header-left {
    display: flex;
    align-items: center;
}

.mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    color: var(--dark-color);
    font-size: 1.25rem;
    margin-right: 1rem;
    cursor: pointer;
}

.page-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--dark-color);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.profile-dropdown {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.profile-name {
    font-weight: 500;
}

.profile-img {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--accent-color);
}

.dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background-color: var(--card-bg);
    min-width: 200px;
    box-shadow: var(--card-shadow);
    border-radius: var(--border-radius);
    z-index: 10;
    padding: 0.5rem 0;
}

.dropdown-menu a {
    color: var(--dark-color);
    padding: 0.75rem 1.5rem;
    text-decoration: none;
    display: flex;
    align-items: center;
    transition: var(--transition);
}

.dropdown-menu a:hover {
    background-color: #f1f5f9;
    color: var(--primary-color);
}

.dropdown-menu a i {
    margin-right: 0.75rem;
    width: 20px;
    text-align: center;
}

.profile-dropdown:hover .dropdown-menu {
    display: block;
}

/* Dashboard Content */
.dashboard-section {
    padding: 1.5rem;
    flex: 1;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.dashboard-header h1 {
    font-size: 1.75rem;
    color: var(--dark-color);
    font-weight: 600;
}

.dashboard-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn {
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: var(--transition);
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
}

.btn-secondary {
    background-color: white;
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
}

.btn-secondary:hover {
    background-color: #f8fafc;
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}
/* Header am√©lior√© */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--gray-light);
}

.dashboard-header h1 {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
}

.dashboard-buttons .btn {
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    border: none;
    padding: 1rem 1.5rem;
    border-radius: 16px;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.dashboard-buttons .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.dashboard-buttons .btn:hover::before {
    left: 100%;
}

.dashboard-buttons .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(67, 97, 238, 0.4);
}

/* Grille d'actions rapides modernis√©e */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.quick-action-card {
    background: var(--card-bg);
    border: 1px solid var(--gray-light);
    border-radius: 20px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 1rem;
    text-align: left;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.quick-action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.quick-action-card:hover {
    transform: translateY(-8px);
    border-color: var(--primary-color);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.quick-action-card:hover::before {
    transform: scaleX(1);
}

.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.quick-action-card:hover .card-icon {
    transform: scale(1.1) rotate(5deg);
}

.card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.card-title {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--dark-color);
}

.card-desc {
    font-size: 0.85rem;
    color: var(--gray-color);
    line-height: 1.4;
}

.card-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--success-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.card-badge.trending {
    background: linear-gradient(135deg, #ff6b6b, #ffa500);
}

/* Animations au chargement */
.quick-action-card {
    animation: cardEntrance 0.6s ease-out;
    animation-fill-mode: both;
}

.quick-action-card:nth-child(1) { animation-delay: 0.1s; }
.quick-action-card:nth-child(2) { animation-delay: 0.2s; }
.quick-action-card:nth-child(3) { animation-delay: 0.3s; }
.quick-action-card:nth-child(4) { animation-delay: 0.4s; }
.quick-action-card:nth-child(5) { animation-delay: 0.5s; }
.quick-action-card:nth-child(6) { animation-delay: 0.6s; }

@keyframes cardEntrance {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .dashboard-header h1 {
        font-size: 1.75rem;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .quick-action-card {
        padding: 1.25rem;
    }
    
    .card-icon {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
    }
}
.quick-action-btn {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 1.5rem;
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    transition: var(--transition);
    cursor: pointer;
    border: none;
    text-align: left;
}

.quick-action-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.quick-action-btn i {
    font-size: 1.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 50%;
    background-color: rgba(72, 149, 239, 0.1);
    color: var(--accent-color);
}

.quick-action-btn .btn-text {
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.25rem;
}

.quick-action-btn .btn-desc {
    font-size: 0.85rem;
    color: var(--gray-color);
}

/* Cards */
.card {
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-title i {
    color: var(--accent-color);
}

.search-container {
    position: relative;
}

.search-container i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-color);
}

.search-container input {
    padding: 0.5rem 1rem 0.5rem 2.25rem;
    border: 1px solid #e2e8f0;
    border-radius: var(--border-radius);
    width: 250px;
    font-size: 0.9rem;
    transition: var(--transition);
}

.search-container input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
}

/* Tables */
.table-responsive {
    overflow-x: auto;
    max-height: 70vh;
    overflow-y: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.product-table, .entrees-table, .verre-catalogue-table {
    width: 100%;
    border-collapse: collapse;
}

.product-table th, .product-table td,
.entrees-table th, .entrees-table td,
.verre-catalogue-table th, .verre-catalogue-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.product-table th,
.entrees-table th,
.verre-catalogue-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
}

.product-table tr:hover,
.entrees-table tr:hover,
.verre-catalogue-table tr:hover {
    background-color: #f5f5f5;
}

th, td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

th {
    background-color: #f8fafc;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
    cursor: pointer;
    position: relative;
    white-space: nowrap;
}

th:hover {
    background-color: #f1f5f9;
}

th.sorted-asc::after {
    content: " \25B2";
    font-size: 0.7em;
    margin-left: 5px;
    color: var(--accent-color);
}

th.sorted-desc::after {
    content: " \25BC";
    font-size: 0.7em;
    margin-left: 5px;
    color: var(--accent-color);
}

tr:hover {
    background-color: #f8fafc;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-active {
    background-color: rgba(74, 222, 128, 0.1);
    color: var(--success-color);
}

.status-inactive {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--danger-color);
}

.client-link {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
    transition: var(--transition);
}

.client-link:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

.action-btn {
    background: none;
    border: none;
    color: var(--gray-color);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: var(--transition);
}

.action-btn:hover {
    color: var(--primary-color);
    background-color: #f1f5f9;
}

/* Pagination */
.pagination-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    padding: 0.75rem 0;
}

.pagination-info {
    font-size: 0.9rem;
    color: var(--gray-color);
}

.pagination-buttons {
    display: flex;
    gap: 0.5rem;
}

.pagination-btn {
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    background-color: white;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.pagination-btn:hover:not(:disabled) {
    background-color: #f1f5f9;
    border-color: var(--accent-color);
    color: var(--accent-color);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.items-per-page {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.items-per-page select {
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    background-color: white;
}

/* Loading and Error States */
.loading-indicator {
    text-align: center;
    padding: 2rem;
    display: none;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f1f5f9;
    border-top: 4px solid var(--accent-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    color: var(--danger-color);
    text-align: center;
    padding: 2rem;
    display: none;
    background-color: rgba(239, 68, 68, 0.05);
    border-radius: var(--border-radius);
    margin: 1rem 0;
}

.no-clients-message {
    text-align: center;
    padding: 2rem;
    color: var(--gray-color);
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    margin: 1rem 0;
}
 
/* Style unique pour le modal d'ajout */
#addFactureModal {
    font-family: 'Poppins', sans-serif;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

#addFactureModal.active {
    opacity: 1;
    visibility: visible;
}

#addFactureModal .modal-content {
    width: 90%;
    max-width: 800px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#addFactureModal.active .modal-content {
    transform: translateY(0);
}

#addFactureModal .modal-header {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 20px;
    position: relative;
    border-bottom: none;
}

#addFactureModal .modal-header::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 20px;
    background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="%23f8f9fa" opacity=".25"/><path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" fill="%23f8f9fa" opacity=".5"/><path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="%23f8f9fa"/></svg>');
    background-size: cover;
}

#addFactureModal .modal-title {
    font-weight: 600;
    letter-spacing: 0.5px;
    font-size: 1.4rem;
    margin: 0;
    font-family: 'Montserrat', sans-serif;
}

#addFactureModal .modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    position: absolute;
    top: 15px;
    right: 15px;
}

#addFactureModal .modal-body {
    padding: 25px;
}

#addFactureModal .form-group {
    margin-bottom: 1.5rem;
    position: relative;
}

#addFactureModal .form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.9rem;
    display: block;
}

#addFactureModal .form-control,
#addFactureModal .form-select {
    width: 100%;
    border-radius: 8px;
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    transition: all 0.3s ease;
    box-shadow: none;
    font-family: 'Poppins', sans-serif;
}

#addFactureModal .form-control:focus,
#addFactureModal .form-select:focus {
    border-color: #2575fc;
    box-shadow: 0 0 0 0.25rem rgba(37, 117, 252, 0.15);
    outline: none;
}

#addFactureModal .modal-footer {
    padding: 20px;
    background-color: #f8f9fa;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

#addFactureModal .btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
    font-family: 'Montserrat', sans-serif;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

#addFactureModal .btn-secondary {
    background-color: #6c757d;
    color: white;
}

#addFactureModal .btn-primary {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

#addFactureModal .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

#addFactureModal .btn-primary:hover::before {
    left: 100%;
}

#addFactureModal .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* Animation de l'onde */
#addFactureModal .form-group::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #2575fc, #6a11cb);
    transition: width 0.4s ease;
}

#addFactureModal .form-group:focus-within::after {
    width: 100%;
}

/* Spinner */
#addFactureModal .spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    #addFactureModal .modal-content {
        width: 95%;
    }
    
    #addFactureModal .row {
        flex-direction: column;
    }
    
    #addFactureModal .col-md-6 {
        width: 100%;
    }
}

/* Style unique pour le modal de modification */
.edit-modal {
    font-family: 'Poppins', sans-serif;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.edit-modal.active {
    opacity: 1;
    visibility: visible;
}

.edit-modal-content {
    width: 90%;
    max-width: 800px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.edit-modal.active .edit-modal-content {
    transform: translateY(0);
}

.edit-modal-header {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 20px;
    position: relative;
    border-bottom: none;
}

.edit-modal-header::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 20px;
    background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="%23f8f9fa" opacity=".25"/><path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" fill="%23f8f9fa" opacity=".5"/><path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="%23f8f9fa"/></svg>');
    background-size: cover;
}

.edit-modal-title {
    font-weight: 600;
    letter-spacing: 0.5px;
    font-size: 1.4rem;
    margin: 0;
    font-family: 'Montserrat', sans-serif;
}

.edit-modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    position: absolute;
    top: 15px;
    right: 15px;
}

.edit-modal-body {
    padding: 25px;
}

.edit-form-group {
    margin-bottom: 1.5rem;
    position: relative;
}

.edit-form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.9rem;
    display: block;
}

.edit-form-control {
    width: 100%;
    border-radius: 8px;
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    transition: all 0.3s ease;
    box-shadow: none;
    font-family: 'Poppins', sans-serif;
}

.edit-form-control:focus {
    border-color: #2575fc;
    box-shadow: 0 0 0 0.25rem rgba(37, 117, 252, 0.15);
    outline: none;
}

.edit-form-control[readonly] {
    background-color: #f8f9fa;
    border-color: #e9ecef;
    color: #6c757d;
}

.edit-modal-footer {
    padding: 20px;
    background-color: #f8f9fa;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.edit-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
    font-family: 'Montserrat', sans-serif;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.edit-btn-secondary {
    background-color: #6c757d;
    color: white;
}

.edit-btn-primary {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

.edit-btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

.edit-btn-primary:hover::before {
    left: 100%;
}

.edit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.edit-row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px;
}

.edit-col {
    flex: 1;
    min-width: 250px;
    padding: 0 10px;
}

/* Animation de l'onde */
.edit-form-group::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #2575fc, #6a11cb);
    transition: width 0.4s ease;
}

.edit-form-group:focus-within::after {
    width: 100%;
}

/* Spinner */
.edit-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: edit-spin 0.75s linear infinite;
}

@keyframes edit-spin {
    to { transform: rotate(360deg); }
}


/* Styles personnalis√©s pour le logo */
.logo-container {
    display: flex;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo-image {
    height: 40px;
    width: 40px;
    object-fit: contain;
    border-radius: 90%;
}

.logo:hover .logo-image {
    transform: scale(1.05);
    transition: transform 0.3s ease;
}

/* Styles personnalis√©s pour les boutons d'action */
.action-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 3px;
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-edit {
    background-color: #4e73df;
    color: white;
}

.btn-edit:hover {
    background-color: #3a5bc7;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(78, 115, 223, 0.3);
}

.btn-cancel {
    background-color: #e74a3b;
    color: white;
}

.btn-cancel:hover {
    background-color: #d62c1a;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(231, 74, 59, 0.3);
}

.action-btns {
    display: flex;
    justify-content: center;
    gap: 6px;
}

.action-btn:active {
    transform: translateY(1px);
}

.action-btn i {
    font-size: 14px;
}

/* Styles personnalis√©s pour l'animation des boutons */
@keyframes buttonHighlight {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 0 10px 5px rgba(40, 167, 69, 0);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
  }
}

.btn-success.highlight {
  animation: buttonHighlight 3s ease-out;
}

/* Styles personnalis√©s pour les overlays de confirmation */
.confirmation-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.confirmation-box {
    background: white;
    padding: 25px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    text-align: center;
}

.confirmation-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
}

.btn-confirm {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-cancel {
    background-color: #f44336;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

/* Styles personnalis√©s pour les indicateurs de statut */
.status-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.status-content {
    background: white;
    padding: 25px;
    border-radius: 8px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.status-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

.status-content.success {
    border: 2px solid #4CAF50;
}

.status-icon {
    color: #4CAF50;
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
}

/* Styles personnalis√©s pour les filtres compacts */
.compact-filters .filter-row {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: 12px;
    margin-bottom: 15px;
}

.compact-filters .filter-group {
    flex: 1;
    min-width: 180px;
}

.compact-filters .filter-action {
    flex: 0 0 auto;
    margin-bottom: 15px;
}

.compact-filters label {
    display: block;
    margin-bottom: 5px;
    font-size: 0.9em;
    font-weight: 500;
}

/* Styles personnalis√©s pour les loaders */
.loader-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
}

.loader-overlay.active {
    display: flex;
}

.loader-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

.loader-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

/* Styles personnalis√©s pour les modales uniques */
#addFactureModal .modal-content {
    width: 90%;
    max-width: 800px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#addFactureModal.active .modal-content {
    transform: translateY(0);
}

#addFactureModal .modal-header {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 20px;
    position: relative;
    border-bottom: none;
}

#addFactureModal .modal-header::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 20px;
    background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="%23f8f9fa" opacity=".25"/><path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" fill="%23f8f9fa" opacity=".5"/><path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="%23f8f9fa"/></svg>');
    background-size: cover;
}

#addFactureModal .btn-primary {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

#addFactureModal .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

#addFactureModal .btn-primary:hover::before {
    left: 100%;
}

/* Styles personnalis√©s pour les indicateurs d'√©tapes */
.step-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--gray-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    transition: var(--transition);
}

.step.active .step-number {
    background-color: var(--primary-color);
}

.step.completed .step-number {
    background-color: var(--success-color);
}

.step-progress {
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 4px;
    background-color: #e2e8f0;
    z-index: 1;
}

.step-progress-bar {
    height: 100%;
    background-color: var(--success-color);
    width: 0%;
    transition: var(--transition);
}

/* Styles personnalis√©s pour les formulaires d'√©tapes */
.form-step {
    display: none;
    background-color: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    margin-bottom: 1.5rem;
}

.form-step.active {
    display: block;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

/* Styles personnalis√©s pour les tables de prescription */
.prescription-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    background-color: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--card-shadow);
}

.prescription-table th {
    background-color: var(--primary-color);
    color: white;
    padding: 1rem;
    text-align: center;
    font-weight: 600;
}

.prescription-table td {
    padding: 1rem;
    border: 1px solid #e2e8f0;
    text-align: center;
}

.prescription-table select,
.prescription-table input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    background-color: white;
}

/* Styles personnalis√©s pour les cartes de paiement */
.payment-card {
    background-color: #f8fafc;
    padding: 1rem;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--primary-color);
    margin-bottom: 1rem;
}

.payment-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}

.payment-group {
    flex: 1;
    min-width: 200px;
}

.payment-label {
    font-size: 0.85rem;
    color: var(--gray-color);
    margin-bottom: 0.25rem;
}

.payment-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--dark-color);
}

.discount-selector {
    display: flex;
    gap: 0.5rem;
}

.discount-selector input {
    flex: 2;
}

.discount-selector select {
    flex: 1;
}

/* Styles personnalis√©s pour la navigation d'√©tapes */
.step-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e2e8f0;
    gap: 0.75rem;
    flex-wrap: wrap;
}

/* Styles personnalis√©s pour les conteneurs de loaders */
.loader-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.loader {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

.loader-visible {
    opacity: 1;
    visibility: visible;
}

/* Styles personnalis√©s pour les messages de statut */
.success-message {
    background-color: var(--success-color);
    color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    margin-top: 15px;
    display: none;
    animation: fadeIn 0.5s ease;
}

.error-message {
    background-color: var(--danger-color);
    color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    margin-top: 15px;
    display: none;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Styles personnalis√©s pour les s√©lecteurs avec input */
.select-with-input {
    position: relative;
}

.btn-small {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
}

.btn-small:hover {
    background-color: #e2e8f0;
}

/* =======================
   PROFORMA MODAL STYLES
   ======================= */

/* Overlay (arri√®re-plan du modal) */
#proformaModal.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(6px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-out;
}

/* Modal actif */
#proformaModal.active {
    display: flex;
}

/* Conteneur principal */
#proformaModal .modal-container {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    width: 90%;
    max-width: 1250px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.25);
    animation: slideDown 0.4s ease-out;
    padding: 20px;
}

/* Header du modal */
#proformaModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: #fff;
    border-radius: 15px 15px 0 0;
}

/* Titre */
#proformaModal .modal-title {
    font-size: 1.6rem;
    font-weight: 700;
}

/* Bouton de fermeture */
#proformaModal .modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.3s;
}
#proformaModal .modal-close:hover {
    background: rgba(255, 255, 255, 0.4);
}

/* =======================
   STEPPER
   ======================= */
#proformaModal .stepper {
    display: flex;
    justify-content: space-between;
    margin: 25px 0 30px;
    position: relative;
}
#proformaModal .stepper::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
}
#proformaModal .step {
    flex: 1;
    text-align: center;
    position: relative;
    z-index: 1;
}
#proformaModal .step-number {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(6px);
    border: 2px solid #6a11cb;
    color: #6a11cb;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 8px;
    transition: all 0.3s ease;
}
#proformaModal .step.active .step-number {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    transform: scale(1.1);
}
#proformaModal .step-label {
    font-size: 0.85rem;
    color: #2575fc;
    font-weight: 500;
}

/* =======================
   FORMULAIRE
   ======================= */
#proformaModal .form-section {
    display: none;
}
#proformaModal .form-section.active {
    display: block;
    animation: fadeIn 0.5s ease;
}
#proformaModal .section-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: #2575fc;
    border-left: 5px solid #6a11cb;
    padding-left: 10px;
}
#proformaModal .form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
}
#proformaModal .form-group {
    flex: 1;
    min-width: 240px;
}
#proformaModal .form-group label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    color: #333;
}
#proformaModal input, 
#proformaModal select {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ccc;
    border-radius: 10px;
    font-size: 1rem;
    transition: border 0.3s, box-shadow 0.3s;
}
#proformaModal input:focus, 
#proformaModal select:focus {
    border-color: #6a11cb;
    box-shadow: 0 0 6px rgba(106, 17, 203, 0.3);
    outline: none;
}

/* =======================
   TABLE
   ======================= */
#proformaModal .prescription-table-container {
    overflow-x: auto;
    margin: 20px 0;
    border-radius: 10px;
    border: 1px solid #eee;
}
#proformaModal .prescription-table {
    width: 100%;
    border-collapse: collapse;
}
#proformaModal .prescription-table th {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    padding: 12px;
    font-weight: 600;
}
#proformaModal .prescription-table td {
    border: 1px solid #eee;
    padding: 10px;
    text-align: center;
}

/* =======================
   NAVIGATION
   ======================= */
#proformaModal .form-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #ddd;
}
#proformaModal .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.3s;
}
#proformaModal .btn-primary {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
}
#proformaModal .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(37, 117, 252, 0.3);
}
#proformaModal .btn-secondary {
    background: #eee;
    color: #333;
}
#proformaModal .btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* =======================
   LOADER
   ======================= */
#proformaModal .loader-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
#proformaModal .loader-overlay.active {
    display: flex;
}
#proformaModal .loader-content {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(6px);
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
}
#proformaModal .loader-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #6a11cb;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

/* =======================
   ANIMATIONS
   ======================= */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes slideDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* =======================
   RESPONSIVE
   ======================= */
@media (max-width: 768px) {
    #proformaModal .modal-container {
        width: 95%;
        padding: 15px;
    }
    #proformaModal .form-row {
        flex-direction: column;
        gap: 15px;
    }
    #proformaModal .btn {
        width: 100%;
    }
}

/* =======================
   NEW SALE MODAL STYLES
   ======================= */

/* -----------------------
   OVERLAY
   ----------------------- */
#newSaleModal.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(6px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-out;
    padding: 15px; /* Ajout de padding pour les petits √©crans */
    box-sizing: border-box;
}

/* Modal actif */
#newSaleModal.active {
    display: flex;
}

/* -----------------------
   MODAL CONTAINER
   ----------------------- */
#newSaleModal .modal-content {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    width: 90%;
    max-width: 2500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    animation: slideDown 0.4s ease-out;
    display: flex;
    flex-direction: column;
}

/* -----------------------
   HEADER
   ----------------------- */
#newSaleModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: #fff;
    border-radius: 20px 20px 0 0;
    flex-wrap: wrap; /* Permet l'adaptation sur petits √©crans */
}

#newSaleModal .modal-title {
    font-size: 1.6rem;
    font-weight: 700;
}

#newSaleModal .modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    font-size: 1.5rem;
    color: white;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s;
}
#newSaleModal .modal-close:hover {
    background: rgba(255,255,255,0.4);
}

/* -----------------------
   STEPPER
   ----------------------- */
#newSaleModal .step-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 25px;
    position: relative;
    flex-wrap: wrap; /* Adaptation sur petits √©crans */
}

#newSaleModal .step-indicator::before {
    content: '';
    position: absolute;
    top: 22px;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(0,0,0,0.1);
    z-index: 1;
}

#newSaleModal .step {
    flex: 1;
    text-align: center;
    position: relative;
    z-index: 2;
    transition: transform 0.3s;
    min-width: 70px; /* √âvite le chevauchement sur petits √©crans */
}

#newSaleModal .step-number {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(6px);
    border: 2px solid #6a11cb;
    color: #6a11cb;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    transition: all 0.3s ease;
}

#newSaleModal .step.active .step-number {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    transform: scale(1.2);
    box-shadow: 0 0 10px rgba(37,117,252,0.6);
}

#newSaleModal .step-label {
    font-size: 0.85rem;
    color: #333;
    font-weight: 500;
}

/* -----------------------
   FORM SECTIONS
   ----------------------- */
#newSaleModal .form-step {
    display: none;
    padding: 20px;
    box-sizing: border-box;
}
#newSaleModal .form-step.active {
    display: block;
    animation: fadeIn 0.5s ease;
}

#newSaleModal .section-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: #2575fc;
    border-left: 5px solid #6a11cb;
    padding-left: 10px;
}

#newSaleModal .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
}

#newSaleModal .form-group label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
    color: #333;
}

#newSaleModal input,
#newSaleModal select,
#newSaleModal textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 1rem;
    transition: border 0.3s, box-shadow 0.3s;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(4px);
    box-sizing: border-box; /* Important pour la largeur 100% */
}

#newSaleModal input:focus,
#newSaleModal select:focus,
#newSaleModal textarea:focus {
    border-color: #6a11cb;
    box-shadow: 0 0 6px rgba(106,17,203,0.3);
    outline: none;
}

/* -----------------------
   SELECT + INPUT COMBINED
   ----------------------- */
#newSaleModal .select-with-input {
    display: flex;
    flex-direction: column;
}

#newSaleModal .select-with-input input {
    margin-top: 5px;
    display: none;
}

/* -----------------------
   TABLE PRESCRIPTION
   ----------------------- */
#newSaleModal .prescription-table-container {
    overflow-x: auto;
    margin: 15px 0;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.1);
    backdrop-filter: blur(4px);
    background: rgba(255,255,255,0.2);
}

#newSaleModal .prescription-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px; /* √âvite que le tableau devienne trop √©troit */
}

#newSaleModal .prescription-table th {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
    padding: 10px;
    font-weight: 600;
    white-space: nowrap; /* √âvite le retour √† la ligne des en-t√™tes */
}

#newSaleModal .prescription-table td {
    border: 1px solid rgba(0,0,0,0.1);
    padding: 8px;
    text-align: center;
}

/* -----------------------
   PAYMENT CARDS
   ----------------------- */
#newSaleModal .payment-card {
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(6px);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}

#newSaleModal .payment-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

#newSaleModal .payment-label {
    font-weight: 600;
    margin-bottom: 5px;
}

#newSaleModal .payment-value {
    font-weight: 700;
    font-size: 1.1rem;
    padding: 6px 10px;
    border-radius: 8px;
    background: rgba(0,0,0,0.05);
}

/* -----------------------
   BUTTONS
   ----------------------- */
#newSaleModal .btn {
    padding: 10px 18px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    min-width: 120px; /* Largeur minimale pour les boutons */
}

#newSaleModal .btn-primary {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: white;
}
#newSaleModal .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(37,117,252,0.3);
}

#newSaleModal .btn-secondary {
    background: #f0f0f0;
    color: #333;
}
#newSaleModal .btn-secondary:hover {
    background: #e0e0e0;
}

/* -----------------------
   STEP NAVIGATION
   ----------------------- */
#newSaleModal .step-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    flex-wrap: wrap;
    gap: 10px;
    padding: 0 20px 20px;
}

/* -----------------------
   LOADER
   ----------------------- */
#newSaleModal .loader-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
#newSaleModal .loader-overlay.active {
    display: flex;
}
#newSaleModal .loader-content {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(6px);
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
    max-width: 90%; /* Adaptation sur petits √©crans */
    margin: 0 15px;
}
#newSaleModal .loader-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #6a11cb;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

/* -----------------------
   ANIMATIONS
   ----------------------- */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* =======================
   RESPONSIVE
   ======================= */
@media (max-width: 768px) {
    #newSaleModal.modal-overlay {
        padding: 10px;
        align-items: flex-start; /* Alignement en haut sur mobile */
        padding-top: 30px;
    }
    
    #newSaleModal .modal-content {
        width: 95%;
        max-height: 85vh;
    }
    
    #newSaleModal .modal-header {
        padding: 12px 15px;
    }
    
    #newSaleModal .modal-title {
        font-size: 1.3rem;
    }
    
    #newSaleModal .step-indicator {
        margin-bottom: 15px;
        padding: 0 10px;
    }
    
    #newSaleModal .step {
        min-width: 60px;
    }
    
    #newSaleModal .step-number {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
    }
    
    #newSaleModal .step-label {
        font-size: 0.75rem;
    }
    
    #newSaleModal .form-step {
        padding: 15px;
    }
    
    #newSaleModal .section-title {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    
    #newSaleModal .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    #newSaleModal .payment-row {
        grid-template-columns: 1fr;
    }
    
    #newSaleModal .btn {
        width: 100%;
        margin-bottom: 5px;
    }
    
    #newSaleModal .step-navigation {
        flex-direction: column;
    }
    
    #newSaleModal .prescription-table {
        font-size: 0.85rem;
    }
    
    #newSaleModal .prescription-table th,
    #newSaleModal .prescription-table td {
        padding: 6px 4px;
    }
}

@media (max-width: 480px) {
    #newSaleModal .modal-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    #newSaleModal .step-indicator::before {
        top: 18px;
    }
    
    #newSaleModal .step-number {
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
    }
    
    #newSaleModal .step-label {
        font-size: 0.7rem;
    }
    
    #newSaleModal input,
    #newSaleModal select,
    #newSaleModal textarea {
        padding: 8px 10px;
        font-size: 0.9rem;
    }
    
    #newSaleModal .payment-value {
        font-size: 1rem;
    }
}

/* ---------- OVERLAY ---------- */
#ajoutGrandCaisseModal.modal-overlay,
#loadingModal.modal-overlay,
#errorModal.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s ease-out;
}

#ajoutGrandCaisseModal.active,
#loadingModal.active,
#errorModal.active {
  display: flex;
}

/* ---------- MODAL CONTAINER ---------- */
#ajoutGrandCaisseModal .modal-content,
#loadingModal .modal-content,
#errorModal .modal-content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
  animation: slideDown 0.4s ease-out;
  overflow: hidden;
}

/* ---------- HEADER ---------- */
#ajoutGrandCaisseModal .modal-header {
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color: #fff;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#ajoutGrandCaisseModal .modal-title {
  font-size: 1.4rem;
  font-weight: 700;
}

#ajoutGrandCaisseModal .modal-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  font-size: 1.5rem;
  color: #fff;
  cursor: pointer;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  transition: background 0.3s;
}

#ajoutGrandCaisseModal .modal-close:hover {
  background: rgba(255, 255, 255, 0.4);
}

/* ---------- BODY ---------- */
#ajoutGrandCaisseModal .modal-body {
  padding: 1.5rem;
}

/* ---------- FORM STYLING ---------- */
#ajoutGrandCaisseModal .form-group {
  margin-bottom: 1rem;
}

#ajoutGrandCaisseModal label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  color: #333;
}

#ajoutGrandCaisseModal .required {
  color: #e74a3b;
}

#ajoutGrandCaisseModal input,
#ajoutGrandCaisseModal select {
  width: 100%;
  padding: 0.75rem 1rem;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1rem;
  transition: border 0.3s, box-shadow 0.3s;
  background: rgba(255, 255, 255, 0.8);
}

#ajoutGrandCaisseModal input:focus,
#ajoutGrandCaisseModal select:focus {
  border-color: #6a11cb;
  box-shadow: 0 0 8px rgba(106, 17, 203, 0.3);
  outline: none;
}

/* Champs invalides */
#ajoutGrandCaisseModal .input-error {
  border-color: #e74a3b !important;
  background: rgba(231, 74, 59, 0.1);
}

/* ---------- FORM MESSAGE ---------- */
#ajoutGrandCaisseModal .form-message {
  font-size: 0.95rem;
  margin-top: 0.5rem;
  padding: 0.5rem;
  border-radius: 6px;
  display: none;
}

#ajoutGrandCaisseModal .form-message.error {
  display: block;
  background: rgba(231, 74, 59, 0.1);
  color: #e74a3b;
}

#ajoutGrandCaisseModal .form-message.success {
  display: block;
  background: rgba(40, 167, 69, 0.1);
  color: #28a745;
}

/* ---------- FOOTER BUTTONS ---------- */
#ajoutGrandCaisseModal .modal-footer {
  padding: 1rem 1.5rem;
  background: rgba(0, 0, 0, 0.03);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

#ajoutGrandCaisseModal .btn {
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
}

#ajoutGrandCaisseModal .btn-primary {
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color: #fff;
}
#ajoutGrandCaisseModal .btn-primary:hover {
  box-shadow: 0 5px 15px rgba(37, 117, 252, 0.4);
  transform: translateY(-2px);
}

#ajoutGrandCaisseModal .btn-secondary {
  background: #f0f0f0;
  color: #333;
}
#ajoutGrandCaisseModal .btn-secondary:hover {
  background: #e0e0e0;
}

/* ---------- LOADING SPINNER ---------- */
.loading-spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-top: 4px solid #2575fc;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin: 0 auto 1rem;
  animation: spin 1s linear infinite;
}

/* ---------- ANIMATIONS ---------- */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideDown {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ---------- RESPONSIVE ---------- */
@media (max-width: 480px) {
  #ajoutGrandCaisseModal .modal-content {
    width: 95%;
    padding: 1rem;
  }
  #ajoutGrandCaisseModal .modal-header,
  #ajoutGrandCaisseModal .modal-footer {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  #ajoutGrandCaisseModal .btn {
    width: 100%;
  }
}

.spinner {
  border: 4px solid rgba(0,0,0,0.1);
  border-left-color: #007bff;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: auto;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}


/* ================================
   MODAL D√âPENSE - STYLES CUSTOM
   ================================ */

/* ---------- OVERLAY ---------- */
#depenseModal.modal-overlay,
#loadingModal.modal-overlay,
#errorModal.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s ease-out;
}

#depenseModal.active,
#loadingModal.active,
#errorModal.active {
  display: flex;
}

/* ---------- MODAL CONTAINER ---------- */
#depenseModal .modal-content,
#loadingModal .modal-content,
#errorModal .modal-content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
  animation: slideDown 0.4s ease-out;
  overflow: hidden;
}

/* ---------- HEADER ---------- */
#depenseModal .modal-header {
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color: #fff;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#depenseModal .modal-title {
  font-size: 1.4rem;
  font-weight: 700;
}

#depenseModal .modal-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  font-size: 1.5rem;
  color: #fff;
  cursor: pointer;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  transition: background 0.3s;
}

#depenseModal .modal-close:hover {
  background: rgba(255, 255, 255, 0.4);
}

/* ---------- BODY ---------- */
#depenseModal .modal-body {
  padding: 1.5rem;
}

/* ---------- FORM STYLING ---------- */
#depenseModal .form-group {
  margin-bottom: 1rem;
}

#depenseModal label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  color: #333;
}

#depenseModal .required {
  color: #e74a3b;
}

#depenseModal input,
#depenseModal select {
  width: 100%;
  padding: 0.75rem 1rem;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1rem;
  transition: border 0.3s, box-shadow 0.3s;
  background: rgba(255, 255, 255, 0.8);
}

#depenseModal input:focus,
#depenseModal select:focus {
  border-color: #6a11cb;
  box-shadow: 0 0 8px rgba(106, 17, 203, 0.3);
  outline: none;
}

/* Champs invalides */
#depenseModal .input-error {
  border-color: #e74a3b !important;
  background: rgba(231, 74, 59, 0.1);
}

/* ---------- FORM MESSAGE ---------- */
#depenseModal .form-message {
  font-size: 0.95rem;
  margin-top: 0.5rem;
  padding: 0.5rem;
  border-radius: 6px;
  display: none;
}

#depenseModal .form-message.error {
  display: block;
  background: rgba(231, 74, 59, 0.1);
  color: #e74a3b;
}

#depenseModal .form-message.success {
  display: block;
  background: rgba(40, 167, 69, 0.1);
  color: #28a745;
}

/* ---------- FOOTER BUTTONS ---------- */
#depenseModal .modal-footer {
  padding: 1rem 1.5rem;
  background: rgba(0, 0, 0, 0.03);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

#depenseModal .btn {
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.3s;
}

#depenseModal .btn-primary {
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color: #fff;
}
#depenseModal .btn-primary:hover {
  box-shadow: 0 5px 15px rgba(37, 117, 252, 0.4);
  transform: translateY(-2px);
}

#depenseModal .btn-secondary {
  background: #f0f0f0;
  color: #333;
}
#depenseModal .btn-secondary:hover {
  background: #e0e0e0;
}

/* ---------- LOADING SPINNER ---------- */
.loading-spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-top: 4px solid #2575fc;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin: 0 auto 1rem;
  animation: spin 1s linear infinite;
}

/* ---------- ANIMATIONS ---------- */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideDown {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


/* ---------- RESPONSIVE ---------- */
@media (max-width: 480px) {
  #depenseModal .modal-content {
    width: 95%;
    padding: 1rem;
  }
  #depenseModal .modal-header,
  #depenseModal .modal-footer {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  #depenseModal .btn {
    width: 100%;
  }
}

    .spinner {
        border: 4px solid rgba(0,0,0,0.1);
        border-left-color: #007bff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: auto;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }


/* ============================
   JOURNAL MODAL - PERSONNALIS√â
   ============================ */

/* Overlay */
#journalModal.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  z-index: 2000;
  display: none;
  justify-content: center;
  align-items: center;
  padding: 1rem;
}
#journalModal.modal-overlay.active {
  display: flex;
  animation: fadeIn 0.3s ease-out;
}

/* Modal Container */
#journalModal .modal-content {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  width: 95%;
  max-width: 1000px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
  animation: slideDown 0.3s ease-out;
  overflow: hidden;
}

/* Header */
#journalModal .modal-header {
  background: linear-gradient(135deg, #4e73df, #224abe);
  color: #fff;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#journalModal .modal-title {
  font-size: 1.3rem;
  font-weight: 600;
}
#journalModal .modal-close {
  background: none;
  border: none;
  color: #fff;
  font-size: 1.8rem;
  cursor: pointer;
  transition: transform 0.2s ease;
}
#journalModal .modal-close:hover {
  transform: scale(1.2);
}

/* Body */
#journalModal .modal-body {
  padding: 1.5rem;
  max-height: 70vh;
  overflow-y: auto;
}

/* Filters */
#journalModal .filters-card {
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}
#journalModal .filters-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
}
#journalModal .filter-item {
  flex: 1;
  min-width: 180px;
  display: flex;
  flex-direction: column;
}
#journalModal label {
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 0.3rem;
  color: #333;
}
#journalModal .date-range {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
#journalModal input[type="date"],
#journalModal select,
#journalModal input[type="text"] {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 0.5rem;
  font-size: 0.9rem;
  background: #fff;
  transition: all 0.2s ease;
}
#journalModal input:focus,
#journalModal select:focus {
  border-color: #4e73df;
  outline: none;
  box-shadow: 0 0 6px rgba(78, 115, 223, 0.3);
}

/* Table */
#journalModal .table-card {
  background: rgba(255, 255, 255, 0.75);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}
#journalModal table {
  width: 100%;
  border-collapse: collapse;
}
#journalModal th,
#journalModal td {
  padding: 0.8rem;
  text-align: left;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}
#journalModal th {
  background: rgba(78, 115, 223, 0.1);
  color: #224abe;
  font-weight: 600;
}
#journalModal tr:hover {
  background: rgba(78, 115, 223, 0.08);
  transition: background 0.2s ease;
}
#journalModal .text-right {
  text-align: right;
}
#journalModal .text-center {
  text-align: center;
}

/* Spinner */
#journalModal .spinner {
  width: 24px;
  height: 24px;
  border: 3px solid #ddd;
  border-top: 3px solid #4e73df;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: auto;
}

/* Footer */
#journalModal .modal-footer {
  background: rgba(255, 255, 255, 0.9);
  padding: 0.8rem 1.5rem;
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  border-top: 1px solid rgba(0, 0, 0, 0.05);
}

/* Buttons */
#journalModal .btn {
  border: none;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}
#journalModal .btn-primary {
  background: #4e73df;
  color: #fff;
}
#journalModal .btn-primary:hover {
  background: #224abe;
}
#journalModal .btn-secondary {
  background: #f8f9fc;
  color: #333;
  border: 1px solid #ddd;
}
#journalModal .btn-secondary:hover {
  background: #e2e6ea;
}
#journalModal .btn-close-modal {
  background: #ff6b6b;
  color: #fff;
}
#journalModal .btn-close-modal:hover {
  background: #e63946;
}

/* Alert */
#journalModal .alert {
  border-radius: 8px;
  padding: 0.8rem;
  font-size: 0.9rem;
}
#journalModal .alert-info {
  background: #e7f1ff;
  color: #224abe;
  border: 1px solid #b6d4fe;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes slideDown {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Overlay */
#grandCaisseModal.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(6px);
  z-index: 2000;
  display: none;
  justify-content: center;
  align-items: center;
  padding: 1rem;
}
#grandCaisseModal.modal-overlay.active {
  display: flex;
  animation: fadeIn 0.3s ease-out;
}

/* Modal Container */
#grandCaisseModal .modal-content {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  width: 95%;
  max-width: 14px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
  animation: slideDown 0.3s ease-out;
  overflow: hidden;
}

/* Header */
#grandCaisseModal .modal-header {
  background: linear-gradient(135deg, #4e73df, #224abe);
  color: #fff;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#grandCaisseModal .modal-title {
  font-size: 1.3rem;
  font-weight: 600;
}
#grandCaisseModal .modal-close {
  background: none;
  border: none;
  color: #fff;
  font-size: 1.8rem;
  cursor: pointer;
  transition: transform 0.2s ease;
}
#grandCaisseModal .modal-close:hover {
  transform: scale(1.2);
}

/* Body */
#grandCaisseModal .modal-body {
  padding: 1.5rem;
  max-height: 85vh;
  overflow-y: auto;
}

/* Filters */
#grandCaisseModal .filters-card {
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}
#grandCaisseModal .filters-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
}
#grandCaisseModal .filter-item {
  flex: 1;
  min-width: 180px;
  display: flex;
  flex-direction: column;
}
#grandCaisseModal label {
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 0.3rem;
  color: #333;
}
#grandCaisseModal .date-range {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
#grandCaisseModal input[type="date"],
#grandCaisseModal select,
#grandCaisseModal input[type="text"] {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 0.5rem;
  font-size: 0.9rem;
  background: #fff;
  transition: all 0.2s ease;
}
#grandCaisseModal input:focus,
#grandCaisseModal select:focus {
  border-color: #4e73df;
  outline: none;
  box-shadow: 0 0 6px rgba(78, 115, 223, 0.3);
}

/* Table */
#grandCaisseModal .table-card {
  background: rgba(255, 255, 255, 0.75);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}
#grandCaisseModal table {
  width: 100%;
  border-collapse: collapse;
}
#grandCaisseModal th,
#grandCaisseModal td {
  padding: 0.8rem;
  text-align: left;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}
#grandCaisseModal th {
  background: rgba(78, 115, 223, 0.1);
  color: #224abe;
  font-weight: 600;
}
#grandCaisseModal tr:hover {
  background: rgba(78, 115, 223, 0.08);
  transition: background 0.2s ease;
}
#grandCaisseModal .text-right {
  text-align: right;
}
#grandCaisseModal .text-center {
  text-align: center;
}

/* Spinner */
#grandCaisseModal .spinner {
  width: 24px;
  height: 24px;
  border: 3px solid #ddd;
  border-top: 3px solid #4e73df;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: auto;
}

/* Footer */
#grandCaisseModal .modal-footer {
  background: rgba(255, 255, 255, 0.9);
  padding: 0.8rem 1.5rem;
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  border-top: 1px solid rgba(0, 0, 0, 0.05);
}

/* Buttons */
#grandCaisseModal .btn {
  border: none;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}
#grandCaisseModal .btn-primary {
  background: #4e73df;
  color: #fff;
}
#grandCaisseModal .btn-primary:hover {
  background: #224abe;
}
#grandCaisseModal .btn-secondary {
  background: #f8f9fc;
  color: #333;
  border: 1px solid #ddd;
}
#grandCaisseModal .btn-secondary:hover {
  background: #e2e6ea;
}
#grandCaisseModal .btn-close-modal {
  background: #ff6b6b;
  color: #fff;
}
#grandCaisseModal .btn-close-modal:hover {
  background: #e63946;
}

/* Alert */
#grandCaisseModal .alert {
  border-radius: 8px;
  padding: 0.8rem;
  font-size: 0.9rem;
}
#grandCaisseModal .alert-info {
  background: #e7f1ff;
  color: #224abe;
  border: 1px solid #b6d4fe;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes slideDown {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

#produitModal .modal-content {
    width: 90%;
    max-width: 3500px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
    transform: translateY(20px);
    transition: transform 0.4s ease;
}

#produitModal.active .modal-content {
    transform: translateY(0);
}

#produitModal .modal-header {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: #fff;
    padding: 15px 20px;
    border-bottom: none;
}

#produitModal .modal-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: bold;
}

#produitModal .modal-close {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
}

#produitModal .filters-panel {
    display: flex;
    gap: 15px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 8px;
    flex-wrap: wrap;
}

#produitModal .table-container {
    max-height: 60vh;
    overflow-y: auto;
    margin-top: 10px;
}

#produitModal .modal-footer {
    background: rgba(255, 255, 255, 0.6);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    padding: 10px;
    display: flex;
    justify-content: space-between;
}

/* ----- Modal Overlay ----- */
#addUserModal.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
    z-index: 1000;
}

#addUserModal.modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

/* ----- Modal Content ----- */
#addUserModal .modal-content {
    width: 90%;
    max-width: 450px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    overflow: hidden;
    transform: translateY(-20px);
    transition: transform 0.4s ease, opacity 0.3s ease;
    opacity: 0;
}

#addUserModal.active .modal-content {
    transform: translateY(0);
    opacity: 1;
}

/* ----- Header ----- */
#addUserModal .modal-header {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    color: #fff;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: none;
}

#addUserModal .modal-title {
    margin: 0;
    font-size: 1.3rem;
    font-weight: bold;
}

#addUserModal .modal-close {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    transition: transform 0.2s ease;
}

#addUserModal .modal-close:hover {
    transform: rotate(90deg);
}

/* ----- Body ----- */
#addUserModal .modal-body {
    padding: 20px;
}

#addUserModal .form-group {
    margin-bottom: 15px;
}

#addUserModal label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
}

#addUserModal .required {
    color: red;
}

#addUserModal .form-control {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    outline: none;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.7);
}

#addUserModal .form-control:focus {
    border-color: #2575fc;
    box-shadow: 0 0 8px rgba(37, 117, 252, 0.3);
}

/* Message d'erreur / succ√®s */
#addUserModal .form-message {
    margin-top: 8px;
    font-size: 0.9rem;
    color: #d9534f;
    display: none;
}

/* ----- Footer ----- */
#addUserModal .modal-footer {
    padding: 12px 20px;
    background: rgba(255, 255, 255, 0.7);
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* ----- Boutons ----- */
#addUserModal .btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

#addUserModal .btn-primary {
    background: linear-gradient(135deg, #2575fc, #6a11cb);
    color: #fff;
}

#addUserModal .btn-primary:hover {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    transform: translateY(-2px);
}

#addUserModal .btn-secondary {
    background: #ddd;
    color: #333;
}

#addUserModal .btn-secondary:hover {
    background: #bbb;
}

/* ----- Responsive ----- */
@media (max-width: 500px) {
    #addUserModal .modal-content {
        width: 95%;
    }
}

/* === OVERLAY ET MODAL === */
#productModal.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 2000;
}

#productModal.active {
  opacity: 1;
  pointer-events: auto;
}

#productModal .modal-content {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(15px);
  border-radius: 18px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  width: 100%;
  max-width: 600px;
  padding: 0;
  overflow: hidden;
  animation: slideDown 0.35s ease;
}

@keyframes slideDown {
  from { transform: translateY(-30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* === HEADER === */
#productModal .modal-header {
  background: linear-gradient(135deg, #4A90E2, #007AFF);
  color: #fff;
  padding: 14px 20px;
  font-size: 1.2rem;
  font-weight: 600;
}

#productModal .modal-title {
  margin: 0;
}

#productModal .modal-header i {
  margin-right: 8px;
}

/* === BODY === */
#productModal .modal-body {
  padding: 20px;
}

/* === FORM GROUP === */
#productModal .form-group {
  margin-bottom: 15px;
}

#productModal label {
  font-weight: 600;
  margin-bottom: 6px;
  display: block;
  font-size: 0.95rem;
  color: #333;
}

#productModal .required {
  color: #e74c3c;
}

/* === INPUTS & SELECT === */
#productModal .form-control,
#productModal select,
#productModal textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 10px;
  font-size: 0.95rem;
  transition: all 0.2s ease-in-out;
  background: rgba(255, 255, 255, 0.9);
}

#productModal .form-control:focus,
#productModal select:focus,
#productModal textarea:focus {
  border-color: #4A90E2;
  outline: none;
  box-shadow: 0 0 8px rgba(74, 144, 226, 0.2);
}

/* === SELECT + INPUT combo === */
#productModal .select-with-input {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

/* === BUTTONS === */
#productModal .btn {
  padding: 8px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s ease-in-out;
}

#productModal .btn-primary {
  background: linear-gradient(135deg, #4A90E2, #007AFF);
  color: #fff;
}

#productModal .btn-primary:hover {
  background: linear-gradient(135deg, #007AFF, #005FCC);
}

#productModal .btn-secondary {
  background: #f1f1f1;
  color: #333;
}

#productModal .btn-secondary:hover {
  background: #ddd;
}

#productModal .btn-small {
  font-size: 0.8rem;
  padding: 5px 8px;
  background: #eee;
  color: #333;
  border-radius: 6px;
}

#productModal .btn-small:hover {
  background: #ddd;
}

/* === LOADING INDICATOR === */
#productModal .loading-indicator {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1rem;
  color: #4A90E2;
}

/* === FOOTER === */
#productModal .modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 14px 20px;
  background: rgba(245, 245, 245, 0.9);
  border-top: 1px solid #eee;
}

/* === FORM MESSAGES === */
#productModal .form-message {
  margin-top: 10px;
  font-size: 0.9rem;
  display: none;
}

#productModal .form-message.success {
  display: block;
  color: #27ae60;
  font-weight: 600;
}

#productModal .form-message.error {
  display: block;
  color: #e74c3c;
  font-weight: 600;
}


/* === RESPONSIVE === */
@media (max-width: 600px) {
  #productModal .modal-content {
    width: 90%;
    max-width: none;
  }
}
/* üîí Overlay du modal Banque */
#modal-banque {
    position: fixed;
    inset: 0;
    display: none; /* s'affiche uniquement quand actif */
    justify-content: center;
    align-items: center;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}
#modal-banque.active {
    display: flex; /* devient visible */
}


/* üì¶ Contenu du modal */
#modal-banque .modal-content {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    width: 95%;
    max-width: 200px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    overflow-x: auto;
    animation: slideIn 0.3s ease;
}

/* üîπ Header du modal */
#modal-banque .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

#modal-banque .modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
}

/* üîπ Table Banque */
#modal-banque .banque-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    min-width: 800px;
}

#modal-banque .banque-table th,
#modal-banque .banque-table td {
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
}

#modal-banque .banque-table th {
    background-color: #f3f4f6;
    color: #111827;
    font-weight: 600;
}

#modal-banque .banque-table td.text-right {
    text-align: right;
}

/* üîπ Lignes Totaux */
#modal-banque .total-row {
    background-color: #f9fafb;
    font-weight: bold;
}

/* üîπ Category editable */
#modal-banque .editable-category span {
    cursor: pointer;
    color: #3b82f6;
    font-weight: 500;
}

#modal-banque .editable-category select {
    width: 100%;
    padding: 0.3rem;
    border-radius: 6px;
    border: 1px solid #d1d5db;
}

/* üîπ Spinner pour chargement */
#modal-banque .spinner {
    width: 30px;
    height: 30px;
    border: 4px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 1rem auto;
}

/* üîπ Boutons */
#modal-banque .btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s ease, transform 0.2s ease;
}

#modal-banque .btn-secondary {
    background-color: #e5e7eb;
    color: #374151;
}

#modal-banque .btn-secondary:hover {
    background-color: #d1d5db;
    transform: translateY(-1px);
}

#modal-banque .btn-close-modal {
    background-color: #ef4444;
    color: #fff;
}

#modal-banque .btn-close-modal:hover {
    background-color: #dc2626;
    transform: translateY(-1px);
}

#modal-banque .btn-primary {
    background-color: #3b82f6;
    color: #fff;
}

#modal-banque .btn-primary:hover {
    background-color: #2563eb;
    transform: translateY(-1px);
}

/* üîπ Messages */
#modal-banque .alert {
    padding: 0.6rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
}

/* üîπ Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Custom Styles for Caisse Modal */
#modal-${action} {
    /* Base Modal Overlay */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* Slightly darker overlay for better contrast */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1050; /* Ensure it's on top of other content */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}

#modal-${action}.active {
    opacity: 1;
    visibility: visible;
}

#modal-${action} .modal-content {
    background-color: #ffffff;
    border-radius: 12px; /* Smoother, modern corners */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* Deeper shadow for a "lifted" effect */
    max-width: 1200px;
    width: 95%; /* Responsive width */
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease;
}

#modal-${action}.active .modal-content {
    transform: scale(1);
}

#modal-${action} .modal-header {
    background-color: #4A90E2; /* Professional blue header */
    color: #fff;
    padding: 20px 30px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

#modal-${action} .modal-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
}

#modal-${action} .modal-title i {
    margin-right: 12px;
    font-size: 1.8rem;
}

#modal-${action} .modal-body {
    padding: 30px;
    display: flex;
    flex-direction: column;
    gap: 25px;
}

/* Filters Card */
#modal-${action} .filters-card {
    background-color: #F8F9FA;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #E0E0E0;
}

#modal-${action} .filters-container {
    display: flex;
    align-items: flex-end; /* Align items to the bottom */
    gap: 20px;
    flex-wrap: wrap;
}

#modal-${action} .filter-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#modal-${action} .filter-item label {
    font-weight: 500;
    color: #555;
    display: flex;
    align-items: center;
    gap: 8px;
}

#modal-${action} .date-range {
    display: flex;
    align-items: center;
    gap: 10px;
}

#modal-${action} .date-range input {
    border: 1px solid #CED4DA;
    border-radius: 6px;
    padding: 8px 12px;
    transition: border-color 0.2s;
    font-size: 0.95rem;
}

#modal-${action} .date-range input:focus {
    border-color: #4A90E2;
    outline: none;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
}

/* Table Card */
#modal-${action} .table-card {
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    overflow: hidden; /* Ensures table corners are rounded */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}

#modal-${action} .caisse-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

#modal-${action} .caisse-table thead {
    background-color: #f2f2f2;
    border-bottom: 2px solid #E0E0E0;
}

#modal-${action} .caisse-table th,
#modal-${action} .caisse-table td {
    padding: 15px 20px;
    text-align: left;
    border-bottom: 1px solid #E9ECEF;
    vertical-align: middle;
}

#modal-${action} .caisse-table th {
    font-weight: 600;
    color: #495057;
    white-space: nowrap;
}

#modal-${action} .caisse-table tbody tr:last-child td {
    border-bottom: none;
}

#modal-${action} .caisse-table tbody tr:hover {
    background-color: #F8F9FA;
}

#modal-${action} .caisse-table tfoot {
    background-color: #E6F0F8;
    font-weight: 700;
}

#modal-${action} .caisse-table tfoot td {
    border-top: 2px solid #4A90E2;
    color: #212529;
}

#modal-${action} .caisse-table .text-right {
    text-align: right;
    font-weight: 500;
}

#modal-${action} .spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-top-color: #4A90E2;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#modal-${action} .alert {
    padding: 15px;
    border-radius: 8px;
    border: 1px solid transparent;
}

#modal-${action} .alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}

/* Footer & Buttons */
#modal-${action} .modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #E9ECEF;
    background-color: #f8f9fa;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
}

#modal-${action} .btn {
    border-radius: 6px;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 600;
    transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

#modal-${action} .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#modal-${action} .btn-secondary {
    background-color: #6c757d;
    color: #fff;
    border: none;
}

#modal-${action} .btn-secondary:hover {
    background-color: #5a6268;
}

#modal-${action} .btn-close-modal {
    background-color: #dc3545; /* A subtle red for 'close' */
    color: #fff;
    border: none;
}

#modal-${action} .btn-close-modal:hover {
    background-color: #c82333;
}

.caisse-summary-item {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 15px 20px;
    border: 2px solid #dee2e6;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    margin-left: auto;
    min-width: 220px;
    text-align: center;
}

.caisse-summary-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    border-color: #007bff;
}

.caisse-summary-item label {
    display: block;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    font-size: 1.1rem;
}

/* Style pour la valeur num√©rique */
.caisse-value-display {
    font-size: 1.8rem;
    font-weight: 700;
    color: #28a745;
    display: block;
    padding: 10px 15px;
    background-color: white;
    border-radius: 8px;
    border: 2px dashed #28a745;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.15);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    animation: pulse 2s infinite;
}

.caisse-value-display:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
}

/* Animation de pulsation subtile */
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.15);
    }
    70% {
        box-shadow: 0 0 0 6px rgba(40, 167, 69, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
    }
}

/* Adaptation pour mobile */
@media (max-width: 768px) {
    #modal-${action} .modal-content {
        width: 95%;
        margin: 20px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    #modal-${action} .modal-header {
        padding: 15px 20px;
    }
    
    #modal-${action} .modal-title {
        font-size: 1.2rem;
    }
    
    #modal-${action} .modal-body {
        padding: 20px 15px;
        gap: 15px;
    }
    
    #modal-${action} .filters-container {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    #modal-${action} .filter-item {
        width: 100%;
    }
    
    #modal-${action} .date-range {
        flex-direction: column;
        gap: 8px;
    }
    
    #modal-${action} .date-range span {
        display: none;
    }
    
    .caisse-summary-item {
        min-width: auto;
        width: 100%;
        margin-left: 0;
        margin-top: 10px;
        padding: 12px 15px;
    }
    
    .caisse-value-display {
        font-size: 1.4rem;
        padding: 8px 12px;
    }
    
    #modal-${action} .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    #modal-${action} .caisse-table {
        min-width: 600px; /* Force le d√©filement horizontal sur tablettes/mobiles */
        font-size: 0.8rem;
    }
    
    #modal-${action} .caisse-table th,
    #modal-${action} .caisse-table td {
        padding: 10px 12px;
    }
    
    #modal-${action} .modal-footer {
        padding: 15px 20px;
        flex-direction: column-reverse;
    }
    
    #modal-${action} .btn {
        width: 100%;
        justify-content: center;
        padding: 12px;
    }
}

/* Adaptation pour tr√®s petits √©crans */
@media (max-width: 480px) {
    #modal-${action} .modal-content {
        margin: 10px;
        width: calc(100% - 20px);
    }
    
    #modal-${action} .modal-header {
        padding: 12px 15px;
    }
    
    #modal-${action} .modal-title {
        font-size: 1.1rem;
    }
    
    #modal-${action} .modal-body {
        padding: 15px 10px;
        gap: 12px;
    }
    
    .caisse-value-display {
        font-size: 1.3rem;
        padding: 6px 10px;
    }
    
    #modal-${action} .caisse-table {
        min-width: 650px; /* Un peu plus large pour assurer la lisibilit√© */
    }
}
</style>
</head>
<body>
    <div class="dashboard">
          <!-- Barre lateral unique debut -->
 <aside class="sidebar">
    <div class="logo-container">
        <div class="logo">
            <img src="logoAppli.png" alt="VOIR PLUS OPTIC Logo" class="logo-image">
            <span class="logo-text">VOIR PLUS OPTIC</span>
        </div>
        <div class="sidebar-toggle">
            <i class="fas fa-chevron-left"></i>
        </div>
    </div>
    
    <nav class="menu">
        <!-- Tableau de bord -->
        <div class="menu-item">
            <a class="menu-link">
                <div class="menu-icon">
                    <i class="fas fa-grid-2"></i>
                </div>
                <span class="menu-text">Tableau de bord</span>
                <i class="fas fa-chevron-down chevron"></i>
            </a>
            <div class="submenu">
                <a href="#" onclick="openVueGlobale()">
                    <div class="submenu-icon">
                        <i class="fas fa-chart-network"></i>
                    </div>
                    <span>Vue Globale</span>
                </a>
                <a href="#" onclick="openLooker()">
                    <div class="submenu-icon">
                        <i class="fas fa-analytics"></i>
                    </div>
                    <span>Statistiques</span>
                </a>
            </div>
        </div>

        <!-- Gestion des Ventes -->
        <div class="menu-item active">
            <a class="menu-link">
                <div class="menu-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <span class="menu-text">Gestion des Ventes</span>
                <i class="fas fa-chevron-down chevron"></i>
            </a>
            <div class="submenu">
                <a href="#" onclick="openNewSale()">
                    <div class="submenu-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <span>Nouvelle Vente</span>
                    <span class="menu-badge">New</span>
                </a>
                <div id="vente-loader" class="menu-loader">
                    <div class="loader-spinner"></div>
                    <span id="vente-status">Chargement...</span>
                </div>
                <a href="#" onclick="openDevis()">
                    <div class="submenu-icon">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <span>Facture Proforma</span>
                </a>
            </div>
        </div>

        <!-- Gestion Stock -->
        <div class="menu-item">
            <a class="menu-link">
                <div class="menu-icon">
                    <i class="fas fa-pallet"></i>
                </div>
                <span class="menu-text">Gestion Stock</span>
                <i class="fas fa-chevron-down chevron"></i>
            </a>
            <div class="submenu">
                <a href="#" onclick="openProductEntryForm()">
                    <div class="submenu-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <span>R√©ception Stock</span>
                </a>
                <a href="#" onclick="openListeProduit()">
                    <div class="submenu-icon">
                        <i class="fas fa-boxes-stacked"></i>
                    </div>
                    <span>Inventaire</span>
                </a>
            </div>
        </div>

        <!-- Assurances -->
        <div class="menu-item">
            <a class="menu-link">
                <div class="menu-icon">
                    <i class="fas fa-shield-check"></i>
                </div>
                <span class="menu-text">Assurances</span>
                <i class="fas fa-chevron-down chevron"></i>
            </a>
            <div class="submenu">
                <a href="#" onclick="openFacturation()">
                    <div class="submenu-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <span>Facturation TP</span>
                </a>
                <a href="#" onclick="openPointFacturation()">
                    <div class="submenu-icon">
                        <i class="fas fa-clipboard-list-check"></i>
                    </div>
                    <span>Point Facturation</span>
                </a>
            </div>
        </div>

        <!-- Catalogue Produit -->
        <div class="menu-item">
            <a class="menu-link">
                <div class="menu-icon">
                    <i class="fas fa-catalog"></i>
                </div>
                <span class="menu-text">Catalogue Produit</span>
                <i class="fas fa-chevron-down chevron"></i>
            </a>
            <div class="submenu">
                <a href="#" onclick="openListeMonture()">
                    <div class="submenu-icon">
                        <i class="fas fa-glasses"></i>
                    </div>
                    <span>Montures</span>
                </a>

                <a href="#" onclick="openCatalogueVerre('catalogueVerre')">
                    <div class="submenu-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <span>Catalogue Produit</span>
                </a>
            </div>
        </div>

        <!-- Gestion de Caisse -->
        <div class="menu-item">
            <a class="menu-link">
                <div class="menu-icon">
                    <i class="fas fa-cash-register"></i>
                </div>
                <span class="menu-text">Gestion de Caisse</span>
                <i class="fas fa-chevron-down chevron"></i>
            </a>
            <div class="submenu">
                <a href="#" onclick="openEntreesJournal()">
                    <div class="submenu-icon">
                        <i class="fas fa-arrow-down-to-bracket"></i>
                    </div>
                    <span>Entr√©es Caisse</span>
                </a>
                <a href="#" onclick="openDepensesJournal()">
                    <div class="submenu-icon">
                        <i class="fas fa-arrow-up-from-bracket"></i>
                    </div>
                    <span>Sorties Caisse</span>
                </a>
                
                <!-- Sous-section Caisses -->
                <div class="submenu-section">
                    <div class="submenu-header">
                        <i class="fas fa-wallet"></i>
                        <span>Caisses Physiques</span>
                    </div>
                    <a href="#" onclick="openCaisse('caisse1', 'Cotonou');">
                        <div class="submenu-icon">
                            <i class="fas fa-location-dot"></i>
                        </div>
                        <span>Cotonou</span>
                        <span class="menu-status online"></span>
                    </a>
                    <a href="#" onclick="openCaisse('caisse2', 'Calavi');">
                        <div class="submenu-icon">
                            <i class="fas fa-location-dot"></i>
                        </div>
                        <span>Calavi</span>
                        <span class="menu-status online"></span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Administration -->
        <div class="menu-item">
            <a class="menu-link" onclick="toggleAdminMenu(event)">
                <div class="menu-icon">
                    <i class="fas fa-user-shield"></i>
                </div>
                <span class="menu-text">Administration</span>
                <i class="fas fa-chevron-down chevron"></i>
                <span class="card-badge trending">Admin</span>
            </a>
            <div class="submenu">
                <a href="#" onclick="openAddUserForm()">
                    <div class="submenu-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <span>Nouvel Utilisateur</span>
                </a>
                <a href="#" onclick="openBanque()">
                    <div class="submenu-icon">
                        <i class="fas fa-building-columns"></i>
                    </div>
                    <span>Journal Banque</span>
                </a>
                <a href="#" onclick="openJournalGrandCaisse()">
                    <div class="submenu-icon">
                        <i class="fas fa-vault"></i>
                    </div>
                    <span>Grande Caisse</span>
                </a>
            </div>
        </div>
    </nav>
    
<!-- Footer de la sidebar -->
<div class="sidebar-footer">
    <div class="user-profile">
        <div class="profile-avatar">
            <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="Admin" class="profile-img">
            <div class="online-status"></div>
        </div>
        <div class="profile-info">
            <span class="profile-name" id="username-display"></span>
            <span class="profile-role">
                <i class="fas fa-circle"></i>
                Session active
            </span>
        </div>
    </div>
    <div class="footer-actions">
        <button class="logout-btn" id="logout-btn" title="D√©connexion">
            <i class="fas fa-right-from-bracket"></i>
        </button>
    </div>
</div>
</aside>


        <div class="main">
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Mon Espace</h1>
                </div>
                
                <div class="user-info">             
    <div class="user-profile">
        <div class="profile-info">
            <span class="profile-role">
                <i class="fas fa-circle"></i>
                Session active
            </span>
        </div>
    </div>
                </div>
            </header>
            <section class="dashboard-section">
<div class="dashboard-header">
    <h1>Tableau de bord</h1>
</div>

<div class="quick-actions">
    <button class="quick-action-card" onclick="openNewSale()">
        <div class="card-icon">
            <i class="fas fa-cash-register"></i>
        </div>
        <div class="card-content">
            <span class="card-title">Nouvelle Vente</span>
            <span class="card-desc">Ajouter une Nouvelle Vente </span>
        </div>
        <div class="card-badge">+</div>
    </button>
    
    <button class="quick-action-card" onclick="openDepense()">
        <div class="card-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="card-content">
            <span class="card-title">D√©pense</span>
            <span class="card-desc">Sortie de caisse</span>
        </div>
    </button>
    
    <button class="quick-action-card" onclick="openDevis()">
        <div class="card-icon">
            <i class="fas fa-file-contract"></i>
        </div>
        <div class="card-content">
            <span class="card-title">Proforma</span>
            <span class="card-desc">Cr√©er un devis</span>
        </div>
    </button>
    
    <button class="quick-action-card" onclick="openLooker()">
        <div class="card-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="card-content">
            <span class="card-title">Analytics</span>
            <span class="card-desc">Tableaux de bord</span>
        </div>
        <div class="card-badge trending">Admin</div>
    </button>
</div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="section-title">
                            <i class="fas fa-users"></i>
                            Liste des Clients
                        </h2>
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Rechercher par ID..." />
                        </div>
                    </div>

                    <div id="loading-indicator" class="loading-indicator">
                        <div class="loading-spinner"></div>
                        <p>Chargement des clients...</p>
                    </div>
                    
                    <div id="error-message" class="error-message"></div>
                        <div id="table-container">
                            <div class="table-responsive">
                                <table id="client-table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            
                        </div>


                    <div class="pagination-controls">
                        <div class="pagination-info" id="page-info">
                            Affichage de 1 √† 3 sur 25 clients
                        </div>
                        <div class="pagination-buttons">
                            <button class="pagination-btn" id="prevPage" disabled>
                                <i class="fas fa-chevron-left"></i> Pr√©c√©dent
                            </button>
                            <button class="pagination-btn">1</button>
                            <button class="pagination-btn">2</button>
                            <button class="pagination-btn">3</button>
                            <button class="pagination-btn" id="nextPage">
                                Suivant <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="items-per-page">
                            <span>Affichage :</span>
                            <select id="itemsPerPageSelect">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
<div id="modal-container"></div>

    <!-- Modale Proforma -->
    
<div class="modal-overlay" id="proformaModal">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">Facture Proforma</h3>
        </div>
        <div class="modal-body">
            <div class="form-container">
                <form id="client-form" method="POST"> 
                    <!-- Stepper Navigation -->
                    <div class="stepper">
                        <div class="step active" id="step1">
                            <div class="step-number">1</div>
                            <div class="step-label">Informations Client</div>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <div class="step-label">Prescription</div>
                        </div>
                        <div class="step" id="step4">
                            <div class="step-number">3</div>
                            <div class="step-label">Paiement</div>
                        </div>
                    </div>
                    
                    <!-- Step 1: Client Information -->
                    <div class="form-section active" id="section1">
                        <h2 class="section-title">INFORMATION CLIENT</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nom_complet" class="required-field">Nom complet du client</label>
                                <input type="text" name="nom_complet" id="nom_complet" required />
                            </div>

                            <div class="form-group">
                                <label class="required-field">Contact</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" name="indicatif" placeholder="+229" value="+229" style="width: 70px;" required/>
                                    <input type="tel" name="numero" placeholder="012345678" required />
                                </div>
                            </div>
                         </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="date_naissance" class="required-field">N√© le</label>
                                <input type="date" name="date_naissance" id="date_naissance" required />
                            </div>
                        

                        
                            <div class="form-group">
                                <label for="civilite" class="required-field">Civilit√©</label>
                                <select name="civilite" id="civilite" required>
                                    <option value="M.">M.</option>
                                    <option value="Mme">Mme</option>
                                    <option value="Mlle">Mlle</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-navigation">
                            <button type="button" class="btn btn-secondary" id="cancelButton">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                            <button type="button" class="btn btn-primary next-step" data-next="2">
                                Suivant <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Prescription -->
                    <div class="form-section" id="section2">
                        <h2 class="section-title">PRESCRIPTION ET COMMANDE</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="type_verre" class="required-field">Type de Verre</label>
                                <select name="type_verre" id="type_verre" required>
                                    <option value="">-- S√©lectionnez --</option>
<option value="ACHAT MONTURE">ACHAT MONTURE</option>
<option value="ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE 1.6 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE 1.6 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE1.56 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  BLANC/ ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER BLANC/ ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE1.56 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 UNIFOCAL BLANC/ ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET">ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.74 UNIFOCAL PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.74 UNIFOCAL TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE1.56 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 PROGRESSIF BLANC/ ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET">ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.74 PROGRESSIF PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.74 PROGRESSIF TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  BLANC/ ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET">ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE1.56 DOUBLE FOYER  PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE1.56 DOUBLE FOYER  TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER BLANC/ ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER BLANC/ ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET">ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE">ORGANIQUE 1.6 DOUBLE FOYER PHOTOCHROMIQUE AR+ ANTILUMIERE BLUE</option>
<option value="ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET + ANTILUMIERE BLUE">ORGANIQUE 1.6 DOUBLE FOYER TRANSITION ANTIREFLET + ANTILUMIERE BLUE</option>      </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="gamme_verre" class="required-field">Gamme des Verres</label>
                                <select name="gamme_verre" id="gamme_verre" required>
                                    <option value="">-- S√©lectionnez --</option>
                                    <option value="ENTREE DE GAMME">ENTREE DE GAMME</option>
                                    <option value="MOYEN DE GAMME">MOYEN DE GAMME</option>
                                    <option value="HAUT DE GAMME">HAUT DE GAMME</option>
                                    
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="choix_monture" class="required-field">Choix de Monture</label>
                              <input type="text"  name="choix_monture" id="choix_monture" required />
                                
                            </div>
                        </div>

                        <div class="prescription-table-container">
                            <table class="prescription-table">
                                <thead>
                                    <tr>
                                        <th>≈íil</th>
                                        <th>Sphere</th>
                                        <th>Cylindre</th>
                                        <th>Axe</th>
                                        <th>ADD</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr>
                                        <td>OD</td>
                                        <td>
                                            <select name="od_sphere" required>
                                                <option value="0.00">0.00</option>
                                                <option value="+0.25">+0.25</option>
                                                <option value="+0.50">+0.50</option>
                                                <option value="+0.75">+0.75</option>
                                                <option value="+1.00">+1.00</option>
                                                <option value="+1.25">+1.25</option>
                                                <option value="+1.50">+1.50</option>
                                                <option value="+1.75">+1.75</option>
                                                <option value="+2.00">+2.00</option>
                                                <option value="+2.25">+2.25</option>
                                                <option value="+2.50">+2.50</option>
                                                <option value="+2.75">+2.75</option>
                                                <option value="+3.00">+3.00</option>
                                                <option value="+3.25">+3.25</option>
                                                <option value="+3.50">+3.50</option>
                                                <option value="+3.75">+3.75</option>
                                                <option value="+4.00">+4.00</option>
                                                <option value="+4.25">+4.25</option>
                                                <option value="+4.50">+4.50</option>
                                                <option value="+4.75">+4.75</option>
                                                <option value="+5.00">+5.00</option>
                                                <option value="+5.25">+5.25</option>
                                                <option value="+5.50">+5.50</option>
                                                <option value="+5.75">+5.75</option>
                                                <option value="+6.00">+6.00</option>
                                                <option value="+6.25">+6.25</option>
                                                <option value="+6.50">+6.50</option>
                                                <option value="+6.75">+6.75</option>
                                                <option value="+7.00">+7.00</option>
                                                <option value="+7.25">+7.25</option>
                                                <option value="+7.50">+7.50</option>
                                                <option value="+7.75">+7.75</option>
                                                <option value="+8,00">+8,00</option>
                                                <option value="+8.25">+8.25</option>
                                                <option value="+8.50">+8.50</option>
                                                <option value="+8.75">+8.75</option>
                                                <option value="+9.00">+9.00</option>
                                                <option value="+9.25">+9.25</option>
                                                <option value="+9.50">+9.50</option>
                                                <option value="+9.75">+9.75</option>
                                                <option value="+10,00">+10.00</option>
                                                <option value="+10.25">+10.25</option>
                                                <option value="+10.5">+10.5</option>
                                                <option value="+10.75">+10.75</option>
                                                <option value="+11,00">+11.00</option>
                                                <option value="+11.25">+11.25</option>
                                                <option value="+11.50">+11.50</option>
                                                <option value="+11.75">+11.75</option>
                                                <option value="+12,00">+12,00</option>
                                                <option value="-0.25">-0.25</option>
                                                <option value="-0.50">-0.50</option>
                                                <option value="-0.75">-0.75</option>
                                                <option value="-1.00">-1.00</option>
                                                <option value="-1.25">-1.25</option>
                                                <option value="-1.50">-1.50</option>
                                                <option value="-1.75">-1.75</option>
                                                <option value="-2.00">-2.00</option>
                                                <option value="-2.25">-2.25</option>
                                                <option value="-2.50">-2.50</option>
                                                <option value="-2.75">-2.75</option>
                                                <option value="-3.00">-3.00</option>
                                                <option value="-3.25">-3.25</option>
                                                <option value="-3.50">-3.50</option>
                                                <option value="-3.75">-3.75</option>
                                                <option value="-4.00">-4.00</option>
                                                <option value="-4.25">-4.25</option>
                                                <option value="-4.50">-4.50</option>
                                                <option value="-4.75">-4.75</option>
                                                <option value="-5.00">-5.00</option>
                                                <option value="-5.25">-5.25</option>
                                                <option value="-5.50">-5.50</option>
                                                <option value="-5.75">-5.75</option>
                                                <option value="-6.00">-6.00</option>
                                                <option value="-6.25">-6.25</option>
                                                <option value="-6.50">-6.50</option>
                                                <option value="-6.75">-6.75</option>
                                                <option value="-7.00">-7.00</option>
                                                <option value="-7.25">-7.25</option>
                                                <option value="-7.50">-7.50</option>
                                                <option value="-7.75">-7.75</option>
                                                <option value="-8.00">-8.00</option>
                                                <option value="-8.25">-8.25</option>
                                                <option value="-8.50">-8.50</option>
                                                <option value="-8.75">-8.75</option>
                                                <option value="-9.00">-9.00</option>
                                                <option value="-9.25">-9.25</option>
                                                <option value="-9.50">-9.50</option>
                                                <option value="-9.75">-9.75</option>
                                                <option value="-10.00">-10.00</option>
                                                <option value="-10.25">-10.25</option>
                                                <option value="-10.50">-10.50</option>
                                                <option value="-10.75">-10.75</option>
                                                <option value="-11.00">-11.00</option>
                                                <option value="-11.25">-11.25</option>
                                                <option value="-11.50">-11.50</option>
                                                <option value="-11.75">-11.75</option>
                                                <option value="-12.00">-12.00</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_cylindre">
                                                <option value="0.00">0.00</option>
                                                <option value="+0.25">+0.25</option>
                                                <option value="+0.50">+0.50</option>
                                                <option value="+0.75">+0.75</option>
                                                <option value="+1.00">+1.00</option>
                                                <option value="+1.25">+1.25</option>
                                                <option value="+1.50">+1.50</option>
                                                <option value="+1.75">+1.75</option>
                                                <option value="+2.00">+2.00</option>
                                                <option value="+2.25">+2.25</option>
                                                <option value="+2.50">+2.50</option>
                                                <option value="+2.75">+2.75</option>
                                                <option value="+3.00">+3.00</option>
                                                <option value="+3.25">+3.25</option>
                                                <option value="+3.50">+3.50</option>
                                                <option value="+3.75">+3.75</option>
                                                <option value="+4.00">+4.00</option>
                                                <option value="+4.25">+4.25</option>
                                                <option value="+4.50">+4.50</option>
                                                <option value="+4.75">+4.75</option>
                                                <option value="+5.00">+5.00</option>
                                                <option value="+5.25">+5.25</option>
                                                <option value="+5.50">+5.50</option>
                                                <option value="+5.75">+5.75</option>
                                                <option value="+6.00">+6.00</option>
                                                <option value="+6.25">+6.25</option>
                                                <option value="+6.50">+6.50</option>
                                                <option value="+6.75">+6.75</option>
                                                <option value="+7.00">+7.00</option>
                                                <option value="+7.25">+7.25</option>
                                                <option value="+7.50">+7.50</option>
                                                <option value="+7.75">+7.75</option>
                                                <option value="+8,00">+8,00</option>
                                                <option value="+8.25">+8.25</option>
                                                <option value="+8.50">+8.50</option>
                                                <option value="+8.75">+8.75</option>
                                                <option value="+9.00">+9.00</option>
                                                <option value="+9.25">+9.25</option>
                                                <option value="+9.50">+9.50</option>
                                                <option value="+9.75">+9.75</option>
                                                <option value="+10,00">+10,00</option>
                                                <option value="+10.25">+10.25</option>
                                                <option value="+10.5">+10.5</option>
                                                <option value="+10.75">+10.75</option>
                                                <option value="+11,00">+11,00</option>
                                                <option value="+11.25">+11.25</option>
                                                <option value="+11.50">+11.50</option>
                                                <option value="+11.75">+11.75</option>
                                                <option value="+12,00">+12,00</option>
                                                <option value="-0.25">-0.25</option>
                                                <option value="-0.50">-0.50</option>
                                                <option value="-0.75">-0.75</option>
                                                <option value="-1.00">-1.00</option>
                                                <option value="-1.25">-1.25</option>
                                                <option value="-1.50">-1.50</option>
                                                <option value="-1.75">-1.75</option>
                                                <option value="-2.00">-2.00</option>
                                                <option value="-2.25">-2.25</option>
                                                <option value="-2.50">-2.50</option>
                                                <option value="-2.75">-2.75</option>
                                                <option value="-3.00">-3.00</option>
                                                <option value="-3.25">-3.25</option>
                                                <option value="-3.50">-3.50</option>
                                                <option value="-3.75">-3.75</option>
                                                <option value="-4.00">-4.00</option>
                                                <option value="-4.25">-4.25</option>
                                                <option value="-4.50">-4.50</option>
                                                <option value="-4.75">-4.75</option>
                                                <option value="-5.00">-5.00</option>
                                                <option value="-5.25">-5.25</option>
                                                <option value="-5.50">-5.50</option>
                                                <option value="-5.75">-5.75</option>
                                                <option value="-6.00">-6.00</option>
                                                <option value="-6.25">-6.25</option>
                                                <option value="-6.50">-6.50</option>
                                                <option value="-6.75">-6.75</option>
                                                <option value="-7.00">-7.00</option>
                                                <option value="-7.25">-7.25</option>
                                                <option value="-7.50">-7.50</option>
                                                <option value="-7.75">-7.75</option>
                                                <option value="-8.00">-8.00</option>
                                                <option value="-8.25">-8.25</option>
                                                <option value="-8.50">-8.50</option>
                                                <option value="-8.75">-8.75</option>
                                                <option value="-9.00">-9.00</option>
                                                <option value="-9.25">-9.25</option>
                                                <option value="-9.50">-9.50</option>
                                                <option value="-9.75">-9.75</option>
                                                <option value="-10.00">-10.00</option>
                                                <option value="-10.25">-10.25</option>
                                                <option value="-10.50">-10.50</option>
                                                <option value="-10.75">-10.75</option>
                                                <option value="-11.00">-11.00</option>
                                                <option value="-11.25">-11.25</option>
                                                <option value="-11.50">-11.50</option>
                                                <option value="-11.75">-11.75</option>
                                                <option value="-12.00">-12.00</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_axe">
                                                <option value="0¬∞">0¬∞</option>
                                                <option value="5¬∞">5¬∞</option>
                                                <option value="10¬∞">10¬∞</option>
                                                <option value="15¬∞">15¬∞</option>
                                                <option value="20¬∞">20¬∞</option>
                                                <option value="25¬∞">25¬∞</option>
                                                <option value="30¬∞">30¬∞</option>
                                                <option value="35¬∞">35¬∞</option>
                                                <option value="40¬∞">40¬∞</option>
                                                <option value="45¬∞">45¬∞</option>
                                                <option value="50¬∞">50¬∞</option>
                                                <option value="55¬∞">55¬∞</option>
                                                <option value="60¬∞">60¬∞</option>
                                                <option value="65¬∞">65¬∞</option>
                                                <option value="70¬∞">70¬∞</option>
                                                <option value="75¬∞">75¬∞</option>
                                                <option value="80¬∞">80¬∞</option>
                                                <option value="85¬∞">85¬∞</option>
                                                <option value="90¬∞">90¬∞</option>
                                                <option value="95¬∞">95¬∞</option>
                                                <option value="100¬∞">100¬∞</option>
                                                <option value="105¬∞">105¬∞</option>
                                                <option value="110¬∞">110¬∞</option>
                                                <option value="115¬∞">115¬∞</option>
                                                <option value="120¬∞">120¬∞</option>
                                                <option value="125¬∞">125¬∞</option>
                                                <option value="130¬∞">130¬∞</option>
                                                <option value="135¬∞">135¬∞</option>
                                                <option value="140¬∞">140¬∞</option>
                                                <option value="145¬∞">145¬∞</option>
                                                <option value="150¬∞">150¬∞</option>
                                                <option value="155¬∞">155¬∞</option>
                                                <option value="160¬∞">160¬∞</option>
                                                <option value="165¬∞">165¬∞</option>
                                                <option value="170¬∞">170¬∞</option>
                                                <option value="175¬∞">175¬∞</option>
                                                <option value="180¬∞">180¬∞</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_add">
                                                    <option value="0.00">0.00</option>
                                                    <option value="+0.50">+0.50</option>
                                                    <option value="+0.75">+0.75</option>
                                                    <option value="+1.00">+1.00</option>
                                                    <option value="+1.25">+1.25</option>
                                                    <option value="+1.50">+1.50</option>
                                                    <option value="+1.75">+1.75</option>
                                                    <option value="+2.00">+2.00</option>
                                                    <option value="+2.25">+2.25</option>
                                                    <option value="+2.50">+2.50</option>
                                                    <option value="+2.75">+2.75</option>
                                                    <option value="+3.00">+3.00</option>
                                                    <option value="+3.25">+3.25</option>
                                                    <option value="+3.50">+3.50</option>
                                                    <option value="+3.75">+3.75</option>
                                                    <option value="+4.00">+4.00</option>
                                            </select>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td>OG</td>
                                        <td>
                                            <select name="og_sphere" required>
                                                <option value="0.00">0.00</option>
                                                <option value="+0.25">+0.25</option>
                                                <option value="+0.50">+0.50</option>
                                                <option value="+0.75">+0.75</option>
                                                <option value="+1.00">+1.00</option>
                                                <option value="+1.25">+1.25</option>
                                                <option value="+1.50">+1.50</option>
                                                <option value="+1.75">+1.75</option>
                                                <option value="+2.00">+2.00</option>
                                                <option value="+2.25">+2.25</option>
                                                <option value="+2.50">+2.50</option>
                                                <option value="+2.75">+2.75</option>
                                                <option value="+3.00">+3.00</option>
                                                <option value="+3.25">+3.25</option>
                                                <option value="+3.50">+3.50</option>
                                                <option value="+3.75">+3.75</option>
                                                <option value="+4.00">+4.00</option>
                                                <option value="+4.25">+4.25</option>
                                                <option value="+4.50">+4.50</option>
                                                <option value="+4.75">+4.75</option>
                                                <option value="+5.00">+5.00</option>
                                                <option value="+5.25">+5.25</option>
                                                <option value="+5.50">+5.50</option>
                                                <option value="+5.75">+5.75</option>
                                                <option value="+6.00">+6.00</option>
                                                <option value="+6.25">+6.25</option>
                                                <option value="+6.50">+6.50</option>
                                                <option value="+6.75">+6.75</option>
                                                <option value="+7.00">+7.00</option>
                                                <option value="+7.25">+7.25</option>
                                                <option value="+7.50">+7.50</option>
                                                <option value="+7.75">+7.75</option>
                                                <option value="+8,00">+8,00</option>
                                                <option value="+8.25">+8.25</option>
                                                <option value="+8.50">+8.50</option>
                                                <option value="+8.75">+8.75</option>
                                                <option value="+9.00">+9.00</option>
                                                <option value="+9.25">+9.25</option>
                                                <option value="+9.50">+9.50</option>
                                                <option value="+9.75">+9.75</option>
                                                <option value="+10,00">+10,00</option>
                                                <option value="+10.25">+10.25</option>
                                                <option value="+10.5">+10.5</option>
                                                <option value="+10.75">+10.75</option>
                                                <option value="+11,00">+11,00</option>
                                                <option value="+11.25">+11.25</option>
                                                <option value="+11.50">+11.50</option>
                                                <option value="+11.75">+11.75</option>
                                                <option value="+12,00">+12,00</option>
                                                <option value="-0.25">-0.25</option>
                                                <option value="-0.50">-0.50</option>
                                                <option value="-0.75">-0.75</option>
                                                <option value="-1.00">-1.00</option>
                                                <option value="-1.25">-1.25</option>
                                                <option value="-1.50">-1.50</option>
                                                <option value="-1.75">-1.75</option>
                                                <option value="-2.00">-2.00</option>
                                                <option value="-2.25">-2.25</option>
                                                <option value="-2.50">-2.50</option>
                                                <option value="-2.75">-2.75</option>
                                                <option value="-3.00">-3.00</option>
                                                <option value="-3.25">-3.25</option>
                                                <option value="-3.50">-3.50</option>
                                                <option value="-3.75">-3.75</option>
                                                <option value="-4.00">-4.00</option>
                                                <option value="-4.25">-4.25</option>
                                                <option value="-4.50">-4.50</option>
                                                <option value="-4.75">-4.75</option>
                                                <option value="-5.00">-5.00</option>
                                                <option value="-5.25">-5.25</option>
                                                <option value="-5.50">-5.50</option>
                                                <option value="-5.75">-5.75</option>
                                                <option value="-6.00">-6.00</option>
                                                <option value="-6.25">-6.25</option>
                                                <option value="-6.50">-6.50</option>
                                                <option value="-6.75">-6.75</option>
                                                <option value="-7.00">-7.00</option>
                                                <option value="-7.25">-7.25</option>
                                                <option value="-7.50">-7.50</option>
                                                <option value="-7.75">-7.75</option>
                                                <option value="-8.00">-8.00</option>
                                                <option value="-8.25">-8.25</option>
                                                <option value="-8.50">-8.50</option>
                                                <option value="-8.75">-8.75</option>
                                                <option value="-9.00">-9.00</option>
                                                <option value="-9.25">-9.25</option>
                                                <option value="-9.50">-9.50</option>
                                                <option value="-9.75">-9.75</option>
                                                <option value="-10.00">-10.00</option>
                                                <option value="-10.25">-10.25</option>
                                                <option value="-10.50">-10.50</option>
                                                <option value="-10.75">-10.75</option>
                                                <option value="-11.00">-11.00</option>
                                                <option value="-11.25">-11.25</option>
                                                <option value="-11.50">-11.50</option>
                                                <option value="-11.75">-11.75</option>
                                                <option value="-12.00">-12.00</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_cylindre">
                                                <option value="0.00">0.00</option>
                                                <option value="+0.25">+0.25</option>
                                                <option value="+0.50">+0.50</option>
                                                <option value="+0.75">+0.75</option>
                                                <option value="+1.00">+1.00</option>
                                                <option value="+1.25">+1.25</option>
                                                <option value="+1.5">+1.5</option>
                                                <option value="+1.75">+1.75</option>
                                                <option value="+2.00">+2.00</option>
                                                <option value="+2.25">+2.25</option>
                                                <option value="+2.50">+2.50</option>
                                                <option value="+2.75">+2.75</option>
                                                <option value="+3.00">+3.00</option>
                                                <option value="+3.25">+3.25</option>
                                                <option value="+3.50">+3.50</option>
                                                <option value="+3.75">+3.75</option>
                                                <option value="+4.00">+4.00</option>
                                                <option value="+4.25">+4.25</option>
                                                <option value="+4.50">+4.50</option>
                                                <option value="+4.75">+4.75</option>
                                                <option value="+5.00">+5.00</option>
                                                <option value="+5.25">+5.25</option>
                                                <option value="+5.50">+5.50</option>
                                                <option value="+5.75">+5.75</option>
                                                <option value="+6.00">+6.00</option>
                                                <option value="+6.25">+6.25</option>
                                                <option value="+6.50">+6.50</option>
                                                <option value="+6.75">+6.75</option>
                                                <option value="+7.00">+7.00</option>
                                                <option value="+7.25">+7.25</option>
                                                <option value="+7.50">+7.50</option>
                                                <option value="+7.75">+7.75</option>
                                                <option value="+8,00">+8,00</option>
                                                <option value="+8.25">+8.25</option>
                                                <option value="+8.50">+8.50</option>
                                                <option value="+8.75">+8.75</option>
                                                <option value="+9.00">+9.00</option>
                                                <option value="+9.25">+9.25</option>
                                                <option value="+9.50">+9.50</option>
                                                <option value="+9.75">+9.75</option>
                                                <option value="+10,00">+10,00</option>
                                                <option value="+10.25">+10.25</option>
                                                <option value="+10.5">+10.5</option>
                                                <option value="+10.75">+10.75</option>
                                                <option value="+11,00">+11,00</option>
                                                <option value="+11.25">+11.25</option>
                                                <option value="+11.50">+11.50</option>
                                                <option value="+11.75">+11.75</option>
                                                <option value="+12,00">+12,00</option>
                                                <option value="-0.25">-0.25</option>
                                                <option value="-0.50">-0.50</option>
                                                <option value="-0.75">-0.75</option>
                                                <option value="-1.00">-1.00</option>
                                                <option value="-1.25">-1.25</option>
                                                <option value="-1.50">-1.50</option>
                                                <option value="-1.75">-1.75</option>
                                                <option value="-2.00">-2.00</option>
                                                <option value="-2.25">-2.25</option>
                                                <option value="-2.50">-2.50</option>
                                                <option value="-2.75">-2.75</option>
                                                <option value="-3.00">-3.00</option>
                                                <option value="-3.25">-3.25</option>
                                                <option value="-3.50">-3.50</option>
                                                <option value="-3.75">-3.75</option>
                                                <option value="-4.00">-4.00</option>
                                                <option value="-4.25">-4.25</option>
                                                <option value="-4.50">-4.50</option>
                                                <option value="-4.75">-4.75</option>
                                                <option value="-5.00">-5.00</option>
                                                <option value="-5.25">-5.25</option>
                                                <option value="-5.50">-5.50</option>
                                                <option value="-5.75">-5.75</option>
                                                <option value="-6.00">-6.00</option>
                                                <option value="-6.25">-6.25</option>
                                                <option value="-6.50">-6.50</option>
                                                <option value="-6.75">-6.75</option>
                                                <option value="-7.00">-7.00</option>
                                                <option value="-7.25">-7.25</option>
                                                <option value="-7.50">-7.50</option>
                                                <option value="-7.75">-7.75</option>
                                                <option value="-8.00">-8.00</option>
                                                <option value="-8.25">-8.25</option>
                                                <option value="-8.50">-8.50</option>
                                                <option value="-8.75">-8.75</option>
                                                <option value="-9.00">-9.00</option>
                                                <option value="-9.25">-9.25</option>
                                                <option value="-9.50">-9.50</option>
                                                <option value="-9.75">-9.75</option>
                                                <option value="-10.00">-10.00</option>
                                                <option value="-10.25">-10.25</option>
                                                <option value="-10.50">-10.50</option>
                                                <option value="-10.75">-10.75</option>
                                                <option value="-11.00">-11.00</option>
                                                <option value="-11.25">-11.25</option>
                                                <option value="-11.50">-11.50</option>
                                                <option value="-11.75">-11.75</option>
                                                <option value="-12.00">-12.00</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_axe">
                                                <option value="0¬∞">0¬∞</option>
                                                <option value="5¬∞">5¬∞</option>
                                                <option value="10¬∞">10¬∞</option>
                                                <option value="15¬∞">15¬∞</option>
                                                <option value="20¬∞">20¬∞</option>
                                                <option value="25¬∞">25¬∞</option>
                                                <option value="30¬∞">30¬∞</option>
                                                <option value="35¬∞">35¬∞</option>
                                                <option value="40¬∞">40¬∞</option>
                                                <option value="45¬∞">45¬∞</option>
                                                <option value="50¬∞">50¬∞</option>
                                                <option value="55¬∞">55¬∞</option>
                                                <option value="60¬∞">60¬∞</option>
                                                <option value="65¬∞">65¬∞</option>
                                                <option value="70¬∞">70¬∞</option>
                                                <option value="75¬∞">75¬∞</option>
                                                <option value="80¬∞">80¬∞</option>
                                                <option value="85¬∞">85¬∞</option>
                                                <option value="90¬∞">90¬∞</option>
                                                <option value="95¬∞">95¬∞</option>
                                                <option value="100¬∞">100¬∞</option>
                                                <option value="105¬∞">105¬∞</option>
                                                <option value="110¬∞">110¬∞</option>
                                                <option value="115¬∞">115¬∞</option>
                                                <option value="120¬∞">120¬∞</option>
                                                <option value="125¬∞">125¬∞</option>
                                                <option value="130¬∞">130¬∞</option>
                                                <option value="135¬∞">135¬∞</option>
                                                <option value="140¬∞">140¬∞</option>
                                                <option value="145¬∞">145¬∞</option>
                                                <option value="150¬∞">150¬∞</option>
                                                <option value="155¬∞">155¬∞</option>
                                                <option value="160¬∞">160¬∞</option>
                                                <option value="165¬∞">165¬∞</option>
                                                <option value="170¬∞">170¬∞</option>
                                                <option value="175¬∞">175¬∞</option>
                                                <option value="180¬∞">180¬∞</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_add">
                                                <option value="0.00">0.00</option>
                                                    <option value="+0.50">+0.50</option>
                                                    <option value="+0.75">+0.75</option>
                                                    <option value="+1.00">+1.00</option>
                                                    <option value="+1.25">+1.25</option>
                                                    <option value="+1.50">+1.50</option>
                                                    <option value="+1.75">+1.75</option>
                                                    <option value="+2.00">+2.00</option>
                                                    <option value="+2.25">+2.25</option>
                                                    <option value="+2.50">+2.50</option>
                                                    <option value="+2.75">+2.75</option>
                                                    <option value="+3.00">+3.00</option>
                                                    <option value="+3.25">+3.25</option>
                                                    <option value="+3.50">+3.50</option>
                                                    <option value="+3.75">+3.75</option>
                                                    <option value="+4.00">+4.00</option>
                                            </select>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-row" style="margin-top: 1rem;">
                            <div class="form-group">
                                <label for="date_soin">Date de soin</label>
                                <input type="date" name="date_soin" id="date_soin" />
                            </div>
                        </div>
                        
                        <div class="form-navigation">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="1">
                                <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                            </button>
                            <button type="button" class="btn btn-primary next-step" data-next="4">
                                Suivant <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 4: Payment -->
                    <div class="form-section" id="section4">
                        <h2 class="section-title">D√âTAILS DE PAIEMENT</h2>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="required-field">Montant Monture (FCFA)</label>
                                <input type="number" name="montant_monture" id="montant_monture" required oninput="calculerTotalPro()" />
                            </div>
                            
                            <div class="form-group">
                                <label class="required-field">Montant Verres (FCFA)</label>
                                <input type="number" name="montant_verres" id="montant_verres" required oninput="calculerTotalPro()" />
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Total Brut (FCFA)</label>
                                <input type="number" name="total_brut" id="total_brut" readonly />
                            </div>
                            
                            <div class="form-group">
                                <label>Remise</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" name="remise" id="remise" value="0" oninput="calculerTotalPro()" style="flex: 2;" />
                                    <select name="remise_type" id="remise_type" onchange="calculerTotalPro()" style="flex: 1;">
                                        <option value="FCFA">FCFA</option>
                                        <option value="%">%</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Net √† payer (FCFA)</label>
                                <input type="number" name="net_a_payer" id="net_a_payer" readonly />
                            </div>
                        </div>
                        
                        <div class="form-navigation">
                            <button type="button" class="btn btn-secondary prev-step" data-prev="2">
                                <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save and Print
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
    <div class="loader-overlay" id="loaderOverlay">
    <div class="loader-content">
        <div class="loader-spinner"></div>
        <div class="loader-text">Chargement du formulaire...</div>
    </div>
</div>
<div id="submitLoader" class="submit-loader">
    <div class="submit-loader-content">
        <div class="submit-spinner"></div>
        <div class="submit-message">Enregistrement en cours</div>
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
   
  <script>

function toggleAdminMenu(event) {
    event.preventDefault(); // Emp√™che le lien de suivre #
    
    if (!hasAdminRights()) {
        alert("‚õî Acc√®s refus√©");
        return; // Bloque l'ouverture du menu
    }

    // ‚úÖ Autoris√© ‚Üí toggle le sous-menu
    const menuItem = event.currentTarget.closest('.menu-item');
    const submenu = menuItem.querySelector('.submenu');
    submenu.classList.toggle('open');
}

function openLooker() {
    if (!hasAdminRights()) {
        alert("‚õî Acc√®s refus√©");
        return;
    }

    window.open(
        'https://lookerstudio.google.com/s/osmFEnMBAFs',
        '_blank'
    );
}
    // Fonction combin√©e pour la gestion des menus et l'ouverture de nouvelle vente
    (function() {
        // Gestion des menus d√©roulants
        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', function(e) {
                // Emp√™che le comportement par default si c'est un lien
                if (e.target.href) e.preventDefault();

                const currentItem = this.parentElement;

                // Fermer toutes les autres sections
                document.querySelectorAll('.menu-item').forEach(item => {
                    if (item !== currentItem) item.classList.remove('active');
                });

                // Basculer l'√©tat de la section cliqu√©e
                currentItem.classList.toggle('active');
            });
        });

        // Fonction pour ouvrir Acceuil
        window.openVueGlobale = function() {
            try {
                const salePath = 'Accueil.html';
                window.location.href = salePath;
            } catch (error) {
                console.error("Erreur d'ouverture:", error);
                alert("Impossible d'ouvrir la page. Contactez l'administrateur.");
            }
        };
    })();
// ouvrir le catalogue Verre
window.openCatalogueVerre = function() {
    const pdfPath = 'Catalogue.pdf';
    window.open(pdfPath, '_blank');
};
window.openProductEntryForm = function() {
    const modalContainer = document.getElementById('modal-container');

    const modalHTML = `
        <div class="modal-overlay" id="productModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">Entr√©e de Produit</h3>
                </div>
                <div class="modal-body">
                    <form id="productForm">
        <div class="form-group">
            <label for="productCategory">Cat√©gorie</label>
            <div class="select-with-input">
               <select name="productCategory" id="productCategory" class="form-control" onchange="updateProductFields()">
                                <option value="">-- S√©lectionnez une cat√©gorie --</option>
                                <option value="monture">Monture</option>
                                <option value="etui">Etuis</option>
                                <option value="nettoyant">Nettoyant</option>
                                <option value="autre">Autre</option>
                </select>
                <input type="text" id="productCategory_input" class="form-control" style="display: none; margin-top: 5px;" 
                       placeholder="Ajouter">
            </div>
            <button type="button" class="btn btn-small" onclick="toggleInput('productCategory')" 
                    style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                <i class="fas fa-plus"></i> Ajouter
            </button>
        </div>
                        <div id="dynamicFields"></div>
                        
                        <div class="form-group">
                            <label for="productQuantity">Quantit√© <span class="required">*</span></label>
                            <input type="number" id="productQuantity" class="form-control" min="1" required>
                        </div>
                        
                        <div id="product-message" class="form-message"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="submitProductForm()">Enregistrer</button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('productModal').classList.add('active');
    }, 10);
};

// Fonction pour charger les fournisseurs depuis l'API
async function loadFournisseurs(selectId) {
    const supplierSelect = document.getElementById(selectId);
    const loadingIndicator = document.getElementById(`loading-${selectId}`);
    const addSupplierBtn = document.getElementById(`addBtn-${selectId}`);
    
    try {
        if (loadingIndicator) loadingIndicator.style.display = 'inline-block';
        if (addSupplierBtn) addSupplierBtn.style.display = 'none';
        supplierSelect.disabled = true;
        supplierSelect.innerHTML = '<option value="">-- Chargement en cours --</option>';
        
        const apiUrl = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=catalogue';
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error('Erreur de chargement des fournisseurs');
        
        const data = await response.json();
        
        if (data.success && data.data.fournisseur) {
            supplierSelect.innerHTML = '<option value="">-- S√©lectionnez un fournisseur --</option>';
            
            data.data.fournisseur.sort().forEach(fournisseur => {
                const option = document.createElement('option');
                option.value = fournisseur;
                option.textContent = fournisseur;
                supplierSelect.appendChild(option);
            });
            
            // Ajouter l'option pour nouveau fournisseur
            const newOption = document.createElement('option');
            newOption.value = 'new';
            newOption.textContent = '+ Ajouter un nouveau fournisseur';
            supplierSelect.appendChild(newOption);
        }
    } catch (error) {
        console.error('Erreur chargement fournisseurs:', error);
        supplierSelect.innerHTML = '<option value="">-- Erreur de chargement --</option>';
    } finally {
        supplierSelect.disabled = false;
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        if (addSupplierBtn) addSupplierBtn.style.display = 'block';
    }
}

// Fonction pour afficher/masquer le champ de nouveau fournisseur
function toggleNewSupplierField(selectId) {
    const supplierSelect = document.getElementById(selectId);
    const newSupplierField = document.getElementById(`newField-${selectId}`);
    const addSupplierBtn = document.getElementById(`addBtn-${selectId}`);
    
    if (supplierSelect.value === 'new') {
        newSupplierField.style.display = 'block';
        addSupplierBtn.style.display = 'none';
    } else {
        newSupplierField.style.display = 'none';
        addSupplierBtn.style.display = 'block';
    }
}

// Fonction pour ajouter un nouveau fournisseur √† la liste
function addNewSupplier(selectId) {
    const newSupplierInput = document.getElementById(`newName-${selectId}`);
    const newSupplierName = newSupplierInput.value.trim();
    
    if (!newSupplierName) {
        alert('Veuillez saisir un nom de fournisseur');
        return;
    }
    
    const supplierSelect = document.getElementById(selectId);
    const newSupplierField = document.getElementById(`newField-${selectId}`);
    const addSupplierBtn = document.getElementById(`addBtn-${selectId}`);
    
    // Ajouter le nouveau fournisseur √† la liste
    const newOption = document.createElement('option');
    newOption.value = newSupplierName;
    newOption.textContent = newSupplierName;
    newOption.selected = true;
    
    // Ins√©rer avant l'option "Ajouter nouveau"
    const addNewOption = supplierSelect.querySelector('option[value="new"]');
    supplierSelect.insertBefore(newOption, addNewOption);
    
    // Masquer le champ et r√©afficher le bouton
    newSupplierField.style.display = 'none';
    addSupplierBtn.style.display = 'block';
    newSupplierInput.value = '';
}

// Fonction pour mettre √† jour les champs en fonction de la cat√©gorie s√©lectionn√©e
function updateProductFields() {
    const category = document.getElementById('productCategory').value;
    const dynamicFields = document.getElementById('dynamicFields');
    
    let fieldsHTML = '';
    
    switch(category) {
        case 'monture':
            fieldsHTML = `
                <div class="form-group">
                    <label for="montureReference">R√©f√©rence Monture <span class="required">*</span></label>
                    <input type="text" id="montureReference" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="montureColor">Prix de vente <span class="required">*</span></label>
                    <input type="text" id="montureColor" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="montureSupplier">Fournisseur <span class="required">*</span></label>
                    <div style="position: relative;">
                        <select id="montureSupplier" class="form-control" required onchange="toggleNewSupplierField('montureSupplier')">
                            <option value="">-- Chargement des fournisseurs --</option>
                        </select>
                        <span id="loading-montureSupplier" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <div id="newField-montureSupplier" style="display: none; margin-top: 5px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newName-montureSupplier" class="form-control" placeholder="Nom du nouveau fournisseur">
                            <button type="button" class="btn btn-success" onclick="addNewSupplier('montureSupplier')" style="white-space: nowrap;">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addBtn-montureSupplier" class="btn btn-small" onclick="document.getElementById('montureSupplier').value = 'new'; toggleNewSupplierField('montureSupplier');" 
                            style="margin-top: 5px; padding: 0.25rem 0.5rem; display: none;">
                        <i class="fas fa-plus"></i> Nouveau fournisseur
                    </button>
                </div>
            `;
            
            // Charger les fournisseurs apr√®s l'insertion du HTML
            setTimeout(() => {
                loadFournisseurs('montureSupplier');
            }, 100);
            break;
            
        case 'etui':
            fieldsHTML = `
                <div class="form-group">
                    <label for="etuiReference">R√©f√©rence <span class="required">*</span></label>
                    <input type="text" id="etuiReference" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="etuiSupplier">Fournisseur <span class="required">*</span></label>
                    <div style="position: relative;">
                        <select id="etuiSupplier" class="form-control" required onchange="toggleNewSupplierField('etuiSupplier')">
                            <option value="">-- Chargement des fournisseurs --</option>
                        </select>
                        <span id="loading-etuiSupplier" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <div id="newField-etuiSupplier" style="display: none; margin-top: 5px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newName-etuiSupplier" class="form-control" placeholder="Nom du nouveau fournisseur">
                            <button type="button" class="btn btn-success" onclick="addNewSupplier('etuiSupplier')" style="white-space: nowrap;">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addBtn-etuiSupplier" class="btn btn-small" onclick="document.getElementById('etuiSupplier').value = 'new'; toggleNewSupplierField('etuiSupplier');" 
                            style="margin-top: 5px; padding: 0.25rem 0.5rem; display: none;">
                        <i class="fas fa-plus"></i> Nouveau fournisseur
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                loadFournisseurs('etuiSupplier');
            }, 100);
            break;
            
        case 'nettoyant':
            fieldsHTML = `
                <div class="form-group">
                    <label for="nettoyantSupplier">Fournisseur <span class="required">*</span></label>
                    <div style="position: relative;">
                        <select id="nettoyantSupplier" class="form-control" required onchange="toggleNewSupplierField('nettoyantSupplier')">
                            <option value="">-- Chargement des fournisseurs --</option>
                        </select>
                        <span id="loading-nettoyantSupplier" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <div id="newField-nettoyantSupplier" style="display: none; margin-top: 5px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newName-nettoyantSupplier" class="form-control" placeholder="Nom du nouveau fournisseur">
                            <button type="button" class="btn btn-success" onclick="addNewSupplier('nettoyantSupplier')" style="white-space: nowrap;">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addBtn-nettoyantSupplier" class="btn btn-small" onclick="document.getElementById('nettoyantSupplier').value = 'new'; toggleNewSupplierField('nettoyantSupplier');" 
                            style="margin-top: 5px; padding: 0.25rem 0.5rem; display: none;">
                        <i class="fas fa-plus"></i> Nouveau fournisseur
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                loadFournisseurs('nettoyantSupplier');
            }, 100);
            break;
            
        case 'autre':
            fieldsHTML = `
                <div class="form-group">
                    <label for="autreReference">R√©f√©rence</label>
                    <input type="text" id="autreReference" class="form-control">
                </div>
                <div class="form-group">
                    <label for="autreSupplier">Fournisseur</label>
                    <div style="position: relative;">
                        <select id="autreSupplier" class="form-control" onchange="toggleNewSupplierField('autreSupplier')">
                            <option value="">-- Chargement des fournisseurs --</option>
                        </select>
                        <span id="loading-autreSupplier" class="loading-indicator" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </div>
                    <div id="newField-autreSupplier" style="display: none; margin-top: 5px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newName-autreSupplier" class="form-control" placeholder="Nom du nouveau fournisseur">
                            <button type="button" class="btn btn-success" onclick="addNewSupplier('autreSupplier')" style="white-space: nowrap;">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addBtn-autreSupplier" class="btn btn-small" onclick="document.getElementById('autreSupplier').value = 'new'; toggleNewSupplierField('autreSupplier');" 
                            style="margin-top: 5px; padding: 0.25rem 0.5rem; display: none;">
                        <i class="fas fa-plus"></i> Nouveau fournisseur
                    </button>
                </div>
                <div class="form-group">
                    <label for="autreInfo">Informations utiles</label>
                    <textarea id="autreInfo" class="form-control" rows="2"></textarea>
                </div>
            `;
            
            setTimeout(() => {
                loadFournisseurs('autreSupplier');
            }, 100);
            break;
            
        default:
            fieldsHTML = '';
    }
    
    dynamicFields.innerHTML = fieldsHTML;
}

// Fonction pour soumettre le formulaire de produit
async function submitProductForm() {
    const form = document.getElementById('productForm');
    const formMessage = document.getElementById('product-message');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires.';
        formMessage.classList.add('error');
        return;
    }

    const category = document.getElementById('productCategory').value;
    const quantity = document.getElementById('productQuantity').value;
    
    let productData = {
        category: category,
        quantity: quantity,
        isNewSupplier: false,
        newSupplierName: ''
    };

    // Fonction pour g√©rer le fournisseur (nouveau ou existant)
    function handleSupplier(selectId) {
        const supplierSelect = document.getElementById(selectId);
        if (supplierSelect.value === 'new') {
            productData.isNewSupplier = true;
            productData.newSupplierName = document.getElementById(`newName-${selectId}`).value.trim();
            return productData.newSupplierName;
        } else {
            return supplierSelect.value;
        }
    }

    // Ajouter les champs sp√©cifiques √† la cat√©gorie
    switch(category) {
        case 'monture':
            productData.reference = document.getElementById('montureReference').value;
            productData.color = document.getElementById('montureColor').value;
            productData.supplier = handleSupplier('montureSupplier');
            break;
            
        case 'etui':
            productData.reference = document.getElementById('etuiReference').value;
            productData.supplier = handleSupplier('etuiSupplier');
            break;
            
        case 'nettoyant':
            productData.supplier = handleSupplier('nettoyantSupplier');
            break;
            
        case 'autre':
            productData.reference = document.getElementById('autreReference').value;
            productData.supplier = handleSupplier('autreSupplier');
            productData.info = document.getElementById('autreInfo').value;
            break;
    }

    const submitButton = document.querySelector('#productModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addProduct";

        await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productData)
        });

        formMessage.textContent = '‚úÖ Produit enregistr√© avec succ√®s!';
        formMessage.classList.add('success');

        form.reset();
        document.getElementById('dynamicFields').innerHTML = '';

        setTimeout(() => {
            closeModal();
        }, 1500);

    } catch (error) {
        console.error("Erreur:", error);
        formMessage.innerHTML = `‚ùå ${error.message || "Une erreur est survenue lors de l'enregistrement"}`;
        formMessage.classList.add('error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';
    }
}


// Fonction pour v√©rifier les droits d'administration
function hasAdminRights() {
    // R√©cup√®re l'utilisateur actuel depuis sessionStorage ou localStorage
    const currentUser = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");
    
    // Liste des utilisateurs autoris√©s
    const adminUsers = ["Admin","Dosso"];
    
    // V√©rifie si l'utilisateur actuel fait partie de la liste
    return adminUsers.includes(currentUser);
}

// Fonction prot√©g√©e pour ajouter un utilisateur
window.openAddUserForm = function() {
    if (!hasAdminRights()) {
        alert("‚õî Acc√®s refus√©");
        return;
    }

    const modalContainer = document.getElementById('modal-container');

    const modalHTML = `
        <div class="modal-overlay" id="addUserModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Ajouter un Utilisateur</h3>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="userUsername">Username <span class="required">*</span></label>
                            <input type="text" id="userUsername" class="form-control" placeholder="Nom d'utilisateur" required>
                        </div>
                        <div class="form-group">
                            <label for="userPassword">Password <span class="required">*</span></label>
                            <input type="password" id="userPassword" class="form-control" placeholder="Mot de passe" required>
                        </div>
                        <div id="user-message" class="form-message"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddUserForm()">Enregistrer</button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('addUserModal').classList.add('active');
    }, 10);
};

// Fonction pour soumettre le formulaire d'utilisateur
async function submitAddUserForm() {
    const form = document.getElementById('addUserForm');
    const formMessage = document.getElementById('user-message');
    const passwordInput = document.getElementById('userPassword');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    // Validation de base du formulaire
    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires.';
        formMessage.classList.add('error');
        return;
    }

    // Validation sp√©cifique du mot de passe
    const password = passwordInput.value.trim();
    const passwordRegex = /^[A-Z][a-zA-Z]{1}\d{2}$/; // 1 majuscule + 1 lettre + 2 chiffres
    
    if (!passwordRegex.test(password)) {
        formMessage.textContent = '‚ùå Le mot de passe doit :\n- Commencer par une majuscule\n- Contenir 2 lettres et 2 chiffres\n- Faire exactement 4 caract√®res\n- Ne pas commencer par 0';
        formMessage.classList.add('error');
        passwordInput.focus();
        return;
    }

    const userData = {
        username: document.getElementById('userUsername').value.trim(),
        password: password
    };

    const submitButton = document.querySelector('#addUserModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=adduser";

        await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        });

        formMessage.textContent = '‚úÖ Utilisateur enregistr√© avec succ√®s!';
        formMessage.classList.add('success');

        form.reset();
        setTimeout(() => {
            closeModal();
        }, 1500);


    } catch (error) {
        console.error("Erreur:", error);
        formMessage.innerHTML = `‚ùå ${error.message || "Une erreur est survenue lors de l'enregistrement"}`;
        formMessage.classList.add('error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';
    }
}
    window.openEntreesJournal = function() {
        const modalContainer = document.getElementById('modal-container');
const modalHTML = `
    <div class="modal-overlay" id="journalModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-invoice-dollar"></i> Journal des Entr√©es</h3>
            </div>
            <div class="modal-body">
                <div class="filters-card">
                    <div class="filters-container">
                        
                        <div class="filter-item">
                            <label><i class="fas fa-building"></i> Agence</label>
                            <select id="filterAgence" class="form-control">
                                <option value="">Toutes les agences</option>
                            </select>
                        </div>
                         <div class="filter-item">
                            <label><i class="fas fa-user"></i> Client</label>
                            <input type="text" id="searchClient" class="form-control" placeholder="Rechercher un client">
                        </div>
                        <div class="filter-item">
                            <label><i class="fas fa-calendar-alt"></i> P√©riode</label>
                            <div class="date-range">
                                <input type="date" id="filterDateStart" class="form-control">
                                <span>√†</span>
                                <input type="date" id="filterDateEnd" class="form-control">
                            </div>
                        </div>

                        <div class="filter-item">
                            <button class="btn btn-outline-secondary" onclick="resetEntreesFilter()">
                                <i class="fas fa-undo"></i> R√©initialiser
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-responsive">
                        <table class="entrees-table" id="entreesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>ID Client</th>
                                    <th class="text-right">Montant</th>
                                    <th>Cat√©gorie</th>
                                    <th>Agence</th>
                                </tr>
                            </thead>
                            <tbody id="entreesData">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="entrees-message" class="alert alert-info mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="printEntrees()">
                    <i class="fas fa-print"></i> Imprimer
                </button>
                <button type="button" class="btn btn-close-modal" onclick="closeModal()">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
        </div>
    </div>
`;


        modalContainer.innerHTML = modalHTML;

        setTimeout(() => {
            document.getElementById('journalModal').classList.add('active');
            loadEntreesData();
        }, 10);
    };

    // Variables globales
    let allEntreesData = [];
    let uniqueAgences = [];

    // Chargement des donn√©es
    async function loadEntreesData() {
        const entreesData = document.getElementById('entreesData');
        const messageDiv = document.getElementById('entrees-message');

        entreesData.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>`;
        messageDiv.style.display = 'none';

        try {
            const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=entree`;
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

            const responseData = await response.json();
            if (!responseData?.data?.rows) throw new Error('Structure de donn√©es invalide');

            const headers = responseData.data.headers;
            allEntreesData = responseData.data.rows.map(row => ({
                Date: row[headers.indexOf('Date')] ? new Date(row[headers.indexOf('Date')]) : null,
                Client: row[headers.indexOf('Nom du client')] || '',
                ClientID: row[headers.indexOf('ID du client')] || '',
                Montant: parseFloat(row[headers.indexOf('Montant pay√©')]) || 0,
                Categorie: row[headers.indexOf('Cat√©gorie')] || '',
                Agence: row[headers.indexOf('Agence')] || ''
            }));

            uniqueAgences = [...new Set(allEntreesData.map(item => item.Agence).filter(Boolean))];
            populateAgenceFilter();
            setupAutoFilters();
            displayFilteredEntrees(allEntreesData);

        } catch (error) {
            console.error('[Entr√©es] Erreur:', error);
            showEntreesMessage(`‚ùå Erreur: ${error.message || 'Chargement √©chou√©'}`, 'danger');
            entreesData.innerHTML = '<tr><td colspan="6" class="text-center">Erreur de chargement</td></tr>';
        }
    }

    function populateAgenceFilter() {
        const agenceSelect = document.getElementById('filterAgence');
        agenceSelect.innerHTML = '<option value="">Toutes les agences</option>';
        uniqueAgences.forEach(agence => {
            const option = document.createElement('option');
            option.value = agence;
            option.textContent = agence;
            agenceSelect.appendChild(option);
        });
    }

    // Ajout des events pour rendre les filtres automatiques
    function setupAutoFilters() {
        document.getElementById('filterDateStart').addEventListener('input', applyEntreesFilter);
        document.getElementById('filterDateEnd').addEventListener('input', applyEntreesFilter);
        document.getElementById('filterAgence').addEventListener('change', applyEntreesFilter);
        document.getElementById('searchClient').addEventListener('input', applyEntreesFilter);
    }

    function displayFilteredEntrees(data) {
        const entreesData = document.getElementById('entreesData');
        if (!data?.length) {
            entreesData.innerHTML = '<tr><td colspan="6" class="text-center">Aucune donn√©e disponible</td></tr>';
            return;
        }
        const html = data.map(item => {
            const dateFormatted = item.Date?.toLocaleDateString('fr-FR') || 'N/A';
            const montantFormatted = item.Montant.toLocaleString('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return `
                <tr>
                    <td>${dateFormatted}</td>
                    <td>${item.Client}</td>
                    <td>${item.ClientID}</td>
                    <td class="text-right">${montantFormatted}</td>
                    <td><span class="badge bg-primary">${item.Categorie}</span></td>
                    <td>${item.Agence}</td>
                </tr>
            `;
        }).join('');
        entreesData.innerHTML = html;
    }

    function applyEntreesFilter() {
        const startDate = document.getElementById('filterDateStart').value;
        const endDate = document.getElementById('filterDateEnd').value;
        const selectedAgence = document.getElementById('filterAgence').value;
        const searchClient = document.getElementById('searchClient').value.toLowerCase();

        let filteredData = [...allEntreesData];

        if (startDate || endDate) {
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            filteredData = filteredData.filter(item => {
                if (!item.Date) return false;
                const d = item.Date;
                if (start && end) return d >= start && d <= end;
                if (start) return d >= start;
                if (end) return d <= end;
                return true;
            });
        }

        if (selectedAgence) {
            filteredData = filteredData.filter(item => item.Agence === selectedAgence);
        }

        if (searchClient) {
            filteredData = filteredData.filter(item =>
                item.Client.toLowerCase().includes(searchClient)
            );
        }

        displayFilteredEntrees(filteredData);
        //showEntreesMessage(`${filteredData.length} entr√©es trouv√©es`, 'info');
    }

    function resetEntreesFilter() {
        document.getElementById('filterDateStart').value = '';
        document.getElementById('filterDateEnd').value = '';
        document.getElementById('filterAgence').value = '';
        document.getElementById('searchClient').value = '';
        displayFilteredEntrees(allEntreesData);
        showEntreesMessage(`‚Üª Affichage de toutes les ${allEntreesData.length} entr√©es`, 'info');
    }

    function showEntreesMessage(message, type) {
        const messageDiv = document.getElementById('entrees-message');
        messageDiv.textContent = message;
        messageDiv.className = `alert alert-${type}`;
        messageDiv.style.display = 'block';
    }
    // Impression (prend en compte les filtres actuels)
    function printEntrees() {
        try {
            const printWindow = window.open('', '_blank');
            const printContent = document.getElementById('entreesTable').cloneNode(true);

            let total = 0;
            const rows = printContent.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const amountCell = row.cells[3]?.textContent;
                if (amountCell) {
                    const amount = parseFloat(amountCell.replace(/[^\d,.-]/g, '').replace(',', '.'));
                    if (!isNaN(amount)) total += amount;
                }
            });

            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="3" class="text-right"><strong>Total</strong></td>
                <td class="text-right"><strong>${total.toLocaleString('fr-FR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}</strong></td>
                <td colspan="2"></td>
            `;
            printContent.querySelector('tbody').appendChild(totalRow);

            const styles = `
                <style>
                    body { font-family: Arial, sans-serif; margin: 15px; }
                    h1 { color: #333; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    .text-right { text-align: right; }
                    .total-row { font-weight: bold; background-color: #f8f9fa; }
                    .badge { padding: 3px 6px; border-radius: 3px; font-size: 12px; }
                    @page { size: auto; margin: 10mm; }
                </style>
            `;

            const dateStart = document.getElementById('filterDateStart').value;
            const dateEnd = document.getElementById('filterDateEnd').value;
            let periodInfo = '';
            if (dateStart || dateEnd) {
                periodInfo = `P√©riode : ${dateStart ? new Date(dateStart).toLocaleDateString('fr-FR') : 'D√©but'} √† ${dateEnd ? new Date(dateEnd).toLocaleDateString('fr-FR') : 'Aujourd\'hui'}`;
            }

            const agence = document.getElementById('filterAgence').value;
            const client = document.getElementById('searchClient').value;
            const filtersInfo = `
                ${periodInfo ? `<p>${periodInfo}</p>` : ''}
                ${agence ? `<p>Agence : ${agence}</p>` : ''}
                ${client ? `<p>Client : ${client}</p>` : ''}
            `;

            printWindow.document.write(`
                <html>
                    <head>
                        <title>Journal des Entr√©es</title>
                        ${styles}
                    </head>
                    <body>
                        <h1>Journal des Entr√©es</h1>
                        ${filtersInfo}
                        <p>Imprim√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                        ${printContent.outerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
printWindow.onload = function () {
        printWindow.focus();
        printWindow.print();
        printWindow.close()
};
        
        } catch (error) {
            console.error('Erreur d\'impression:', error);
            alert("Une erreur est survenue lors de l'impression");
        }
    }

// =========================
// üîπ Fonction principale
// =========================
window.openCaisse = function(action, title) {
    const modalContainer = document.getElementById('modal-container');
    const tableId = `caisseTable-${action}`;
    const dataId = `caisseData-${action}`;
    const totalsId = `caisseTotals-${action}`;
    const startId = `start-${action}`;
    const endId = `end-${action}`;
    const messageId = `message-${action}`;
    const currentCaisseId = `currentCaisse-${action}`; // Nouvel ID pour la valeur En Caisse

    modalContainer.innerHTML = `
        <div class="modal-overlay" id="modal-${action}">
            <div class="modal-content" style="max-width: 1200px;">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-cash-register"></i> Caisse ${title}</h3>
                </div>
                <div class="modal-body">
                    <div class="filters-card">
                        <div class="filters-container">
                            <div class="filter-item">
                                <label><i class="fas fa-calendar-alt"></i> P√©riode</label>
                                <div class="date-range">
                                    <input type="date" id="${startId}" class="form-control">
                                    <span>√†</span>
                                    <input type="date" id="${endId}" class="form-control">
                                </div>
                            </div>
                            <div class="filter-item">
                                <button class="btn btn-outline-secondary" onclick="resetCaisse('${action}')">
                                    <i class="fas fa-undo"></i> R√©initialiser
                                </button>
                            </div>
                            
                            <div class="filter-item caisse-summary-item">
                                <label>En Caisse :</label>
                                <strong id="${currentCaisseId}" class="caisse-value-display">--</strong>
                            </div>
                            </div>
                    </div>

                    <div class="table-card">
                        <div class="table-responsive">
                            <table class="caisse-table" id="${tableId}">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th class="text-right">Acompte</th>
                                        <th class="text-right">Compl√©ments</th>
                                        <th class="text-right">D√©pense</th>
                                        <th class="text-right">En Caisse</th>
                                    </tr>
                                </thead>
                                <tbody id="${dataId}">
                                    <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                                <tfoot id="${totalsId}"></tfoot>
                            </table>
                        </div>
                        <div id="${messageId}" class="alert alert-info mt-3" style="display:none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="printCaisse('${action}', '${title}')">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-close-modal" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    setTimeout(() => {
        document.getElementById(`modal-${action}`).classList.add('active');

        loadCaisse(action); 
    }, 10);
};

// =========================
// üîπ Variables globales
// =========================
const caisseDataStore = {}; // Stocke toutes les donn√©es par action (caisse1, caisse2, etc.)

// =========================
// üîπ Chargement des donn√©es
// =========================
async function loadCaisse(action) {
    const dataId = `caisseData-${action}`;
    const messageId = `message-${action}`;
    const currentCaisseId = `currentCaisse-${action}`; // Utiliser le bon ID
    
    const tableBody = document.getElementById(dataId);
    const messageDiv = document.getElementById(messageId);
    const currentCaisseDiv = document.getElementById(currentCaisseId); // R√©cup√©rer l'√©l√©ment correct

    tableBody.innerHTML = `<tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>`;
    messageDiv.style.display = 'none';
    if (currentCaisseDiv) {
        currentCaisseDiv.textContent = '--'; // R√©initialiser l'affichage pendant le chargement
    }

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=${action}`;
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const responseData = await response.json();
        if (!responseData?.data?.rows) throw new Error('Structure de donn√©es invalide');

        const headers = responseData.data.headers;
        caisseDataStore[action] = responseData.data.rows.map(row => {
            const dateIndex = headers.findIndex(h => h.toLowerCase().includes('date'));
            const acompteIndex = headers.findIndex(h => h.toLowerCase().includes('acompte'));
            const comp1Index = headers.findIndex(h => h.toLowerCase().includes('compl√©ments') || h.toLowerCase().includes('complements'));
            const depenseIndex = headers.findIndex(h => h.toLowerCase().includes('d√©pense') || h.toLowerCase().includes('depense'));
            const encaisseIndex = headers.findIndex(h => h.toLowerCase().includes('en caisse') || h.toLowerCase().includes('encaisse'));

            return {
                Date: row[dateIndex] ? new Date(row[dateIndex]) : null,
                Acompte: parseFloat(row[acompteIndex]) || 0,
                Complements: parseFloat(row[comp1Index]) || 0,
                Depense: parseFloat(row[depenseIndex]) || 0,
                EnCaisse: parseFloat(row[encaisseIndex]) || 0
            };
        });

        // Trier les donn√©es par date en ordre d√©croissant pour obtenir la derni√®re valeur "En Caisse"
        caisseDataStore[action].sort((a, b) => b.Date - a.Date);

        setupFilters(action);
        displayCaisse(action, caisseDataStore[action]);

        // Trouver et afficher la derni√®re valeur "En Caisse"
        const latestCaisseEntry = caisseDataStore[action][0];
        if (latestCaisseEntry && currentCaisseDiv) {
            currentCaisseDiv.textContent = `${latestCaisseEntry.EnCaisse.toFixed(2)} FCFA`;
        }

    } catch (error) {
        console.error(`[${action}] Erreur:`, error);
        showCaisseMessage(action, `‚ùå Erreur: ${error.message || 'Chargement √©chou√©'}`, 'danger');
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Erreur de chargement</td></tr>';
        if (currentCaisseDiv) {
            currentCaisseDiv.textContent = 'Erreur';
        }
    }
}

// =========================
// üîπ Gestion des filtres
// =========================
function setupFilters(action) {
    const startInput = document.getElementById(`start-${action}`);
    const endInput = document.getElementById(`end-${action}`);
    startInput.addEventListener('input', () => applyCaisseFilter(action));
    endInput.addEventListener('input', () => applyCaisseFilter(action));
}

function applyCaisseFilter(action) {
    const startDate = document.getElementById(`start-${action}`).value;
    const endDate = document.getElementById(`end-${action}`).value;
    const allData = caisseDataStore[action] || [];

    const start = startDate ? new Date(startDate) : null;
    const end = endDate ? new Date(endDate) : null;

    const filteredData = allData.filter(item => {
        if (!item.Date) return false;
        return (!start || item.Date >= start) && (!end || item.Date <= end);
    });

    displayCaisse(action, filteredData);
    showCaisseMessage(action, `${filteredData.length} enregistrements trouv√©s`, 'info');
}

function resetCaisse(action) {
    document.getElementById(`start-${action}`).value = '';
    document.getElementById(`end-${action}`).value = '';
    displayCaisse(action, caisseDataStore[action]);
    showCaisseMessage(action, `‚Üª Affichage de tous les ${caisseDataStore[action].length} enregistrements`, 'info');
}

// =========================
// üîπ Affichage tableau
// =========================
function displayCaisse(action, data) {
    const dataId = `caisseData-${action}`;
    const totalsId = `caisseTotals-${action}`;
    const tableBody = document.getElementById(dataId);
    const tableTotals = document.getElementById(totalsId);

    if (!data?.length) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Aucune donn√©e disponible</td></tr>';
        tableTotals.innerHTML = '';
        return;
    }

    const formatCurrency = val => val.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    const rows = data.map(item => `
        <tr>
            <td>${item.Date?.toLocaleDateString('fr-FR') || 'N/A'}</td>
            <td class="text-right">${formatCurrency(item.Acompte)}</td>
            <td class="text-right">${formatCurrency(item.Complements)}</td>
            <td class="text-right">${formatCurrency(item.Depense)}</td>
            <td class="text-right"><strong>${formatCurrency(item.EnCaisse)}</strong></td>
        </tr>
    `).join('');

    tableBody.innerHTML = rows;

    const totals = data.reduce((acc, i) => {
        acc.Acompte += i.Acompte;
        acc.Comp1 += i.Complements;
        acc.Depense += i.Depense;
        acc.EnCaisse += i.EnCaisse;
        return acc;
    }, { Acompte:0, Comp1:0,  Depense:0, EnCaisse:0 });

    tableTotals.innerHTML = `
        <tr class="total-row">
            <td><strong>Total</strong></td>
            <td class="text-right"><strong>${formatCurrency(totals.Acompte)}</strong></td>
            <td class="text-right"><strong>${formatCurrency(totals.Comp1)}</strong></td>
            <td class="text-right"><strong>${formatCurrency(totals.Depense)}</strong></td>
            <td class="text-right"><strong>${formatCurrency(totals.EnCaisse)}</strong></td>
        </tr>
    `;
}

// =========================
// üîπ Messages
// =========================
function showCaisseMessage(action, message, type) {
    const messageDiv = document.getElementById(`message-${action}`);
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// =========================
// üîπ Impression
// =========================
function printCaisse(action, title) {
    try {
        const table = document.getElementById(`caisseTable-${action}`).cloneNode(true);
        table.querySelectorAll('td.text-right, th.text-right').forEach(cell => {
            cell.style.textAlign = 'right';
        });

        const styles = `
            <style>
                body { font-family: Arial, sans-serif; margin: 15px; }
                h1 { text-align: center; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid #ddd; padding: 8px; }
                th { background-color: #f2f2f2; }
                .text-right { text-align: right; }
                .total-row { font-weight: bold; background-color: #f8f9fa; }
                @page { size: landscape; margin: 10mm; }
            </style>
        `;

        const dateStart = document.getElementById(`start-${action}`).value;
        const dateEnd = document.getElementById(`end-${action}`).value;
        let period = '';
        if (dateStart || dateEnd) {
            period = `P√©riode : ${dateStart ? new Date(dateStart).toLocaleDateString('fr-FR') : 'D√©but'} √† ${dateEnd ? new Date(dateEnd).toLocaleDateString('fr-FR') : "Aujourd'hui"}`;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head><title>Caisse ${title}</title>${styles}</head>
                <body>
                    <h1>Caisse ${title}</h1>
                    ${period ? `<p>${period}</p>` : ''}
                    <p>Imprim√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                    ${table.outerHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
    printWindow.onload = function () {
    printWindow.focus();   // Met la fen√™tre au premier plan
    printWindow.print();   // Lance l'impression
    printWindow.close();   // Ferme la fen√™tre apr√®s impression
};

    } catch (e) {
        alert("Erreur lors de l'impression");
    }
}

// üîπ Variable globale pour stocker les donn√©es
let allDepensesData = [];

// üîπ Ouvrir le journal des d√©penses
window.openDepensesJournal = function() {
  const modalContainer = document.getElementById('modal-container');
  modalContainer.innerHTML = `
    <div class="modal-overlay" id="journalModal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h3 class="modal-title">Journal des D√©penses</h3>
        </div>
        <div class="modal-body">
          <div class="filters mb-4">
            <div class="filter-group">
              <div class="date-filters">
                <div class="date-input-group">
                  <span class="date-icon"><i class="fas fa-calendar-alt"></i></span>
                  <input type="date" id="filterDateStart" class="form-control date-input">
                  <span class="date-separator">au</span>
                  <input type="date" id="filterDateEnd" class="form-control date-input">
                </div>
                <div class="agency-filter">
                  <select id="filterAgency" class="form-control">
                    <option value="">Toutes les agences</option>
                  </select>
                </div>
                <button class="btn btn-reset" onclick="resetFilters()">
                  <i class="fas fa-times"></i> R√©initialiser
                </button>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover" id="depensesTable">
              <thead class="table-header">
                <tr>
                  <th>Date</th>
                  <th>Agence</th>
                  <th>D√©signation</th>
                  <th>Cat√©gorie</th>
                  <th class="text-right">Montant</th>
                </tr>
              </thead>
              <tbody id="depensesData">
                <tr>
                  <td colspan="5" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="sr-only">Chargement...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="depenses-message" class="form-message"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="printDepenses()">
            <i class="fas fa-print"></i> Imprimer
          </button>
          <button type="button" class="btn btn-close-modal" onclick="closeModal()">
            <i class="fas fa-times"></i> Fermer
          </button>
        </div>
      </div>
    </div>
  `;

  setTimeout(() => {
    document.getElementById('journalModal').classList.add('active');
    loadDepensesData();
  }, 10);
};

// üîπ Charger les donn√©es
async function loadDepensesData() {
  const depensesData = document.getElementById('depensesData');
  const messageDiv = document.getElementById('depenses-message');

  depensesData.innerHTML = '<tr><td colspan="5" class="text-center">Chargement...</td></tr>';
  messageDiv.textContent = '';
  messageDiv.classList.remove('error', 'success');

  try {
    const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=depense`;
    const response = await fetch(apiUrl);
    if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);

    const responseData = await response.json();
    allDepensesData = responseData.data || [];

    populateAgencyFilter(allDepensesData);
    applyFilters(); // üî• Affiche directement avec filtre appliqu√©

  } catch (error) {
    console.error("Erreur :", error);
    messageDiv.innerHTML = `‚ùå Erreur de chargement : ${error.message}`;
    messageDiv.classList.add('error');
    depensesData.innerHTML = '<tr><td colspan="5" class="text-center">Erreur de chargement</td></tr>';
  }
}

// üîπ Remplir le filtre Agence
function populateAgencyFilter(data) {
  const agencySelect = document.getElementById('filterAgency');
  const agencies = [...new Set(data.map(item => item.Agence).filter(Boolean))].sort();
  agencySelect.innerHTML = `<option value="">Toutes les agences</option>` +
    agencies.map(ag => `<option value="${ag}">${ag}</option>`).join('');
}

// üîπ Appliquer les filtres (date + agence)
function applyFilters() {
  const dateStart = document.getElementById('filterDateStart').value;
  const dateEnd = document.getElementById('filterDateEnd').value;
  const selectedAgency = document.getElementById('filterAgency').value;

  const filtered = allDepensesData.filter(item => {
    const itemDate = new Date(item.Date);
    const start = dateStart ? new Date(dateStart) : null;
    const end = dateEnd ? new Date(dateEnd) : null;

    let isDateValid = true;
    if (start && itemDate < start) isDateValid = false;
    if (end && itemDate > end) isDateValid = false;

    const isAgencyValid = selectedAgency ? item.Agence === selectedAgency : true;
    return isDateValid && isAgencyValid;
  });

  displayFilteredData(filtered);
}

// üîπ R√©initialiser filtres
function resetFilters() {
  document.getElementById('filterDateStart').value = '';
  document.getElementById('filterDateEnd').value = '';
  document.getElementById('filterAgency').value = '';
  displayFilteredData(allDepensesData);
}

// üîπ Afficher les donn√©es filtr√©es
function displayFilteredData(data) {
  const depensesData = document.getElementById('depensesData');
  if (!data || data.length === 0) {
    depensesData.innerHTML = '<tr><td colspan="5" class="text-center">Aucune donn√©e</td></tr>';
    return;
  }

  depensesData.innerHTML = data.map(row => {
    const date = row.Date ? new Date(row.Date).toLocaleDateString('fr-FR') : '';
    const montant = row.Montant
      ? parseFloat(row.Montant).toLocaleString('fr-FR', { minimumFractionDigits: 2 })
      : '';
    return `
      <tr>
        <td>${date}</td>
        <td>${row.Agence || ''}</td>
        <td>${row.Designation || ''}</td>
        <td>${row.Categorie || ''}</td>
        <td class="text-right">${montant}</td>
      </tr>`;
  }).join('');
}

// üîπ √âcouteurs pour filtrage automatique
document.addEventListener('change', e => {
  if (['filterDateStart', 'filterDateEnd', 'filterAgency'].includes(e.target.id)) {
    applyFilters();
  }
});

function printDepenses() {
    try {
        const originalTable = document.getElementById('depensesTable');
        if (!originalTable) {
            alert("Impossible de trouver le tableau des d√©penses √† imprimer");
            return;
        }

        // V√©rifier s'il y a des donn√©es √† imprimer
        const dataRows = originalTable.querySelectorAll('tbody tr');
        if (dataRows.length === 0 || (dataRows.length === 1 && dataRows[0].querySelector('td[colspan="5"]'))) {
            alert("Aucune donn√©e disponible pour l'impression");
            return;
        }

        // Clone le tableau pour l'impression
        const printContent = originalTable.cloneNode(true);
        
        // Cr√©e une fen√™tre d'impression
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            alert("Veuillez autoriser les fen√™tres pop-up pour cette fonctionnalit√©");
            return;
        }

        // Style am√©lior√© pour l'impression
        const styles = `
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 0; 
                    padding: 15px; 
                    color: #333;
                    font-size: 12px;
                }
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 1px solid #eee;
                    padding-bottom: 10px;
                }
                .print-title {
                    font-size: 18px;
                    font-weight: bold;
                    margin: 10px 0;
                }
                .print-info {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 10px;
                    font-size: 11px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 6px; 
                    text-align: left; 
                }
                th { 
                    background-color: #f2f2f2; 
                    font-weight: bold;
                }
                .text-right { 
                    text-align: right; 
                }
                .total-row { 
                    font-weight: bold; 
                    background-color: #f9f9f9;
                }
                tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                @page { 
                    size: auto;  
                    margin: 10mm;
                }
                @media print {
                    body { 
                        margin: 0; 
                        padding: 0; 
                    }
                    .no-print { 
                        display: none !important; 
                    }
                    table {
                        page-break-inside: auto;
                    }
                    tr {
                        page-break-inside: avoid;
                        page-break-after: auto;
                    }
                }
            </style>
        `;
        
        // Calcul du total
        let total = 0;
        const rows = printContent.getElementsByTagName('tbody')[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const amountCell = rows[i].cells[4];
            if (amountCell && !rows[i].querySelector('td[colspan]')) {
                const amountText = amountCell.textContent
                    .replace('', '')
                    .replace(/\s/g, '')
                    .replace(',', '.');
                const amount = parseFloat(amountText);
                if (!isNaN(amount)) {
                    total += amount;
                }
            }
        }
        
        // Formatage du total
        const formattedTotal = total.toLocaleString('fr-FR', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        }) + '';
        
        // Ajout de la ligne de total
        const tbody = printContent.getElementsByTagName('tbody')[0];
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
            <td colspan="4" class="text-right"><strong>Total</strong></td>
            <td class="text-right"><strong>${formattedTotal}</strong></td>
        `;
        tbody.appendChild(totalRow);
        
        // Informations d'en-t√™te
        const dateStart = document.getElementById('filterDateStart').value;
        const dateEnd = document.getElementById('filterDateEnd').value;
        let periodInfo = '';
        
        if (dateStart || dateEnd) {
            const startText = dateStart ? new Date(dateStart).toLocaleDateString('fr-FR') : 'd√©but';
            const endText = dateEnd ? new Date(dateEnd).toLocaleDateString('fr-FR') : 'aujourd\'hui';
            periodInfo = `P√©riode : du ${startText} au ${endText}`;
        } else {
            periodInfo = 'Toutes les d√©penses';
        }
        
        // Construction du contenu HTML complet
        printWindow.document.write(`
            <html>
                <head>
                    <title>Journal des D√©penses</title>
                    ${styles}
                </head>
                <body>
                    <div class="print-header">
                        <div class="print-title">Journal des D√©penses</div>
                        <div class="print-info">
                            <span>${periodInfo}</span>
                            <span>Imprim√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                    </div>
                    ${printContent.outerHTML}

                </body>
            </html>
        `);
        
        printWindow.document.close();
    printWindow.onload = function () {
    printWindow.focus();   // Met la fen√™tre au premier plan
    printWindow.print();   // Lance l'impression
    printWindow.close();   // Ferme la fen√™tre apr√®s impression
};
        
    } catch (error) {
        console.error("Erreur lors de l'impression:", error);
        alert("Une erreur est survenue lors de la pr√©paration de l'impression");
    }
}

// Fonction pour ouvrir la liste des verres avec filtrage instantan√©
function openListeVerre() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="verreModal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-glasses modal-icon"></i> Catalogue des Verres
                    </h3>
                </div>
                <div class="modal-body">
                    <div class="filters-panel">
                        <div class="filter-group">
                            <label for="filterGamme">Gamme</label>
                            <select id="filterGamme" class="form-select" onchange="applyVerreFilter()">
                                <option value="">Toutes les gammes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterType">Type de Verre</label>
                            <select id="filterType" class="form-select" onchange="applyVerreFilter()">
                                <option value="">Tous les types</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterIndice">Indice</label>
                            <select id="filterIndice" class="form-select" onchange="applyVerreFilter()">
                                <option value="">Tous les indices</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterTraitement">Traitement</label>
                            <select id="filterTraitement" class="form-select" onchange="applyVerreFilter()">
                                <option value="">Tous les traitements</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-outline-secondary btn-icon" onclick="resetVerreFilter()">
                                <i class="fas fa-undo"></i> R√©initialiser
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover verre-catalogue-table" id="verreTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Gamme</th>
                                        <th>Type de Verre</th>
                                        <th>Indice</th>
                                        <th>Traitement</th>
                                        <th class="text-right">Prix (FCFA)</th>
                                    </tr>
                                </thead>
                                <tbody id="verreData">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="verre-message" class="alert alert-info mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-icon" onclick="printVerreList()">
                        <i class="fas fa-print"></i> Imprimer la liste
                    </button>
                    <button type="button" class="btn btn-primary btn-icon" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('verreModal').classList.add('active');
    loadVerreData();
}

// Variables globales
let allVerreData = [];
let uniqueGammes = [];
let uniqueTypes = [];
let uniqueIndices = [];
let uniqueTraitements = [];

// Chargement des donn√©es
async function loadVerreData() {
    const verreData = document.getElementById('verreData');
    const messageDiv = document.getElementById('verre-message');
    
    verreData.innerHTML = '<tr><td colspan="5" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importverre`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de donn√©es invalide');
        }
        
        // Transformation des donn√©es
        allVerreData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                Gamme: row[headers.indexOf('Gamme')] || '',
                Type: row[headers.indexOf('Type de Verre')] || '',
                Indice: row[headers.indexOf('Indice')] || '',
                Traitement: row[headers.indexOf('TRAITEMENT')] || '',
                Prix: parseFloat(row[headers.indexOf('PRIX')]) || 0
            };
        });

        // R√©cup√©ration des valeurs uniques pour les filtres
        uniqueGammes = [...new Set(allVerreData.map(item => item.Gamme).filter(Boolean))];
        uniqueTypes = [...new Set(allVerreData.map(item => item.Type).filter(Boolean))];
        uniqueIndices = [...new Set(allVerreData.map(item => item.Indice).filter(Boolean))];
        uniqueTraitements = [...new Set(allVerreData.map(item => item.Traitement).filter(Boolean))];

        // Peuplement des filtres
        populateSelect('filterGamme', uniqueGammes);
        populateSelect('filterType', uniqueTypes);
        populateSelect('filterIndice', uniqueIndices);
        populateSelect('filterTraitement', uniqueTraitements);

        displayFilteredVerre(allVerreData);
        
    } catch (error) {
        console.error('Erreur:', error);
        showVerreMessage(`‚ùå Erreur: ${error.message || 'Chargement √©chou√©'}`, 'error');
        verreData.innerHTML = '<tr><td colspan="5" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Peuplement des select filters
function populateSelect(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">Tous</option>`;
    
    values.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
    });
}

// Affichage des donn√©es filtr√©es
function displayFilteredVerre(data) {
    const verreData = document.getElementById('verreData');
    
    if (!data?.length) {
        verreData.innerHTML = '<tr><td colspan="5" class="text-center">Aucun verre trouv√©</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        html += `
            <tr>
                <td>${item.Gamme}</td>
                <td>${item.Type}</td>
                <td>${item.Indice}</td>
                <td>${item.Traitement}</td>
                <td class="text-right">${item.Prix.toLocaleString('fr-FR', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 })}
                </td>

            </tr>
        `;
    });
    
    verreData.innerHTML = html;
}

// Application des filtres
function applyVerreFilter() {
    const gamme = document.getElementById('filterGamme').value;
    const type = document.getElementById('filterType').value;
    const indice = document.getElementById('filterIndice').value;
    const traitement = document.getElementById('filterTraitement').value;
    
    let filteredData = allVerreData.filter(item => {
        return (!gamme || item.Gamme === gamme) &&
               (!type || item.Type === type) &&
               (!indice || item.Indice === indice) &&
               (!traitement || item.Traitement === traitement);
    });
    
    displayFilteredVerre(filteredData);
    //showVerreMessage(`üîé ${filteredData.length} verres trouv√©s`, 'info');
}

// R√©initialisation des filtres
function resetVerreFilter() {
    document.getElementById('filterGamme').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterIndice').value = '';
    document.getElementById('filterTraitement').value = '';
    
    displayFilteredVerre(allVerreData);
    showVerreMessage(`‚Üª Affichage de tous les ${allVerreData.length} verres`, 'info');
}

// Affichage des messages
function showVerreMessage(message, type) {
    const messageDiv = document.getElementById('verre-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression
function printVerreList() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('verreTable').cloneNode(true);
    
    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 15px; }
            h1 { color: #333; text-align: center; margin-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .text-right { text-align: right; }
            @page { size: auto; margin: 10mm; }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Catalogue des Verres</title>
                ${styles}
            </head>
            <body>
                <h1>Catalogue des Verres</h1>
                <p>Imprim√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.onload = function () {
    printWindow.focus();   // Met la fen√™tre au premier plan
    printWindow.print();   // Lance l'impression
    printWindow.close();   // Ferme la fen√™tre apr√®s impression
};

}

// Fonction pour ouvrir la liste des montures

function openListeMonture() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="montureModal">
            <div class="modal-content extra-large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-glasses modal-icon"></i> Catalogue des Montures
                    </h3>
                </div>
                <div class="modal-body">
                    <div class="filters-panel compact-filters">
                        <div class="filter-row">
                            <!-- Filtre R√©f√©rence -->
                            <div class="filter-group">
                                <label for="filterReference">R√©f√©rence</label>
                                <select id="filterReference" class="form-select" onchange="applyMontureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            
                            <!-- Filtre Fournisseur -->
                            <div class="filter-group">
                                <label for="filterFournisseur">Fournisseur</label>
                                <select id="filterFournisseur" class="form-select" onchange="applyMontureFilter()">
                                    <option value="">Tous</option>
                                </select>
                            </div>
                            
                            <!-- Filtre Couleur -->
                            <div class="filter-group">
                                <label for="filterCouleur">Couleur</label>
                                <select id="filterCouleur" class="form-select" onchange="applyMontureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            
                            <!-- Bouton R√©initialiser -->
                            <div class="filter-action">
                                <button class="btn btn-outline-secondary btn-icon" onclick="resetMontureFilter()">
                                    <i class="fas fa-undo"></i> R√©initialiser
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover monture-catalogue-table" id="montureTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>R√©f√©rence</th>
                                        <th>Fournisseur</th>
                                        <th>Couleur</th>
                                        <th class="text-right">Quantit√©</th>
                                        <th>Code Unique</th>
                                    </tr>
                                </thead>
                                <tbody id="montureData">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="monture-message" class="alert alert-info mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-icon" onclick="printMontureList()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-primary btn-icon" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('montureModal').classList.add('active');
    loadMontureData();
}
// Variables globales pour les montures
let allMontureData = [];
let uniqueReferences = [];
let uniqueFournisseurs = [];
let uniqueCouleurs = [];

// Chargement des donn√©es des montures
async function loadMontureData() {
    const montureData = document.getElementById('montureData');
    const messageDiv = document.getElementById('monture-message');
    
    montureData.innerHTML = '<tr><td colspan="5" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importmonture`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de donn√©es invalide');
        }
        
        // Transformation des donn√©es
        allMontureData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                Reference: row[headers.indexOf('R√©f√©rence')] || '',
                Fournisseur: row[headers.indexOf('Fournisseur')] || '',
                Couleur: row[headers.indexOf('Couleur')] || '',
                Quantite: parseInt(row[headers.indexOf('Quantit√©')]) || 0,
                CodeUnique: row[headers.indexOf('Code Unique')] || ''
            };
        });

        // R√©cup√©ration des valeurs uniques pour les filtres
        uniqueReferences = [...new Set(allMontureData.map(item => item.Reference).filter(Boolean))];
        uniqueFournisseurs = [...new Set(allMontureData.map(item => item.Fournisseur).filter(Boolean))];
        uniqueCouleurs = [...new Set(allMontureData.map(item => item.Couleur).filter(Boolean))];

        // Peuplement des filtres
        populateSelect('filterReference', uniqueReferences);
        populateSelect('filterFournisseur', uniqueFournisseurs);
        populateSelect('filterCouleur', uniqueCouleurs);

        displayFilteredMonture(allMontureData);
        
    } catch (error) {
        console.error('Erreur:', error);
        showMontureMessage(`‚ùå Erreur: ${error.message || 'Chargement √©chou√©'}`, 'error');
        montureData.innerHTML = '<tr><td colspan="5" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Affichage des donn√©es filtr√©es pour montures
function displayFilteredMonture(data) {
    const montureData = document.getElementById('montureData');
    
    if (!data?.length) {
        montureData.innerHTML = '<tr><td colspan="5" class="text-center">Aucune monture trouv√©e</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        html += `
            <tr>
                <td>${item.Reference}</td>
                <td>${item.Fournisseur}</td>
                <td>${item.Couleur}</td>
                <td class="text-right">${item.Quantite}</td>
                <td>${item.CodeUnique}</td>
            </tr>
        `;
    });
    
    montureData.innerHTML = html;
}

// Application des filtres pour montures
function applyMontureFilter() {
    const reference = document.getElementById('filterReference').value;
    const fournisseur = document.getElementById('filterFournisseur').value;
    const couleur = document.getElementById('filterCouleur').value;
    
    let filteredData = allMontureData.filter(item => {
        return (!reference || item.Reference === reference) &&
               (!fournisseur || item.Fournisseur === fournisseur) &&
               (!couleur || item.Couleur === couleur);
    });
    
    displayFilteredMonture(filteredData);
    //showMontureMessage(`üîé ${filteredData.length} montures trouv√©es`, 'info');
}

// R√©initialisation des filtres pour montures
function resetMontureFilter() {
    document.getElementById('filterReference').value = '';
    document.getElementById('filterFournisseur').value = '';
    document.getElementById('filterCouleur').value = '';
    
    displayFilteredMonture(allMontureData);
    showMontureMessage(`‚Üª Affichage de toutes les ${allMontureData.length} montures`, 'info');
}

// Affichage des messages pour montures
function showMontureMessage(message, type) {
    const messageDiv = document.getElementById('monture-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression pour montures
function printMontureList() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('montureTable').cloneNode(true);
    
    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 15px; }
            h1 { color: #333; text-align: center; margin-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .text-right { text-align: right; }
            @page { size: auto; margin: 10mm; }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Catalogue des Montures</title>
                ${styles}
            </head>
            <body>
                <h1>Catalogue des Montures</h1>
                <p>Imprim√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.onload = function () {
    printWindow.focus();   // Met la fen√™tre au premier plan
    printWindow.print();   // Lance l'impression
    printWindow.close();   // Ferme la fen√™tre apr√®s impression
};

}

// Variables globales pour les factures
let allFactureData = [];
let uniqueFactureSocietes = [];
let uniqueFactureAssurances = [];
let uniqueFactureCompagnies = [];
let uniqueFactureProprietaires = [];
let currentFilteredFactures = [];

// D√©lai pour le filtrage
let filterTimeout;

// Fonction principale pour ouvrir la gestion des facturations
function openFacturation() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="facturationModal">
            <div class="modal-content" style="width: 95vw; max-width: none; height: 90vh;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid #ddd;">
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">
                        <i class="fas fa-truck me-2"></i> Gestion des Facturations
                    </h3>
                    <div>
                        <button class="btn btn-primary btn-sm me-2" onclick="openAddFactureModal()" title="Ajouter une facture">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                </div>

                <div class="modal-body" style="display: flex; flex-direction: column; padding: 15px; gap: 10px; overflow: hidden;">

                    <!-- Filtres am√©lior√©s -->
                    <div class="filters-panel" style="flex-shrink: 0; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
                            <!-- Filtre Date D√©but -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterFactureDateStart" class="form-label small">Date de d√©but</label>
                                <input type="date" id="filterFactureDateStart" class="form-control form-control-sm" onchange="applyFactureFilter()">
                            </div>
                            <!-- Filtre Date Fin -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterFactureDateEnd" class="form-label small">Date de fin</label>
                                <input type="date" id="filterFactureDateEnd" class="form-control form-control-sm" onchange="applyFactureFilter()">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterFactureSociete" class="form-label small">Soci√©t√©</label>
                                <select id="filterFactureSociete" class="form-select form-select-sm" onchange="applyFactureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterFactureAssurance" class="form-label small">Assurance</label>
                                <select id="filterFactureAssurance" class="form-select form-select-sm" onchange="applyFactureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterFactureCompagnie" class="form-label small">Compagnie</label>
                                <select id="filterFactureCompagnie" class="form-select form-select-sm" onchange="applyFactureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterFactureProprietaire" class="form-label small">Propri√©taire</label>
                                <select id="filterFactureProprietaire" class="form-select form-select-sm" onchange="applyFactureFilter()">
                                    <option value="">Tous</option>
                                </select>
                            </div>
                            <div style="align-self: center;">
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetFactureFilter()">
                                    <i class="fas fa-undo me-1"></i> R√©initialiser
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="table-container" style="flex-grow: 1; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm" id="factureTable">
                                <thead class="table-dark sticky-top" id="factureTableHeader">
                                    <!-- Les en-t√™tes seront g√©n√©r√©s dynamiquement -->
                                </thead>
                                <tbody id="factureData">
                                    <tr>
                                        <td colspan="12" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Message -->
                    <div id="facture-message" class="alert alert-info small mt-2" style="display: none;"></div>
                </div>

                <!-- Footer -->
                <div class="modal-footer d-flex justify-content-between align-items-center p-2 border-top">
                    <button type="button" class="btn btn-success btn-sm" onclick="genererFacture()">
                        <i class="fas fa-file-invoice me-1"></i> G√©n√©rer Facture
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="closeModal()">
                        <i class="fas fa-times me-1"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('facturationModal').classList.add('active');
    loadFactureData();
}

// Chargement des donn√©es de facturation
async function loadFactureData() {
    const factureData = document.getElementById('factureData');
    const messageDiv = document.getElementById('facture-message');
    const tableHeader = document.getElementById('factureTableHeader');
    
    factureData.innerHTML = '<tr><td colspan="12" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importassurance`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows || !responseData?.data?.headers) {
            throw new Error('Structure de donn√©es invalide');
        }
        
        // G√©n√©rer les en-t√™tes du tableau
        generateTableHeaders(responseData.data.headers);
        
        // Transformation des donn√©es
        allFactureData = responseData.data.rows.map(row => {
            const item = {};
            responseData.data.headers.forEach((header, index) => {
                const cleanHeader = header.replace(/\t/g, ' ').trim();
                item[cleanHeader] = row[index] || '';
                
                if (cleanHeader.includes('MONTANT TOTAL') || cleanHeader.includes('TOTAL PART ASSURE') || cleanHeader.includes('PART ASSUREUR')) {
                    item[cleanHeader] = parseFloat(row[index]) || 0;
                }
            });
            return item;
        });

        // Initialiser les donn√©es filtr√©es
        currentFilteredFactures = [...allFactureData];

        // Mettre √† jour les filtres
        refreshFilters();

        // Afficher les donn√©es
        const headers = Object.keys(allFactureData[0] || {});
        displayFilteredFactures(allFactureData, headers);
        
    } catch (error) {
        console.error('Erreur:', error);
        showFactureMessage(`‚ùå Erreur: ${error.message || 'Chargement √©chou√©'}`, 'error');
        factureData.innerHTML = '<tr><td colspan="12" class="text-center">Erreur de chargement</td></tr>';
    }
}

// G√©n√©rer les en-t√™tes du tableau
function generateTableHeaders(headers) {
    const tableHeader = document.getElementById('factureTableHeader');
    tableHeader.innerHTML = '';
    
    const headerRow = document.createElement('tr');
    
    headers.forEach(header => {
        const th = document.createElement('th');
        const cleanHeader = header.replace(/\t/g, ' ').trim();
        
        if (cleanHeader.includes('MONTANT TOTAL') || cleanHeader.includes('TOTAL PART ASSURE') || cleanHeader.includes('PART ASSUREUR')) {
            th.className = 'text-end';
        }
        
        th.textContent = cleanHeader;
        headerRow.appendChild(th);
    });
    
    // Ajouter la colonne Actions
    const actionsTh = document.createElement('th');
    actionsTh.textContent = 'Actions';
    headerRow.appendChild(actionsTh);
    
    tableHeader.appendChild(headerRow);
}

// Rafra√Æchir les filtres
function refreshFilters() {
    uniqueFactureSocietes = [...new Set(allFactureData.map(item => item['Soci√©t√©']).filter(Boolean))];
    uniqueFactureAssurances = [...new Set(allFactureData.map(item => item['Assurance']).filter(Boolean))];
    uniqueFactureCompagnies = [...new Set(allFactureData.map(item => item['Compagnie']).filter(Boolean))];
    uniqueFactureProprietaires = [...new Set(allFactureData.map(item => item['Proprietaire']).filter(Boolean))];

    populateFactureFilter('filterFactureSociete', uniqueFactureSocietes);
    populateFactureFilter('filterFactureAssurance', uniqueFactureAssurances);
    populateFactureFilter('filterFactureCompagnie', uniqueFactureCompagnies);
    populateFactureFilter('filterFactureProprietaire', uniqueFactureProprietaires);
}

// Peupler les filtres
function populateFactureFilter(selectId, values) {
    const select = document.getElementById(selectId);
    if (!select) {
        console.error(`Element #${selectId} non trouv√©`);
        return;
    }
    
    select.innerHTML = `<option value="">Tous</option>`;
    
    if (!values || !values.length) return;
    
    values.sort().forEach(value => {
        if (value) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
        }
    });
}

// Application des filtres
function applyFactureFilter() {
    console.log("Application des filtres...");
    
    const dateStart = document.getElementById('filterFactureDateStart').value;
    const dateEnd = document.getElementById('filterFactureDateEnd').value;
    const societe = document.getElementById('filterFactureSociete').value;
    const assurance = document.getElementById('filterFactureAssurance').value;
    const compagnie = document.getElementById('filterFactureCompagnie').value;
    const proprietaire = document.getElementById('filterFactureProprietaire').value;
    
    // Convertir les dates une seule fois
    const startDateObj = dateStart ? new Date(dateStart) : null;
    const endDateObj = dateEnd ? new Date(dateEnd) : null;
    
    let filteredData = allFactureData.filter(item => {
        // Filtrage par date
        let dateMatch = true;
        if (item['Date']) {
            const itemDate = new Date(item['Date']);
            
            if (startDateObj && endDateObj) {
                dateMatch = itemDate >= startDateObj && itemDate <= endDateObj;
            } else if (startDateObj) {
                dateMatch = itemDate >= startDateObj;
            } else if (endDateObj) {
                dateMatch = itemDate <= endDateObj;
            }
        }
        
        // Filtrage par autres crit√®res
        const societeMatch = !societe || item['Soci√©t√©'] === societe;
        const assuranceMatch = !assurance || item['Assurance'] === assurance;
        const compagnieMatch = !compagnie || item['Compagnie'] === compagnie;
        const proprietaireMatch = !proprietaire || item['Proprietaire'] === proprietaire;
        
        return dateMatch && societeMatch && assuranceMatch && compagnieMatch && proprietaireMatch;
    });
    
    console.log(`Filtres appliqu√©s - ${filteredData.length} r√©sultats`);
    
    const headers = Object.keys(allFactureData[0] || {});
    displayFilteredFactures(filteredData, headers);
}

// R√©initialiser les filtres
function resetFactureFilter() {
    console.log("R√©initialisation des filtres");
    
    document.getElementById('filterFactureDateStart').value = '';
    document.getElementById('filterFactureDateEnd').value = '';
    document.getElementById('filterFactureSociete').value = '';
    document.getElementById('filterFactureAssurance').value = '';
    document.getElementById('filterFactureCompagnie').value = '';
    document.getElementById('filterFactureProprietaire').value = '';
    
    const headers = Object.keys(allFactureData[0] || {});
    displayFilteredFactures(allFactureData, headers);
}

// Affichage des donn√©es filtr√©es
function displayFilteredFactures(data, headers) {
    const factureData = document.getElementById('factureData');
    
    // Stocker les donn√©es filtr√©es actuellement affich√©es
    currentFilteredFactures = data;
    
    if (!data?.length) {
        factureData.innerHTML = `<tr><td colspan="${headers.length + 1}" class="text-center">Aucune facture trouv√©e</td></tr>`;
        return;
    }
    
    let html = '';
    data.forEach((item, index) => {
        html += '<tr>';
        
        headers.forEach(header => {
            const cleanHeader = header.replace(/\t/g, ' ').trim();
            const value = item[cleanHeader] || '';
            
            if (cleanHeader === 'Date') {
                html += `<td>${formatDate(value)}</td>`;
            } 
            else if (cleanHeader.includes('MONTANT') || cleanHeader.includes('PART') || cleanHeader.includes('TOTAL')) {
                html += `<td class="text-end">${formatCurrency(value)}</td>`;
            }
            else if (cleanHeader === 'Statut') {
                html += `<td><span class="badge ${getStatusBadgeClass(value)}">${value}</span></td>`;
            }
            else {
                html += `<td>${value}</td>`;
            }
        });
        
        // Boutons d'action - utiliser l'index des donn√©es filtr√©es
        html += `
            <td>
                <div class="action-btns">
                    <button class="action-btn btn-edit" onclick="editFilteredFacture(${index})" title="Modifier">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="action-btn btn-cancel" onclick="cancelFilteredFacture(${index})" title="Annuler">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </td>
        `;
        
        html += '</tr>';
    });
    
    factureData.innerHTML = html;
}

// √âdition d'une facture depuis les donn√©es filtr√©es
function editFilteredFacture(filteredIndex) {
    // R√©cup√©rer la facture depuis les donn√©es filtr√©es actuelles
    const facture = currentFilteredFactures[filteredIndex];
    
    // Trouver l'index correspondant dans allFactureData
    const originalIndex = allFactureData.findIndex(item => 
        item['Id Client'] === facture['Id Client'] && 
        item['N¬∞Police'] === facture['N¬∞Police']
    );
    
    if (originalIndex === -1) {
        alert('Facture non trouv√©e dans les donn√©es originales');
        return;
    }
    
    // Ouvrir la modal d'√©dition avec l'index original
    openEditFactureModal(originalIndex, facture);
}

// Annulation d'une facture depuis les donn√©es filtr√©es
function cancelFilteredFacture(filteredIndex) {
    // R√©cup√©rer la facture depuis les donn√©es filtr√©es actuelles
    const facture = currentFilteredFactures[filteredIndex];
    
    // Trouver l'index correspondant dans allFactureData
    const originalIndex = allFactureData.findIndex(item => 
        item['Id Client'] === facture['Id Client'] && 
        item['N¬∞Police'] === facture['N¬∞Police']
    );
    
    if (originalIndex === -1) {
        alert('Facture non trouv√©e dans les donn√©es originales');
        return;
    }
    
    // Appeler la fonction d'annulation avec l'index original
    cancelFacture(originalIndex);
}

// Ouvrir la modal d'√©dition de facture
function openEditFactureModal(index, factureData = null) {
    const facture = factureData || allFactureData[index];
    const modalContainer = document.getElementById('modal-container');
    
    const modalHTML = `
        <div class="edit-modal active" id="editFactureModal">
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h3 class="edit-modal-title">
                        <i class="fas fa-edit me-2"></i> 
                        Modifier Facture ${facture['N¬∞Police'] || facture['Id Client']}
                    </h3>
                </div>
                
                <div class="edit-modal-body">
                    <form id="editFactureForm">
                        <div class="edit-row">
                            <div class="edit-col">
                                <div class="edit-form-group">
                                    <label class="edit-form-label">ID Client</label>
                                    <input type="text" class="edit-form-control" value="${facture['Id Client'] || ''}" readonly>
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Date</label>
                                    <input type="date" class="edit-form-control" id="editDate" value="${formatDateForInput(facture['Date'])}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">N¬∞ Police</label>
                                    <input type="text" class="edit-form-control" id="editPolice" value="${facture['N¬∞Police'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Soci√©t√©</label>
                                    <input type="text" class="edit-form-control" id="editSociete" value="${facture['Soci√©t√©'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Assur√© Principal</label>
                                    <input type="text" class="edit-form-control" id="editAssure" value="${facture['Assur√© Principal'] || ''}">
                                </div>
                                                            
                                <div class="edit-form-group">
                                    <label class="edit-form-label">B√©n√©ficiaire</label>
                                    <input type="text" class="edit-form-control" id="editBeneficiaire" value="${facture['B√©n√©ficiaire'] || ''}">
                                </div>
                            </div>
                            
                            <div class="edit-col">
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Actes</label>
                                    <input type="text" class="edit-form-control" id="editActes" value="${facture['Actes'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Montant Total</label>
                                    <input type="number" step="0.01" class="edit-form-control" id="editMontant" value="${facture['MONTANT TOTAL'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Part Assureur</label>
                                    <input type="number" step="0.01" class="edit-form-control" id="editPartAssureur" value="${facture['PART ASSUREUR'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">PART ASSURE</label>
                                    <input type="text" class="edit-form-control" id="editPartAssure" value="${facture['TOTAL PART ASSURE'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Assurance</label>
                                    <input type="text" class="edit-form-control" id="editAssurance" value="${facture['Assurance'] || ''}">
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Compagnie</label>
                                    <input type="text" class="edit-form-control" id="editCompagnie" value="${facture['Compagnie'] || ''}">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="edit-modal-footer">
                    <button type="button" class="edit-btn edit-btn-secondary" onclick="closeModalAndOpenFacturation()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="button" class="edit-btn edit-btn-primary" onclick="submitFactureUpdate(${index})">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modalHTML;
    document.body.classList.add('modal-open');
}

function formatDateForInput(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toISOString().split('T')[0];
    } catch (e) {
        return '';
    }
}

function submitFactureUpdate(index) {
    const facture = allFactureData[index];
    const idClient = facture['Id Client'];
    
    // R√©cup√©ration des valeurs des champs
    const updatedData = {
        'Id Client': idClient,
        'Date': document.getElementById('editDate').value,
        'N¬∞Police': document.getElementById('editPolice').value,
        'Soci√©t√©': document.getElementById('editSociete').value,
        'Assur√© Principal': document.getElementById('editAssure').value,
        'B√©n√©ficiaire': document.getElementById('editBeneficiaire').value,
        'Actes': document.getElementById('editActes').value,
        'MONTANT TOTAL': document.getElementById('editMontant').value,
        'PART ASSUREUR': document.getElementById('editPartAssureur').value,
        'TOTAL PART ASSURE': document.getElementById('editPartAssure').value,
        'Assurance': document.getElementById('editAssurance').value,
        'Compagnie': document.getElementById('editCompagnie').value
    };

    const submitBtn = document.querySelector('.edit-btn-primary');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    submitBtn.disabled = true;

    const url = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=updateFacture`;
    
    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            idClient: idClient,
            updatedData: updatedData
        })
    })
    .then(() => {
        // Mise √† jour optimiste
        allFactureData[index] = {...allFactureData[index], ...updatedData};
        closeModalAndOpenFacturation();
    })
    .catch(error => {
        console.error("Erreur d'envoi:", error);
        closeModalAndOpenFacturation();
    })
    .finally(() => {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    });
}

async function cancelFacture(index) {
    const facture = allFactureData[index];
    const clientId = facture['Id Client'];
    const policeNumber = facture['N¬∞Police'] || '';

    if (!confirm(`Confirmez-vous l'annulation de la facture ${policeNumber} ?`)) {
        return;
    }

    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        await fetch(`https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=deleteFacture`, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                idClient: clientId,
                policeNumber: policeNumber
            })
        });

        // Suppression optimiste
        allFactureData.splice(index, 1);
        refreshFilters();
        closeModalAndOpenFacturation();
    } catch (e) {
        console.error('Erreur r√©seau:', e);
    } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

function closeModalAndOpenFacturation() {
    const modalContainer = document.getElementById('modal-container');
    if (modalContainer) {
        modalContainer.innerHTML = '';
        document.body.classList.remove('modal-open');
    }
    
    setTimeout(() => {
        if (typeof openFacturation === 'function') {
            openFacturation();
        }
    }, 300);
}

// Fonctions utilitaires
function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('fr-FR');
    } catch (e) {
        return dateString;
    }
}

function formatCurrency(amount) {
    if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
    return amount.toLocaleString('fr-FR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

function getStatusBadgeClass(statut) {
    switch(statut) {
        case 'Pay√©': return 'bg-success';
        case 'En attente': return 'bg-warning text-dark';
        case 'Annul√©': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function showFactureMessage(message, type) {
    const messageDiv = document.getElementById('facture-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}


// Fonction pour ouvrir le modal d'ajout
async function openAddFactureModal() {
    const modalContainer = document.getElementById('modal-container');
    
    // V√©rifier si une modale est d√©j√† ouverte
    if (document.querySelector('.edit-modal.active')) {
        closeCurrentModal();
        await new Promise(resolve => setTimeout(resolve, 300)); // Attendre la fermeture
    }

    // D√©finir la date du jour par d√©faut
    const today = new Date().toISOString().split('T')[0];

    const modalHTML = `
    <div class="edit-modal active" id="addFactureModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3 class="edit-modal-title">
                    <i class="fas fa-plus-circle me-2"></i> 
                    Nouvelle Facture
                </h3>
            </div>
            
            <div class="edit-modal-body">
                <form id="addFactureForm">
                    <div class="edit-row">
                        <div class="edit-col">
                            <div class="edit-form-group">
                                <label class="edit-form-label">ID Client <span class="required">*</span></label>
                                <input type="text" class="edit-form-control" id="addClientId" required
                                       placeholder="2 lettres du nom + num√©ro de police, sans espace">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Date <span class="required">*</span></label>
                                <input type="date" class="edit-form-control" id="addDate" 
                                       value="${today}" required>
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">N¬∞ Police</label>
                                <input type="text" class="edit-form-control" id="addPolice"
                                       placeholder="Num√©ro de police d'assurance">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Soci√©t√©</label>
                                <input type="text" class="edit-form-control" id="addSociete"
                                       placeholder="Nom de la soci√©t√©">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Assur√© Principal</label>
                                <input type="text" class="edit-form-control" id="addAssure"
                                       placeholder="Nom complet de l'assur√©">
                            </div>
                                                        
                            <div class="edit-form-group">
                                <label class="edit-form-label">B√©n√©ficiaire</label>
                                <input type="text" class="edit-form-control" id="addBeneficiaire"
                                       placeholder="Nom du b√©n√©ficiaire">
                            </div>
                        </div>
                        
                        <div class="edit-col">
<div class="edit-form-group">
    <label class="edit-form-label">Actes</label>
    <textarea class="edit-form-control" id="addActes" rows="1"
              placeholder="D√©tails des actes m√©dicaux">Lunettes</textarea>
</div>

                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Montant Total</label>
                                <input type="number" step="0.01" class="edit-form-control" id="addMontant"
                                       placeholder="0.00">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Part Assureur</label>
                                <input type="number" step="0.01" class="edit-form-control" id="addPartAssureur"
                                       placeholder="0.00">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Part Assur√©</label>
                                <input type="number" step="0.01" class="edit-form-control" id="addPartAssure"
                                       placeholder="0.00">
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Assurance</label>
                                <select class="edit-form-control" id="addAssurance">
                                    <option value="">S√©lectionner une assurance</option>
                                </select>
                            </div>
                            
                            <div class="edit-form-group">
                                <label class="edit-form-label">Compagnie</label>
                                <select class="edit-form-control" id="addCompagnie">
                                    <option value="">S√©lectionner une compagnie</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="edit-modal-footer">
                <button type="button" class="edit-btn edit-btn-secondary" onclick="closeModalAndOpenFacturation()">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="edit-btn edit-btn-primary" id="submitNewFactureBtn" onclick="submitNewFacture()">
                    <i class="fas fa-save"></i> Ajouter
                </button>
            </div>
        </div>
    </div>`;

    // Ajouter la modale au DOM
    modalContainer.insertAdjacentHTML('beforeend', modalHTML);

    // Focus automatique sur le premier champ
    setTimeout(() => {
        document.getElementById('addClientId')?.focus();
    }, 100);

    // Charger les options dynamiques
    await loadDynamicOptions();
}
// Fonction pour soumettre la nouvelle facture

async function submitNewFacture() {
    const form = document.getElementById('addFactureForm');
    const formMessage = document.getElementById('form-message') || document.createElement('div');
    formMessage.id = 'form-message';
    formMessage.textContent = '';
    formMessage.className = 'form-message';
    
    // Si le message n'existe pas d√©j√† dans le DOM, on l'ajoute
    if (!document.getElementById('form-message')) {
        form.insertAdjacentElement('beforebegin', formMessage);
    }

    // Validation am√©lior√©e
    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires correctement.';
        formMessage.classList.add('error');
        
        // Highlight des champs invalides
        const invalidFields = form.querySelectorAll(':invalid');
        invalidFields.forEach(field => {
            field.classList.add('input-error');
            field.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.classList.remove('input-error');
                }
            });
        });
        
        return;
    }

    // Pr√©paration des donn√©es de la facture
    const factureData = {
        clientId: document.getElementById('addClientId').value.trim(),
        date: document.getElementById('addDate').value,
        police: document.getElementById('addPolice').value.trim(),
        societe: document.getElementById('addSociete').value.trim(),
        assure: document.getElementById('addAssure').value.trim(),
        beneficiaire: document.getElementById('addBeneficiaire').value.trim(),
        actes: document.getElementById('addActes').value.trim(),
        montant: parseFloat(document.getElementById('addMontant').value) || 0,
        partAssureur: parseFloat(document.getElementById('addPartAssureur').value) || 0,
        partAssure: parseFloat(document.getElementById('addPartAssure').value) || 0,
        assurance: document.getElementById('addAssurance').value,
        compagnie: document.getElementById('addCompagnie').value
    };


    const submitButton = document.getElementById('submitNewFactureBtn');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addfacture";

        await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(factureData)
        });

        // Succ√®s
        formMessage.textContent = '‚úÖ Facture enregistr√©e avec succ√®s!';
        formMessage.classList.add('success');
        
        // R√©initialiser le formulaire apr√®s succ√®s
        form.reset();
        document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
        
        // Fermer apr√®s 1.5s
        setTimeout(() => {
            closeModalAndOpenFacturation();
            // Rafra√Æchir les donn√©es si n√©cessaire
            if (typeof refreshFactures === 'function') {
                refreshFactures();
            }
        }, 1500);

    } catch (error) {
        console.error("Erreur:", error);
        formMessage.textContent = '‚ùå Une erreur est survenue lors de l\'enregistrement';
        formMessage.classList.add('error');
        logError(`Facture: ${error.message}`);
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-save"></i> Ajouter';
    }
}

// Fonction d'affichage des alertes (√† adapter selon votre impl√©mentation)
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} fixed-top mx-auto mt-3`;
    alertDiv.style.maxWidth = '500px';
    alertDiv.style.zIndex = '1100';
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

function showAlert(type, message) {
    // Impl√©mentez votre syst√®me d'alerte
    alert(`${type}: ${message}`);
}

async function loadDynamicOptions() {
    try {
        // R√©cup√©rer les donn√©es depuis l'API
        const response = await fetch(DATA_SOURCE_URL);
        if (!response.ok) throw new Error('Erreur r√©seau');
        
        const data = await response.json();
        if (!data.success) throw new Error(data.message || 'Erreur de donn√©es');

        // Extraire uniquement les assurances et compagnies
        const { assurances, compagnies } = data.data;

        // Remplir le select des assurances
        const assuranceSelect = document.getElementById('addAssurance');
        assurances.forEach(assurance => {
            assuranceSelect.innerHTML += `<option value="${assurance}">${assurance}</option>`;
        });

        // Remplir le select des compagnies
        const compagnieSelect = document.getElementById('addCompagnie');
        compagnies.forEach(compagnie => {
            compagnieSelect.innerHTML += `<option value="${compagnie}">${compagnie}</option>`;
        });

    } catch (error) {
        console.error('Erreur lors du chargement des options:', error);
    }
}

async function genererFacture() {
    // R√©cup√©rer les valeurs des filtres
    const dateDebut = document.getElementById('filterFactureDateStart').value;
    const dateFin = document.getElementById('filterFactureDateEnd').value;
    const assurance = document.getElementById('filterFactureAssurance').value;
    const compagnie = document.getElementById('filterFactureCompagnie').value;
    
    // V√©rifier que tous les champs sont remplis
    if (!dateDebut || !dateFin || !assurance || !compagnie) {
        alert("‚ùå Veuillez remplir tous les filtres obligatoires :\n- Date de d√©but\n- Date de fin\n- Assurance\n- Compagnie");
        return;
    }
    
    // R√©cup√©rer la date du jour au format DD/MM/YYYY
    const aujourdhui = new Date();
    const dateDuJour = `${String(aujourdhui.getDate()).padStart(2, '0')}/${String(aujourdhui.getMonth() + 1).padStart(2, '0')}/${aujourdhui.getFullYear()}`;
    
    // Pr√©parer les donn√©es (sans action dans le body car elle est dans l'URL)
    const data = {
        dateDebut: dateDebut,
        dateFin: dateFin,
        assurance: assurance,
        compagnie: compagnie,
        dateDuJour: dateDuJour
    };
    
    console.log("Donn√©es √† envoyer:", data);
    
    // URL du script Google Apps AVEC l'action dans l'URL
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=adddepotData';
    
    // Afficher un message de confirmation
    if (!confirm(`Confirmez-vous l'ajout de ce d√©p√¥t ?\n\nDu: ${dateDebut}\nAu: ${dateFin}\nAssurance: ${assurance}\nCompagnie: ${compagnie}`)) {
        return;
    }
    
    const generateButton = document.getElementById('generateFactureBtn') || document.querySelector('button[onclick*="genererFacture"]');
    let originalText = '';
    
    try {
        // D√©sactiver le bouton et afficher un indicateur de chargement
        if (generateButton) {
            originalText = generateButton.innerHTML;
            generateButton.disabled = true;
            generateButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';
        }
        
        // Envoyer les donn√©es avec mode: 'no-cors' comme dans submitNewFacture
        await fetch(scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        console.log("Donn√©es envoy√©es avec succ√®s");
        
        // Message de succ√®s
        alert("‚úÖ D√©p√¥t enregistr√© avec succ√®s !\nOuverture de la pointage de facturation dans 5 secondes...");
        
        // Attendre 5 secondes puis ouvrir la fonction
        setTimeout(() => {
            if (typeof openPointFacturation === 'function') {
                openPointFacturation();
            } else {
                console.error("La fonction openPointFacturation n'est pas d√©finie");
                alert("Erreur: fonction openPointFacturation non trouv√©e");
            }
        }, 5000);
        
    } catch (error) {
        console.error("Erreur lors de l'envoi:", error);
        alert("‚ùå Erreur lors de l'enregistrement du d√©p√¥t");
        logError(`G√©n√©ration Facture: ${error.message}`);
        
    } finally {
        // R√©activer le bouton
        if (generateButton) {
            generateButton.disabled = false;
            generateButton.innerHTML = originalText;
        }
    }
}

function openPointFacturation() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="facturationModal">
            <div class="modal-content" style="width: 95vw; max-width: none; height: 90vh;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid #ddd;">
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">
                        <i class="fas fa-file-contract me-2"></i> Point des Facturations
                    </h3>
                </div>

                <div class="modal-body" style="display: flex; flex-direction: column; padding: 15px; gap: 5px; overflow: hidden;">

                    <!-- Filtres -->
                    <div class="filters-panel" style="flex-shrink: 0;">
                        <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
                            <!-- Filtre Date D√©but -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterDateStart" class="form-label small">Date d√©but</label>
                                <input type="date" id="filterDateStart" class="form-control form-control-sm" onchange="applyFacturationFilter()">
                            </div>
                            <!-- Filtre Date Fin -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterDateEnd" class="form-label small">Date fin</label>
                                <input type="date" id="filterDateEnd" class="form-control form-control-sm" onchange="applyFacturationFilter()">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterDateDepot" class="form-label small">Date d√©p√¥t</label>
                                <input type="date" id="filterDateDepot" class="form-control form-control-sm" onchange="applyFacturationFilter()">
                            </div>
            

                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterAssurance" class="form-label small">Assurance</label>
                                <select id="filterAssurance" class="form-select form-select-sm" onchange="applyFacturationFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterCompagnie" class="form-label small">Compagnie</label>
                                <select id="filterCompagnie" class="form-select form-select-sm" onchange="applyFacturationFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="align-self: center;">
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetFacturationFilter()">
                                    <i class="fas fa-undo me-1"></i> R√©initialiser
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="table-container" style="flex-grow: 1; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm" id="facturationTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Date d√©but</th>
                                        <th>Date fin</th>
                                        <th>Assurance</th>
                                        <th>Compagnie</th>
                                        <th>Date d√©p√¥t</th>
                                        <th class="text-end">Montant Total</th>
                                        <th class="text-end">Part Assur√©</th>
                                        <th class="text-end">Part Assureur</th>
                                        <th>Nb Factures</th>
                                        <th>PDF R√©cap</th>
                                        <th>PDF D√©tail</th>
                                    </tr>
                                </thead>
                                <tbody id="facturationData">
                                    <tr>
                                        <td colspan="11" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Message -->
                    <div id="facturation-message" class="alert alert-info small mt-2" style="display: none;"></div>
                </div>

                <!-- Footer -->
                <div class="modal-footer d-flex justify-content-between align-items-center p-2 border-top">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="printFacturationList()">
                        <i class="fas fa-print me-1"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="closeModal()">
                        <i class="fas fa-times me-1"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('facturationModal').classList.add('active');
    loadFacturationData();
}

// Variables globales
let allFacturationData = [];
let uniqueAssurances = [];
let uniqueCompagnies = [];

// Chargement des donn√©es
async function loadFacturationData() {
    const facturationData = document.getElementById('facturationData');
    const messageDiv = document.getElementById('facturation-message');
    
    facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=pointfacturation`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de donn√©es invalide');
        }
        
        // Transformation des donn√©es
        allFacturationData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                DateDebut: row[headers.indexOf('Date debut')] || '',
                DateFin: row[headers.indexOf('Date fin')] || '',
                Assurance: row[headers.indexOf('Assurance')] || '',
                Compagnie: row[headers.indexOf('Compagnie')] || '',
                DateDepot: row[headers.indexOf('Date de depot')] || '',
                MontantTotal: parseFloat(row[headers.indexOf('MONTANT TOTAL')]) || 0,
                PartAssure: parseFloat(row[headers.indexOf('PART ASSURE')]) || 0,
                PartAssureur: parseFloat(row[headers.indexOf('PART ASSUREUR')]) || 0,
                NbFactures: row[headers.indexOf('Nbs')] || '',
                PdfRecap: row[headers.indexOf("lien Pdf Recaps")] || '',
                PdfDetail: row[headers.indexOf("lien Pdf Detail")] || ''
                
            };
        });

        // TRI DES DONN√âES PAR DATE DE D√âP√îT D√âCROISSANTE (les plus r√©centes en premier)
        allFacturationData.sort((a, b) => {
            const dateA = a.DateDepot ? new Date(a.DateDepot) : new Date(0);
            const dateB = b.DateDepot ? new Date(b.DateDepot) : new Date(0);
            return dateB - dateA; // Ordre d√©croissant
        });
        
        // R√©cup√©ration des valeurs uniques pour les filtres
        uniqueAssurances = [...new Set(allFacturationData.map(item => item.Assurance).filter(Boolean))];
        uniqueCompagnies = [...new Set(allFacturationData.map(item => item.Compagnie).filter(Boolean))];
        
        // Peuplement des filtres
        populatePointdesfacture('filterAssurance', uniqueAssurances);
        populatePointdesfacture('filterCompagnie', uniqueCompagnies);

        displayFilteredFacturation(allFacturationData);
       
    } catch (error) {
        console.error('Erreur:', error);
        showFacturationMessage(`‚ùå Erreur: ${error.message || 'Chargement √©chou√©'}`, 'error');
        facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Peuplement des select filters
function populatePointdesfacture(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">Tous</option>`;
    
    values.sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
    });
}

// Affichage des donn√©es filtr√©es avec gestion am√©lior√©e des PDF
function displayFilteredFacturation(data) {
    const facturationData = document.getElementById('facturationData');
    
    if (!data?.length) {
        facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Aucune donn√©e trouv√©e</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        // Gestion des liens PDF
        const pdfRecapBtn = item.PdfRecap && isValidUrl(item.PdfRecap) 
            ? `<a href="${item.PdfRecap}" target="_blank" class="btn btn-sm btn-outline-primary">Facture</a>`
            : '<span class="text-muted"> </span>';
        

const pdfDetailBtn = item.PdfDetail && isValidUrl(item.PdfDetail) 
            ? `<a href="${item.PdfDetail}" target="_blank" class="btn btn-sm btn-outline-primary">Detail Facture</a>`
            : '<span class="text-muted"> </span>';

        html += `
            <tr>
                <td>${formatDate(item.DateDebut)}</td>
                <td>${formatDate(item.DateFin)}</td>
                <td>${item.Assurance}</td>
                <td>${item.Compagnie}</td>
                <td>${formatDate(item.DateDepot)}</td>
                <td class="text-right">${formatCurrency(item.MontantTotal)}</td>
                <td class="text-right">${formatCurrency(item.PartAssure)}</td>
                <td class="text-right">${formatCurrency(item.PartAssureur)}</td>
                <td>${item.NbFactures}</td>
                <td>${pdfRecapBtn}</td>
                <td>${pdfDetailBtn}</td>
            </tr>
        `;
    });
    
    facturationData.innerHTML = html;
}

// V√©rifie si une URL est valide
function isValidUrl(string) {
    if (!string || typeof string !== 'string') return false;
    
    // Nettoyage basique de l'URL
    string = string.trim().replace(/\s+/g, '');
    
    try {
        new URL(string);
        return true;
    } catch (_) {
        // Tentative de correction pour les URLs Google Drive avec espaces
        if (string.includes('drive.google.com') && string.includes(' ')) {
            const cleanedUrl = string.replace(/\s/g, '');
            try {
                new URL(cleanedUrl);
                return true;
            } catch (_) {
                return false;
            }
        }
        return false;
    }
}

// Helper pour formater la date
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return isNaN(date) ? dateString : date.toLocaleDateString('fr-FR');
}

// Helper pour formater les montants
function formatCurrency(amount) {
    return amount.toLocaleString('fr-FR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

// Application des filtres
function applyFacturationFilter() {
    const dateStart = document.getElementById('filterDateStart').value;
    const dateEnd = document.getElementById('filterDateEnd').value;
    const dateDepot = document.getElementById('filterDateDepot').value;
    const assurance = document.getElementById('filterAssurance').value;
    const compagnie = document.getElementById('filterCompagnie').value;
    
    let filteredData = allFacturationData.filter(item => {
        // Conversion des dates en objets Date pour comparaison
        const itemDateDebut = item.DateDebut ? new Date(item.DateDebut) : null;
        const itemDateFin = item.DateFin ? new Date(item.DateFin) : null;
        const itemDateDepot = item.DateDepot ? new Date(item.DateDepot) : null;
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        const filterDateDepotObj = dateDepot ? new Date(dateDepot) : null;
        
        // V√©rification de la plage de dates
        let dateMatch = true;
        if (startDate && endDate) {
            dateMatch = (itemDateDebut >= startDate && itemDateDebut <= endDate) || 
                       (itemDateFin >= startDate && itemDateFin <= endDate);
        } else if (startDate) {
            dateMatch = itemDateDebut >= startDate || itemDateFin >= startDate;
        } else if (endDate) {
            dateMatch = itemDateDebut <= endDate || itemDateFin <= endDate;
        }

        let depotMatch = true;
        if (filterDateDepotObj && itemDateDepot) {
            // Compare seulement jour/mois/ann√©e (ignore l'heure)
            depotMatch = itemDateDepot.toDateString() === filterDateDepotObj.toDateString();
        }
        const assuranceMatch = !assurance || item.Assurance === assurance;
        const compagnieMatch = !compagnie || item.Compagnie === compagnie;
        
        return dateMatch && assuranceMatch && compagnieMatch && depotMatch;
    });
    
    displayFilteredFacturation(filteredData);
    
}

// R√©initialisation des filtres
function resetFacturationFilter() {
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    document.getElementById('filterDateDepot').value = ''; 
    document.getElementById('filterAssurance').value = '';
    document.getElementById('filterCompagnie').value = '';
    
    displayFilteredFacturation(allFacturationData);
    
}

// Affichage des messages
function showFacturationMessage(message, type) {
    const messageDiv = document.getElementById('facturation-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression
function printFacturationList() {
    const printWindow = window.open('', '_blank');
    
    // R√©cup√©rer les valeurs actuelles des filtres
    const dateStart = document.getElementById('filterDateStart').value;
    const dateEnd = document.getElementById('filterDateEnd').value;
    const dateDepot = document.getElementById('filterDateDepot').value;
    const assurance = document.getElementById('filterAssurance').value;
    const compagnie = document.getElementById('filterCompagnie').value;
    
    // Filtrer les donn√©es selon les filtres actuels
    const filteredData = filterData(allFacturationData, dateStart, dateEnd, dateDepot, assurance, compagnie);
    
    const printContent = document.getElementById('facturationTable').cloneNode(true);
    
    // Traitement sp√©cifique pour les PDF
    const pdfCells = printContent.querySelectorAll('td:nth-child(10), td:nth-child(11)');
    pdfCells.forEach(cell => {
        cell.textContent = cell.textContent.includes('Non disponible') ? 'Non disponible' : 'Disponible';
    });

    // Calcul du r√©capitulatif par assurance avec les donn√©es FILTR√âES
    const recapByAssurance = calculateRecapByAssurance(filteredData);
    
    // Cr√©ation du tableau r√©capitulatif
    let recapHTML = `
        <h2 style="margin-top: 20px; margin-bottom: 10px; font-size: 14px;">R√©capitulatif par Assurance (Donn√©es filtr√©es)</h2>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="border: 1px solid #ddd; padding: 5px; text-align: left;">Assurance</th>
                    <th style="border: 1px solid #ddd; padding: 5px; text-align: right;">Total Part Assureur</th>
                    <th style="border: 1px solid #ddd; padding: 5px; text-align: right;">Nombre de Factures</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let grandTotal = 0;
    let grandTotalFactures = 0;
    
    recapByAssurance.forEach(item => {
        recapHTML += `
            <tr>
                <td style="border: 1px solid #ddd; padding: 5px;">${item.Assurance}</td>
                <td style="border: 1px solid #ddd; padding: 5px; text-align: right;">${formatCurrency(item.TotalPartAssureur)}</td>
                <td style="border: 1px solid #ddd; padding: 5px; text-align: right;">${item.NbFactures}</td>
            </tr>
        `;
        grandTotal += item.TotalPartAssureur;
        grandTotalFactures += item.NbFactures;
    });
    
    // Ligne du total g√©n√©ral
    recapHTML += `
            <tr style="font-weight: bold; background-color: #e8e8e8;">
                <td style="border: 1px solid #ddd; padding: 5px;">TOTAL G√âN√âRAL</td>
                <td style="border: 1px solid #ddd; padding: 5px; text-align: right;">${formatCurrency(grandTotal)}</td>
                <td style="border: 1px solid #ddd; padding: 5px; text-align: right;">${grandTotalFactures}</td>
            </tr>
        </tbody>
    </table>
    `;

    // Ajouter les informations sur les filtres appliqu√©s
    let filtersInfo = `<div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #007bff;">`;
    filtersInfo += `<strong>Filtres appliqu√©s :</strong><br>`;
    if (dateStart) filtersInfo += `- Date d√©but: ${dateStart}<br>`;
    if (dateEnd) filtersInfo += `- Date fin: ${dateEnd}<br>`;
    if (dateDepot) filtersInfo += `- Date d√©p√¥t: ${dateDepot}<br>`;
    if (assurance) filtersInfo += `- Assurance: ${assurance}<br>`;
    if (compagnie) filtersInfo += `- Compagnie: ${compagnie}<br>`;
    if (!dateStart && !dateEnd && !dateDepot && !assurance && !compagnie) {
        filtersInfo += `- Aucun filtre appliqu√©<br>`;
    }
    filtersInfo += `</div>`;

    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 10px; font-size: 12px; }
            h1 { color: #333; text-align: center; margin-bottom: 5px; font-size: 16px; }
            h2 { color: #555; margin-top: 15px; font-size: 14px; }
            table { width: 100%; border-collapse: collapse; margin-top: 5px; }
            th, td { border: 1px solid #ddd; padding: 5px; text-align: left; }
            th { background-color: #f2f2f2; }
            .text-right { text-align: right; }
            @page { size: landscape; margin: 5mm; }
            @media print {
                body { margin: 0; padding: 0; }
            }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Point des Facturations</title>
                ${styles}
            </head>
            <body>
                <h1>Point des Facturations</h1>
                <p>Imprim√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${filtersInfo}
                ${printContent.outerHTML}
                ${recapHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.onload = function () {
    printWindow.focus();   // Met la fen√™tre au premier plan
    printWindow.print();   // Lance l'impression
    printWindow.close();   // Ferme la fen√™tre apr√®s impression
};

}

// Fonction pour filtrer les donn√©es (identique √† applyFacturationFilter mais retourne les donn√©es)
function filterData(data, dateStart, dateEnd, dateDepot, assurance, compagnie) {
    return data.filter(item => {
        // Conversion des dates en objets Date pour comparaison
        const itemDateDebut = item.DateDebut ? new Date(item.DateDebut) : null;
        const itemDateFin = item.DateFin ? new Date(item.DateFin) : null;
        const itemDateDepot = item.DateDepot ? new Date(item.DateDepot) : null;
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        const filterDateDepotObj = dateDepot ? new Date(dateDepot) : null;
        
        // V√©rification de la plage de dates
        let dateMatch = true;
        if (startDate && endDate) {
            dateMatch = (itemDateDebut >= startDate && itemDateDebut <= endDate) || 
                       (itemDateFin >= startDate && itemDateFin <= endDate);
        } else if (startDate) {
            dateMatch = itemDateDebut >= startDate || itemDateFin >= startDate;
        } else if (endDate) {
            dateMatch = itemDateDebut <= endDate || itemDateFin <= endDate;
        }

        let depotMatch = true;
        if (filterDateDepotObj && itemDateDepot) {
            // Compare seulement jour/mois/ann√©e (ignore l'heure)
            depotMatch = itemDateDepot.toDateString() === filterDateDepotObj.toDateString();
        }
        const assuranceMatch = !assurance || item.Assurance === assurance;
        const compagnieMatch = !compagnie || item.Compagnie === compagnie;
        
        return dateMatch && assuranceMatch && compagnieMatch && depotMatch;
    });
}

// Fonction pour calculer le r√©capitulatif par assurance
function calculateRecapByAssurance(data) {
    const recap = {};
    
    data.forEach(item => {
        if (!recap[item.Assurance]) {
            recap[item.Assurance] = {
                Assurance: item.Assurance,
                TotalPartAssureur: 0,
                NbFactures: 0
            };
        }
        
        recap[item.Assurance].TotalPartAssureur += item.PartAssureur;
        recap[item.Assurance].NbFactures += parseInt(item.NbFactures) || 0;
    });
    
    // Convertir l'objet en array et trier par nom d'assurance
    return Object.values(recap).sort((a, b) => a.Assurance.localeCompare(b.Assurance));
}

// Helper pour formater les montants (assurez-vous qu'elle existe)
function formatCurrency(amount) {
    return amount.toLocaleString('fr-FR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}
function openListeProduit() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay active" id="produitModal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-boxes modal-icon"></i> Liste des Produits
                    </h3>
                </div>
                <div class="modal-body">
                    <!-- Filtres -->
                    <div class="filters-panel">
                        <div class="filter-group">
                            <label for="filterCategorie">Cat√©gorie</label>
                            <select id="filterCategorie" class="form-select" onchange="applyProduitFilter()">
                                <option value="">Toutes les cat√©gories</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterFournisseur">Fournisseur</label>
                            <select id="filterFournisseur" class="form-select" onchange="applyProduitFilter()">
                                <option value="">Tous les fournisseurs</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterDisponible">Qt√© min.</label>
                            <input type="number" id="filterDisponible" class="form-control" placeholder="Quantit√© min..." min="0" oninput="applyProduitFilter()">
                        </div>
                        <div class="filter-group">
                            <label for="searchReference">Recherche R√©f√©rence</label>
                            <input type="text" id="searchReference" class="form-control" placeholder="Entrez une r√©f√©rence..." oninput="applyProduitFilter()">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-outline-secondary btn-icon" onclick="resetProduitFilter()">
                                <i class="fas fa-undo"></i> R√©initialiser
                            </button>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover produit-catalogue-table" id="produitTable">
                                <thead>
                                    <tr>
                                        <th>Date d'ajout</th>
                                        <th>Cat√©gorie</th>
                                        <th>R√©f√©rence</th>
                                        <th>Qt√©s Ajout√©</th>
                                        <th>Fournisseur</th>
                                        <th>Price </th>
                                        <th>Disponible</th>
                                        <th>Info</th>
                                        <th>IDs Client</th>
                                    </tr>
                                </thead>
                                <tbody id="produitData">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="produit-message" class="alert alert-info mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-icon" onclick="printProduitList()">
                        <i class="fas fa-print"></i> Imprimer la liste
                    </button>
                    <button type="button" class="btn btn-primary btn-icon" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    loadProduitData();
}

// Variables globales
let allProduitData = [];
let uniqueCategorie = [];
let uniqueFournisseur = [];

// Charger les donn√©es produits
async function loadProduitData() {
    const produitData = document.getElementById('produitData');
    const messageDiv = document.getElementById('produit-message');
    produitData.innerHTML = '<tr><td colspan="9" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importproduits`;
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const responseData = await response.json();
        if (!responseData?.data?.rows) throw new Error('Structure de donn√©es invalide');

        const headers = responseData.data.headers;
        allProduitData = responseData.data.rows.map(row => ({
            Date: row[headers.indexOf("Date d'ajout")] || '',
            Categorie: row[headers.indexOf('Cat√©gorie')] || '',
            Reference: row[headers.indexOf('R√©f√©rence')] || '',
            Quantite: row[headers.indexOf('Quantit√©')] || 0,
            Fournisseur: row[headers.indexOf('Fournisseur')] || '',
            Price: row[headers.indexOf('Prix de vente')] || '',
            Disponible: row[headers.indexOf('Disponible')] || '',
            Informations: row[headers.indexOf('Informations')] || '',
            ID: row[headers.indexOf('ID')] || ''
        }));

        uniqueCategorie = [...new Set(allProduitData.map(i => i.Categorie).filter(Boolean))];
        uniqueFournisseur = [...new Set(allProduitData.map(i => i.Fournisseur).filter(Boolean))];

        populateFiltreProduit('filterCategorie', uniqueCategorie);
        populateFiltreProduit('filterFournisseur', uniqueFournisseur);

        displayFilteredProduit(allProduitData);
    } catch (error) {
        console.error(error);
        showProduitMessage(`‚ùå Erreur: ${error.message}`, 'danger');
        produitData.innerHTML = '<tr><td colspan="9" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Peupler les filtres
function populateFiltreProduit(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">Tous</option>`;
    values.sort().forEach(value => {
        const option = document.createElement('option');
        option.value = String(value); // Convertir en string
        option.textContent = String(value); // Convertir en string
        select.appendChild(option);
    });
}

// Afficher les produits filtr√©s
function displayFilteredProduit(data) {
    const produitData = document.getElementById('produitData');
    if (!data?.length) {
        produitData.innerHTML = '<tr><td colspan="9" class="text-center">Aucun produit trouv√©</td></tr>';
        return;
    }
    produitData.innerHTML = data.map(item => `
        <tr>
            <td>${item.Date ? new Date(item.Date).toLocaleDateString('fr-FR') : ''}</td>
            <td>${item.Categorie}</td>
            <td>${item.Reference}</td>
            <td>${item.Quantite}</td>
            <td>${item.Fournisseur}</td>
            <td>${item.Price}</td>
            <td>${item.Disponible}</td>
            <td>${item.Informations}</td>
            <td>${item.ID}</td>
        </tr>
    `).join('');
}

// Filtres
function applyProduitFilter() {
    const categorie = document.getElementById('filterCategorie').value;
    const fournisseur = document.getElementById('filterFournisseur').value;
    const disponibleInput = document.getElementById('filterDisponible').value;
    const searchReference = document.getElementById('searchReference').value.toLowerCase();
    
    // Convertir la valeur de quantit√© en nombre, si vide alors null
    const quantiteMin = disponibleInput ? parseInt(disponibleInput) : null;
    
    const filteredData = allProduitData.filter(item => {
        // Convertir la quantit√© disponible en nombre pour la comparaison
        const quantiteDisponible = parseInt(item.Disponible) || 0;
        
        return (!categorie || item.Categorie === categorie) &&
               (!fournisseur || item.Fournisseur === fournisseur) &&
               (!quantiteMin || quantiteDisponible >= quantiteMin) &&
               (!searchReference || 
                (item.Reference && 
                 item.Reference.toString().toLowerCase().includes(searchReference)));
    });
    
    displayFilteredProduit(filteredData);
}

function resetProduitFilter() {
    document.getElementById('filterCategorie').value = '';
    document.getElementById('filterFournisseur').value = '';
    document.getElementById('filterDisponible').value = '';
    document.getElementById('searchReference').value = '';
    displayFilteredProduit(allProduitData);
    showProduitMessage(`‚Üª Affichage des ${allProduitData.length} produits`, 'info');
}

// Messages
function showProduitMessage(message, type) {
    const messageDiv = document.getElementById('produit-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}
// Impression
function printProduitList() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('produitTable').cloneNode(true);
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 15px; }
            h1 { color: #333; text-align: center; margin-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8em; }
            th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
            th { background-color: #f2f2f2; }
            @page { size: auto; margin: 5mm; orientation: landscape; }
        </style>
    `;
    printWindow.document.write(`
        <html>
            <head><title>Liste des Produits</title>${styles}</head>
            <body>
                <h1>Liste des Produits</h1>
                <p>Imprim√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.onload = function () {
    printWindow.focus();   // Met la fen√™tre au premier plan
    printWindow.print();   // Lance l'impression
    printWindow.close();   // Ferme la fen√™tre apr√®s impression
};
}

async function openDevis() {
    const modal = document.getElementById('proformaModal');
    
    // Afficher le loader
    document.getElementById('loaderOverlay').classList.add('active');
    
    try {
        await loadDataFromSheet();
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    } catch (error) {
        console.error("Erreur lors du chargement:", error);
        alert("Erreur lors du chargement des donn√©es");
    } finally {
        // Cacher le loader
        document.getElementById('loaderOverlay').classList.remove('active');
    }
}

// Fonction pour afficher un loader pendant la g√©n√©ration du PDF
async function generatePDFWithLoader() {
    const loader = document.getElementById('loaderOverlay');
    const loaderText = loader.querySelector('.loader-text');
    
    try {
        loaderText.textContent = 'G√©n√©ration du PDF en cours...';
        loader.classList.add('active');
        
        // Attendre un court d√©lai pour permettre l'affichage du loader
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Attendre la g√©n√©ration du PDF
        await generatePDF();
    } catch (error) {
        console.error("Erreur lors de la g√©n√©ration du PDF:", error);
        alert("Erreur lors de la g√©n√©ration du PDF: " + error.message);
    } finally {
        loader.classList.remove('active');
    }
}

document.getElementById('client-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Activer le loader d'envoi
    document.getElementById('submitLoader').classList.add('active');
    
    try {
        await generatePDF();
    } catch (error) {
        console.error("Erreur:", error);
        alert("Erreur lors de la g√©n√©ration du PDF");
    } finally {
        // D√©sactiver le loader d'envoi
        document.getElementById('submitLoader').classList.remove('active');
    }
});

// Calcul des totaux
document.addEventListener("DOMContentLoaded", function() {
    function calculerTotalPro() {
        const montantMonture = parseFloat(document.getElementById('montant_monture').value) || 0;
        const montantVerres = parseFloat(document.getElementById('montant_verres').value) || 0;
        const remise = parseFloat(document.getElementById('remise').value) || 0;
        const remiseType = document.getElementById('remise_type').value;

        const totalBrut = montantMonture + montantVerres;
        document.getElementById('total_brut').value = totalBrut.toFixed(2);

        let montantRemise = remiseType === '%' ? totalBrut * (remise / 100) : remise;
        const netAPayer = totalBrut - montantRemise;
        document.getElementById('net_a_payer').value = Math.max(0, netAPayer).toFixed(2);
    }

    // Rendre la fonction globale si n√©cessaire
    window.calculerTotalPro = calculerTotalPro;
});

function validateStep() {
    return true; // Valide toujours
}

function updateStepper(activeStep) {
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
        
        const stepNumber = parseInt(step.id.replace('step', ''));
        if (stepNumber < activeStep) {
            step.classList.add('completed');
        } else if (stepNumber == activeStep) {
            step.classList.add('active');
        }
    });
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', async () => {
    // Charger les donn√©es au premier affichage de la modale
    document.getElementById('proformaModal').addEventListener('click', async function(e) {
        if (e.target === this && !window.appDataCache) {
            await loadDataFromSheet();
        }
    });

    // Gestion du formulaire
    document.getElementById('client-form').addEventListener('submit', function(e) {
        e.preventDefault();
        generatePDF();
    });
});

async function generatePDF() {
    // R√©cup√©rer les donn√©es du formulaire
    const formData = {
        nom_complet: document.getElementById('nom_complet').value,
        contact: document.querySelector('input[name="indicatif"]').value + ' ' + 
        document.querySelector('input[name="numero"]').value,
        date_naissance: document.getElementById('date_naissance').value,
        civilite: document.getElementById('civilite').value,
        type_verre: document.getElementById('type_verre').value,
        gamme_verre: document.getElementById('gamme_verre').value,
        choix_monture: document.getElementById('choix_monture').value,
        od_sphere: document.querySelector('select[name="od_sphere"]').value,
        od_cylindre: document.querySelector('select[name="od_cylindre"]').value,
        od_axe: document.querySelector('select[name="od_axe"]').value,
        od_add: document.querySelector('select[name="od_add"]').value,
        og_sphere: document.querySelector('select[name="og_sphere"]').value,
        og_cylindre: document.querySelector('select[name="og_cylindre"]').value,
        og_axe: document.querySelector('select[name="og_axe"]').value,
        og_add: document.querySelector('select[name="og_add"]').value,
        date_soin: document.getElementById('date_soin').value,
        montant_monture: document.getElementById('montant_monture').value,
        montant_verres: document.getElementById('montant_verres').value,
        total_brut: document.getElementById('total_brut').value,
        remise: document.getElementById('remise').value,
        remise_type: document.getElementById('remise_type').value,
        net_a_payer: document.getElementById('net_a_payer').value
    };

    // Afficher un indicateur de chargement
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration en cours...';
    submitBtn.disabled = true;

    try {
        const url = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addproforma`;
        
        // Envoyer les donn√©es en no-cors
        await fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                formData: formData
            })
        });

        console.log("‚úÖ Donn√©es envoy√©es (mode no-cors)");

        // Attendre 3 secondes pour la g√©n√©ration du PDF
        setTimeout(() => {
          
            // Ouvrir le PDF
            checkAndOpenPDF();
            
        }, 3000);

    } catch (error) {
        console.log("‚ö†Ô∏è Erreur ignor√©e (mode no-cors):", error);
        
        // M√™me en cas d'erreur, fermer et ouvrir le PDF
        setTimeout(() => {
            checkAndOpenPDF();
            closeModal();
        }, 3000);
    } finally {
        // Restaurer le bouton (au cas o√π)
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    }
}

// Fonction unique pour r√©cup√©rer et ouvrir le PDF (version robuste)
async function checkAndOpenPDF() {
    try {
        console.log("üîç Recherche du PDF...");
        
        const url = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getlastpdf`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP! statut: ${response.status}`);
        }
        
        const result = await response.json();
        
        console.log("üìÑ R√©ponse API:", result);
        
        // V√©rifier les deux orthographes possibles (succ√®s/success)
        const isSuccess = result.succ√®s || result.success;
        const message = result.message || {};
        const isMessageSuccess = message.succ√®s || message.success;
        
        let pdfUrl = null;
        
        if (isSuccess && message && message.pdfUrl) {
            pdfUrl = message.pdfUrl;
            console.log("‚úÖ PDF trouv√©:", pdfUrl);
        } else if (message && isMessageSuccess === false) {
            console.warn("‚ö†Ô∏è Aucun PDF disponible:", message);
            alert("Le PDF est en cours de g√©n√©ration. Veuillez patienter quelques secondes puis r√©essayer.");
            return;
        } else {
            console.warn("‚ö†Ô∏è Structure de r√©ponse inattendue:", result);
            alert("Erreur inattendue lors de la g√©n√©ration du PDF.");
            return;
        }
        
        // Ouvrir le PDF
        if (pdfUrl) {
            console.log("üìÑ Ouverture du PDF:", pdfUrl);
            closeModal();
            window.open(pdfUrl, '_blank');
            alert("PDF g√©n√©r√© avec succ√®s! Ouverture dans un nouvel onglet.");
        }
        
    } catch (error) {
        console.error("‚ùå Erreur ouverture PDF:", error);
        alert("Erreur lors de l'ouverture du PDF: " + error.message);
    }
}

//fin proforma

    // Variables globales
    let allClientsData = [];
    let filteredClients = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let currentSortColumn = null;
    let currentSortDirection = 'asc';

    // Chargement des clients depuis l'API
async function loadClientsFromScript() {
    showLoading();

    const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=liste";

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const responseData = await response.json();
        
        console.log("R√©ponse API:", responseData); // Pour d√©bogage
        
        if (!responseData.success || !responseData.data) {
            throw new Error("R√©ponse inattendue de l'API");
        }

        const { headers, rows } = responseData.data;
        
        // V√©rification des donn√©es re√ßues
        console.log("En-t√™tes re√ßus:", headers);
        console.log("Premi√®re ligne re√ßue:", rows.length > 0 ? rows[0] : "Aucune donn√©e");
        
        if (!Array.isArray(headers) || !Array.isArray(rows)) {
            throw new Error("Structure de donn√©es invalide");
        }

        allClientsData = rows;
        filteredClients = [...allClientsData];
        
        renderTableHeaders(headers);
        updateTableAndPagination();

    } catch (error) {
        console.error("Erreur de chargement:", error);
        displayError(error.message || "Erreur lors du chargement des clients");
    } finally {
        hideLoading();
    }
}

    // Affichage des en-t√™tes du tableau
    function renderTableHeaders(headers) {
        const thead = document.querySelector("#client-table thead");
        thead.innerHTML = "";

        const tr = document.createElement("tr");

        headers.forEach((header, index) => {
            const th = document.createElement("th");
            th.textContent = header;
            th.setAttribute('data-column', index);
            th.addEventListener('click', () => sortTable(index));
            tr.appendChild(th);
        });

        thead.appendChild(tr);
    }

// Affichage des lignes du tableau
function renderTableRows(rows) {
    const tbody = document.querySelector("#client-table tbody");
    tbody.innerHTML = "";

    if (!rows || rows.length === 0) {
        // Cr√©ez un message "Aucune donn√©e" si n√©cessaire
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = document.querySelector("#client-table thead th").length;
        td.textContent = "Aucun client trouv√©";
        td.style.textAlign = "center";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    rows.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");

        row.forEach((cell, cellIndex) => {
            const td = document.createElement("td");

            // Formater la colonne 4 (index 3) comme date DD/MM/YYYY
            if (cellIndex === 3 && cell) {
                try {
                    const date = new Date(cell);
                    if (!isNaN(date.getTime())) {
                        // Formater en DD/MM/YYYY
                        const formattedDate = date.toLocaleDateString('fr-FR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        td.textContent = formattedDate;
                    } else {
                        td.textContent = cell; // Conserver la valeur originale si ce n'est pas une date valide
                    }
                } catch (error) {
                    console.error("Erreur de formatage de date:", error);
                    td.textContent = cell; // Conserver la valeur originale en cas d'erreur
                }
            } else if (cellIndex === 0) {
                const link = document.createElement("a");
                link.href = "#";
                link.className = "client-link";
                link.textContent = cell || "";
                link.onclick = (e) => {
                    e.preventDefault();
                    selectClient(row);
                };
                td.appendChild(link);
            } else {
                td.textContent = cell || "0";
            }
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });
}

    // S√©lection d'un client
    function selectClient(clientData) {
        localStorage.setItem("selectedClient", JSON.stringify(clientData));
        window.location.href = "DetailClient.html";
    }

    // Filtrage des clients
function applySearchFilter() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();

    if (!searchTerm) {
        filteredClients = [...allClientsData];
    } else {
        filteredClients = allClientsData.filter(client => {
            // Recherche dans la colonne 0 (ID) et colonne 1 (Nom)
            const idMatch = client[0]?.toLowerCase().includes(searchTerm);
            const nameMatch = client[1]?.toLowerCase().includes(searchTerm);
            return idMatch || nameMatch;
        });
    }

    currentPage = 1;
    updateTableAndPagination();
}

    // Tri du tableau
    function sortTable(columnIndex) {
        if (currentSortColumn === columnIndex) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = columnIndex;
            currentSortDirection = 'asc';
        }

        filteredClients.sort((a, b) => {
            const valA = a[columnIndex] ?? '';
            const valB = b[columnIndex] ?? '';

            if (currentSortDirection === 'asc') {
                return String(valA).localeCompare(String(valB));
            } else {
                return String(valB).localeCompare(String(valA));
            }
        });

        updateTableAndPagination();
    }

    // Mise √† jour de la pagination
    function updateTableAndPagination() {
        const totalItems = filteredClients.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
        const rowsToDisplay = filteredClients.slice(startIndex, endIndex);

        // Mise √† jour des informations de pagination
        const paginationInfo = document.querySelector(".pagination-info");
        if (paginationInfo) {
            paginationInfo.textContent = `Affichage de ${startIndex + 1} √† ${endIndex} sur ${totalItems} clients`;
        }

        // Mise √† jour des boutons de navigation
        document.getElementById("prevPage").disabled = currentPage <= 1;
        document.getElementById("nextPage").disabled = currentPage >= totalPages;

        // Affichage des donn√©es
        renderTableRows(rowsToDisplay);
    }

    // Navigation entre les pages
    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTableAndPagination();
        }
    }

    function goToNextPage() {
        const totalPages = Math.ceil(filteredClients.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateTableAndPagination();
        }
    }

    // Gestion des √©tats de chargement
    function showLoading() {
        document.getElementById("loading-indicator").style.display = "block";
        document.getElementById("error-message").style.display = "none";
        document.getElementById("table-container").style.display = "none";
    }

    function hideLoading() {
        document.getElementById("loading-indicator").style.display = "none";
        document.getElementById("table-container").style.display = "block";
    }

    function displayError(message) {
        document.getElementById("error-message").textContent = message;
        document.getElementById("error-message").style.display = "block";
    }

    // Global function to close any active modal

async function fetchDataFromGoogleSheet() {
    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getconfigdata');

        if (!response.ok) {
            throw new Error(`Erreur HTTP! statut: ${response.status}`);
        }

        const responseData = await response.json();
        console.log("R√©ponse compl√®te:", responseData); // Pour d√©bogage
        
        // Modification ici: v√©rifier responseData.data au lieu de responseData
        if (!responseData.success || !responseData.data) {
            throw new Error(responseData.message || "R√©ponse inattendue de l'API");
        }

        // Modification ici: acc√©der aux donn√©es via responseData.data
        const { categories, agences } = responseData.data;
        
        // V√©rification des donn√©es requises
        if (!categories || !agences) {
            throw new Error("Structure de donn√©es incompl√®te");
        }

        console.log("Cat√©gories re√ßues:", categories);
        console.log("Agences re√ßues:", agences);

        return {
            success: true,
            categories: categories,
            agences: agences
        };

    } catch (error) {
        console.error("Erreur fetchDataFromGoogleSheet:", error);
        throw error;
    }
}
// Function to fetch categories from Google Sheets
window.openDepense = async function() {
    const modalContainer = document.getElementById('modal-container');

    // Afficher un loader pendant le chargement
    modalContainer.innerHTML = `
        <div class="modal-overlay active" id="loadingModal">
            <div class="modal-content" style="text-align: center; padding: 2rem;">
                <div class="loading-spinner"></div>
                <p>Chargement des donn√©es...</p>
            </div>
        </div>
    `;

    try {
        // R√©cup√©rer les donn√©es de configuration
        const { categories, agences } = await fetchDataFromGoogleSheet();

        const modalHTML = `
            <div class="modal-overlay" id="depenseModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Ajouter une D√©pense</h3>
                    </div>
                    <div class="modal-body">
                        <form id="depenseForm">
                            <div class="form-group">
                                <label for="depenseDate">Date <span class="required">*</span></label>
                                <input type="date" id="depenseDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="depenseAgence">Agence <span class="required">*</span></label>
                                <select id="depenseAgence" class="form-control select-control" required>
                                    <option value="">S√©lectionner une agence</option>
                                    ${agences.map(agence =>
                                        `<option value="${agence}">${agence}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="depenseDesignation">D√©signation <span class="required">*</span></label>
                                <input type="text" id="depenseDesignation" class="form-control" placeholder="Description de la d√©pense" required>
                            </div>
                            <div class="form-group">
                                <label for="depenseCategorie">Cat√©gorie <span class="required">*</span></label>
                                <select id="depenseCategorie" class="form-control select-control" required>
                                    <option value="">S√©lectionner une cat√©gorie</option>
                                    ${categories.map(cat =>
                                        `<option value="${cat.value}">${cat.label}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="depenseMontant">Montant (FCFA) <span class="required">*</span></label>
                                <input type="number" id="depenseMontant" class="form-control" placeholder="0" required>
                            </div>
                            
                            <div id="form-message" class="form-message"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                        <button type="button" class="btn btn-primary" onclick="submitDepense()">Enregistrer</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.innerHTML = modalHTML;

        // Afficher la modal
        setTimeout(() => {
            document.getElementById('depenseModal').classList.add('active');
            document.getElementById('depenseDate').value = new Date().toISOString().split('T')[0];
        }, 10);

    } catch (error) {
        console.error("Erreur:", error);
        modalContainer.innerHTML = `
            <div class="modal-overlay active" id="errorModal">
                <div class="modal-content" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-color); font-size: 2rem; margin-bottom: 1rem;"></i>
                    <h4>Erreur de chargement</h4>
                    <p>Impossible de charger les donn√©es n√©cessaires depuis le tableur.</p>
                    <p><strong>D√©tails :</strong> ${error.message}</p>
                    <button class="btn btn-danger" onclick="closeModal()">Fermer</button>
                </div>
            </div>
        `;
    }
};
    // Function to submit the expense
async function submitDepense() {
    const form = document.getElementById('depenseForm');
    const formMessage = document.getElementById('form-message');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    // Validation am√©lior√©e
    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires correctement.';
        formMessage.classList.add('error');
        
        // Highlight des champs invalides
        const invalidFields = form.querySelectorAll(':invalid');
        invalidFields.forEach(field => {
            field.classList.add('input-error');
            field.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.classList.remove('input-error');
                }
            });
        });
        
        return;
    }

    const depenseData = {
        date: document.getElementById('depenseDate').value,
        agence: document.getElementById('depenseAgence').value,
        designation: document.getElementById('depenseDesignation').value.trim(),
        categorie: document.getElementById('depenseCategorie').value,
        montant: parseFloat(document.getElementById('depenseMontant').value)
    };

    // Validation suppl√©mentaire
if (isNaN(depenseData.montant)) {
    formMessage.textContent = 'Veuillez entrer un montant valide.';
    formMessage.classList.add('error');
    document.getElementById('depenseMontant').classList.add('input-error');
    return;
}

    const submitButton = document.querySelector('#depenseModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addDepense";

            await fetch(apiUrl, {
              method: 'POST',
              mode: 'no-cors',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(depenseData)
            });

        // Succ√®s
        formMessage.textContent = '‚úÖ D√©pense enregistr√©e avec succ√®s!';
        formMessage.classList.add('success');
        
        // R√©initialiser le formulaire apr√®s succ√®s
        form.reset();
        
        // Fermer apr√®s 1.5s
        setTimeout(() => {
            closeModal();
            // Rafra√Æchir les donn√©es si n√©cessaire
            if (typeof refreshExpenses === 'function') {
                refreshExpenses();
            }
        }, 1500);

    } catch (error) {
        console.error("Erreur:", error);
        formMessage.innerHTML = `‚ùå ${error.message || "Une erreur est survenue lors de l'enregistrement"}`;
        logError(`D√©pense: ${errorMsg}`);
        formMessage.classList.add('error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';
    }
}


// URL pour soumettre les donn√©es
const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addCommandeClient";

let currentStep = 1;
const totalSteps = 4;

// Fonction pour ouvrir la modal de nouvelle vente
function openNewSale() {
    // V√©rifier si la modal existe d√©j√†
    let modal = document.getElementById('newSaleModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'newSaleModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Nouvelle Vente</h3>
                </div>
                <div class="modal-body">
                    <form id="client-form" method="POST">
                        <input type="hidden" name="source" value="web_form">
                        
                        <!-- Indicateur d'√©tapes -->
                        <div class="step-indicator">
                            <div class="step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-label">Informations Client</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-label">Prescription & Commande</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-number">3</div>
                                <div class="step-label">Paiement</div>
                            </div>
                            <div class="step" data-step="4">
                                <div class="step-number">4</div>
                                <div class="step-label">Tier Payant & Livraison</div>
                            </div>
                            <div class="step-progress">
                                <div class="step-progress-bar" id="stepProgressBar"></div>
                            </div>
                        </div>

                        <!-- √âtape 1: Informations Client -->
                        <div id="step-1" class="form-step active">
                            <h2 class="section-title">Informations Client</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="nom_complet" class="required-field">Nom complet</label>
                                    <input type="text" name="nom_complet" id="nom_complet" class="form-control" required />
                                </div>

                                <div class="form-group">
                                    <label for="numero" class="required-field">T√©l√©phone</label>
                                    <input type="text" name="indicatif" id="indicatif" placeholder="+229" value="+229" style="width: 70px;" required/>
                                    <input type="tel" name="numero" id="numero" class="form-control" placeholder="0142749795" required />
                                </div>

                                <div class="form-group">
                                    <label for="date_naissance" class="required-field">Date de naissance</label>
                                    <input type="date" name="date_naissance" id="date_naissance" class="form-control" required />
                                </div>

                                <div class="form-group">
                                    <label for="civilite" class="required-field">Civilit√©</label>
                                    <select name="civilite" id="civilite" class="form-control" required>
                                        <option value="M.">M.</option>
                                        <option value="Mme">Mme</option>
                                        <option value="Mlle">Mlle</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="entreprise">Entreprise</label>
                                    <div class="select-with-input">
                                        <select name="entreprise" id="entreprise" class="form-control">
                                            <option value="">-- Choisir --</option>
                                        </select>
                                        <input type="text" id="entreprise_input" class="form-control" style="display: none; margin-top: 5px;" 
                                               placeholder="Nouvelle entreprise">
                                    </div>
                                    <button type="button" class="btn btn-small" onclick="toggleInput('entreprise')" 
                                            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                        <i class="fas fa-plus"></i> Ajouter nouvelle
                                    </button>
                                </div>

                                <div class="form-group">
                                    <label for="agence" class="required-field">Agence</label>
                                    <select name="agence" id="agence" class="form-control" required>
                                        <option value="">-- Choisir --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="commercial">Commercial</label>
                                    <div class="select-with-input">
                                        <select name="commercial" id="commercial" class="form-control">
                                            <option value="">-- Choisir --</option>
                                        </select>
                                        <input type="text" id="commercial_input" class="form-control" style="display: none; margin-top: 5px;" 
                                               placeholder="New commercial">
                                    </div>
                                    
                                    <button type="button" class="btn btn-small" onclick="toggleInput('commercial')" 
                                            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                        <i class="fas fa-plus"></i> Ajouter nouvelle
                                    </button>
                                </div>
                                <div class="form-group">
                                    <label for="current_user" class="required-field">Utilisateur</label>
                                    <input type="text" name="current_user" id="current_user" class="form-control" readonly 
                                           style="background-color: #f0f0f0; cursor: not-allowed;">
                                </div>
                            </div>
                        </div>

                        <!-- √âtape 2: Prescription & Commande -->
                        <div id="step-2" class="form-step">
                            <h2 class="section-title">Prescription M√©dicale</h2>
                            
                            <table class="prescription-table">
                                <thead>
                                    <tr>
                                        <th>≈íil</th>
                                        <th>Sphere</th>
                                        <th>Cylindre</th>
                                        <th>Axe</th>
                                        <th>ADD</th>
                                        <th>DP</th>
                                        <th>Hauteur</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- OD -->
                                    <tr>
                                        <td>OD</td>
                                        <td>
                                            <select name="od_sphere" required>
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_cylindre">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_axe">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_add">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="od_dp" value="0" min="0">
                                        </td>
                                        <td>
                                            <input type="number" name="od_hauteur" value="0" min="0">
                                        </td>
                                    </tr>

                                    <!-- OG -->
                                    <tr>
                                        <td>OG</td>
                                        <td>
                                            <select name="og_sphere" required>
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_cylindre">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_axe">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_add">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="og_dp" value="0" min="0">
                                        </td>
                                        <td>
                                            <input type="number" name="og_hauteur" value="0" min="0">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="clinique">Clinique</label>
                                    <div class="select-with-input">
                                        <select name="clinique" id="clinique" class="form-control">
                                            <option value="">-- Choisir --</option>
                                            <!-- Options existantes seront ajout√©es dynamiquement -->
                                        </select>
                                        <input type="text" id="clinique_input" class="form-control" style="display: none; margin-top: 5px;" 
                                               placeholder="Nouvelle clinique">
                                    </div>
                                    <button type="button" class="btn btn-small" onclick="toggleInput('clinique')" 
                                            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                        <i class="fas fa-plus"></i> Ajouter nouvelle
                                    </button>
                                </div>
                                
                                <div class="form-group">
                                    <label for="ophtalmo">Ophtalmologue</label>
                                    <div class="select-with-input">
                                        <select name="ophtalmo" id="ophtalmo" class="form-control">
                                            <option value="">-- Choisir --</option>
                                            <!-- Options existantes seront ajout√©es dynamiquement -->
                                        </select>
                                        <input type="text" id="ophtalmo_input" class="form-control" style="display: none; margin-top: 5px;" 
                                               placeholder="Nouvel ophtalmologue">
                                    </div>
                                    <button type="button" class="btn btn-small" onclick="toggleInput('ophtalmo')"
                                            style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                        <i class="fas fa-plus"></i> Ajouter nouveau
                                    </button>
                                </div>
                                
                                <div class="form-group">
                                    <label for="date_soin">Date de soin</label>
                                    <input type="date" name="date_soin" id="date_soin" class="form-control" />
                                </div>
                            </div>

                            <h2 class="section-title" style="margin-top: 2rem;">D√©tails de la Commande</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="type_verre" class="required-field">Type de Verre</label>
                                    <select name="type_verre" id="type_verre" class="form-control" required>
                                        <option value="">-- Type de Verre --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="gamme_verre" class="required-field">Gamme des Verres</label>
                                    <select name="gamme_verre" id="gamme_verre" class="form-control" required>
                                        <option value="">-- Gamme --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="choix_monture" class="required-field">Choix de Monture</label>
                                    <select name="choix_monture" id="choix_monture" class="form-control" required>
                                        <option value="">-- Choix de Monture --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- √âtape 3: Paiement -->
                        <div id="step-3" class="form-step">
                            <h2 class="section-title">D√©tails de Paiement</h2>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label required-field">Montant Monture (FCFA)</label>
                                        <input type="number" class="form-control" name="montant_monture" id="montant_monture" required oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label required-field">Montant Verres (FCFA)</label>
                                        <input type="number" class="form-control" name="montant_verres" id="montant_verres" required oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Frais de livraison (FCFA)</label>
                                        <input type="number" class="form-control" name="frais_livraison" id="frais_livraison" value="0" oninput="calculerTotal()" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label">Total Brut (FCFA)</label>
                                        <div class="payment-value" id="total_brut_display">0</div>
                                        <input type="hidden" name="total_brut" id="total_brut" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Remise</label>
                                        <div class="discount-selector">
                                            <input type="number" class="form-control discount-amount" name="remise" id="remise" value="0" oninput="calculerTotal()" />
                                            <select class="form-control discount-type" name="remise_type" id="remise_type" onchange="calculerTotal()">
                                                <option value="FCFA">FCFA</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Part Assurance (FCFA)</label>
                                        <input type="number" class="form-control" name="part_assurance" id="part_assurance" value="0" oninput="calculerTotal()" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label">Net √† payer (FCFA)</label>
                                        <div class="payment-value" id="net_a_payer_display">0</div>
                                        <input type="hidden" name="net_a_payer" id="net_a_payer" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Acompte (FCFA)</label>
                                        <input type="number" class="form-control" name="acompte" id="acompte" value="0" oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Reste √† payer (FCFA)</label>
                                        <div class="payment-value" id="reste_a_payer_display">0</div>
                                        <input type="hidden" name="reste_a_payer" id="reste_a_payer" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- √âtape 4: Tier Payant & Livraison -->
                        <div id="step-4" class="form-step">
                        <h2 class="section-title">Tier Payant</h2>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="assurance">Assurance</label>
                                <div class="select-with-input">
                                    <select name="assurance" id="assurance" class="form-control" style="display: none;">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                    <input type="text" id="assurance_input" class="form-control" 
                                          placeholder="Nom de l'assurance">
                                </div>
                                <button type="button" class="btn btn-small" onclick="toggleInput('assurance')" 
                                        style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                    <i class="fas fa-exchange-alt"></i> Choisir dans la liste
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label for="compagnie">Compagnie</label>
                                <div class="select-with-input">
                                    <select name="compagnie" id="compagnie" class="form-control" style="display: none;">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                    <input type="text" id="compagnie_input" class="form-control" 
                                          placeholder="Nom de la compagnie">
                                </div>
                                <button type="button" class="btn btn-small" onclick="toggleInput('compagnie')"
                                        style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                                    <i class="fas fa-exchange-alt"></i> Choisir dans la liste
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label for="numero_police">N¬∞ Police</label>
                                <input type="text" name="numero_police" id="numero_police" class="form-control" placeholder="Num√©ro de police d'assurance" />
                            </div>
                            
                                <div class="form-group">
                                    <label for="taux_couverture">Taux de couverture (%)</label>
                                    <input type="number" name="taux_couverture" id="taux_couverture" class="form-control" placeholder="Ex: 80" min="0" max="100" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="assure_principal">Assur√© Principal</label>
                                    <select name="assure_principal" id="assure_principal" class="form-control">
                                        <option value="">-- Choisir --</option>
                                        <option value="oui">Oui</option>
                                        <option value="non">Non</option>
                                    </select>
                                </div>

                                <div class="form-group" id="assure_principal_nom_container" style="display: none;">
                                    <label class="required-field">Nom complet de l'assur√© principal</label>
                                    <input type="text" name="assure_principal_nom" id="assure_principal_nom" class="form-control" />
                                </div>
                            </div>

                        <!-- Nouvelle section pour la modification des montants assurance -->
                        <div class="form-grid" id="modification_montants_section" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
                            <div class="form-group" style="grid-column: span 3;">
                                <label>Souhaitez-vous modifier les montants pour l'assurance ?</label>
                                <div class="radio-group" style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                    <label class="radio-label">
                                        <input type="radio" name="modifier_montants" value="oui" onchange="toggleChampsMontantsAssurance(true)"> Oui
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="modifier_montants" value="non" checked onchange="toggleChampsMontantsAssurance(false)"> Non
                                    </label>
                                </div>
                            </div>

                            <div id="champs_montants_assurance" style="display: none; grid-column: span 3;">
                                <div class="payment-card">
                                    <h4 style="margin-bottom: 1rem; color: #333;">R√©partition des montants assurance</h4>
                                    <div class="payment-row">
                                        <div class="payment-group">
                                            <label class="payment-label required-field">Part du client (FCFA)</label>
                                            <input type="number" class="form-control" name="part_client_assurance" id="part_client_assurance" 
                                                  value="0" oninput="calculerTotalAssurance()" />
                                        </div>
                                        
                                        <div class="payment-group">
                                            <label class="payment-label required-field">Part assureur (FCFA)</label>
                                            <input type="number" class="form-control" name="part_assureur" id="part_assureur" 
                                                  value="0" oninput="calculerTotalAssurance()" />
                                        </div>
                                        
                                        <div class="payment-group">
                                            <label class="payment-label">Montant total assurance (FCFA)</label>
                                            <div class="payment-value" id="montant_total_assurance_display">0</div>
                                            <input type="hidden" name="montant_total_assurance" id="montant_total_assurance" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h2 class="section-title" style="margin-top: 2rem;">Informations de Livraison</h2>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required-field">Date de livraison pr√©vue</label>
                                <input type="date" class="form-control" name="date_livraison" id="date_livraison" required />
                            </div>
                            
                            <div class="form-group">
                                <label class="required-field">Personne √† contacter</label>
                                <select class="form-control" name="contact_livraison_type" id="contact_livraison_type" required>
                                    <option value="">-- Choisir --</option>
                                    <option value="client">Lui-m√™me</option>
                                    <option value="tiers">Tier Personne</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="required-field">T√©l√©phone du contact</label>
                                <input type="tel" class="form-control" name="telephone_contact" id="telephone_contact" required />
                            </div>
                            
                            <div class="form-group" style="grid-column: span 2">
                                <label class="required-field">Adresse de livraison</label>
                                <textarea class="form-control" name="adresse_livraison" id="adresse_livraison" rows="3" required></textarea>
                            </div>
                            
                            <div class="form-group" style="grid-column: span 2">
                                <label>Informations compl√©mentaires</label>
                                <textarea class="form-control" name="infos_complementaires" id="infos_complementaires" rows="3"></textarea>
                            </div>
                        </div>
                        </div>
                        <!-- Navigation entre les √©tapes -->
                        <div class="step-navigation">
                            <div class="nav-group">
                                <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;">
                                    <i class="fas fa-arrow-left"></i> Pr√©c√©dent
                                </button>
                            </div>
                            
                            <div class="nav-group">
                                <button type="button" class="btn btn-outline" id="resetButton">
                                    <i class="fas fa-undo"></i> R√©initialiser
                                </button>
                                <button type="button" class="btn btn-outline" id="cancelButton">
                                    <i class="fas fa-times"></i> Annuler
                                </button>
                            </div>
                            
                            <div class="nav-group">
                                <button type="button" class="btn btn-primary" id="nextStepBtn">
                                    Suivant <i class="fas fa-arrow-right"></i>
                                </button>
                                <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                                    <i class="fas fa-check"></i> Ajouter
                                </button>
                            </div>
                        </div>

                        <style>
                        .step-navigation {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            gap: 1rem;
                            margin-top: 2rem;
                            padding-top: 1.5rem;
                            border-top: 1px solid #eee;
                            flex-wrap: wrap;
                        }

                        .nav-group {
                            display: flex;
                            gap: 0.75rem;
                            flex-wrap: wrap;
                        }

                        .btn-outline {
                            background: white;
                            border: 1px solid #ddd;
                            color: #555;
                        }

                        .btn-outline:hover {
                            background: #f5f5f5;
                        }

                        .btn-success {
                            background-color: #4ade80;
                        }

                        .btn-success:hover {
                            background-color: #3bc46d;
                        }

                        @media (max-width: 768px) {
                            .step-navigation {
                                flex-direction: column-reverse;
                            }
                            
                            .nav-group {
                                width: 100%;
                                justify-content: space-between;
                            }
                        }
                        </style>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Afficher la modal
    modal.classList.add('active');
    
    // Initialiser la modal
    initModal();
};

 
 // URL de votre Web App Google Apps Script
const DATA_SOURCE_URL = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=catalogue';   // Initialisation de la modal
function initModal() {
    // Configurer les √©v√©nements
    setupEventListeners();
    
    // Calcul initial
    calculerTotal();
    
    // Charger les donn√©es depuis Google Sheets
    loadDataFromSheet();
    
    // Mettre √† jour l'affichage des √©tapes
    updateStepDisplay();
    setupCurrentUserField();
     // Ajouter les √©couteurs pour les champs assurance
    const champsAssurance = ['assurance', 'assurance_input', 'compagnie', 'compagnie_input', 'numero_police'];
    champsAssurance.forEach(champ => {
        const element = document.getElementById(champ);
        if (element) {
            element.addEventListener('input', verifierAffichageModificationMontants);
            element.addEventListener('change', verifierAffichageModificationMontants);
        }
    });
    
    // Initialiser l'affichage
    verifierAffichageModificationMontants();
}

// Fonction pour calculer les parts assurance bas√©es sur le taux de couverture
function calculerPartsAssurance() {
    const tauxCouverture = parseFloat(document.getElementById('taux_couverture').value) || 0;
    const netAPayer = parseFloat(document.getElementById('net_a_payer').value) || 0;
    
    if (tauxCouverture > 0 && netAPayer > 0) {
        const partAssureur = (netAPayer * tauxCouverture) / 100;
        const partClient = netAPayer - partAssureur;
        
        document.getElementById('part_assureur').value = Math.round(partAssureur);
        document.getElementById('part_client_assurance').value = Math.round(partClient);
        calculerTotalAssurance();
    }
}

// Fonction pour afficher/masquer le champ nom de l'assur√© principal
function toggleAssurePrincipalNom() {
    const assurePrincipal = document.getElementById('assure_principal');
    const nomContainer = document.getElementById('assure_principal_nom_container');
    
    if (assurePrincipal && nomContainer) {
        if (assurePrincipal.value === 'non') {
            nomContainer.style.display = 'block';
        } else {
            nomContainer.style.display = 'none';
            document.getElementById('assure_principal_nom').value = '';
        }
    }
}

// Fonction pour calculer le total assurance
function calculerTotalAssurance() {
    const partClient = parseFloat(document.getElementById('part_client_assurance').value) || 0;
    const partAssureur = parseFloat(document.getElementById('part_assureur').value) || 0;
    const totalAssurance = partClient + partAssureur;
    
    // Utiliser formatNumber si disponible, sinon afficher directement
    try {
        document.getElementById('montant_total_assurance_display').textContent = formatNumber(totalAssurance);
    } catch (e) {
        document.getElementById('montant_total_assurance_display').textContent = totalAssurance;
    }
    document.getElementById('montant_total_assurance').value = totalAssurance;
}

// Fonction pour afficher/masquer les champs de modification des montants
function toggleChampsMontantsAssurance(afficher) {
    const champsMontants = document.getElementById('champs_montants_assurance');
    
    if (afficher) {
        champsMontants.style.display = 'block';
        // Initialiser les valeurs √† 0
        document.getElementById('part_client_assurance').value = '0';
        document.getElementById('part_assureur').value = '0';
        calculerTotalAssurance();
    } else {
        champsMontants.style.display = 'none';
        // R√©initialiser les valeurs
        document.getElementById('part_client_assurance').value = '0';
        document.getElementById('part_assureur').value = '0';
        calculerTotalAssurance();
    }
}

// Fonction pour afficher la section modification montants si assurance renseign√©e
function verifierAffichageModificationMontants() {
    const assurance = document.getElementById('assurance').value || document.getElementById('assurance_input').value;
    const compagnie = document.getElementById('compagnie').value || document.getElementById('compagnie_input').value;
    const numeroPolice = document.getElementById('numero_police').value;
    
    const sectionModification = document.getElementById('modification_montants_section');
    
    if (assurance || compagnie || numeroPolice) {
        sectionModification.style.display = 'grid';
    } else {
        sectionModification.style.display = 'none';
        document.getElementById('champs_montants_assurance').style.display = 'none';
        // D√©cocher "Oui" si cach√©
        const ouiRadio = document.querySelector('input[name="modifier_montants"][value="oui"]');
        const nonRadio = document.querySelector('input[name="modifier_montants"][value="non"]');
        if (ouiRadio && nonRadio) {
            ouiRadio.checked = false;
            nonRadio.checked = true;
        }
    }
}

// Mettre √† jour l'affichage des √©tapes
function updateStepDisplay() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    // Masquer toutes les √©tapes
    modal.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Afficher l'√©tape actuelle
    const currentStepElement = modal.querySelector(`#step-${currentStep}`);
    if (currentStepElement) {
        currentStepElement.classList.add('active');
    }
    
    // Mettre √† jour l'indicateur d'√©tapes
    modal.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
        const stepNumber = parseInt(step.getAttribute('data-step'));
        
        if (stepNumber === currentStep) {
            step.classList.add('active');
        } else if (stepNumber < currentStep) {
            step.classList.add('completed');
        }
    });
    
    // Mettre √† jour la barre de progression
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    const progressBar = modal.querySelector('#stepProgressBar');
    if (progressBar) {
        progressBar.style.width = `${progressPercentage}%`;
    }
    
    // G√©rer les boutons de navigation
    const prevBtn = modal.querySelector('#prevStepBtn');
    const nextBtn = modal.querySelector('#nextStepBtn');
    const submitBtn = modal.querySelector('#submitBtn');
    
    if (prevBtn) {
        prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
    }
    
    if (nextBtn && submitBtn) {
        if (currentStep < totalSteps) {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        } else {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        }
    }
}

// Aller √† l'√©tape suivante
function nextStep() {
    if (!validateStep(currentStep)) return;
    
    if (currentStep < totalSteps) {
        currentStep++;
        updateStepDisplay();
        const modal = document.getElementById('newSaleModal');
        if (modal) {
            modal.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
}

// Revenir √† l'√©tape pr√©c√©dente
function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
        const modal = document.getElementById('newSaleModal');
        if (modal) {
            modal.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
}

// Valider l'√©tape actuelle
function validateStep(step) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return false;
    
    let isValid = true;
    const highlightError = (element) => {
        if (element) {
            element.style.borderColor = 'var(--danger-color)';
            setTimeout(() => {
                element.style.borderColor = '';
            }, 2000);
        }
    };
    
    // Validation pour l'√©tape 1 (Informations Client)
    if (step === 1) {
        const requiredFields = [
            'nom_complet', 'numero', 'date_naissance', 
            'civilite', 'agence', 'commercial'
        ];
        
        for (const fieldId of requiredFields) {
            const field = modal.querySelector(`#${fieldId}`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        if (!isValid) {
            showError('Veuillez remplir tous les champs obligatoires');
        }
    }
    
    // Validation pour l'√©tape 2 (Prescription)
    if (step === 2) {
        const requiredFields = ['od_sphere', 'og_sphere'];
        
        for (const fieldName of requiredFields) {
            const field = modal.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        if (!isValid) {
            showError('Veuillez remplir les champs obligatoires de la prescription');
        }
    }
    
    // Validation pour l'√©tape 3 (Commande)
    if (step === 3) {
        const requiredFields = ['type_verre', 'gamme_verre', 'choix_monture'];
        
        for (const fieldId of requiredFields) {
            const field = modal.querySelector(`#${fieldId}`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        if (!isValid) {
            showError('Veuillez s√©lectionner le type de verre, la gamme et la monture');
        }
    }
    
    // Validation pour l'√©tape 6 (Livraison)
    if (step === 6) {
        const requiredFields = [
            'date_livraison', 'contact_livraison_type', 
            'telephone_contact', 'adresse_livraison'
        ];
        
        for (const fieldId of requiredFields) {
            const field = modal.querySelector(`#${fieldId}`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        if (!isValid) {
            showError('Veuillez remplir tous les champs obligatoires pour la livraison');
        }
    }
    
    return isValid;
}

// Configuration des √©v√©nements
function setupEventListeners() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    // Boutons de navigation
    const nextBtn = modal.querySelector('#nextStepBtn');
    const prevBtn = modal.querySelector('#prevStepBtn');
    
    if (nextBtn) nextBtn.addEventListener('click', nextStep);
    if (prevBtn) prevBtn.addEventListener('click', prevStep);
    
    // Boutons d'action
    const resetBtn = modal.querySelector('#resetButton');
    const cancelBtn = modal.querySelector('#cancelButton');
    const form = modal.querySelector('#client-form');
    
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment r√©initialiser le formulaire ?')) {
                form.reset();
                const nomComplet = modal.querySelector('#nom_complet');
                if (nomComplet) nomComplet.focus();
                calculerTotal();
                showSuccess('Formulaire r√©initialis√© avec succ√®s !');
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment annuler et fermer le formulaire ?')) {
                closeModal();
            }
        });
    }
    
    // Calcul automatique pour tous les champs pertinents
    const calcFields = [
        'montant_monture', 'montant_verres', 'frais_livraison',
        'remise', 'part_assurance', 'acompte'
    ];
    calcFields.forEach(id => {
        const field = modal.querySelector(`#${id}`);
        if (field) field.addEventListener('input', calculerTotal);
    });
    
    // √âcouteur pour le type de remise (FCFA ou %)
    const remiseType = modal.querySelector('#remise_type');
    if (remiseType) remiseType.addEventListener('change', calculerTotal);
    
    // Synchronisation automatique de l'ADD OD vers OG
    const odAdd = modal.querySelector('[name="od_add"]');
    if (odAdd) {
        odAdd.addEventListener('change', function() {
            const odAddValue = this.value;
            const ogAddSelect = modal.querySelector('[name="og_add"]');
            if (odAddValue && ogAddSelect) {
                ogAddSelect.value = odAddValue;
            }
        });
    }
    
    // Gestion de l'affichage conditionnel pour l'assur√© principal
    const assurePrincipal = modal.querySelector('#assure_principal');
    if (assurePrincipal) {
        assurePrincipal.addEventListener('change', function() {
            const container = modal.querySelector('#assure_principal_nom_container');
            const input = modal.querySelector('#assure_principal_nom');
            const nomComplet = modal.querySelector('#nom_complet');
            
            if (!container || !input) return;
            
            if (this.value === 'oui') {
                container.style.display = 'block';
                input.value = nomComplet?.value || '';
                input.readOnly = true;
                input.style.backgroundColor = '#f0f0f0';
            } else if (this.value === 'non') {
                container.style.display = 'block';
                input.readOnly = false;
                input.style.backgroundColor = '';
                input.value = '';
            } else {
                container.style.display = 'none';
            }
        });
    }
    
    // Gestion du type de contact pour la livraison
    const contactLivraisonType = modal.querySelector('#contact_livraison_type');
    if (contactLivraisonType) {
        contactLivraisonType.addEventListener('change', function() {
            const telephoneContact = modal.querySelector('#telephone_contact');
            const adresseLivraison = modal.querySelector('#adresse_livraison');
            const clientTel = modal.querySelector('#numero')?.value || '';
            const agence = modal.querySelector('#agence')?.value || '';
            
            if (!telephoneContact || !adresseLivraison) return;
            
            if (this.value === 'client') {
                telephoneContact.value = clientTel;
                telephoneContact.readOnly = true;
                telephoneContact.style.backgroundColor = '#f0f0f0';
                
                if (agence) {
                    const adressesAgences = agence
                    
                    adresseLivraison.value = adressesAgences[agence] || agence;
                    adresseLivraison.readOnly = true;
                    adresseLivraison.style.backgroundColor = '#f0f0f0';
                    const fraisLivraison = modal.querySelector('#frais_livraison');
                    if (fraisLivraison) fraisLivraison.value = 0;
                    calculerTotal();
                }
            } else if (this.value === 'tiers') {
                telephoneContact.readOnly = false;
                telephoneContact.style.backgroundColor = '';
                if (telephoneContact.value === clientTel) {
                    telephoneContact.value = '';
                }
                
                adresseLivraison.readOnly = false;
                adresseLivraison.style.backgroundColor = '';
                adresseLivraison.value = '';
            }
        });
    }

    // Soumission du formulaire
    if (form) {
        showSubmitButton();
        console.log('Formulaire trouv√©, ajout de l\'√©couteur d\'√©v√©nement submit');
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Validation rapide du formulaire
            if (!modal.querySelector('#nom_complet')?.value) {
                showError('Veuillez renseigner le nom complet du client');
                return;
            }
                // Afficher la bo√Æte de confirmation
                const confirmation = await showConfirmation(
                    'Confirmer la vente',
                    '√ätes-vous s√ªr de vouloir enregistrer cette vente ?',
                    'Oui, enregistrer',
                    'Annuler'
                );
            
                if (!confirmation) {
                    return; // L'utilisateur a annul√©
                }
            showStatusMessage('Enregistrement en cours', 'Veuillez patienter...');
            
            const cliniqueInput = modal.querySelector('#clinique_input')?.value;
            const ophtalmoInput = modal.querySelector('#ophtalmo_input')?.value;
            const assuranceInput = modal.querySelector('#assurance_input')?.value;
            const compagnieInput = modal.querySelector('#compagnie_input')?.value;

            const entrepriseInput = modal.querySelector('#entreprise_input')?.value;
            const commercialInput = modal.querySelector('#commercial_input')?.value;
            const formData = new FormData(form);
            if (!formData.get('clinique') && cliniqueInput) {
                formData.append('clinique_input', cliniqueInput);
            }
            if (!formData.get('ophtalmo') && ophtalmoInput) {
                formData.append('ophtalmo_input', ophtalmoInput);
            }
            if (!formData.get('assurance') && assuranceInput) {
                formData.append('assurance_input', assuranceInput);
            }
            if (!formData.get('compagnie') && compagnieInput) {
                formData.append('compagnie_input', compagnieInput);
            }
            if (!formData.get('entreprise') && entrepriseInput) {
                formData.append('entreprise_input', entrepriseInput);
            }if (!formData.get('commercial') && commercialInput) {
                formData.append('commercial_input', commercialInput);
            }
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                
                const response = await fetch(SUBMIT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                // Mais nous supposons que si la requ√™te est partie, c'est bon
                showStatusMessage('Succ√®s !', 'La vente a √©t√© enregistr√©e avec succ√®s. Fermeture en cours...');
                console.log('fin');
                
                // Fermer la modal apr√®s un d√©lai
                setTimeout(() => {
                   hideStatusMessage();
                    closeModal();
                    showSuccess('Vente enregistr√©e avec succ√®s !');
                }, 2000);

            } catch (error) {
                console.error('Erreur lors de l\'envoi des donn√©es :', error);
                showError('Erreur lors de l\'envoi des donn√©es. Veuillez r√©essayer.');
            }
        });
    }
}

    function showConfirmation(title, message, confirmText = 'Confirmer', cancelText = 'Annuler') {
    return new Promise((resolve) => {
        // Cr√©er l'overlay
        const overlay = document.createElement('div');
        overlay.className = 'confirmation-overlay';
        
        // Cr√©er la bo√Æte de confirmation
        const box = document.createElement('div');
        box.className = 'confirmation-box';
        box.innerHTML = `
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="confirmation-buttons">
                <button class="btn btn-confirm">${confirmText}</button>
                <button class="btn btn-cancel">${cancelText}</button>
            </div>
        `;
        
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        // G√©rer les clics
        const confirmBtn = box.querySelector('.btn-confirm');
        const cancelBtn = box.querySelector('.btn-cancel');

        const cleanUp = () => {
            document.body.removeChild(overlay);
        };

        confirmBtn.addEventListener('click', () => {
            cleanUp();
            resolve(true);
        });

        cancelBtn.addEventListener('click', () => {
            cleanUp();
            resolve(false);
        });
    });
}
// Calculs financiers
function calculerTotal() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const getValue = id => {
        const element = modal.querySelector(`#${id}`);
        if (!element) return 0;
        const value = parseFloat(element.value);
        return isNaN(value) ? 0 : value;
    };

    const montantMonture = getValue('montant_monture');
    const montantVerres = getValue('montant_verres');
    const fraisLivraison = getValue('frais_livraison');
    const remise = getValue('remise');
    const remiseType = modal.querySelector('#remise_type')?.value || 'FCFA';
    const partAssurance = getValue('part_assurance');
    const acompte = getValue('acompte');
    
    // Calculs
    const totalBrut = montantMonture + montantVerres + fraisLivraison;
    let montantRemise = 0;
    if (remiseType === '%') {
        montantRemise = totalBrut * (remise / 100);
    } else {
        montantRemise = remise;
    }

    const netAPayer = Math.max(0, totalBrut - montantRemise - partAssurance);
    const resteAPayer = Math.max(0, netAPayer - acompte);
    
    // Affichage
    const totalBrutInput = modal.querySelector('#total_brut');
    const totalBrutDisplay = modal.querySelector('#total_brut_display');
    if (totalBrutInput && totalBrutDisplay) {
        totalBrutInput.value = Math.round(totalBrut);
        totalBrutDisplay.textContent = Math.round(totalBrut).toLocaleString();
    }
    
    const netAPayerInput = modal.querySelector('#net_a_payer');
    const netAPayerDisplay = modal.querySelector('#net_a_payer_display');
    if (netAPayerInput && netAPayerDisplay) {
        netAPayerInput.value = Math.round(netAPayer);
        netAPayerDisplay.textContent = Math.round(netAPayer).toLocaleString();
    }
    
    const resteAPayerInput = modal.querySelector('#reste_a_payer');
    const resteAPayerDisplay = modal.querySelector('#reste_a_payer_display');
    if (resteAPayerInput && resteAPayerDisplay) {
        resteAPayerInput.value = Math.round(resteAPayer);
        resteAPayerDisplay.textContent = Math.round(resteAPayer).toLocaleString();
    }
}

// Fonction pour remplir une liste d√©roulante
function populateSelect(id, options) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const select = modal.querySelector(`#${id}`);
    if (!select) return;
    
    // Sauvegarder la valeur s√©lectionn√©e actuelle
    const currentValue = select.value;
    
    // Vider le select sauf la premi√®re option
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Ajouter les nouvelles options
    options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
    
    // Restaurer la valeur s√©lectionn√©e si elle existe toujours
    if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
    }
}

// Fonction pour remplir les options de prescription
function populatePrescriptionOptions(selectName, values) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const selects = modal.querySelectorAll(`[name="${selectName}"]`);
    if (!selects || selects.length === 0) return;
    
    const select = selects[0];
    const currentValue = select.value;
    
    // Vider le select sauf la premi√®re option
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Ajouter les nouvelles options
    values.forEach(value => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        select.appendChild(opt);
    });
    
    // Restaurer la valeur s√©lectionn√©e si elle existe toujours
    if (currentValue && values.includes(currentValue)) {
        select.value = currentValue;
    }
}

// Fonction principale de chargement des donn√©es
async function loadDataFromSheet() {
    showStatusMessage('Chargement des donn√©es...');
    
    try {
        const response = await fetch(DATA_SOURCE_URL);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const data = await response.json();
        
        if (!data.success) throw new Error("R√©ponse invalide du serveur.");
        if (!data.data) throw new Error("Donn√©es manquantes dans la r√©ponse");

        appDataCache = data.data;
        populateFormWithData(data.data);
        
    } catch (error) {
        console.error('Erreur lors du chargement:', error);
        showError(`Erreur lors du chargement: ${error.message}`);
    } finally {
        hideStatusMessage();
    }
}

// Fonction pour remplir le formulaire avec les donn√©es
function populateFormWithData(data) {
    if (!data) return;
    
    // Liste des champs √† remplir avec leurs donn√©es correspondantes
    const fieldsToPopulate = [
        { id: 'entreprise', data: data.entreprises },
        { id: 'agence', data: data.agences },
        { id: 'commercial', data: data.commerciaux },
        { id: 'type_verre', data: data.typesVerre },
        { id: 'gamme_verre', data: data.gammesVerre },
        { id: 'choix_monture', data: data.montures },
        { id: 'clinique', data: data.cliniques },
        { id: 'ophtalmo', data: data.ophtalmos },
        { id: 'assurance', data: data.assurances },
        { id: 'compagnie', data: data.compagnies }
    ];

    fieldsToPopulate.forEach(field => {
        if (Array.isArray(field.data)) {
            populateSelect(field.id, field.data);
        }
    });

    // Gestion des champs de prescription
    const prescriptionFields = [
        { name: 'od_sphere', data: data.sphere },
        { name: 'od_cylindre', data: data.sphere },
        { name: 'od_axe', data: data.axe },
        { name: 'od_add', data: data.add },
        { name: 'og_sphere', data: data.sphere },
        { name: 'og_cylindre', data: data.sphere },
        { name: 'og_axe', data: data.axe },
        { name: 'og_add', data: data.add }
    ];

    prescriptionFields.forEach(field => {
        if (Array.isArray(field.data)) {
            populatePrescriptionOptions(field.name, field.data);
        }
    });
}

// Fonction pour basculer entre select et input
function toggleInput(fieldName) {
    const select = document.getElementById(fieldName);
    const input = document.getElementById(`${fieldName}_input`);
    const button = event.currentTarget;
    
    if (input.style.display === 'none') {
        // Passer en mode saisie libre
        select.style.display = 'none';
        input.style.display = 'block';
        input.value = '';
        button.innerHTML = '<i class="fas fa-list"></i> Choisir existant';
        
        // Si une valeur √©tait s√©lectionn√©e, la mettre dans l'input
        if (select.value && !select.options[select.selectedIndex].disabled) {
            input.value = select.options[select.selectedIndex].text;
        }
    } else {
        // Revenir en mode s√©lection
        select.style.display = 'block';
        input.style.display = 'none';
        button.innerHTML = '<i class="fas fa-plus"></i> Ajouter nouveau';
        
        // Si l'input contient une valeur, l'ajouter aux options
        if (input.value.trim()) {
            addOptionIfNotExists(select, input.value.trim());
        }
    }
}

// Ajouter une option si elle n'existe pas d√©j√†
function addOptionIfNotExists(selectElement, value) {
    // V√©rifier si la valeur existe d√©j√†
    for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].text === value) {
            selectElement.value = value;
            return;
        }
    }
    
    // Ajouter la nouvelle option
    const option = document.createElement('option');
    option.value = value;
    option.text = value;
    selectElement.add(option);
    selectElement.value = value;
}

// Fonctions utilitaires
function showStatusMessage(title = 'Chargement', message = 'Veuillez patienter...', isSuccess = false) {
    let statusBox = document.getElementById('statusMessageBox');
    
    if (!statusBox) {
        statusBox = document.createElement('div');
        statusBox.id = 'statusMessageBox';
        statusBox.className = 'status-overlay';
        statusBox.innerHTML = `
            <div class="status-content ${isSuccess ? 'success' : ''}">
                ${!isSuccess ? '<div class="status-spinner"></div>' : ''}
                ${isSuccess ? '<i class="fas fa-check-circle status-icon"></i>' : ''}
                <h3>${title}</h3>
                <p>${message}</p>
            </div>
        `;
        document.body.appendChild(statusBox);
    } else {
        // Mise √† jour dynamique
        const content = statusBox.querySelector('.status-content');
        const spinner = statusBox.querySelector('.status-spinner');
        const icon = statusBox.querySelector('.status-icon');
        
        content.className = `status-content ${isSuccess ? 'success' : ''}`;
        
        if (isSuccess) {
            if (spinner) spinner.remove();
            if (!icon) {
                content.insertAdjacentHTML('afterbegin', '<i class="fas fa-check-circle status-icon"></i>');
            }
        } else {
            if (icon) icon.remove();
            if (!spinner) {
                content.insertAdjacentHTML('afterbegin', '<div class="status-spinner"></div>');
            }
        }
        
        statusBox.querySelector('h3').textContent = title;
        statusBox.querySelector('p').textContent = message;
    }
}

function hideStatusMessage() {
    const statusBox = document.getElementById('statusMessageBox');
    if (statusBox) {
        statusBox.remove();
    }
}

function showSuccess(message) {
hideStatusMessage();
    
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    document.body.appendChild(successDiv);
    successDiv.style.display = 'block';
    
    setTimeout(() => {
        successDiv.style.display = 'none';
        setTimeout(() => {
            document.body.removeChild(successDiv);
        }, 500);
    }, 3000);
}

function showError(message) {
   hideStatusMessage();
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    document.body.appendChild(errorDiv);
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
        errorDiv.style.display = 'none';
        setTimeout(() => {
            document.body.removeChild(errorDiv);
        }, 500);
    }, 5000);
}

// Initialiser la modal lorsque le DOM est charg√©
document.addEventListener('DOMContentLoaded', function() {
    // Si la modal existe d√©j√† dans le DOM, l'initialiser
    if (document.getElementById('newSaleModal')) {
        initModal();
    }
    document.getElementById("itemsPerPageSelect").addEventListener("change", function() {
        itemsPerPage = parseInt(this.value);
        currentPage = 1;
        updateTableAndPagination();
    });
    document.getElementById("searchInput").addEventListener("input", applySearchFilter);
});


// Pour afficher le bouton avec l'animation
function showSubmitButton() {
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.style.display = 'inline-block';
  submitBtn.classList.add('highlight');
  
  // Retirer la classe apr√®s l'animation pour pouvoir la r√©utiliser
  setTimeout(() => {
    submitBtn.classList.remove('highlight');
  }, 3000);
}

    document.addEventListener('DOMContentLoaded', function() {
    // 1. Gestion de l'utilisateur et authentification
    handleUserSession();

    // 2. Initialisation des donn√©es et interface
    initializeDataAndUI();

    // 3. Gestion de la navigation par √©tapes (formulaire proforma)
    setupFormStepNavigation();
});

// ==================== Fonctions s√©par√©es pour plus de clart√© ====================

function handleUserSession() {
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");

    if (!username) {
        redirectToLogin();
        return;
    }

    // Afficher le nom d'utilisateur
    const usernameDisplay = document.getElementById("username-display");
    if (usernameDisplay) {
        usernameDisplay.textContent = username;
    }

    // Mettre √† jour l'image de profil
    const profileImg = document.querySelector('.profile-img');
    if (profileImg) {
        profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=4361ee&color=fff`;
    }

    // Bouton d√©connexion
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    // Lancer le timer d'inactivit√©
    startInactivityTimer();
}

function logout() {
    sessionStorage.removeItem("utilisateur");
    localStorage.removeItem("utilisateur");
    redirectToLogin();
}

function redirectToLogin() {
    window.location.href = "code.html";
}

function startInactivityTimer() {
    const INACTIVITY_LIMIT = 30 * 60 * 1000; // 1h
    let inactivityTimeout;

    function resetTimer() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(logout, INACTIVITY_LIMIT);
    }

    // R√©initialiser le timer sur chaque interaction
    ["load", "mousemove", "keydown", "click", "scroll"].forEach(event => {
        window.addEventListener(event, resetTimer, true);
    });

    resetTimer();
}

// Ex√©cuter au chargement
handleUserSession();


// 2. Initialisation des donn√©es et interface
function initializeDataAndUI() {
    // Chargement des clients
    loadClientsFromScript();

    // Configuration de la recherche
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', applySearchFilter);
    }

    // Configuration de la pagination
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    
    if (prevPageBtn) prevPageBtn.addEventListener('click', goToPrevPage);
    if (nextPageBtn) nextPageBtn.addEventListener('click', goToNextPage);
}

// 3. Navigation par √©tapes du formulaire
function setupFormStepNavigation() {
    // Bouton Suivant - sans validation
    document.querySelectorAll('.next-step').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const currentSection = this.closest('.form-section');
            const nextStep = this.dataset.next;
            
            currentSection.classList.remove('active');
            document.getElementById(`section${nextStep}`).classList.add('active');
            updateStepper(nextStep);
        });
    });
    
    // Bouton Pr√©c√©dent (inchang√©)
    document.querySelectorAll('.prev-step').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const currentSection = this.closest('.form-section');
            const prevStep = this.dataset.prev;
            currentSection.classList.remove('active');
            document.getElementById(`section${prevStep}`).classList.add('active');
            updateStepper(prevStep);
        });
    });

    // Bouton Annuler
    const cancelButton = document.getElementById('cancelButton');
    if (cancelButton) {
        cancelButton.addEventListener('click', closeModal);
    }
}
    
document.addEventListener('DOMContentLoaded', function() {
    console.log("Initialisation de la navigation par √©tapes");
    setupFormStepNavigation();
    
    // Debug : Affiche tous les champs requis
    document.querySelectorAll('[required]').forEach(field => {
        field.addEventListener('change', function() {
            console.log(`Champ ${this.name} modifi√© :`, this.value);
        });
    });
});

// Fonction utilitaire pour changer de section
function switchSection(currentSection, targetStep) {
    currentSection.classList.remove('active');
    const nextSection = document.getElementById(`section${targetStep}`);
    if (nextSection) {
        nextSection.classList.add('active');
        updateStepper(targetStep);
        
        // Scroll vers le haut pour une meilleure UX
        nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}
function closeModal() {
    // S√©lectionne toutes les bo√Ætes de dialogue avec la classe 'active'
    const openModals = document.querySelectorAll('.dialog-overlay.active, .modal-overlay.active, [id$="Modal"].active');
    
    // Parcourt toutes les bo√Ætes de dialogue ouvertes et les ferme
    openModals.forEach(modal => {
        modal.classList.remove('active');
        
        // D√©clenche un √©v√©nement personnalis√© pour notifier la fermeture
        const event = new CustomEvent('modalClosed', {
            detail: { modalId: modal.id || 'unknown' }
        });
        modal.dispatchEvent(event);
    });
    
    // Optionnel: Emp√™che le d√©filement du body quand aucun modal n'est ouvert
    document.body.style.overflow = 'auto';

    // Recharge la page Accueil.html uniquement si on est dessus (ou alors redirige)
    if (window.location.pathname.endsWith('Accueil.html')) {
        window.location.reload();
    }
}

function setupCurrentUserField() {
    // 1. R√©cup√®re l'utilisateur stock√©
    const currentUser = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");
    
    // 2. Trouve le champ utilisateur dans le formulaire
    const userField = document.getElementById('current_user');
    
    // 3. Si le champ existe et qu'on a un utilisateur
    if (userField && currentUser) {
        // a. Affiche le nom dans le champ visible
        userField.value = currentUser;
        
        // b. Cr√©e un champ cach√© pour l'envoi au serveur
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'utilisateur';
        hiddenInput.value = currentUser;
        hiddenInput.id = 'hidden_utilisateur';
        
        // c. Ajoute le champ cach√© au formulaire (s'il n'existe pas d√©j√†)
        if (!document.getElementById('hidden_utilisateur')) {
            document.getElementById('client-form').appendChild(hiddenInput);
        }
    }
}
window.openJournalGrandCaisse = function () {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="grandCaisseModal">
            <div class="modal-content" style="max-width: 1600px;">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-cash-register"></i> Journal Grand Caisse</h3>
                </div>
                <div class="modal-body">
                    <div class="filters-card">
                        <div class="filters-container">
                        <div class="filter-item">
                                <label><i class="fas fa-exchange-alt"></i> Mouvement</label>
                                <select id="gcFilterMouvement" class="form-control">
                                    <option value="">Tous</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label><i class="fas fa-tags"></i> Cat√©gorie</label>
                                <select id="gcFilterCategorie" class="form-control">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label><i class="fas fa-calendar-alt"></i> P√©riode</label>
                                <div class="date-range">
                                    <input type="date" id="gcDateStart" class="form-control">
                                    <span>√†</span>
                                    <input type="date" id="gcDateEnd" class="form-control">
                                </div>
                            </div>

                            <div class="filter-item">
                                <button class="btn btn-outline-secondary" onclick="resetGrandCaisseFilter()">
                                    <i class="fas fa-undo"></i> R√©initialiser
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-card">
                        <div class="table-responsive">
                            <table class="grandcaisse-table" id="grandCaisseTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>D√©signation</th>
                                        <th class="text-right">Montant</th>
                                        <th>Mouvement</th>
                                        <th>Agence</th>
                                        <th>En caisse</th>
                                        <th>Mode de Paiement</th>
                                        <th>Cat√©gorie</th>
                                    </tr>
                                </thead>
                                <tbody id="grandCaisseData">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="grandcaisse-message" class="alert alert-info mt-3" style="display:none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="openAjoutGrandCaisse()">
                        <i class="fas fa-plus"></i> Ajouter
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="printGrandCaisse()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-close-modal" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;
    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('grandCaisseModal').classList.add('active');
        loadGrandCaisseData();
    }, 10);
};

// Variables
let allGrandCaisseData = [];
let uniqueMouvements = [];
let uniqueCategories = [];

// Charger les donn√©es
async function loadGrandCaisseData() {
    const tbody = document.getElementById('grandCaisseData');
    const msgDiv = document.getElementById('grandcaisse-message');
    tbody.innerHTML = `<tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>`;
    msgDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=grandcaisse`;
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const data = await response.json();
        if (!data?.data?.rows) throw new Error('Structure de donn√©es invalide');

        const headers = data.data.headers;
        allGrandCaisseData = data.data.rows.map(row => ({
            Date: row[headers.indexOf('Date')] ? new Date(row[headers.indexOf('Date')]) : null,
            Designation: row[headers.indexOf('Designation')] || '',
            Montant: parseFloat(row[headers.indexOf('Montant')]) || 0,
            Mouvement: row[headers.indexOf('Mouvement')] || '',
            Agence: row[headers.indexOf('Agence')] || '',
            EnCaisse: row[headers.indexOf('En caisse')] || '',
            ModePaiement: row[headers.indexOf('Mode de Paiement')] || '',
            Categorie: row[headers.indexOf('Categorie')] || ''
        }));

        uniqueMouvements = [...new Set(allGrandCaisseData.map(i => i.Mouvement).filter(Boolean))];
        uniqueCategories = [...new Set(allGrandCaisseData.map(i => i.Categorie).filter(Boolean))];

        populateFilterOptions('gcFilterMouvement', uniqueMouvements);
        populateFilterOptions('gcFilterCategorie', uniqueCategories);

        setupGrandCaisseFilters();
        displayGrandCaisseData(allGrandCaisseData);

    } catch (err) {
        console.error('[Grand Caisse] Erreur:', err);
        showGrandCaisseMessage(`‚ùå Erreur: ${err.message}`, 'danger');
        tbody.innerHTML = `<tr><td colspan="8" class="text-center">Erreur de chargement</td></tr>`;
    }
}

function populateFilterOptions(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">${selectId.includes('Mouvement') ? 'Tous' : 'Toutes'}</option>`;
    values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
    });
}

function setupGrandCaisseFilters() {
    document.getElementById('gcDateStart').addEventListener('input', applyGrandCaisseFilter);
    document.getElementById('gcDateEnd').addEventListener('input', applyGrandCaisseFilter);
    document.getElementById('gcFilterMouvement').addEventListener('change', applyGrandCaisseFilter);
    document.getElementById('gcFilterCategorie').addEventListener('change', applyGrandCaisseFilter);
}

function displayGrandCaisseData(data) {
    const tbody = document.getElementById('grandCaisseData');
    if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center">Aucune donn√©e disponible</td></tr>`;
        return;
    }
    tbody.innerHTML = data.map(item => `
        <tr>
            <td>${item.Date?.toLocaleDateString('fr-FR') || 'N/A'}</td>
            <td>${item.Designation}</td>
            <td class="text-right">${item.Montant.toLocaleString('fr-FR', {minimumFractionDigits:2})}</td>
            <td>${item.Mouvement}</td>
            <td>${item.Agence}</td>
            <td>${item.EnCaisse}</td>
            <td>${item.ModePaiement}</td>
            <td>${item.Categorie}</td>
        </tr>
    `).join('');
}

function applyGrandCaisseFilter() {
    const start = document.getElementById('gcDateStart').value ? new Date(document.getElementById('gcDateStart').value) : null;
    const end = document.getElementById('gcDateEnd').value ? new Date(document.getElementById('gcDateEnd').value) : null;
    const mouvement = document.getElementById('gcFilterMouvement').value;
    const categorie = document.getElementById('gcFilterCategorie').value;

    let filtered = [...allGrandCaisseData];

    if (start || end) {
        filtered = filtered.filter(i => {
            if (!i.Date) return false;
            if (start && end) return i.Date >= start && i.Date <= end;
            if (start) return i.Date >= start;
            if (end) return i.Date <= end;
            return true;
        });
    }

    if (mouvement) filtered = filtered.filter(i => i.Mouvement === mouvement);
    if (categorie) filtered = filtered.filter(i => i.Categorie === categorie);

    displayGrandCaisseData(filtered);
}

function resetGrandCaisseFilter() {
    document.getElementById('gcDateStart').value = '';
    document.getElementById('gcDateEnd').value = '';
    document.getElementById('gcFilterMouvement').value = '';
    document.getElementById('gcFilterCategorie').value = '';
    displayGrandCaisseData(allGrandCaisseData);
    showGrandCaisseMessage(`‚Üª Affichage de toutes les ${allGrandCaisseData.length} entr√©es`, 'info');
}

function showGrandCaisseMessage(msg, type) {
    const div = document.getElementById('grandcaisse-message');
    div.textContent = msg;
    div.className = `alert alert-${type}`;
    div.style.display = 'block';
}

// Impression
function printGrandCaisse() {
    try {
        const printWindow = window.open('', '_blank');
        const printContent = document.getElementById('grandCaisseTable').cloneNode(true);

        let total = 0;
        printContent.querySelectorAll('tbody tr').forEach(row => {
            const cell = row.cells[2]?.textContent;
            if (cell) {
                const amount = parseFloat(cell.replace(/[^\d,.-]/g, '').replace(',', '.'));
                if (!isNaN(amount)) total += amount;
            }
        });

        const totalRow = document.createElement('tr');
        totalRow.innerHTML = `<td colspan="2" class="text-right"><strong>Total</strong></td>
                              <td class="text-right"><strong>${total.toLocaleString('fr-FR',{minimumFractionDigits:2})}</strong></td>
                              <td colspan="5"></td>`;
        printContent.querySelector('tbody').appendChild(totalRow);

        const styles = `
            <style>
                body { font-family: Arial; margin:15px; }
                h1 { text-align:center; }
                table { width:100%; border-collapse:collapse; margin-top:10px; }
                th,td { border:1px solid #ddd; padding:8px; }
                th { background:#f2f2f2; }
                .text-right{text-align:right;}
                @page { margin: 10mm; }
            </style>
        `;

        printWindow.document.write(`
            <html>
                <head><title>Journal Grand Caisse</title>${styles}</head>
                <body>
                    <h1>Journal Grand Caisse</h1>
                    <p>Imprim√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                    ${printContent.outerHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); printWindow.close(); };

    } catch (err) {
        console.error('Erreur impression:', err);
        alert("Erreur lors de l'impression");
    }
}
window.openAjoutGrandCaisse = async function() {
    const modalContainer = document.getElementById('modal-container');

    // Loader pendant chargement
    modalContainer.innerHTML = `
        <div class="modal-overlay active" id="loadingModal">
            <div class="modal-content" style="text-align:center; padding:2rem;">
                <div class="loading-spinner"></div>
                <p>Chargement des cat√©gories...</p>
            </div>
        </div>
    `;

    try {
        // Charger les cat√©gories dynamiquement
        const { categories } = await fetchDataFromGoogleSheet(); // ta fonction existante

        const modalHTML = `
            <div class="modal-overlay" id="ajoutGrandCaisseModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-plus-circle"></i> Ajouter une D√©pense</h3>
                    </div>
                    <div class="modal-body">
                        <form id="grandCaisseForm">
                            <div class="form-group">
                                <label>Date <span class="required">*</span></label>
                                <input type="date" id="gcDate" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label>D√©signation <span class="required">*</span></label>
                                <input type="text" id="gcDesignation" class="form-control" placeholder="Description" required>
                            </div>

                            <div class="form-group">
                                <label>Montant (FCFA) <span class="required">*</span></label>
                                <input type="number" id="gcMontant" class="form-control" placeholder="0" required>
                            </div>

                            <div class="form-group">
                                <label>Mouvement <span class="required">*</span></label>
                                <select id="gcMouvement" class="form-control" required>
                                    <option value="Sortie">Sortie</option>
                                    <option value="Entr√©e">Entr√©e</option>
                                    
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Agence</label>
                                <input type="text" id="gcAgence" class="form-control" value="Grand-C" readonly>
                            </div>

                            <div class="form-group">
                                <label>Mode de Paiement <span class="required">*</span></label>
                                <select id="gcModePaiement" class="form-control" required>
                                    <option value="CASH">CASH</option>
                                    <option value="MOMO">MOMO</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Cat√©gorie <span class="required">*</span></label>
                                <select id="gcCategorie" class="form-control" required>
                                    <option value="">S√©lectionner une cat√©gorie</option>
                                    ${categories.map(cat => `<option value="${cat.value}">${cat.label}</option>`).join('')}
                                </select>
                            </div>

                            <div id="gcFormMessage" class="form-message"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModalopengrandecaisse()">Annuler</button>
                        <button class="btn btn-primary" onclick="submitGrandCaisse()">Enregistrer</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.innerHTML = modalHTML;
        setTimeout(() => {
            document.getElementById('ajoutGrandCaisseModal').classList.add('active');
            document.getElementById('gcDate').value = new Date().toISOString().split('T')[0];
        }, 10);

    } catch (err) {
        console.error(err);
        modalContainer.innerHTML = `
            <div class="modal-overlay active">
                <div class="modal-content" style="text-align:center; padding:2rem;">
                    <i class="fas fa-exclamation-triangle" style="color:red;font-size:2rem;"></i>
                    <p>Erreur de chargement : ${err.message}</p>
                    <button class="btn btn-danger" onclick="closeModalopengrandecaisse()">Fermer</button>
                </div>
            </div>
        `;
    }
};
async function submitGrandCaisse() {
    const formMessage = document.getElementById('gcFormMessage');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    const date = document.getElementById('gcDate').value;
    const designation = document.getElementById('gcDesignation').value.trim();
    const montant = parseFloat(document.getElementById('gcMontant').value);
    const mouvement = document.getElementById('gcMouvement').value;
    const agence = document.getElementById('gcAgence').value;
    const modePaiement = document.getElementById('gcModePaiement').value;
    const categorie = document.getElementById('gcCategorie').value;

    if (!date || !designation || isNaN(montant) || !mouvement || !modePaiement || !categorie) {
        formMessage.textContent = "Veuillez remplir tous les champs obligatoires.";
        formMessage.classList.add('error');
        return;
    }

    const payload = { date, designation, montant, mouvement, agence, modePaiement, categorie };

    const submitBtn = document.querySelector('#ajoutGrandCaisseModal .btn-primary');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addGrandCaisse";

        await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        formMessage.textContent = "‚úÖ D√©pense enregistr√©e avec succ√®s !";
        formMessage.classList.add('success');

        setTimeout(() => {
            closeModalopengrandecaisse();
            loadGrandCaisseData(); // recharge la table
        }, 1500);

    } catch (err) {
        console.error(err);
        formMessage.textContent = `‚ùå Erreur: ${err.message}`;
        formMessage.classList.add('error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enregistrer';
    }
}


document.addEventListener('DOMContentLoaded', () => {
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const sidebar = document.querySelector('.sidebar');

  // Ouvrir / fermer avec le bouton
  mobileMenuBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // Emp√™che le clic de se propager
    sidebar.classList.toggle('active');
  });

  // Cacher si clic en dehors
  document.addEventListener('click', (e) => {
    if (sidebar.classList.contains('active') && !sidebar.contains(e.target) && e.target !== mobileMenuBtn) {
      sidebar.classList.remove('active');
    }
  });
});
function closeModalopengrandecaisse() {
    const modalContainer = document.getElementById('modal-container');
    if (modalContainer) {
        modalContainer.innerHTML = '';
        document.body.classList.remove('modal-open');
    }
    
    setTimeout(() => {
        if (typeof openJournalGrandCaisse === 'function') {
            openJournalGrandCaisse();
        }
    }, 100);
}

// Variables globales pour les transactions bancaires
let allBanqueData = [];
let uniqueBanqueDesignations = [];
let uniqueBanqueTypes = [];
let uniqueBanqueCategories = [];
let currentFilteredBanque = [];
let banqueCategories = [];

// Charger les cat√©gories de configuration
async function loadConfigData() {
    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getconfigdata');
        const json = await response.json();

        if (json.success && json.data?.categories) {
            banqueCategories = json.data.categories;
            console.log("‚úÖ Cat√©gories charg√©es :", banqueCategories);
        } else {
            banqueCategories = [];
            console.warn("‚ö†Ô∏è Aucune cat√©gorie trouv√©e");
        }
    } catch (error) {
        console.error("‚ùå Erreur lors du chargement des cat√©gories :", error);
        banqueCategories = [];
    }
}

// Fonction principale pour ouvrir la gestion du compte banque
function openBanque() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="banqueModal">
            <div class="modal-content" style="width: 95vw; max-width: none; height: 90vh;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid #ddd;">
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">
                        <i class="fas fa-university me-2"></i> Gestion du Compte Banque
                    </h3>
                </div>

                <div class="modal-body" style="display: flex; flex-direction: column; padding: 15px; gap: 10px; overflow: hidden;">

                    <!-- Filtres am√©lior√©s -->
                    <div class="filters-panel" style="flex-shrink: 0; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
                            <!-- Filtre Date D√©but -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterBanqueDateStart" class="form-label small">Date de d√©but</label>
                                <input type="date" id="filterBanqueDateStart" class="form-control form-control-sm" onchange="applyBanqueFilter()">
                            </div>
                            <!-- Filtre Date Fin -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterBanqueDateEnd" class="form-label small">Date de fin</label>
                                <input type="date" id="filterBanqueDateEnd" class="form-control form-control-sm" onchange="applyBanqueFilter()">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterBanqueDesignation" class="form-label small">D√©signation</label>
                                <select id="filterBanqueDesignation" class="form-select form-select-sm" onchange="applyBanqueFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterBanqueType" class="form-label small">Type de transaction</label>
                                <select id="filterBanqueType" class="form-select form-select-sm" onchange="applyBanqueFilter()">
                                    <option value="">Tous</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterBanqueCategorie" class="form-label small">Cat√©gorie</label>
                                <select id="filterBanqueCategorie" class="form-select form-select-sm" onchange="applyBanqueFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="align-self: center;">
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetBanqueFilter()">
                                    <i class="fas fa-undo me-1"></i> R√©initialiser
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="table-container" style="flex-grow: 1; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm" id="banqueTable">
                                <thead class="table-dark sticky-top" id="banqueTableHeader">
                                    <!-- Les en-t√™tes seront g√©n√©r√©s dynamiquement -->
                                </thead>
                                <tbody id="banqueData">
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Message -->
                    <div id="banque-message" class="alert alert-info small mt-2" style="display: none;"></div>
                </div>

                <!-- Footer -->
                <div class="modal-footer d-flex justify-content-end align-items-center p-2 border-top">
                    <button type="button" class="btn btn-primary btn-sm" onclick="closeModal()">
                        <i class="fas fa-times me-1"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('banqueModal').classList.add('active');
    
    // Charger les donn√©es de banque ET les cat√©gories
    Promise.all([loadBanqueData(), loadConfigData()]).then(() => {
        console.log("‚úÖ Toutes les donn√©es sont charg√©es");
    });
}

// Chargement des donn√©es bancaires
async function loadBanqueData() {
    const banqueData = document.getElementById('banqueData');
    const messageDiv = document.getElementById('banque-message');
    const tableHeader = document.getElementById('banqueTableHeader');
    
    banqueData.innerHTML = '<tr><td colspan="8" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=banque`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows || !responseData?.data?.headers) {
            throw new Error('Structure de donn√©es invalide');
        }
        
        // G√©n√©rer les en-t√™tes du tableau
        generateBanqueTableHeaders(responseData.data.headers);
        
        // Transformation des donn√©es
        allBanqueData = responseData.data.rows.map(row => {
            const item = {};
            responseData.data.headers.forEach((header, index) => {
                const cleanHeader = header.replace(/\t/g, ' ').trim();
                item[cleanHeader] = row[index] || '';
                
                if (cleanHeader.includes('Montant') || cleanHeader.includes('SOLDE DISPONIBLE')) {
                    item[cleanHeader] = parseFloat(row[index]) || 0;
                }
            });
            return item;
        });

        // Initialiser les donn√©es filtr√©es
        currentFilteredBanque = [...allBanqueData];

        // Mettre √† jour les filtres
        refreshBanqueFilters();

        // Afficher les donn√©es
        const headers = Object.keys(allBanqueData[0] || {});
        displayFilteredBanque(allBanqueData, headers);
        
    } catch (error) {
        console.error('Erreur:', error);
        showBanqueMessage(`‚ùå Erreur: ${error.message || 'Chargement √©chou√©'}`, 'error');
        banqueData.innerHTML = '<tr><td colspan="8" class="text-center">Erreur de chargement</td></tr>';
    }
}

// G√©n√©rer les en-t√™tes du tableau banque
function generateBanqueTableHeaders(headers) {
    const tableHeader = document.getElementById('banqueTableHeader');
    tableHeader.innerHTML = '';
    
    const headerRow = document.createElement('tr');
    
    headers.forEach(header => {
        const th = document.createElement('th');
        const cleanHeader = header.replace(/\t/g, ' ').trim();
        
        if (cleanHeader.includes('Montant') || cleanHeader.includes('SOLDE DISPONIBLE')) {
            th.className = 'text-end';
        }
        
        th.textContent = cleanHeader;
        headerRow.appendChild(th);
    });
    
    // Ajouter la colonne Actions
    const actionsTh = document.createElement('th');
    actionsTh.textContent = 'Actions';
    headerRow.appendChild(actionsTh);
    
    tableHeader.appendChild(headerRow);
}

// Rafra√Æchir les filtres banque
function refreshBanqueFilters() {
    uniqueBanqueDesignations = [...new Set(allBanqueData.map(item => item['Designation']).filter(Boolean))];
    uniqueBanqueTypes = [...new Set(allBanqueData.map(item => item['Type de transation']).filter(Boolean))];
    uniqueBanqueCategories = [...new Set(allBanqueData.map(item => item['Categorie']).filter(Boolean))];

    populateBanqueFilter('filterBanqueDesignation', uniqueBanqueDesignations);
    populateBanqueFilter('filterBanqueType', uniqueBanqueTypes);
    populateBanqueFilter('filterBanqueCategorie', uniqueBanqueCategories);
}

// Peupler les filtres banque
function populateBanqueFilter(selectId, values) {
    const select = document.getElementById(selectId);
    if (!select) {
        console.error(`Element #${selectId} non trouv√©`);
        return;
    }
    
    select.innerHTML = `<option value="">Tous</option>`;
    
    if (!values || !values.length) return;
    
    values.sort().forEach(value => {
        if (value) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
        }
    });
}

// Application des filtres banque
function applyBanqueFilter() {
    console.log("Application des filtres banque...");
    
    const dateStart = document.getElementById('filterBanqueDateStart').value;
    const dateEnd = document.getElementById('filterBanqueDateEnd').value;
    const designation = document.getElementById('filterBanqueDesignation').value;
    const type = document.getElementById('filterBanqueType').value;
    const categorie = document.getElementById('filterBanqueCategorie').value;
    
    // Convertir les dates
    const startDateObj = dateStart ? new Date(dateStart) : null;
    const endDateObj = dateEnd ? new Date(dateEnd) : null;
    
    let filteredData = allBanqueData.filter(item => {
        // Filtrage par date
        let dateMatch = true;
        if (item['Date']) {
            const itemDate = new Date(item['Date']);
            
            if (startDateObj && endDateObj) {
                dateMatch = itemDate >= startDateObj && itemDate <= endDateObj;
            } else if (startDateObj) {
                dateMatch = itemDate >= startDateObj;
            } else if (endDateObj) {
                dateMatch = itemDate <= endDateObj;
            }
        }
        
        // Filtrage par autres crit√®res
        const designationMatch = !designation || item['Designation'] === designation;
        const typeMatch = !type || item['Type de transation'] === type;
        const categorieMatch = !categorie || item['Categorie'] === categorie;
        
        return dateMatch && designationMatch && typeMatch && categorieMatch;
    });
    
    console.log(`Filtres appliqu√©s - ${filteredData.length} r√©sultats`);
    
    const headers = Object.keys(allBanqueData[0] || {});
    displayFilteredBanque(filteredData, headers);
}

// R√©initialiser les filtres banque
function resetBanqueFilter() {
    console.log("R√©initialisation des filtres banque");
    
    document.getElementById('filterBanqueDateStart').value = '';
    document.getElementById('filterBanqueDateEnd').value = '';
    document.getElementById('filterBanqueDesignation').value = '';
    document.getElementById('filterBanqueType').value = '';
    document.getElementById('filterBanqueCategorie').value = '';
    
    const headers = Object.keys(allBanqueData[0] || {});
    displayFilteredBanque(allBanqueData, headers);
}
// Affichage des donn√©es filtr√©es banque
function displayFilteredBanque(data, headers) {
    const banqueData = document.getElementById('banqueData');
    
    // Stocker les donn√©es filtr√©es actuellement affich√©es
    currentFilteredBanque = data;
    
    if (!data?.length) {
        banqueData.innerHTML = `<tr><td colspan="${headers.length + 1}" class="text-center">Aucune transaction trouv√©e</td></tr>`;
        return;
    }
    
    // Trier les donn√©es par date (plus r√©cent en premier)
    const sortedData = [...data].sort((a, b) => {
        const dateA = new Date(a['Date'] || 0);
        const dateB = new Date(b['Date'] || 0);
        return dateB - dateA; // Ordre d√©croissant (plus r√©cent en premier)
    });
    
    let html = '';
    sortedData.forEach((item, index) => {
        html += '<tr>';
        
        headers.forEach(header => {
            const cleanHeader = header.replace(/\t/g, ' ').trim();
            const value = item[cleanHeader] || '';
            
            if (cleanHeader === 'Date') {
                html += `<td>${formatDate(value)}</td>`;
            } 
            else if (cleanHeader.includes('Montant') || cleanHeader.includes('SOLDE DISPONIBLE')) {
                const amount = parseFloat(value) || 0;
                const amountClass = amount < 0 ? 'text-danger' : 'text-success';
                html += `<td class="text-end ${amountClass} fw-bold">${formatCurrency(value)}</td>`;
            }
            else if (cleanHeader === 'Type de transation') {
                html += `<td><span class="badge ${getTransactionTypeBadgeClass(value)}">${value}</span></td>`;
            }
            else {
                html += `<td>${value}</td>`;
            }
        });
        
        // Bouton d'action uniquement pour l'√©dition
        html += `
            <td>
                <div class="action-btns">
                    <button class="action-btn btn-edit" onclick="editBanqueByUniqueId('${item['Idunique']}')" title="Modifier">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
            </td>
        `;
        
        html += '</tr>';
    });
    
    banqueData.innerHTML = html;
}

// √âdition d'une transaction depuis les donn√©es filtr√©es
function editBanqueByUniqueId(idUnique) {
    if (!idUnique) {
        alert('ID de transaction manquant');
        return;
    }
    
    // Trouver la transaction dans allBanqueData
    const originalIndex = allBanqueData.findIndex(item => 
        item['Idunique'] && item['Idunique'].toString() === idUnique.toString()
    );
    
    if (originalIndex === -1) {
        console.error('Transaction non trouv√©e avec ID:', idUnique);
        alert('Erreur: Transaction non trouv√©e');
        return;
    }
    
    const transaction = allBanqueData[originalIndex];
    openEditBanqueModal(originalIndex, transaction);
}

// Ouvrir la modal d'√©dition de transaction
async function openEditBanqueModal(index, transactionData = null) {
    // S'assurer que les cat√©gories sont charg√©es
    if (banqueCategories.length === 0) {
        console.log("üì• Chargement des cat√©gories...");
        await loadConfigData();
    }
    
    const transaction = transactionData || allBanqueData[index];
    const modalContainer = document.getElementById('modal-container');
    
    // G√©n√©rer les options de cat√©gorie
    let categoryOptions = '';
    if (banqueCategories && banqueCategories.length > 0) {
        console.log("‚úÖ Affichage des cat√©gories:", banqueCategories);
        banqueCategories.forEach(category => {
            const selected = category === transaction['Categorie'] ? 'selected' : '';
            categoryOptions += `<option value="${category.value}" ${selected}>${category.label}</option>`;
        });
    } else {
        console.warn("‚ö†Ô∏è Aucune cat√©gorie disponible");
        categoryOptions = `<option value="${transaction['Categorie'] || ''}" selected>${transaction['Categorie'] || 'Aucune cat√©gorie'}</option>`;
    }
    
    const modalHTML = `
        <div class="edit-modal active" id="editBanqueModal">
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h3 class="edit-modal-title">
                        <i class="fas fa-edit me-2"></i> 
                        Modifier Transaction
                    </h3>
                </div>
                
                <div class="edit-modal-body">
                    <form id="editBanqueForm">
                        <div class="edit-row">
                            <div class="edit-col">
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Date</label>
                                    <input type="date" class="edit-form-control" id="editBanqueDate" value="${formatDateForInput(transaction['Date'])}" readonly>
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">D√©signation</label>
                                    <input type="text" class="edit-form-control" id="editBanqueDesignation" value="${transaction['Designation'] || ''}" readonly>
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Montant</label>
                                    <input type="number" step="0.01" class="edit-form-control" id="editBanqueMontant" value="${transaction['Montant'] || ''}" readonly>
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Type de transaction</label>
                                    <input type="text" class="edit-form-control" id="editBanqueType" value="${transaction['Type de transation'] || ''}" readonly>
                                </div>
                            </div>
                            
                            <div class="edit-col">
                                <div class="edit-form-group">
                                    <label class="edit-form-label">SOLDE DISPONIBLE</label>
                                    <input type="number" step="0.01" class="edit-form-control" id="editBanqueSolde" value="${transaction['SOLDE DISPONIBLE'] || ''}" readonly>
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">Cat√©gorie *</label>
                                    <select class="edit-form-control" id="editBanqueCategorie" required>
                                        <option value="">S√©lectionner une cat√©gorie...</option>
                                        ${categoryOptions}
                                    </select>
                                </div>
                                
                                <div class="edit-form-group">
                                    <label class="edit-form-label">ID Unique</label>
                                    <input type="text" class="edit-form-control" value="${transaction['Idunique'] || ''}" readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="edit-modal-footer">
                    <button type="button" class="edit-btn edit-btn-secondary" onclick="closeModalAndOpenBanque()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="button" class="edit-btn edit-btn-primary" onclick="submitBanqueUpdate(${index})">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modalHTML;
    document.body.classList.add('modal-open');
}

// Soumettre la mise √† jour d'une transaction
function submitBanqueUpdate(index) {
    const transaction = allBanqueData[index];
    const idUnique = transaction['Idunique'];
    
    // R√©cup√©ration uniquement de la cat√©gorie (seul champ modifiable)
    const updatedData = {
        'Date': transaction['Date'],
        'Designation': transaction['Designation'],
        'Montant': transaction['Montant'],
        'Type de transation': transaction['Type de transation'],
        'SOLDE DISPONIBLE': transaction['SOLDE DISPONIBLE'],
        'Categorie': document.getElementById('editBanqueCategorie').value,
        'Idunique': idUnique
    };

    // Validation de la cat√©gorie
    if (!updatedData.Categorie) {
        alert('Veuillez s√©lectionner une cat√©gorie');
        return;
    }

    const submitBtn = document.querySelector('.edit-btn-primary');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    submitBtn.disabled = true;

    const url = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=updatebanque`;
    
    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            idUnique: idUnique,
            updatedData: updatedData
        })
    })
    .then(() => {
        // Mise √† jour optimiste
        allBanqueData[index] = {...allBanqueData[index], ...updatedData};
        closeModalAndOpenBanque();
    })
    .catch(error => {
        console.error("Erreur d'envoi:", error);
        closeModalAndOpenBanque();
    })
    .finally(() => {
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
    });
}

function closeModalAndOpenBanque() {
    const modalContainer = document.getElementById('modal-container');
    if (modalContainer) {
        modalContainer.innerHTML = '';
        document.body.classList.remove('modal-open');
    }
    
    setTimeout(() => {
        if (typeof openBanque === 'function') {
            openBanque();
        }
    }, 300);
}

// Fonctions utilitaires pour banque
function getTransactionTypeBadgeClass(type) {
    switch(type) {
        case 'Cr√©dit': return 'bg-success';
        case 'D√©bit': return 'bg-danger';
        case 'Virement': return 'bg-primary';
        case 'Pr√©l√®vement': return 'bg-warning text-dark';
        default: return 'bg-secondary';
    }
}

function showBanqueMessage(message, type) {
    const messageDiv = document.getElementById('banque-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

</script>
</body>
</html>
